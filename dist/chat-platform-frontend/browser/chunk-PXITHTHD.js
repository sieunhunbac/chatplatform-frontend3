import{E as bL,Q as Sc,R as Tc,S as TS,Z as ll,c as bt,d as vL,e as SS,f as I,g as dl,h as yL,ma as IL,n as CL,oa as AL,r as Pp,ta as wL}from"./chunk-LEPOSHV4.js";var DL=bt((zX,RS)=>{"use strict";global.crypto&&global.crypto.getRandomValues?RS.exports.randomBytes=function(v){var S=new Uint8Array(v);return global.crypto.getRandomValues(S),S}:RS.exports.randomBytes=function(v){for(var S=new Array(v),b=0;b<v;b++)S[b]=Math.floor(Math.random()*256);return S}});var Ks=bt((XX,LL)=>{"use strict";var _Y=DL(),PL="abcdefghijklmnopqrstuvwxyz012345";LL.exports={string:function(v){for(var S=PL.length,b=_Y.randomBytes(v),O=[],M=0;M<v;M++)O.push(PL.substr(b[M]%S,1));return O.join("")},number:function(v){return Math.floor(Math.random()*v)},numberString:function(v){var S=(""+(v-1)).length,b=new Array(S+1).join("0");return(b+this.number(v)).slice(-S)}}});var ho=bt((JX,Vp)=>{"use strict";var mY=Ks(),vc={},vS=!1,kL=global.chrome&&global.chrome.app&&global.chrome.app.runtime;Vp.exports={attachEvent:function(v,S){typeof global.addEventListener<"u"?global.addEventListener(v,S,!1):global.document&&global.attachEvent&&(global.document.attachEvent("on"+v,S),global.attachEvent("on"+v,S))},detachEvent:function(v,S){typeof global.addEventListener<"u"?global.removeEventListener(v,S,!1):global.document&&global.detachEvent&&(global.document.detachEvent("on"+v,S),global.detachEvent("on"+v,S))},unloadAdd:function(v){if(kL)return null;var S=mY.string(8);return vc[S]=v,vS&&setTimeout(this.triggerUnloadCallbacks,0),S},unloadDel:function(v){v in vc&&delete vc[v]},triggerUnloadCallbacks:function(){for(var v in vc)vc[v](),delete vc[v]}};var EY=function(){vS||(vS=!0,Vp.exports.triggerUnloadCallbacks())};kL||Vp.exports.attachEvent("unload",EY)});var UL=bt((QX,ML)=>{"use strict";ML.exports=function(S,b){if(b=b.split(":")[0],S=+S,!S)return!1;switch(b){case"http":case"ws":return S!==80;case"https":case"wss":return S!==443;case"ftp":return S!==21;case"gopher":return S!==70;case"file":return!1}return S!==0}});var FL=bt(yS=>{"use strict";var fY=Object.prototype.hasOwnProperty,gY;function xL(v){try{return decodeURIComponent(v.replace(/\+/g," "))}catch{return null}}function VL(v){try{return encodeURIComponent(v)}catch{return null}}function SY(v){for(var S=/([^=?#&]+)=?([^&]*)/g,b={},O;O=S.exec(v);){var M=xL(O[1]),q=xL(O[2]);M===null||q===null||M in b||(b[M]=q)}return b}function TY(v,S){S=S||"";var b=[],O,M;typeof S!="string"&&(S="?");for(M in v)if(fY.call(v,M)){if(O=v[M],!O&&(O===null||O===gY||isNaN(O))&&(O=""),M=VL(M),O=VL(O),M===null||O===null)continue;b.push(M+"="+O)}return b.length?S+b.join("&"):""}yS.stringify=TY;yS.parse=SY});var IS=bt(($X,qL)=>{"use strict";var jL=UL(),Fp=FL(),RY=/^[\x00-\x20\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/,GL=/[\n\r\t]/g,vY=/^[A-Za-z][A-Za-z0-9+-.]*:\/\//,WL=/:\d+$/,yY=/^([a-z][a-z0-9.+-]*:)?(\/\/)?([\\/]+)?([\S\s]*)/i,CY=/^[a-zA-Z]:/;function bS(v){return(v||"").toString().replace(RY,"")}var CS=[["#","hash"],["?","query"],function(S,b){return Br(b.protocol)?S.replace(/\\/g,"/"):S},["/","pathname"],["@","auth",1],[NaN,"host",void 0,1,1],[/:(\d*)$/,"port",void 0,1],[NaN,"hostname",void 0,1,1]],BL={hash:1,query:1};function HL(v){var S;typeof window<"u"?S=window:typeof global<"u"?S=global:typeof self<"u"?S=self:S={};var b=S.location||{};v=v||b;var O={},M=typeof v,q;if(v.protocol==="blob:")O=new jr(unescape(v.pathname),{});else if(M==="string"){O=new jr(v,{});for(q in BL)delete O[q]}else if(M==="object"){for(q in v)q in BL||(O[q]=v[q]);O.slashes===void 0&&(O.slashes=vY.test(v.href))}return O}function Br(v){return v==="file:"||v==="ftp:"||v==="http:"||v==="https:"||v==="ws:"||v==="wss:"}function KL(v,S){v=bS(v),v=v.replace(GL,""),S=S||{};var b=yY.exec(v),O=b[1]?b[1].toLowerCase():"",M=!!b[2],q=!!b[3],et=0,st;return M?q?(st=b[2]+b[3]+b[4],et=b[2].length+b[3].length):(st=b[2]+b[4],et=b[2].length):q?(st=b[3]+b[4],et=b[3].length):st=b[4],O==="file:"?et>=2&&(st=st.slice(2)):Br(O)?st=b[4]:O?M&&(st=st.slice(2)):et>=2&&Br(S.protocol)&&(st=b[4]),{protocol:O,slashes:M||Br(O),slashesCount:et,rest:st}}function bY(v,S){if(v==="")return S;for(var b=(S||"/").split("/").slice(0,-1).concat(v.split("/")),O=b.length,M=b[O-1],q=!1,et=0;O--;)b[O]==="."?b.splice(O,1):b[O]===".."?(b.splice(O,1),et++):et&&(O===0&&(q=!0),b.splice(O,1),et--);return q&&b.unshift(""),(M==="."||M==="..")&&b.push(""),b.join("/")}function jr(v,S,b){if(v=bS(v),v=v.replace(GL,""),!(this instanceof jr))return new jr(v,S,b);var O,M,q,et,st,ct,mt=CS.slice(),Wt=typeof S,ht=this,jt=0;for(Wt!=="object"&&Wt!=="string"&&(b=S,S=null),b&&typeof b!="function"&&(b=Fp.parse),S=HL(S),M=KL(v||"",S),O=!M.protocol&&!M.slashes,ht.slashes=M.slashes||O&&S.slashes,ht.protocol=M.protocol||S.protocol||"",v=M.rest,(M.protocol==="file:"&&(M.slashesCount!==2||CY.test(v))||!M.slashes&&(M.protocol||M.slashesCount<2||!Br(ht.protocol)))&&(mt[3]=[/(.*)/,"pathname"]);jt<mt.length;jt++){if(et=mt[jt],typeof et=="function"){v=et(v,ht);continue}q=et[0],ct=et[1],q!==q?ht[ct]=v:typeof q=="string"?(st=q==="@"?v.lastIndexOf(q):v.indexOf(q),~st&&(typeof et[2]=="number"?(ht[ct]=v.slice(0,st),v=v.slice(st+et[2])):(ht[ct]=v.slice(st),v=v.slice(0,st)))):(st=q.exec(v))&&(ht[ct]=st[1],v=v.slice(0,st.index)),ht[ct]=ht[ct]||O&&et[3]&&S[ct]||"",et[4]&&(ht[ct]=ht[ct].toLowerCase())}b&&(ht.query=b(ht.query)),O&&S.slashes&&ht.pathname.charAt(0)!=="/"&&(ht.pathname!==""||S.pathname!=="")&&(ht.pathname=bY(ht.pathname,S.pathname)),ht.pathname.charAt(0)!=="/"&&Br(ht.protocol)&&(ht.pathname="/"+ht.pathname),jL(ht.port,ht.protocol)||(ht.host=ht.hostname,ht.port=""),ht.username=ht.password="",ht.auth&&(st=ht.auth.indexOf(":"),~st?(ht.username=ht.auth.slice(0,st),ht.username=encodeURIComponent(decodeURIComponent(ht.username)),ht.password=ht.auth.slice(st+1),ht.password=encodeURIComponent(decodeURIComponent(ht.password))):ht.username=encodeURIComponent(decodeURIComponent(ht.auth)),ht.auth=ht.password?ht.username+":"+ht.password:ht.username),ht.origin=ht.protocol!=="file:"&&Br(ht.protocol)&&ht.host?ht.protocol+"//"+ht.host:"null",ht.href=ht.toString()}function IY(v,S,b){var O=this;switch(v){case"query":typeof S=="string"&&S.length&&(S=(b||Fp.parse)(S)),O[v]=S;break;case"port":O[v]=S,jL(S,O.protocol)?S&&(O.host=O.hostname+":"+S):(O.host=O.hostname,O[v]="");break;case"hostname":O[v]=S,O.port&&(S+=":"+O.port),O.host=S;break;case"host":O[v]=S,WL.test(S)?(S=S.split(":"),O.port=S.pop(),O.hostname=S.join(":")):(O.hostname=S,O.port="");break;case"protocol":O.protocol=S.toLowerCase(),O.slashes=!b;break;case"pathname":case"hash":if(S){var M=v==="pathname"?"/":"#";O[v]=S.charAt(0)!==M?M+S:S}else O[v]=S;break;case"username":case"password":O[v]=encodeURIComponent(S);break;case"auth":var q=S.indexOf(":");~q?(O.username=S.slice(0,q),O.username=encodeURIComponent(decodeURIComponent(O.username)),O.password=S.slice(q+1),O.password=encodeURIComponent(decodeURIComponent(O.password))):O.username=encodeURIComponent(decodeURIComponent(S))}for(var et=0;et<CS.length;et++){var st=CS[et];st[4]&&(O[st[1]]=O[st[1]].toLowerCase())}return O.auth=O.password?O.username+":"+O.password:O.username,O.origin=O.protocol!=="file:"&&Br(O.protocol)&&O.host?O.protocol+"//"+O.host:"null",O.href=O.toString(),O}function AY(v){(!v||typeof v!="function")&&(v=Fp.stringify);var S,b=this,O=b.host,M=b.protocol;M&&M.charAt(M.length-1)!==":"&&(M+=":");var q=M+(b.protocol&&b.slashes||Br(b.protocol)?"//":"");return b.username?(q+=b.username,b.password&&(q+=":"+b.password),q+="@"):b.password?(q+=":"+b.password,q+="@"):b.protocol!=="file:"&&Br(b.protocol)&&!O&&b.pathname!=="/"&&(q+="@"),(O[O.length-1]===":"||WL.test(b.hostname)&&!b.port)&&(O+=":"),q+=O+b.pathname,S=typeof b.query=="object"?v(b.query):b.query,S&&(q+=S.charAt(0)!=="?"?"?"+S:S),b.hash&&(q+=b.hash),q}jr.prototype={set:IY,toString:AY};jr.extractProtocol=KL;jr.location=HL;jr.trimLeft=bS;jr.qs=Fp;qL.exports=jr});var Rn=bt((t9,YL)=>{"use strict";var wY=IS(),OY=function(){};YL.exports={getOrigin:function(v){if(!v)return null;var S=new wY(v);if(S.protocol==="file:")return null;var b=S.port;return b||(b=S.protocol==="https:"?"443":"80"),S.protocol+"//"+S.hostname+":"+b},isOriginEqual:function(v,S){var b=this.getOrigin(v)===this.getOrigin(S);return OY("same",v,S,b),b},isSchemeEqual:function(v,S){return v.split(":")[0]===S.split(":")[0]},addPath:function(v,S){var b=v.split("?");return b[0]+S+(b[1]?"?"+b[1]:"")},addQuery:function(v,S){return v+(v.indexOf("?")===-1?"?"+S:"&"+S)},isLoopbackAddr:function(v){return/^127\.([0-9]{1,3})\.([0-9]{1,3})\.([0-9]{1,3})$/i.test(v)||/^\[::1\]$/.test(v)}}});var Se=bt((e9,AS)=>{"use strict";typeof Object.create=="function"?AS.exports=function(S,b){b&&(S.super_=b,S.prototype=Object.create(b.prototype,{constructor:{value:S,enumerable:!1,writable:!0,configurable:!0}}))}:AS.exports=function(S,b){if(b){S.super_=b;var O=function(){};O.prototype=b.prototype,S.prototype=new O,S.prototype.constructor=S}}});var wS=bt((i9,zL)=>{"use strict";function Bp(){this._listeners={}}Bp.prototype.addEventListener=function(v,S){v in this._listeners||(this._listeners[v]=[]);var b=this._listeners[v];b.indexOf(S)===-1&&(b=b.concat([S])),this._listeners[v]=b};Bp.prototype.removeEventListener=function(v,S){var b=this._listeners[v];if(b){var O=b.indexOf(S);if(O!==-1){b.length>1?this._listeners[v]=b.slice(0,O).concat(b.slice(O+1)):delete this._listeners[v];return}}};Bp.prototype.dispatchEvent=function(){var v=arguments[0],S=v.type,b=arguments.length===1?[v]:Array.apply(null,arguments);if(this["on"+S]&&this["on"+S].apply(this,b),S in this._listeners)for(var O=this._listeners[S],M=0;M<O.length;M++)O[M].apply(this,b)};zL.exports=Bp});var Vi=bt((n9,XL)=>{"use strict";var NY=Se(),jp=wS();function ts(){jp.call(this)}NY(ts,jp);ts.prototype.removeAllListeners=function(v){v?delete this._listeners[v]:this._listeners={}};ts.prototype.once=function(v,S){var b=this,O=!1;function M(){b.removeListener(v,M),O||(O=!0,S.apply(this,arguments))}this.on(v,M)};ts.prototype.emit=function(){var v=arguments[0],S=this._listeners[v];if(S){for(var b=arguments.length,O=new Array(b-1),M=1;M<b;M++)O[M-1]=arguments[M];for(var q=0;q<S.length;q++)S[q].apply(this,O)}};ts.prototype.on=ts.prototype.addListener=jp.prototype.addEventListener;ts.prototype.removeListener=jp.prototype.removeEventListener;XL.exports.EventEmitter=ts});var QL=bt((r9,OS)=>{"use strict";var JL=global.WebSocket||global.MozWebSocket;JL?OS.exports=function(S){return new JL(S)}:OS.exports=void 0});var ik=bt((o9,ek)=>{"use strict";var ZL=ho(),DY=Rn(),PY=Se(),$L=Vi().EventEmitter,tk=QL(),po=function(){};function _o(v,S,b){if(!_o.enabled())throw new Error("Transport created when disabled");$L.call(this),po("constructor",v);var O=this,M=DY.addPath(v,"/websocket");M.slice(0,5)==="https"?M="wss"+M.slice(5):M="ws"+M.slice(4),this.url=M,this.ws=new tk(this.url,[],b),this.ws.onmessage=function(q){po("message event",q.data),O.emit("message",q.data)},this.unloadRef=ZL.unloadAdd(function(){po("unload"),O.ws.close()}),this.ws.onclose=function(q){po("close event",q.code,q.reason),O.emit("close",q.code,q.reason),O._cleanup()},this.ws.onerror=function(q){po("error event",q),O.emit("close",1006,"WebSocket connection broken"),O._cleanup()}}PY(_o,$L);_o.prototype.send=function(v){var S="["+v+"]";po("send",S),this.ws.send(S)};_o.prototype.close=function(){po("close");var v=this.ws;this._cleanup(),v&&v.close()};_o.prototype._cleanup=function(){po("_cleanup");var v=this.ws;v&&(v.onmessage=v.onclose=v.onerror=null),ZL.unloadDel(this.unloadRef),this.unloadRef=this.ws=null,this.removeAllListeners()};_o.enabled=function(){return po("enabled"),!!tk};_o.transportName="websocket";_o.roundTrips=2;ek.exports=_o});var ok=bt((s9,rk)=>{"use strict";var LY=Se(),nk=Vi().EventEmitter,mo=function(){};function qs(v,S){mo(v),nk.call(this),this.sendBuffer=[],this.sender=S,this.url=v}LY(qs,nk);qs.prototype.send=function(v){mo("send",v),this.sendBuffer.push(v),this.sendStop||this.sendSchedule()};qs.prototype.sendScheduleWait=function(){mo("sendScheduleWait");var v=this,S;this.sendStop=function(){mo("sendStop"),v.sendStop=null,clearTimeout(S)},S=setTimeout(function(){mo("timeout"),v.sendStop=null,v.sendSchedule()},25)};qs.prototype.sendSchedule=function(){mo("sendSchedule",this.sendBuffer.length);var v=this;if(this.sendBuffer.length>0){var S="["+this.sendBuffer.join(",")+"]";this.sendStop=this.sender(this.url,S,function(b){v.sendStop=null,b?(mo("error",b),v.emit("close",b.code||1006,"Sending error: "+b),v.close()):v.sendScheduleWait()}),this.sendBuffer=[]}};qs.prototype._cleanup=function(){mo("_cleanup"),this.removeAllListeners()};qs.prototype.close=function(){mo("close"),this._cleanup(),this.sendStop&&(this.sendStop(),this.sendStop=null)};rk.exports=qs});var ck=bt((a9,ak)=>{"use strict";var kY=Se(),sk=Vi().EventEmitter,hl=function(){};function Gp(v,S,b){hl(S),sk.call(this),this.Receiver=v,this.receiveUrl=S,this.AjaxObject=b,this._scheduleReceiver()}kY(Gp,sk);Gp.prototype._scheduleReceiver=function(){hl("_scheduleReceiver");var v=this,S=this.poll=new this.Receiver(this.receiveUrl,this.AjaxObject);S.on("message",function(b){hl("message",b),v.emit("message",b)}),S.once("close",function(b,O){hl("close",b,O,v.pollIsClosing),v.poll=S=null,v.pollIsClosing||(O==="network"?v._scheduleReceiver():(v.emit("close",b||1006,O),v.removeAllListeners()))})};Gp.prototype.abort=function(){hl("abort"),this.removeAllListeners(),this.pollIsClosing=!0,this.poll&&this.poll.abort()};ak.exports=Gp});var PS=bt((c9,dk)=>{"use strict";var MY=Se(),UY=Rn(),NS=ok(),xY=ck(),Wp=function(){};function DS(v,S,b,O,M){var q=UY.addPath(v,S);Wp(q);var et=this;NS.call(this,v,b),this.poll=new xY(O,q,M),this.poll.on("message",function(st){Wp("poll message",st),et.emit("message",st)}),this.poll.once("close",function(st,ct){Wp("poll close",st,ct),et.poll=null,et.emit("close",st,ct),et.close()})}MY(DS,NS);DS.prototype.close=function(){NS.prototype.close.call(this),Wp("close"),this.removeAllListeners(),this.poll&&(this.poll.abort(),this.poll=null)};dk.exports=DS});var Ys=bt((d9,hk)=>{"use strict";var VY=Se(),FY=Rn(),lk=PS(),LS=function(){};function BY(v){return function(S,b,O){LS("create ajax sender",S,b);var M={};typeof b=="string"&&(M.headers={"Content-type":"text/plain"});var q=FY.addPath(S,"/xhr_send"),et=new v("POST",q,b,M);return et.once("finish",function(st){if(LS("finish",st),et=null,st!==200&&st!==204)return O(new Error("http status "+st));O()}),function(){LS("abort"),et.close(),et=null;var st=new Error("Aborted");st.code=1e3,O(st)}}}function uk(v,S,b,O){lk.call(this,v,S,BY(O),b,O)}VY(uk,lk);hk.exports=uk});var _l=bt((l9,_k)=>{"use strict";var jY=Se(),pk=Vi().EventEmitter,es=function(){};function pl(v,S){es(v),pk.call(this);var b=this;this.bufferPosition=0,this.xo=new S("POST",v,null),this.xo.on("chunk",this._chunkHandler.bind(this)),this.xo.once("finish",function(O,M){es("finish",O,M),b._chunkHandler(O,M),b.xo=null;var q=O===200?"network":"permanent";es("close",q),b.emit("close",null,q),b._cleanup()})}jY(pl,pk);pl.prototype._chunkHandler=function(v,S){if(es("_chunkHandler",v),!(v!==200||!S))for(var b=-1;;this.bufferPosition+=b+1){var O=S.slice(this.bufferPosition);if(b=O.indexOf(`
`),b===-1)break;var M=O.slice(0,b);M&&(es("message",M),this.emit("message",M))}};pl.prototype._cleanup=function(){es("_cleanup"),this.removeAllListeners()};pl.prototype.abort=function(){es("abort"),this.xo&&(this.xo.close(),es("close"),this.emit("close",null,"user"),this.xo=null),this._cleanup()};_k.exports=pl});var kS=bt((u9,Sk)=>{"use strict";var Ek=Vi().EventEmitter,GY=Se(),fk=ho(),WY=Rn(),ml=global.XMLHttpRequest,cn=function(){};function Gr(v,S,b,O){cn(v,S);var M=this;Ek.call(this),setTimeout(function(){M._start(v,S,b,O)},0)}GY(Gr,Ek);Gr.prototype._start=function(v,S,b,O){var M=this;try{this.xhr=new ml}catch{}if(!this.xhr){cn("no xhr"),this.emit("finish",0,"no xhr support"),this._cleanup();return}S=WY.addQuery(S,"t="+ +new Date),this.unloadRef=fk.unloadAdd(function(){cn("unload cleanup"),M._cleanup(!0)});try{this.xhr.open(v,S,!0),this.timeout&&"timeout"in this.xhr&&(this.xhr.timeout=this.timeout,this.xhr.ontimeout=function(){cn("xhr timeout"),M.emit("finish",0,""),M._cleanup(!1)})}catch(et){cn("exception",et),this.emit("finish",0,""),this._cleanup(!1);return}if((!O||!O.noCredentials)&&Gr.supportsCORS&&(cn("withCredentials"),this.xhr.withCredentials=!0),O&&O.headers)for(var q in O.headers)this.xhr.setRequestHeader(q,O.headers[q]);this.xhr.onreadystatechange=function(){if(M.xhr){var et=M.xhr,st,ct;switch(cn("readyState",et.readyState),et.readyState){case 3:try{ct=et.status,st=et.responseText}catch{}cn("status",ct),ct===1223&&(ct=204),ct===200&&st&&st.length>0&&(cn("chunk"),M.emit("chunk",ct,st));break;case 4:ct=et.status,cn("status",ct),ct===1223&&(ct=204),(ct===12005||ct===12029)&&(ct=0),cn("finish",ct,et.responseText),M.emit("finish",ct,et.responseText),M._cleanup(!1);break}}};try{M.xhr.send(b)}catch{M.emit("finish",0,""),M._cleanup(!1)}};Gr.prototype._cleanup=function(v){if(cn("cleanup"),!!this.xhr){if(this.removeAllListeners(),fk.unloadDel(this.unloadRef),this.xhr.onreadystatechange=function(){},this.xhr.ontimeout&&(this.xhr.ontimeout=null),v)try{this.xhr.abort()}catch{}this.unloadRef=this.xhr=null}};Gr.prototype.close=function(){cn("close"),this._cleanup(!0)};Gr.enabled=!!ml;var mk=["Active"].concat("Object").join("X");!Gr.enabled&&mk in global&&(cn("overriding xmlhttprequest"),ml=function(){try{return new global[mk]("Microsoft.XMLHTTP")}catch{return null}},Gr.enabled=!!new ml);var gk=!1;try{gk="withCredentials"in new ml}catch{}Gr.supportsCORS=gk;Sk.exports=Gr});var El=bt((h9,Tk)=>{"use strict";var HY=Se(),Hp=kS();function MS(v,S,b,O){Hp.call(this,v,S,b,O)}HY(MS,Hp);MS.enabled=Hp.enabled&&Hp.supportsCORS;Tk.exports=MS});var yc=bt((p9,Rk)=>{"use strict";var KY=Se(),US=kS();function xS(v,S,b){US.call(this,v,S,b,{noCredentials:!0})}KY(xS,US);xS.enabled=US.enabled;Rk.exports=xS});var Cc=bt((_9,vk)=>{"use strict";vk.exports={isOpera:function(){return global.navigator&&/opera/i.test(global.navigator.userAgent)},isKonqueror:function(){return global.navigator&&/konqueror/i.test(global.navigator.userAgent)},hasDomain:function(){if(!global.document)return!0;try{return!!global.document.domain}catch{return!1}}}});var bk=bt((m9,Ck)=>{"use strict";var qY=Se(),yk=Ys(),YY=_l(),VS=El(),zY=yc(),XY=Cc();function bc(v){if(!zY.enabled&&!VS.enabled)throw new Error("Transport created when disabled");yk.call(this,v,"/xhr_streaming",YY,VS)}qY(bc,yk);bc.enabled=function(v){return v.nullOrigin||XY.isOpera()?!1:VS.enabled};bc.transportName="xhr-streaming";bc.roundTrips=2;bc.needBody=!!global.document;Ck.exports=bc});var Kp=bt((E9,wk)=>{"use strict";var Ik=Vi().EventEmitter,JY=Se(),Ak=ho(),QY=Cc(),ZY=Rn(),is=function(){};function zs(v,S,b){is(v,S);var O=this;Ik.call(this),setTimeout(function(){O._start(v,S,b)},0)}JY(zs,Ik);zs.prototype._start=function(v,S,b){is("_start");var O=this,M=new global.XDomainRequest;S=ZY.addQuery(S,"t="+ +new Date),M.onerror=function(){is("onerror"),O._error()},M.ontimeout=function(){is("ontimeout"),O._error()},M.onprogress=function(){is("progress",M.responseText),O.emit("chunk",200,M.responseText)},M.onload=function(){is("load"),O.emit("finish",200,M.responseText),O._cleanup(!1)},this.xdr=M,this.unloadRef=Ak.unloadAdd(function(){O._cleanup(!0)});try{this.xdr.open(v,S),this.timeout&&(this.xdr.timeout=this.timeout),this.xdr.send(b)}catch{this._error()}};zs.prototype._error=function(){this.emit("finish",0,""),this._cleanup(!1)};zs.prototype._cleanup=function(v){if(is("cleanup",v),!!this.xdr){if(this.removeAllListeners(),Ak.unloadDel(this.unloadRef),this.xdr.ontimeout=this.xdr.onerror=this.xdr.onprogress=this.xdr.onload=null,v)try{this.xdr.abort()}catch{}this.unloadRef=this.xdr=null}};zs.prototype.close=function(){is("close"),this._cleanup(!0)};zs.enabled=!!(global.XDomainRequest&&QY.hasDomain());wk.exports=zs});var BS=bt((f9,Nk)=>{"use strict";var $Y=Se(),Ok=Ys(),tz=_l(),FS=Kp();function fl(v){if(!FS.enabled)throw new Error("Transport created when disabled");Ok.call(this,v,"/xhr_streaming",tz,FS)}$Y(fl,Ok);fl.enabled=function(v){return v.cookie_needed||v.nullOrigin?!1:FS.enabled&&v.sameScheme};fl.transportName="xdr-streaming";fl.roundTrips=2;Nk.exports=fl});var jS=bt((g9,Dk)=>{"use strict";Dk.exports=global.EventSource});var kk=bt((S9,Lk)=>{"use strict";var ez=Se(),Pk=Vi().EventEmitter,iz=jS(),Ic=function(){};function gl(v){Ic(v),Pk.call(this);var S=this,b=this.es=new iz(v);b.onmessage=function(O){Ic("message",O.data),S.emit("message",decodeURI(O.data))},b.onerror=function(O){Ic("error",b.readyState,O);var M=b.readyState!==2?"network":"permanent";S._cleanup(),S._close(M)}}ez(gl,Pk);gl.prototype.abort=function(){Ic("abort"),this._cleanup(),this._close("user")};gl.prototype._cleanup=function(){Ic("cleanup");var v=this.es;v&&(v.onmessage=v.onerror=null,v.close(),this.es=null)};gl.prototype._close=function(v){Ic("close",v);var S=this;setTimeout(function(){S.emit("close",null,v),S.removeAllListeners()},200)};Lk.exports=gl});var GS=bt((T9,Uk)=>{"use strict";var nz=Se(),Mk=Ys(),rz=kk(),oz=El(),sz=jS();function Ac(v){if(!Ac.enabled())throw new Error("Transport created when disabled");Mk.call(this,v,"/eventsource",rz,oz)}nz(Ac,Mk);Ac.enabled=function(){return!!sz};Ac.transportName="eventsource";Ac.roundTrips=2;Uk.exports=Ac});var WS=bt((R9,xk)=>{"use strict";xk.exports="1.6.1"});var wc=bt((v9,Eo)=>{"use strict";var qp=ho(),az=Cc(),Xs=function(){};Eo.exports={WPrefix:"_jp",currentWindowId:null,polluteGlobalNamespace:function(){Eo.exports.WPrefix in global||(global[Eo.exports.WPrefix]={})},postMessage:function(v,S){global.parent!==global?global.parent.postMessage(JSON.stringify({windowId:Eo.exports.currentWindowId,type:v,data:S||""}),"*"):Xs("Cannot postMessage, no parent window.",v,S)},createIframe:function(v,S){var b=global.document.createElement("iframe"),O,M,q=function(){Xs("unattach"),clearTimeout(O);try{b.onload=null}catch{}b.onerror=null},et=function(){Xs("cleanup"),b&&(q(),setTimeout(function(){b&&b.parentNode.removeChild(b),b=null},0),qp.unloadDel(M))},st=function(mt){Xs("onerror",mt),b&&(et(),S(mt))},ct=function(mt,Wt){Xs("post",mt,Wt),setTimeout(function(){try{b&&b.contentWindow&&b.contentWindow.postMessage(mt,Wt)}catch{}},0)};return b.src=v,b.style.display="none",b.style.position="absolute",b.onerror=function(){st("onerror")},b.onload=function(){Xs("onload"),clearTimeout(O),O=setTimeout(function(){st("onload timeout")},2e3)},global.document.body.appendChild(b),O=setTimeout(function(){st("timeout")},15e3),M=qp.unloadAdd(et),{post:ct,cleanup:et,loaded:q}},createHtmlfile:function(v,S){var b=["Active"].concat("Object").join("X"),O=new global[b]("htmlfile"),M,q,et,st=function(){clearTimeout(M),et.onerror=null},ct=function(){O&&(st(),qp.unloadDel(q),et.parentNode.removeChild(et),et=O=null,CollectGarbage())},mt=function(jt){Xs("onerror",jt),O&&(ct(),S(jt))},Wt=function(jt,Dc){try{setTimeout(function(){et&&et.contentWindow&&et.contentWindow.postMessage(jt,Dc)},0)}catch{}};O.open(),O.write('<html><script>document.domain="'+global.document.domain+'";<\/script></html>'),O.close(),O.parentWindow[Eo.exports.WPrefix]=global[Eo.exports.WPrefix];var ht=O.createElement("div");return O.body.appendChild(ht),et=O.createElement("iframe"),ht.appendChild(et),et.src=v,et.onerror=function(){mt("onerror")},M=setTimeout(function(){mt("timeout")},15e3),q=qp.unloadAdd(ct),{post:Wt,cleanup:ct,loaded:st}}};Eo.exports.iframeEnabled=!1;global.document&&(Eo.exports.iframeEnabled=(typeof global.postMessage=="function"||typeof global.postMessage=="object")&&!az.isKonqueror())});var KS=bt((y9,jk)=>{"use strict";var cz=Se(),Vk=Vi().EventEmitter,dz=WS(),HS=Rn(),Fk=wc(),Bk=ho(),lz=Ks(),Wr=function(){};function Hr(v,S,b){if(!Hr.enabled())throw new Error("Transport created when disabled");Vk.call(this);var O=this;this.origin=HS.getOrigin(b),this.baseUrl=b,this.transUrl=S,this.transport=v,this.windowId=lz.string(8);var M=HS.addPath(b,"/iframe.html")+"#"+this.windowId;Wr(v,S,M),this.iframeObj=Fk.createIframe(M,function(q){Wr("err callback"),O.emit("close",1006,"Unable to load an iframe ("+q+")"),O.close()}),this.onmessageCallback=this._message.bind(this),Bk.attachEvent("message",this.onmessageCallback)}cz(Hr,Vk);Hr.prototype.close=function(){if(Wr("close"),this.removeAllListeners(),this.iframeObj){Bk.detachEvent("message",this.onmessageCallback);try{this.postMessage("c")}catch{}this.iframeObj.cleanup(),this.iframeObj=null,this.onmessageCallback=this.iframeObj=null}};Hr.prototype._message=function(v){if(Wr("message",v.data),!HS.isOriginEqual(v.origin,this.origin)){Wr("not same origin",v.origin,this.origin);return}var S;try{S=JSON.parse(v.data)}catch{Wr("bad json",v.data);return}if(S.windowId!==this.windowId){Wr("mismatched window id",S.windowId,this.windowId);return}switch(S.type){case"s":this.iframeObj.loaded(),this.postMessage("s",JSON.stringify([dz,this.transport,this.transUrl,this.baseUrl]));break;case"t":this.emit("message",S.data);break;case"c":var b;try{b=JSON.parse(S.data)}catch{Wr("bad json",S.data);return}this.emit("close",b[0],b[1]),this.close();break}};Hr.prototype.postMessage=function(v,S){Wr("postMessage",v,S),this.iframeObj.post(JSON.stringify({windowId:this.windowId,type:v,data:S||""}),this.origin)};Hr.prototype.send=function(v){Wr("send",v),this.postMessage("m",v)};Hr.enabled=function(){return Fk.iframeEnabled};Hr.transportName="iframe";Hr.roundTrips=2;jk.exports=Hr});var Yp=bt((C9,Gk)=>{"use strict";Gk.exports={isObject:function(v){var S=typeof v;return S==="function"||S==="object"&&!!v},extend:function(v){if(!this.isObject(v))return v;for(var S,b,O=1,M=arguments.length;O<M;O++){S=arguments[O];for(b in S)Object.prototype.hasOwnProperty.call(S,b)&&(v[b]=S[b])}return v}}});var Xp=bt((b9,Wk)=>{"use strict";var uz=Se(),zp=KS(),hz=Yp();Wk.exports=function(v){function S(b,O){zp.call(this,v.transportName,b,O)}return uz(S,zp),S.enabled=function(b,O){if(!global.document)return!1;var M=hz.extend({},O);return M.sameOrigin=!0,v.enabled(M)&&zp.enabled()},S.transportName="iframe-"+v.transportName,S.needBody=!0,S.roundTrips=zp.roundTrips+v.roundTrips-1,S.facadeTransport=v,S}});var Yk=bt((I9,qk)=>{"use strict";var pz=Se(),Js=wc(),_z=Rn(),Kk=Vi().EventEmitter,mz=Ks(),fo=function(){};function pr(v){fo(v),Kk.call(this);var S=this;Js.polluteGlobalNamespace(),this.id="a"+mz.string(6),v=_z.addQuery(v,"c="+decodeURIComponent(Js.WPrefix+"."+this.id)),fo("using htmlfile",pr.htmlfileEnabled);var b=pr.htmlfileEnabled?Js.createHtmlfile:Js.createIframe;global[Js.WPrefix][this.id]={start:function(){fo("start"),S.iframeObj.loaded()},message:function(O){fo("message",O),S.emit("message",O)},stop:function(){fo("stop"),S._cleanup(),S._close("network")}},this.iframeObj=b(v,function(){fo("callback"),S._cleanup(),S._close("permanent")})}pz(pr,Kk);pr.prototype.abort=function(){fo("abort"),this._cleanup(),this._close("user")};pr.prototype._cleanup=function(){fo("_cleanup"),this.iframeObj&&(this.iframeObj.cleanup(),this.iframeObj=null),delete global[Js.WPrefix][this.id]};pr.prototype._close=function(v){fo("_close",v),this.emit("close",null,v),this.removeAllListeners()};pr.htmlfileEnabled=!1;var Hk=["Active"].concat("Object").join("X");if(Hk in global)try{pr.htmlfileEnabled=!!new global[Hk]("htmlfile")}catch{}pr.enabled=pr.htmlfileEnabled||Js.iframeEnabled;qk.exports=pr});var YS=bt((A9,Xk)=>{"use strict";var Ez=Se(),qS=Yk(),fz=yc(),zk=Ys();function Sl(v){if(!qS.enabled)throw new Error("Transport created when disabled");zk.call(this,v,"/htmlfile",qS,fz)}Ez(Sl,zk);Sl.enabled=function(v){return qS.enabled&&v.sameOrigin};Sl.transportName="htmlfile";Sl.roundTrips=2;Xk.exports=Sl});var XS=bt((w9,Zk)=>{"use strict";var gz=Se(),Jk=Ys(),Sz=_l(),zS=El(),Qk=yc();function Tl(v){if(!Qk.enabled&&!zS.enabled)throw new Error("Transport created when disabled");Jk.call(this,v,"/xhr",Sz,zS)}gz(Tl,Jk);Tl.enabled=function(v){return v.nullOrigin?!1:Qk.enabled&&v.sameOrigin?!0:zS.enabled};Tl.transportName="xhr-polling";Tl.roundTrips=2;Zk.exports=Tl});var i1=bt((O9,e1)=>{"use strict";var Tz=Se(),t1=Ys(),Rz=BS(),vz=_l(),$k=Kp();function Rl(v){if(!$k.enabled)throw new Error("Transport created when disabled");t1.call(this,v,"/xhr",vz,$k)}Tz(Rl,t1);Rl.enabled=Rz.enabled;Rl.transportName="xdr-polling";Rl.roundTrips=2;e1.exports=Rl});var s1=bt((N9,o1)=>{"use strict";var vl=wc(),n1=Ks(),yz=Cc(),Cz=Rn(),bz=Se(),r1=Vi().EventEmitter,_r=function(){};function Yn(v){_r(v);var S=this;r1.call(this),vl.polluteGlobalNamespace(),this.id="a"+n1.string(6);var b=Cz.addQuery(v,"c="+encodeURIComponent(vl.WPrefix+"."+this.id));global[vl.WPrefix][this.id]=this._callback.bind(this),this._createScript(b),this.timeoutId=setTimeout(function(){_r("timeout"),S._abort(new Error("JSONP script loaded abnormally (timeout)"))},Yn.timeout)}bz(Yn,r1);Yn.prototype.abort=function(){if(_r("abort"),global[vl.WPrefix][this.id]){var v=new Error("JSONP user aborted read");v.code=1e3,this._abort(v)}};Yn.timeout=35e3;Yn.scriptErrorTimeout=1e3;Yn.prototype._callback=function(v){_r("_callback",v),this._cleanup(),!this.aborting&&(v&&(_r("message",v),this.emit("message",v)),this.emit("close",null,"network"),this.removeAllListeners())};Yn.prototype._abort=function(v){_r("_abort",v),this._cleanup(),this.aborting=!0,this.emit("close",v.code,v.message),this.removeAllListeners()};Yn.prototype._cleanup=function(){if(_r("_cleanup"),clearTimeout(this.timeoutId),this.script2&&(this.script2.parentNode.removeChild(this.script2),this.script2=null),this.script){var v=this.script;v.parentNode.removeChild(v),v.onreadystatechange=v.onerror=v.onload=v.onclick=null,this.script=null}delete global[vl.WPrefix][this.id]};Yn.prototype._scriptError=function(){_r("_scriptError");var v=this;this.errorTimer||(this.errorTimer=setTimeout(function(){v.loadedOkay||v._abort(new Error("JSONP script loaded abnormally (onerror)"))},Yn.scriptErrorTimeout))};Yn.prototype._createScript=function(v){_r("_createScript",v);var S=this,b=this.script=global.document.createElement("script"),O;if(b.id="a"+n1.string(8),b.src=v,b.type="text/javascript",b.charset="UTF-8",b.onerror=this._scriptError.bind(this),b.onload=function(){_r("onload"),S._abort(new Error("JSONP script loaded abnormally (onload)"))},b.onreadystatechange=function(){if(_r("onreadystatechange",b.readyState),/loaded|closed/.test(b.readyState)){if(b&&b.htmlFor&&b.onclick){S.loadedOkay=!0;try{b.onclick()}catch{}}b&&S._abort(new Error("JSONP script loaded abnormally (onreadystatechange)"))}},typeof b.async>"u"&&global.document.attachEvent)if(yz.isOpera())O=this.script2=global.document.createElement("script"),O.text="try{var a = document.getElementById('"+b.id+"'); if(a)a.onerror();}catch(x){};",b.async=O.async=!1;else{try{b.htmlFor=b.id,b.event="onclick"}catch{}b.async=!0}typeof b.async<"u"&&(b.async=!0);var M=global.document.getElementsByTagName("head")[0];M.insertBefore(b,M.firstChild),O&&M.insertBefore(O,M.firstChild)};o1.exports=Yn});var d1=bt((D9,c1)=>{"use strict";var Iz=Ks(),a1=Rn(),go=function(){},vn,yl;function Az(v){go("createIframe",v);try{return global.document.createElement('<iframe name="'+v+'">')}catch{var S=global.document.createElement("iframe");return S.name=v,S}}function wz(){go("createForm"),vn=global.document.createElement("form"),vn.style.display="none",vn.style.position="absolute",vn.method="POST",vn.enctype="application/x-www-form-urlencoded",vn.acceptCharset="UTF-8",yl=global.document.createElement("textarea"),yl.name="d",vn.appendChild(yl),global.document.body.appendChild(vn)}c1.exports=function(v,S,b){go(v,S),vn||wz();var O="a"+Iz.string(8);vn.target=O,vn.action=a1.addQuery(a1.addPath(v,"/jsonp_send"),"i="+O);var M=Az(O);M.id=O,M.style.display="none",vn.appendChild(M);try{yl.value=S}catch{}vn.submit();var q=function(et){go("completed",O,et),M.onerror&&(M.onreadystatechange=M.onerror=M.onload=null,setTimeout(function(){go("cleaning up",O),M.parentNode.removeChild(M),M=null},500),yl.value="",b(et))};return M.onerror=function(){go("onerror",O),q()},M.onload=function(){go("onload",O),q()},M.onreadystatechange=function(et){go("onreadystatechange",O,M.readyState,et),M.readyState==="complete"&&q()},function(){go("aborted",O),q(new Error("Aborted"))}}});var h1=bt((P9,u1)=>{"use strict";var Oz=Se(),l1=PS(),Nz=s1(),Dz=d1();function Qs(v){if(!Qs.enabled())throw new Error("Transport created when disabled");l1.call(this,v,"/jsonp",Dz,Nz)}Oz(Qs,l1);Qs.enabled=function(){return!!global.document};Qs.transportName="jsonp-polling";Qs.roundTrips=1;Qs.needBody=!0;u1.exports=Qs});var _1=bt((L9,p1)=>{"use strict";p1.exports=[ik(),bk(),BS(),GS(),Xp()(GS()),YS(),Xp()(YS()),XS(),i1(),Xp()(XS()),h1()]});var R1=bt(()=>{"use strict";var Cl=Array.prototype,$S=Object.prototype,Pz=Function.prototype,bl=String.prototype,JS=Cl.slice,tT=$S.toString,f1=function(v){return $S.toString.call(v)==="[object Function]"},Lz=function(S){return tT.call(S)==="[object Array]"},g1=function(S){return tT.call(S)==="[object String]"},kz=Object.defineProperty&&function(){try{return Object.defineProperty({},"x",{}),!0}catch{return!1}}(),ZS;kz?ZS=function(v,S,b,O){!O&&S in v||Object.defineProperty(v,S,{configurable:!0,enumerable:!1,writable:!0,value:b})}:ZS=function(v,S,b,O){!O&&S in v||(v[S]=b)};var Il=function(v,S,b){for(var O in S)$S.hasOwnProperty.call(S,O)&&ZS(v,O,S[O],b)},S1=function(v){if(v==null)throw new TypeError("can't convert "+v+" to object");return Object(v)};function Mz(v){var S=+v;return S!==S?S=0:S!==0&&S!==1/0&&S!==-1/0&&(S=(S>0||-1)*Math.floor(Math.abs(S))),S}function Uz(v){return v>>>0}function QS(){}Il(Pz,{bind:function(S){var b=this;if(!f1(b))throw new TypeError("Function.prototype.bind called on incompatible "+b);for(var O=JS.call(arguments,1),M=function(){if(this instanceof ct){var mt=b.apply(this,O.concat(JS.call(arguments)));return Object(mt)===mt?mt:this}else return b.apply(S,O.concat(JS.call(arguments)))},q=Math.max(0,b.length-O.length),et=[],st=0;st<q;st++)et.push("$"+st);var ct=Function("binder","return function ("+et.join(",")+"){ return binder.apply(this, arguments); }")(M);return b.prototype&&(QS.prototype=b.prototype,ct.prototype=new QS,QS.prototype=null),ct}});Il(Array,{isArray:Lz});var m1=Object("a"),T1=m1[0]!=="a"||!(0 in m1),xz=function(S){var b=!0,O=!0;return S&&(S.call("foo",function(M,q,et){typeof et!="object"&&(b=!1)}),S.call([1],function(){"use strict";O=typeof this=="string"},"x")),!!S&&b&&O};Il(Cl,{forEach:function(S){var b=S1(this),O=T1&&g1(this)?this.split(""):b,M=arguments[1],q=-1,et=O.length>>>0;if(!f1(S))throw new TypeError;for(;++q<et;)q in O&&S.call(M,O[q],q,b)}},!xz(Cl.forEach));var Vz=Array.prototype.indexOf&&[0,1].indexOf(1,2)!==-1;Il(Cl,{indexOf:function(S){var b=T1&&g1(this)?this.split(""):S1(this),O=b.length>>>0;if(!O)return-1;var M=0;for(arguments.length>1&&(M=Mz(arguments[1])),M=M>=0?M:Math.max(0,O+M);M<O;M++)if(M in b&&b[M]===S)return M;return-1}},Vz);var E1=bl.split;"ab".split(/(?:ab)*/).length!==2||".".split(/(.?)(.?)/).length!==4||"tesst".split(/(s)*/)[1]==="t"||"test".split(/(?:)/,-1).length!==4||"".split(/.?/).length||".".split(/()()/).length>1?function(){var v=/()??/.exec("")[1]===void 0;bl.split=function(S,b){var O=this;if(S===void 0&&b===0)return[];if(tT.call(S)!=="[object RegExp]")return E1.call(this,S,b);var M=[],q=(S.ignoreCase?"i":"")+(S.multiline?"m":"")+(S.extended?"x":"")+(S.sticky?"y":""),et=0,st,ct,mt,Wt;for(S=new RegExp(S.source,q+"g"),O+="",v||(st=new RegExp("^"+S.source+"$(?!\\s)",q)),b=b===void 0?-1>>>0:Uz(b);(ct=S.exec(O))&&(mt=ct.index+ct[0].length,!(mt>et&&(M.push(O.slice(et,ct.index)),!v&&ct.length>1&&ct[0].replace(st,function(){for(var ht=1;ht<arguments.length-2;ht++)arguments[ht]===void 0&&(ct[ht]=void 0)}),ct.length>1&&ct.index<O.length&&Cl.push.apply(M,ct.slice(1)),Wt=ct[0].length,et=mt,M.length>=b)));)S.lastIndex===ct.index&&S.lastIndex++;return et===O.length?(Wt||!S.test(""))&&M.push(""):M.push(O.slice(et)),M.length>b?M.slice(0,b):M}}():"0".split(void 0,0).length&&(bl.split=function(S,b){return S===void 0&&b===0?[]:E1.call(this,S,b)});var Fz=bl.substr,Bz="".substr&&"0b".substr(-1)!=="b";Il(bl,{substr:function(S,b){return Fz.call(this,S<0&&(S=this.length+S)<0?0:S,b)}},Bz)});var y1=bt((U9,v1)=>{"use strict";var Jp=/[\x00-\x1f\ud800-\udfff\ufffe\uffff\u0300-\u0333\u033d-\u0346\u034a-\u034c\u0350-\u0352\u0357-\u0358\u035c-\u0362\u0374\u037e\u0387\u0591-\u05af\u05c4\u0610-\u0617\u0653-\u0654\u0657-\u065b\u065d-\u065e\u06df-\u06e2\u06eb-\u06ec\u0730\u0732-\u0733\u0735-\u0736\u073a\u073d\u073f-\u0741\u0743\u0745\u0747\u07eb-\u07f1\u0951\u0958-\u095f\u09dc-\u09dd\u09df\u0a33\u0a36\u0a59-\u0a5b\u0a5e\u0b5c-\u0b5d\u0e38-\u0e39\u0f43\u0f4d\u0f52\u0f57\u0f5c\u0f69\u0f72-\u0f76\u0f78\u0f80-\u0f83\u0f93\u0f9d\u0fa2\u0fa7\u0fac\u0fb9\u1939-\u193a\u1a17\u1b6b\u1cda-\u1cdb\u1dc0-\u1dcf\u1dfc\u1dfe\u1f71\u1f73\u1f75\u1f77\u1f79\u1f7b\u1f7d\u1fbb\u1fbe\u1fc9\u1fcb\u1fd3\u1fdb\u1fe3\u1feb\u1fee-\u1fef\u1ff9\u1ffb\u1ffd\u2000-\u2001\u20d0-\u20d1\u20d4-\u20d7\u20e7-\u20e9\u2126\u212a-\u212b\u2329-\u232a\u2adc\u302b-\u302c\uaab2-\uaab3\uf900-\ufa0d\ufa10\ufa12\ufa15-\ufa1e\ufa20\ufa22\ufa25-\ufa26\ufa2a-\ufa2d\ufa30-\ufa6d\ufa70-\ufad9\ufb1d\ufb1f\ufb2a-\ufb36\ufb38-\ufb3c\ufb3e\ufb40-\ufb41\ufb43-\ufb44\ufb46-\ufb4e\ufff0-\uffff]/g,eT,jz=function(v){var S,b={},O=[];for(S=0;S<65536;S++)O.push(String.fromCharCode(S));return v.lastIndex=0,O.join("").replace(v,function(M){return b[M]="\\u"+("0000"+M.charCodeAt(0).toString(16)).slice(-4),""}),v.lastIndex=0,b};v1.exports={quote:function(v){var S=JSON.stringify(v);return Jp.lastIndex=0,Jp.test(S)?(eT||(eT=jz(Jp)),S.replace(Jp,function(b){return eT[b]})):S}}});var b1=bt((x9,C1)=>{"use strict";var Qp=function(){};C1.exports=function(v){return{filterToEnabled:function(S,b){var O={main:[],facade:[]};return S?typeof S=="string"&&(S=[S]):S=[],v.forEach(function(M){if(M){if(M.transportName==="websocket"&&b.websocket===!1){Qp("disabled from server","websocket");return}if(S.length&&S.indexOf(M.transportName)===-1){Qp("not in whitelist",M.transportName);return}M.enabled(b)?(Qp("enabled",M.transportName),O.main.push(M),M.facadeTransport&&O.facade.push(M.facadeTransport)):Qp("disabled",M.transportName)}}),O}}}});var A1=bt((V9,I1)=>{"use strict";var iT={};["log","debug","warn"].forEach(function(v){var S;try{S=global.console&&global.console[v]&&global.console[v].apply}catch{}iT[v]=S?function(){return global.console[v].apply(global.console,arguments)}:v==="log"?function(){}:iT.log});I1.exports=iT});var Zp=bt((F9,w1)=>{"use strict";function Zs(v){this.type=v}Zs.prototype.initEvent=function(v,S,b){return this.type=v,this.bubbles=S,this.cancelable=b,this.timeStamp=+new Date,this};Zs.prototype.stopPropagation=function(){};Zs.prototype.preventDefault=function(){};Zs.CAPTURING_PHASE=1;Zs.AT_TARGET=2;Zs.BUBBLING_PHASE=3;w1.exports=Zs});var nT=bt((B9,O1)=>{"use strict";O1.exports=global.location||{origin:"http://localhost:80",protocol:"http:",host:"localhost",port:80,href:"http://localhost/",hash:""}});var L1=bt((j9,P1)=>{"use strict";var Gz=Se(),N1=Zp();function D1(){N1.call(this),this.initEvent("close",!1,!1),this.wasClean=!1,this.code=0,this.reason=""}Gz(D1,N1);P1.exports=D1});var x1=bt((G9,U1)=>{"use strict";var Wz=Se(),k1=Zp();function M1(v){k1.call(this),this.initEvent("message",!1,!1),this.data=v}Wz(M1,k1);U1.exports=M1});var B1=bt((W9,F1)=>{"use strict";var V1=Vi().EventEmitter,Hz=Se();function Al(){var v=this;V1.call(this),this.to=setTimeout(function(){v.emit("finish",200,"{}")},Al.timeout)}Hz(Al,V1);Al.prototype.close=function(){clearTimeout(this.to)};Al.timeout=2e3;F1.exports=Al});var oT=bt((H9,G1)=>{"use strict";var j1=Vi().EventEmitter,Kz=Se(),qz=Yp(),Yz=function(){};function rT(v,S){j1.call(this);var b=this,O=+new Date;this.xo=new S("GET",v),this.xo.once("finish",function(M,q){var et,st;if(M===200){if(st=+new Date-O,q)try{et=JSON.parse(q)}catch{Yz("bad json",q)}qz.isObject(et)||(et={})}b.emit("finish",et,st),b.removeAllListeners()})}Kz(rT,j1);rT.prototype.close=function(){this.removeAllListeners(),this.xo.close()};G1.exports=rT});var sT=bt((K9,H1)=>{"use strict";var zz=Se(),W1=Vi().EventEmitter,Xz=yc(),Jz=oT();function $p(v){var S=this;W1.call(this),this.ir=new Jz(v,Xz),this.ir.once("finish",function(b,O){S.ir=null,S.emit("message",JSON.stringify([b,O]))})}zz($p,W1);$p.transportName="iframe-info-receiver";$p.prototype.close=function(){this.ir&&(this.ir.close(),this.ir=null),this.removeAllListeners()};H1.exports=$p});var z1=bt((q9,Y1)=>{"use strict";var K1=Vi().EventEmitter,Qz=Se(),Zz=ho(),q1=KS(),$z=sT(),tX=function(){};function t_(v,S){var b=this;K1.call(this);var O=function(){var M=b.ifr=new q1($z.transportName,S,v);M.once("message",function(q){if(q){var et;try{et=JSON.parse(q)}catch{tX("bad json",q),b.emit("finish"),b.close();return}var st=et[0],ct=et[1];b.emit("finish",st,ct)}b.close()}),M.once("close",function(){b.emit("finish"),b.close()})};global.document.body?O():Zz.attachEvent("load",O)}Qz(t_,K1);t_.enabled=function(){return q1.enabled()};t_.prototype.close=function(){this.ifr&&this.ifr.close(),this.removeAllListeners(),this.ifr=null};Y1.exports=t_});var tM=bt((Y9,$1)=>{"use strict";var Z1=Vi().EventEmitter,eX=Se(),iX=Rn(),X1=Kp(),J1=El(),nX=yc(),rX=B1(),Q1=z1(),e_=oT(),Oc=function(){};function So(v,S){Oc(v);var b=this;Z1.call(this),setTimeout(function(){b.doXhr(v,S)},0)}eX(So,Z1);So._getReceiver=function(v,S,b){return b.sameOrigin?new e_(S,nX):J1.enabled?new e_(S,J1):X1.enabled&&b.sameScheme?new e_(S,X1):Q1.enabled()?new Q1(v,S):new e_(S,rX)};So.prototype.doXhr=function(v,S){var b=this,O=iX.addPath(v,"/info");Oc("doXhr",O),this.xo=So._getReceiver(v,O,S),this.timeoutRef=setTimeout(function(){Oc("timeout"),b._cleanup(!1),b.emit("finish")},So.timeout),this.xo.once("finish",function(M,q){Oc("finish",M,q),b._cleanup(!0),b.emit("finish",M,q)})};So.prototype._cleanup=function(v){Oc("_cleanup"),clearTimeout(this.timeoutRef),this.timeoutRef=null,!v&&this.xo&&this.xo.close(),this.xo=null};So.prototype.close=function(){Oc("close"),this.removeAllListeners(),this._cleanup(!1)};So.timeout=8e3;$1.exports=So});var nM=bt((z9,iM)=>{"use strict";var eM=wc();function wl(v){this._transport=v,v.on("message",this._transportMessage.bind(this)),v.on("close",this._transportClose.bind(this))}wl.prototype._transportClose=function(v,S){eM.postMessage("c",JSON.stringify([v,S]))};wl.prototype._transportMessage=function(v){eM.postMessage("t",v)};wl.prototype._send=function(v){this._transport.send(v)};wl.prototype._close=function(){this._transport.close(),this._transport.removeAllListeners()};iM.exports=wl});var aM=bt((X9,sM)=>{"use strict";var rM=Rn(),oX=ho(),sX=nM(),oM=sT(),aT=wc(),i_=nT(),cT=function(){};sM.exports=function(v,S){var b={};S.forEach(function(M){M.facadeTransport&&(b[M.facadeTransport.transportName]=M.facadeTransport)}),b[oM.transportName]=oM;var O;v.bootstrap_iframe=function(){var M;aT.currentWindowId=i_.hash.slice(1);var q=function(et){if(et.source===parent&&(typeof O>"u"&&(O=et.origin),et.origin===O)){var st;try{st=JSON.parse(et.data)}catch{cT("bad json",et.data);return}if(st.windowId===aT.currentWindowId)switch(st.type){case"s":var ct;try{ct=JSON.parse(st.data)}catch{cT("bad json",st.data);break}var mt=ct[0],Wt=ct[1],ht=ct[2],jt=ct[3];if(cT(mt,Wt,ht,jt),mt!==v.version)throw new Error('Incompatible SockJS! Main site uses: "'+mt+'", the iframe: "'+v.version+'".');if(!rM.isOriginEqual(ht,i_.href)||!rM.isOriginEqual(jt,i_.href))throw new Error("Can't connect to different domain from within an iframe. ("+i_.href+", "+ht+", "+jt+")");M=new sX(new b[Wt](ht,jt));break;case"m":M._send(st.data);break;case"c":M&&M._close(),M=null;break}}};oX.attachEvent("message",q),aT.postMessage("s")}}});var _M=bt((J9,pM)=>{"use strict";R1();var aX=IS(),cX=Se(),cM=Ks(),dX=y1(),Ol=Rn(),lX=ho(),uX=b1(),hX=Yp(),pX=Cc(),_X=A1(),dT=Zp(),lM=wS(),n_=nT(),mX=L1(),dM=x1(),EX=tM(),li=function(){},uM;function Te(v,S,b){if(!(this instanceof Te))return new Te(v,S,b);if(arguments.length<1)throw new TypeError("Failed to construct 'SockJS: 1 argument required, but only 0 present");lM.call(this),this.readyState=Te.CONNECTING,this.extensions="",this.protocol="",b=b||{},b.protocols_whitelist&&_X.warn("'protocols_whitelist' is DEPRECATED. Use 'transports' instead."),this._transportsWhitelist=b.transports,this._transportOptions=b.transportOptions||{},this._timeout=b.timeout||0;var O=b.sessionId||8;if(typeof O=="function")this._generateSessionId=O;else if(typeof O=="number")this._generateSessionId=function(){return cM.string(O)};else throw new TypeError("If sessionId is used in the options, it needs to be a number or a function.");this._server=b.server||cM.numberString(1e3);var M=new aX(v);if(!M.host||!M.protocol)throw new SyntaxError("The URL '"+v+"' is invalid");if(M.hash)throw new SyntaxError("The URL must not contain a fragment");if(M.protocol!=="http:"&&M.protocol!=="https:")throw new SyntaxError("The URL's scheme must be either 'http:' or 'https:'. '"+M.protocol+"' is not allowed.");var q=M.protocol==="https:";if(n_.protocol==="https:"&&!q&&!Ol.isLoopbackAddr(M.hostname))throw new Error("SecurityError: An insecure SockJS connection may not be initiated from a page loaded over HTTPS");S?Array.isArray(S)||(S=[S]):S=[];var et=S.sort();et.forEach(function(ct,mt){if(!ct)throw new SyntaxError("The protocols entry '"+ct+"' is invalid.");if(mt<et.length-1&&ct===et[mt+1])throw new SyntaxError("The protocols entry '"+ct+"' is duplicated.")});var st=Ol.getOrigin(n_.href);this._origin=st?st.toLowerCase():null,M.set("pathname",M.pathname.replace(/\/+$/,"")),this.url=M.href,li("using url",this.url),this._urlInfo={nullOrigin:!pX.hasDomain(),sameOrigin:Ol.isOriginEqual(this.url,n_.href),sameScheme:Ol.isSchemeEqual(this.url,n_.href)},this._ir=new EX(this.url,this._urlInfo),this._ir.once("finish",this._receiveInfo.bind(this))}cX(Te,lM);function hM(v){return v===1e3||v>=3e3&&v<=4999}Te.prototype.close=function(v,S){if(v&&!hM(v))throw new Error("InvalidAccessError: Invalid code");if(S&&S.length>123)throw new SyntaxError("reason argument has an invalid length");if(!(this.readyState===Te.CLOSING||this.readyState===Te.CLOSED)){var b=!0;this._close(v||1e3,S||"Normal closure",b)}};Te.prototype.send=function(v){if(typeof v!="string"&&(v=""+v),this.readyState===Te.CONNECTING)throw new Error("InvalidStateError: The connection has not been established yet");this.readyState===Te.OPEN&&this._transport.send(dX.quote(v))};Te.version=WS();Te.CONNECTING=0;Te.OPEN=1;Te.CLOSING=2;Te.CLOSED=3;Te.prototype._receiveInfo=function(v,S){if(li("_receiveInfo",S),this._ir=null,!v){this._close(1002,"Cannot connect to server");return}this._rto=this.countRTO(S),this._transUrl=v.base_url?v.base_url:this.url,v=hX.extend(v,this._urlInfo),li("info",v);var b=uM.filterToEnabled(this._transportsWhitelist,v);this._transports=b.main,li(this._transports.length+" enabled transports"),this._connect()};Te.prototype._connect=function(){for(var v=this._transports.shift();v;v=this._transports.shift()){if(li("attempt",v.transportName),v.needBody&&(!global.document.body||typeof global.document.readyState<"u"&&global.document.readyState!=="complete"&&global.document.readyState!=="interactive")){li("waiting for body"),this._transports.unshift(v),lX.attachEvent("load",this._connect.bind(this));return}var S=Math.max(this._timeout,this._rto*v.roundTrips||5e3);this._transportTimeoutId=setTimeout(this._transportTimeout.bind(this),S),li("using timeout",S);var b=Ol.addPath(this._transUrl,"/"+this._server+"/"+this._generateSessionId()),O=this._transportOptions[v.transportName];li("transport url",b);var M=new v(b,this._transUrl,O);M.on("message",this._transportMessage.bind(this)),M.once("close",this._transportClose.bind(this)),M.transportName=v.transportName,this._transport=M;return}this._close(2e3,"All transports failed",!1)};Te.prototype._transportTimeout=function(){li("_transportTimeout"),this.readyState===Te.CONNECTING&&(this._transport&&this._transport.close(),this._transportClose(2007,"Transport timed out"))};Te.prototype._transportMessage=function(v){li("_transportMessage",v);var S=this,b=v.slice(0,1),O=v.slice(1),M;switch(b){case"o":this._open();return;case"h":this.dispatchEvent(new dT("heartbeat")),li("heartbeat",this.transport);return}if(O)try{M=JSON.parse(O)}catch{li("bad json",O)}if(typeof M>"u"){li("empty payload",O);return}switch(b){case"a":Array.isArray(M)&&M.forEach(function(q){li("message",S.transport,q),S.dispatchEvent(new dM(q))});break;case"m":li("message",this.transport,M),this.dispatchEvent(new dM(M));break;case"c":Array.isArray(M)&&M.length===2&&this._close(M[0],M[1],!0);break}};Te.prototype._transportClose=function(v,S){if(li("_transportClose",this.transport,v,S),this._transport&&(this._transport.removeAllListeners(),this._transport=null,this.transport=null),!hM(v)&&v!==2e3&&this.readyState===Te.CONNECTING){this._connect();return}this._close(v,S)};Te.prototype._open=function(){li("_open",this._transport&&this._transport.transportName,this.readyState),this.readyState===Te.CONNECTING?(this._transportTimeoutId&&(clearTimeout(this._transportTimeoutId),this._transportTimeoutId=null),this.readyState=Te.OPEN,this.transport=this._transport.transportName,this.dispatchEvent(new dT("open")),li("connected",this.transport)):this._close(1006,"Server lost session")};Te.prototype._close=function(v,S,b){li("_close",this.transport,v,S,b,this.readyState);var O=!1;if(this._ir&&(O=!0,this._ir.close(),this._ir=null),this._transport&&(this._transport.close(),this._transport=null,this.transport=null),this.readyState===Te.CLOSED)throw new Error("InvalidStateError: SockJS has already been closed");this.readyState=Te.CLOSING,setTimeout((function(){this.readyState=Te.CLOSED,O&&this.dispatchEvent(new dT("error"));var M=new mX("close");M.wasClean=b||!1,M.code=v||1e3,M.reason=S,this.dispatchEvent(M),this.onmessage=this.onclose=this.onerror=null,li("disconnected")}).bind(this),0)};Te.prototype.countRTO=function(v){return v>100?4*v:300+v};pM.exports=function(v){return uM=uX(v),aM()(Te,v),Te}});var EM=bt((Q9,mM)=>{"use strict";var fX=_1();mM.exports=_M()(fX);"_sockjs_onload"in global&&setTimeout(global._sockjs_onload,1)});var TM=bt((lT,uT)=>{"use strict";(function(v,S){typeof lT=="object"&&typeof uT<"u"?uT.exports=S():typeof define=="function"&&define.amd?define(S):(v=typeof globalThis<"u"?globalThis:v||self).AgoraRTC=S()})(lT,function(){"use strict";function v(t,e){return e.forEach(function(i){i&&typeof i!="string"&&!Array.isArray(i)&&Object.keys(i).forEach(function(n){if(n!=="default"&&!(n in t)){var r=Object.getOwnPropertyDescriptor(i,n);Object.defineProperty(t,n,r.get?r:{enumerable:!0,get:function(){return i[n]}})}})}),Object.freeze(t)}var S=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function b(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var O=function(t){try{return!!t()}catch{return!0}},M=!O(function(){var t=(function(){}).bind();return typeof t!="function"||t.hasOwnProperty("prototype")}),q=M,et=Function.prototype,st=et.call,ct=q&&et.bind.bind(st,st),mt=q?ct:function(t){return function(){return st.apply(t,arguments)}},Wt=mt({}.isPrototypeOf),ht=function(t){return t&&t.Math===Math&&t},jt=ht(typeof globalThis=="object"&&globalThis)||ht(typeof window=="object"&&window)||ht(typeof self=="object"&&self)||ht(typeof S=="object"&&S)||ht(typeof S=="object"&&S)||function(){return this}()||Function("return this")(),Dc=M,o_=Function.prototype,hT=o_.apply,pT=o_.call,Pc=typeof Reflect=="object"&&Reflect.apply||(Dc?pT.bind(hT):function(){return pT.apply(hT,arguments)}),_T=mt,vM=_T({}.toString),yM=_T("".slice),mr=function(t){return yM(vM(t),8,-1)},CM=mr,bM=mt,Lc=function(t){if(CM(t)==="Function")return bM(t)},s_=typeof document=="object"&&document.all,Je=s_===void 0&&s_!==void 0?function(t){return typeof t=="function"||t===s_}:function(t){return typeof t=="function"},Pl={},Di=!O(function(){return Object.defineProperty({},1,{get:function(){return 7}})[1]!==7}),IM=M,Ll=Function.prototype.call,ii=IM?Ll.bind(Ll):function(){return Ll.apply(Ll,arguments)},kl={},mT={}.propertyIsEnumerable,ET=Object.getOwnPropertyDescriptor,AM=ET&&!mT.call({1:2},1);kl.f=AM?function(t){var e=ET(this,t);return!!e&&e.enumerable}:mT;var To,Ml,Ro=function(t,e){return{enumerable:!(1&t),configurable:!(2&t),writable:!(4&t),value:e}},wM=O,OM=mr,a_=Object,NM=mt("".split),Ul=wM(function(){return!a_("z").propertyIsEnumerable(0)})?function(t){return OM(t)==="String"?NM(t,""):a_(t)}:a_,xl=function(t){return t==null},DM=xl,PM=TypeError,ns=function(t){if(DM(t))throw new PM("Can't call method on "+t);return t},LM=Ul,kM=ns,vo=function(t){return LM(kM(t))},MM=Je,yi=function(t){return typeof t=="object"?t!==null:MM(t)},dn={},c_=dn,d_=jt,UM=Je,fT=function(t){return UM(t)?t:void 0},Ci=function(t,e){return arguments.length<2?fT(c_[t])||fT(d_[t]):c_[t]&&c_[t][e]||d_[t]&&d_[t][e]},gT=jt.navigator,ST=gT&&gT.userAgent,Kr=ST?String(ST):"",TT=jt,l_=Kr,RT=TT.process,vT=TT.Deno,yT=RT&&RT.versions||vT&&vT.version,CT=yT&&yT.v8;CT&&(Ml=(To=CT.split("."))[0]>0&&To[0]<4?1:+(To[0]+To[1])),!Ml&&l_&&(!(To=l_.match(/Edge\/(\d+)/))||To[1]>=74)&&(To=l_.match(/Chrome\/(\d+)/))&&(Ml=+To[1]);var rs=Ml,bT=rs,xM=O,VM=jt.String,ta=!!Object.getOwnPropertySymbols&&!xM(function(){var t=Symbol("symbol detection");return!VM(t)||!(Object(t)instanceof Symbol)||!Symbol.sham&&bT&&bT<41}),IT=ta&&!Symbol.sham&&typeof Symbol.iterator=="symbol",FM=Ci,BM=Je,jM=Wt,GM=Object,kc=IT?function(t){return typeof t=="symbol"}:function(t){var e=FM("Symbol");return BM(e)&&jM(e.prototype,GM(t))},WM=String,ea=function(t){try{return WM(t)}catch{return"Object"}},HM=Je,KM=ea,qM=TypeError,qi=function(t){if(HM(t))return t;throw new qM(KM(t)+" is not a function")},YM=qi,zM=xl,Vl=function(t,e){var i=t[e];return zM(i)?void 0:YM(i)},u_=ii,h_=Je,p_=yi,XM=TypeError,AT={exports:{}},wT=jt,JM=Object.defineProperty,QM=jt,ZM=function(t,e){try{JM(wT,t,{value:e,configurable:!0,writable:!0})}catch{wT[t]=e}return e},OT="__core-js_shared__",NT=AT.exports=QM[OT]||ZM(OT,{});(NT.versions||(NT.versions=[])).push({version:"3.42.0",mode:"pure",copyright:"\xA9 2014-2025 Denis Pushkarev (zloirock.ru)",license:"https://github.com/zloirock/core-js/blob/v3.42.0/LICENSE",source:"https://github.com/zloirock/core-js"});var __=AT.exports,DT=__,ia=function(t,e){return DT[t]||(DT[t]=e||{})},$M=ns,tU=Object,Er=function(t){return tU($M(t))},eU=Er,iU=mt({}.hasOwnProperty),ai=Object.hasOwn||function(t,e){return iU(eU(t),e)},nU=mt,rU=0,oU=Math.random(),sU=nU(1 .toString),m_=function(t){return"Symbol("+(t===void 0?"":t)+")_"+sU(++rU+oU,36)},aU=ia,PT=ai,cU=m_,dU=ta,lU=IT,na=jt.Symbol,E_=aU("wks"),uU=lU?na.for||na:na&&na.withoutSetter||cU,Pe=function(t){return PT(E_,t)||(E_[t]=dU&&PT(na,t)?na[t]:uU("Symbol."+t)),E_[t]},hU=ii,LT=yi,kT=kc,pU=Vl,_U=function(t,e){var i,n;if(e==="string"&&h_(i=t.toString)&&!p_(n=u_(i,t))||h_(i=t.valueOf)&&!p_(n=u_(i,t))||e!=="string"&&h_(i=t.toString)&&!p_(n=u_(i,t)))return n;throw new XM("Can't convert object to primitive value")},mU=TypeError,EU=Pe("toPrimitive"),fU=function(t,e){if(!LT(t)||kT(t))return t;var i,n=pU(t,EU);if(n){if(e===void 0&&(e="default"),i=hU(n,t,e),!LT(i)||kT(i))return i;throw new mU("Can't convert object to primitive value")}return e===void 0&&(e="number"),_U(t,e)},gU=kc,f_=function(t){var e=fU(t,"string");return gU(e)?e:e+""},MT=yi,g_=jt.document,SU=MT(g_)&&MT(g_.createElement),S_=function(t){return SU?g_.createElement(t):{}},TU=S_,UT=!Di&&!O(function(){return Object.defineProperty(TU("div"),"a",{get:function(){return 7}}).a!==7}),RU=Di,vU=ii,yU=kl,CU=Ro,bU=vo,IU=f_,AU=ai,wU=UT,xT=Object.getOwnPropertyDescriptor;Pl.f=RU?xT:function(t,e){if(t=bU(t),e=IU(e),wU)try{return xT(t,e)}catch{}if(AU(t,e))return CU(!vU(yU.f,t,e),t[e])};var OU=O,NU=Je,DU=/#|\.prototype\./,Mc=function(t,e){var i=LU[PU(t)];return i===MU||i!==kU&&(NU(e)?OU(e):!!e)},PU=Mc.normalize=function(t){return String(t).replace(DU,".").toLowerCase()},LU=Mc.data={},kU=Mc.NATIVE="N",MU=Mc.POLYFILL="P",VT=Mc,UU=qi,xU=M,VU=Lc(Lc.bind),yo=function(t,e){return UU(t),e===void 0?t:xU?VU(t,e):function(){return t.apply(e,arguments)}},yn={},FT=Di&&O(function(){return Object.defineProperty(function(){},"prototype",{value:42,writable:!1}).prototype!==42}),FU=yi,BU=String,jU=TypeError,Fi=function(t){if(FU(t))return t;throw new jU(BU(t)+" is not an object")},GU=Di,WU=UT,HU=FT,Fl=Fi,BT=f_,KU=TypeError,T_=Object.defineProperty,qU=Object.getOwnPropertyDescriptor,R_="enumerable",v_="configurable",y_="writable";yn.f=GU?HU?function(t,e,i){if(Fl(t),e=BT(e),Fl(i),typeof t=="function"&&e==="prototype"&&"value"in i&&y_ in i&&!i[y_]){var n=qU(t,e);n&&n[y_]&&(t[e]=i.value,i={configurable:v_ in i?i[v_]:n[v_],enumerable:R_ in i?i[R_]:n[R_],writable:!1})}return T_(t,e,i)}:T_:function(t,e,i){if(Fl(t),e=BT(e),Fl(i),WU)try{return T_(t,e,i)}catch{}if("get"in i||"set"in i)throw new KU("Accessors not supported");return"value"in i&&(t[e]=i.value),t};var YU=yn,zU=Ro,os=Di?function(t,e,i){return YU.f(t,e,zU(1,i))}:function(t,e,i){return t[e]=i,t},Uc=jt,XU=Pc,JU=Lc,QU=Je,ZU=Pl.f,$U=VT,ra=dn,t2=yo,oa=os,jT=ai,e2=function(t){var e=function(i,n,r){if(this instanceof e){switch(arguments.length){case 0:return new t;case 1:return new t(i);case 2:return new t(i,n)}return new t(i,n,r)}return XU(t,this,arguments)};return e.prototype=t.prototype,e},Ht=function(t,e){var i,n,r,o,s,a,c,d,l,u=t.target,h=t.global,p=t.stat,g=t.proto,E=h?Uc:p?Uc[u]:Uc[u]&&Uc[u].prototype,f=h?ra:ra[u]||oa(ra,u,{})[u],R=f.prototype;for(o in e)n=!(i=$U(h?o:u+(p?".":"#")+o,t.forced))&&E&&jT(E,o),a=f[o],n&&(c=t.dontCallGetSet?(l=ZU(E,o))&&l.value:E[o]),s=n&&c?c:e[o],(i||g||typeof a!=typeof s)&&(d=t.bind&&n?t2(s,Uc):t.wrap&&n?e2(s):g&&QU(s)?JU(s):s,(t.sham||s&&s.sham||a&&a.sham)&&oa(d,"sham",!0),oa(f,o,d),g&&(jT(ra,r=u+"Prototype")||oa(ra,r,{}),oa(ra[r],o,s),t.real&&R&&(i||!R[o])&&oa(R,o,s)))},i2=Math.ceil,n2=Math.floor,r2=Math.trunc||function(t){var e=+t;return(e>0?n2:i2)(e)},o2=r2,C_=function(t){var e=+t;return e!=e||e===0?0:o2(e)},s2=C_,a2=Math.max,c2=Math.min,b_=function(t,e){var i=s2(t);return i<0?a2(i+e,0):c2(i,e)},d2=C_,l2=Math.min,GT=function(t){var e=d2(t);return e>0?l2(e,9007199254740991):0},u2=GT,Co=function(t){return u2(t.length)},h2=vo,p2=b_,_2=Co,WT=function(t){return function(e,i,n){var r=h2(e),o=_2(r);if(o===0)return!t&&-1;var s,a=p2(n,o);if(t&&i!=i){for(;o>a;)if((s=r[a++])!=s)return!0}else for(;o>a;a++)if((t||a in r)&&r[a]===i)return t||a||0;return!t&&-1}},I_={includes:WT(!0),indexOf:WT(!1)},m2=I_.includes;Ht({target:"Array",proto:!0,forced:O(function(){return!Array(1).includes()})},{includes:function(t){return m2(this,t,arguments.length>1?arguments[1]:void 0)}});var E2=jt,f2=dn,Cn=function(t,e){var i=f2[t+"Prototype"],n=i&&i[e];if(n)return n;var r=E2[t],o=r&&r.prototype;return o&&o[e]},g2=Cn("Array","includes"),S2=yi,T2=mr,R2=Pe("match"),HT=function(t){var e;return S2(t)&&((e=t[R2])!==void 0?!!e:T2(t)==="RegExp")},v2=HT,y2=TypeError,KT={};KT[Pe("toStringTag")]="z";var A_=String(KT)==="[object z]",C2=A_,b2=Je,Bl=mr,I2=Pe("toStringTag"),A2=Object,w2=Bl(function(){return arguments}())==="Arguments",bo=C2?Bl:function(t){var e,i,n;return t===void 0?"Undefined":t===null?"Null":typeof(i=function(r,o){try{return r[o]}catch{}}(e=A2(t),I2))=="string"?i:w2?Bl(e):(n=Bl(e))==="Object"&&b2(e.callee)?"Arguments":n},O2=bo,N2=String,Yi=function(t){if(O2(t)==="Symbol")throw new TypeError("Cannot convert a Symbol value to a string");return N2(t)},D2=Pe("match"),P2=Ht,L2=function(t){if(v2(t))throw new y2("The method doesn't accept regular expressions");return t},k2=ns,qT=Yi,M2=function(t){var e=/./;try{"/./"[t](e)}catch{try{return e[D2]=!1,"/./"[t](e)}catch{}}return!1},U2=mt("".indexOf);P2({target:"String",proto:!0,forced:!M2("includes")},{includes:function(t){return!!~U2(qT(k2(this)),qT(L2(t)),arguments.length>1?arguments[1]:void 0)}});var x2=Cn("String","includes"),YT=Wt,V2=g2,F2=x2,w_=Array.prototype,O_=String.prototype,B2=function(t){var e=t.includes;return t===w_||YT(w_,t)&&e===w_.includes?V2:typeof t=="string"||t===O_||YT(O_,t)&&e===O_.includes?F2:e},z=b(B2),j2=qi,G2=Er,W2=Ul,H2=Co,zT=TypeError,XT="Reduce of empty array with no initial value",JT=function(t){return function(e,i,n,r){var o=G2(e),s=W2(o),a=H2(o);if(j2(i),a===0&&n<2)throw new zT(XT);var c=t?a-1:0,d=t?-1:1;if(n<2)for(;;){if(c in s){r=s[c],c+=d;break}if(c+=d,t?c<0:a<=c)throw new zT(XT)}for(;t?c>=0:a>c;c+=d)c in s&&(r=i(r,s[c],c,o));return r}},K2={left:JT(!1),right:JT(!0)},q2=O,jl=function(t,e){var i=[][t];return!!i&&q2(function(){i.call(null,e||function(){return 1},1)})},xc=jt,Y2=Kr,z2=mr,Gl=function(t){return Y2.slice(0,t.length)===t},N_=Gl("Bun/")?"BUN":Gl("Cloudflare-Workers")?"CLOUDFLARE":Gl("Deno/")?"DENO":Gl("Node.js/")?"NODE":xc.Bun&&typeof Bun.version=="string"?"BUN":xc.Deno&&typeof Deno.version=="object"?"DENO":z2(xc.process)==="process"?"NODE":xc.window&&xc.document?"BROWSER":"REST",Wl=N_==="NODE",X2=K2.left;Ht({target:"Array",proto:!0,forced:!Wl&&rs>79&&rs<83||!jl("reduce")},{reduce:function(t){var e=arguments.length;return X2(this,t,e,e>1?arguments[1]:void 0)}});var J2=Cn("Array","reduce"),Q2=Wt,Z2=J2,D_=Array.prototype,$2=function(t){var e=t.reduce;return t===D_||Q2(D_,t)&&e===D_.reduce?Z2:e},QT=$2,bn=b(QT),tx=mr,Vc=Array.isArray||function(t){return tx(t)==="Array"},ex=Ht,ix=Vc,nx=mt([].reverse),ZT=[1,2];ex({target:"Array",proto:!0,forced:String(ZT)===String(ZT.reverse())},{reverse:function(){return ix(this)&&(this.length=this.length),nx(this)}});var rx=Cn("Array","reverse"),ox=Wt,sx=rx,P_=Array.prototype,ax=function(t){var e=t.reverse;return t===P_||ox(P_,t)&&e===P_.reverse?sx:e},$T=ax,tR=b($T),cx=m_,eR=ia("keys"),Hl=function(t){return eR[t]||(eR[t]=cx(t))},dx=!O(function(){function t(){}return t.prototype.constructor=null,Object.getPrototypeOf(new t)!==t.prototype}),lx=ai,ux=Je,hx=Er,px=dx,iR=Hl("IE_PROTO"),L_=Object,_x=L_.prototype,k_=px?L_.getPrototypeOf:function(t){var e=hx(t);if(lx(e,iR))return e[iR];var i=e.constructor;return ux(i)&&e instanceof i?i.prototype:e instanceof L_?_x:null},mx=mt,Ex=qi,fx=yi,gx=function(t){return fx(t)||t===null},Sx=String,Tx=TypeError,Rx=function(t,e,i){try{return mx(Ex(Object.getOwnPropertyDescriptor(t,e)[i]))}catch{}},vx=yi,yx=ns,Cx=function(t){if(gx(t))return t;throw new Tx("Can't set "+Sx(t)+" as a prototype")},bx=Object.setPrototypeOf||("__proto__"in{}?function(){var t,e=!1,i={};try{(t=Rx(Object.prototype,"__proto__","set"))(i,[]),e=i instanceof Array}catch{}return function(n,r){return yx(n),Cx(r),vx(n)&&(e?t(n,r):n.__proto__=r),n}}():void 0),Kl={},ql={},M_=ai,Ix=vo,Ax=I_.indexOf,wx=ql,nR=mt([].push),rR=function(t,e){var i,n=Ix(t),r=0,o=[];for(i in n)!M_(wx,i)&&M_(n,i)&&nR(o,i);for(;e.length>r;)M_(n,i=e[r++])&&(~Ax(o,i)||nR(o,i));return o},U_=["constructor","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","toLocaleString","toString","valueOf"],Ox=rR,Nx=U_.concat("length","prototype");Kl.f=Object.getOwnPropertyNames||function(t){return Ox(t,Nx)};var Fc={};Fc.f=Object.getOwnPropertySymbols;var Dx=Ci,Px=Kl,Lx=Fc,kx=Fi,Mx=mt([].concat),Ux=Dx("Reflect","ownKeys")||function(t){var e=Px.f(kx(t)),i=Lx.f;return i?Mx(e,i(t)):e},oR=ai,xx=Ux,Vx=Pl,Fx=yn,x_={},Bx=rR,jx=U_,Yl=Object.keys||function(t){return Bx(t,jx)},Gx=Di,Wx=FT,Hx=yn,Kx=Fi,qx=vo,Yx=Yl;x_.f=Gx&&!Wx?Object.defineProperties:function(t,e){Kx(t);for(var i,n=qx(e),r=Yx(e),o=r.length,s=0;o>s;)Hx.f(t,i=r[s++],n[i]);return t};var zl,sR=Ci("document","documentElement"),zx=Fi,Xx=x_,aR=U_,Jx=ql,Qx=sR,Zx=S_,V_="prototype",F_="script",cR=Hl("IE_PROTO"),B_=function(){},dR=function(t){return"<"+F_+">"+t+"</"+F_+">"},lR=function(t){t.write(dR("")),t.close();var e=t.parentWindow.Object;return t=null,e},Xl=function(){try{zl=new ActiveXObject("htmlfile")}catch{}var t,e,i;Xl=typeof document<"u"?document.domain&&zl?lR(zl):(e=Zx("iframe"),i="java"+F_+":",e.style.display="none",Qx.appendChild(e),e.src=String(i),(t=e.contentWindow.document).open(),t.write(dR("document.F=Object")),t.close(),t.F):lR(zl);for(var n=aR.length;n--;)delete Xl[V_][aR[n]];return Xl()};Jx[cR]=!0;var Bc=Object.create||function(t,e){var i;return t!==null?(B_[V_]=zx(t),i=new B_,B_[V_]=null,i[cR]=t):i=Xl(),e===void 0?i:Xx.f(i,e)},$x=yi,tV=os,uR=Error,eV=mt("".replace),iV=String(new uR("zxcasd").stack),hR=/\n\s*at [^:]*:[^\n]*/,nV=hR.test(iV),rV=Ro,oV=!O(function(){var t=new Error("a");return!("stack"in t)||(Object.defineProperty(t,"stack",rV(1,7)),t.stack!==7)}),sV=os,aV=function(t,e){if(nV&&typeof t=="string"&&!uR.prepareStackTrace)for(;e--;)t=eV(t,hR,"");return t},cV=oV,pR=Error.captureStackTrace,sa={},dV=sa,lV=Pe("iterator"),uV=Array.prototype,_R=function(t){return t!==void 0&&(dV.Array===t||uV[lV]===t)},hV=bo,mR=Vl,pV=xl,_V=sa,mV=Pe("iterator"),Jl=function(t){if(!pV(t))return mR(t,mV)||mR(t,"@@iterator")||_V[hV(t)]},EV=ii,fV=qi,gV=Fi,SV=ea,TV=Jl,RV=TypeError,j_=function(t,e){var i=arguments.length<2?TV(t):e;if(fV(i))return gV(EV(i,t));throw new RV(SV(t)+" is not iterable")},vV=ii,ER=Fi,yV=Vl,fR=function(t,e,i){var n,r;ER(t);try{if(!(n=yV(t,"return"))){if(e==="throw")throw i;return i}n=vV(n,t)}catch(o){r=!0,n=o}if(e==="throw")throw i;if(r)throw n;return ER(n),i},CV=yo,bV=ii,IV=Fi,AV=ea,wV=_R,OV=Co,gR=Wt,NV=j_,DV=Jl,SR=fR,PV=TypeError,Ql=function(t,e){this.stopped=t,this.result=e},TR=Ql.prototype,jc=function(t,e,i){var n,r,o,s,a,c,d,l=i&&i.that,u=!(!i||!i.AS_ENTRIES),h=!(!i||!i.IS_RECORD),p=!(!i||!i.IS_ITERATOR),g=!(!i||!i.INTERRUPTED),E=CV(e,l),f=function(y){return n&&SR(n,"normal",y),new Ql(!0,y)},R=function(y){return u?(IV(y),g?E(y[0],y[1],f):E(y[0],y[1])):g?E(y,f):E(y)};if(h)n=t.iterator;else if(p)n=t;else{if(!(r=DV(t)))throw new PV(AV(t)+" is not iterable");if(wV(r)){for(o=0,s=OV(t);s>o;o++)if((a=R(t[o]))&&gR(TR,a))return a;return new Ql(!1)}n=NV(t,r)}for(c=h?t.next:n.next;!(d=bV(c,n)).done;){try{a=R(d.value)}catch(y){SR(n,"throw",y)}if(typeof a=="object"&&a&&gR(TR,a))return a}return new Ql(!1)},LV=Yi,kV=Ht,MV=Wt,UV=k_,Zl=bx,xV=function(t,e,i){for(var n=xx(e),r=Fx.f,o=Vx.f,s=0;s<n.length;s++){var a=n[s];oR(t,a)||i&&oR(i,a)||r(t,a,o(e,a))}},RR=Bc,G_=os,W_=Ro,VV=function(t,e){$x(e)&&"cause"in e&&tV(t,"cause",e.cause)},FV=function(t,e,i,n){cV&&(pR?pR(t,e):sV(t,"stack",aV(i,n)))},BV=jc,jV=function(t,e){return t===void 0?arguments.length<2?"":e:LV(t)},GV=Pe("toStringTag"),$l=Error,WV=[].push,aa=function(t,e){var i,n=MV(H_,this);Zl?i=Zl(new $l,n?UV(this):H_):(i=n?this:RR(H_),G_(i,GV,"Error")),e!==void 0&&G_(i,"message",jV(e)),FV(i,aa,i.stack,1),arguments.length>2&&VV(i,arguments[2]);var r=[];return BV(t,WV,{that:r}),G_(i,"errors",r),i};Zl?Zl(aa,$l):xV(aa,$l,{name:!0});var H_=aa.prototype=RR($l.prototype,{constructor:W_(1,aa),message:W_(1,""),name:W_(1,"AggregateError")});kV({global:!0,constructor:!0,arity:2},{AggregateError:aa});var tu,Gc,eu,HV=Je,vR=jt.WeakMap,KV=HV(vR)&&/native code/.test(String(vR)),yR=jt,qV=yi,YV=os,K_=ai,q_=__,zV=Hl,XV=ql,CR="Object already initialized",Y_=yR.TypeError,JV=yR.WeakMap;if(KV||q_.state){var fr=q_.state||(q_.state=new JV);fr.get=fr.get,fr.has=fr.has,fr.set=fr.set,tu=function(t,e){if(fr.has(t))throw new Y_(CR);return e.facade=t,fr.set(t,e),e},Gc=function(t){return fr.get(t)||{}},eu=function(t){return fr.has(t)}}else{var ca=zV("state");XV[ca]=!0,tu=function(t,e){if(K_(t,ca))throw new Y_(CR);return e.facade=t,YV(t,ca,e),e},Gc=function(t){return K_(t,ca)?t[ca]:{}},eu=function(t){return K_(t,ca)}}var ss,bR,IR,as={set:tu,get:Gc,has:eu,enforce:function(t){return eu(t)?Gc(t):tu(t,{})},getterFor:function(t){return function(e){var i;if(!qV(e)||(i=Gc(e)).type!==t)throw new Y_("Incompatible receiver, "+t+" required");return i}}},z_=Di,QV=ai,AR=Function.prototype,ZV=z_&&Object.getOwnPropertyDescriptor,X_=QV(AR,"name"),wR={EXISTS:X_,PROPER:X_&&(function(){}).name==="something",CONFIGURABLE:X_&&(!z_||z_&&ZV(AR,"name").configurable)},$V=os,Io=function(t,e,i,n){return n&&n.enumerable?t[e]=i:$V(t,e,i),t},tF=O,eF=Je,iF=yi,nF=Bc,OR=k_,rF=Io,J_=Pe("iterator"),NR=!1;[].keys&&("next"in(IR=[].keys())?(bR=OR(OR(IR)))!==Object.prototype&&(ss=bR):NR=!0);var oF=!iF(ss)||tF(function(){var t={};return ss[J_].call(t)!==t});eF((ss=oF?{}:nF(ss))[J_])||rF(ss,J_,function(){return this});var DR={IteratorPrototype:ss,BUGGY_SAFARI_ITERATORS:NR},sF=bo,aF=A_?{}.toString:function(){return"[object "+sF(this)+"]"},cF=A_,dF=yn.f,lF=os,uF=ai,hF=aF,PR=Pe("toStringTag"),qr=function(t,e,i,n){var r=i?t:t&&t.prototype;r&&(uF(r,PR)||dF(r,PR,{configurable:!0,value:e}),n&&!cF&&lF(r,"toString",hF))},pF=DR.IteratorPrototype,_F=Bc,mF=Ro,EF=qr,fF=sa,gF=function(){return this},Q_=function(t,e,i,n){var r=e+" Iterator";return t.prototype=_F(pF,{next:mF(+!n,i)}),EF(t,r,!1,!0),fF[r]=gF,t},SF=Ht,TF=ii,RF=wR,vF=Q_,yF=k_,CF=qr,LR=Io,kR=sa,bF=DR,IF=RF.PROPER,iu=bF.BUGGY_SAFARI_ITERATORS,Z_=Pe("iterator"),MR="keys",nu="values",UR="entries",AF=function(){return this},xR=function(t,e,i,n,r,o,s){vF(i,e,n);var a,c,d,l=function(R){if(R===r&&E)return E;if(!iu&&R&&R in p)return p[R];switch(R){case MR:case nu:case UR:return function(){return new i(this,R)}}return function(){return new i(this)}},u=e+" Iterator",h=!1,p=t.prototype,g=p[Z_]||p["@@iterator"]||r&&p[r],E=!iu&&g||l(r),f=e==="Array"&&p.entries||g;if(f&&(a=yF(f.call(new t)))!==Object.prototype&&a.next&&(CF(a,u,!0,!0),kR[u]=AF),IF&&r===nu&&g&&g.name!==nu&&(h=!0,E=function(){return TF(g,this)}),r)if(c={values:l(nu),keys:o?E:l(MR),entries:l(UR)},s)for(d in c)(iu||h||!(d in p))&&LR(p,d,c[d]);else SF({target:e,proto:!0,forced:iu||h},c);return s&&p[Z_]!==E&&LR(p,Z_,E,{name:r}),kR[e]=E,c},ru=function(t,e){return{value:t,done:e}},wF=vo,VR=sa,FR=as;yn.f;var OF=xR,ou=ru,BR="Array Iterator",NF=FR.set,DF=FR.getterFor(BR);OF(Array,"Array",function(t,e){NF(this,{type:BR,target:wF(t),index:0,kind:e})},function(){var t=DF(this),e=t.target,i=t.index++;if(!e||i>=e.length)return t.target=null,ou(void 0,!0);switch(t.kind){case"keys":return ou(i,!1);case"values":return ou(e[i],!1)}return ou([i,e[i]],!1)},"values"),VR.Arguments=VR.Array;var PF=yn,su=function(t,e,i){return PF.f(t,e,i)},LF=Ci,kF=su,MF=Di,jR=Pe("species"),UF=Wt,xF=TypeError,$_=function(t,e){if(UF(e,t))return t;throw new xF("Incorrect invocation")},VF=Je,tm=__,FF=mt(Function.toString);VF(tm.inspectSource)||(tm.inspectSource=function(t){return FF(t)});var GR=tm.inspectSource,BF=mt,jF=O,WR=Je,GF=bo,WF=GR,HR=function(){},KR=Ci("Reflect","construct"),em=/^\s*(?:class|function)\b/,HF=BF(em.exec),KF=!em.test(HR),Wc=function(t){if(!WR(t))return!1;try{return KR(HR,[],t),!0}catch{return!1}},qR=function(t){if(!WR(t))return!1;switch(GF(t)){case"AsyncFunction":case"GeneratorFunction":case"AsyncGeneratorFunction":return!1}try{return KF||!!HF(em,WF(t))}catch{return!0}};qR.sham=!0;var Hc,da,YR,im,au=!KR||jF(function(){var t;return Wc(Wc.call)||!Wc(Object)||!Wc(function(){t=!0})||t})?qR:Wc,qF=au,YF=ea,zF=TypeError,zR=Fi,XF=function(t){if(qF(t))return t;throw new zF(YF(t)+" is not a constructor")},JF=xl,QF=Pe("species"),nm=function(t,e){var i,n=zR(t).constructor;return n===void 0||JF(i=zR(n)[QF])?e:XF(i)},Ao=mt([].slice),ZF=TypeError,cs=function(t,e){if(t<e)throw new ZF("Not enough arguments");return t},XR=/(?:ipad|iphone|ipod).*applewebkit/i.test(Kr),ln=jt,$F=Pc,tB=yo,JR=Je,eB=ai,QR=O,ZR=sR,iB=Ao,$R=S_,nB=cs,rB=XR,oB=Wl,rm=ln.setImmediate,om=ln.clearImmediate,sB=ln.process,sm=ln.Dispatch,aB=ln.Function,tv=ln.MessageChannel,cB=ln.String,am=0,Kc={},ev="onreadystatechange";QR(function(){Hc=ln.location});var cm=function(t){if(eB(Kc,t)){var e=Kc[t];delete Kc[t],e()}},dm=function(t){return function(){cm(t)}},iv=function(t){cm(t.data)},nv=function(t){ln.postMessage(cB(t),Hc.protocol+"//"+Hc.host)};rm&&om||(rm=function(t){nB(arguments.length,1);var e=JR(t)?t:aB(t),i=iB(arguments,1);return Kc[++am]=function(){$F(e,void 0,i)},da(am),am},om=function(t){delete Kc[t]},oB?da=function(t){sB.nextTick(dm(t))}:sm&&sm.now?da=function(t){sm.now(dm(t))}:tv&&!rB?(im=(YR=new tv).port2,YR.port1.onmessage=iv,da=tB(im.postMessage,im)):ln.addEventListener&&JR(ln.postMessage)&&!ln.importScripts&&Hc&&Hc.protocol!=="file:"&&!QR(nv)?(da=nv,ln.addEventListener("message",iv,!1)):da=ev in $R("script")?function(t){ZR.appendChild($R("script"))[ev]=function(){ZR.removeChild(this),cm(t)}}:function(t){setTimeout(dm(t),0)});var cu={set:rm,clear:om},rv=jt,dB=Di,lB=Object.getOwnPropertyDescriptor,ov=function(t){if(!dB)return rv[t];var e=lB(rv,t);return e&&e.value},sv=function(){this.head=null,this.tail=null};sv.prototype={add:function(t){var e={item:t,next:null},i=this.tail;i?i.next=e:this.head=e,this.tail=e},get:function(){var t=this.head;if(t)return(this.head=t.next)===null&&(this.tail=null),t.item}};var la,lm,um,hm,av,cv=sv,uB=/ipad|iphone|ipod/i.test(Kr)&&typeof Pebble<"u",hB=/web0s(?!.*chrome)/i.test(Kr),ua=jt,pB=ov,dv=yo,pm=cu.set,_B=cv,mB=XR,EB=uB,fB=hB,_m=Wl,lv=ua.MutationObserver||ua.WebKitMutationObserver,uv=ua.document,hv=ua.process,du=ua.Promise,mm=pB("queueMicrotask");if(!mm){var lu=new _B,uu=function(){var t,e;for(_m&&(t=hv.domain)&&t.exit();e=lu.get();)try{e()}catch(i){throw lu.head&&la(),i}t&&t.enter()};mB||_m||fB||!lv||!uv?!EB&&du&&du.resolve?((hm=du.resolve(void 0)).constructor=du,av=dv(hm.then,hm),la=function(){av(uu)}):_m?la=function(){hv.nextTick(uu)}:(pm=dv(pm,ua),la=function(){pm(uu)}):(lm=!0,um=uv.createTextNode(""),new lv(uu).observe(um,{characterData:!0}),la=function(){um.data=lm=!lm}),mm=function(t){lu.head||la(),lu.add(t)}}var pv=mm,ha=function(t){try{return{error:!1,value:t()}}catch(e){return{error:!0,value:e}}},ds=jt.Promise,gB=jt,qc=ds,SB=Je,TB=VT,RB=GR,vB=Pe,_v=N_,Em=rs,mv=qc&&qc.prototype,yB=vB("species"),Ev=!1,fv=SB(gB.PromiseRejectionEvent),CB=TB("Promise",function(){var t=RB(qc),e=t!==String(qc);if(!e&&Em===66||!mv.catch||!mv.finally)return!0;if(!Em||Em<51||!/native code/.test(t)){var i=new qc(function(r){r(1)}),n=function(r){r(function(){},function(){})};if((i.constructor={})[yB]=n,!(Ev=i.then(function(){})instanceof n))return!0}return!(e||_v!=="BROWSER"&&_v!=="DENO"||fv)}),Yc={CONSTRUCTOR:CB,REJECTION_EVENT:fv,SUBCLASSING:Ev},gr={},gv=qi,bB=TypeError,IB=function(t){var e,i;this.promise=new t(function(n,r){if(e!==void 0||i!==void 0)throw new bB("Bad Promise constructor");e=n,i=r}),this.resolve=gv(e),this.reject=gv(i)};gr.f=function(t){return new IB(t)};var fm,Sv,AB=Ht,hu=Wl,wo=jt,zc=ii,wB=Io,OB=qr,NB=function(t){var e=LF(t);MF&&e&&!e[jR]&&kF(e,jR,{configurable:!0,get:function(){return this}})},DB=qi,gm=Je,PB=yi,LB=$_,kB=nm,Tv=cu.set,Sm=pv,MB=function(t,e){try{arguments.length===1?console.error(t):console.error(t,e)}catch{}},UB=ha,xB=cv,Rv=as,Tm=ds,vv=Yc,yv=gr,pu="Promise",Cv=vv.CONSTRUCTOR,VB=vv.REJECTION_EVENT,Rm=Rv.getterFor(pu),FB=Rv.set,BB=Tm&&Tm.prototype,Xc=Tm,vm=BB,bv=wo.TypeError,ym=wo.document,Cm=wo.process,bm=yv.f,jB=bm,GB=!!(ym&&ym.createEvent&&wo.dispatchEvent),Iv="unhandledrejection",Av=function(t){var e;return!(!PB(t)||!gm(e=t.then))&&e},wv=function(t,e){var i,n,r,o=e.value,s=e.state===1,a=s?t.ok:t.fail,c=t.resolve,d=t.reject,l=t.domain;try{a?(s||(e.rejection===2&&HB(e),e.rejection=1),a===!0?i=o:(l&&l.enter(),i=a(o),l&&(l.exit(),r=!0)),i===t.promise?d(new bv("Promise-chain cycle")):(n=Av(i))?zc(n,i,c,d):c(i)):d(o)}catch(u){l&&!r&&l.exit(),d(u)}},Ov=function(t,e){t.notified||(t.notified=!0,Sm(function(){for(var i,n=t.reactions;i=n.get();)wv(i,t);t.notified=!1,e&&!t.rejection&&WB(t)}))},Nv=function(t,e,i){var n,r;GB?((n=ym.createEvent("Event")).promise=e,n.reason=i,n.initEvent(t,!1,!0),wo.dispatchEvent(n)):n={promise:e,reason:i},!VB&&(r=wo["on"+t])?r(n):t===Iv&&MB("Unhandled promise rejection",i)},WB=function(t){zc(Tv,wo,function(){var e,i=t.facade,n=t.value;if(Dv(t)&&(e=UB(function(){hu?Cm.emit("unhandledRejection",n,i):Nv(Iv,i,n)}),t.rejection=hu||Dv(t)?2:1,e.error))throw e.value})},Dv=function(t){return t.rejection!==1&&!t.parent},HB=function(t){zc(Tv,wo,function(){var e=t.facade;hu?Cm.emit("rejectionHandled",e):Nv("rejectionhandled",e,t.value)})},pa=function(t,e,i){return function(n){t(e,n,i)}},_a=function(t,e,i){t.done||(t.done=!0,i&&(t=i),t.value=e,t.state=2,Ov(t,!0))},Im=function(t,e,i){if(!t.done){t.done=!0,i&&(t=i);try{if(t.facade===e)throw new bv("Promise can't be resolved itself");var n=Av(e);n?Sm(function(){var r={done:!1};try{zc(n,e,pa(Im,r,t),pa(_a,r,t))}catch(o){_a(r,o,t)}}):(t.value=e,t.state=1,Ov(t,!1))}catch(r){_a({done:!1},r,t)}}};Cv&&(vm=(Xc=function(t){LB(this,vm),DB(t),zc(fm,this);var e=Rm(this);try{t(pa(Im,e),pa(_a,e))}catch(i){_a(e,i)}}).prototype,(fm=function(t){FB(this,{type:pu,done:!1,notified:!1,parent:!1,reactions:new xB,rejection:!1,state:0,value:null})}).prototype=wB(vm,"then",function(t,e){var i=Rm(this),n=bm(kB(this,Xc));return i.parent=!0,n.ok=!gm(t)||t,n.fail=gm(e)&&e,n.domain=hu?Cm.domain:void 0,i.state===0?i.reactions.add(n):Sm(function(){wv(n,i)}),n.promise}),Sv=function(){var t=new fm,e=Rm(t);this.promise=t,this.resolve=pa(Im,e),this.reject=pa(_a,e)},yv.f=bm=function(t){return t===Xc||t===void 0?new Sv(t):jB(t)}),AB({global:!0,constructor:!0,wrap:!0,forced:Cv},{Promise:Xc}),OB(Xc,pu,!1,!0),NB(pu);var Pv=Pe("iterator"),Lv=!1;try{var KB=0,kv={next:function(){return{done:!!KB++}},return:function(){Lv=!0}};kv[Pv]=function(){return this},Array.from(kv,function(){throw 2})}catch{}var qB=ds,YB=function(t,e){try{if(!e&&!Lv)return!1}catch{return!1}var i=!1;try{var n={};n[Pv]=function(){return{next:function(){return{done:i=!0}}}},t(n)}catch{}return i},_u=Yc.CONSTRUCTOR||!YB(function(t){qB.all(t).then(void 0,function(){})}),zB=ii,XB=qi,JB=gr,QB=ha,ZB=jc;Ht({target:"Promise",stat:!0,forced:_u},{all:function(t){var e=this,i=JB.f(e),n=i.resolve,r=i.reject,o=QB(function(){var s=XB(e.resolve),a=[],c=0,d=1;ZB(t,function(l){var u=c++,h=!1;d++,zB(s,e,l).then(function(p){h||(h=!0,a[u]=p,--d||n(a))},r)}),--d||n(a)});return o.error&&r(o.value),i.promise}});var $B=Ht,tj=Yc.CONSTRUCTOR;ds&&ds.prototype,$B({target:"Promise",proto:!0,forced:tj,real:!0},{catch:function(t){return this.then(void 0,t)}});var ej=ii,ij=qi,nj=gr,rj=ha,oj=jc;Ht({target:"Promise",stat:!0,forced:_u},{race:function(t){var e=this,i=nj.f(e),n=i.reject,r=rj(function(){var o=ij(e.resolve);oj(t,function(s){ej(o,e,s).then(i.resolve,n)})});return r.error&&n(r.value),i.promise}});var sj=gr;Ht({target:"Promise",stat:!0,forced:Yc.CONSTRUCTOR},{reject:function(t){var e=sj.f(this);return(0,e.reject)(t),e.promise}});var aj=Fi,cj=yi,dj=gr,Mv=function(t,e){if(aj(t),cj(e)&&e.constructor===t)return e;var i=dj.f(t);return(0,i.resolve)(e),i.promise},lj=Ht,uj=ds,hj=Yc.CONSTRUCTOR,pj=Mv,_j=Ci("Promise"),mj=!hj;lj({target:"Promise",stat:!0,forced:!0},{resolve:function(t){return pj(mj&&this===_j?uj:this,t)}});var Ej=ii,fj=qi,gj=gr,Sj=ha,Tj=jc;Ht({target:"Promise",stat:!0,forced:_u},{allSettled:function(t){var e=this,i=gj.f(e),n=i.resolve,r=i.reject,o=Sj(function(){var s=fj(e.resolve),a=[],c=0,d=1;Tj(t,function(l){var u=c++,h=!1;d++,Ej(s,e,l).then(function(p){h||(h=!0,a[u]={status:"fulfilled",value:p},--d||n(a))},function(p){h||(h=!0,a[u]={status:"rejected",reason:p},--d||n(a))})}),--d||n(a)});return o.error&&r(o.value),i.promise}});var Rj=ii,vj=qi,yj=Ci,Cj=gr,bj=ha,Ij=jc,Uv="No one promise resolved";Ht({target:"Promise",stat:!0,forced:_u},{any:function(t){var e=this,i=yj("AggregateError"),n=Cj.f(e),r=n.resolve,o=n.reject,s=bj(function(){var a=vj(e.resolve),c=[],d=0,l=1,u=!1;Ij(t,function(h){var p=d++,g=!1;l++,Rj(a,e,h).then(function(E){g||u||(u=!0,r(E))},function(E){g||u||(g=!0,c[p]=E,--l||o(new i(c,Uv)))})}),--l||o(new i(c,Uv))});return s.error&&o(s.value),n.promise}});var Aj=Ht,wj=Pc,Oj=Ao,Nj=gr,Dj=qi,xv=ha,Am=jt.Promise,Vv=!1;Aj({target:"Promise",stat:!0,forced:!Am||!Am.try||xv(function(){Am.try(function(t){Vv=t===8},8)}).error||!Vv},{try:function(t){var e=arguments.length>1?Oj(arguments,1):[],i=Nj.f(this),n=xv(function(){return wj(Dj(t),void 0,e)});return(n.error?i.reject:i.resolve)(n.value),i.promise}});var Pj=gr;Ht({target:"Promise",stat:!0},{withResolvers:function(){var t=Pj.f(this);return{promise:t.promise,resolve:t.resolve,reject:t.reject}}});var Lj=Ht,wm=ds,kj=O,Mj=Ci,Uj=Je,xj=nm,Fv=Mv,Vj=wm&&wm.prototype;Lj({target:"Promise",proto:!0,real:!0,forced:!!wm&&kj(function(){Vj.finally.call({then:function(){}},function(){})})},{finally:function(t){var e=xj(this,Mj("Promise")),i=Uj(t);return this.then(i?function(n){return Fv(e,t()).then(function(){return n})}:t,i?function(n){return Fv(e,t()).then(function(){throw n})}:t)}});var Om=mt,Fj=C_,Bj=Yi,jj=ns,Gj=Om("".charAt),Bv=Om("".charCodeAt),Wj=Om("".slice),jv=function(t){return function(e,i){var n,r,o=Bj(jj(e)),s=Fj(i),a=o.length;return s<0||s>=a?t?"":void 0:(n=Bv(o,s))<55296||n>56319||s+1===a||(r=Bv(o,s+1))<56320||r>57343?t?Gj(o,s):n:t?Wj(o,s,s+2):r-56320+(n-55296<<10)+65536}},Nm={codeAt:jv(!1),charAt:jv(!0)},Hj=Nm.charAt,Kj=Yi,Gv=as,qj=xR,Wv=ru,Hv="String Iterator",Yj=Gv.set,zj=Gv.getterFor(Hv);qj(String,"String",function(t){Yj(this,{type:Hv,string:Kj(t),index:0})},function(){var t,e=zj(this),i=e.string,n=e.index;return n>=i.length?Wv(void 0,!0):(t=Hj(i,n),e.index+=t.length,Wv(t,!1))});var Xj=dn.Promise,Jj={CSSRuleList:0,CSSStyleDeclaration:0,CSSValueList:0,ClientRectList:0,DOMRectList:0,DOMStringList:0,DOMTokenList:1,DataTransferItemList:0,FileList:0,HTMLAllCollection:0,HTMLCollection:0,HTMLFormElement:0,HTMLSelectElement:0,MediaList:0,MimeTypeArray:0,NamedNodeMap:0,NodeList:1,PaintRequestList:0,Plugin:0,PluginArray:0,SVGLengthList:0,SVGNumberList:0,SVGPathSegList:0,SVGPointList:0,SVGStringList:0,SVGTransformList:0,SourceBufferList:0,StyleSheetList:0,TextTrackCueList:0,TextTrackList:0,TouchList:0},Qj=jt,Zj=qr,Kv=sa;for(var Dm in Jj)Zj(Qj[Dm],Dm),Kv[Dm]=Kv.Array;var qv=Xj,Q=b(qv),$j=Cn("Array","values"),tG=bo,eG=ai,iG=Wt,nG=$j,Pm=Array.prototype,rG={DOMTokenList:!0,NodeList:!0},oG=function(t){var e=t.values;return t===Pm||iG(Pm,t)&&e===Pm.values||eG(rG,tG(t))?nG:e},Bi=b(oG),Yv=ea,sG=TypeError,zv=Ao,aG=Math.floor,Lm=function(t,e){var i=t.length;if(i<8)for(var n,r,o=1;o<i;){for(r=o,n=t[o];r&&e(t[r-1],n)>0;)t[r]=t[--r];r!==o++&&(t[r]=n)}else for(var s=aG(i/2),a=Lm(zv(t,0,s),e),c=Lm(zv(t,s),e),d=a.length,l=c.length,u=0,h=0;u<d||h<l;)t[u+h]=u<d&&h<l?e(a[u],c[h])<=0?a[u++]:c[h++]:u<d?a[u++]:c[h++];return t},Xv=Lm,Jv=Kr.match(/firefox\/(\d+)/i),cG=!!Jv&&+Jv[1],dG=/MSIE|Trident/.test(Kr),Qv=Kr.match(/AppleWebKit\/(\d+)\./),lG=!!Qv&&+Qv[1],uG=Ht,Zv=mt,hG=qi,pG=Er,$v=Co,_G=function(t,e){if(!delete t[e])throw new sG("Cannot delete property "+Yv(e)+" of "+Yv(t))},ty=Yi,km=O,mG=Xv,EG=jl,ey=cG,fG=dG,iy=rs,ny=lG,Oo=[],ry=Zv(Oo.sort),gG=Zv(Oo.push),SG=km(function(){Oo.sort(void 0)}),TG=km(function(){Oo.sort(null)}),RG=EG("sort"),oy=!km(function(){if(iy)return iy<70;if(!(ey&&ey>3)){if(fG)return!0;if(ny)return ny<603;var t,e,i,n,r="";for(t=65;t<76;t++){switch(e=String.fromCharCode(t),t){case 66:case 69:case 70:case 72:i=3;break;case 68:case 71:i=4;break;default:i=2}for(n=0;n<47;n++)Oo.push({k:e+n,v:i})}for(Oo.sort(function(o,s){return s.v-o.v}),n=0;n<Oo.length;n++)e=Oo[n].k.charAt(0),r.charAt(r.length-1)!==e&&(r+=e);return r!=="DGBEFHACIJK"}});uG({target:"Array",proto:!0,forced:SG||!TG||!RG||!oy},{sort:function(t){t!==void 0&&hG(t);var e=pG(this);if(oy)return t===void 0?ry(e):ry(e,t);var i,n,r=[],o=$v(e);for(n=0;n<o;n++)n in e&&gG(r,e[n]);for(mG(r,function(s){return function(a,c){return c===void 0?-1:a===void 0?1:s!==void 0?+s(a,c)||0:ty(a)>ty(c)?1:-1}}(t)),i=$v(r),n=0;n<i;)e[n]=r[n++];for(;n<o;)_G(e,n++);return e}});var vG=Cn("Array","sort"),yG=Wt,CG=vG,Mm=Array.prototype,bG=function(t){var e=t.sort;return t===Mm||yG(Mm,t)&&e===Mm.sort?CG:e},ls=b(bG),IG=Ht,AG=mt,wG=b_,OG=RangeError,sy=String.fromCharCode,ay=String.fromCodePoint,NG=AG([].join);IG({target:"String",stat:!0,arity:1,forced:!!ay&&ay.length!==1},{fromCodePoint:function(t){for(var e,i=[],n=arguments.length,r=0;n>r;){if(e=+arguments[r++],wG(e,1114111)!==e)throw new OG(e+" is not a valid code point");i[r]=e<65536?sy(e):sy(55296+((e-=65536)>>10),e%1024+56320)}return NG(i,"")}});var DG=O,PG=Pe("iterator"),mu=!DG(function(){var t=new URL("b?a=1&b=2&c=3","https://a"),e=t.searchParams,i=new URLSearchParams("a=1&a=2&b=3"),n="";return t.pathname="c%20d",e.forEach(function(r,o){e.delete("b"),n+=o+r}),i.delete("a",2),i.delete("b",void 0),!t.toJSON||!i.has("a",1)||i.has("a",2)||!i.has("a",void 0)||i.has("b")||!e.size&&!0||!e.sort||t.href!=="https://a/c%20d?a=1&c=3"||e.get("c")!=="3"||String(new URLSearchParams("?a=1"))!=="a=1"||!e[PG]||new URL("https://a@b").username!=="a"||new URLSearchParams(new URLSearchParams("a=b")).get("a")!=="b"||new URL("https://\u0442\u0435\u0441\u0442").host!=="xn--e1aybc"||new URL("https://a#\u0431").hash!=="#%D0%B1"||n!=="a1c3"||new URL("https://x",void 0).host!=="x"}),LG=Io,Um=Ht,cy=jt,xm=ov,kG=Ci,Eu=ii,zn=mt,Jc=Di,dy=mu,ly=Io,MG=su,UG=function(t,e,i){for(var n in e)i&&i.unsafe&&t[n]?t[n]=e[n]:LG(t,n,e[n],i);return t},xG=qr,VG=Q_,Vm=as,uy=$_,Fm=Je,FG=ai,BG=yo,jG=bo,GG=Fi,hy=yi,ji=Yi,WG=Bc,py=Ro,_y=j_,HG=Jl,fu=ru,ma=cs,KG=Xv,qG=Pe("iterator"),Ea="URLSearchParams",my=Ea+"Iterator",Ey=Vm.set,In=Vm.getterFor(Ea),YG=Vm.getterFor(my),fy=xm("fetch"),gu=xm("Request"),Qc=xm("Headers"),Bm=gu&&gu.prototype,gy=Qc&&Qc.prototype,zG=cy.TypeError,XG=cy.encodeURIComponent,JG=String.fromCharCode,QG=kG("String","fromCodePoint"),ZG=parseInt,Su=zn("".charAt),Sy=zn([].join),No=zn([].push),Ty=zn("".replace),$G=zn([].shift),Ry=zn([].splice),vy=zn("".split),yy=zn("".slice),tW=zn(/./.exec),eW=/\+/g,iW=/^[0-9a-f]+$/i,Cy=function(t,e){var i=yy(t,e,e+2);return tW(iW,i)?ZG(i,16):NaN},nW=function(t){for(var e=0,i=128;i>0&&(t&i)!=0;i>>=1)e++;return e},rW=function(t){var e=null;switch(t.length){case 1:e=t[0];break;case 2:e=(31&t[0])<<6|63&t[1];break;case 3:e=(15&t[0])<<12|(63&t[1])<<6|63&t[2];break;case 4:e=(7&t[0])<<18|(63&t[1])<<12|(63&t[2])<<6|63&t[3]}return e>1114111?null:e},by=function(t){for(var e=(t=Ty(t,eW," ")).length,i="",n=0;n<e;){var r=Su(t,n);if(r==="%"){if(Su(t,n+1)==="%"||n+3>e){i+="%",n++;continue}var o=Cy(t,n+1);if(o!=o){i+=r,n++;continue}n+=2;var s=nW(o);if(s===0)r=JG(o);else{if(s===1||s>4){i+="\uFFFD",n++;continue}for(var a=[o],c=1;c<s&&!(++n+3>e||Su(t,n)!=="%");){var d=Cy(t,n+1);if(d!=d){n+=3;break}if(d>191||d<128)break;No(a,d),n+=2,c++}if(a.length!==s){i+="\uFFFD";continue}var l=rW(a);l===null?i+="\uFFFD":r=QG(l)}}i+=r,n++}return i},oW=/[!'()~]|%20/g,sW={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+"},aW=function(t){return sW[t]},Iy=function(t){return Ty(XG(t),oW,aW)},jm=VG(function(t,e){Ey(this,{type:my,target:In(t).entries,index:0,kind:e})},Ea,function(){var t=YG(this),e=t.target,i=t.index++;if(!e||i>=e.length)return t.target=null,fu(void 0,!0);var n=e[i];switch(t.kind){case"keys":return fu(n.key,!1);case"values":return fu(n.value,!1)}return fu([n.key,n.value],!1)},!0),Ay=function(t){this.entries=[],this.url=null,t!==void 0&&(hy(t)?this.parseObject(t):this.parseQuery(typeof t=="string"?Su(t,0)==="?"?yy(t,1):t:ji(t)))};Ay.prototype={type:Ea,bindURL:function(t){this.url=t,this.update()},parseObject:function(t){var e,i,n,r,o,s,a,c=this.entries,d=HG(t);if(d)for(i=(e=_y(t,d)).next;!(n=Eu(i,e)).done;){if(o=(r=_y(GG(n.value))).next,(s=Eu(o,r)).done||(a=Eu(o,r)).done||!Eu(o,r).done)throw new zG("Expected sequence with length 2");No(c,{key:ji(s.value),value:ji(a.value)})}else for(var l in t)FG(t,l)&&No(c,{key:l,value:ji(t[l])})},parseQuery:function(t){if(t)for(var e,i,n=this.entries,r=vy(t,"&"),o=0;o<r.length;)(e=r[o++]).length&&(i=vy(e,"="),No(n,{key:by($G(i)),value:by(Sy(i,"="))}))},serialize:function(){for(var t,e=this.entries,i=[],n=0;n<e.length;)t=e[n++],No(i,Iy(t.key)+"="+Iy(t.value));return Sy(i,"&")},update:function(){this.entries.length=0,this.parseQuery(this.url.query)},updateURL:function(){this.url&&this.url.update()}};var Tu=function(){uy(this,fa);var t=Ey(this,new Ay(arguments.length>0?arguments[0]:void 0));Jc||(this.size=t.entries.length)},fa=Tu.prototype;if(UG(fa,{append:function(t,e){var i=In(this);ma(arguments.length,2),No(i.entries,{key:ji(t),value:ji(e)}),Jc||this.length++,i.updateURL()},delete:function(t){for(var e=In(this),i=ma(arguments.length,1),n=e.entries,r=ji(t),o=i<2?void 0:arguments[1],s=o===void 0?o:ji(o),a=0;a<n.length;){var c=n[a];if(c.key!==r||s!==void 0&&c.value!==s)a++;else if(Ry(n,a,1),s!==void 0)break}Jc||(this.size=n.length),e.updateURL()},get:function(t){var e=In(this).entries;ma(arguments.length,1);for(var i=ji(t),n=0;n<e.length;n++)if(e[n].key===i)return e[n].value;return null},getAll:function(t){var e=In(this).entries;ma(arguments.length,1);for(var i=ji(t),n=[],r=0;r<e.length;r++)e[r].key===i&&No(n,e[r].value);return n},has:function(t){for(var e=In(this).entries,i=ma(arguments.length,1),n=ji(t),r=i<2?void 0:arguments[1],o=r===void 0?r:ji(r),s=0;s<e.length;){var a=e[s++];if(a.key===n&&(o===void 0||a.value===o))return!0}return!1},set:function(t,e){var i=In(this);ma(arguments.length,1);for(var n,r=i.entries,o=!1,s=ji(t),a=ji(e),c=0;c<r.length;c++)(n=r[c]).key===s&&(o?Ry(r,c--,1):(o=!0,n.value=a));o||No(r,{key:s,value:a}),Jc||(this.size=r.length),i.updateURL()},sort:function(){var t=In(this);KG(t.entries,function(e,i){return e.key>i.key?1:-1}),t.updateURL()},forEach:function(t){for(var e,i=In(this).entries,n=BG(t,arguments.length>1?arguments[1]:void 0),r=0;r<i.length;)n((e=i[r++]).value,e.key,this)},keys:function(){return new jm(this,"keys")},values:function(){return new jm(this,"values")},entries:function(){return new jm(this,"entries")}},{enumerable:!0}),ly(fa,qG,fa.entries,{name:"entries"}),ly(fa,"toString",function(){return In(this).serialize()},{enumerable:!0}),Jc&&MG(fa,"size",{get:function(){return In(this).entries.length},configurable:!0,enumerable:!0}),xG(Tu,Ea),Um({global:!0,constructor:!0,forced:!dy},{URLSearchParams:Tu}),!dy&&Fm(Qc)){var cW=zn(gy.has),dW=zn(gy.set),wy=function(t){if(hy(t)){var e,i=t.body;if(jG(i)===Ea)return e=t.headers?new Qc(t.headers):new Qc,cW(e,"content-type")||dW(e,"content-type","application/x-www-form-urlencoded;charset=UTF-8"),WG(t,{body:py(0,ji(i)),headers:py(0,e)})}return t};if(Fm(fy)&&Um({global:!0,enumerable:!0,dontCallGetSet:!0,forced:!0},{fetch:function(t){return fy(t,arguments.length>1?wy(arguments[1]):{})}}),Fm(gu)){var Gm=function(t){return uy(this,Bm),new gu(t,arguments.length>1?wy(arguments[1]):{})};Bm.constructor=Gm,Gm.prototype=Bm,Um({global:!0,constructor:!0,dontCallGetSet:!0,forced:!0},{Request:Gm})}}var An,lW={URLSearchParams:Tu,getState:In},uW=dn.URLSearchParams,Oy=Di,hW=mt,pW=ii,_W=O,Wm=Yl,mW=Fc,EW=kl,fW=Er,gW=Ul,ga=Object.assign,Ny=Object.defineProperty,SW=hW([].concat),TW=!ga||_W(function(){if(Oy&&ga({b:1},ga(Ny({},"a",{enumerable:!0,get:function(){Ny(this,"b",{value:3,enumerable:!1})}}),{b:2})).b!==1)return!0;var t={},e={},i=Symbol("assign detection"),n="abcdefghijklmnopqrst";return t[i]=7,n.split("").forEach(function(r){e[r]=r}),ga({},t)[i]!==7||Wm(ga({},e)).join("")!==n})?function(t,e){for(var i=fW(t),n=arguments.length,r=1,o=mW.f,s=EW.f;n>r;)for(var a,c=gW(arguments[r++]),d=o?SW(Wm(c),o(c)):Wm(c),l=d.length,u=0;l>u;)a=d[u++],Oy&&!pW(s,c,a)||(i[a]=c[a]);return i}:ga,RW=Fi,vW=fR,yW=Di,CW=yn,bW=Ro,Hm=function(t,e,i){yW?CW.f(t,e,bW(0,i)):t[e]=i},IW=yo,AW=ii,wW=Er,OW=function(t,e,i,n){try{return n?e(RW(i)[0],i[1]):e(i)}catch(r){vW(t,"throw",r)}},NW=_R,DW=au,PW=Co,Dy=Hm,LW=j_,kW=Jl,Py=Array,us=mt,Km=2147483647,MW=/[^\0-\u007E]/,Ly=/[.\u3002\uFF0E\uFF61]/g,ky="Overflow: input needs wider integers to process",My=RangeError,UW=us(Ly.exec),Sa=Math.floor,qm=String.fromCharCode,Uy=us("".charCodeAt),xy=us([].join),Do=us([].push),xW=us("".replace),VW=us("".split),FW=us("".toLowerCase),Vy=function(t){return t+22+75*(t<26)},BW=function(t,e,i){var n=0;for(t=i?Sa(t/700):t>>1,t+=Sa(t/e);t>455;)t=Sa(t/35),n+=36;return Sa(n+36*t/(t+38))},jW=function(t){var e=[];t=function(R){for(var y=[],N=0,k=R.length;N<k;){var L=Uy(R,N++);if(L>=55296&&L<=56319&&N<k){var P=Uy(R,N++);(64512&P)==56320?Do(y,((1023&L)<<10)+(1023&P)+65536):(Do(y,L),N--)}else Do(y,L)}return y}(t);var i,n,r=t.length,o=128,s=0,a=72;for(i=0;i<t.length;i++)(n=t[i])<128&&Do(e,qm(n));var c=e.length,d=c;for(c&&Do(e,"-");d<r;){var l=Km;for(i=0;i<t.length;i++)(n=t[i])>=o&&n<l&&(l=n);var u=d+1;if(l-o>Sa((Km-s)/u))throw new My(ky);for(s+=(l-o)*u,o=l,i=0;i<t.length;i++){if((n=t[i])<o&&++s>Km)throw new My(ky);if(n===o){for(var h=s,p=36;;){var g=p<=a?1:p>=a+26?26:p-a;if(h<g)break;var E=h-g,f=36-g;Do(e,qm(Vy(g+E%f))),h=Sa(E/f),p+=36}Do(e,qm(Vy(h))),a=BW(s,u,d===c),s=0,d++}}s++,o++}return xy(e,"")},GW=Ht,Ym=Di,WW=mu,zm=jt,Fy=yo,wn=mt,Ru=Io,On=su,HW=$_,Xm=ai,Jm=TW,Ta=function(t){var e=wW(t),i=DW(this),n=arguments.length,r=n>1?arguments[1]:void 0,o=r!==void 0;o&&(r=IW(r,n>2?arguments[2]:void 0));var s,a,c,d,l,u,h=kW(e),p=0;if(!h||this===Py&&NW(h))for(s=PW(e),a=i?new this(s):Py(s);s>p;p++)u=o?r(e[p],p):e[p],Dy(a,p,u);else for(a=i?new this:[],l=(d=LW(e,h)).next;!(c=AW(l,d)).done;p++)u=o?OW(d,r,[c.value,p],!0):c.value,Dy(a,p,u);return a.length=p,a},Xn=Ao,KW=Nm.codeAt,qW=function(t){var e,i,n=[],r=VW(xW(FW(t),Ly,"."),".");for(e=0;e<r.length;e++)i=r[e],Do(n,UW(MW,i)?"xn--"+jW(i):i);return xy(n,".")},Yr=Yi,YW=qr,zW=cs,By=lW,jy=as,XW=jy.set,vu=jy.getterFor("URL"),JW=By.URLSearchParams,QW=By.getState,Zc=zm.URL,Qm=zm.TypeError,yu=zm.parseInt,ZW=Math.floor,Gy=Math.pow,Nn=wn("".charAt),Jn=wn(/./.exec),$c=wn([].join),$W=wn(1 .toString),t3=wn([].pop),Ra=wn([].push),Zm=wn("".replace),e3=wn([].shift),i3=wn("".split),td=wn("".slice),Cu=wn("".toLowerCase),n3=wn([].unshift),$m="Invalid scheme",hs="Invalid host",Wy="Invalid port",Hy=/[a-z]/i,r3=/[\d+-.a-z]/i,tE=/\d/,o3=/^0x/i,s3=/^[0-7]+$/,a3=/^\d+$/,Ky=/^[\da-f]+$/i,c3=/[\0\t\n\r #%/:<>?@[\\\]^|]/,d3=/[\0\t\n\r #/:<>?@[\\\]^|]/,l3=/^[\u0000-\u0020]+/,u3=/(^|[^\u0000-\u0020])[\u0000-\u0020]+$/,h3=/[\t\n\r]/g,ed=function(t){var e,i,n,r;if(typeof t=="number"){for(e=[],i=0;i<4;i++)n3(e,t%256),t=ZW(t/256);return $c(e,".")}if(typeof t=="object"){for(e="",n=function(o){for(var s=null,a=1,c=null,d=0,l=0;l<8;l++)o[l]!==0?(d>a&&(s=c,a=d),c=null,d=0):(c===null&&(c=l),++d);return d>a?c:s}(t),i=0;i<8;i++)r&&t[i]===0||(r&&(r=!1),n===i?(e+=i?":":"::",r=!0):(e+=$W(t[i],16),i<7&&(e+=":")));return"["+e+"]"}return t},bu={},qy=Jm({},bu,{" ":1,'"':1,"<":1,">":1,"`":1}),Yy=Jm({},qy,{"#":1,"?":1,"{":1,"}":1}),eE=Jm({},Yy,{"/":1,":":1,";":1,"=":1,"@":1,"[":1,"\\":1,"]":1,"^":1,"|":1}),Po=function(t,e){var i=KW(t,0);return i>32&&i<127&&!Xm(e,t)?t:encodeURIComponent(t)},Iu={ftp:21,file:null,http:80,https:443,ws:80,wss:443},id=function(t,e){var i;return t.length===2&&Jn(Hy,Nn(t,0))&&((i=Nn(t,1))===":"||!e&&i==="|")},zy=function(t){var e;return t.length>1&&id(td(t,0,2))&&(t.length===2||(e=Nn(t,2))==="/"||e==="\\"||e==="?"||e==="#")},p3=function(t){return t==="."||Cu(t)==="%2e"},iE={},Xy={},nE={},Jy={},Qy={},rE={},Zy={},$y={},Au={},wu={},oE={},sE={},aE={},cE={},tC={},dE={},va={},Sr={},eC={},ps={},zr={},lE=function(t,e,i){var n,r,o,s=Yr(t);if(e){if(r=this.parse(s))throw new Qm(r);this.searchParams=null}else{if(i!==void 0&&(n=new lE(i,!0)),r=this.parse(s,null,n))throw new Qm(r);(o=QW(new JW)).bindURL(this),this.searchParams=o}};lE.prototype={type:"URL",parse:function(t,e,i){var n,r,o,s,a,c=this,d=e||iE,l=0,u="",h=!1,p=!1,g=!1;for(t=Yr(t),e||(c.scheme="",c.username="",c.password="",c.host=null,c.port=null,c.path=[],c.query=null,c.fragment=null,c.cannotBeABaseURL=!1,t=Zm(t,l3,""),t=Zm(t,u3,"$1")),t=Zm(t,h3,""),n=Ta(t);l<=n.length;){switch(r=n[l],d){case iE:if(!r||!Jn(Hy,r)){if(e)return $m;d=nE;continue}u+=Cu(r),d=Xy;break;case Xy:if(r&&(Jn(r3,r)||r==="+"||r==="-"||r==="."))u+=Cu(r);else{if(r!==":"){if(e)return $m;u="",d=nE,l=0;continue}if(e&&(c.isSpecial()!==Xm(Iu,u)||u==="file"&&(c.includesCredentials()||c.port!==null)||c.scheme==="file"&&!c.host))return;if(c.scheme=u,e)return void(c.isSpecial()&&Iu[c.scheme]===c.port&&(c.port=null));u="",c.scheme==="file"?d=cE:c.isSpecial()&&i&&i.scheme===c.scheme?d=Jy:c.isSpecial()?d=$y:n[l+1]==="/"?(d=Qy,l++):(c.cannotBeABaseURL=!0,Ra(c.path,""),d=eC)}break;case nE:if(!i||i.cannotBeABaseURL&&r!=="#")return $m;if(i.cannotBeABaseURL&&r==="#"){c.scheme=i.scheme,c.path=Xn(i.path),c.query=i.query,c.fragment="",c.cannotBeABaseURL=!0,d=zr;break}d=i.scheme==="file"?cE:rE;continue;case Jy:if(r!=="/"||n[l+1]!=="/"){d=rE;continue}d=Au,l++;break;case Qy:if(r==="/"){d=wu;break}d=Sr;continue;case rE:if(c.scheme=i.scheme,r===An)c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=Xn(i.path),c.query=i.query;else if(r==="/"||r==="\\"&&c.isSpecial())d=Zy;else if(r==="?")c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=Xn(i.path),c.query="",d=ps;else{if(r!=="#"){c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=Xn(i.path),c.path.length--,d=Sr;continue}c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,c.path=Xn(i.path),c.query=i.query,c.fragment="",d=zr}break;case Zy:if(!c.isSpecial()||r!=="/"&&r!=="\\"){if(r!=="/"){c.username=i.username,c.password=i.password,c.host=i.host,c.port=i.port,d=Sr;continue}d=wu}else d=Au;break;case $y:if(d=Au,r!=="/"||Nn(u,l+1)!=="/")continue;l++;break;case Au:if(r!=="/"&&r!=="\\"){d=wu;continue}break;case wu:if(r==="@"){h&&(u="%40"+u),h=!0,o=Ta(u);for(var E=0;E<o.length;E++){var f=o[E];if(f!==":"||g){var R=Po(f,eE);g?c.password+=R:c.username+=R}else g=!0}u=""}else if(r===An||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(h&&u==="")return"Invalid authority";l-=Ta(u).length+1,u="",d=oE}else u+=r;break;case oE:case sE:if(e&&c.scheme==="file"){d=dE;continue}if(r!==":"||p){if(r===An||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()){if(c.isSpecial()&&u==="")return hs;if(e&&u===""&&(c.includesCredentials()||c.port!==null))return;if(s=c.parseHost(u))return s;if(u="",d=va,e)return;continue}r==="["?p=!0:r==="]"&&(p=!1),u+=r}else{if(u==="")return hs;if(s=c.parseHost(u))return s;if(u="",d=aE,e===sE)return}break;case aE:if(!Jn(tE,r)){if(r===An||r==="/"||r==="?"||r==="#"||r==="\\"&&c.isSpecial()||e){if(u!==""){var y=yu(u,10);if(y>65535)return Wy;c.port=c.isSpecial()&&y===Iu[c.scheme]?null:y,u=""}if(e)return;d=va;continue}return Wy}u+=r;break;case cE:if(c.scheme="file",r==="/"||r==="\\")d=tC;else{if(!i||i.scheme!=="file"){d=Sr;continue}switch(r){case An:c.host=i.host,c.path=Xn(i.path),c.query=i.query;break;case"?":c.host=i.host,c.path=Xn(i.path),c.query="",d=ps;break;case"#":c.host=i.host,c.path=Xn(i.path),c.query=i.query,c.fragment="",d=zr;break;default:zy($c(Xn(n,l),""))||(c.host=i.host,c.path=Xn(i.path),c.shortenPath()),d=Sr;continue}}break;case tC:if(r==="/"||r==="\\"){d=dE;break}i&&i.scheme==="file"&&!zy($c(Xn(n,l),""))&&(id(i.path[0],!0)?Ra(c.path,i.path[0]):c.host=i.host),d=Sr;continue;case dE:if(r===An||r==="/"||r==="\\"||r==="?"||r==="#"){if(!e&&id(u))d=Sr;else if(u===""){if(c.host="",e)return;d=va}else{if(s=c.parseHost(u))return s;if(c.host==="localhost"&&(c.host=""),e)return;u="",d=va}continue}u+=r;break;case va:if(c.isSpecial()){if(d=Sr,r!=="/"&&r!=="\\")continue}else if(e||r!=="?")if(e||r!=="#"){if(r!==An&&(d=Sr,r!=="/"))continue}else c.fragment="",d=zr;else c.query="",d=ps;break;case Sr:if(r===An||r==="/"||r==="\\"&&c.isSpecial()||!e&&(r==="?"||r==="#")){if((a=Cu(a=u))===".."||a==="%2e."||a===".%2e"||a==="%2e%2e"?(c.shortenPath(),r==="/"||r==="\\"&&c.isSpecial()||Ra(c.path,"")):p3(u)?r==="/"||r==="\\"&&c.isSpecial()||Ra(c.path,""):(c.scheme==="file"&&!c.path.length&&id(u)&&(c.host&&(c.host=""),u=Nn(u,0)+":"),Ra(c.path,u)),u="",c.scheme==="file"&&(r===An||r==="?"||r==="#"))for(;c.path.length>1&&c.path[0]==="";)e3(c.path);r==="?"?(c.query="",d=ps):r==="#"&&(c.fragment="",d=zr)}else u+=Po(r,Yy);break;case eC:r==="?"?(c.query="",d=ps):r==="#"?(c.fragment="",d=zr):r!==An&&(c.path[0]+=Po(r,bu));break;case ps:e||r!=="#"?r!==An&&(r==="'"&&c.isSpecial()?c.query+="%27":c.query+=r==="#"?"%23":Po(r,bu)):(c.fragment="",d=zr);break;case zr:r!==An&&(c.fragment+=Po(r,qy))}l++}},parseHost:function(t){var e,i,n;if(Nn(t,0)==="["){if(Nn(t,t.length-1)!=="]"||(e=function(r){var o,s,a,c,d,l,u,h=[0,0,0,0,0,0,0,0],p=0,g=null,E=0,f=function(){return Nn(r,E)};if(f()===":"){if(Nn(r,1)!==":")return;E+=2,g=++p}for(;f();){if(p===8)return;if(f()!==":"){for(o=s=0;s<4&&Jn(Ky,f());)o=16*o+yu(f(),16),E++,s++;if(f()==="."){if(s===0||(E-=s,p>6))return;for(a=0;f();){if(c=null,a>0){if(!(f()==="."&&a<4))return;E++}if(!Jn(tE,f()))return;for(;Jn(tE,f());){if(d=yu(f(),10),c===null)c=d;else{if(c===0)return;c=10*c+d}if(c>255)return;E++}h[p]=256*h[p]+c,++a!=2&&a!==4||p++}if(a!==4)return;break}if(f()===":"){if(E++,!f())return}else if(f())return;h[p++]=o}else{if(g!==null)return;E++,g=++p}}if(g!==null)for(l=p-g,p=7;p!==0&&l>0;)u=h[p],h[p--]=h[g+l-1],h[g+--l]=u;else if(p!==8)return;return h}(td(t,1,-1)),!e))return hs;this.host=e}else if(this.isSpecial()){if(t=qW(t),Jn(c3,t)||(e=function(r){var o,s,a,c,d,l,u,h=i3(r,".");if(h.length&&h[h.length-1]===""&&h.length--,(o=h.length)>4)return r;for(s=[],a=0;a<o;a++){if((c=h[a])==="")return r;if(d=10,c.length>1&&Nn(c,0)==="0"&&(d=Jn(o3,c)?16:8,c=td(c,d===8?1:2)),c==="")l=0;else{if(!Jn(d===10?a3:d===8?s3:Ky,c))return r;l=yu(c,d)}Ra(s,l)}for(a=0;a<o;a++)if(l=s[a],a===o-1){if(l>=Gy(256,5-o))return null}else if(l>255)return null;for(u=t3(s),a=0;a<s.length;a++)u+=s[a]*Gy(256,3-a);return u}(t),e===null))return hs;this.host=e}else{if(Jn(d3,t))return hs;for(e="",i=Ta(t),n=0;n<i.length;n++)e+=Po(i[n],bu);this.host=e}},cannotHaveUsernamePasswordPort:function(){return!this.host||this.cannotBeABaseURL||this.scheme==="file"},includesCredentials:function(){return this.username!==""||this.password!==""},isSpecial:function(){return Xm(Iu,this.scheme)},shortenPath:function(){var t=this.path,e=t.length;!e||this.scheme==="file"&&e===1&&id(t[0],!0)||t.length--},serialize:function(){var t=this,e=t.scheme,i=t.username,n=t.password,r=t.host,o=t.port,s=t.path,a=t.query,c=t.fragment,d=e+":";return r!==null?(d+="//",t.includesCredentials()&&(d+=i+(n?":"+n:"")+"@"),d+=ed(r),o!==null&&(d+=":"+o)):e==="file"&&(d+="//"),d+=t.cannotBeABaseURL?s[0]:s.length?"/"+$c(s,"/"):"",a!==null&&(d+="?"+a),c!==null&&(d+="#"+c),d},setHref:function(t){var e=this.parse(t);if(e)throw new Qm(e);this.searchParams.update()},getOrigin:function(){var t=this.scheme,e=this.port;if(t==="blob")try{return new ya(t.path[0]).origin}catch{return"null"}return t!=="file"&&this.isSpecial()?t+"://"+ed(this.host)+(e!==null?":"+e:""):"null"},getProtocol:function(){return this.scheme+":"},setProtocol:function(t){this.parse(Yr(t)+":",iE)},getUsername:function(){return this.username},setUsername:function(t){var e=Ta(Yr(t));if(!this.cannotHaveUsernamePasswordPort()){this.username="";for(var i=0;i<e.length;i++)this.username+=Po(e[i],eE)}},getPassword:function(){return this.password},setPassword:function(t){var e=Ta(Yr(t));if(!this.cannotHaveUsernamePasswordPort()){this.password="";for(var i=0;i<e.length;i++)this.password+=Po(e[i],eE)}},getHost:function(){var t=this.host,e=this.port;return t===null?"":e===null?ed(t):ed(t)+":"+e},setHost:function(t){this.cannotBeABaseURL||this.parse(t,oE)},getHostname:function(){var t=this.host;return t===null?"":ed(t)},setHostname:function(t){this.cannotBeABaseURL||this.parse(t,sE)},getPort:function(){var t=this.port;return t===null?"":Yr(t)},setPort:function(t){this.cannotHaveUsernamePasswordPort()||((t=Yr(t))===""?this.port=null:this.parse(t,aE))},getPathname:function(){var t=this.path;return this.cannotBeABaseURL?t[0]:t.length?"/"+$c(t,"/"):""},setPathname:function(t){this.cannotBeABaseURL||(this.path=[],this.parse(t,va))},getSearch:function(){var t=this.query;return t?"?"+t:""},setSearch:function(t){(t=Yr(t))===""?this.query=null:(Nn(t,0)==="?"&&(t=td(t,1)),this.query="",this.parse(t,ps)),this.searchParams.update()},getSearchParams:function(){return this.searchParams.facade},getHash:function(){var t=this.fragment;return t?"#"+t:""},setHash:function(t){(t=Yr(t))!==""?(Nn(t,0)==="#"&&(t=td(t,1)),this.fragment="",this.parse(t,zr)):this.fragment=null},update:function(){this.query=this.searchParams.serialize()||null}};var ya=function(t){var e=HW(this,Gi),i=zW(arguments.length,1)>1?arguments[1]:void 0,n=XW(e,new lE(t,!1,i));Ym||(e.href=n.serialize(),e.origin=n.getOrigin(),e.protocol=n.getProtocol(),e.username=n.getUsername(),e.password=n.getPassword(),e.host=n.getHost(),e.hostname=n.getHostname(),e.port=n.getPort(),e.pathname=n.getPathname(),e.search=n.getSearch(),e.searchParams=n.getSearchParams(),e.hash=n.getHash())},Gi=ya.prototype,Dn=function(t,e){return{get:function(){return vu(this)[t]()},set:e&&function(i){return vu(this)[e](i)},configurable:!0,enumerable:!0}};if(Ym&&(On(Gi,"href",Dn("serialize","setHref")),On(Gi,"origin",Dn("getOrigin")),On(Gi,"protocol",Dn("getProtocol","setProtocol")),On(Gi,"username",Dn("getUsername","setUsername")),On(Gi,"password",Dn("getPassword","setPassword")),On(Gi,"host",Dn("getHost","setHost")),On(Gi,"hostname",Dn("getHostname","setHostname")),On(Gi,"port",Dn("getPort","setPort")),On(Gi,"pathname",Dn("getPathname","setPathname")),On(Gi,"search",Dn("getSearch","setSearch")),On(Gi,"searchParams",Dn("getSearchParams")),On(Gi,"hash",Dn("getHash","setHash"))),Ru(Gi,"toJSON",function(){return vu(this).serialize()},{enumerable:!0}),Ru(Gi,"toString",function(){return vu(this).serialize()},{enumerable:!0}),Zc){var iC=Zc.createObjectURL,nC=Zc.revokeObjectURL;iC&&Ru(ya,"createObjectURL",Fy(iC,Zc)),nC&&Ru(ya,"revokeObjectURL",Fy(nC,Zc))}YW(ya,"URL"),GW({global:!0,constructor:!0,forced:!WW,sham:!Ym},{URL:ya});var _3=Ht,rC=O,m3=cs,oC=Yi,E3=mu,uE=Ci("URL"),f3=E3&&rC(function(){uE.canParse()}),g3=rC(function(){return uE.canParse.length!==1});_3({target:"URL",stat:!0,forced:!f3||g3},{canParse:function(t){var e=m3(arguments.length,1),i=oC(t),n=e<2||arguments[1]===void 0?void 0:oC(arguments[1]);try{return!!new uE(i,n)}catch{return!1}}});var S3=Ht,T3=cs,sC=Yi,R3=mu,v3=Ci("URL");S3({target:"URL",stat:!0,forced:!R3},{parse:function(t){var e=T3(arguments.length,1),i=sC(t),n=e<2||arguments[1]===void 0?void 0:sC(arguments[1]);try{return new v3(i,n)}catch{return null}}});var Ou=b(dn.URL);let aC=!0,cC=!0;function Nu(t,e,i){let n=t.match(e);return n&&n.length>=i&&parseInt(n[i],10)}function _s(t,e,i){if(!t.RTCPeerConnection)return;let n=t.RTCPeerConnection.prototype,r=n.addEventListener;n.addEventListener=function(s,a){if(s!==e)return r.apply(this,arguments);let c=d=>{let l=i(d);l&&(a.handleEvent?a.handleEvent(l):a(l))};return this._eventMap=this._eventMap||{},this._eventMap[e]||(this._eventMap[e]=new Map),this._eventMap[e].set(a,c),r.apply(this,[s,c])};let o=n.removeEventListener;n.removeEventListener=function(s,a){if(s!==e||!this._eventMap||!this._eventMap[e])return o.apply(this,arguments);if(!this._eventMap[e].has(a))return o.apply(this,arguments);let c=this._eventMap[e].get(a);return this._eventMap[e].delete(a),this._eventMap[e].size===0&&delete this._eventMap[e],Object.keys(this._eventMap).length===0&&delete this._eventMap,o.apply(this,[s,c])},Object.defineProperty(n,"on"+e,{get(){return this["_on"+e]},set(s){this["_on"+e]&&(this.removeEventListener(e,this["_on"+e]),delete this["_on"+e]),s&&this.addEventListener(e,this["_on"+e]=s)},enumerable:!0,configurable:!0})}function y3(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(aC=t,t?"adapter.js logging disabled":"adapter.js logging enabled")}function C3(t){return typeof t!="boolean"?new Error("Argument type: "+typeof t+". Please use a boolean."):(cC=!t,"adapter.js deprecation warnings "+(t?"disabled":"enabled"))}function dC(){if(typeof window=="object"){if(aC)return;typeof console<"u"&&typeof console.log=="function"&&console.log.apply(console,arguments)}}function hE(t,e){cC&&console.warn(t+" is deprecated, please use "+e+" instead.")}function lC(t){return Object.prototype.toString.call(t)==="[object Object]"}function uC(t){var e;return lC(t)?bn(e=Object.keys(t)).call(e,function(i,n){let r=lC(t[n]),o=r?uC(t[n]):t[n],s=r&&!Object.keys(o).length;return o===void 0||s?i:Object.assign(i,{[n]:o})},{}):t}function pE(t,e,i){e&&!i.has(e.id)&&(i.set(e.id,e),Object.keys(e).forEach(n=>{n.endsWith("Id")?pE(t,t.get(e[n]),i):n.endsWith("Ids")&&e[n].forEach(r=>{pE(t,t.get(r),i)})}))}function hC(t,e,i){let n=i?"outbound-rtp":"inbound-rtp",r=new Map;if(e===null)return r;let o=[];return t.forEach(s=>{s.type==="track"&&s.trackIdentifier===e.id&&o.push(s)}),o.forEach(s=>{t.forEach(a=>{a.type===n&&a.trackId===s.id&&pE(t,a,r)})}),r}let pC=dC;function _C(t,e){let i=t&&t.navigator;if(!i.mediaDevices)return;let n=function(s){if(typeof s!="object"||s.mandatory||s.optional)return s;let a={};return Object.keys(s).forEach(c=>{if(c==="require"||c==="advanced"||c==="mediaSource")return;let d=typeof s[c]=="object"?s[c]:{ideal:s[c]};d.exact!==void 0&&typeof d.exact=="number"&&(d.min=d.max=d.exact);let l=function(u,h){return u?u+h.charAt(0).toUpperCase()+h.slice(1):h==="deviceId"?"sourceId":h};if(d.ideal!==void 0){a.optional=a.optional||[];let u={};typeof d.ideal=="number"?(u[l("min",c)]=d.ideal,a.optional.push(u),u={},u[l("max",c)]=d.ideal,a.optional.push(u)):(u[l("",c)]=d.ideal,a.optional.push(u))}d.exact!==void 0&&typeof d.exact!="number"?(a.mandatory=a.mandatory||{},a.mandatory[l("",c)]=d.exact):["min","max"].forEach(u=>{d[u]!==void 0&&(a.mandatory=a.mandatory||{},a.mandatory[l(u,c)]=d[u])})}),s.advanced&&(a.optional=(a.optional||[]).concat(s.advanced)),a},r=function(s,a){if(e.version>=61)return a(s);if((s=JSON.parse(JSON.stringify(s)))&&typeof s.audio=="object"){let c=function(d,l,u){l in d&&!(u in d)&&(d[u]=d[l],delete d[l])};c((s=JSON.parse(JSON.stringify(s))).audio,"autoGainControl","googAutoGainControl"),c(s.audio,"noiseSuppression","googNoiseSuppression"),s.audio=n(s.audio)}if(s&&typeof s.video=="object"){let c=s.video.facingMode;c=c&&(typeof c=="object"?c:{ideal:c});let d=e.version<66;if(c&&(c.exact==="user"||c.exact==="environment"||c.ideal==="user"||c.ideal==="environment")&&(!i.mediaDevices.getSupportedConstraints||!i.mediaDevices.getSupportedConstraints().facingMode||d)){let l;if(delete s.video.facingMode,c.exact==="environment"||c.ideal==="environment"?l=["back","rear"]:c.exact!=="user"&&c.ideal!=="user"||(l=["front"]),l)return i.mediaDevices.enumerateDevices().then(u=>{let h=(u=u.filter(p=>p.kind==="videoinput")).find(p=>l.some(g=>{var E;return z(E=p.label.toLowerCase()).call(E,g)}));return!h&&u.length&&z(l).call(l,"back")&&(h=u[u.length-1]),h&&(s.video.deviceId=c.exact?{exact:h.deviceId}:{ideal:h.deviceId}),s.video=n(s.video),pC("chrome: "+JSON.stringify(s)),a(s)})}s.video=n(s.video)}return pC("chrome: "+JSON.stringify(s)),a(s)},o=function(s){return e.version>=64?s:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[s.name]||s.name,message:s.message,constraint:s.constraint||s.constraintName,toString(){return this.name+(this.message&&": ")+this.message}}};if(i.getUserMedia=(function(s,a,c){r(s,d=>{i.webkitGetUserMedia(d,a,l=>{c&&c(o(l))})})}).bind(i),i.mediaDevices.getUserMedia){let s=i.mediaDevices.getUserMedia.bind(i.mediaDevices);i.mediaDevices.getUserMedia=function(a){return r(a,c=>s(c).then(d=>{if(c.audio&&!d.getAudioTracks().length||c.video&&!d.getVideoTracks().length)throw d.getTracks().forEach(l=>{l.stop()}),new DOMException("","NotFoundError");return d},d=>Q.reject(o(d))))}}}function mC(t){t.MediaStream=t.MediaStream||t.webkitMediaStream}function EC(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("ontrack"in t.RTCPeerConnection.prototype)){Object.defineProperty(t.RTCPeerConnection.prototype,"ontrack",{get(){return this._ontrack},set(i){this._ontrack&&this.removeEventListener("track",this._ontrack),this.addEventListener("track",this._ontrack=i)},enumerable:!0,configurable:!0});let e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){return this._ontrackpoly||(this._ontrackpoly=i=>{i.stream.addEventListener("addtrack",n=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===n.track.id):{track:n.track};let o=new Event("track");o.track=n.track,o.receiver=r,o.transceiver={receiver:r},o.streams=[i.stream],this.dispatchEvent(o)}),i.stream.getTracks().forEach(n=>{let r;r=t.RTCPeerConnection.prototype.getReceivers?this.getReceivers().find(s=>s.track&&s.track.id===n.id):{track:n};let o=new Event("track");o.track=n,o.receiver=r,o.transceiver={receiver:r},o.streams=[i.stream],this.dispatchEvent(o)})},this.addEventListener("addstream",this._ontrackpoly)),e.apply(this,arguments)}}else _s(t,"track",e=>(e.transceiver||Object.defineProperty(e,"transceiver",{value:{receiver:e.receiver}}),e))}function fC(t){if(typeof t=="object"&&t.RTCPeerConnection&&!("getSenders"in t.RTCPeerConnection.prototype)&&"createDTMFSender"in t.RTCPeerConnection.prototype){let e=function(r,o){return{track:o,get dtmf(){return this._dtmf===void 0&&(o.kind==="audio"?this._dtmf=r.createDTMFSender(o):this._dtmf=null),this._dtmf},_pc:r}};if(!t.RTCPeerConnection.prototype.getSenders){t.RTCPeerConnection.prototype.getSenders=function(){return this._senders=this._senders||[],this._senders.slice()};let r=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(s,a){let c=r.apply(this,arguments);return c||(c=e(this,s),this._senders.push(c)),c};let o=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(s){o.apply(this,arguments);let a=this._senders.indexOf(s);a!==-1&&this._senders.splice(a,1)}}let i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(r){this._senders=this._senders||[],i.apply(this,[r]),r.getTracks().forEach(o=>{this._senders.push(e(this,o))})};let n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(r){this._senders=this._senders||[],n.apply(this,[r]),r.getTracks().forEach(o=>{let s=this._senders.find(a=>a.track===o);s&&this._senders.splice(this._senders.indexOf(s),1)})}}else if(typeof t=="object"&&t.RTCPeerConnection&&"getSenders"in t.RTCPeerConnection.prototype&&"createDTMFSender"in t.RTCPeerConnection.prototype&&t.RTCRtpSender&&!("dtmf"in t.RTCRtpSender.prototype)){let e=t.RTCPeerConnection.prototype.getSenders;t.RTCPeerConnection.prototype.getSenders=function(){let i=e.apply(this,[]);return i.forEach(n=>n._pc=this),i},Object.defineProperty(t.RTCRtpSender.prototype,"dtmf",{get(){return this._dtmf===void 0&&(this.track.kind==="audio"?this._dtmf=this._pc.createDTMFSender(this.track):this._dtmf=null),this._dtmf}})}}function gC(t){if(!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){let[i,n,r]=arguments;if(arguments.length>0&&typeof i=="function")return e.apply(this,arguments);if(e.length===0&&(arguments.length===0||typeof i!="function"))return e.apply(this,[]);let o=function(a){let c={};return a.result().forEach(d=>{let l={id:d.id,timestamp:d.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[d.type]||d.type};d.names().forEach(u=>{l[u]=d.stat(u)}),c[l.id]=l}),c},s=function(a){return new Map(Object.keys(a).map(c=>[c,a[c]]))};if(arguments.length>=2){let a=function(c){n(s(o(c)))};return e.apply(this,[a,i])}return new Q((a,c)=>{e.apply(this,[function(d){a(s(o(d)))},c])}).then(n,r)}}function SC(t){if(!(typeof t=="object"&&t.RTCPeerConnection&&t.RTCRtpSender&&t.RTCRtpReceiver))return;if(!("getStats"in t.RTCRtpSender.prototype)){let i=t.RTCPeerConnection.prototype.getSenders;i&&(t.RTCPeerConnection.prototype.getSenders=function(){let r=i.apply(this,[]);return r.forEach(o=>o._pc=this),r});let n=t.RTCPeerConnection.prototype.addTrack;n&&(t.RTCPeerConnection.prototype.addTrack=function(){let r=n.apply(this,arguments);return r._pc=this,r}),t.RTCRtpSender.prototype.getStats=function(){let r=this;return this._pc.getStats().then(o=>hC(o,r.track,!0))}}if(!("getStats"in t.RTCRtpReceiver.prototype)){let i=t.RTCPeerConnection.prototype.getReceivers;i&&(t.RTCPeerConnection.prototype.getReceivers=function(){let n=i.apply(this,[]);return n.forEach(r=>r._pc=this),n}),_s(t,"track",n=>(n.receiver._pc=n.srcElement,n)),t.RTCRtpReceiver.prototype.getStats=function(){let n=this;return this._pc.getStats().then(r=>hC(r,n.track,!1))}}if(!("getStats"in t.RTCRtpSender.prototype)||!("getStats"in t.RTCRtpReceiver.prototype))return;let e=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){if(arguments.length>0&&arguments[0]instanceof t.MediaStreamTrack){let i=arguments[0],n,r,o;return this.getSenders().forEach(s=>{s.track===i&&(n?o=!0:n=s)}),this.getReceivers().forEach(s=>(s.track===i&&(r?o=!0:r=s),s.track===i)),o||n&&r?Q.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):n?n.getStats():r?r.getStats():Q.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return e.apply(this,arguments)}}function TC(t){t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},Object.keys(this._shimmedLocalStreams).map(o=>this._shimmedLocalStreams[o][0])};let e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addTrack=function(o,s){if(!s)return e.apply(this,arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};let a=e.apply(this,arguments);return this._shimmedLocalStreams[s.id]?this._shimmedLocalStreams[s.id].indexOf(a)===-1&&this._shimmedLocalStreams[s.id].push(a):this._shimmedLocalStreams[s.id]=[s,a],a};let i=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(o){this._shimmedLocalStreams=this._shimmedLocalStreams||{},o.getTracks().forEach(c=>{if(this.getSenders().find(l=>l.track===c))throw new DOMException("Track already exists.","InvalidAccessError")});let s=this.getSenders();i.apply(this,arguments);let a=this.getSenders().filter(c=>s.indexOf(c)===-1);this._shimmedLocalStreams[o.id]=[o].concat(a)};let n=t.RTCPeerConnection.prototype.removeStream;t.RTCPeerConnection.prototype.removeStream=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},delete this._shimmedLocalStreams[o.id],n.apply(this,arguments)};let r=t.RTCPeerConnection.prototype.removeTrack;t.RTCPeerConnection.prototype.removeTrack=function(o){return this._shimmedLocalStreams=this._shimmedLocalStreams||{},o&&Object.keys(this._shimmedLocalStreams).forEach(s=>{let a=this._shimmedLocalStreams[s].indexOf(o);a!==-1&&this._shimmedLocalStreams[s].splice(a,1),this._shimmedLocalStreams[s].length===1&&delete this._shimmedLocalStreams[s]}),r.apply(this,arguments)}}function RC(t,e){if(!t.RTCPeerConnection)return;if(t.RTCPeerConnection.prototype.addTrack&&e.version>=65)return TC(t);let i=t.RTCPeerConnection.prototype.getLocalStreams;t.RTCPeerConnection.prototype.getLocalStreams=function(){let c=i.apply(this);return this._reverseStreams=this._reverseStreams||{},c.map(d=>this._reverseStreams[d.id])};let n=t.RTCPeerConnection.prototype.addStream;t.RTCPeerConnection.prototype.addStream=function(c){if(this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},c.getTracks().forEach(d=>{if(this.getSenders().find(u=>u.track===d))throw new DOMException("Track already exists.","InvalidAccessError")}),!this._reverseStreams[c.id]){let d=new t.MediaStream(c.getTracks());this._streams[c.id]=d,this._reverseStreams[d.id]=c,c=d}n.apply(this,[c])};let r=t.RTCPeerConnection.prototype.removeStream;function o(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(u=>{let h=c._reverseStreams[u],p=c._streams[h.id];l=l.replace(new RegExp(p.id,"g"),h.id)}),new RTCSessionDescription({type:d.type,sdp:l})}t.RTCPeerConnection.prototype.removeStream=function(c){this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{},r.apply(this,[this._streams[c.id]||c]),delete this._reverseStreams[this._streams[c.id]?this._streams[c.id].id:c.id],delete this._streams[c.id]},t.RTCPeerConnection.prototype.addTrack=function(c,d){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");let l=[].slice.call(arguments,1);if(l.length!==1||!l[0].getTracks().find(p=>p===c))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(p=>p.track===c))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{},this._reverseStreams=this._reverseStreams||{};let h=this._streams[d.id];if(h)h.addTrack(c),Q.resolve().then(()=>{this.dispatchEvent(new Event("negotiationneeded"))});else{let p=new t.MediaStream([c]);this._streams[d.id]=p,this._reverseStreams[p.id]=d,this.addStream(p)}return this.getSenders().find(p=>p.track===c)},["createOffer","createAnswer"].forEach(function(c){let d=t.RTCPeerConnection.prototype[c],l={[c](){let u=arguments;return arguments.length&&typeof arguments[0]=="function"?d.apply(this,[h=>{let p=o(this,h);u[0].apply(null,[p])},h=>{u[1]&&u[1].apply(null,h)},arguments[2]]):d.apply(this,arguments).then(h=>o(this,h))}};t.RTCPeerConnection.prototype[c]=l[c]});let s=t.RTCPeerConnection.prototype.setLocalDescription;t.RTCPeerConnection.prototype.setLocalDescription=function(){return arguments.length&&arguments[0].type?(arguments[0]=function(c,d){let l=d.sdp;return Object.keys(c._reverseStreams||[]).forEach(u=>{let h=c._reverseStreams[u],p=c._streams[h.id];l=l.replace(new RegExp(h.id,"g"),p.id)}),new RTCSessionDescription({type:d.type,sdp:l})}(this,arguments[0]),s.apply(this,arguments)):s.apply(this,arguments)};let a=Object.getOwnPropertyDescriptor(t.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(t.RTCPeerConnection.prototype,"localDescription",{get(){let c=a.get.apply(this);return c.type===""?c:o(this,c)}}),t.RTCPeerConnection.prototype.removeTrack=function(c){if(this.signalingState==="closed")throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!c._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.","TypeError");if(c._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");let d;this._streams=this._streams||{},Object.keys(this._streams).forEach(l=>{this._streams[l].getTracks().find(u=>c.track===u)&&(d=this._streams[l])}),d&&(d.getTracks().length===1?this.removeStream(this._reverseStreams[d.id]):d.removeTrack(c.track),this.dispatchEvent(new Event("negotiationneeded")))}}function _E(t,e){!t.RTCPeerConnection&&t.webkitRTCPeerConnection&&(t.RTCPeerConnection=t.webkitRTCPeerConnection),t.RTCPeerConnection&&e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(i){let n=t.RTCPeerConnection.prototype[i],r={[i](){return arguments[0]=new(i==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),n.apply(this,arguments)}};t.RTCPeerConnection.prototype[i]=r[i]})}function vC(t,e){_s(t,"negotiationneeded",i=>{let n=i.target;if(!(e.version<72||n.getConfiguration&&n.getConfiguration().sdpSemantics==="plan-b")||n.signalingState==="stable")return i})}var yC=Object.freeze({__proto__:null,fixNegotiationNeeded:vC,shimAddTrackRemoveTrack:RC,shimAddTrackRemoveTrackWithNative:TC,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(typeof e=="function"?t.navigator.mediaDevices.getDisplayMedia=function(i){return e(i).then(n=>{let r=i.video&&i.video.width,o=i.video&&i.video.height,s=i.video&&i.video.frameRate;return i.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:n,maxFrameRate:s||3}},r&&(i.video.mandatory.maxWidth=r),o&&(i.video.mandatory.maxHeight=o),t.navigator.mediaDevices.getUserMedia(i)})}:console.error("shimGetDisplayMedia: getSourceId argument is not a function"))},shimGetSendersWithDtmf:fC,shimGetStats:gC,shimGetUserMedia:_C,shimMediaStream:mC,shimOnTrack:EC,shimPeerConnection:_E,shimSenderReceiverGetStats:SC});function CC(t,e){let i=t&&t.navigator,n=t&&t.MediaStreamTrack;if(i.getUserMedia=function(r,o,s){hE("navigator.getUserMedia","navigator.mediaDevices.getUserMedia"),i.mediaDevices.getUserMedia(r).then(o,s)},!(e.version>55&&"autoGainControl"in i.mediaDevices.getSupportedConstraints())){let r=function(s,a,c){a in s&&!(c in s)&&(s[c]=s[a],delete s[a])},o=i.mediaDevices.getUserMedia.bind(i.mediaDevices);if(i.mediaDevices.getUserMedia=function(s){return typeof s=="object"&&typeof s.audio=="object"&&(s=JSON.parse(JSON.stringify(s)),r(s.audio,"autoGainControl","mozAutoGainControl"),r(s.audio,"noiseSuppression","mozNoiseSuppression")),o(s)},n&&n.prototype.getSettings){let s=n.prototype.getSettings;n.prototype.getSettings=function(){let a=s.apply(this,arguments);return r(a,"mozAutoGainControl","autoGainControl"),r(a,"mozNoiseSuppression","noiseSuppression"),a}}if(n&&n.prototype.applyConstraints){let s=n.prototype.applyConstraints;n.prototype.applyConstraints=function(a){return this.kind==="audio"&&typeof a=="object"&&(a=JSON.parse(JSON.stringify(a)),r(a,"autoGainControl","mozAutoGainControl"),r(a,"noiseSuppression","mozNoiseSuppression")),s.apply(this,[a])}}}}function bC(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function mE(t,e){if(typeof t!="object"||!t.RTCPeerConnection&&!t.mozRTCPeerConnection)return;!t.RTCPeerConnection&&t.mozRTCPeerConnection&&(t.RTCPeerConnection=t.mozRTCPeerConnection),e.version<53&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(r){let o=t.RTCPeerConnection.prototype[r],s={[r](){return arguments[0]=new(r==="addIceCandidate"?t.RTCIceCandidate:t.RTCSessionDescription)(arguments[0]),o.apply(this,arguments)}};t.RTCPeerConnection.prototype[r]=s[r]});let i={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"},n=t.RTCPeerConnection.prototype.getStats;t.RTCPeerConnection.prototype.getStats=function(){let[r,o,s]=arguments;return n.apply(this,[r||null]).then(a=>{if(e.version<53&&!o)try{a.forEach(c=>{c.type=i[c.type]||c.type})}catch(c){if(c.name!=="TypeError")throw c;a.forEach((d,l)=>{a.set(l,Object.assign({},d,{type:i[d.type]||d.type}))})}return a}).then(o,s)}}function IC(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpSender.prototype)return;let e=t.RTCPeerConnection.prototype.getSenders;e&&(t.RTCPeerConnection.prototype.getSenders=function(){let n=e.apply(this,[]);return n.forEach(r=>r._pc=this),n});let i=t.RTCPeerConnection.prototype.addTrack;i&&(t.RTCPeerConnection.prototype.addTrack=function(){let n=i.apply(this,arguments);return n._pc=this,n}),t.RTCRtpSender.prototype.getStats=function(){return this.track?this._pc.getStats(this.track):Q.resolve(new Map)}}function AC(t){if(typeof t!="object"||!t.RTCPeerConnection||!t.RTCRtpSender||t.RTCRtpSender&&"getStats"in t.RTCRtpReceiver.prototype)return;let e=t.RTCPeerConnection.prototype.getReceivers;e&&(t.RTCPeerConnection.prototype.getReceivers=function(){let i=e.apply(this,[]);return i.forEach(n=>n._pc=this),i}),_s(t,"track",i=>(i.receiver._pc=i.srcElement,i)),t.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}function wC(t){t.RTCPeerConnection&&!("removeStream"in t.RTCPeerConnection.prototype)&&(t.RTCPeerConnection.prototype.removeStream=function(e){hE("removeStream","removeTrack"),this.getSenders().forEach(i=>{var n;i.track&&z(n=e.getTracks()).call(n,i.track)&&this.removeTrack(i)})})}function OC(t){t.DataChannel&&!t.RTCDataChannel&&(t.RTCDataChannel=t.DataChannel)}function NC(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.addTransceiver;e&&(t.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];let i=arguments[1]&&arguments[1].sendEncodings;i===void 0&&(i=[]),i=[...i];let n=i.length>0;n&&i.forEach(o=>{if("rid"in o&&!/^[a-z0-9]{0,16}$/i.test(o.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in o&&!(parseFloat(o.scaleResolutionDownBy)>=1))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in o&&!(parseFloat(o.maxFramerate)>=0))throw new RangeError("max_framerate must be >= 0.0")});let r=e.apply(this,arguments);if(n){let{sender:o}=r,s=o.getParameters();(!("encodings"in s)||s.encodings.length===1&&Object.keys(s.encodings[0]).length===0)&&(s.encodings=i,o.sendEncodings=i,this.setParametersPromises.push(o.setParameters(s).then(()=>{delete o.sendEncodings}).catch(()=>{delete o.sendEncodings})))}return r})}function DC(t){if(typeof t!="object"||!t.RTCRtpSender)return;let e=t.RTCRtpSender.prototype.getParameters;e&&(t.RTCRtpSender.prototype.getParameters=function(){let i=e.apply(this,arguments);return"encodings"in i||(i.encodings=[].concat(this.sendEncodings||[{}])),i})}function PC(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Q.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}function LC(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype.createAnswer;t.RTCPeerConnection.prototype.createAnswer=function(){return this.setParametersPromises&&this.setParametersPromises.length?Q.all(this.setParametersPromises).then(()=>e.apply(this,arguments)).finally(()=>{this.setParametersPromises=[]}):e.apply(this,arguments)}}var kC=Object.freeze({__proto__:null,shimAddTransceiver:NC,shimCreateAnswer:LC,shimCreateOffer:PC,shimGetDisplayMedia:function(t,e){t.navigator.mediaDevices&&"getDisplayMedia"in t.navigator.mediaDevices||t.navigator.mediaDevices&&(t.navigator.mediaDevices.getDisplayMedia=function(i){if(!i||!i.video){let n=new DOMException("getDisplayMedia without video constraints is undefined");return n.name="NotFoundError",n.code=8,Q.reject(n)}return i.video===!0?i.video={mediaSource:e}:i.video.mediaSource=e,t.navigator.mediaDevices.getUserMedia(i)})},shimGetParameters:DC,shimGetUserMedia:CC,shimOnTrack:bC,shimPeerConnection:mE,shimRTCDataChannel:OC,shimReceiverGetStats:AC,shimRemoveStream:wC,shimSenderGetStats:IC});function MC(t){if(typeof t=="object"&&t.RTCPeerConnection){if("getLocalStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getLocalStreams=function(){return this._localStreams||(this._localStreams=[]),this._localStreams}),!("addStream"in t.RTCPeerConnection.prototype)){let e=t.RTCPeerConnection.prototype.addTrack;t.RTCPeerConnection.prototype.addStream=function(i){var n;this._localStreams||(this._localStreams=[]),z(n=this._localStreams).call(n,i)||this._localStreams.push(i),i.getAudioTracks().forEach(r=>e.call(this,r,i)),i.getVideoTracks().forEach(r=>e.call(this,r,i))},t.RTCPeerConnection.prototype.addTrack=function(i){for(var n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return r&&r.forEach(s=>{var a;this._localStreams?z(a=this._localStreams).call(a,s)||this._localStreams.push(s):this._localStreams=[s]}),e.apply(this,arguments)}}"removeStream"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.removeStream=function(e){this._localStreams||(this._localStreams=[]);let i=this._localStreams.indexOf(e);if(i===-1)return;this._localStreams.splice(i,1);let n=e.getTracks();this.getSenders().forEach(r=>{z(n).call(n,r.track)&&this.removeTrack(r)})})}}function UC(t){if(typeof t=="object"&&t.RTCPeerConnection&&("getRemoteStreams"in t.RTCPeerConnection.prototype||(t.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?this._remoteStreams:[]}),!("onaddstream"in t.RTCPeerConnection.prototype))){Object.defineProperty(t.RTCPeerConnection.prototype,"onaddstream",{get(){return this._onaddstream},set(i){this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly)),this.addEventListener("addstream",this._onaddstream=i),this.addEventListener("track",this._onaddstreampoly=n=>{n.streams.forEach(r=>{var o;if(this._remoteStreams||(this._remoteStreams=[]),z(o=this._remoteStreams).call(o,r))return;this._remoteStreams.push(r);let s=new Event("addstream");s.stream=r,this.dispatchEvent(s)})})}});let e=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){let i=this;return this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(n){n.streams.forEach(r=>{if(i._remoteStreams||(i._remoteStreams=[]),i._remoteStreams.indexOf(r)>=0)return;i._remoteStreams.push(r);let o=new Event("addstream");o.stream=r,i.dispatchEvent(o)})}),e.apply(i,arguments)}}}function xC(t){if(typeof t!="object"||!t.RTCPeerConnection)return;let e=t.RTCPeerConnection.prototype,i=e.createOffer,n=e.createAnswer,r=e.setLocalDescription,o=e.setRemoteDescription,s=e.addIceCandidate;e.createOffer=function(c,d){let l=arguments.length>=2?arguments[2]:arguments[0],u=i.apply(this,[l]);return d?(u.then(c,d),Q.resolve()):u},e.createAnswer=function(c,d){let l=arguments.length>=2?arguments[2]:arguments[0],u=n.apply(this,[l]);return d?(u.then(c,d),Q.resolve()):u};let a=function(c,d,l){let u=r.apply(this,[c]);return l?(u.then(d,l),Q.resolve()):u};e.setLocalDescription=a,a=function(c,d,l){let u=o.apply(this,[c]);return l?(u.then(d,l),Q.resolve()):u},e.setRemoteDescription=a,a=function(c,d,l){let u=s.apply(this,[c]);return l?(u.then(d,l),Q.resolve()):u},e.addIceCandidate=a}function VC(t){let e=t&&t.navigator;if(e.mediaDevices&&e.mediaDevices.getUserMedia){let i=e.mediaDevices,n=i.getUserMedia.bind(i);e.mediaDevices.getUserMedia=r=>n(FC(r))}!e.getUserMedia&&e.mediaDevices&&e.mediaDevices.getUserMedia&&(e.getUserMedia=(function(i,n,r){e.mediaDevices.getUserMedia(i).then(n,r)}).bind(e))}function FC(t){return t&&t.video!==void 0?Object.assign({},t,{video:uC(t.video)}):t}function BC(t){if(!t.RTCPeerConnection)return;let e=t.RTCPeerConnection;t.RTCPeerConnection=function(i,n){if(i&&i.iceServers){let r=[];for(let o=0;o<i.iceServers.length;o++){let s=i.iceServers[o];!s.hasOwnProperty("urls")&&s.hasOwnProperty("url")?(hE("RTCIceServer.url","RTCIceServer.urls"),s=JSON.parse(JSON.stringify(s)),s.urls=s.url,delete s.url,r.push(s)):r.push(i.iceServers[o])}i.iceServers=r}return new e(i,n)},t.RTCPeerConnection.prototype=e.prototype,"generateCertificate"in e&&Object.defineProperty(t.RTCPeerConnection,"generateCertificate",{get:()=>e.generateCertificate})}function jC(t){typeof t=="object"&&t.RTCTrackEvent&&"receiver"in t.RTCTrackEvent.prototype&&!("transceiver"in t.RTCTrackEvent.prototype)&&Object.defineProperty(t.RTCTrackEvent.prototype,"transceiver",{get(){return{receiver:this.receiver}}})}function GC(t){let e=t.RTCPeerConnection.prototype.createOffer;t.RTCPeerConnection.prototype.createOffer=function(i){if(i){i.offerToReceiveAudio!==void 0&&(i.offerToReceiveAudio=!!i.offerToReceiveAudio);let n=this.getTransceivers().find(o=>o.receiver.track.kind==="audio");i.offerToReceiveAudio===!1&&n?n.direction==="sendrecv"?n.setDirection?n.setDirection("sendonly"):n.direction="sendonly":n.direction==="recvonly"&&(n.setDirection?n.setDirection("inactive"):n.direction="inactive"):i.offerToReceiveAudio!==!0||n||this.addTransceiver("audio",{direction:"recvonly"}),i.offerToReceiveVideo!==void 0&&(i.offerToReceiveVideo=!!i.offerToReceiveVideo);let r=this.getTransceivers().find(o=>o.receiver.track.kind==="video");i.offerToReceiveVideo===!1&&r?r.direction==="sendrecv"?r.setDirection?r.setDirection("sendonly"):r.direction="sendonly":r.direction==="recvonly"&&(r.setDirection?r.setDirection("inactive"):r.direction="inactive"):i.offerToReceiveVideo!==!0||r||this.addTransceiver("video",{direction:"recvonly"})}return e.apply(this,arguments)}}function WC(t){typeof t!="object"||t.AudioContext||(t.AudioContext=t.webkitAudioContext)}var HC=Object.freeze({__proto__:null,shimAudioContext:WC,shimCallbacksAPI:xC,shimConstraints:FC,shimCreateOfferLegacy:GC,shimGetUserMedia:VC,shimLocalStreamsAPI:MC,shimRTCIceServerUrls:BC,shimRemoteStreamsAPI:UC,shimTrackEventTransceiver:jC}),KC=`	
\v\f\r \xA0\u1680\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200A\u202F\u205F\u3000\u2028\u2029\uFEFF`,b3=ns,I3=Yi,EE=KC,qC=mt("".replace),A3=RegExp("^["+EE+"]+"),w3=RegExp("(^|[^"+EE+"])["+EE+"]+$"),fE=function(t){return function(e){var i=I3(b3(e));return 1&t&&(i=qC(i,A3,"")),2&t&&(i=qC(i,w3,"$1")),i}},O3={start:fE(1),end:fE(2),trim:fE(3)},N3=wR.PROPER,D3=O,YC=KC,P3=O3.trim;Ht({target:"String",proto:!0,forced:function(t){return D3(function(){return!!YC[t]()||"\u200B\x85\u180E"[t]()!=="\u200B\x85\u180E"||N3&&YC[t].name!==t})}("trim")},{trim:function(){return P3(this)}});var L3=Cn("String","trim"),k3=Wt,M3=L3,gE=String.prototype,U3=function(t){var e=t.trim;return typeof t=="string"||t===gE||k3(gE,t)&&e===gE.trim?M3:e},ui=b(U3),zC={exports:{}};(function(t){let e={generateIdentifier:function(){return Math.random().toString(36).substring(2,12)}};e.localCName=e.generateIdentifier(),e.splitLines=function(i){return i.trim().split(`
`).map(n=>n.trim())},e.splitSections=function(i){return i.split(`
m=`).map((n,r)=>(r>0?"m="+n:n).trim()+`\r
`)},e.getDescription=function(i){let n=e.splitSections(i);return n&&n[0]},e.getMediaSections=function(i){let n=e.splitSections(i);return n.shift(),n},e.matchPrefix=function(i,n){return e.splitLines(i).filter(r=>r.indexOf(n)===0)},e.parseCandidate=function(i){let n;n=i.indexOf("a=candidate:")===0?i.substring(12).split(" "):i.substring(10).split(" ");let r={foundation:n[0],component:{1:"rtp",2:"rtcp"}[n[1]]||n[1],protocol:n[2].toLowerCase(),priority:parseInt(n[3],10),ip:n[4],address:n[4],port:parseInt(n[5],10),type:n[7]};for(let o=8;o<n.length;o+=2)switch(n[o]){case"raddr":r.relatedAddress=n[o+1];break;case"rport":r.relatedPort=parseInt(n[o+1],10);break;case"tcptype":r.tcpType=n[o+1];break;case"ufrag":r.ufrag=n[o+1],r.usernameFragment=n[o+1];break;default:r[n[o]]===void 0&&(r[n[o]]=n[o+1])}return r},e.writeCandidate=function(i){let n=[];n.push(i.foundation);let r=i.component;r==="rtp"?n.push(1):r==="rtcp"?n.push(2):n.push(r),n.push(i.protocol.toUpperCase()),n.push(i.priority),n.push(i.address||i.ip),n.push(i.port);let o=i.type;return n.push("typ"),n.push(o),o!=="host"&&i.relatedAddress&&i.relatedPort&&(n.push("raddr"),n.push(i.relatedAddress),n.push("rport"),n.push(i.relatedPort)),i.tcpType&&i.protocol.toLowerCase()==="tcp"&&(n.push("tcptype"),n.push(i.tcpType)),(i.usernameFragment||i.ufrag)&&(n.push("ufrag"),n.push(i.usernameFragment||i.ufrag)),"candidate:"+n.join(" ")},e.parseIceOptions=function(i){return i.substring(14).split(" ")},e.parseRtpMap=function(i){let n=i.substring(9).split(" "),r={payloadType:parseInt(n.shift(),10)};return n=n[0].split("/"),r.name=n[0],r.clockRate=parseInt(n[1],10),r.channels=n.length===3?parseInt(n[2],10):1,r.numChannels=r.channels,r},e.writeRtpMap=function(i){let n=i.payloadType;i.preferredPayloadType!==void 0&&(n=i.preferredPayloadType);let r=i.channels||i.numChannels||1;return"a=rtpmap:"+n+" "+i.name+"/"+i.clockRate+(r!==1?"/"+r:"")+`\r
`},e.parseExtmap=function(i){let n=i.substring(9).split(" ");return{id:parseInt(n[0],10),direction:n[0].indexOf("/")>0?n[0].split("/")[1]:"sendrecv",uri:n[1],attributes:n.slice(2).join(" ")}},e.writeExtmap=function(i){return"a=extmap:"+(i.id||i.preferredId)+(i.direction&&i.direction!=="sendrecv"?"/"+i.direction:"")+" "+i.uri+(i.attributes?" "+i.attributes:"")+`\r
`},e.parseFmtp=function(i){let n={},r,o=i.substring(i.indexOf(" ")+1).split(";");for(let s=0;s<o.length;s++)r=o[s].trim().split("="),n[r[0].trim()]=r[1];return n},e.writeFmtp=function(i){let n="",r=i.payloadType;if(i.preferredPayloadType!==void 0&&(r=i.preferredPayloadType),i.parameters&&Object.keys(i.parameters).length){let o=[];Object.keys(i.parameters).forEach(s=>{i.parameters[s]!==void 0?o.push(s+"="+i.parameters[s]):o.push(s)}),n+="a=fmtp:"+r+" "+o.join(";")+`\r
`}return n},e.parseRtcpFb=function(i){let n=i.substring(i.indexOf(" ")+1).split(" ");return{type:n.shift(),parameter:n.join(" ")}},e.writeRtcpFb=function(i){let n="",r=i.payloadType;return i.preferredPayloadType!==void 0&&(r=i.preferredPayloadType),i.rtcpFeedback&&i.rtcpFeedback.length&&i.rtcpFeedback.forEach(o=>{n+="a=rtcp-fb:"+r+" "+o.type+(o.parameter&&o.parameter.length?" "+o.parameter:"")+`\r
`}),n},e.parseSsrcMedia=function(i){let n=i.indexOf(" "),r={ssrc:parseInt(i.substring(7,n),10)},o=i.indexOf(":",n);return o>-1?(r.attribute=i.substring(n+1,o),r.value=i.substring(o+1)):r.attribute=i.substring(n+1),r},e.parseSsrcGroup=function(i){let n=i.substring(13).split(" ");return{semantics:n.shift(),ssrcs:n.map(r=>parseInt(r,10))}},e.getMid=function(i){let n=e.matchPrefix(i,"a=mid:")[0];if(n)return n.substring(6)},e.parseFingerprint=function(i){let n=i.substring(14).split(" ");return{algorithm:n[0].toLowerCase(),value:n[1].toUpperCase()}},e.getDtlsParameters=function(i,n){return{role:"auto",fingerprints:e.matchPrefix(i+n,"a=fingerprint:").map(e.parseFingerprint)}},e.writeDtlsParameters=function(i,n){let r="a=setup:"+n+`\r
`;return i.fingerprints.forEach(o=>{r+="a=fingerprint:"+o.algorithm+" "+o.value+`\r
`}),r},e.parseCryptoLine=function(i){let n=i.substring(9).split(" ");return{tag:parseInt(n[0],10),cryptoSuite:n[1],keyParams:n[2],sessionParams:n.slice(3)}},e.writeCryptoLine=function(i){return"a=crypto:"+i.tag+" "+i.cryptoSuite+" "+(typeof i.keyParams=="object"?e.writeCryptoKeyParams(i.keyParams):i.keyParams)+(i.sessionParams?" "+i.sessionParams.join(" "):"")+`\r
`},e.parseCryptoKeyParams=function(i){if(i.indexOf("inline:")!==0)return null;let n=i.substring(7).split("|");return{keyMethod:"inline",keySalt:n[0],lifeTime:n[1],mkiValue:n[2]?n[2].split(":")[0]:void 0,mkiLength:n[2]?n[2].split(":")[1]:void 0}},e.writeCryptoKeyParams=function(i){return i.keyMethod+":"+i.keySalt+(i.lifeTime?"|"+i.lifeTime:"")+(i.mkiValue&&i.mkiLength?"|"+i.mkiValue+":"+i.mkiLength:"")},e.getCryptoParameters=function(i,n){return e.matchPrefix(i+n,"a=crypto:").map(e.parseCryptoLine)},e.getIceParameters=function(i,n){let r=e.matchPrefix(i+n,"a=ice-ufrag:")[0],o=e.matchPrefix(i+n,"a=ice-pwd:")[0];return r&&o?{usernameFragment:r.substring(12),password:o.substring(10)}:null},e.writeIceParameters=function(i){let n="a=ice-ufrag:"+i.usernameFragment+`\r
a=ice-pwd:`+i.password+`\r
`;return i.iceLite&&(n+=`a=ice-lite\r
`),n},e.parseRtpParameters=function(i){let n={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},r=e.splitLines(i)[0].split(" ");n.profile=r[2];for(let s=3;s<r.length;s++){let a=r[s],c=e.matchPrefix(i,"a=rtpmap:"+a+" ")[0];if(c){let d=e.parseRtpMap(c),l=e.matchPrefix(i,"a=fmtp:"+a+" ");switch(d.parameters=l.length?e.parseFmtp(l[0]):{},d.rtcpFeedback=e.matchPrefix(i,"a=rtcp-fb:"+a+" ").map(e.parseRtcpFb),n.codecs.push(d),d.name.toUpperCase()){case"RED":case"ULPFEC":n.fecMechanisms.push(d.name.toUpperCase())}}}e.matchPrefix(i,"a=extmap:").forEach(s=>{n.headerExtensions.push(e.parseExtmap(s))});let o=e.matchPrefix(i,"a=rtcp-fb:* ").map(e.parseRtcpFb);return n.codecs.forEach(s=>{o.forEach(a=>{s.rtcpFeedback.find(c=>c.type===a.type&&c.parameter===a.parameter)||s.rtcpFeedback.push(a)})}),n},e.writeRtpDescription=function(i,n){let r="";r+="m="+i+" ",r+=n.codecs.length>0?"9":"0",r+=" "+(n.profile||"UDP/TLS/RTP/SAVPF")+" ",r+=n.codecs.map(s=>s.preferredPayloadType!==void 0?s.preferredPayloadType:s.payloadType).join(" ")+`\r
`,r+=`c=IN IP4 0.0.0.0\r
`,r+=`a=rtcp:9 IN IP4 0.0.0.0\r
`,n.codecs.forEach(s=>{r+=e.writeRtpMap(s),r+=e.writeFmtp(s),r+=e.writeRtcpFb(s)});let o=0;return n.codecs.forEach(s=>{s.maxptime>o&&(o=s.maxptime)}),o>0&&(r+="a=maxptime:"+o+`\r
`),n.headerExtensions&&n.headerExtensions.forEach(s=>{r+=e.writeExtmap(s)}),r},e.parseRtpEncodingParameters=function(i){let n=[],r=e.parseRtpParameters(i),o=r.fecMechanisms.indexOf("RED")!==-1,s=r.fecMechanisms.indexOf("ULPFEC")!==-1,a=e.matchPrefix(i,"a=ssrc:").map(h=>e.parseSsrcMedia(h)).filter(h=>h.attribute==="cname"),c=a.length>0&&a[0].ssrc,d,l=e.matchPrefix(i,"a=ssrc-group:FID").map(h=>h.substring(17).split(" ").map(p=>parseInt(p,10)));l.length>0&&l[0].length>1&&l[0][0]===c&&(d=l[0][1]),r.codecs.forEach(h=>{if(h.name.toUpperCase()==="RTX"&&h.parameters.apt){let p={ssrc:c,codecPayloadType:parseInt(h.parameters.apt,10)};c&&d&&(p.rtx={ssrc:d}),n.push(p),o&&(p=JSON.parse(JSON.stringify(p)),p.fec={ssrc:c,mechanism:s?"red+ulpfec":"red"},n.push(p))}}),n.length===0&&c&&n.push({ssrc:c});let u=e.matchPrefix(i,"b=");return u.length&&(u=u[0].indexOf("b=TIAS:")===0?parseInt(u[0].substring(7),10):u[0].indexOf("b=AS:")===0?1e3*parseInt(u[0].substring(5),10)*.95-16e3:void 0,n.forEach(h=>{h.maxBitrate=u})),n},e.parseRtcpParameters=function(i){let n={},r=e.matchPrefix(i,"a=ssrc:").map(a=>e.parseSsrcMedia(a)).filter(a=>a.attribute==="cname")[0];r&&(n.cname=r.value,n.ssrc=r.ssrc);let o=e.matchPrefix(i,"a=rtcp-rsize");n.reducedSize=o.length>0,n.compound=o.length===0;let s=e.matchPrefix(i,"a=rtcp-mux");return n.mux=s.length>0,n},e.writeRtcpParameters=function(i){let n="";return i.reducedSize&&(n+=`a=rtcp-rsize\r
`),i.mux&&(n+=`a=rtcp-mux\r
`),i.ssrc!==void 0&&i.cname&&(n+="a=ssrc:"+i.ssrc+" cname:"+i.cname+`\r
`),n},e.parseMsid=function(i){let n,r=e.matchPrefix(i,"a=msid:");if(r.length===1)return n=r[0].substring(7).split(" "),{stream:n[0],track:n[1]};let o=e.matchPrefix(i,"a=ssrc:").map(s=>e.parseSsrcMedia(s)).filter(s=>s.attribute==="msid");return o.length>0?(n=o[0].value.split(" "),{stream:n[0],track:n[1]}):void 0},e.parseSctpDescription=function(i){let n=e.parseMLine(i),r=e.matchPrefix(i,"a=max-message-size:"),o;r.length>0&&(o=parseInt(r[0].substring(19),10)),isNaN(o)&&(o=65536);let s=e.matchPrefix(i,"a=sctp-port:");if(s.length>0)return{port:parseInt(s[0].substring(12),10),protocol:n.fmt,maxMessageSize:o};let a=e.matchPrefix(i,"a=sctpmap:");if(a.length>0){let c=a[0].substring(10).split(" ");return{port:parseInt(c[0],10),protocol:c[1],maxMessageSize:o}}},e.writeSctpDescription=function(i,n){let r=[];return r=i.protocol!=="DTLS/SCTP"?["m="+i.kind+" 9 "+i.protocol+" "+n.protocol+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctp-port:"+n.port+`\r
`]:["m="+i.kind+" 9 "+i.protocol+" "+n.port+`\r
`,`c=IN IP4 0.0.0.0\r
`,"a=sctpmap:"+n.port+" "+n.protocol+` 65535\r
`],n.maxMessageSize!==void 0&&r.push("a=max-message-size:"+n.maxMessageSize+`\r
`),r.join("")},e.generateSessionId=function(){return Math.random().toString().substr(2,22)},e.writeSessionBoilerplate=function(i,n,r){let o,s=n!==void 0?n:2;return o=i||e.generateSessionId(),`v=0\r
o=`+(r||"thisisadapterortc")+" "+o+" "+s+` IN IP4 127.0.0.1\r
s=-\r
t=0 0\r
`},e.getDirection=function(i,n){let r=e.splitLines(i);for(let o=0;o<r.length;o++)switch(r[o]){case"a=sendrecv":case"a=sendonly":case"a=recvonly":case"a=inactive":return r[o].substring(2)}return n?e.getDirection(n):"sendrecv"},e.getKind=function(i){return e.splitLines(i)[0].split(" ")[0].substring(2)},e.isRejected=function(i){return i.split(" ",2)[1]==="0"},e.parseMLine=function(i){let n=e.splitLines(i)[0].substring(2).split(" ");return{kind:n[0],port:parseInt(n[1],10),protocol:n[2],fmt:n.slice(3).join(" ")}},e.parseOLine=function(i){let n=e.matchPrefix(i,"o=")[0].substring(2).split(" ");return{username:n[0],sessionId:n[1],sessionVersion:parseInt(n[2],10),netType:n[3],addressType:n[4],address:n[5]}},e.isValidSDP=function(i){if(typeof i!="string"||i.length===0)return!1;let n=e.splitLines(i);for(let r=0;r<n.length;r++)if(n[r].length<2||n[r].charAt(1)!=="=")return!1;return!0},t.exports=e})(zC);var XC=zC.exports,Ca=b(XC),x3=v({__proto__:null,default:Ca},[XC]);function Du(t){if(!t.RTCIceCandidate||t.RTCIceCandidate&&"foundation"in t.RTCIceCandidate.prototype)return;let e=t.RTCIceCandidate;t.RTCIceCandidate=function(i){if(typeof i=="object"&&i.candidate&&i.candidate.indexOf("a=")===0&&((i=JSON.parse(JSON.stringify(i))).candidate=i.candidate.substr(2)),i.candidate&&i.candidate.length){let n=new e(i),r=Ca.parseCandidate(i.candidate),o=Object.assign(n,r);return o.toJSON=function(){return{candidate:o.candidate,sdpMid:o.sdpMid,sdpMLineIndex:o.sdpMLineIndex,usernameFragment:o.usernameFragment}},o}return new e(i)},t.RTCIceCandidate.prototype=e.prototype,_s(t,"icecandidate",i=>(i.candidate&&Object.defineProperty(i,"candidate",{value:new t.RTCIceCandidate(i.candidate),writable:"false"}),i))}function SE(t){!t.RTCIceCandidate||t.RTCIceCandidate&&"relayProtocol"in t.RTCIceCandidate.prototype||_s(t,"icecandidate",e=>{if(e.candidate){let i=Ca.parseCandidate(e.candidate.candidate);i.type==="relay"&&(e.candidate.relayProtocol={0:"tls",1:"tcp",2:"udp"}[i.priority>>24])}return e})}function Pu(t,e){if(!t.RTCPeerConnection)return;"sctp"in t.RTCPeerConnection.prototype||Object.defineProperty(t.RTCPeerConnection.prototype,"sctp",{get(){return this._sctp===void 0?null:this._sctp}});let i=function(a){if(!a||!a.sdp)return!1;let c=Ca.splitSections(a.sdp);return c.shift(),c.some(d=>{let l=Ca.parseMLine(d);return l&&l.kind==="application"&&l.protocol.indexOf("SCTP")!==-1})},n=function(a){let c=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(c===null||c.length<2)return-1;let d=parseInt(c[1],10);return d!=d?-1:d},r=function(a){let c=65536;return e.browser==="firefox"&&(c=e.version<57?a===-1?16384:2147483637:e.version<60?e.version===57?65535:65536:2147483637),c},o=function(a,c){let d=65536;e.browser==="firefox"&&e.version===57&&(d=65535);let l=Ca.matchPrefix(a.sdp,"a=max-message-size:");return l.length>0?d=parseInt(l[0].substr(19),10):e.browser==="firefox"&&c!==-1&&(d=2147483637),d},s=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(){if(this._sctp=null,e.browser==="chrome"&&e.version>=76){let{sdpSemantics:a}=this.getConfiguration();a==="plan-b"&&Object.defineProperty(this,"sctp",{get(){return this._sctp===void 0?null:this._sctp},enumerable:!0,configurable:!0})}if(i(arguments[0])){let a=n(arguments[0]),c=r(a),d=o(arguments[0],a),l;l=c===0&&d===0?Number.POSITIVE_INFINITY:c===0||d===0?Math.max(c,d):Math.min(c,d);let u={};Object.defineProperty(u,"maxMessageSize",{get:()=>l}),this._sctp=u}return s.apply(this,arguments)}}function Lu(t){if(!t.RTCPeerConnection||!("createDataChannel"in t.RTCPeerConnection.prototype))return;function e(n,r){let o=n.send;n.send=function(){let s=arguments[0],a=s.length||s.size||s.byteLength;if(n.readyState==="open"&&r.sctp&&a>r.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+r.sctp.maxMessageSize+" bytes)");return o.apply(n,arguments)}}let i=t.RTCPeerConnection.prototype.createDataChannel;t.RTCPeerConnection.prototype.createDataChannel=function(){let n=i.apply(this,arguments);return e(n,this),n},_s(t,"datachannel",n=>(e(n.channel,n.target),n))}function TE(t){if(!t.RTCPeerConnection||"connectionState"in t.RTCPeerConnection.prototype)return;let e=t.RTCPeerConnection.prototype;Object.defineProperty(e,"connectionState",{get(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0}),Object.defineProperty(e,"onconnectionstatechange",{get(){return this._onconnectionstatechange||null},set(i){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange),i&&this.addEventListener("connectionstatechange",this._onconnectionstatechange=i)},enumerable:!0,configurable:!0}),["setLocalDescription","setRemoteDescription"].forEach(i=>{let n=e[i];e[i]=function(){return this._connectionstatechangepoly||(this._connectionstatechangepoly=r=>{let o=r.target;if(o._lastConnectionState!==o.connectionState){o._lastConnectionState=o.connectionState;let s=new Event("connectionstatechange",r);o.dispatchEvent(s)}return r},this.addEventListener("iceconnectionstatechange",this._connectionstatechangepoly)),n.apply(this,arguments)}})}function RE(t,e){if(!t.RTCPeerConnection||e.browser==="chrome"&&e.version>=71||e.browser==="safari"&&e.version>=605)return;let i=t.RTCPeerConnection.prototype.setRemoteDescription;t.RTCPeerConnection.prototype.setRemoteDescription=function(n){if(n&&n.sdp&&n.sdp.indexOf(`
a=extmap-allow-mixed`)!==-1){let r=n.sdp.split(`
`).filter(o=>ui(o).call(o)!=="a=extmap-allow-mixed").join(`
`);t.RTCSessionDescription&&n instanceof t.RTCSessionDescription?arguments[0]=new t.RTCSessionDescription({type:n.type,sdp:r}):n.sdp=r}return i.apply(this,arguments)}}function ku(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;let i=t.RTCPeerConnection.prototype.addIceCandidate;i&&i.length!==0&&(t.RTCPeerConnection.prototype.addIceCandidate=function(){return arguments[0]?(e.browser==="chrome"&&e.version<78||e.browser==="firefox"&&e.version<68||e.browser==="safari")&&arguments[0]&&arguments[0].candidate===""?Q.resolve():i.apply(this,arguments):(arguments[1]&&arguments[1].apply(null),Q.resolve())})}function Mu(t,e){if(!t.RTCPeerConnection||!t.RTCPeerConnection.prototype)return;let i=t.RTCPeerConnection.prototype.setLocalDescription;i&&i.length!==0&&(t.RTCPeerConnection.prototype.setLocalDescription=function(){let n=arguments[0]||{};if(typeof n!="object"||n.type&&n.sdp)return i.apply(this,arguments);if(n={type:n.type,sdp:n.sdp},!n.type)switch(this.signalingState){case"stable":case"have-local-offer":case"have-remote-pranswer":n.type="offer";break;default:n.type="answer"}return n.sdp||n.type!=="offer"&&n.type!=="answer"?i.apply(this,[n]):(n.type==="offer"?this.createOffer:this.createAnswer).apply(this).then(r=>i.apply(this,[r]))})}var V3=Object.freeze({__proto__:null,removeExtmapAllowMixed:RE,shimAddIceCandidateNullOrEmpty:ku,shimConnectionState:TE,shimMaxMessageSize:Pu,shimParameterlessSetLocalDescription:Mu,shimRTCIceCandidate:Du,shimRTCIceCandidateRelayProtocol:SE,shimSendThrowTypeError:Lu});(function(){let{window:t}=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimSafari:!0},i=dC,n=function(o){let s={browser:null,version:null};if(o===void 0||!o.navigator)return s.browser="Not a browser.",s;let{navigator:a}=o;if(a.mozGetUserMedia)s.browser="firefox",s.version=Nu(a.userAgent,/Firefox\/(\d+)\./,1);else if(a.webkitGetUserMedia||o.isSecureContext===!1&&o.webkitRTCPeerConnection)s.browser="chrome",s.version=Nu(a.userAgent,/Chrom(e|ium)\/(\d+)\./,2);else{if(!o.RTCPeerConnection||!a.userAgent.match(/AppleWebKit\/(\d+)\./))return s.browser="Not a supported browser.",s;s.browser="safari",s.version=Nu(a.userAgent,/AppleWebKit\/(\d+)\./,1),s.supportsUnifiedPlan=o.RTCRtpTransceiver&&"currentDirection"in o.RTCRtpTransceiver.prototype}return s}(t),r={browserDetails:n,commonShim:V3,extractVersion:Nu,disableLog:y3,disableWarnings:C3,sdp:x3};switch(n.browser){case"chrome":if(!yC||!_E||!e.shimChrome)return i("Chrome shim is not included in this adapter release."),r;if(n.version===null)return i("Chrome shim can not determine version, not shimming."),r;i("adapter.js shimming chrome."),r.browserShim=yC,ku(t,n),Mu(t),_C(t,n),mC(t),_E(t,n),EC(t),RC(t,n),fC(t),gC(t),SC(t),vC(t,n),Du(t),SE(t),TE(t),Pu(t,n),Lu(t),RE(t,n);break;case"firefox":if(!kC||!mE||!e.shimFirefox)return i("Firefox shim is not included in this adapter release."),r;i("adapter.js shimming firefox."),r.browserShim=kC,ku(t,n),Mu(t),CC(t,n),mE(t,n),bC(t),wC(t),IC(t),AC(t),OC(t),NC(t),DC(t),PC(t),LC(t),Du(t),TE(t),Pu(t,n),Lu(t);break;case"safari":if(!HC||!e.shimSafari)return i("Safari shim is not included in this adapter release."),r;i("adapter.js shimming safari."),r.browserShim=HC,ku(t,n),Mu(t),BC(t),GC(t),xC(t),MC(t),UC(t),jC(t),VC(t),WC(t),Du(t),SE(t),Pu(t,n),Lu(t),RE(t,n);break;default:i("Unsupported browser!")}})({window:typeof window>"u"?void 0:window});var vE=jt;Ht({global:!0,forced:vE.globalThis!==vE},{globalThis:vE});var JC=b(jt),yE={exports:{}};(function(t,e){(function(i,n){var r="function",o="undefined",s="object",a="string",c="major",d="model",l="name",u="type",h="vendor",p="version",g="architecture",E="console",f="mobile",R="tablet",y="smarttv",N="wearable",k="embedded",L="Amazon",P="Apple",V="ASUS",B="BlackBerry",Y="Browser",J="Chrome",yt="Firefox",Rt="Google",_t="Huawei",ne="LG",Qt="Microsoft",Ni="Motorola",j="Opera",K="Samsung",it="Sharp",G="Sony",m="Xiaomi",w="Zebra",D="Facebook",H="Chromium OS",St="Mac OS",ee=" Browser",Me=function(De){for(var Ue={},se=0;se<De.length;se++)Ue[De[se].toUpperCase()]=De[se];return Ue},Sn=function(De,Ue){return typeof De===a&&qn(Ue).indexOf(qn(De))!==-1},qn=function(De){return De.toLowerCase()},cl=function(De,Ue){if(typeof De===a)return De=De.replace(/^\s\s*/,""),typeof Ue===o?De:De.substring(0,500)},Gs=function(De,Ue){for(var se,xi,lr,Ce,lo,Pt,ur=0;ur<Ue.length&&!lo;){var Ws=Ue[ur],Fr=Ue[ur+1];for(se=xi=0;se<Ws.length&&!lo&&Ws[se];)if(lo=Ws[se++].exec(De))for(lr=0;lr<Fr.length;lr++)Pt=lo[++xi],typeof(Ce=Fr[lr])===s&&Ce.length>0?Ce.length===2?typeof Ce[1]==r?this[Ce[0]]=Ce[1].call(this,Pt):this[Ce[0]]=Ce[1]:Ce.length===3?typeof Ce[1]!==r||Ce[1].exec&&Ce[1].test?this[Ce[0]]=Pt?Pt.replace(Ce[1],Ce[2]):n:this[Ce[0]]=Pt?Ce[1].call(this,Pt,Ce[2]):n:Ce.length===4&&(this[Ce[0]]=Pt?Ce[3].call(this,Pt.replace(Ce[1],Ce[2])):n):this[Ce]=Pt||n;ur+=2}},gc=function(De,Ue){for(var se in Ue)if(typeof Ue[se]===s&&Ue[se].length>0){for(var xi=0;xi<Ue[se].length;xi++)if(Sn(Ue[se][xi],De))return se==="?"?n:se}else if(Sn(Ue[se],De))return se==="?"?n:se;return Ue.hasOwnProperty("*")?Ue["*"]:De},Op={ME:"4.90","NT 3.11":"NT3.51","NT 4.0":"NT4.0",2e3:"NT 5.0",XP:["NT 5.1","NT 5.2"],Vista:"NT 6.0",7:"NT 6.1",8:"NT 6.2",8.1:"NT 6.3",10:["NT 6.4","NT 10.0"],RT:"ARM"},Np={browser:[[/\b(?:crmo|crios)\/([\w\.]+)/i],[p,[l,"Chrome"]],[/edg(?:e|ios|a)?\/([\w\.]+)/i],[p,[l,"Edge"]],[/(opera mini)\/([-\w\.]+)/i,/(opera [mobiletab]{3,6})\b.+version\/([-\w\.]+)/i,/(opera)(?:.+version\/|[\/ ]+)([\w\.]+)/i],[l,p],[/opios[\/ ]+([\w\.]+)/i],[p,[l,j+" Mini"]],[/\bop(?:rg)?x\/([\w\.]+)/i],[p,[l,j+" GX"]],[/\bopr\/([\w\.]+)/i],[p,[l,j]],[/\bb[ai]*d(?:uhd|[ub]*[aekoprswx]{5,6})[\/ ]?([\w\.]+)/i],[p,[l,"Baidu"]],[/\b(?:mxbrowser|mxios|myie2)\/?([-\w\.]*)\b/i],[p,[l,"Maxthon"]],[/(kindle)\/([\w\.]+)/i,/(lunascape|maxthon|netfront|jasmine|blazer|sleipnir)[\/ ]?([\w\.]*)/i,/(avant|iemobile|slim(?:browser|boat|jet))[\/ ]?([\d\.]*)/i,/(?:ms|\()(ie) ([\w\.]+)/i,/(flock|rockmelt|midori|epiphany|silk|skyfire|ovibrowser|bolt|iron|vivaldi|iridium|phantomjs|bowser|qupzilla|falkon|rekonq|puffin|brave|whale(?!.+naver)|qqbrowserlite|duckduckgo|klar|helio|(?=comodo_)?dragon)\/([-\w\.]+)/i,/(heytap|ovi|115)browser\/([\d\.]+)/i,/(weibo)__([\d\.]+)/i],[l,p],[/quark(?:pc)?\/([-\w\.]+)/i],[p,[l,"Quark"]],[/\bddg\/([\w\.]+)/i],[p,[l,"DuckDuckGo"]],[/(?:\buc? ?browser|(?:juc.+)ucweb)[\/ ]?([\w\.]+)/i],[p,[l,"UC"+Y]],[/microm.+\bqbcore\/([\w\.]+)/i,/\bqbcore\/([\w\.]+).+microm/i,/micromessenger\/([\w\.]+)/i],[p,[l,"WeChat"]],[/konqueror\/([\w\.]+)/i],[p,[l,"Konqueror"]],[/trident.+rv[: ]([\w\.]{1,9})\b.+like gecko/i],[p,[l,"IE"]],[/ya(?:search)?browser\/([\w\.]+)/i],[p,[l,"Yandex"]],[/slbrowser\/([\w\.]+)/i],[p,[l,"Smart Lenovo "+Y]],[/(avast|avg)\/([\w\.]+)/i],[[l,/(.+)/,"$1 Secure "+Y],p],[/\bfocus\/([\w\.]+)/i],[p,[l,yt+" Focus"]],[/\bopt\/([\w\.]+)/i],[p,[l,j+" Touch"]],[/coc_coc\w+\/([\w\.]+)/i],[p,[l,"Coc Coc"]],[/dolfin\/([\w\.]+)/i],[p,[l,"Dolphin"]],[/coast\/([\w\.]+)/i],[p,[l,j+" Coast"]],[/miuibrowser\/([\w\.]+)/i],[p,[l,"MIUI"+ee]],[/fxios\/([\w\.-]+)/i],[p,[l,yt]],[/\bqihoobrowser\/?([\w\.]*)/i],[p,[l,"360"]],[/\b(qq)\/([\w\.]+)/i],[[l,/(.+)/,"$1Browser"],p],[/(oculus|sailfish|huawei|vivo|pico)browser\/([\w\.]+)/i],[[l,/(.+)/,"$1"+ee],p],[/samsungbrowser\/([\w\.]+)/i],[p,[l,K+" Internet"]],[/metasr[\/ ]?([\d\.]+)/i],[p,[l,"Sogou Explorer"]],[/(sogou)mo\w+\/([\d\.]+)/i],[[l,"Sogou Mobile"],p],[/(electron)\/([\w\.]+) safari/i,/(tesla)(?: qtcarbrowser|\/(20\d\d\.[-\w\.]+))/i,/m?(qqbrowser|2345(?=browser|chrome|explorer))\w*[\/ ]?v?([\w\.]+)/i],[l,p],[/(lbbrowser|rekonq)/i,/\[(linkedin)app\]/i],[l],[/ome\/([\w\.]+) \w* ?(iron) saf/i,/ome\/([\w\.]+).+qihu (360)[es]e/i],[p,l],[/((?:fban\/fbios|fb_iab\/fb4a)(?!.+fbav)|;fbav\/([\w\.]+);)/i],[[l,D],p],[/(Klarna)\/([\w\.]+)/i,/(kakao(?:talk|story))[\/ ]([\w\.]+)/i,/(naver)\(.*?(\d+\.[\w\.]+).*\)/i,/safari (line)\/([\w\.]+)/i,/\b(line)\/([\w\.]+)\/iab/i,/(alipay)client\/([\w\.]+)/i,/(twitter)(?:and| f.+e\/([\w\.]+))/i,/(chromium|instagram|snapchat)[\/ ]([-\w\.]+)/i],[l,p],[/\bgsa\/([\w\.]+) .*safari\//i],[p,[l,"GSA"]],[/musical_ly(?:.+app_?version\/|_)([\w\.]+)/i],[p,[l,"TikTok"]],[/headlesschrome(?:\/([\w\.]+)| )/i],[p,[l,J+" Headless"]],[/ wv\).+(chrome)\/([\w\.]+)/i],[[l,J+" WebView"],p],[/droid.+ version\/([\w\.]+)\b.+(?:mobile safari|safari)/i],[p,[l,"Android "+Y]],[/(chrome|omniweb|arora|[tizenoka]{5} ?browser)\/v?([\w\.]+)/i],[l,p],[/version\/([\w\.\,]+) .*mobile\/\w+ (safari)/i],[p,[l,"Mobile Safari"]],[/version\/([\w(\.|\,)]+) .*(mobile ?safari|safari)/i],[p,l],[/webkit.+?(mobile ?safari|safari)(\/[\w\.]+)/i],[l,[p,gc,{"1.0":"/8",1.2:"/1",1.3:"/3","2.0":"/412","2.0.2":"/416","2.0.3":"/417","2.0.4":"/419","?":"/"}]],[/(webkit|khtml)\/([\w\.]+)/i],[l,p],[/(navigator|netscape\d?)\/([-\w\.]+)/i],[[l,"Netscape"],p],[/(wolvic|librewolf)\/([\w\.]+)/i],[l,p],[/mobile vr; rv:([\w\.]+)\).+firefox/i],[p,[l,yt+" Reality"]],[/ekiohf.+(flow)\/([\w\.]+)/i,/(swiftfox)/i,/(icedragon|iceweasel|camino|chimera|fennec|maemo browser|minimo|conkeror)[\/ ]?([\w\.\+]+)/i,/(seamonkey|k-meleon|icecat|iceape|firebird|phoenix|palemoon|basilisk|waterfox)\/([-\w\.]+)$/i,/(firefox)\/([\w\.]+)/i,/(mozilla)\/([\w\.]+) .+rv\:.+gecko\/\d+/i,/(polaris|lynx|dillo|icab|doris|amaya|w3m|netsurf|obigo|mosaic|(?:go|ice|up)[\. ]?browser)[-\/ ]?v?([\w\.]+)/i,/(links) \(([\w\.]+)/i],[l,[p,/_/g,"."]],[/(cobalt)\/([\w\.]+)/i],[l,[p,/master.|lts./,""]]],cpu:[[/(?:(amd|x(?:(?:86|64)[-_])?|wow|win)64)[;\)]/i],[[g,"amd64"]],[/(ia32(?=;))/i],[[g,qn]],[/((?:i[346]|x)86)[;\)]/i],[[g,"ia32"]],[/\b(aarch64|arm(v?8e?l?|_?64))\b/i],[[g,"arm64"]],[/\b(arm(?:v[67])?ht?n?[fl]p?)\b/i],[[g,"armhf"]],[/windows (ce|mobile); ppc;/i],[[g,"arm"]],[/((?:ppc|powerpc)(?:64)?)(?: mac|;|\))/i],[[g,/ower/,"",qn]],[/(sun4\w)[;\)]/i],[[g,"sparc"]],[/((?:avr32|ia64(?=;))|68k(?=\))|\barm(?=v(?:[1-7]|[5-7]1)l?|;|eabi)|(?=atmel )avr|(?:irix|mips|sparc)(?:64)?\b|pa-risc)/i],[[g,qn]]],device:[[/\b(sch-i[89]0\d|shw-m380s|sm-[ptx]\w{2,4}|gt-[pn]\d{2,4}|sgh-t8[56]9|nexus 10)/i],[d,[h,K],[u,R]],[/\b((?:s[cgp]h|gt|sm)-(?![lr])\w+|sc[g-]?[\d]+a?|galaxy nexus)/i,/samsung[- ]((?!sm-[lr])[-\w]+)/i,/sec-(sgh\w+)/i],[d,[h,K],[u,f]],[/(?:\/|\()(ip(?:hone|od)[\w, ]*)(?:\/|;)/i],[d,[h,P],[u,f]],[/\((ipad);[-\w\),; ]+apple/i,/applecoremedia\/[\w\.]+ \((ipad)/i,/\b(ipad)\d\d?,\d\d?[;\]].+ios/i],[d,[h,P],[u,R]],[/(macintosh);/i],[d,[h,P]],[/\b(sh-?[altvz]?\d\d[a-ekm]?)/i],[d,[h,it],[u,f]],[/(?:honor)([-\w ]+)[;\)]/i],[d,[h,"Honor"],[u,f]],[/\b((?:ag[rs][23]?|bah2?|sht?|btv)-a?[lw]\d{2})\b(?!.+d\/s)/i],[d,[h,_t],[u,R]],[/(?:huawei)([-\w ]+)[;\)]/i,/\b(nexus 6p|\w{2,4}e?-[atu]?[ln][\dx][012359c][adn]?)\b(?!.+d\/s)/i],[d,[h,_t],[u,f]],[/\b(poco[\w ]+|m2\d{3}j\d\d[a-z]{2})(?: bui|\))/i,/\b; (\w+) build\/hm\1/i,/\b(hm[-_ ]?note?[_ ]?(?:\d\w)?) bui/i,/\b(redmi[\-_ ]?(?:note|k)?[\w_ ]+)(?: bui|\))/i,/oid[^\)]+; (m?[12][0-389][01]\w{3,6}[c-y])( bui|; wv|\))/i,/\b(mi[-_ ]?(?:a\d|one|one[_ ]plus|note lte|max|cc)?[_ ]?(?:\d?\w?)[_ ]?(?:plus|se|lite|pro)?)(?: bui|\))/i],[[d,/_/g," "],[h,m],[u,f]],[/oid[^\)]+; (2\d{4}(283|rpbf)[cgl])( bui|\))/i,/\b(mi[-_ ]?(?:pad)(?:[\w_ ]+))(?: bui|\))/i],[[d,/_/g," "],[h,m],[u,R]],[/; (\w+) bui.+ oppo/i,/\b(cph[12]\d{3}|p(?:af|c[al]|d\w|e[ar])[mt]\d0|x9007|a101op)\b/i],[d,[h,"OPPO"],[u,f]],[/\b(opd2\d{3}a?) bui/i],[d,[h,"OPPO"],[u,R]],[/vivo (\w+)(?: bui|\))/i,/\b(v[12]\d{3}\w?[at])(?: bui|;)/i],[d,[h,"Vivo"],[u,f]],[/\b(rmx[1-3]\d{3})(?: bui|;|\))/i],[d,[h,"Realme"],[u,f]],[/\b(milestone|droid(?:[2-4x]| (?:bionic|x2|pro|razr))?:?( 4g)?)\b[\w ]+build\//i,/\bmot(?:orola)?[- ](\w*)/i,/((?:moto[\w\(\) ]+|xt\d{3,4}|nexus 6)(?= bui|\)))/i],[d,[h,Ni],[u,f]],[/\b(mz60\d|xoom[2 ]{0,2}) build\//i],[d,[h,Ni],[u,R]],[/((?=lg)?[vl]k\-?\d{3}) bui| 3\.[-\w; ]{10}lg?-([06cv9]{3,4})/i],[d,[h,ne],[u,R]],[/(lm(?:-?f100[nv]?|-[\w\.]+)(?= bui|\))|nexus [45])/i,/\blg[-e;\/ ]+((?!browser|netcast|android tv)\w+)/i,/\blg-?([\d\w]+) bui/i],[d,[h,ne],[u,f]],[/(ideatab[-\w ]+)/i,/lenovo ?(s[56]000[-\w]+|tab(?:[\w ]+)|yt[-\d\w]{6}|tb[-\d\w]{6})/i],[d,[h,"Lenovo"],[u,R]],[/(?:maemo|nokia).*(n900|lumia \d+)/i,/nokia[-_ ]?([-\w\.]*)/i],[[d,/_/g," "],[h,"Nokia"],[u,f]],[/(pixel c)\b/i],[d,[h,Rt],[u,R]],[/droid.+; (pixel[\daxl ]{0,6})(?: bui|\))/i],[d,[h,Rt],[u,f]],[/droid.+; (a?\d[0-2]{2}so|[c-g]\d{4}|so[-gl]\w+|xq-a\w[4-7][12])(?= bui|\).+chrome\/(?![1-6]{0,1}\d\.))/i],[d,[h,G],[u,f]],[/sony tablet [ps]/i,/\b(?:sony)?sgp\w+(?: bui|\))/i],[[d,"Xperia Tablet"],[h,G],[u,R]],[/ (kb2005|in20[12]5|be20[12][59])\b/i,/(?:one)?(?:plus)? (a\d0\d\d)(?: b|\))/i],[d,[h,"OnePlus"],[u,f]],[/(alexa)webm/i,/(kf[a-z]{2}wi|aeo(?!bc)\w\w)( bui|\))/i,/(kf[a-z]+)( bui|\)).+silk\//i],[d,[h,L],[u,R]],[/((?:sd|kf)[0349hijorstuw]+)( bui|\)).+silk\//i],[[d,/(.+)/g,"Fire Phone $1"],[h,L],[u,f]],[/(playbook);[-\w\),; ]+(rim)/i],[d,h,[u,R]],[/\b((?:bb[a-f]|st[hv])100-\d)/i,/\(bb10; (\w+)/i],[d,[h,B],[u,f]],[/(?:\b|asus_)(transfo[prime ]{4,10} \w+|eeepc|slider \w+|nexus 7|padfone|p00[cj])/i],[d,[h,V],[u,R]],[/ (z[bes]6[027][012][km][ls]|zenfone \d\w?)\b/i],[d,[h,V],[u,f]],[/(nexus 9)/i],[d,[h,"HTC"],[u,R]],[/(htc)[-;_ ]{1,2}([\w ]+(?=\)| bui)|\w+)/i,/(zte)[- ]([\w ]+?)(?: bui|\/|\))/i,/(alcatel|geeksphone|nexian|panasonic(?!(?:;|\.))|sony(?!-bra))[-_ ]?([-\w]*)/i],[h,[d,/_/g," "],[u,f]],[/droid [\w\.]+; ((?:8[14]9[16]|9(?:0(?:48|60|8[01])|1(?:3[27]|66)|2(?:6[69]|9[56])|466))[gqswx])\w*(\)| bui)/i],[d,[h,"TCL"],[u,R]],[/(itel) ((\w+))/i],[[h,qn],d,[u,gc,{tablet:["p10001l","w7001"],"*":"mobile"}]],[/droid.+; ([ab][1-7]-?[0178a]\d\d?)/i],[d,[h,"Acer"],[u,R]],[/droid.+; (m[1-5] note) bui/i,/\bmz-([-\w]{2,})/i],[d,[h,"Meizu"],[u,f]],[/; ((?:power )?armor(?:[\w ]{0,8}))(?: bui|\))/i],[d,[h,"Ulefone"],[u,f]],[/; (energy ?\w+)(?: bui|\))/i,/; energizer ([\w ]+)(?: bui|\))/i],[d,[h,"Energizer"],[u,f]],[/; cat (b35);/i,/; (b15q?|s22 flip|s48c|s62 pro)(?: bui|\))/i],[d,[h,"Cat"],[u,f]],[/((?:new )?andromax[\w- ]+)(?: bui|\))/i],[d,[h,"Smartfren"],[u,f]],[/droid.+; (a(?:015|06[35]|142p?))/i],[d,[h,"Nothing"],[u,f]],[/(blackberry|benq|palm(?=\-)|sonyericsson|acer|asus|dell|meizu|motorola|polytron|infinix|tecno|micromax|advan)[-_ ]?([-\w]*)/i,/; (imo) ((?!tab)[\w ]+?)(?: bui|\))/i,/(hp) ([\w ]+\w)/i,/(asus)-?(\w+)/i,/(microsoft); (lumia[\w ]+)/i,/(lenovo)[-_ ]?([-\w]+)/i,/(jolla)/i,/(oppo) ?([\w ]+) bui/i],[h,d,[u,f]],[/(imo) (tab \w+)/i,/(kobo)\s(ereader|touch)/i,/(archos) (gamepad2?)/i,/(hp).+(touchpad(?!.+tablet)|tablet)/i,/(kindle)\/([\w\.]+)/i,/(nook)[\w ]+build\/(\w+)/i,/(dell) (strea[kpr\d ]*[\dko])/i,/(le[- ]+pan)[- ]+(\w{1,9}) bui/i,/(trinity)[- ]*(t\d{3}) bui/i,/(gigaset)[- ]+(q\w{1,9}) bui/i,/(vodafone) ([\w ]+)(?:\)| bui)/i],[h,d,[u,R]],[/(surface duo)/i],[d,[h,Qt],[u,R]],[/droid [\d\.]+; (fp\du?)(?: b|\))/i],[d,[h,"Fairphone"],[u,f]],[/(u304aa)/i],[d,[h,"AT&T"],[u,f]],[/\bsie-(\w*)/i],[d,[h,"Siemens"],[u,f]],[/\b(rct\w+) b/i],[d,[h,"RCA"],[u,R]],[/\b(venue[\d ]{2,7}) b/i],[d,[h,"Dell"],[u,R]],[/\b(q(?:mv|ta)\w+) b/i],[d,[h,"Verizon"],[u,R]],[/\b(?:barnes[& ]+noble |bn[rt])([\w\+ ]*) b/i],[d,[h,"Barnes & Noble"],[u,R]],[/\b(tm\d{3}\w+) b/i],[d,[h,"NuVision"],[u,R]],[/\b(k88) b/i],[d,[h,"ZTE"],[u,R]],[/\b(nx\d{3}j) b/i],[d,[h,"ZTE"],[u,f]],[/\b(gen\d{3}) b.+49h/i],[d,[h,"Swiss"],[u,f]],[/\b(zur\d{3}) b/i],[d,[h,"Swiss"],[u,R]],[/\b((zeki)?tb.*\b) b/i],[d,[h,"Zeki"],[u,R]],[/\b([yr]\d{2}) b/i,/\b(dragon[- ]+touch |dt)(\w{5}) b/i],[[h,"Dragon Touch"],d,[u,R]],[/\b(ns-?\w{0,9}) b/i],[d,[h,"Insignia"],[u,R]],[/\b((nxa|next)-?\w{0,9}) b/i],[d,[h,"NextBook"],[u,R]],[/\b(xtreme\_)?(v(1[045]|2[015]|[3469]0|7[05])) b/i],[[h,"Voice"],d,[u,f]],[/\b(lvtel\-)?(v1[12]) b/i],[[h,"LvTel"],d,[u,f]],[/\b(ph-1) /i],[d,[h,"Essential"],[u,f]],[/\b(v(100md|700na|7011|917g).*\b) b/i],[d,[h,"Envizen"],[u,R]],[/\b(trio[-\w\. ]+) b/i],[d,[h,"MachSpeed"],[u,R]],[/\btu_(1491) b/i],[d,[h,"Rotor"],[u,R]],[/(shield[\w ]+) b/i],[d,[h,"Nvidia"],[u,R]],[/(sprint) (\w+)/i],[h,d,[u,f]],[/(kin\.[onetw]{3})/i],[[d,/\./g," "],[h,Qt],[u,f]],[/droid.+; (cc6666?|et5[16]|mc[239][23]x?|vc8[03]x?)\)/i],[d,[h,w],[u,R]],[/droid.+; (ec30|ps20|tc[2-8]\d[kx])\)/i],[d,[h,w],[u,f]],[/smart-tv.+(samsung)/i],[h,[u,y]],[/hbbtv.+maple;(\d+)/i],[[d,/^/,"SmartTV"],[h,K],[u,y]],[/(nux; netcast.+smarttv|lg (netcast\.tv-201\d|android tv))/i],[[h,ne],[u,y]],[/(apple) ?tv/i],[h,[d,P+" TV"],[u,y]],[/crkey/i],[[d,J+"cast"],[h,Rt],[u,y]],[/droid.+aft(\w+)( bui|\))/i],[d,[h,L],[u,y]],[/\(dtv[\);].+(aquos)/i,/(aquos-tv[\w ]+)\)/i],[d,[h,it],[u,y]],[/(bravia[\w ]+)( bui|\))/i],[d,[h,G],[u,y]],[/(mitv-\w{5}) bui/i],[d,[h,m],[u,y]],[/Hbbtv.*(technisat) (.*);/i],[h,d,[u,y]],[/\b(roku)[\dx]*[\)\/]((?:dvp-)?[\d\.]*)/i,/hbbtv\/\d+\.\d+\.\d+ +\([\w\+ ]*; *([\w\d][^;]*);([^;]*)/i],[[h,cl],[d,cl],[u,y]],[/\b(android tv|smart[- ]?tv|opera tv|tv; rv:)\b/i],[[u,y]],[/(ouya)/i,/(nintendo) ([wids3utch]+)/i],[h,d,[u,E]],[/droid.+; (shield) bui/i],[d,[h,"Nvidia"],[u,E]],[/(playstation [345portablevi]+)/i],[d,[h,G],[u,E]],[/\b(xbox(?: one)?(?!; xbox))[\); ]/i],[d,[h,Qt],[u,E]],[/\b(sm-[lr]\d\d[05][fnuw]?s?)\b/i],[d,[h,K],[u,N]],[/((pebble))app/i],[h,d,[u,N]],[/(watch)(?: ?os[,\/]|\d,\d\/)[\d\.]+/i],[d,[h,P],[u,N]],[/droid.+; (glass) \d/i],[d,[h,Rt],[u,N]],[/droid.+; (wt63?0{2,3})\)/i],[d,[h,w],[u,N]],[/droid.+; (glass) \d/i],[d,[h,Rt],[u,N]],[/(pico) (4|neo3(?: link|pro)?)/i],[h,d,[u,N]],[/; (quest( \d| pro)?)/i],[d,[h,D],[u,N]],[/(tesla)(?: qtcarbrowser|\/[-\w\.]+)/i],[h,[u,k]],[/(aeobc)\b/i],[d,[h,L],[u,k]],[/droid .+?; ([^;]+?)(?: bui|; wv\)|\) applew).+? mobile safari/i],[d,[u,f]],[/droid .+?; ([^;]+?)(?: bui|\) applew).+?(?! mobile) safari/i],[d,[u,R]],[/\b((tablet|tab)[;\/]|focus\/\d(?!.+mobile))/i],[[u,R]],[/(phone|mobile(?:[;\/]| [ \w\/\.]*safari)|pda(?=.+windows ce))/i],[[u,f]],[/(android[-\w\. ]{0,9});.+buil/i],[d,[h,"Generic"]]],engine:[[/windows.+ edge\/([\w\.]+)/i],[p,[l,"EdgeHTML"]],[/(arkweb)\/([\w\.]+)/i],[l,p],[/webkit\/537\.36.+chrome\/(?!27)([\w\.]+)/i],[p,[l,"Blink"]],[/(presto)\/([\w\.]+)/i,/(webkit|trident|netfront|netsurf|amaya|lynx|w3m|goanna|servo)\/([\w\.]+)/i,/ekioh(flow)\/([\w\.]+)/i,/(khtml|tasman|links)[\/ ]\(?([\w\.]+)/i,/(icab)[\/ ]([23]\.[\d\.]+)/i,/\b(libweb)/i],[l,p],[/rv\:([\w\.]{1,9})\b.+(gecko)/i],[p,l]],os:[[/microsoft (windows) (vista|xp)/i],[l,p],[/(windows (?:phone(?: os)?|mobile))[\/ ]?([\d\.\w ]*)/i],[l,[p,gc,Op]],[/windows nt 6\.2; (arm)/i,/windows[\/ ]?([ntce\d\. ]+\w)(?!.+xbox)/i,/(?:win(?=3|9|n)|win 9x )([nt\d\.]+)/i],[[p,gc,Op],[l,"Windows"]],[/ip[honead]{2,4}\b(?:.*os ([\w]+) like mac|; opera)/i,/(?:ios;fbsv\/|iphone.+ios[\/ ])([\d\.]+)/i,/cfnetwork\/.+darwin/i],[[p,/_/g,"."],[l,"iOS"]],[/(mac os x) ?([\w\. ]*)/i,/(macintosh|mac_powerpc\b)(?!.+haiku)/i],[[l,St],[p,/_/g,"."]],[/droid ([\w\.]+)\b.+(android[- ]x86|harmonyos)/i],[p,l],[/(android|webos|qnx|bada|rim tablet os|maemo|meego|sailfish|openharmony)[-\/ ]?([\w\.]*)/i,/(blackberry)\w*\/([\w\.]*)/i,/(tizen|kaios)[\/ ]([\w\.]+)/i,/\((series40);/i],[l,p],[/\(bb(10);/i],[p,[l,B]],[/(?:symbian ?os|symbos|s60(?=;)|series60)[-\/ ]?([\w\.]*)/i],[p,[l,"Symbian"]],[/mozilla\/[\d\.]+ \((?:mobile|tablet|tv|mobile; [\w ]+); rv:.+ gecko\/([\w\.]+)/i],[p,[l,yt+" OS"]],[/web0s;.+rt(tv)/i,/\b(?:hp)?wos(?:browser)?\/([\w\.]+)/i],[p,[l,"webOS"]],[/watch(?: ?os[,\/]|\d,\d\/)([\d\.]+)/i],[p,[l,"watchOS"]],[/crkey\/([\d\.]+)/i],[p,[l,J+"cast"]],[/(cros) [\w]+(?:\)| ([\w\.]+)\b)/i],[[l,H],p],[/panasonic;(viera)/i,/(netrange)mmh/i,/(nettv)\/(\d+\.[\w\.]+)/i,/(nintendo|playstation) ([wids345portablevuch]+)/i,/(xbox); +xbox ([^\);]+)/i,/\b(joli|palm)\b ?(?:os)?\/?([\w\.]*)/i,/(mint)[\/\(\) ]?(\w*)/i,/(mageia|vectorlinux)[; ]/i,/([kxln]?ubuntu|debian|suse|opensuse|gentoo|arch(?= linux)|slackware|fedora|mandriva|centos|pclinuxos|red ?hat|zenwalk|linpus|raspbian|plan 9|minix|risc os|contiki|deepin|manjaro|elementary os|sabayon|linspire)(?: gnu\/linux)?(?: enterprise)?(?:[- ]linux)?(?:-gnu)?[-\/ ]?(?!chrom|package)([-\w\.]*)/i,/(hurd|linux) ?([\w\.]*)/i,/(gnu) ?([\w\.]*)/i,/\b([-frentopcghs]{0,5}bsd|dragonfly)[\/ ]?(?!amd|[ix346]{1,2}86)([\w\.]*)/i,/(haiku) (\w+)/i],[l,p],[/(sunos) ?([\w\.\d]*)/i],[[l,"Solaris"],p],[/((?:open)?solaris)[-\/ ]?([\w\.]*)/i,/(aix) ((\d)(?=\.|\)| )[\w\.])*/i,/\b(beos|os\/2|amigaos|morphos|openvms|fuchsia|hp-ux|serenityos)/i,/(unix) ?([\w\.]*)/i],[l,p]]},Tn=function(De,Ue){if(typeof De===s&&(Ue=De,De=n),!(this instanceof Tn))return new Tn(De,Ue).getResult();var se=typeof i!==o&&i.navigator?i.navigator:n,xi=De||(se&&se.userAgent?se.userAgent:""),lr=se&&se.userAgentData?se.userAgentData:n,Ce=Ue?function(Pt,ur){var Ws={};for(var Fr in Pt)ur[Fr]&&ur[Fr].length%2==0?Ws[Fr]=ur[Fr].concat(Pt[Fr]):Ws[Fr]=Pt[Fr];return Ws}(Np,Ue):Np,lo=se&&se.userAgent==xi;return this.getBrowser=function(){var Pt={};return Pt[l]=n,Pt[p]=n,Gs.call(Pt,xi,Ce.browser),Pt[c]=function(ur){return typeof ur===a?ur.replace(/[^\d\.]/g,"").split(".")[0]:n}(Pt[p]),lo&&se&&se.brave&&typeof se.brave.isBrave==r&&(Pt[l]="Brave"),Pt},this.getCPU=function(){var Pt={};return Pt[g]=n,Gs.call(Pt,xi,Ce.cpu),Pt},this.getDevice=function(){var Pt={};return Pt[h]=n,Pt[d]=n,Pt[u]=n,Gs.call(Pt,xi,Ce.device),lo&&!Pt[u]&&lr&&lr.mobile&&(Pt[u]=f),lo&&Pt[d]=="Macintosh"&&se&&typeof se.standalone!==o&&se.maxTouchPoints&&se.maxTouchPoints>2&&(Pt[d]="iPad",Pt[u]=R),Pt},this.getEngine=function(){var Pt={};return Pt[l]=n,Pt[p]=n,Gs.call(Pt,xi,Ce.engine),Pt},this.getOS=function(){var Pt={};return Pt[l]=n,Pt[p]=n,Gs.call(Pt,xi,Ce.os),lo&&!Pt[l]&&lr&&lr.platform&&lr.platform!="Unknown"&&(Pt[l]=lr.platform.replace(/chrome os/i,H).replace(/macos/i,St)),Pt},this.getResult=function(){return{ua:this.getUA(),browser:this.getBrowser(),engine:this.getEngine(),os:this.getOS(),device:this.getDevice(),cpu:this.getCPU()}},this.getUA=function(){return xi},this.setUA=function(Pt){return xi=typeof Pt===a&&Pt.length>500?cl(Pt,500):Pt,this},this.setUA(xi),this};Tn.VERSION="0.7.40",Tn.BROWSER=Me([l,p,c]),Tn.CPU=Me([g]),Tn.DEVICE=Me([d,h,u,E,f,y,R,N,k]),Tn.ENGINE=Tn.OS=Me([l,p]),t.exports&&(e=t.exports=Tn),e.UAParser=Tn;var co=typeof i!==o&&(i.jQuery||i.Zepto);if(co&&!co.ua){var Dp=new Tn;co.ua=Dp.getResult(),co.ua.get=function(){return Dp.getUA()},co.ua.set=function(De){Dp.setUA(De);var Ue=Dp.getResult();for(var se in Ue)co.ua[se]=Ue[se]}}})(typeof window=="object"?window:S)})(yE,yE.exports);var F3=b(yE.exports),QC=cu.clear;Ht({global:!0,bind:!0,enumerable:!0,forced:jt.clearImmediate!==QC},{clearImmediate:QC});var ZC=jt,B3=Pc,j3=Je,G3=N_,W3=Kr,H3=Ao,K3=cs,q3=ZC.Function,Y3=/MSIE .\./.test(W3)||G3==="BUN"&&function(){var t=ZC.Bun.version.split(".");return t.length<3||t[0]==="0"&&(t[1]<3||t[1]==="3"&&t[2]==="0")}(),z3=Ht,$C=jt,tb=cu.set,X3=function(t,e){var i=e?2:1;return Y3?function(n,r){var o=K3(arguments.length,1)>i,s=j3(n)?n:q3(n),a=o?H3(arguments,i):[],c=o?function(){B3(s,this,a)}:s;return e?t(c,r):t(c)}:t},eb=$C.setImmediate?X3(tb,!1):tb;z3({global:!0,bind:!0,enumerable:!0,forced:$C.setImmediate!==eb},{setImmediate:eb});var ib=b(dn.setImmediate),J3=jt,Q3=pv,Z3=qi,$3=cs,tH=Di;Ht({global:!0,enumerable:!0,dontCallGetSet:!0,forced:O(function(){return tH&&Object.getOwnPropertyDescriptor(J3,"queueMicrotask").value.length!==1})},{queueMicrotask:function(t){$3(arguments.length,1),Q3(Z3(t))}});var nb=b(dn.queueMicrotask);function rb(t,e){return function(){return t.apply(e,arguments)}}let{toString:eH}=Object.prototype,{getPrototypeOf:CE}=Object,{iterator:Uu,toStringTag:ob}=Symbol,xu=(bE=Object.create(null),t=>{let e=eH.call(t);return bE[e]||(bE[e]=e.slice(8,-1).toLowerCase())});var bE;let Qn=t=>(t=t.toLowerCase(),e=>xu(e)===t),Vu=t=>e=>typeof e===t,{isArray:ba}=Array,nd=Vu("undefined"),sb=Qn("ArrayBuffer"),iH=Vu("string"),zi=Vu("function"),ab=Vu("number"),Fu=t=>t!==null&&typeof t=="object",Bu=t=>{if(xu(t)!=="object")return!1;let e=CE(t);return!(e!==null&&e!==Object.prototype&&Object.getPrototypeOf(e)!==null||ob in t||Uu in t)},nH=Qn("Date"),rH=Qn("File"),oH=Qn("Blob"),sH=Qn("FileList"),aH=Qn("URLSearchParams"),[cH,dH,lH,uH]=["ReadableStream","Request","Response","Headers"].map(Qn);function rd(t,e){let i,n,{allOwnKeys:r=!1}=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(t!=null)if(typeof t!="object"&&(t=[t]),ba(t))for(i=0,n=t.length;i<n;i++)e.call(null,t[i],i,t);else{let o=r?Object.getOwnPropertyNames(t):Object.keys(t),s=o.length,a;for(i=0;i<s;i++)a=o[i],e.call(null,t[a],a,t)}}function cb(t,e){e=e.toLowerCase();let i=Object.keys(t),n,r=i.length;for(;r-- >0;)if(n=i[r],e===n.toLowerCase())return n;return null}let ms=JC!==void 0?JC:typeof self<"u"?self:typeof window<"u"?window:global,db=t=>!nd(t)&&t!==ms,hH=(IE=typeof Uint8Array<"u"&&CE(Uint8Array),t=>IE&&t instanceof IE);var IE;let pH=Qn("HTMLFormElement"),lb=(t=>{let{hasOwnProperty:e}=t;return(i,n)=>e.call(i,n)})(Object.prototype),_H=Qn("RegExp"),ub=(t,e)=>{let i=Object.getOwnPropertyDescriptors(t),n={};rd(i,(r,o)=>{let s;(s=e(r,o,t))!==!1&&(n[o]=s||r)}),Object.defineProperties(t,n)},mH=Qn("AsyncFunction"),hb=(pb=typeof ib=="function",_b=zi(ms.postMessage),pb?ib:_b?(AE="axios@".concat(Math.random()),ju=[],ms.addEventListener("message",t=>{let{source:e,data:i}=t;e===ms&&i===AE&&ju.length&&ju.shift()()},!1),t=>{ju.push(t),ms.postMessage(AE,"*")}):t=>setTimeout(t));var pb,_b,AE,ju;let EH=nb!==void 0?nb.bind(ms):typeof process<"u"&&process.nextTick||hb;var X={isArray:ba,isArrayBuffer:sb,isBuffer:function(t){return t!==null&&!nd(t)&&t.constructor!==null&&!nd(t.constructor)&&zi(t.constructor.isBuffer)&&t.constructor.isBuffer(t)},isFormData:t=>{let e;return t&&(typeof FormData=="function"&&t instanceof FormData||zi(t.append)&&((e=xu(t))==="formdata"||e==="object"&&zi(t.toString)&&t.toString()==="[object FormData]"))},isArrayBufferView:function(t){let e;return e=typeof ArrayBuffer<"u"&&ArrayBuffer.isView?ArrayBuffer.isView(t):t&&t.buffer&&sb(t.buffer),e},isString:iH,isNumber:ab,isBoolean:t=>t===!0||t===!1,isObject:Fu,isPlainObject:Bu,isReadableStream:cH,isRequest:dH,isResponse:lH,isHeaders:uH,isUndefined:nd,isDate:nH,isFile:rH,isBlob:oH,isRegExp:_H,isFunction:zi,isStream:t=>Fu(t)&&zi(t.pipe),isURLSearchParams:aH,isTypedArray:hH,isFileList:sH,forEach:rd,merge:function t(){let{caseless:e}=db(this)&&this||{},i={},n=(r,o)=>{let s=e&&cb(i,o)||o;Bu(i[s])&&Bu(r)?i[s]=t(i[s],r):Bu(r)?i[s]=t({},r):ba(r)?i[s]=r.slice():i[s]=r};for(let r=0,o=arguments.length;r<o;r++)arguments[r]&&rd(arguments[r],n);return i},extend:function(t,e,i){let{allOwnKeys:n}=arguments.length>3&&arguments[3]!==void 0?arguments[3]:{};return rd(e,(r,o)=>{i&&zi(r)?t[o]=rb(r,i):t[o]=r},{allOwnKeys:n}),t},trim:t=>ui(t)?ui(t).call(t):t.replace(/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,""),stripBOM:t=>(t.charCodeAt(0)===65279&&(t=t.slice(1)),t),inherits:(t,e,i,n)=>{t.prototype=Object.create(e.prototype,n),t.prototype.constructor=t,Object.defineProperty(t,"super",{value:e.prototype}),i&&Object.assign(t.prototype,i)},toFlatObject:(t,e,i,n)=>{let r,o,s,a={};if(e=e||{},t==null)return e;do{for(r=Object.getOwnPropertyNames(t),o=r.length;o-- >0;)s=r[o],n&&!n(s,t,e)||a[s]||(e[s]=t[s],a[s]=!0);t=i!==!1&&CE(t)}while(t&&(!i||i(t,e))&&t!==Object.prototype);return e},kindOf:xu,kindOfTest:Qn,endsWith:(t,e,i)=>{t=String(t),(i===void 0||i>t.length)&&(i=t.length),i-=e.length;let n=t.indexOf(e,i);return n!==-1&&n===i},toArray:t=>{if(!t)return null;if(ba(t))return t;let e=t.length;if(!ab(e))return null;let i=new Array(e);for(;e-- >0;)i[e]=t[e];return i},forEachEntry:(t,e)=>{let i=(t&&t[Uu]).call(t),n;for(;(n=i.next())&&!n.done;){let r=n.value;e.call(t,r[0],r[1])}},matchAll:(t,e)=>{let i,n=[];for(;(i=t.exec(e))!==null;)n.push(i);return n},isHTMLForm:pH,hasOwnProperty:lb,hasOwnProp:lb,reduceDescriptors:ub,freezeMethods:t=>{ub(t,(e,i)=>{if(zi(t)&&["arguments","caller","callee"].indexOf(i)!==-1)return!1;let n=t[i];zi(n)&&(e.enumerable=!1,"writable"in e?e.writable=!1:e.set||(e.set=()=>{throw Error("Can not rewrite read-only method '"+i+"'")}))})},toObjectSet:(t,e)=>{let i={},n=r=>{r.forEach(o=>{i[o]=!0})};return ba(t)?n(t):n(String(t).split(e)),i},toCamelCase:t=>t.toLowerCase().replace(/[-_\s]([a-z\d])(\w*)/g,function(e,i,n){return i.toUpperCase()+n}),noop:()=>{},toFiniteNumber:(t,e)=>t!=null&&Number.isFinite(t=+t)?t:e,findKey:cb,global:ms,isContextDefined:db,isSpecCompliantForm:function(t){return!!(t&&zi(t.append)&&t[ob]==="FormData"&&t[Uu])},toJSONObject:t=>{let e=new Array(10),i=(n,r)=>{if(Fu(n)){if(e.indexOf(n)>=0)return;if(!("toJSON"in n)){e[r]=n;let o=ba(n)?[]:{};return rd(n,(s,a)=>{let c=i(s,r+1);!nd(c)&&(o[a]=c)}),e[r]=void 0,o}}return n};return i(t,0)},isAsyncFn:mH,isThenable:t=>t&&(Fu(t)||zi(t))&&zi(t.then)&&zi(t.catch),setImmediate:hb,asap:EH,isIterable:t=>t!=null&&zi(t[Uu])};function zt(t,e,i,n,r){Error.call(this),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):this.stack=new Error().stack,this.message=t,this.name="AxiosError",e&&(this.code=e),i&&(this.config=i),n&&(this.request=n),r&&(this.response=r,this.status=r.status?r.status:null)}X.inherits(zt,Error,{toJSON:function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:X.toJSONObject(this.config),code:this.code,status:this.status}}});let mb=zt.prototype,Eb={};["ERR_BAD_OPTION_VALUE","ERR_BAD_OPTION","ECONNABORTED","ETIMEDOUT","ERR_NETWORK","ERR_FR_TOO_MANY_REDIRECTS","ERR_DEPRECATED","ERR_BAD_RESPONSE","ERR_BAD_REQUEST","ERR_CANCELED","ERR_NOT_SUPPORT","ERR_INVALID_URL"].forEach(t=>{Eb[t]={value:t}}),Object.defineProperties(zt,Eb),Object.defineProperty(mb,"isAxiosError",{value:!0}),zt.from=(t,e,i,n,r,o)=>{let s=Object.create(mb);return X.toFlatObject(t,s,function(a){return a!==Error.prototype},a=>a!=="isAxiosError"),zt.call(s,t.message,e,i,n,r),s.cause=t,s.name=t.name,o&&Object.assign(s,o),s};function wE(t){return X.isPlainObject(t)||X.isArray(t)}function fb(t){return X.endsWith(t,"[]")?t.slice(0,-2):t}function gb(t,e,i){return t?t.concat(e).map(function(n,r){return n=fb(n),!i&&r?"["+n+"]":n}).join(i?".":""):e}let fH=X.toFlatObject(X,{},null,function(t){return/^is[A-Z]/.test(t)});function Gu(t,e,i){if(!X.isObject(t))throw new TypeError("target must be an object");e=e||new FormData;let n=(i=X.toFlatObject(i,{metaTokens:!0,dots:!1,indexes:!1},!1,function(h,p){return!X.isUndefined(p[h])})).metaTokens,r=i.visitor||d,o=i.dots,s=i.indexes,a=(i.Blob||typeof Blob<"u"&&Blob)&&X.isSpecCompliantForm(e);if(!X.isFunction(r))throw new TypeError("visitor must be a function");function c(h){if(h===null)return"";if(X.isDate(h))return h.toISOString();if(!a&&X.isBlob(h))throw new zt("Blob is not supported. Use a Buffer instead.");return X.isArrayBuffer(h)||X.isTypedArray(h)?a&&typeof Blob=="function"?new Blob([h]):Buffer.from(h):h}function d(h,p,g){let E=h;if(h&&!g&&typeof h=="object"){if(X.endsWith(p,"{}"))p=n?p:p.slice(0,-2),h=JSON.stringify(h);else if(X.isArray(h)&&function(f){return X.isArray(f)&&!f.some(wE)}(h)||(X.isFileList(h)||X.endsWith(p,"[]"))&&(E=X.toArray(h)))return p=fb(p),E.forEach(function(f,R){!X.isUndefined(f)&&f!==null&&e.append(s===!0?gb([p],R,o):s===null?p:p+"[]",c(f))}),!1}return!!wE(h)||(e.append(gb(g,p,o),c(h)),!1)}let l=[],u=Object.assign(fH,{defaultVisitor:d,convertValue:c,isVisitable:wE});if(!X.isObject(t))throw new TypeError("data must be an object");return function h(p,g){if(!X.isUndefined(p)){if(l.indexOf(p)!==-1)throw Error("Circular reference detected in "+g.join("."));l.push(p),X.forEach(p,function(E,f){(!(X.isUndefined(E)||E===null)&&r.call(e,E,X.isString(f)?ui(f).call(f):f,g,u))===!0&&h(E,g?g.concat(f):[f])}),l.pop()}}(t),e}function Sb(t){let e={"!":"%21","'":"%27","(":"%28",")":"%29","~":"%7E","%20":"+","%00":"\0"};return encodeURIComponent(t).replace(/[!'()~]|%20|%00/g,function(i){return e[i]})}function OE(t,e){this._pairs=[],t&&Gu(t,this,e)}let Tb=OE.prototype;function gH(t){return encodeURIComponent(t).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}function Rb(t,e,i){if(!e)return t;let n=i&&i.encode||gH;X.isFunction(i)&&(i={serialize:i});let r=i&&i.serialize,o;if(o=r?r(e,i):X.isURLSearchParams(e)?e.toString():new OE(e,i).toString(n),o){let s=t.indexOf("#");s!==-1&&(t=t.slice(0,s)),t+=(t.indexOf("?")===-1?"?":"&")+o}return t}Tb.append=function(t,e){this._pairs.push([t,e])},Tb.toString=function(t){let e=t?function(i){return t.call(this,i,Sb)}:Sb;return this._pairs.map(function(i){return e(i[0])+"="+e(i[1])},"").join("&")};var vb=class{constructor(){this.handlers=[]}use(t,e,i){return this.handlers.push({fulfilled:t,rejected:e,synchronous:!!i&&i.synchronous,runWhen:i?i.runWhen:null}),this.handlers.length-1}eject(t){this.handlers[t]&&(this.handlers[t]=null)}clear(){this.handlers&&(this.handlers=[])}forEach(t){X.forEach(this.handlers,function(e){e!==null&&t(e)})}},yb={silentJSONParsing:!0,forcedJSONParsing:!0,clarifyTimeoutError:!1},Cb={exports:{}},SH=Ht,TH=Di,bb=yn.f;SH({target:"Object",stat:!0,forced:Object.defineProperty!==bb,sham:!TH},{defineProperty:bb});var Ib=dn.Object,RH=Cb.exports=function(t,e,i){return Ib.defineProperty(t,e,i)};Ib.defineProperty.sham&&(RH.sham=!0);var Ab=b(Cb.exports),vH=TypeError,wb=Vc,yH=au,CH=yi,bH=Pe("species"),Ob=Array,IH=function(t){var e;return wb(t)&&(e=t.constructor,(yH(e)&&(e===Ob||wb(e.prototype))||CH(e)&&(e=e[bH])===null)&&(e=void 0)),e===void 0?Ob:e},Nb=function(t,e){return new(IH(t))(e===0?0:e)},AH=O,wH=rs,OH=Pe("species"),Db=function(t){return wH>=51||!AH(function(){var e=[];return(e.constructor={})[OH]=function(){return{foo:1}},e[t](Boolean).foo!==1})},NH=Ht,DH=O,PH=Vc,LH=yi,kH=Er,MH=Co,Pb=function(t){if(t>9007199254740991)throw vH("Maximum allowed index exceeded");return t},Lb=Hm,UH=Nb,xH=Db,VH=rs,kb=Pe("isConcatSpreadable"),FH=VH>=51||!DH(function(){var t=[];return t[kb]=!1,t.concat()[0]!==t}),BH=function(t){if(!LH(t))return!1;var e=t[kb];return e!==void 0?!!e:PH(t)};NH({target:"Array",proto:!0,arity:1,forced:!FH||!xH("concat")},{concat:function(t){var e,i,n,r,o,s=kH(this),a=UH(s,0),c=0;for(e=-1,n=arguments.length;e<n;e++)if(BH(o=e===-1?s:arguments[e]))for(r=MH(o),Pb(c+r),i=0;i<r;i++,c++)i in o&&Lb(a,c,o[i]);else Pb(c+1),Lb(a,c++,o);return a.length=c,a}});var Mb={},jH=mr,GH=vo,Ub=Kl.f,WH=Ao,xb=typeof window=="object"&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];Mb.f=function(t){return xb&&jH(t)==="Window"?function(e){try{return Ub(e)}catch{return WH(xb)}}(t):Ub(GH(t))};var Ia={},HH=Pe;Ia.f=HH;var Vb=dn,KH=ai,qH=Ia,YH=yn.f,He=function(t){var e=Vb.Symbol||(Vb.Symbol={});KH(e,t)||YH(e,t,{value:qH.f(t)})},zH=ii,XH=Ci,JH=Pe,QH=Io,Fb=function(){var t=XH("Symbol"),e=t&&t.prototype,i=e&&e.valueOf,n=JH("toPrimitive");e&&!e[n]&&QH(e,n,function(r){return zH(i,this)},{arity:1})},ZH=yo,$H=Ul,t5=Er,e5=Co,i5=Nb,Bb=mt([].push),Lo=function(t){var e=t===1,i=t===2,n=t===3,r=t===4,o=t===6,s=t===7,a=t===5||o;return function(c,d,l,u){for(var h,p,g=t5(c),E=$H(g),f=e5(E),R=ZH(d,l),y=0,N=u||i5,k=e?N(c,f):i||s?N(c,0):void 0;f>y;y++)if((a||y in E)&&(p=R(h=E[y],y,g),t))if(e)k[y]=p;else if(p)switch(t){case 3:return!0;case 5:return h;case 6:return y;case 2:Bb(k,h)}else switch(t){case 4:return!1;case 7:Bb(k,h)}return o?-1:n||r?r:k}},jb={forEach:Lo(0),map:Lo(1),filter:Lo(2),some:Lo(3),every:Lo(4),find:Lo(5),findIndex:Lo(6),filterReject:Lo(7)},Wu=Ht,od=jt,NE=ii,n5=mt,Aa=Di,wa=ta,r5=O,Ei=ai,o5=Wt,DE=Fi,Hu=vo,PE=f_,s5=Yi,LE=Ro,Oa=Bc,Gb=Yl,a5=Kl,Wb=Mb,c5=Fc,Hb=Pl,Kb=yn,d5=x_,qb=kl,Yb=Io,l5=su,kE=ia,zb=ql,Xb=m_,u5=Pe,h5=Ia,p5=He,_5=Fb,m5=qr,Jb=as,Ku=jb.forEach,Xi=Hl("hidden"),qu="Symbol",sd="prototype",E5=Jb.set,Qb=Jb.getterFor(qu),Zn=Object[sd],Es=od.Symbol,Yu=Es&&Es[sd],f5=od.RangeError,g5=od.TypeError,ME=od.QObject,Zb=Hb.f,fs=Kb.f,$b=Wb.f,S5=qb.f,tI=n5([].push),Xr=kE("symbols"),ad=kE("op-symbols"),T5=kE("wks"),UE=!ME||!ME[sd]||!ME[sd].findChild,eI=function(t,e,i){var n=Zb(Zn,e);n&&delete Zn[e],fs(t,e,i),n&&t!==Zn&&fs(Zn,e,n)},xE=Aa&&r5(function(){return Oa(fs({},"a",{get:function(){return fs(this,"a",{value:7}).a}})).a!==7})?eI:fs,VE=function(t,e){var i=Xr[t]=Oa(Yu);return E5(i,{type:qu,tag:t,description:e}),Aa||(i.description=e),i},zu=function(t,e,i){t===Zn&&zu(ad,e,i),DE(t);var n=PE(e);return DE(i),Ei(Xr,n)?(i.enumerable?(Ei(t,Xi)&&t[Xi][n]&&(t[Xi][n]=!1),i=Oa(i,{enumerable:LE(0,!1)})):(Ei(t,Xi)||fs(t,Xi,LE(1,Oa(null))),t[Xi][n]=!0),xE(t,n,i)):fs(t,n,i)},FE=function(t,e){DE(t);var i=Hu(e),n=Gb(i).concat(oI(i));return Ku(n,function(r){Aa&&!NE(iI,i,r)||zu(t,r,i[r])}),t},iI=function(t){var e=PE(t),i=NE(S5,this,e);return!(this===Zn&&Ei(Xr,e)&&!Ei(ad,e))&&(!(i||!Ei(this,e)||!Ei(Xr,e)||Ei(this,Xi)&&this[Xi][e])||i)},nI=function(t,e){var i=Hu(t),n=PE(e);if(i!==Zn||!Ei(Xr,n)||Ei(ad,n)){var r=Zb(i,n);return!r||!Ei(Xr,n)||Ei(i,Xi)&&i[Xi][n]||(r.enumerable=!0),r}},rI=function(t){var e=$b(Hu(t)),i=[];return Ku(e,function(n){Ei(Xr,n)||Ei(zb,n)||tI(i,n)}),i},oI=function(t){var e=t===Zn,i=$b(e?ad:Hu(t)),n=[];return Ku(i,function(r){!Ei(Xr,r)||e&&!Ei(Zn,r)||tI(n,Xr[r])}),n};wa||(Es=function(){if(o5(Yu,this))throw new g5("Symbol is not a constructor");var t=arguments.length&&arguments[0]!==void 0?s5(arguments[0]):void 0,e=Xb(t),i=function(n){var r=this===void 0?od:this;r===Zn&&NE(i,ad,n),Ei(r,Xi)&&Ei(r[Xi],e)&&(r[Xi][e]=!1);var o=LE(1,n);try{xE(r,e,o)}catch(s){if(!(s instanceof f5))throw s;eI(r,e,o)}};return Aa&&UE&&xE(Zn,e,{configurable:!0,set:i}),VE(e,t)},Yb(Yu=Es[sd],"toString",function(){return Qb(this).tag}),Yb(Es,"withoutSetter",function(t){return VE(Xb(t),t)}),qb.f=iI,Kb.f=zu,d5.f=FE,Hb.f=nI,a5.f=Wb.f=rI,c5.f=oI,h5.f=function(t){return VE(u5(t),t)},Aa&&l5(Yu,"description",{configurable:!0,get:function(){return Qb(this).description}})),Wu({global:!0,constructor:!0,wrap:!0,forced:!wa,sham:!wa},{Symbol:Es}),Ku(Gb(T5),function(t){p5(t)}),Wu({target:qu,stat:!0,forced:!wa},{useSetter:function(){UE=!0},useSimple:function(){UE=!1}}),Wu({target:"Object",stat:!0,forced:!wa,sham:!Aa},{create:function(t,e){return e===void 0?Oa(t):FE(Oa(t),e)},defineProperty:zu,defineProperties:FE,getOwnPropertyDescriptor:nI}),Wu({target:"Object",stat:!0,forced:!wa},{getOwnPropertyNames:rI}),_5(),m5(Es,qu),zb[Xi]=!0;var sI=ta&&!!Symbol.for&&!!Symbol.keyFor,R5=Ht,v5=Ci,y5=ai,C5=Yi,aI=ia,b5=sI,BE=aI("string-to-symbol-registry"),I5=aI("symbol-to-string-registry");R5({target:"Symbol",stat:!0,forced:!b5},{for:function(t){var e=C5(t);if(y5(BE,e))return BE[e];var i=v5("Symbol")(e);return BE[e]=i,I5[i]=e,i}});var A5=Ht,w5=ai,O5=kc,N5=ea,D5=sI,cI=ia("symbol-to-string-registry");A5({target:"Symbol",stat:!0,forced:!D5},{keyFor:function(t){if(!O5(t))throw new TypeError(N5(t)+" is not a symbol");if(w5(cI,t))return cI[t]}});var dI=Vc,P5=Je,lI=mr,L5=Yi,uI=mt([].push),k5=Ht,hI=Ci,pI=Pc,M5=ii,cd=mt,_I=O,mI=Je,EI=kc,fI=Ao,U5=function(t){if(P5(t))return t;if(dI(t)){for(var e=t.length,i=[],n=0;n<e;n++){var r=t[n];typeof r=="string"?uI(i,r):typeof r!="number"&&lI(r)!=="Number"&&lI(r)!=="String"||uI(i,L5(r))}var o=i.length,s=!0;return function(a,c){if(s)return s=!1,c;if(dI(this))return c;for(var d=0;d<o;d++)if(i[d]===a)return c}}},x5=ta,V5=String,ko=hI("JSON","stringify"),Xu=cd(/./.exec),gI=cd("".charAt),F5=cd("".charCodeAt),B5=cd("".replace),j5=cd(1 .toString),G5=/[\uD800-\uDFFF]/g,SI=/^[\uD800-\uDBFF]$/,TI=/^[\uDC00-\uDFFF]$/,RI=!x5||_I(function(){var t=hI("Symbol")("stringify detection");return ko([t])!=="[null]"||ko({a:t})!=="{}"||ko(Object(t))!=="{}"}),vI=_I(function(){return ko("\uDF06\uD834")!=='"\\udf06\\ud834"'||ko("\uDEAD")!=='"\\udead"'}),W5=function(t,e){var i=fI(arguments),n=U5(e);if(mI(n)||t!==void 0&&!EI(t))return i[1]=function(r,o){if(mI(n)&&(o=M5(n,this,V5(r),o)),!EI(o))return o},pI(ko,null,i)},H5=function(t,e,i){var n=gI(i,e-1),r=gI(i,e+1);return Xu(SI,t)&&!Xu(TI,r)||Xu(TI,t)&&!Xu(SI,n)?"\\u"+j5(F5(t,0),16):t};ko&&k5({target:"JSON",stat:!0,arity:3,forced:RI||vI},{stringify:function(t,e,i){var n=fI(arguments),r=pI(RI?W5:ko,null,n);return vI&&typeof r=="string"?B5(r,G5,H5):r}});var yI=Fc,K5=Er;Ht({target:"Object",stat:!0,forced:!ta||O(function(){yI.f(1)})},{getOwnPropertySymbols:function(t){var e=yI.f;return e?e(K5(t)):[]}}),He("asyncIterator"),He("hasInstance"),He("isConcatSpreadable"),He("iterator"),He("match"),He("matchAll"),He("replace"),He("search"),He("species"),He("split");var q5=Fb;He("toPrimitive"),q5();var Y5=Ci,z5=qr;He("toStringTag"),z5(Y5("Symbol"),"Symbol"),He("unscopables"),qr(jt.JSON,"JSON",!0);var X5=dn.Symbol,J5=Pe,Q5=yn.f,CI=J5("metadata"),bI=Function.prototype;bI[CI]===void 0&&Q5(bI,CI,{value:null}),He("asyncDispose"),He("dispose"),He("metadata");var Z5=X5,$5=mt,jE=Ci("Symbol"),t4=jE.keyFor,e4=$5(jE.prototype.valueOf),II=jE.isRegisteredSymbol||function(t){try{return t4(e4(t))!==void 0}catch{return!1}};Ht({target:"Symbol",stat:!0},{isRegisteredSymbol:II});for(var i4=ia,AI=Ci,n4=mt,r4=kc,o4=Pe,Ju=AI("Symbol"),wI=Ju.isWellKnownSymbol,OI=AI("Object","getOwnPropertyNames"),s4=n4(Ju.prototype.valueOf),NI=i4("wks"),GE=0,DI=OI(Ju),a4=DI.length;GE<a4;GE++)try{var PI=DI[GE];r4(Ju[PI])&&o4(PI)}catch{}var LI=function(t){if(wI&&wI(t))return!0;try{for(var e=s4(t),i=0,n=OI(NI),r=n.length;i<r;i++)if(NI[n[i]]==e)return!0}catch{}return!1};Ht({target:"Symbol",stat:!0,forced:!0},{isWellKnownSymbol:LI}),He("customMatcher"),He("observable"),Ht({target:"Symbol",stat:!0,name:"isRegisteredSymbol"},{isRegistered:II}),Ht({target:"Symbol",stat:!0,name:"isWellKnownSymbol",forced:!0},{isWellKnown:LI}),He("matcher"),He("metadataKey"),He("patternMatch"),He("replaceAll");var Na=b(Z5),kI=b(Ia.f("iterator"));function dd(t){return dd=typeof Na=="function"&&typeof kI=="symbol"?function(e){return typeof e}:function(e){return e&&typeof Na=="function"&&e.constructor===Na&&e!==Na.prototype?"symbol":typeof e},dd(t)}var c4=b(Ia.f("toPrimitive"));function d4(t){var e=function(i,n){if(dd(i)!="object"||!i)return i;var r=i[c4];if(r!==void 0){var o=r.call(i,n||"default");if(dd(o)!="object")return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return(n==="string"?String:Number)(i)}(t,"string");return dd(e)=="symbol"?e:e+""}function T(t,e,i){return(e=d4(e))in t?Ab(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var MI=b(uW),l4={isBrowser:!0,classes:{URLSearchParams:MI!==void 0?MI:OE,FormData:typeof FormData<"u"?FormData:null,Blob:typeof Blob<"u"?Blob:null},protocols:["http","https","file","blob","url","data"]};let WE=typeof window<"u"&&typeof document<"u",HE=typeof navigator=="object"&&navigator||void 0,u4=WE&&(!HE||["ReactNative","NativeScript","NS"].indexOf(HE.product)<0),h4=typeof WorkerGlobalScope<"u"&&self instanceof WorkerGlobalScope&&typeof self.importScripts=="function",p4=WE&&window.location.href||"http://localhost";function UI(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function xI(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?UI(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):UI(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}var Pi=xI(xI({},Object.freeze({__proto__:null,hasBrowserEnv:WE,hasStandardBrowserEnv:u4,hasStandardBrowserWebWorkerEnv:h4,navigator:HE,origin:p4})),l4),_4=Fi,m4=ii,E4=ai,f4=Wt,g4=function(){var t=_4(this),e="";return t.hasIndices&&(e+="d"),t.global&&(e+="g"),t.ignoreCase&&(e+="i"),t.multiline&&(e+="m"),t.dotAll&&(e+="s"),t.unicode&&(e+="u"),t.unicodeSets&&(e+="v"),t.sticky&&(e+="y"),e},VI=RegExp.prototype,FI=function(t){var e=t.flags;return e!==void 0||"flags"in VI||E4(t,"flags")||!f4(VI,t)?e:m4(g4,t)},S4=Nm.charAt,BI=ii,T4=Fi,R4=Je,v4=mr,y4=/./.exec,C4=TypeError,b4=Ht,jI=ii,GI=Lc,I4=Q_,Qu=ru,WI=ns,HI=GT,ld=Yi,A4=Fi,w4=yi,O4=mr,N4=HT,KI=FI,D4=Vl,P4=O,L4=nm,k4=function(t,e,i){return e+(i?S4(t,e).length:1)},M4=function(t,e){var i=t.exec;if(R4(i)){var n=BI(i,t,e);return n!==null&&T4(n),n}if(v4(t)==="RegExp")return BI(y4,t,e);throw new C4("RegExp#exec called on incompatible receiver")},qI=as,U4=Pe("matchAll"),YI="RegExp String",zI=YI+" Iterator",x4=qI.set,V4=qI.getterFor(zI),F4=TypeError,KE=GI("".indexOf),Zu=GI("".matchAll),qE=!!Zu&&!P4(function(){Zu("a",/./)}),B4=I4(function(t,e,i,n){x4(this,{type:zI,regexp:t,string:e,global:i,unicode:n,done:!1})},YI,function(){var t=V4(this);if(t.done)return Qu(void 0,!0);var e=t.regexp,i=t.string,n=M4(e,i);return n===null?(t.done=!0,Qu(void 0,!0)):t.global?(ld(n[0])===""&&(e.lastIndex=k4(i,HI(e.lastIndex),t.unicode)),Qu(n,!1)):(t.done=!0,Qu(n,!1))}),XI=function(t){var e,i,n,r=A4(this),o=ld(t),s=L4(r,RegExp),a=ld(KI(r));return e=new s(s===RegExp?r.source:r,a),i=!!~KE(a,"g"),n=!!~KE(a,"u"),e.lastIndex=HI(r.lastIndex),new B4(e,o,i,n)};b4({target:"String",proto:!0,forced:qE},{matchAll:function(t){var e,i,n,r,o=WI(this);if(w4(t)){if(N4(t)&&(e=ld(WI(KI(t))),!~KE(e,"g")))throw new F4("`.matchAll` does not allow non-global regexes");if(qE)return Zu(o,t);if((n=D4(t,U4))===void 0&&O4(t)==="RegExp"&&(n=XI),n)return jI(n,t,o)}else if(qE)return Zu(o,t);return i=ld(o),r=new RegExp(t,"g"),jI(XI,r,i)}});var j4=Cn("String","matchAll"),G4=Wt,W4=j4,YE=String.prototype,H4=function(t){var e=t.matchAll;return typeof t=="string"||t===YE||G4(YE,t)&&e===YE.matchAll?W4:e},K4=b(H4);function JI(t){function e(i,n,r,o){let s=i[o++];if(s==="__proto__")return!0;let a=Number.isFinite(+s),c=o>=i.length;return s=!s&&X.isArray(r)?r.length:s,c?(X.hasOwnProp(r,s)?r[s]=[r[s],n]:r[s]=n,!a):(r[s]&&X.isObject(r[s])||(r[s]=[]),e(i,n,r[s],o)&&X.isArray(r[s])&&(r[s]=function(d){let l={},u=Object.keys(d),h,p=u.length,g;for(h=0;h<p;h++)g=u[h],l[g]=d[g];return l}(r[s])),!a)}if(X.isFormData(t)&&X.isFunction(t.entries)){let i={};return X.forEachEntry(t,(n,r)=>{e(function(o){return K4(X).call(X,/\w+|\[(\w*)]/g,o).map(s=>s[0]==="[]"?"":s[1]||s[0])}(n),r,i,0)}),i}return null}let zE={transitional:yb,adapter:["xhr","http","fetch"],transformRequest:[function(t,e){let i=e.getContentType()||"",n=i.indexOf("application/json")>-1,r=X.isObject(t);if(r&&X.isHTMLForm(t)&&(t=new FormData(t)),X.isFormData(t))return n?JSON.stringify(JI(t)):t;if(X.isArrayBuffer(t)||X.isBuffer(t)||X.isStream(t)||X.isFile(t)||X.isBlob(t)||X.isReadableStream(t))return t;if(X.isArrayBufferView(t))return t.buffer;if(X.isURLSearchParams(t))return e.setContentType("application/x-www-form-urlencoded;charset=utf-8",!1),t.toString();let o;if(r){if(i.indexOf("application/x-www-form-urlencoded")>-1)return function(s,a){return Gu(s,new Pi.classes.URLSearchParams,Object.assign({visitor:function(c,d,l,u){return Pi.isNode&&X.isBuffer(c)?(this.append(d,c.toString("base64")),!1):u.defaultVisitor.apply(this,arguments)}},a))}(t,this.formSerializer).toString();if((o=X.isFileList(t))||i.indexOf("multipart/form-data")>-1){let s=this.env&&this.env.FormData;return Gu(o?{"files[]":t}:t,s&&new s,this.formSerializer)}}return r||n?(e.setContentType("application/json",!1),function(s,a,c){if(X.isString(s))try{return(a||JSON.parse)(s),ui(X).call(X,s)}catch(d){if(d.name!=="SyntaxError")throw d}return(c||JSON.stringify)(s)}(t)):t}],transformResponse:[function(t){let e=this.transitional||zE.transitional,i=e&&e.forcedJSONParsing,n=this.responseType==="json";if(X.isResponse(t)||X.isReadableStream(t))return t;if(t&&X.isString(t)&&(i&&!this.responseType||n)){let r=!(e&&e.silentJSONParsing)&&n;try{return JSON.parse(t)}catch(o){if(r)throw o.name==="SyntaxError"?zt.from(o,zt.ERR_BAD_RESPONSE,this,null,this.response):o}}return t}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,env:{FormData:Pi.classes.FormData,Blob:Pi.classes.Blob},validateStatus:function(t){return t>=200&&t<300},headers:{common:{Accept:"application/json, text/plain, */*","Content-Type":void 0}}};X.forEach(["delete","get","head","post","put","patch"],t=>{zE.headers[t]={}});var XE=zE;let q4=X.toObjectSet(["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"]),QI=Symbol("internals");function ud(t){var e;return t&&ui(e=String(t)).call(e).toLowerCase()}function $u(t){return t===!1||t==null?t:X.isArray(t)?t.map($u):String(t)}function JE(t,e,i,n,r){return X.isFunction(n)?n.call(this,e,i):(r&&(e=i),X.isString(e)?X.isString(n)?e.indexOf(n)!==-1:X.isRegExp(n)?n.test(e):void 0:void 0)}class th{constructor(e){e&&this.set(e)}set(e,i,n){let r=this;function o(c,d,l){let u=ud(d);if(!u)throw new Error("header name must be a non-empty string");let h=X.findKey(r,u);(!h||r[h]===void 0||l===!0||l===void 0&&r[h]!==!1)&&(r[h||d]=$u(c))}let s=(c,d)=>X.forEach(c,(l,u)=>o(l,u,d));if(X.isPlainObject(e)||e instanceof this.constructor)s(e,i);else if(X.isString(e)&&(e=ui(e).call(e))&&!/^[-_a-zA-Z0-9^`|~,!#$%&'*+.]+$/.test(ui(a=e).call(a)))s((c=>{let d={},l,u,h;return c&&c.split(`
`).forEach(function(p){var g,E;h=p.indexOf(":"),l=ui(g=p.substring(0,h)).call(g).toLowerCase(),u=ui(E=p.substring(h+1)).call(E),!l||d[l]&&q4[l]||(l==="set-cookie"?d[l]?d[l].push(u):d[l]=[u]:d[l]=d[l]?d[l]+", "+u:u)}),d})(e),i);else if(X.isObject(e)&&X.isIterable(e)){let c,d,l={};for(let u of e){if(!X.isArray(u))throw TypeError("Object iterator must return a key-value pair");l[d=u[0]]=(c=l[d])?X.isArray(c)?[...c,u[1]]:[c,u[1]]:u[1]}s(l,i)}else e!=null&&o(i,e,n);var a;return this}get(e,i){if(e=ud(e)){let n=X.findKey(this,e);if(n){let r=this[n];if(!i)return r;if(i===!0)return function(o){let s=Object.create(null),a=/([^\s,;=]+)\s*(?:=\s*([^,;]+))?/g,c;for(;c=a.exec(o);)s[c[1]]=c[2];return s}(r);if(X.isFunction(i))return i.call(this,r,n);if(X.isRegExp(i))return i.exec(r);throw new TypeError("parser must be boolean|regexp|function")}}}has(e,i){if(e=ud(e)){let n=X.findKey(this,e);return!(!n||this[n]===void 0||i&&!JE(0,this[n],n,i))}return!1}delete(e,i){let n=this,r=!1;function o(s){if(s=ud(s)){let a=X.findKey(n,s);!a||i&&!JE(0,n[a],a,i)||(delete n[a],r=!0)}}return X.isArray(e)?e.forEach(o):o(e),r}clear(e){let i=Object.keys(this),n=i.length,r=!1;for(;n--;){let o=i[n];e&&!JE(0,this[o],o,e,!0)||(delete this[o],r=!0)}return r}normalize(e){let i=this,n={};return X.forEach(this,(r,o)=>{var s;let a=X.findKey(n,o);if(a)return i[a]=$u(r),void delete i[o];let c=e?function(d){return ui(d).call(d).toLowerCase().replace(/([a-z\d])(\w*)/g,(l,u,h)=>u.toUpperCase()+h)}(o):ui(s=String(o)).call(s);c!==o&&delete i[o],i[c]=$u(r),n[c]=!0}),this}concat(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return this.constructor.concat(this,...i)}toJSON(e){let i=Object.create(null);return X.forEach(this,(n,r)=>{n!=null&&n!==!1&&(i[r]=e&&X.isArray(n)?n.join(", "):n)}),i}[Symbol.iterator](){return Object.entries(this.toJSON())[Symbol.iterator]()}toString(){return Object.entries(this.toJSON()).map(e=>{let[i,n]=e;return i+": "+n}).join(`
`)}getSetCookie(){return this.get("set-cookie")||[]}get[Symbol.toStringTag](){return"AxiosHeaders"}static from(e){return e instanceof this?e:new this(e)}static concat(e){let i=new this(e);for(var n=arguments.length,r=new Array(n>1?n-1:0),o=1;o<n;o++)r[o-1]=arguments[o];return r.forEach(s=>i.set(s)),i}static accessor(e){let i=(this[QI]=this[QI]={accessors:{}}).accessors,n=this.prototype;function r(o){let s=ud(o);i[s]||(function(a,c){let d=X.toCamelCase(" "+c);["get","set","has"].forEach(l=>{Object.defineProperty(a,l+d,{value:function(u,h,p){return this[l].call(this,c,u,h,p)},configurable:!0})})}(n,o),i[s]=!0)}return X.isArray(e)?e.forEach(r):r(e),this}}th.accessor(["Content-Type","Content-Length","Accept","Accept-Encoding","User-Agent","Authorization"]),X.reduceDescriptors(th.prototype,(t,e)=>{let{value:i}=t,n=e[0].toUpperCase()+e.slice(1);return{get:()=>i,set(r){this[n]=r}}}),X.freezeMethods(th);var $n=th;function QE(t,e){let i=this||XE,n=e||i,r=$n.from(n.headers),o=n.data;return X.forEach(t,function(s){o=s.call(i,o,r.normalize(),e?e.status:void 0)}),r.normalize(),o}function ZI(t){return!(!t||!t.__CANCEL__)}function Da(t,e,i){zt.call(this,t??"canceled",zt.ERR_CANCELED,e,i),this.name="CanceledError"}function $I(t,e,i){let n=i.config.validateStatus;i.status&&n&&!n(i.status)?e(new zt("Request failed with status code "+i.status,[zt.ERR_BAD_REQUEST,zt.ERR_BAD_RESPONSE][Math.floor(i.status/100)-4],i.config,i.request,i)):t(i)}X.inherits(Da,zt,{__CANCEL__:!0});let eh=function(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:3,n=0,r=function(o,s){o=o||10;let a=new Array(o),c=new Array(o),d,l=0,u=0;return s=s!==void 0?s:1e3,function(h){let p=Date.now(),g=c[u];d||(d=p),a[l]=h,c[l]=p;let E=u,f=0;for(;E!==l;)f+=a[E++],E%=o;if(l=(l+1)%o,l===u&&(u=(u+1)%o),p-d<s)return;let R=g&&p-g;return R?Math.round(1e3*f/R):void 0}}(50,250);return function(o,s){let a,c,d=0,l=1e3/s,u=function(h){d=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Date.now(),a=null,c&&(clearTimeout(c),c=null),o.apply(null,h)};return[function(){let h=Date.now(),p=h-d;for(var g=arguments.length,E=new Array(g),f=0;f<g;f++)E[f]=arguments[f];p>=l?u(E,h):(a=E,c||(c=setTimeout(()=>{c=null,u(a)},l-p)))},()=>a&&u(a)]}(o=>{let s=o.loaded,a=o.lengthComputable?o.total:void 0,c=s-n,d=r(c);n=s,t({loaded:s,total:a,progress:a?s/a:void 0,bytes:c,rate:d||void 0,estimated:d&&a&&s<=a?(a-s)/d:void 0,event:o,lengthComputable:a!=null,[e?"download":"upload"]:!0})},i)},tA=(t,e)=>{let i=t!=null;return[n=>e[0]({lengthComputable:i,total:t,loaded:n}),e[1]]},eA=t=>function(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];return X.asap(()=>t(...i))};var Y4=Pi.hasStandardBrowserEnv?((t,e)=>i=>(i=new Ou(i,Pi.origin),t.protocol===i.protocol&&t.host===i.host&&(e||t.port===i.port)))(new Ou(Pi.origin),Pi.navigator&&/(msie|trident)/i.test(Pi.navigator.userAgent)):()=>!0,z4=Pi.hasStandardBrowserEnv?{write(t,e,i,n,r,o){let s=[t+"="+encodeURIComponent(e)];X.isNumber(i)&&s.push("expires="+new Date(i).toGMTString()),X.isString(n)&&s.push("path="+n),X.isString(r)&&s.push("domain="+r),o===!0&&s.push("secure"),document.cookie=s.join("; ")},read(t){let e=document.cookie.match(new RegExp("(^|;\\s*)("+t+")=([^;]*)"));return e?decodeURIComponent(e[3]):null},remove(t){this.write(t,"",Date.now()-864e5)}}:{write(){},read:()=>null,remove(){}};function iA(t,e,i){let n=!function(r){return/^([a-z][a-z\d+\-.]*:)?\/\//i.test(r)}(e);return t&&(n||i==0)?function(r,o){return o?r.replace(/\/?\/$/,"")+"/"+o.replace(/^\/+/,""):r}(t,e):e}function nA(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}let rA=t=>t instanceof $n?function(e){for(var i=1;i<arguments.length;i++){var n=arguments[i]!=null?arguments[i]:{};i%2?nA(Object(n),!0).forEach(function(r){T(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nA(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}({},t):t;function gs(t,e){e=e||{};let i={};function n(d,l,u,h){return X.isPlainObject(d)&&X.isPlainObject(l)?X.merge.call({caseless:h},d,l):X.isPlainObject(l)?X.merge({},l):X.isArray(l)?l.slice():l}function r(d,l,u,h){return X.isUndefined(l)?X.isUndefined(d)?void 0:n(void 0,d,0,h):n(d,l,0,h)}function o(d,l){if(!X.isUndefined(l))return n(void 0,l)}function s(d,l){return X.isUndefined(l)?X.isUndefined(d)?void 0:n(void 0,d):n(void 0,l)}function a(d,l,u){return u in e?n(d,l):u in t?n(void 0,d):void 0}let c={url:o,method:o,data:o,baseURL:s,transformRequest:s,transformResponse:s,paramsSerializer:s,timeout:s,timeoutMessage:s,withCredentials:s,withXSRFToken:s,adapter:s,responseType:s,xsrfCookieName:s,xsrfHeaderName:s,onUploadProgress:s,onDownloadProgress:s,decompress:s,maxContentLength:s,maxBodyLength:s,beforeRedirect:s,transport:s,httpAgent:s,httpsAgent:s,cancelToken:s,socketPath:s,responseEncoding:s,validateStatus:a,headers:(d,l,u)=>r(rA(d),rA(l),0,!0)};return X.forEach(Object.keys(Object.assign({},t,e)),function(d){let l=c[d]||r,u=l(t[d],e[d],d);X.isUndefined(u)&&l!==a||(i[d]=u)}),i}var oA=t=>{let e=gs({},t),i,{data:n,withXSRFToken:r,xsrfHeaderName:o,xsrfCookieName:s,headers:a,auth:c}=e;if(e.headers=a=$n.from(a),e.url=Rb(iA(e.baseURL,e.url,e.allowAbsoluteUrls),t.params,t.paramsSerializer),c&&a.set("Authorization","Basic "+btoa((c.username||"")+":"+(c.password?unescape(encodeURIComponent(c.password)):""))),X.isFormData(n)){if(Pi.hasStandardBrowserEnv||Pi.hasStandardBrowserWebWorkerEnv)a.setContentType(void 0);else if((i=a.getContentType())!==!1){let[d,...l]=i?i.split(";").map(u=>ui(u).call(u)).filter(Boolean):[];a.setContentType([d||"multipart/form-data",...l].join("; "))}}if(Pi.hasStandardBrowserEnv&&(r&&X.isFunction(r)&&(r=r(e)),r||r!==!1&&Y4(e.url))){let d=o&&s&&z4.read(s);d&&a.set(o,d)}return e},X4=typeof XMLHttpRequest<"u"&&function(t){return new Q(function(e,i){let n=oA(t),r=n.data,o=$n.from(n.headers).normalize(),s,a,c,d,l,{responseType:u,onUploadProgress:h,onDownloadProgress:p}=n;function g(){d&&d(),l&&l(),n.cancelToken&&n.cancelToken.unsubscribe(s),n.signal&&n.signal.removeEventListener("abort",s)}let E=new XMLHttpRequest;function f(){if(!E)return;let y=$n.from("getAllResponseHeaders"in E&&E.getAllResponseHeaders());$I(function(N){e(N),g()},function(N){i(N),g()},{data:u&&u!=="text"&&u!=="json"?E.response:E.responseText,status:E.status,statusText:E.statusText,headers:y,config:t,request:E}),E=null}E.open(n.method.toUpperCase(),n.url,!0),E.timeout=n.timeout,"onloadend"in E?E.onloadend=f:E.onreadystatechange=function(){E&&E.readyState===4&&(E.status!==0||E.responseURL&&E.responseURL.indexOf("file:")===0)&&setTimeout(f)},E.onabort=function(){E&&(i(new zt("Request aborted",zt.ECONNABORTED,t,E)),E=null)},E.onerror=function(){i(new zt("Network Error",zt.ERR_NETWORK,t,E)),E=null},E.ontimeout=function(){let y=n.timeout?"timeout of "+n.timeout+"ms exceeded":"timeout exceeded",N=n.transitional||yb;n.timeoutErrorMessage&&(y=n.timeoutErrorMessage),i(new zt(y,N.clarifyTimeoutError?zt.ETIMEDOUT:zt.ECONNABORTED,t,E)),E=null},r===void 0&&o.setContentType(null),"setRequestHeader"in E&&X.forEach(o.toJSON(),function(y,N){E.setRequestHeader(N,y)}),X.isUndefined(n.withCredentials)||(E.withCredentials=!!n.withCredentials),u&&u!=="json"&&(E.responseType=n.responseType),p&&([c,l]=eh(p,!0),E.addEventListener("progress",c)),h&&E.upload&&([a,d]=eh(h),E.upload.addEventListener("progress",a),E.upload.addEventListener("loadend",d)),(n.cancelToken||n.signal)&&(s=y=>{E&&(i(!y||y.type?new Da(null,t,E):y),E.abort(),E=null)},n.cancelToken&&n.cancelToken.subscribe(s),n.signal&&(n.signal.aborted?s():n.signal.addEventListener("abort",s)));let R=function(y){let N=/^([-+\w]{1,25})(:?\/\/|:)/.exec(y);return N&&N[1]||""}(n.url);R&&Pi.protocols.indexOf(R)===-1?i(new zt("Unsupported protocol "+R+":",zt.ERR_BAD_REQUEST,t)):E.send(r||null)})},J4=(t,e)=>{let{length:i}=t=t?t.filter(Boolean):[];if(e||i){let n,r=new AbortController,o=function(d){if(!n){n=!0,a();let l=d instanceof Error?d:this.reason;r.abort(l instanceof zt?l:new Da(l instanceof Error?l.message:l))}},s=e&&setTimeout(()=>{s=null,o(new zt("timeout ".concat(e," of ms exceeded"),zt.ETIMEDOUT))},e),a=()=>{t&&(s&&clearTimeout(s),s=null,t.forEach(d=>{d.unsubscribe?d.unsubscribe(o):d.removeEventListener("abort",o)}),t=null)};t.forEach(d=>d.addEventListener("abort",o));let{signal:c}=r;return c.unsubscribe=()=>X.asap(a),c}},ZE=b(qv),sA=Ia.f("asyncIterator"),Q4=b(sA);function $E(t,e){this.v=t,this.k=e}function un(t){return function(){return new hd(t.apply(this,arguments))}}function hd(t){var e,i;function n(o,s){try{var a=t[o](s),c=a.value,d=c instanceof $E;ZE.resolve(d?c.v:c).then(function(l){if(d){var u=o==="return"?"return":"next";if(!c.k||l.done)return n(u,l);l=t[u](l).value}r(a.done?"return":"normal",l)},function(l){n("throw",l)})}catch(l){r("throw",l)}}function r(o,s){switch(o){case"return":e.resolve({value:s,done:!0});break;case"throw":e.reject(s);break;default:e.resolve({value:s,done:!1})}(e=e.next)?n(e.key,e.arg):i=null}this._invoke=function(o,s){return new ZE(function(a,c){var d={key:o,arg:s,resolve:a,reject:c,next:null};i?i=i.next=d:(e=i=d,n(o,s))})},typeof t.return!="function"&&(this.return=void 0)}function Lt(t){return new $E(t,0)}function ih(t){var e={},i=!1;function n(r,o){return i=!0,o=new ZE(function(s){s(t[r](o))}),{done:!1,value:new $E(o,1)}}return e[Na!==void 0&&kI||"@@iterator"]=function(){return this},e.next=function(r){return i?(i=!1,r):n("next",r)},typeof t.throw=="function"&&(e.throw=function(r){if(i)throw i=!1,r;return n("throw",r)}),typeof t.return=="function"&&(e.return=function(r){return i?(i=!1,r):n("return",r)}),e}hd.prototype[typeof Na=="function"&&Q4||"@@asyncIterator"]=function(){return this},hd.prototype.next=function(t){return this._invoke("next",t)},hd.prototype.throw=function(t){return this._invoke("throw",t)},hd.prototype.return=function(t){return this._invoke("return",t)};var tf=b(sA);function ef(t){var e,i,n,r=2;for(typeof Symbol<"u"&&(i=tf,n=Symbol.iterator);r--;){if(i&&(e=t[i])!=null)return e.call(t);if(n&&(e=t[n])!=null)return new nh(e.call(t));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function nh(t){function e(i){if(Object(i)!==i)return Q.reject(new TypeError(i+" is not an object."));var n=i.done;return Q.resolve(i.value).then(function(r){return{value:r,done:n}})}return nh=function(i){this.s=i,this.n=i.next},nh.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(i){var n=this.s.return;return n===void 0?Q.resolve({value:i,done:!0}):e(n.apply(this.s,arguments))},throw:function(i){var n=this.s.return;return n===void 0?Q.reject(i):e(n.apply(this.s,arguments))}},new nh(t)}let Z4=function*(t,e){let i=t.byteLength;if(!e||i<e)return void(yield t);let n,r=0;for(;r<i;)n=r+e,yield t.slice(r,n),r=n},$4=function(){var t=un(function*(e,i){var n,r=!1,o=!1;try{for(var s,a=ef(tK(e));r=!(s=yield Lt(a.next())).done;r=!1){let c=s.value;yield*dl(ih(ef(Z4(c,i))))}}catch(c){o=!0,n=c}finally{try{r&&a.return!=null&&(yield Lt(a.return()))}finally{if(o)throw n}}});return function(e,i){return t.apply(this,arguments)}}(),tK=function(){var t=un(function*(e){if(e[tf])return void(yield*dl(ih(ef(e))));let i=e.getReader();try{for(;;){let{done:n,value:r}=yield Lt(i.read());if(n)break;yield r}}finally{yield Lt(i.cancel())}});return function(e){return t.apply(this,arguments)}}(),aA=(t,e,i,n)=>{let r=$4(t,e),o,s=0,a=d=>{o||(o=!0,n&&n(d))};return new ReadableStream({pull(d){return I(this,null,function*(){try{let{done:l,value:u}=yield r.next();if(l)return a(),void d.close();let h=u.byteLength;if(i){let p=s+=h;i(p)}d.enqueue(new Uint8Array(u))}catch(l){throw a(l),l}})},cancel:d=>(a(d),r.return())},{highWaterMark:2})};function cA(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function dA(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?cA(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):cA(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let rh=typeof fetch=="function"&&typeof Request=="function"&&typeof Response=="function",lA=rh&&typeof ReadableStream=="function",eK=rh&&(typeof TextEncoder=="function"?(uA=new TextEncoder,t=>uA.encode(t)):t=>I(null,null,function*(){return new Uint8Array(yield new Response(t).arrayBuffer())}));var uA;let hA=function(t){try{for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];return!!t(...i)}catch{return!1}},iK=lA&&hA(()=>{let t=!1,e=new Request(Pi.origin,{body:new ReadableStream,method:"POST",get duplex(){return t=!0,"half"}}).headers.has("Content-Type");return t&&!e}),nf=lA&&hA(()=>X.isReadableStream(new Response("").body)),oh={stream:nf&&(t=>t.body)};var pA;rh&&(pA=new Response,["text","arrayBuffer","blob","formData","stream"].forEach(t=>{!oh[t]&&(oh[t]=X.isFunction(pA[t])?e=>e[t]():(e,i)=>{throw new zt("Response type '".concat(t,"' is not supported"),zt.ERR_NOT_SUPPORT,i)})}));let nK=(t,e)=>I(null,null,function*(){let i=X.toFiniteNumber(t.getContentLength());return i??(n=>I(null,null,function*(){return n==null?0:X.isBlob(n)?n.size:X.isSpecCompliantForm(n)?(yield new Request(Pi.origin,{method:"POST",body:n}).arrayBuffer()).byteLength:X.isArrayBufferView(n)||X.isArrayBuffer(n)?n.byteLength:(X.isURLSearchParams(n)&&(n+=""),X.isString(n)?(yield eK(n)).byteLength:void 0)}))(e)});var rK=rh&&(t=>I(null,null,function*(){let{url:e,method:i,data:n,signal:r,cancelToken:o,timeout:s,onDownloadProgress:a,onUploadProgress:c,responseType:d,headers:l,withCredentials:u="same-origin",fetchOptions:h}=oA(t);d=d?(d+"").toLowerCase():"text";let p,g=J4([r,o&&o.toAbortSignal()],s),E=g&&g.unsubscribe&&(()=>{g.unsubscribe()}),f;try{if(c&&iK&&i!=="get"&&i!=="head"&&(f=yield nK(l,n))!==0){let L,P=new Request(e,{method:"POST",body:n,duplex:"half"});if(X.isFormData(n)&&(L=P.headers.get("content-type"))&&l.setContentType(L),P.body){let[V,B]=tA(f,eh(eA(c)));n=aA(P.body,65536,V,B)}}X.isString(u)||(u=u?"include":"omit");let R="credentials"in Request.prototype;p=new Request(e,dA(dA({},h),{},{signal:g,method:i.toUpperCase(),headers:l.normalize().toJSON(),body:n,duplex:"half",credentials:R?u:void 0}));let y=yield fetch(p),N=nf&&(d==="stream"||d==="response");if(nf&&(a||N&&E)){let L={};["status","statusText","headers"].forEach(Y=>{L[Y]=y[Y]});let P=X.toFiniteNumber(y.headers.get("content-length")),[V,B]=a&&tA(P,eh(eA(a),!0))||[];y=new Response(aA(y.body,65536,V,()=>{B&&B(),E&&E()}),L)}d=d||"text";let k=yield oh[X.findKey(oh,d)||"text"](y,t);return!N&&E&&E(),yield new Q((L,P)=>{$I(L,P,{data:k,headers:$n.from(y.headers),status:y.status,statusText:y.statusText,config:t,request:p})})}catch(R){throw E&&E(),R&&R.name==="TypeError"&&/Load failed|fetch/i.test(R.message)?Object.assign(new zt("Network Error",zt.ERR_NETWORK,t,p),{cause:R.cause||R}):zt.from(R,R&&R.code,t,p)}}));let rf={http:null,xhr:X4,fetch:rK};X.forEach(rf,(t,e)=>{if(t){try{Object.defineProperty(t,"name",{value:e})}catch{}Object.defineProperty(t,"adapterName",{value:e})}});let _A=t=>"- ".concat(t),oK=t=>X.isFunction(t)||t===null||t===!1;var mA={getAdapter:t=>{t=X.isArray(t)?t:[t];let{length:e}=t,i,n,r={};for(let o=0;o<e;o++){let s;if(i=t[o],n=i,!oK(i)&&(n=rf[(s=String(i)).toLowerCase()],n===void 0))throw new zt("Unknown adapter '".concat(s,"'"));if(n)break;r[s||"#"+o]=n}if(!n){let o=Object.entries(r).map(s=>{let[a,c]=s;return"adapter ".concat(a," ")+(c===!1?"is not supported by the environment":"is not available in the build")});throw new zt("There is no suitable adapter to dispatch the request "+(e?o.length>1?`since :
`+o.map(_A).join(`
`):" "+_A(o[0]):"as no adapter specified"),"ERR_NOT_SUPPORT")}return n},adapters:rf};function of(t){if(t.cancelToken&&t.cancelToken.throwIfRequested(),t.signal&&t.signal.aborted)throw new Da(null,t)}function EA(t){return of(t),t.headers=$n.from(t.headers),t.data=QE.call(t,t.transformRequest),["post","put","patch"].indexOf(t.method)!==-1&&t.headers.setContentType("application/x-www-form-urlencoded",!1),mA.getAdapter(t.adapter||XE.adapter)(t).then(function(e){return of(t),e.data=QE.call(t,t.transformResponse,e),e.headers=$n.from(e.headers),e},function(e){return ZI(e)||(of(t),e&&e.response&&(e.response.data=QE.call(t,t.transformResponse,e.response),e.response.headers=$n.from(e.response.headers))),Q.reject(e)})}let fA="1.9.0",sh={};["object","boolean","number","function","string","symbol"].forEach((t,e)=>{sh[t]=function(i){return typeof i===t||"a"+(e<1?"n ":" ")+t}});let gA={};sh.transitional=function(t,e,i){function n(r,o){return"[Axios v"+fA+"] Transitional option '"+r+"'"+o+(i?". "+i:"")}return(r,o,s)=>{if(t===!1)throw new zt(n(o," has been removed"+(e?" in "+e:"")),zt.ERR_DEPRECATED);return e&&!gA[o]&&(gA[o]=!0,console.warn(n(o," has been deprecated since v"+e+" and will be removed in the near future"))),!t||t(r,o,s)}},sh.spelling=function(t){return(e,i)=>(console.warn("".concat(i," is likely a misspelling of ").concat(t)),!0)};var ah={assertOptions:function(t,e,i){if(typeof t!="object")throw new zt("options must be an object",zt.ERR_BAD_OPTION_VALUE);let n=Object.keys(t),r=n.length;for(;r-- >0;){let o=n[r],s=e[o];if(s){let a=t[o],c=a===void 0||s(a,o,t);if(c!==!0)throw new zt("option "+o+" must be "+c,zt.ERR_BAD_OPTION_VALUE)}else if(i!==!0)throw new zt("Unknown option "+o,zt.ERR_BAD_OPTION)}},validators:sh};let Tr=ah.validators,ch=class{constructor(t){this.defaults=t||{},this.interceptors={request:new vb,response:new vb}}request(t,e){return I(this,null,function*(){try{return yield this._request(t,e)}catch(i){if(i instanceof Error){let n={};Error.captureStackTrace?Error.captureStackTrace(n):n=new Error;let r=n.stack?n.stack.replace(/^.+\n/,""):"";try{i.stack?r&&!String(i.stack).endsWith(r.replace(/^.+\n.+\n/,""))&&(i.stack+=`
`+r):i.stack=r}catch{}}throw i}})}_request(t,e){typeof t=="string"?(e=e||{}).url=t:e=t||{},e=gs(this.defaults,e);let{transitional:i,paramsSerializer:n,headers:r}=e;i!==void 0&&ah.assertOptions(i,{silentJSONParsing:Tr.transitional(Tr.boolean),forcedJSONParsing:Tr.transitional(Tr.boolean),clarifyTimeoutError:Tr.transitional(Tr.boolean)},!1),n!=null&&(X.isFunction(n)?e.paramsSerializer={serialize:n}:ah.assertOptions(n,{encode:Tr.function,serialize:Tr.function},!0)),e.allowAbsoluteUrls!==void 0||(this.defaults.allowAbsoluteUrls!==void 0?e.allowAbsoluteUrls=this.defaults.allowAbsoluteUrls:e.allowAbsoluteUrls=!0),ah.assertOptions(e,{baseUrl:Tr.spelling("baseURL"),withXsrfToken:Tr.spelling("withXSRFToken")},!0),e.method=(e.method||this.defaults.method||"get").toLowerCase();let o=r&&X.merge(r.common,r[e.method]);r&&X.forEach(["delete","get","head","post","put","patch","common"],p=>{delete r[p]}),e.headers=$n.concat(o,r);let s=[],a=!0;this.interceptors.request.forEach(function(p){typeof p.runWhen=="function"&&p.runWhen(e)===!1||(a=a&&p.synchronous,s.unshift(p.fulfilled,p.rejected))});let c=[],d;this.interceptors.response.forEach(function(p){c.push(p.fulfilled,p.rejected)});let l,u=0;if(!a){let p=[EA.bind(this),void 0];for(p.unshift.apply(p,s),p.push.apply(p,c),l=p.length,d=Q.resolve(e);u<l;)d=d.then(p[u++],p[u++]);return d}l=s.length;let h=e;for(u=0;u<l;){let p=s[u++],g=s[u++];try{h=p(h)}catch(E){g.call(this,E);break}}try{d=EA.call(this,h)}catch(p){return Q.reject(p)}for(u=0,l=c.length;u<l;)d=d.then(c[u++],c[u++]);return d}getUri(t){return Rb(iA((t=gs(this.defaults,t)).baseURL,t.url,t.allowAbsoluteUrls),t.params,t.paramsSerializer)}};X.forEach(["delete","get","head","options"],function(t){ch.prototype[t]=function(e,i){return this.request(gs(i||{},{method:t,url:e,data:(i||{}).data}))}}),X.forEach(["post","put","patch"],function(t){function e(i){return function(n,r,o){return this.request(gs(o||{},{method:t,headers:i?{"Content-Type":"multipart/form-data"}:{},url:n,data:r}))}}ch.prototype[t]=e(),ch.prototype[t+"Form"]=e(!0)});var dh=ch;class sf{constructor(e){if(typeof e!="function")throw new TypeError("executor must be a function.");let i;this.promise=new Q(function(r){i=r});let n=this;this.promise.then(r=>{if(!n._listeners)return;let o=n._listeners.length;for(;o-- >0;)n._listeners[o](r);n._listeners=null}),this.promise.then=r=>{let o,s=new Q(a=>{n.subscribe(a),o=a}).then(r);return s.cancel=function(){n.unsubscribe(o)},s},e(function(r,o,s){n.reason||(n.reason=new Da(r,o,s),i(n.reason))})}throwIfRequested(){if(this.reason)throw this.reason}subscribe(e){this.reason?e(this.reason):this._listeners?this._listeners.push(e):this._listeners=[e]}unsubscribe(e){if(!this._listeners)return;let i=this._listeners.indexOf(e);i!==-1&&this._listeners.splice(i,1)}toAbortSignal(){let e=new AbortController,i=n=>{e.abort(n)};return this.subscribe(i),e.signal.unsubscribe=()=>this.unsubscribe(i),e.signal}static source(){let e;return{token:new sf(function(n){e=n}),cancel:e}}}var sK=sf;let af={Continue:100,SwitchingProtocols:101,Processing:102,EarlyHints:103,Ok:200,Created:201,Accepted:202,NonAuthoritativeInformation:203,NoContent:204,ResetContent:205,PartialContent:206,MultiStatus:207,AlreadyReported:208,ImUsed:226,MultipleChoices:300,MovedPermanently:301,Found:302,SeeOther:303,NotModified:304,UseProxy:305,Unused:306,TemporaryRedirect:307,PermanentRedirect:308,BadRequest:400,Unauthorized:401,PaymentRequired:402,Forbidden:403,NotFound:404,MethodNotAllowed:405,NotAcceptable:406,ProxyAuthenticationRequired:407,RequestTimeout:408,Conflict:409,Gone:410,LengthRequired:411,PreconditionFailed:412,PayloadTooLarge:413,UriTooLong:414,UnsupportedMediaType:415,RangeNotSatisfiable:416,ExpectationFailed:417,ImATeapot:418,MisdirectedRequest:421,UnprocessableEntity:422,Locked:423,FailedDependency:424,TooEarly:425,UpgradeRequired:426,PreconditionRequired:428,TooManyRequests:429,RequestHeaderFieldsTooLarge:431,UnavailableForLegalReasons:451,InternalServerError:500,NotImplemented:501,BadGateway:502,ServiceUnavailable:503,GatewayTimeout:504,HttpVersionNotSupported:505,VariantAlsoNegotiates:506,InsufficientStorage:507,LoopDetected:508,NotExtended:510,NetworkAuthenticationRequired:511};Object.entries(af).forEach(t=>{let[e,i]=t;af[i]=e});var aK=af;let ci=function t(e){let i=new dh(e),n=rb(dh.prototype.request,i);return X.extend(n,dh.prototype,i,{allOwnKeys:!0}),X.extend(n,i,null,{allOwnKeys:!0}),n.create=function(r){return t(gs(e,r))},n}(XE);ci.Axios=dh,ci.CanceledError=Da,ci.CancelToken=sK,ci.isCancel=ZI,ci.VERSION=fA,ci.toFormData=Gu,ci.AxiosError=zt,ci.Cancel=ci.CanceledError,ci.all=function(t){return Q.all(t)},ci.spread=function(t){return function(e){return t.apply(null,e)}},ci.isAxiosError=function(t){return X.isObject(t)&&t.isAxiosError===!0},ci.mergeConfig=gs,ci.AxiosHeaders=$n,ci.formToJSON=t=>JI(X.isHTMLForm(t)?new FormData(t):t),ci.getAdapter=mA.getAdapter,ci.HttpStatusCode=aK,ci.default=ci;var bi=ci;let cK=()=>{};function pd(){let t={promise:void 0,isResolved:!1,isRejected:!1,isFinished:!1,resolve:void 0,reject:void 0,cancel:cK};return t.promise=new Q((e,i)=>{t.resolve=n=>{t.isFinished||(t.isResolved=!0,t.isFinished=!0,e(n),t.value=n)},t.reject=n=>{t.isFinished||(t.isRejected=!0,t.isFinished=!0,i(n))}}),t}let lh=new Map,uh=new Map,Rr=new Map,Ve=function(t){return t.WIN_10="Windows 10",t.WIN_81="Windows 8.1",t.WIN_8="Windows 8",t.WIN_7="Windows 7",t.WIN_VISTA="Windows Vista",t.WIN_SERVER_2003="Windows Server 2003",t.WIN_XP="Windows XP",t.WIN_2000="Windows 2000",t.ANDROID="Android",t.HARMONY_OS="HarmonyOS",t.OPEN_BSD="Open BSD",t.SUN_OS="Sun OS",t.LINUX="Linux",t.IOS="iOS",t.MAC_OS="Mac OS",t.CHROMIUM_OS="Chromium OS",t.QNX="QNX",t.UNIX="UNIX",t.BEOS="BeOS",t.OS_2="OS/2",t.SEARCH_BOT="Search Bot",t}({}),xt=function(t){return t.CHROME="Chrome",t.SAFARI="Safari",t.EDGE="Edge",t.FIREFOX="Firefox",t.OPERA="OPR",t.QQ="QQBrowser",t.WECHAT="MicroMessenger",t}({}),cf=new F3,tr=cf.getResult(),df=null;function kt(t){if(!df){t&&cf.setUA(t),tr=cf.getResult();let e=function(a){if(a.engine.name==="Blink"&&a.browser.name!=="WeChat")return xt.CHROME;switch(a.browser.name){case"Chrome Headless":case"Chrome":case"Chromium":return xt.CHROME;case"Safari":case"Mobile Safari":return xt.SAFARI;case"Edge":return xt.EDGE;case"Firefox":return xt.FIREFOX;case"QQ":case"QQBrowser":return xt.QQ;case"Opera":return xt.OPERA;case"WeChat":return xt.WECHAT;default:return a.browser.name||""}}(tr),i=SA(tr),n=function(a){return a.os.name==="Windows"?a.os.version?a.os.name+" "+a.os.version:a.os.name:a.os.name||""}(tr),r=tr.os.version,o=SA(tr,!1),s=tr.device.type;if(!(e&&i&&n&&r))return{name:e,version:i,os:n,osVersion:r,browserVersion:o,deviceType:s};df={name:e,version:i,os:n,osVersion:r,browserVersion:o,deviceType:s}}return df}function SA(t){let e,i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];return e=t.engine.name==="Blink"?t.engine.version||"":t.browser.version||"",i?e.split(".")[0]:e}function hh(){return kt().os}function TA(){let t=kt();return"".concat(t.os," ").concat(t.osVersion)}function ph(){let t=kt();return!!(tr.engine.name==="WebKit"&&t.os===Ve.MAC_OS&&navigator.maxTouchPoints&&navigator.maxTouchPoints>0&&t.name!==xt.SAFARI||fi()&&t.name!==xt.SAFARI)}function Jr(){return kt().name===xt.CHROME}function Qe(){return kt().name===xt.SAFARI}function RA(){return kt().name===xt.EDGE}function _e(){return kt().name===xt.FIREFOX}function fi(){return kt().os===Ve.IOS}function _d(t){let e=kt();return!(e.name!==xt.CHROME||!e.osVersion)&&Number(e.version)>=t}function vA(t){let e=kt();return!(e.name!==xt.CHROME||!e.osVersion)&&Number(e.version)<t}function lf(t,e,i){let n=kt();return!(n.name!==t||!n.osVersion)&&(i?Number(n.version)>=e&&Number(n.version)<=i:Number(n.version)===e)}function uf(t){let e=kt();return!(e.name!==xt.EDGE||!e.osVersion)&&Number(e.version)>=t}function yA(t){let e=kt();return!(e.name!==xt.SAFARI||!e.osVersion)&&Number(e.version)>=t}function CA(t,e,i){let n=kt();if(n.os!==Ve.IOS||!n.osVersion)return!1;let r=n.osVersion.split(".");return i?e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t:e?Number(r[0])===t&&Number(r[1])<=e||Number(r[0])<t:Number(r[0])<=t}function bA(t,e,i){let n=kt();if(n.name!==xt.SAFARI||!n.osVersion||!n.browserVersion)return!1;let r=n.browserVersion.split(".");return i?e&&Number(r[0])===t&&Number(r[1])<e||Number(r[0])<t:e?Number(r[0])===t&&Number(r[1])<=e||Number(r[0])<t:Number(r[0])<=t}function hf(t){let e=kt();return!(e.name!==xt.OPERA||!e.osVersion)&&Number(e.version)>=t}function IA(){let t=kt();if(t.os!==Ve.IOS||!t.osVersion)return!1;let e=t.osVersion.split(".");return Number(e[0])<14||Number(e[0])===14&&Number(e[1])<=6}function Pa(){let t=kt();if(t.os!==Ve.IOS||!t.osVersion)return!1;let e=t.osVersion.split(".");return Number(e[0])===15}function pf(){let t=kt();if(t.os!==Ve.IOS||!t.osVersion)return!1;let e=t.osVersion.split(".");return Number(e[0])===16}function AA(){let t=kt();if(t.os!==Ve.IOS||!t.osVersion)return!1;let e=t.osVersion.split(".");return Number(e[0])===15&&Number(e[1])>=1}function Pn(){return Qe()&&navigator.maxTouchPoints>0}function wA(){return kt().name===xt.WECHAT}function OA(){return window.navigator.appVersion&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)!==null&&window.navigator.appVersion.match(/Chrome\/([\w\W]*?)\./)[1]<=35}function _f(){let t=hh();return function(){let{deviceType:e}=kt();return e==="mobile"||e==="tablet"}()||t===Ve.ANDROID||t===Ve.IOS||t===Ve.HARMONY_OS}function Qr(){let t=kt();return t.name!==xt.EDGE&&t.name!==xt.SAFARI&&!!navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]./i)}function _h(){return hh()===Ve.ANDROID}function md(){let t=kt();return _h()&&(t.name===xt.CHROME||t.name===xt.WECHAT||/chrome|chromium/i.test(navigator.userAgent))}function ft(t,e,i){return(e=function(n){var r=function(o,s){if(typeof o!="object"||!o)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(n);return typeof r=="symbol"?r:r+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function NA(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function tt(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?NA(Object(i),!0).forEach(function(n){ft(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):NA(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let C=function(t){return t.UNEXPECTED_ERROR="UNEXPECTED_ERROR",t.UNEXPECTED_RESPONSE="UNEXPECTED_RESPONSE",t.TIMEOUT="TIMEOUT",t.INVALID_PARAMS="INVALID_PARAMS",t.NOT_READABLE="NOT_READABLE",t.NOT_SUPPORTED="NOT_SUPPORTED",t.INVALID_OPERATION="INVALID_OPERATION",t.OPERATION_ABORTED="OPERATION_ABORTED",t.WEB_SECURITY_RESTRICT="WEB_SECURITY_RESTRICT",t.EXCHANGE_SDP_FAILED="EXCHANGE_SDP_FAILED",t.ADD_CANDIDATE_FAILED="ADD_CANDIDATE_FAILED",t.DATACHANNEL_FAILED="DATACHANNEL_FAILED",t.NETWORK_ERROR="NETWORK_ERROR",t.NETWORK_TIMEOUT="NETWORK_TIMEOUT",t.NETWORK_RESPONSE_ERROR="NETWORK_RESPONSE_ERROR",t.API_INVOKE_TIMEOUT="API_INVOKE_TIMEOUT",t.ENUMERATE_DEVICES_FAILED="ENUMERATE_DEVICES_FAILED",t.DEVICE_NOT_FOUND="DEVICE_NOT_FOUND",t.ELECTRON_IS_NULL="ELECTRON_IS_NULL",t.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR="ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR",t.CHROME_PLUGIN_NO_RESPONSE="CHROME_PLUGIN_NO_RESPONSE",t.CHROME_PLUGIN_NOT_INSTALL="CHROME_PLUGIN_NOT_INSTALL",t.MEDIA_OPTION_INVALID="MEDIA_OPTION_INVALID",t.PERMISSION_DENIED="PERMISSION_DENIED",t.CONSTRAINT_NOT_SATISFIED="CONSTRAINT_NOT_SATISFIED",t.TRACK_IS_DISABLED="TRACK_IS_DISABLED",t.GET_VIDEO_ELEMENT_VISIBLE_ERROR="GET_VIDEO_ELEMENT_VISIBLE_ERROR",t.SHARE_AUDIO_NOT_ALLOWED="SHARE_AUDIO_NOT_ALLOWED",t.LOW_STREAM_ENCODING_ERROR="LOW_STREAM_ENCODING_ERROR",t.SET_ENCODING_PARAMETER_ERROR="SET_ENCODING_PARAMETER_ERROR",t.TRACK_STATE_UNREACHABLE="TRACK_STATE_UNREACHABLE",t.INVALID_UINT_UID_FROM_STRING_UID="INVALID_UINT_UID_FROM_STRING_UID",t.CAN_NOT_GET_PROXY_SERVER="CAN_NOT_GET_PROXY_SERVER",t.CAN_NOT_GET_GATEWAY_SERVER="CAN_NOT_GET_GATEWAY_SERVER",t.VOID_GATEWAY_ADDRESS="VOID_GATEWAY_ADDRESS",t.UID_CONFLICT="UID_CONFLICT",t.MULTI_UNILBS_RESPONSE_ERROR="MULTI_UNILBS_RESPONSE_ERROR",t.UPDATE_TICKET_FAILED="UPDATE_TICKET_FAILED",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t.INVALID_LOCAL_TRACK="INVALID_LOCAL_TRACK",t.INVALID_TRACK="INVALID_TRACK",t.SENDER_NOT_FOUND="SENDER_NOT_FOUND",t.CREATE_OFFER_FAILED="CREATE_OFFER_FAILED",t.SET_ANSWER_FAILED="SET_ANSWER_FAILED",t.ICE_FAILED="ICE_FAILED",t.PC_CLOSED="PC_CLOSED",t.SENDER_REPLACE_FAILED="SENDER_REPLACE_FAILED",t.GET_LOCAL_CAPABILITIES_FAILED="GET_LOCAL_CAPABILITIES_FAILED",t.GET_LOCAL_CONNECTION_PARAMS_FAILED="GET_LOCAL_CONNECTION_PARAMS_FAILED",t.SUBSCRIBE_FAILED="SUBSCRIBE_FAILED",t.UNSUBSCRIBE_FAILED="UNSUBSCRIBE_FAILED",t.GATEWAY_P2P_LOST="GATEWAY_P2P_LOST",t.NO_ICE_CANDIDATE="NO_ICE_CANDIDATE",t.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS="CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS",t.EXIST_DISABLED_VIDEO_TRACK="EXIST_DISABLED_VIDEO_TRACK",t.INVALID_REMOTE_USER="INVALID_REMOTE_USER",t.REMOTE_USER_IS_NOT_PUBLISHED="REMOTE_USER_IS_NOT_PUBLISHED",t.CUSTOM_REPORT_SEND_FAILED="CUSTOM_REPORT_SEND_FAILED",t.CUSTOM_REPORT_FREQUENCY_TOO_HIGH="CUSTOM_REPORT_FREQUENCY_TOO_HIGH",t.FETCH_AUDIO_FILE_FAILED="FETCH_AUDIO_FILE_FAILED",t.READ_LOCAL_AUDIO_FILE_ERROR="READ_LOCAL_AUDIO_FILE_ERROR",t.DECODE_AUDIO_FILE_FAILED="DECODE_AUDIO_FILE_FAILED",t.WS_ABORT="WS_ABORT",t.WS_DISCONNECT="WS_DISCONNECT",t.WS_ERR="WS_ERR",t.EXTERNAL_SIGNAL_ABORT="EXTERNAL_SIGNAL_ABORT",t.LIVE_STREAMING_TASK_CONFLICT="LIVE_STREAMING_TASK_CONFLICT",t.LIVE_STREAMING_INVALID_ARGUMENT="LIVE_STREAMING_INVALID_ARGUMENT",t.LIVE_STREAMING_INTERNAL_SERVER_ERROR="LIVE_STREAMING_INTERNAL_SERVER_ERROR",t.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED="LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED",t.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED="LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED",t.LIVE_STREAMING_CDN_ERROR="LIVE_STREAMING_CDN_ERROR",t.LIVE_STREAMING_INVALID_RAW_STREAM="LIVE_STREAMING_INVALID_RAW_STREAM",t.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT="LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT",t.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE="LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE",t.LIVE_STREAMING_WARN_FREQUENT_REQUEST="LIVE_STREAMING_WARN_FREQUENT_REQUEST",t.WEBGL_INTERNAL_ERROR="WEBGL_INTERNAL_ERROR",t.BEAUTY_PROCESSOR_INTERNAL_ERROR="BEAUTY_PROCESSOR_INTERNAL_ERROR",t.CROSS_CHANNEL_WAIT_STATUS_ERROR="CROSS_CHANNEL_WAIT_STATUS_ERROR",t.CROSS_CHANNEL_FAILED_JOIN_SRC="CROSS_CHANNEL_FAILED_JOIN_SEC",t.CROSS_CHANNEL_FAILED_JOIN_DEST="CROSS_CHANNEL_FAILED_JOIN_DEST",t.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST="CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST",t.CROSS_CHANNEL_SERVER_ERROR_RESPONSE="CROSS_CHANNEL_SERVER_ERROR_RESPONSE",t.METADATA_OUT_OF_RANGE="METADATA_OUT_OF_RANGE",t.LOCAL_AEC_ERROR="LOCAL_AEC_ERROR",t.INVALID_PLUGIN="INVALID_PLUGIN",t.DISCONNECT_P2P="DISCONNECT_P2P",t.CONVERTING_IMAGEDATA_TO_BLOB_FAILED="CONVERTING_IMAGEDATA_TO_BLOB_FAILED",t.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED="CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED",t.INIT_DATACHANNEL_TIMEOUT="INIT_DATACHANNEL_TIMEOUT",t.CREATE_DATACHANNEL_ERROR="CREATE_DATACHANNEL_ERROR",t.DATACHANNEL_CONNECTION_TIMEOUT="DATACHANNEL_CONNECTION_TIMEOUT",t.PROHIBITED_OPERATION="PROHIBITED_OPERATION",t.IMAGE_MODERATION_UPLOAD_FAILED="IMAGE_MODERATION_UPLOAD_FAILED",t.P2P_MESSAGE_FAILED="P2P_MESSAGE_FAILED",t}({}),F=class extends Error{constructor(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",i=arguments.length>2?arguments[2]:void 0;super(e),ft(this,"code",void 0),ft(this,"message",void 0),ft(this,"data",void 0),ft(this,"name","AgoraRTCException"),this.code=t,this.message="AgoraRTCError ".concat(this.code,": ").concat(e),this.data=i}toString(){return this.data?"".concat(this.message,`
data: `).concat(JSON.stringify(this.data)):this.message}print(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error",e=arguments.length>1?arguments[1]:void 0;return t==="error"&&(e||console).error(this.toString()),t==="warning"&&(e||console).warn(this.toString()),this}throw(t){throw this.print("error",t),this}};function Zr(t,e){if(typeof t!="boolean")throw new F(C.INVALID_PARAMS,"Invalid ".concat(e,": The value is of the boolean type."))}function xe(t,e,i){if(!z(i).call(i,t))throw new F(C.INVALID_PARAMS,"".concat(e," can only be set as ").concat(JSON.stringify(i)))}function Xt(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:1e4;if(t<i||t>n||(!(arguments.length>4&&arguments[4]!==void 0)||arguments[4])&&!function(r){return typeof r=="number"&&r%1==0}(t))throw new F(C.INVALID_PARAMS,"invalid ".concat(e,": the value range is [").concat(i,", ").concat(n,"]. integer only"))}function mf(t,e){if(typeof t!="number"){if(!(t.min||t.max||t.ideal||t.exact))throw new F(C.INVALID_PARAMS,"".concat(e," is not a valid ConstrainLong"));t.min!==void 0&&Xt(t.min,"".concat(e,".min"),0,1/0),t.max!==void 0&&Xt(t.max,"".concat(e,".max"),1,1/0),t.exact!==void 0&&Xt(t.exact,"".concat(e,".exact"),1,1/0),t.ideal!==void 0&&Xt(t.ideal,"".concat(e,".ideal"),1,1/0)}else Xt(t,e,1,1/0)}function Ke(t,e){let i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:1,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:255,r=!(arguments.length>4&&arguments[4]!==void 0)||arguments[4];if(t==null)throw new F(C.INVALID_PARAMS,"".concat(e||"param"," cannot be empty"));if(!DA(t,i,n,r))throw new F(C.INVALID_PARAMS,"Invalid ".concat(e||"string param",": Length of the string: [").concat(i,",").concat(n,"].").concat(r?" ASCII characters only.":""))}function $r(t,e){if(!Array.isArray(t))throw new F(C.INVALID_PARAMS,"".concat(e," should be an array"))}function me(t){return t==null}function DA(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:255,n=!(arguments.length>3&&arguments[3]!==void 0)||arguments[3];return typeof t=="string"&&t.length<=i&&t.length>=e&&(!n||function(r){if(typeof r!="string")return!1;for(let o=0;o<r.length;o+=1){let s=r.charCodeAt(o);if(s<0||s>255)return!1}return!0}(t))}var Ed=function(t){return t.COVERED="COVERED",t.POSITION="POSITION",t.SIZE="SIZE",t.STYLE="STYLE",t}(Ed||{}),Ef=function(t){return t.UNMOUNTED="UNMOUNTED",t.INVALID_HTML_ELEMENT="INVALID_HTML_ELEMENT",t}(Ef||{});let PA=new class{constructor(){ft(this,"_clientSize",null),ft(this,"getClientWidth",()=>document.documentElement?document.documentElement.clientWidth:document.body.clientWidth),ft(this,"getClientHeight",()=>document.documentElement?document.documentElement.clientHeight:document.body.clientHeight),ft(this,"getStyle",t=>window.getComputedStyle(t,null)),ft(this,"checkCssVisibleProperty",t=>{var e;let i=!0,n=this.getStyle(t),{display:r,visibility:o,opacity:s,filter:a}=n;return(r==="none"||z(e=["hidden","collapse"]).call(e,o)||Number(s)<.1)&&(i=!1),!!i&&(a&&a.split(" ").filter(c=>{var d;let l=c.split("(")[0];return z(d=["brightness","blur","opacity"]).call(d,l)}).map(c=>{let[d,l]=c.split(/\(|\)/);return[d,Number(l.match(/^[0-9\.]+/))]}).forEach(c=>{let[d,l]=c;switch(d){case"brightness":(l<.1||l>3)&&(i=!1);break;case"blur":l>3&&(i=!1);break;case"opacity":l<.1&&(i=!1)}}),i)}),ft(this,"checkPropertyUpToAllParentNodes",(t,e)=>{let i=!0,n=!0,r=s=>e(s),o=t;for(;o&&n;)r(o)||(i=!1,n=!1),o=o.parentElement,o||(n=!1);return i}),ft(this,"checkActualCssVisibleIncludeInherit",t=>this.checkPropertyUpToAllParentNodes(t,this.checkCssVisibleProperty)),ft(this,"getSizeAboutClient",t=>{let{width:e,height:i,left:n,right:r,top:o,bottom:s}=t.getBoundingClientRect(),a=this.getClientWidth(),c=this.getClientHeight();return{width:e,height:i,left:n,right:r,top:o,bottom:s,clientWidth:a,clientHeight:c,clientMin:Math.min(a,c)}}),ft(this,"checkActualSize",()=>{let{width:t,height:e,clientMin:i}=this._clientSize;return this.checkSizeIsVisible(t,e,i)}),ft(this,"elementFromPoint",(t,e)=>document.elementFromPoint?document.elementFromPoint(t,e):null),ft(this,"checkCoverForAPoint",(t,e,i)=>{let n=this.elementFromPoint(t,e);return n!==null&&n!==i}),ft(this,"getPointPositionList",()=>{let{width:t,height:e,left:i,top:n}=this._clientSize,r=t/6,o=e/6,s=[],a=10**6;for(let c=0;c<5;c++)for(let d=0;d<5;d++){let l=(i*a+(c===0?.1:c===4?(r*c*a-1e5)/a:r*c)*a)/a,u=(n*a+(d===0?.1:d===4?(o*d*a-1e5)/a:o*d)*a)/a;s.push({x:l,y:u})}return[...s]}),ft(this,"checkElementCover",t=>this.getPointPositionList().map(e=>this.checkCoverForAPoint(e.x,e.y,t)).filter(e=>!!e).length>6),ft(this,"checkSizeIsVisible",(t,e,i)=>(t>50||i/t<=10)&&(e>50||i/e<=10)),ft(this,"checkSizeOfPartInClient",()=>{let{left:t,right:e,top:i,bottom:n,clientHeight:r,clientWidth:o,clientMin:s}=this._clientSize,a,c,d,l;if(t<0)a=0;else{if(!(t<o))return!1;a=t}if(e<0)return!1;if(c=e<o?e:o,i<0)d=0;else{if(!(i<r))return!1;d=i}if(n<0)return!1;l=n<r?n:r;let u=c-a,h=l-d;return this.checkSizeIsVisible(u,h,s)}),ft(this,"returnHiddenResult",t=>(this._clientSize=null,{visible:!1,reason:t})),ft(this,"checkOneElementVisible",t=>{if(t instanceof HTMLElement){if(this.checkElementIsMountedOnDom(t)){if(this.checkActualCssVisibleIncludeInherit(t)){if(this._clientSize=this.getSizeAboutClient(t),this.checkElementCover(t))return this.returnHiddenResult(Ed.COVERED);{let e=this.checkActualSize(),i=this.checkSizeOfPartInClient();return e&&!i?this.returnHiddenResult(Ed.POSITION):e?(this._clientSize=null,{visible:!0}):this.returnHiddenResult(Ed.SIZE)}}return this.returnHiddenResult(Ed.STYLE)}return this.returnHiddenResult(Ef.UNMOUNTED)}return this.returnHiddenResult(Ef.INVALID_HTML_ELEMENT)}),ft(this,"checkElementIsMountedOnDom",t=>this.checkPropertyUpToAllParentNodes(t,e=>e.nodeName.toUpperCase()!=="HTML"?e.parentElement!==null:!!document.documentElement))}};function ff(t){return new TextEncoder().encode(t)}let LA=function(t,e){let i=new Uint8Array(t.byteLength+e.byteLength);return i.set(new Uint8Array(t),0),i.set(new Uint8Array(e),t.byteLength),i},gf=t=>I(null,null,function*(){return function(e,i){let n="";return new Uint8Array(e).forEach(r=>{n+=r.toString(i).padStart(2,"0")}),n}(yield crypto.subtle.digest("SHA-256",ff(t)),16)}),ue=class{constructor(){ft(this,"_events",{}),ft(this,"addListener",this.on)}getListeners(t){return this._events[t]?this._events[t].map(e=>e.listener):[]}on(t,e){this._events[t]||(this._events[t]=[]);let i=this._events[t];this._indexOfListener(i,e)===-1&&i.push({listener:e,once:!1})}once(t,e){this._events[t]||(this._events[t]=[]);let i=this._events[t];this._indexOfListener(i,e)===-1&&i.push({listener:e,once:!0})}off(t,e){if(!this._events[t])return;let i=this._events[t],n=this._indexOfListener(i,e);n!==-1&&i.splice(n,1),this._events[t].length===0&&delete this._events[t]}removeAllListeners(t){t?delete this._events[t]:this._events={}}emit(t){this._events[t]||(this._events[t]=[]);let e=this._events[t].map(o=>o);for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];for(let o=0;o<e.length;o+=1){let s=e[o];s.once&&this.off(t,s.listener),s.listener.apply(this,n||[])}}safeEmit(t){for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];[...this._events[t]||[]].forEach(r=>{r.once&&this.off(t,r.listener);try{r.listener.apply(this,i)}catch(o){console.error("safeEmit event:".concat(t," error ").concat(o?.toString()))}})}_indexOfListener(t,e){let i=t.length;for(;i--;)if(t[i].listener===e)return i;return-1}},fd=null;function kA(){if(fd)return fd;if(window.electron)return fd=window.electron;if(!window.require)return null;try{return fd=window.require("electron"),fd}catch{return null}}let be=function(t){return t.CREATE_CLIENT="createClient",t.CHECK_SYSTEM_REQUIREMENTS="checkSystemRequirements",t.SET_AREA="setArea",t.PRELOAD="PRELOAD",t.CHECK_VIDEO_TRACK_IS_ACTIVE="checkVideoTrackIsActive",t.CHECK_AUDIO_TRACK_IS_ACTIVE="checkAudioTrackIsActive",t.CREATE_MIC_AUDIO_TRACK="createMicrophoneAudioTrack",t.CREATE_CUSTOM_AUDIO_TRACK="createCustomAudioTrack",t.CREATE_BUFFER_AUDIO_TRACK="createBufferSourceAudioTrack",t.CREATE_CAM_VIDEO_TRACK="createCameraVideoTrack",t.CREATE_CUSTOM_VIDEO_TRACK="createCustomVideoTrack",t.CREATE_MIC_AND_CAM_TRACKS="createMicrophoneAndCameraTracks",t.CREATE_SCREEN_VIDEO_TRACK="createScreenVideoTrack",t.SET_ENCRYPTION_CONFIG="Client.setEncryptionConfig",t.START_PROXY_SERVER="Client.startProxyServer",t.STOP_PROXY_SERVER="Client.stopProxyServer",t.SET_PROXY_SERVER="Client.setProxyServer",t.SET_TURN_SERVER="Client.setTurnServer",t.SET_CLIENT_ROLE="Client.setClientRole",t.SET_LOW_STREAM_PARAMETER="Client.setLowStreamParameter",t.ENABLE_DUAL_STREAM="Client.enableDualStream",t.DISABLE_DUAL_STREAM="Client.disableDualStream",t.JOIN="Client.join",t.LEAVE="Client.leave",t.PUBLISH="Client.publish",t.UNPUBLISH="Client.unpublish",t.SUBSCRIBE="Client.subscribe",t.MASS_SUBSCRIBE="Client.massSubscribe",t.MASS_UNSUBSCRIBE="Client.massUnsubscribe",t.UNSUBSCRIBE="Client.unsubscribe",t.RENEW_TOKEN="Client.renewToken",t.SET_REMOTE_VIDEO_STREAM_TYPE="Client.setRemoteVideoStreamType",t.SET_STREAM_FALLBACK_OPTION="Client.setStreamFallbackOption",t.ENABLE_AUDIO_VOLUME_INDICATOR="Client.enableAudioVolumeIndicator",t.SEND_CUSTOM_REPORT_MESSAGE="Client.sendCustomReportMessage",t.INSPECT_VIDEO_CONTENT="Client.inspectVideoContent",t.STOP_INSPECT_VIDEO_CONTENT="Client.stopInspectVideoContent",t.JOIN_FALLBACK_TO_PROXY="Client._joinFallbackToProxy",t.ON_LIVE_STREAM_WARNING="Client.onLiveStreamWarning",t.ON_LIVE_STREAM_ERROR="Client.onLiveStreamingError",t.START_LIVE_STREAMING="Client.startLiveStreaming",t.SET_LIVE_TRANSCODING="Client.setLiveTranscoding",t.STOP_LIVE_STREAMING="Client.stopLiveStreaming",t.START_CHANNEL_MEDIA_RELAY="Client.startChannelMediaRelay",t.UPDATE_CHANNEL_MEDIA_RELAY="Client.updateChannelMediaRelay",t.STOP_CHANNEL_MEDIA_RELAY="Client.stopChannelMediaRelay",t.REQUEST_CONFIG_DISTRIBUTE="_config-distribute-request",t.SET_CONFIG_DISTRIBUTE="_configDistribute",t.LOCAL_TRACK_SET_MUTED="LocalTrack.setMute",t.LOCAL_AUDIO_TRACK_PLAY="LocalAudioTrack.play",t.LOCAL_AUDIO_TRACK_PLAY_IN_ELEMENT="LocalAudioTrack.playInElement",t.LOCAL_AUDIO_TRACK_STOP="LocalAudioTrack.stop",t.LOCAL_AUDIO_TRACK_SET_VOLUME="LocalAudioTrack.setVolume",t.MIC_AUDIO_TRACK_SET_DEVICE="MicrophoneAudioTrack.setDevice",t.BUFFER_AUDIO_TRACK_START="BufferSourceAudioTrack.startProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_STOP="BufferSourceAudioTrack.stopProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_PAUSE="BufferSourceAudioTrack.pauseProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_RESUME="BufferSourceAudioTrack.resumeProcessAudioBuffer",t.BUFFER_AUDIO_TRACK_SEEK="BufferSourceAudioTrack.seekAudioBuffer",t.LOCAL_VIDEO_TRACK_PLAY="LocalVideoTrack.play",t.LOCAL_VIDEO_TRACK_STOP="LocalVideoTrack.stop",t.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE="LocalVideoTrack.getVideoElementVisibleStatus",t.LOCAL_VIDEO_TRACK_BEAUTY="LocalVideoTrack.setBeautyEffect",t.LOCAL_VIDEO_SEND_SEI_DATA="LocalVideoTrack.sendSeiData",t.CAM_VIDEO_TRACK_SET_DEVICE="CameraVideoTrack.setDevice",t.CAM_VIDEO_TRACK_SET_ENCODER_CONFIG="CameraVideoTrack.setEncoderConfiguration",t.REMOTE_VIDEO_TRACK_PLAY="RemoteVideoTrack.play",t.REMOTE_VIDEO_TRACK_STOP="RemoteVideoTrack.stop",t.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE="RemoteVideoTrack.getVideoElementVisibleStatus",t.REMOTE_AUDIO_TRACK_PLAY="RemoteAudioTrack.play",t.REMOTE_AUDIO_TRACK_STOP="RemoteAudioTrack.stop",t.REMOTE_AUDIO_SET_VOLUME="RemoteAudioTrack.setVolume",t.REMOTE_AUDIO_SET_OUTPUT_DEVICE="RemoteAudioTrack.setOutputDevice",t.GET_MEDIA_STREAM_TRACK="Track.getMediaStreamTrack",t.STREAM_TYPE_CHANGE="streamTypeChange",t.CONNECTION_STATE_CHANGE="connectionStateChange",t.LOAD_CONFIG_FROM_LOCALSTORAGE="loadConfigFromLocalStorage",t.IMAGE_MODERATION_UPLOAD="imageModerationUpload",t.REPUB_AFTER_PC_CONNECTED="repubAfterPCConnected",t}({}),Ee=function(t){return t.TRACER="tracer",t}({});function MA(t){return Xt(t.timeout,"config.timeout",0,1e5),Xt(t.timeoutFactor,"config.timeoutFactor",0,100,!1),Xt(t.maxRetryCount,"config.maxRetryConfig",0,1/0),Xt(t.maxRetryTimeout,"config.maxRetryTimeout",0,1/0),!0}let dK=function(t){return t[t.AUDIENCE_LEVEL_LOW_LATENCY=1]="AUDIENCE_LEVEL_LOW_LATENCY",t[t.AUDIENCE_LEVEL_ULTRA_LOW_LATENCY=2]="AUDIENCE_LEVEL_ULTRA_LOW_LATENCY",t[t.AUDIENCE_LEVEL_SYNC_LATENCY=3]="AUDIENCE_LEVEL_SYNC_LATENCY",t}({}),Ft=function(t){return t.LEAVE="LEAVE",t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.UID_BANNED="UID_BANNED",t.FALLBACK="FALLBACK",t.IP_BANNED="IP_BANNED",t.CHANNEL_BANNED="CHANNEL_BANNED",t.LICENSE_MISSING="LICENSE_MISSING",t.LICENSE_EXPIRED="LICENSE_EXPIRED",t.LICENSE_MINUTES_EXCEEDED="LICENSE_MINUTES_EXCEEDED",t.LICENSE_PERIOD_INVALID="LICENSE_PERIOD_INVALID",t.LICENSE_MULTIPLE_SDK_SERVICE="LICENSE_MULTIPLE_SDK_SERVICE",t.LICENSE_ILLEGAL="LICENSE_ILLEGAL",t.TOKEN_EXPIRE="TOKEN_EXPIRE",t}({});function gd(t){if(!Array.isArray(t)||t.length<1)return!1;try{t.forEach(e=>{if(!e.urls)throw Error()})}catch{return!1}return!0}function UA(t){return Ke(t.turnServerURL,"turnServerURL"),Ke(t.username,"username"),Ke(t.password,"password"),t.udpport&&Xt(t.udpport,"udpport",1,99999,!0),t.forceturn&&Zr(t.forceturn,"forceturn"),t.security&&Zr(t.security,"security"),t.tcpport&&Xt(t.tcpport,"tcpport",1,99999,!0),!0}function Sf(t){return t.level!==void 0&&xe(t.level,"level",[1,2,3]),t.delay!==void 0&&Xt(t.delay,"delay",0,3e3,!0),!0}let It=function(t){return t.PEERCONNECTION_STATE_CHANGE="peerconnection-state-change",t.AUDIO_METADATA="audio-metadata",t.CONNECTION_STATE_CHANGE="connection-state-change",t.MEDIA_RECONNECT_START="media-reconnect-start",t.MEDIA_RECONNECT_END="media-reconnect-end",t.IS_USING_CLOUD_PROXY="is-using-cloud-proxy",t.USER_JOINED="user-joined",t.USER_LEAVED="user-left",t.USER_PUBLISHED="user-published",t.USER_UNPUBLISHED="user-unpublished",t.USER_INFO_UPDATED="user-info-updated",t.CLIENT_BANNED="client-banned",t.CHANNEL_MEDIA_RELAY_STATE="channel-media-relay-state",t.CHANNEL_MEDIA_RELAY_EVENT="channel-media-relay-event",t.VOLUME_INDICATOR="volume-indicator",t.CRYPT_ERROR="crypt-error",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="token-privilege-will-expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="token-privilege-did-expire",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGED="stream-type-changed",t.STREAM_FALLBACK="stream-fallback",t.RECEIVE_METADATA="receive-metadata",t.STREAM_MESSAGE="stream-message",t.LIVE_STREAMING_ERROR="live-streaming-error",t.LIVE_STREAMING_WARNING="live-streaming-warning",t.EXCEPTION="exception",t.ERROR="error",t.P2P_LOST="p2p_lost",t.JOIN_FALLBACK_TO_PROXY="join-fallback-to-proxy",t.CHANNEL_FALLBACK_TO_WEBSOCKET="channel-fallback-to-websocket",t.MEDIA_CONNECTION_TYPE_CHANGE="media-connection-type-change",t.PUBLISHED_USER_LIST="published-user-list",t.CONTENT_INSPECT_CONNECTION_STATE_CHANGE="content-inspect-connection-state-change",t.CONTENT_INSPECT_ERROR="content-inspect-error",t.CONTENT_INSPECT_RESULT="content-inspect-result",t.IMAGE_MODERATION_CONNECTION_STATE_CHANGE="image-moderation-connection-state-change",t}({}),Ze=function(t){return t.NETWORK_ERROR="NETWORK_ERROR",t.SERVER_ERROR="SERVER_ERROR",t.MULTI_IP="MULTI_IP",t.TIMEOUT="TIMEOUT",t.OFFLINE="OFFLINE",t.LEAVE="LEAVE",t.P2P_FAILED="P2P_FAILED",t.FALLBACK="FALLBACK",t.REGIONAL_DISTRIBUTION="REGIONAL_DISTRIBUTION",t}({}),Wi=function(t){return t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({}),La=function(t){return t.NETWORK_STATE_CHANGE="NETWORK_STATE_CHANGE",t.ONLINE="ONLINE",t.OFFLINE="OFFLINE",t}({});function $e(t,e){for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return t.getListeners(e).length===0?Q.reject(new F(C.UNEXPECTED_ERROR,"can not emit promise")):new Q((o,s)=>{t.emit(e,...n,o,s)})}function Zt(t,e){if(t.getListeners(e).length===0)return Q.resolve();for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return $e(t,e,...n)}function Ji(t,e){if(t.getListeners(e).length===0)return null;for(var i=arguments.length,n=new Array(i>2?i-2:0),r=2;r<i;r++)n[r-2]=arguments[r];return Sd(t,e,...n)}function Sd(t,e){let i=null,n=null;for(var r=arguments.length,o=new Array(r>2?r-2:0),s=2;s<r;s++)o[s-2]=arguments[s];if(t.emit(e,...o,a=>{i=a},a=>{n=a}),n!==null)throw n;if(i===null)throw new F(C.UNEXPECTED_ERROR,"handler is not sync");return i}let Ie=new class extends ue{set networkState(t){this.emit(La.NETWORK_STATE_CHANGE,t,this._networkState),t===Wi.ONLINE?this.emit(La.ONLINE):t===Wi.OFFLINE&&(this.onlineWaiter=new Q(e=>{this.once(La.ONLINE,()=>{this.onlineWaiter=void 0,e(Wi.ONLINE)})}),this.emit(La.OFFLINE)),this._networkState=t}get networkState(){return this._networkState}get isOnline(){return this._networkState===Wi.ONLINE}constructor(){super(),ft(this,"_moduleName","network-indicator"),ft(this,"_networkState",Wi.ONLINE),ft(this,"onlineWaiter",void 0),window.addEventListener("online",()=>{this.networkState=Wi.ONLINE}),window.addEventListener("offline",()=>{this.networkState=Wi.OFFLINE})}};function mh(t,e){let i=t.indexOf(e);i!==-1&&t.splice(i,1)}function ka(t){let e=[];return t.forEach(i=>{e.indexOf(i)===-1&&e.push(i)}),e}function Eh(t){Q!==void 0?Q.resolve().then(t):setTimeout(t,0)}function he(t){return JSON.parse(JSON.stringify(t))}function Ss(t){try{return he(t)}catch{return t}}let xA={};function Mo(t,e){xA[e]||(xA[e]=!0,t())}function Ts(t){let e=window.atob(t),i=new Uint8Array(new ArrayBuffer(e.length));for(let n=0;n<e.length;n+=1)i[n]=e.charCodeAt(n);return i}function Uo(t){let e="";for(let i=0;i<t.length;i+=1)e+=String.fromCharCode(t[i]);return window.btoa(e)}function VA(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:16,i=new TextEncoder().encode(t);if(i.length>e)i=i.slice(0,e);else if(i.length<e){let n=new Uint8Array(e);n.set(i),i=n}return i}function FA(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];let n=bn(e).call(e,(s,a)=>s+a.length,0),r=new Uint8Array(new ArrayBuffer(n)),o=0;return e.forEach(s=>{r.set(s,o),o+=s.length}),r}function vr(t){return window.TextEncoder?new TextEncoder().encode(t).length:t.length}function BA(t){let e=0;return(/DingTalk/i.test(navigator.userAgent)||/AliApp/i.test(navigator.userAgent))&&t.realFormData&&(t=t.realFormData),t.forEach(i=>{e+=typeof i=="string"?vr(i):i.size}),e+138}function lK(t){let e=new F(C.TIMEOUT,"timeout");return new Q((i,n)=>{window.setTimeout(()=>n(e),t)})}function qe(t){return new Q(e=>{window.setTimeout(e,t)})}function te(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:7,e=arguments.length>1?arguments[1]:void 0,i=Math.random().toString(16).substr(2,t).toLowerCase();return i.length===t?"".concat(e).concat(i):"".concat(e).concat(i)+te(t-i.length,"")}function Rs(){return te(32,"").toUpperCase()}let fh=()=>{},jA=new class{constructor(){ft(this,"fnMap",new Map)}throttleByKey(t,e,i,n){for(var r=arguments.length,o=new Array(r>4?r-4:0),s=4;s<r;s++)o[s-4]=arguments[s];if(this.fnMap.has(e)){let a=this.fnMap.get(e);if(a.threshold!==i){a.fn(...a.args),clearTimeout(a.timer);let c=window.setTimeout(()=>{let d=this.fnMap.get(e);d&&d.fn(...d.args),this.fnMap.delete(e)},i);this.fnMap.set(e,{fn:t,threshold:i,timer:c,args:o,skipFn:n})}else a.skipFn&&a.skipFn(...a.args),this.fnMap.set(e,tt(tt({},a),{},{fn:t,args:o,skipFn:n}))}else{let a=window.setTimeout(()=>{let c=this.fnMap.get(e);c&&c.fn(...c.args),this.fnMap.delete(e)},i);this.fnMap.set(e,{fn:t,threshold:i,timer:a,args:o,skipFn:n})}}},GA=jA.throttleByKey.bind(jA);function WA(t){return typeof t=="object"&&t!==null&&!(t instanceof RegExp)}function Tf(t,e){if(!WA(t)||!WA(e)||Array.isArray(t)&&!Array.isArray(e)||!Array.isArray(t)&&Array.isArray(e))return e;if(Array.isArray(e)&&Array.isArray(t)){let i=[...t];for(let n=0;n<e.length;n++)i[n]=Tf(t[n],e[n]);return i}{let i=tt({},t);for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&(Object.prototype.hasOwnProperty.call(t,n)?i[n]=Tf(t[n],e[n]):i[n]=e[n]);return i}}function HA(t,e){let i=[0];if(e&&(i=new Array(e).fill(0)),t===0)return i;let n=0;for(;t>0&&(i[n]=255&t,t>>=8,n++,!e||n!==e););return i}function Rf(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function vf(t){return bn(t).call(t,(e,i)=>e+i,0)}function KA(t){let e="0123456789abcdef";function i(N){let k,L="";for(k=0;k<=3;k++)L+=e.charAt(N>>8*k+4&15)+e.charAt(N>>8*k&15);return L}function n(N,k){let L=(65535&N)+(65535&k);return(N>>16)+(k>>16)+(L>>16)<<16|65535&L}function r(N,k,L,P,V,B){return n(function(Y,J){return Y<<J|Y>>>32-J}(n(n(k,N),n(P,B)),V),L)}function o(N,k,L,P,V,B,Y){return r(k&L|~k&P,N,k,V,B,Y)}function s(N,k,L,P,V,B,Y){return r(k&P|L&~P,N,k,V,B,Y)}function a(N,k,L,P,V,B,Y){return r(k^L^P,N,k,V,B,Y)}function c(N,k,L,P,V,B,Y){return r(L^(k|~P),N,k,V,B,Y)}let d=function(N){let k,L=1+(N.length+8>>6),P=new Array(16*L);for(k=0;k<16*L;k++)P[k]=0;for(k=0;k<N.length;k++)P[k>>2]|=N.charCodeAt(k)<<k%4*8;return P[k>>2]|=128<<k%4*8,P[16*L-2]=8*N.length,P}(t),l,u,h,p,g,E=1732584193,f=-271733879,R=-1732584194,y=271733878;for(l=0;l<d.length;l+=16)u=E,h=f,p=R,g=y,E=o(E,f,R,y,d[l+0],7,-680876936),y=o(y,E,f,R,d[l+1],12,-389564586),R=o(R,y,E,f,d[l+2],17,606105819),f=o(f,R,y,E,d[l+3],22,-1044525330),E=o(E,f,R,y,d[l+4],7,-176418897),y=o(y,E,f,R,d[l+5],12,1200080426),R=o(R,y,E,f,d[l+6],17,-1473231341),f=o(f,R,y,E,d[l+7],22,-45705983),E=o(E,f,R,y,d[l+8],7,1770035416),y=o(y,E,f,R,d[l+9],12,-1958414417),R=o(R,y,E,f,d[l+10],17,-42063),f=o(f,R,y,E,d[l+11],22,-1990404162),E=o(E,f,R,y,d[l+12],7,1804603682),y=o(y,E,f,R,d[l+13],12,-40341101),R=o(R,y,E,f,d[l+14],17,-1502002290),f=o(f,R,y,E,d[l+15],22,1236535329),E=s(E,f,R,y,d[l+1],5,-165796510),y=s(y,E,f,R,d[l+6],9,-1069501632),R=s(R,y,E,f,d[l+11],14,643717713),f=s(f,R,y,E,d[l+0],20,-373897302),E=s(E,f,R,y,d[l+5],5,-701558691),y=s(y,E,f,R,d[l+10],9,38016083),R=s(R,y,E,f,d[l+15],14,-660478335),f=s(f,R,y,E,d[l+4],20,-405537848),E=s(E,f,R,y,d[l+9],5,568446438),y=s(y,E,f,R,d[l+14],9,-1019803690),R=s(R,y,E,f,d[l+3],14,-187363961),f=s(f,R,y,E,d[l+8],20,1163531501),E=s(E,f,R,y,d[l+13],5,-1444681467),y=s(y,E,f,R,d[l+2],9,-51403784),R=s(R,y,E,f,d[l+7],14,1735328473),f=s(f,R,y,E,d[l+12],20,-1926607734),E=a(E,f,R,y,d[l+5],4,-378558),y=a(y,E,f,R,d[l+8],11,-2022574463),R=a(R,y,E,f,d[l+11],16,1839030562),f=a(f,R,y,E,d[l+14],23,-35309556),E=a(E,f,R,y,d[l+1],4,-1530992060),y=a(y,E,f,R,d[l+4],11,1272893353),R=a(R,y,E,f,d[l+7],16,-155497632),f=a(f,R,y,E,d[l+10],23,-1094730640),E=a(E,f,R,y,d[l+13],4,681279174),y=a(y,E,f,R,d[l+0],11,-358537222),R=a(R,y,E,f,d[l+3],16,-722521979),f=a(f,R,y,E,d[l+6],23,76029189),E=a(E,f,R,y,d[l+9],4,-640364487),y=a(y,E,f,R,d[l+12],11,-421815835),R=a(R,y,E,f,d[l+15],16,530742520),f=a(f,R,y,E,d[l+2],23,-995338651),E=c(E,f,R,y,d[l+0],6,-198630844),y=c(y,E,f,R,d[l+7],10,1126891415),R=c(R,y,E,f,d[l+14],15,-1416354905),f=c(f,R,y,E,d[l+5],21,-57434055),E=c(E,f,R,y,d[l+12],6,1700485571),y=c(y,E,f,R,d[l+3],10,-1894986606),R=c(R,y,E,f,d[l+10],15,-1051523),f=c(f,R,y,E,d[l+1],21,-2054922799),E=c(E,f,R,y,d[l+8],6,1873313359),y=c(y,E,f,R,d[l+15],10,-30611744),R=c(R,y,E,f,d[l+6],15,-1560198380),f=c(f,R,y,E,d[l+13],21,1309151649),E=c(E,f,R,y,d[l+4],6,-145523070),y=c(y,E,f,R,d[l+11],10,-1120210379),R=c(R,y,E,f,d[l+2],15,718787259),f=c(f,R,y,E,d[l+9],21,-343485551),E=n(E,u),f=n(f,h),R=n(R,p),y=n(y,g);return i(E)+i(f)+i(R)+i(y)}let uK=1,qA=console,ni=class{static setLogger(t){qA=t}constructor(t,e){ft(this,"id",void 0),ft(this,"lockingPromise",Q.resolve()),ft(this,"locks",0),ft(this,"name",""),ft(this,"lockId",void 0),this.lockId=uK++,t&&(this.name=t),e&&(this.id=e),this.logger("created")}logger(t,e){let i=(this.id?"[".concat(this.id,"]"):"")+"[lock-".concat(this.name,"-").concat(this.lockId,"]"),n=t==="created"?"is ".concat(t,"."):"is ".concat(t,", current queue ").concat(this.locks,". ").concat(e??"");qA.debug("".concat(i," ").concat(n))}setId(t){this.id=t}get isLocked(){return this.locks>0}lock(t){let e;this.locks+=1,this.logger("locked",t);let i=new Q(r=>{e=()=>{this.locks-=1,this.logger("unlocked",t),r()}}),n=this.lockingPromise.then(()=>e);return this.lockingPromise=this.lockingPromise.then(()=>i),n}};function Ma(t,e){return function(i,n,r){let o=r.value;if(typeof o!="function")throw new Error("Cannot use mutex on object property.");return r.value=function(){return I(this,arguments,function*(){let s=this[e];if(!s)throw new Error("mutex property key ".concat(e," doesn't exist on ").concat(t));let a=yield s.lock("From ".concat(t,".").concat(n));try{for(var c=arguments.length,d=new Array(c),l=0;l<c;l++)d[l]=arguments[l];return yield o.apply(this,d)}finally{a()}})},r}}let Oe={timeout:500,timeoutFactor:1.5,maxRetryCount:1/0,maxRetryTimeout:1e4};function yf(t,e){let i=Math.floor(e.timeout*Math.pow(e.timeoutFactor,t));return Math.min(e.maxRetryTimeout,i)}function er(t,e,i,n){let r=Object.assign({},Oe,n),o=r.timeout,s=()=>I(null,null,function*(){yield function(d){return new Q(l=>{window.setTimeout(l,d)})}(o),o*=r.timeoutFactor,o=Math.min(r.maxRetryTimeout,o)}),a=!1,c=new Q((d,l)=>I(null,null,function*(){e=e||(()=>!1),i=i||(()=>!0);for(let u=0;u<r.maxRetryCount;u+=1){if(a)return l(new F(C.OPERATION_ABORTED));try{let h=yield t();if(!e(h,u)||u+1===r.maxRetryCount)return d(h);yield s()}catch(h){if(!i(h,u)||u+1===r.maxRetryCount)return l(h);yield s()}}}));return c.cancel=()=>a=!0,c}let gh,YA=class{constructor(t){ft(this,"input",[]),ft(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}mean(){var t;return this.input.length===0?0:bn(t=this.input).call(t,(e,i)=>e+i)/this.input.length}},Sh=0,Cf=0;function bf(t,e,i,n){return new Q((r,o)=>{e.responseType=e.responseType||"json",e.data&&!i?(e.data=JSON.stringify(e.data),Sh+=vr(e.data)):i&&(e.data.size?Sh+=e.data.size:e.data instanceof FormData?Sh+=BA(e.data):Sh+=vr(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,bi.request(e).then(s=>{typeof s.data=="string"?Cf+=vr(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?Cf+=s.data.byteLength:Cf+=vr(JSON.stringify(s.data)),n&&r({data:s.data,headers:s.headers}),r(s.data)}).catch(s=>{bi.isCancel(s)?o(new F(C.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new F(C.NETWORK_TIMEOUT,s.message)):s.response?o(new F(C.NETWORK_RESPONSE_ERROR,s.response.status)):o(new F(C.NETWORK_ERROR,s.message))})})}function hK(t,e){return I(this,null,function*(){let i=new Blob([e.data],{type:"buffer"});return yield bf(t,tt(tt({},e),{},{data:i,headers:{"Content-Type":"application/octet-stream"}}),!0)})}let zA=()=>window.isSecureContext!==void 0;function Ln(t){if(Array.isArray(t))return t.map(i=>i);if(!XA(t))return t;let e={};for(let i in t){let n=t[i];XA(n)||Array.isArray(n)?e[i]=Ln(n):e[i]=n}return e}function XA(t){return!(typeof t!="object"||Array.isArray(t)||!t)}let If=class{constructor(t){ft(this,"input",[]),ft(this,"size",void 0),this.size=t}add(t){this.input.push(t),this.input.length>this.size&&this.input.splice(0,1)}diffMean(){return this.input.length===0?0:(this.input[this.input.length-1]-this.input[0])/this.input.length}},yr={address:"unknown",candidateType:"unknown",id:"unknown",port:0,priority:0,protocol:"unknown",type:"unknown"},Td={timestamp:0,bitrate:{actualEncoded:0,transmit:0},sendPacketLossRate:0,recvPacketLossRate:0,videoRecv:[],videoSend:[],audioRecv:[],audioSend:[],selectedCandidatePair:{id:"unknown",localCandidate:yr,remoteCandidate:yr},updateInterval:0},JA={firsCount:0,nacksCount:0,plisCount:0,framesDecodeCount:0,framesDecodeInterval:0,framesDecodeFreezeTime:0,decodeFrameRate:0,bytes:0,packetsLost:0,packetLostRate:0,packets:0,ssrc:0,qpSumPerFrame:0,framesDroppedCount:0,outputFrameRate:0,packetsDiscarded:0,framesAssembledFromMultiplePackets:0,totalProcessingDelay:0,avgDecodeMs:0,avgFramesAssembledFromMultiplePacketsMs:0,avgProcessingDelayMs:0,avgInterFrameDelayMs:0,totalAssemblyTime:0},QA={firsCount:0,nacksCount:0,plisCount:0,frameCount:0,bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0,qpSumPerFrame:0},ZA={bytes:0,packets:0,packetsLost:0,packetLostRate:0,ssrc:0,rttMs:0,jitterMs:0},$A={jitterBufferMs:0,jitterMs:0,bytes:0,packetsLost:0,packetLostRate:0,packetsDiscarded:0,packets:0,ssrc:0,receivedFrames:0,droppedFrames:0,concealedSamples:0,totalSamplesReceived:0,silentConcealedSamples:0,concealmentEvents:0,freezeMs80:0,freezeMs200:0,freezeSamples80:0,freezeSamples200:0},Af=class{constructor(t,e){ft(this,"onFirstVideoReceived",void 0),ft(this,"onFirstVideoDecoded",void 0),ft(this,"onFirstAudioReceived",void 0),ft(this,"onFirstVideoDecodedTimeout",void 0),ft(this,"onFirstAudioDecoded",void 0),ft(this,"onSelectedLocalCandidateChanged",void 0),ft(this,"onSelectedRemoteCandidateChanged",void 0),ft(this,"videoIsReady",!1),ft(this,"videoIsReady2",{}),ft(this,"pc",void 0),ft(this,"options",void 0),ft(this,"intervalTimer",void 0),ft(this,"stats",Ln(Td)),ft(this,"isFirstVideoReceived",{}),ft(this,"isFirstVideoDecoded",{}),ft(this,"isFirstAudioReceived",{}),ft(this,"isFirstAudioDecoded",{}),ft(this,"isFirstVideoDecodedTimeout",{}),ft(this,"lossRateWindowStats",[]),this.pc=t,this.options=e,this.intervalTimer=window.setInterval(()=>I(this,null,function*(){this.updateStats()}),this.options.updateInterval)}getStats(){return this.stats}getSelectedCandidatePair(){return new Q(t=>{t({local:tt({},yr),remote:tt({},yr)})})}setVideoIsReady(t){this.videoIsReady=t}setVideoIsReady2(t,e){this.videoIsReady2[t]=e}getVideoIsReady(t){return this.videoIsReady2[t]||!1}setIsFirstAudioDecoded(t){}destroy(){window.clearInterval(this.intervalTimer),this.pc=void 0}calcLossRate(t){this.lossRateWindowStats.push(t),this.lossRateWindowStats.length>this.options.lossRateInterval&&this.lossRateWindowStats.splice(0,1);let e=this.lossRateWindowStats.length,i=["videoSend","audioSend","videoRecv","audioRecv"],n=0,r=0,o=0,s=0;for(let a of i)t[a].forEach((c,d)=>{if(!this.lossRateWindowStats[e-1][a][d]||!this.lossRateWindowStats[0][a][d])return;let l=this.lossRateWindowStats[e-1][a][d].packets-this.lossRateWindowStats[0][a][d].packets,u=this.lossRateWindowStats[e-1][a][d].packetsLost-this.lossRateWindowStats[0][a][d].packetsLost;a==="videoSend"||a==="audioSend"?(n+=l,o+=u):(r+=l,s+=u),Number.isNaN(l)||Number.isNaN(l)?c.packetLostRate=0:c.packetLostRate=l<=0||u<=0?0:u/(l+u)});t.sendPacketLossRate=n<=0||o<=0?0:o/(n+o),t.recvPacketLossRate=r<=0||s<=0?0:s/(r+s)}},pK=class extends Af{constructor(){super(...arguments),ft(this,"_stats",Td),ft(this,"lastDecodeVideoReceiverStats",new Map)}updateStats(){return I(this,null,function*(){let t=yield this._getStats(),e=this.statsResponsesToObjects(t);this._stats=Ln(Td);let i=e.filter(r=>r.type==="ssrc");this.processSSRCStats(i);let n=e.find(r=>r.type==="VideoBwe");n&&this.processBandwidthStats(n),this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats})}processBandwidthStats(t){this._stats.bitrate={actualEncoded:Number(t.googActualEncBitrate),targetEncoded:Number(t.googTargetEncBitrate),retransmit:Number(t.googRetransmitBitrate),transmit:Number(t.googTransmitBitrate)},this._stats.sendBandwidth=Number(t.googAvailableSendBandwidth)}processSSRCStats(t){t.forEach(e=>{var i;let n=z(i=e.id).call(i,"send");switch("".concat(e.mediaType,"_").concat(n?"send":"recv")){case"video_send":{let r=Ln(QA);r.codec=e.googCodecName,r.adaptionChangeReason="none",e.googCpuLimitedResolution&&(r.adaptionChangeReason="cpu"),e.googBandwidthLimitedResolution&&(r.adaptionChangeReason="bandwidth"),r.avgEncodeMs=Number(e.googAvgEncodeMs),r.inputFrame={width:Number(e.googFrameWidthInput)||Number(e.googFrameWidthSent),height:Number(e.googFrameHeightInput)||Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.sentFrame={width:Number(e.googFrameWidthSent),height:Number(e.googFrameHeightSent),frameRate:Number(e.googFrameRateInput)},r.firsCount=Number(e.googFirReceived),r.nacksCount=Number(e.googNacksReceived),r.plisCount=Number(e.googPlisReceived),r.frameCount=Number(e.framesEncoded),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.videoSend.push(r),this._stats.rtt=r.rttMs;break}case"video_recv":{let r=Ln(JA),o=this.lastDecodeVideoReceiverStats.get(Number(e.ssrc));if(r.codec=e.googCodecName,r.targetDelayMs=Number(e.googTargetDelayMs),r.renderDelayMs=Number(e.googRenderDelayMs),r.currentDelayMs=Number(e.googCurrentDelayMs),r.minPlayoutDelayMs=Number(e.googMinPlayoutDelayMs),r.decodeMs=Number(e.googDecodeMs),r.maxDecodeMs=Number(e.googMaxDecodeMs),r.receivedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateReceived)},r.decodedFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateDecoded)},r.decodeFrameRate=Number(e.googFrameRateDecoded),r.outputFrame={width:Number(e.googFrameWidthReceived),height:Number(e.googFrameHeightReceived),frameRate:Number(e.googFrameRateOutput)},r.jitterBufferMs=Number(e.googJitterBufferMs),r.firsCount=Number(e.googFirsSent),r.nacksCount=Number(e.googNacksSent),r.plisCount=Number(e.googPlisSent),r.framesDecodeCount=Number(e.framesDecoded),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.packets>0&&!this.isFirstVideoReceived[r.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(r.ssrc),this.isFirstVideoReceived[r.ssrc]=!0),r.framesDecodeCount>0&&!this.isFirstVideoDecoded[r.ssrc]&&(this.onFirstVideoDecoded&&this.onFirstVideoDecoded(r.ssrc,r.decodedFrame.width,r.decodedFrame.height),this.isFirstVideoDecoded[r.ssrc]=!0),o){let s=o.stats,a=Date.now()-o.lts;r.framesDecodeFreezeTime=s.framesDecodeFreezeTime,r.framesDecodeInterval=s.framesDecodeInterval,r.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[r.ssrc]?(o.lts=Date.now(),r.framesDecodeInterval=a,r.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(e.ssrc,10))?r.framesDecodeFreezeTime+=r.framesDecodeInterval:this.setVideoIsReady2(parseInt(e.ssrc,10),!0))):r.framesDecodeCount<o.stats.framesDecodeCount&&(r.framesDecodeInterval=0)}this.lastDecodeVideoReceiverStats.set(r.ssrc,{stats:tt({},r),lts:Date.now()}),this._stats.videoRecv.push(r);break}case"audio_recv":{let r=Ln($A);r.codec=e.googCodecName,r.outputLevel=Math.abs(Number(e.audioOutputLevel))/32767,r.decodingCNG=Number(e.googDecodingCNG),r.decodingCTN=Number(e.googDecodingCTN),r.decodingCTSG=Number(e.googDecodingCTSG),r.decodingNormal=Number(e.googDecodingNormal),r.decodingPLC=Number(e.googDecodingPLC),r.decodingPLCCNG=Number(e.googDecodingPLCCNG),r.expandRate=Number(e.googExpandRate),r.accelerateRate=Number(e.googAccelerateRate),r.preemptiveExpandRate=Number(e.googPreemptiveExpandRate),r.secondaryDecodedRate=Number(e.googSecondaryDecodedRate),r.speechExpandRate=Number(e.googSpeechExpandRate),r.preferredJitterBufferMs=Number(e.googPreferredJitterBufferMs),r.jitterBufferMs=Number(e.googJitterBufferMs),r.jitterMs=Number(e.googJitterReceived),r.bytes=Number(e.bytesReceived),r.packets=Number(e.packetsReceived),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.receivedFrames=Number(e.googDecodingCTN)||Number(e.packetsReceived),r.droppedFrames=Number(e.googDecodingPLC)+Number(e.googDecodingPLCCNG)||Number(e.packetsLost),r.receivedFrames>0&&!this.isFirstAudioReceived[r.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(r.ssrc),this.isFirstAudioReceived[r.ssrc]=!0),r.decodingNormal>0&&!this.isFirstAudioDecoded[r.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(r.ssrc),this.isFirstAudioDecoded[r.ssrc]=!0),this._stats.audioRecv.push(r);break}case"audio_send":{let r=Ln(ZA);r.codec=e.googCodecName,r.inputLevel=Math.abs(Number(e.audioInputLevel))/32767,r.aecReturnLoss=Number(e.googEchoCancellationReturnLoss||0),r.aecReturnLossEnhancement=Number(e.googEchoCancellationReturnLossEnhancement||0),r.residualEchoLikelihood=Number(e.googResidualEchoLikelihood||0),r.residualEchoLikelihoodRecentMax=Number(e.googResidualEchoLikelihoodRecentMax||0),r.bytes=Number(e.bytesSent),r.packets=Number(e.packetsSent),r.packetsLost=Number(e.packetsLost),r.ssrc=Number(e.ssrc),r.rttMs=Number(e.googRtt||0),this._stats.rtt=r.rttMs,this._stats.audioSend.push(r);break}}})}_getStats(){return new Q((t,e)=>{this.pc.getStats(t,e)})}statsResponsesToObjects(t){let e=[];return t.result().forEach(i=>{let n={id:i.id,timestamp:i.timestamp.valueOf().toString(),type:i.type};i.names().forEach(r=>{n[r]=i.stat(r)}),e.push(n)}),e}},Rd=function(t){return t.BANDWIDTH="bandwidth",t.CPU="cpu",t.NONE="none",t.OTHER="other",t}({}),Th=function(t){return t.L1T1="L1T1",t.L1T2="L1T2",t.L1T3="L1T3",t.L1T3_KEY="L1T3_KEY",t.L2T1_KEY="L2T1_KEY",t.L2T2_KEY="L2T2_KEY",t.L2T3_KEY="L2T3_KEY",t.L3T1_KEY="L3T1_KEY",t.L3T2_KEY="L3T2_KEY",t.L3T3_KEY="L3T3_KEY",t}({}),wf=function(t){return t[t.new=0]="new",t[t.connecting=1]="connecting",t[t.connected=2]="connected",t[t.disconnected=3]="disconnected",t[t.failed=4]="failed",t[t.closed=5]="closed",t}({}),Qi=function(t){return t.CERTIFICATE="certificate",t.CODEC="codec",t.CANDIDATE_PAIR="candidate-pair",t.LOCAL_CANDIDATE="local-candidate",t.REMOTE_CANDIDATE="remote-candidate",t.INBOUND="inbound-rtp",t.TRACK="track",t.OUTBOUND="outbound-rtp",t.PC="peer-connection",t.REMOTE_INBOUND="remote-inbound-rtp",t.REMOTE_OUTBOUND="remote-outbound-rtp",t.TRANSPORT="transport",t.CSRC="csrc",t.DATA_CHANNEL="data-channel",t.STREAM="stream",t.SENDER="sender",t.RECEIVER="receiver",t}({});var Ua=function(t){return t[t.kNone=1]="kNone",t[t.kMillisecondsFromSeconds=1e3]="kMillisecondsFromSeconds",t[t.kBytesToBits=8]="kBytesToBits",t}(Ua||{});function vd(t,e,i,n){let r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:Ua.kNone;if(!e)return;let o=Number(e[i]);if(typeof o!="number")return;let s=Number(e[n]);if(typeof s!="number")return;if(!t)return s?o/s*r:void 0;let a=Number(t[i]);if(typeof a!="number")return;let c=Number(t[n]);if(typeof c!="number")return;let d=s-c;return d?(o-a)/d*r:void 0}let tw=class extends Af{constructor(){super(...arguments),ft(this,"_stats",Td),ft(this,"report",void 0),ft(this,"lastDecodeVideoReceiverStats",new Map),ft(this,"lastVideoFramesRecv",new Map),ft(this,"lastVideoFramesSent",new Map),ft(this,"lastVideoFramesDecode",new Map),ft(this,"lastVideoFramesOutput",new Map),ft(this,"lastVideoJBDelay",new Map),ft(this,"lastAudioJBDelay",new Map),ft(this,"mediaBytesSent",new Map),ft(this,"mediaBytesRetransmit",new Map),ft(this,"mediaBytesTargetEncode",new Map),ft(this,"lastDecodeAudioReceiverStats",new Map),ft(this,"lastAudioConcealment",new Map),ft(this,"lastEncoderMs",new Map)}updateStats(){return I(this,null,function*(){this.report=yield this.pc.getStats(),this._stats=Ln(Td),this.report.forEach(t=>{switch(t.type){case Qi.OUTBOUND:case Qi.INBOUND:{let e=t.mediaType||t.kind,i=!e&&"frameWidth"in t,n=!e&&!("frameWidth"in t);t.type===Qi.OUTBOUND?e==="audio"||n?this.processAudioOutboundStats(t):(e==="video"||i)&&this.processVideoOutboundStats(t):t.type===Qi.INBOUND&&(e==="audio"||n?this.processAudioInboundStats(t):(e==="video"||i)&&this.processVideoInboundStats(t));break}case Qi.TRANSPORT:{let e=this.report.get(t.selectedCandidatePairId);e&&this.processCandidatePairStats(e);break}case Qi.CANDIDATE_PAIR:t.selected&&this.processCandidatePairStats(t)}}),this.updateSendBitrate(),this._stats.updateInterval=Date.now()-this.stats.timestamp,this._stats.timestamp=Date.now(),this.calcLossRate(this._stats),this.stats=this._stats})}getSelectedCandidatePair(){return I(this,null,function*(){let t=yield this.pc.getStats(),e={local:tt({},yr),remote:tt({},yr)};return t.forEach(i=>{let n;if(i.type===Qi.TRANSPORT&&(n=t.get(i.selectedCandidatePairId)),i.type===Qi.CANDIDATE_PAIR&&i.selected&&(n=i),n){let r=(o,s)=>{o.type=s.type,o.id=s.id,s.address&&(o.address=s.address),s.candidateType&&(o.candidateType=s.candidateType),s.port&&(o.port=s.port),s.priority&&(o.priority=s.priority),s.protocol&&(o.protocol=s.protocol),s.relayProtocol&&(o.relayProtocol=s.relayProtocol)};if(n.localCandidateId){let o=t.get(n.localCandidateId);o&&r(e.local,o)}if(n.remoteCandidateId){let o=t.get(n.remoteCandidateId);o&&r(e.remote,o)}}}),e})}processCandidatePairStats(t){if(this._stats.sendBandwidth=t.availableOutgoingBitrate||0,t.currentRoundTripTime&&(this._stats.rtt=1e3*t.currentRoundTripTime),this._stats.videoSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.audioSend.forEach(e=>{t.currentRoundTripTime&&(e.rttMs=1e3*t.currentRoundTripTime)}),this._stats.selectedCandidatePair.id=t.id,t.localCandidateId){let e=this.report.get(t.localCandidateId);e&&this.processCandidateStats(e)}if(t.remoteCandidateId){let e=this.report.get(t.remoteCandidateId);e&&this.processCandidateStats(e)}}processCandidateStats(t){let e;t.type===Qi.LOCAL_CANDIDATE&&(e=this._stats.selectedCandidatePair.localCandidate),t.type===Qi.REMOTE_CANDIDATE&&(e=this._stats.selectedCandidatePair.remoteCandidate),e&&(e.type=t.type,e.id=t.id,t.address&&(e.address=t.address),t.candidateType&&(e.candidateType=t.candidateType),t.port&&(e.port=t.port),t.priority&&(e.priority=t.priority),t.protocol&&(e.protocol=t.protocol),t.relayProtocol&&(e.relayProtocol=t.relayProtocol),t.type===Qi.LOCAL_CANDIDATE&&this.stats.selectedCandidatePair.localCandidate.id!==e.id&&this.onSelectedLocalCandidateChanged&&this.onSelectedLocalCandidateChanged(tt({},e),tt({},this.stats.selectedCandidatePair.localCandidate)),t.type===Qi.REMOTE_CANDIDATE&&this.stats.selectedCandidatePair.remoteCandidate.id!==e.id&&this.onSelectedRemoteCandidateChanged&&this.onSelectedRemoteCandidateChanged(tt({},e),tt({},this.stats.selectedCandidatePair.remoteCandidate)))}processAudioInboundStats(t){let e=this._stats.audioRecv.find(n=>n.ssrc===t.ssrc);e||(e=Ln($A),this._stats.audioRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.packetsDiscarded=t.packetsDiscarded,e.bytes=t.bytesReceived,e.jitterMs=1e3*t.jitter,e.retransmittedBytesReceived=t.retransmittedBytesReceived,e.retransmittedPacketsReceived=t.retransmittedPacketsReceived,e.totalProcessingDelay=t.totalProcessingDelay,e.jitterBufferEmittedCount=t.jitterBufferEmittedCount;let i=this.lastDecodeAudioReceiverStats.get(e.ssrc);e.avgProcessingDelayMs=vd(i,e,"totalProcessingDelay","jitterBufferEmittedCount",Ua.kMillisecondsFromSeconds),this.processAudioTrackReceiverStats(t,t.trackId,e),this.calculateAudioFreeze(e,i,t),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),e.receivedFrames||(e.receivedFrames=t.packetsReceived),e.droppedFrames||(e.droppedFrames=t.packetsLost),e.receivedFrames>0&&!this.isFirstAudioReceived[e.ssrc]&&(this.onFirstAudioReceived&&this.onFirstAudioReceived(e.ssrc),this.isFirstAudioReceived[e.ssrc]=!0),e.outputLevel&&e.outputLevel>0&&!this.isFirstAudioDecoded[e.ssrc]&&(this.onFirstAudioDecoded&&this.onFirstAudioDecoded(e.ssrc),this.isFirstAudioDecoded[e.ssrc]=!0),typeof t.concealedSamples=="number"&&(e.concealedSamples=t.concealedSamples),this.lastDecodeAudioReceiverStats.set(e.ssrc,tt({},e))}calculateAudioFreeze(t,e,i){let n=this.lastAudioConcealment.get(t.ssrc);if(e!=null&&n!=null){let r=n.lts,o=i.timestamp,s=o-r;if(s<=0)return;let a=t.concealedSamples-e.concealedSamples-0,c=n.nonSilent+a,d=t.totalSamplesReceived-e.totalSamplesReceived;if(d<=0)return;let l=80*d/s,u=200*d/s,h=s/d,p=0;t.freezeSamples80=e.freezeSamples80,t.freezeMs80=e.freezeMs80,c>l&&(n.plc80>0?(t.freezeSamples80+=a,t.freezeMs80+=Math.round(a*h)):(t.freezeSamples80+=c,t.freezeMs80+=Math.round(c*h)),p=n.plc80+1);let g=0;t.freezeSamples200=e.freezeSamples200,t.freezeMs200=e.freezeMs200,c>u&&(n.plc200>0?(t.freezeSamples200+=a,t.freezeMs200+=Math.round(a*h)):(t.freezeSamples200+=c,t.freezeMs200+=Math.round(c*h)),g=n.plc200+1),this.lastAudioConcealment.set(t.ssrc,{nonSilent:a,lts:o,plc80:p,plc200:g})}else t.freezeSamples80=0,t.freezeSamples200=0,t.freezeMs80=0,t.freezeMs200=0,this.lastAudioConcealment.set(t.ssrc,{nonSilent:0,lts:i.timestamp,plc80:0,plc200:0})}processVideoInboundStats(t){let e=this._stats.videoRecv.find(s=>s.ssrc===t.ssrc);e||(e=Ln(JA),this._stats.videoRecv.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsReceived,e.packetsLost=t.packetsLost,e.bytes=t.bytesReceived,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.framesDecodeCount=t.framesDecoded,e.framesDroppedCount=t.framesDropped,e.totalInterFrameDelay=t.totalInterFrameDelay,e.totalSquaredInterFrameDelay=t.totalSquaredInterFrameDelay,e.totalFreezesDuration=t.totalFreezesDuration,e.totalProcessingDelay=t.totalProcessingDelay,e.packetsDiscarded=t.packetsDiscarded,e.framesAssembledFromMultiplePackets=t.framesAssembledFromMultiplePackets,e.totalAssemblyTime=t.totalAssemblyTime,e.keyFramesDecoded=t.keyFramesDecoded,e.retransmittedBytesReceived=t.retransmittedBytesReceived,e.retransmittedPacketsReceived=t.retransmittedPacketsReceived;let i=this.lastDecodeVideoReceiverStats.get(e.ssrc),n=this.lastVideoFramesDecode.get(e.ssrc),r=this.lastVideoFramesOutput.get(e.ssrc),o=Date.now();if(e.framesDecodeCount>0&&!this.isFirstVideoDecoded[e.ssrc]){let s=e.decodedFrame?e.decodedFrame.width:0,a=e.decodedFrame?e.decodedFrame.height:0;this.onFirstVideoDecoded&&this.onFirstVideoDecoded(e.ssrc,s,a),this.isFirstVideoDecoded[e.ssrc]=!0}if(i){let s=i.stats,a=o-i.lts;e.framesDecodeFreezeTime=s.framesDecodeFreezeTime,e.framesDecodeInterval=s.framesDecodeInterval,!this.isFirstVideoDecoded[e.ssrc]&&a>this.options.firstVideoDecodedTimeout&&!this.isFirstVideoDecodedTimeout[e.ssrc]&&(this.onFirstVideoDecodedTimeout&&this.onFirstVideoDecodedTimeout(e.ssrc),this.isFirstVideoDecodedTimeout[e.ssrc]=!0),e.framesDecodeCount>s.framesDecodeCount&&this.isFirstVideoDecoded[e.ssrc]?(i.lts=Date.now(),e.framesDecodeInterval=a,e.framesDecodeInterval>=this.options.freezeRateLimit&&(this.getVideoIsReady(parseInt(t.ssrc))?e.framesDecodeFreezeTime+=e.framesDecodeInterval:this.setVideoIsReady2(parseInt(t.ssrc,10),!0))):e.framesDecodeCount<s.framesDecodeCount&&(e.framesDecodeInterval=0),t.framesDecoded&&t.qpSum&&(i.stats.framesDecodeCount>t.framesDecoded?e.qpSumPerFrame=t.qpSum/t.framesDecoded:e.qpSumPerFrame=(t.qpSum-i.qpSum)/(t.framesDecoded-i.stats.framesDecodeCount))}t.totalDecodeTime&&(e.decodeMs=1e3*t.totalDecodeTime,e.avgDecodeMs=vd(i?.stats,e,"decodeMs","framesDecodeCount")),e.avgProcessingDelayMs=vd(i?.stats,e,"totalProcessingDelay","framesDecodeCount",Ua.kMillisecondsFromSeconds),e.avgFramesAssembledFromMultiplePacketsMs=vd(i?.stats,e,"totalAssemblyTime","framesAssembledFromMultiplePackets",Ua.kMillisecondsFromSeconds),e.avgInterFrameDelayMs=vd(i?.stats,e,"totalInterFrameDelay","framesDecodeCount",Ua.kMillisecondsFromSeconds),n&&o-n.lts>=800?(e.decodeFrameRate=Math.round((e.framesDecodeCount-n.count)/((o-n.lts)/1e3)),this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:o,rate:e.decodeFrameRate})):n?e.decodeFrameRate=n.rate:this.lastVideoFramesDecode.set(e.ssrc,{count:e.framesDecodeCount,lts:o,rate:0}),e.framesDroppedCount&&t.framesReceived&&(r&&o-r.lts>=800?(e.outputFrameRate=Math.round((t.framesReceived-e.framesDroppedCount-r.count)/((o-r.lts)/1e3)),this.lastVideoFramesOutput.set(e.ssrc,{count:t.framesReceived-e.framesDroppedCount,lts:o,rate:Math.max(e.outputFrameRate,0)})):r?e.outputFrameRate=r.rate:this.lastVideoFramesOutput.set(e.ssrc,{count:t.framesReceived-e.framesDroppedCount,lts:o,rate:0})),this.processVideoTrackReceiverStats(t,t.trackId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.framerateMean&&(e.framesRateFirefox=t.framerateMean),e.packets>0&&!this.isFirstVideoReceived[e.ssrc]&&(this.onFirstVideoReceived&&this.onFirstVideoReceived(e.ssrc),this.isFirstVideoReceived[e.ssrc]=!0),this.lastDecodeVideoReceiverStats.set(e.ssrc,{stats:tt({},e),lts:i?i.lts:Date.now(),qpSum:t.qpSum})}processVideoOutboundStats(t){let e=this._stats.videoSend.find(n=>n.ssrc===t.ssrc);e||(e=Ln(QA),this._stats.videoSend.push(e));let i=this.mediaBytesSent.get(t.ssrc);if(i)i.add(t.bytesSent);else{let n=new If(10);n.add(t.bytesSent),this.mediaBytesSent.set(t.ssrc,n)}if(t.retransmittedBytesSent!==void 0){let n=this.mediaBytesRetransmit.get(t.ssrc);if(n)n.add(t.retransmittedBytesSent);else{let r=new If(10);r.add(t.retransmittedBytesSent),this.mediaBytesRetransmit.set(t.ssrc,r)}}if(t.totalEncodedBytesTarget){let n=this.mediaBytesTargetEncode.get(t.ssrc);if(n)n.add(t.totalEncodedBytesTarget);else{let r=new If(10);r.add(t.totalEncodedBytesTarget),this.mediaBytesTargetEncode.set(t.ssrc,r)}}if(e.ssrc=t.ssrc,e.bytes=t.bytesSent,e.packets=t.packetsSent,e.firsCount=t.firCount,e.nacksCount=t.nackCount,e.plisCount=t.pliCount,e.frameCount=t.framesEncoded,e.adaptionChangeReason=t.qualityLimitationReason,e.scalabilityMode=t.scalabilityMode,e.retransmittedBytesSent=t.retransmittedBytesSent,e.retransmittedPacketsSent=t.retransmittedPacketsSent,e.hugeFramesSent=t.hugeFramesSent,e.keyFramesEncoded=t.keyFramesEncoded,e.targetBitrate=t.targetBitrate,t.totalEncodeTime&&t.framesEncoded){let n=this.lastEncoderMs.get(t.ssrc);if(!n||n.lastFrameCount>t.framesEncoded)e.avgEncodeMs=1e3*t.totalEncodeTime/t.framesEncoded;else{let r=t.framesEncoded-n.lastFrameCount,o=t.totalEncodeTime-n.lastEncoderTime;e.avgEncodeMs=1e3*o/r}}if(t.framesEncoded&&t.qpSum){let n=this.lastEncoderMs.get(t.ssrc);!n||n.lastFrameCount>t.framesEncoded?e.qpSumPerFrame=t.qpSum/t.framesEncoded:e.qpSumPerFrame=(t.qpSum-n.lastQpSum)/(t.framesEncoded-n.lastFrameCount)}if(this.lastEncoderMs.set(t.ssrc,{lastFrameCount:t.framesEncoded,lastEncoderTime:t.totalEncodeTime,lastQpSum:t.qpSum,lts:Date.now()}),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),t.mediaSourceId&&this.processVideoMediaSource(t.mediaSourceId,e),this.processVideoTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{let n=this.findRemoteStatsId(t.ssrc,Qi.REMOTE_INBOUND);n&&this.processRemoteInboundStats(n,e)}}processAudioOutboundStats(t){let e=this._stats.audioSend.find(i=>i.ssrc===t.ssrc);if(e||(e=Ln(ZA),this._stats.audioSend.push(e)),e.ssrc=t.ssrc,e.packets=t.packetsSent,e.bytes=t.bytesSent,e.retransmittedBytesSent=t.retransmittedBytesSent,e.retransmittedPacketsSent=t.retransmittedPacketsSent,t.mediaSourceId&&this.processAudioMediaSource(t.mediaSourceId,e),t.codecId&&(e.codec=this.getCodecFromCodecStats(t.codecId)),this.processAudioTrackSenderStats(t,t.trackId,e),t.remoteId)this.processRemoteInboundStats(t.remoteId,e);else{let i=this.findRemoteStatsId(t.ssrc,Qi.REMOTE_INBOUND);i&&this.processRemoteInboundStats(i,e)}}findRemoteStatsId(t,e){var i;let n=Array.from(Bi(i=this.report).call(i)).find(r=>r.type===e&&r.ssrc===t);return n?n.id:null}processVideoMediaSource(t,e){let i=this.report.get(t);i&&i.width&&i.height&&i.framesPerSecond&&(e.inputFrame={width:i.width,height:i.height,frameRate:i.framesPerSecond})}processAudioMediaSource(t,e){let i=this.report.get(t);i&&(e.inputLevel=i.audioLevel)}processVideoTrackSenderStats(t,e,i){var n,r,o,s;let a=e?this.report.get(e):void 0,c=(n=a?.framesSent)!==null&&n!==void 0?n:t.framesSent;if(typeof c!="number")return;let d=(r=a?.frameWidth)!==null&&r!==void 0?r:t.frameWidth,l=(o=a?.frameHeight)!==null&&o!==void 0?o:t.frameHeight,u=(s=a?.framesPerSecond)!==null&&s!==void 0?s:t.framesPerSecond;if(typeof d=="number"&&typeof l=="number"||(d=0,l=0),u==null){let h=Date.now(),p=this.lastVideoFramesSent.get(i.ssrc);p&&h-p.lts>=800?(u=Math.round((c-p.count)/((h-p.lts)/1e3)),this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:h,rate:u})):p?u=p.rate:this.lastVideoFramesSent.set(i.ssrc,{count:c,lts:h,rate:0})}i.sentFrame={width:d,height:l,frameRate:Math.max(0,u)}}processVideoTrackReceiverStats(t,e,i){var n,r,o,s,a;let c=e?this.report.get(e):void 0,d=(n=c?.framesReceived)!==null&&n!==void 0?n:t.framesReceived,l=(r=c?.frameWidth)!==null&&r!==void 0?r:t.frameWidth,u=(o=c?.frameHeight)!==null&&o!==void 0?o:t.frameHeight,h=(s=c?.jitterBufferDelay)!==null&&s!==void 0?s:t.jitterBufferDelay,p=(a=c?.jitterBufferEmittedCount)!==null&&a!==void 0?a:t.jitterBufferEmittedCount;if(typeof d=="number"){let g=this.lastVideoFramesRecv.get(i.ssrc),E=Date.now();i.framesReceivedCount=d;let f=0;g&&E-g.lts>=800?(f=Math.round((d-g.count)/((E-g.lts)/1e3)),this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:E,rate:f})):g?f=g.rate:this.lastVideoFramesRecv.set(i.ssrc,{count:d,lts:E,rate:0}),i.receivedFrame={width:l||0,height:u||0,frameRate:f||0},i.decodedFrame={width:l||0,height:u||0,frameRate:i.decodeFrameRate||0},i.outputFrame={width:l||0,height:u||0,frameRate:i.outputFrameRate||i.decodeFrameRate||0}}if(h&&p){let g=this.lastVideoJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},E=g.jitterBufferMs,f=p-g.jitterBufferEmittedCount;f>0&&(E=1e3*(h-g.jitterBufferDelay)/f),i.jitterBufferMs=E,i.currentDelayMs=Math.round(E),this.lastVideoJBDelay.set(i.ssrc,{jitterBufferDelay:h,jitterBufferEmittedCount:p,jitterBufferMs:i.currentDelayMs})}}processAudioTrackSenderStats(t,e,i){var n,r,o,s;let a=e?this.report.get(e):void 0,c=(n=(r=a?.echoReturnLoss)!==null&&r!==void 0?r:t.echoReturnLoss)!==null&&n!==void 0?n:0,d=(o=(s=a?.echoReturnLossEnhancement)!==null&&s!==void 0?s:t.echoReturnLossEnhancement)!==null&&o!==void 0?o:0;i.aecReturnLoss=c,i.aecReturnLossEnhancement=d}processAudioTrackReceiverStats(t,e,i){var n,r,o,s,a,c,d,l,u;let h=e?this.report.get(e):void 0,p=(n=h?.removedSamplesForAcceleration)!==null&&n!==void 0?n:t.removedSamplesForAcceleration,g=(r=h?.totalSamplesReceived)!==null&&r!==void 0?r:t.totalSamplesReceived,E=(o=h?.jitterBufferDelay)!==null&&o!==void 0?o:t.jitterBufferDelay,f=(s=h?.jitterBufferEmittedCount)!==null&&s!==void 0?s:t.jitterBufferEmittedCount,R=(a=h?.audioLevel)!==null&&a!==void 0?a:t?.audioLevel,y=(c=h?.totalSamplesDuration)!==null&&c!==void 0?c:t?.totalSamplesDuration,N=(d=h?.concealedSamples)!==null&&d!==void 0?d:t.concealedSamples,k=(l=h?.silentConcealedSamples)!==null&&l!==void 0?l:t.silentConcealedSamples,L=(u=h?.concealmentEvents)!==null&&u!==void 0?u:t.concealmentEvents;if(typeof g=="number"&&(i.totalSamplesReceived=g),typeof k=="number"&&(i.silentConcealedSamples=k),typeof L=="number"&&(i.concealmentEvents=L),typeof N=="number"&&(i.concealedSamples=N),p&&g&&(i.accelerateRate=p/g),E&&f){let V=this.lastAudioJBDelay.get(i.ssrc)||{jitterBufferDelay:0,jitterBufferEmittedCount:0,jitterBufferMs:0},B=V.jitterBufferMs,Y=f-V.jitterBufferEmittedCount;Y>0&&(B=1e3*(E-V.jitterBufferDelay)/Y),i.jitterBufferMs=Math.round(B),this.lastAudioJBDelay.set(i.ssrc,{jitterBufferDelay:E,jitterBufferEmittedCount:f,jitterBufferMs:i.jitterBufferMs})}i.outputLevel=R;let P=1920;y&&g&&(P=g/y/50,i.receivedFrames=Math.round(g/P)),N&&(i.droppedFrames=Math.round(N/P))}processRemoteInboundStats(t,e){let i=this.report.get(t);i&&(e.packetsLost=i.packetsLost,i.roundTripTime&&(e.rttMs=1e3*i.roundTripTime),i.jitter&&(e.jitterMs=1e3*i.jitter),i.timestamp&&(e.timestamp=i.timestamp))}getCodecFromCodecStats(t){let e=this.report.get(t);if(!e)return"";let i=e.mimeType.match(/\/(.*)$/);return i&&i[1]?i[1]:""}updateSendBitrate(){let t=0,e=null,i=null;this.mediaBytesSent.forEach(r=>{t+=r.diffMean()}),this.mediaBytesRetransmit.forEach(r=>{e=e===null?r.diffMean():e+r.diffMean()}),this.mediaBytesTargetEncode.forEach(r=>{i=i===null?r.diffMean():i+r.diffMean()});let n=e!==null?t-e:t;this._stats.bitrate={actualEncoded:8*n/(this.options.updateInterval/1e3),transmit:8*t/(this.options.updateInterval/1e3)},e!==null&&(this._stats.bitrate.retransmit=8*e/(this.options.updateInterval/1e3)),i!==null&&(this._stats.bitrate.targetEncoded=8*i/(this.options.updateInterval/1e3))}},_K=class extends Af{updateStats(){return Q.resolve()}};function Of(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:250,i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:8,n=arguments.length>3&&arguments[3]!==void 0?arguments[3]:500,r=arguments.length>4&&arguments[4]!==void 0?arguments[4]:1e4,o=function(){let s=navigator.userAgent.toLocaleLowerCase().match(/chrome\/[\d]*/i);return s&&s[0]?Number(s[0].split("/")[1]):null}();return o?o<76?new pK(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):new tw(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):function(s){if(!window.RTCStatsReport)return!1;let a=s.getStats();return!!(a instanceof Q||function(c){return!!c&&(typeof c=="object"||typeof c=="function")&&typeof c.then=="function"}(a))}(t)?new tw(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r}):new _K(t,{updateInterval:e,lossRateInterval:i,freezeRateLimit:n,firstVideoDecodedTimeout:r})}let ew="websdk_ng_install_id";function Nf(){try{if(A("INSTALL_ID"))return A("INSTALL_ID");let t=window.localStorage.getItem(ew);return t||(t=Rs(),window.localStorage.setItem(ew,t)),qt("INSTALL_ID",t),t}catch{return}}let hn=function(t){if(t.match(/[0-9]+\.[0-9]+\.[0-9]+$/))return t;let e=t.match(/([0-9]+\.[0-9]+\.[0-9]+)\-([0-9]+)/);if(e&&e[1]&&e[2]){let i=e[1],n=e[2];return"".concat(i,".").concat(n)}return"4.0.0.999"}("4.23.4"),Df=function(){try{return JSON.parse("true")===!0}catch{return!0}}(),vs=function(t){return t.Default="default",t.Auto="auto",t.Relay="relay",t.SdRtn="sd-rtn",t}({}),ti=function(){let t="us".concat("erna","me"),e="pa".concat("sswo","rd"),i=["t","s","t"];i.splice(1,0,"e");let n=i.join(""),r=[];for(let a=0;a<6;a++)r.push("1");let o=r.join(""),s={};return s[t]=n,s[e]=o,Object.assign(s,{turnServerURL:"",tcpport:3433,udpport:3478,forceturn:!1})}();window.DEFAULT_TURN_CONFIG=ti;let Rh={ENABLE_PUBLISHED_USER_LIST:!0,MAX_SUBSCRIPTION:50,SUBSCRIBE_AUDIO_FILTER_TOPN:void 0,ENABLE_PUBLISH_AUDIO_FILTER:void 0,ENABLE_USER_LICENSE_CHECK:!0,DISABLE_FEC:void 0,ENABLE_NTP_REPORT:!1,ENABLE_INSTANT_VIDEO:!1,ENABLE_USER_AUTO_REBALANCE_CHECK:!0,ENABLE_LOSSBASED_BWE:!0,ENABLE_AUT_CC:!1,ENABLE_CC_FALLBACK:void 0,SUBSCRIBE_TWCC:!0,PUBLISH_TWCC:!1,ENABLE_SVC_DEFAULT_CODECS:["H264","VP8","VP9","AV1"],SVC:[],ENABLE_FULL_LINK_AV_SYNC:!1,SVC_MODE:null,PRE_SUB_NUM:2,ENABLE_AUT_FEEDBACK:!1,SVC_EXTENDED:["VP9"]},Pf={MIN_FRAME_RATE:1,MAX_FRAME_RATE:30,MAX_THRESHOLD_FRAMERATE:30,BITRATE_MIN_THRESHOLD:100,BITRATE_MAX_THRESHOLD:100,MAX_SCALE:5,BWE_SCALE_UP_THRESHOLD:.6,BWE_SCALE_DOWN_THRESHOLD:.6,PERF_SCALE_UP_THRESHOLD:.7,PERF_SCALE_DOWN_THRESHOLD:.6,MOTION_RESOLUTION_FACTOR:.8,MOTION_BITRATE_FACTOR:.6,DETAIL_FRAMERATE_FACTOR:.8,DETAIL_BITRATE_FACTOR:.6,BALANCE_RESOLUTION_FACTOR:.9,BALANCE_FRAMERATE_FACTOR:.9,BALANCE_BITRATE_FACTOR:.6,OVERUSE_TIMES_THRESHOLD:10,UNDERUSE_TIMES_THRESHOLD:40},Lf="v4.23.4-0-g17410532-dirty(6/5/2025, 4:24:52 PM)",kf={ENABLE_EVENT_REPORT:!0,UPLOAD_LOG:!1,ENABLE_AG_ADAPTATION:!0,FORCE_AG_HIGH_FRAMERATE:!1,FORCE_SUPPORT_AG_ADAPTATION:!1,ENCODER_CONFIG_LIMIT:{},CAMERA_CAPTURE_CONFIG:void 0,ENABLE_PRELOAD:!0,NEW_ICE_RESTART:!1,ICE_RESTART_INTERVAL:1e4,RESTART_SEQUENCE:["udp_tcp_relay","relay"],FIRST_TCP_CANDIDATE:!1,FIRST_TCP_CANDIDATE_INTERVAL:1e3,TURN_DOMAIN:"edge.agora.io",USE_TURN_IP:!1,NEW_TURN_MODE:void 0,NEW_FORCE_TURN:!1,USE_NEW_RENDER_FREEZE_TIME:!1},ae=tt(tt(tt(tt({},kf),{},{PROCESS_ID:"",ENCRYPT_AES:!0,AREAS:["CHINA","GLOBAL"],WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io","webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io","webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-web-2.ap.sd-rtn.com","cds-ap-web-3.agora.io","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-web-2.ap.sd-rtn.com","sua-ap-web-3.agora.io","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-ap-web-1.agora.io","uap-web-2.ap.sd-rtn.com","uap-ap-web-3.agora.io","uap-web-4.ap.sd-rtn.com"],LOG_UPLOAD_SERVER:"logservice.agora.io",EVENT_REPORT_DOMAIN:"statscollector-1.agora.io",EVENT_REPORT_BACKUP_DOMAIN:"web-2.statscollector.sd-rtn.com",GATEWAY_ADDRESS:[],GATEWAY_WSS_ADDRESS:"",LIVE_STREAMING_ADDRESS:"",HTTP_CONNECT_TIMEOUT:5e3,SIGNAL_REQUEST_TIMEOUT:1e4,REPORT_STATS:!0,NOT_REPORT_EVENT:[],PING_PONG_TIME_OUT:10,WEBSOCKET_TIMEOUT_MIN:1e4,EVENT_REPORT_SEND_INTERVAL:3e3,CONFIG_DISTRIBUTE_INTERVAL:3e5,ENABLE_CONFIG_DISTRIBUTE:!0,CANDIDATE_TIMEOUT:5e3,SHOW_REPORT_INVOKER_LOG:!1,SHOW_REPORT_USER_INVOKER_LOG:!0,JOIN_EXTEND:"",PUB_EXTEND:"",SUB_EXTEND:"",FORCE_TURN:!1,TURN_ENABLE_TCP:!0,TURN_ENABLE_UDP:!0,MAX_UPLOAD_CACHE:50,UPLOAD_CACHE_INTERVAL:2e3,AJAX_REQUEST_CONCURRENT:3,REPORT_APP_SCENARIO:void 0,GATEWAY_DOMAINS:["edge.agora.io","edge.sd-rtn.com"],CONNECT_GATEWAY_WITHOUT_DOMAIN:!1,WORKER_DOMAIN:"edge.agora.io",EVENT_REPORT_RETRY:!0,CHROME_FORCE_PLAN_B:!1,AUDIO_SOURCE_VOLUME_UPDATE_INTERVAL:400,AUDIO_SOURCE_AVG_VOLUME_DURATION:3e3,AUDIO_VOLUME_INDICATION_INTERVAL:2e3,VOLUME_VOICE_WEIGHT:10,GET_VOLUME_OF_MUTED_AUDIO_TRACK:!1,STATS_UPDATE_INTERVAL:250,NORMAL_EVENT_QUEUE_CAPACITY:100,CUSTOM_REPORT:!0,CUSTOM_REPORT_LIMIT:20,PROXY_SERVER_TYPE2:"webnginx-proxy.agora.io",PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com","webrtc-cloud-proxy.agora.io"],CUSTOM_PUB_ANSWER_MODIFIER:null,CUSTOM_SUB_ANSWER_MODIFIER:null,CUSTOM_PUB_OFFER_MODIFIER:null,CUSTOM_SUB_OFFER_MODIFIER:null,DSCP_TYPE:"high",REMOVE_NEW_CODECS:!0,FRAGEMENT_LENGTH:3,WEBSOCKET_COMPRESS:!1,SIMULCAST:!1,PRELOAD_MEDIA_COUNT:0,CHECK_VIDEO_VISIBLE_INTERVAL:3e4,CHECK_LOCAL_STATS_INTERVAL:250,PROFILE_SWITCH_INTERVAL:2e3,UNSUPPORTED_VIDEO_CODEC:[],ENUMERATE_DEVICES_INTERVAL:!1,ENUMERATE_DEVICES_INTERVAL_TIME:1e4,USE_NEW_TOKEN:!1,CLOSE_AFB_FOR_LOCAL_AP:!0,JOIN_MAX_CONCURRENCY:6,JOIN_WITH_FALLBACK_SIGNAL_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY:!0,JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE:!1,JOIN_GATEWAY_TRY_443PORT_DURATION:2e3,JOIN_GATEWAY_USE_443PORT_ONLY:!1,JOIN_GATEWAY_USE_DUAL_DOMAIN:!0,JOIN_GATEWAY_FALLBACK_PORT:443,USE_TURN_SERVER_OF_GATEWAY:!1,H264_PROFILE_LEVEL_ID:"",USE_NEW_LOG:!1,LOG_VERSION:3,MEDIA_DEVICE_CONSTRAINTS:null,ENCRYPT_PROXY_USERNAME_AND_PSW:!0,SDP_LOGGING:!1,CSP_DETECTED_HOSTNAME_LIST:["agora.io","sd-rtn.com"],REMOTE_AUDIO_TRACK_USES_WEB_AUDIO:!1,LOCAL_AUDIO_TRACK_USES_WEB_AUDIO:!1,BITRATE_ADAPTER_TYPE:"STANDARD_BITRATE",AI_DENOISER_PARAMETERS:{excludedLinks:[]},ADJUST_3A_FROM_PLUGINS:!0,RAISE_H264_BASELINE_PRIORITY:!0,FILTER_SEND_H264_BASELINE:!1,FIRST_H264_PROFILE_LEVEL_ID:"42001f",FIRST_PACKETIZATION_MODE:"",X_GOOGLE_START_BITRATE:void 0,NEW_REPORT_SERVER:!1,NEW_REPORT_SERVER_DOMAINS:["data-reporting.agora.io","data-reporting.agora.io"],VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT:3e5,VIDEO_INSPECT_INTERVAL_MINIMUM:1e3,VIDEO_INSPECT_QUALITY_RATIO:.9,VIDEO_INSPECT_WORKER_MANAGER_HOST:"edge.agora.io",VIDEO_INSPECT_WORKER_MANAGER_PORT:"",VIDEO_INSPECT_WORKER_PORT:"",SHOW_VIDEO_INSPECT_WORKER_MESSAGE:!1,STATS_COLLECTOR_PORT:443,FORCE_TURN_TCP:!1,WEBAUDIO_INIT_OPTIONS:void 0,FILTER_VIDEO_FEC:!0,FILTER_AUDIO_FEC:!1,CHROME_DUAL_STREAM_USE_ENCODING:!0,DISABLE_DUAL_STREAM_USE_ENCODING:!1,EXTENSION_USAGE_UPLOAD_INTERVAL:1e4,ICE_RESTART:!0,FINGERPRINT:null,ENABLE_VIDEO_FRAME_CALLBACK:!0,VIDEO_FREEZE_DURATION:500,SPATIALIZER_PARAMETERS:{},UPLOAD_LOG_INTERVAL:3e3,UPLOAD_LOG_REQUEST_RETRY_INTERVAL:2e3,UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL:2e4,UPLOAD_LOG_TRY_INTERVAL_WHILE_OFF:5e3,UPLOAD_LOG_RETRY_INTERVAL_V1:1e4,UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1:200,UPLOAD_LOG_LENGTH_EACH_TIME:10,APP_TYPE:0,DISABLE_WEBAUDIO:!1,CHANNEL_MEDIA_RELAY_SERVERS:void 0,KEEP_LAST_FRAME:!0,FORWARD_P2P_CREATION:!0,SYNC_GROUP:!0,BLOCK_LOCAL_CLIENT:!1,ENABLE_AUDIO_TOPN:!1,ENABLE_AUDIO_METADATA:!1,ENABLE_AUDIO_PTS_METADATA:!1,TOPN_SMOOTH_LEVEL:void 0,TOPN_NEW_SPEAKER_DELAY:void 0,TOPN_SWITCH_HOLD_MS:void 0,TOPN_AUDIO_GAIN:void 0,TOPN_SILENCE_THRESHOLD:250,AP_AREA:!0,ENABLE_ENCODED_TRANSFORM:!1,ENABLE_VIDEO_SEI:!1,IMAGE_MODERATION_WORKER_HOST:"edge.agora.io",IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT:3e5,IMAGE_MODERATION_INTERVAL_MINIMUM:1e3,SHOW_IMAGE_MODERATION_WORKER_MESSAGE:!1,IMAGE_MODERATION_QUALITY_RATIO:.9,IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL:5e3,SHOW_GLOBAL_CLIENT_LIST:!1,DATASTREAM_MAX_RETRANSMITS:10,TCP_CANDIDATE_ONLY:!1,EXTERNAL_SIGNAL_REQUEST_TIMEOUT:3e3,SHOW_P2P_LOG:!1,MAX_P2P_TIMEOUT:3e4,P2P_TOKEN_INTERVAL:1e3,SHOW_DATASTREAM2_LOG:!1,RESTRICTION_SET_PLAYBACK_DEVICE:!0,USE_PURE_ENCRYPTION_MASTER_KEY:!1,ENABLE_AUDIO_RED:!1,OPUS_PTIME:void 0,AUDIO_DUPLICATE_NUM:void 0,ACCOUNT_REGISTER_RETRY_TIMEOUT:1,ACCOUNT_REGISTER_RETRY_RATIO:2,ACCOUNT_REGISTER_RETRY_TIMEOUT_MAX:6e4,ACCOUNT_REGISTER_RETRY_COUNT_MAX:1e5,AUDIO_CONTEXT:null,WEBCS_BACKUP_CONNECT_TIMEOUT:6e3,PLAYER_STATE_DEFER:2e3,SIGNAL_REQUEST_WATCH_INTERVAL:1e3,FILEPATH_LENMAX:255,DUALSTREAM_OPERATION_CHECK:!0,MEDIA_ELEMENT_EXISTS_DEPTH:3,SHIM_CANDIDATE:!1,LEAVE_MSG_TIMEOUT:2e3,STATS_FILTER:{transportId:!0,googTrackId:!0},FILTER_VIDEO_CODEC:[],USE_NEW_NETWORK_CONFIG:!1,AUTO_RESET_AUDIO_ROUTE:!1,PLUGIN_INFO:[],OVERUSE_DETECTOR_PARAMS:Pf,CUSTOM_ADAPTATION_DEFAULT_MODE:"",HIDE_NO_POSTER:!1,AP_CACHE_NUM:10,AP_UPDATE_INTERVAL:12e4,AP_CACHE_LIFETIME:12e4,MAX_PRELOAD_ASYNC_LENGTH:3,DISABLE_SCREEN_SHARE_REMB:!1},Rh),{},{USE_CANDIDATE_FROM_AP_DETAIL:!1,AP_REQUEST_DETAIL:void 0,ENABLE_ROLE_SELECT_EDGE:!1,CLIENT_ROLE_OPTIONS:void 0,COMPATIBLE_SDP_EXTENSION:["gdpr_forbidden"],LIMIT_BITRATE:void 0,EXPERIMENTS:{},USE_PUB_RTX:!0,USE_SUB_RTX:!0,ENABLE_DATASTREAM_2:!1,USE_XR:!0,ENABLE_PREALLOC_PC:!1,ENABLE_PRE_SUB:!1,ENABLE_SVC:!1},{INSTALL_ID:""}),{},{K_MIN_RENDER_DELAY:66,USE_STANDARD_BITRATE_DEFAULT:!1,VIDEO_NEW_BITRATE_RATIO:void 0,VIDEO_STANDARD_BITRATE_VERSION:void 0,BASELINE_MORE_H264_BITRATE_RATIO:1.1});function qt(t,e,i){var n,r,o;z(n=Object.keys(ae)).call(n,t)&&(!i&&z(r=Object.keys(ir)).call(r,t)||(ae[t]=e,t!=="ENABLE_VIDEO_SEI"&&t!=="ENABLE_AUDIO_TOPN"&&t!=="ENABLE_AUDIO_METADATA"&&t!=="ENABLE_AUDIO_PTS_METADATA"||e!==!0||(ae.ENABLE_ENCODED_TRANSFORM=!0,t==="ENABLE_AUDIO_PTS_METADATA"&&(ae.ENABLE_AUDIO_METADATA=!0)),t==="USE_NEW_NETWORK_CONFIG"&&e&&(o=!!e,ae.USE_NEW_NETWORK_CONFIG=o,o&&(ae.WEBCS_DOMAIN=["webrtc2-2.ap.sd-rtn.com"],ae.WEBCS_DOMAIN_BACKUP_LIST=["webrtc2-4.ap.sd-rtn.com"],ae.CDS_AP=["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ae.ACCOUNT_REGISTER=["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],ae.EVENT_REPORT_DOMAIN="web-2.statscollector.sd-rtn.com",ae.EVENT_REPORT_BACKUP_DOMAIN="statscollector-1.agora.io",ae.GATEWAY_DOMAINS=["edge.sd-rtn.com"])),t==="ENABLE_PRE_SUB"&&e&&(ae.ENABLE_INSTANT_VIDEO=!0,ae.ENABLE_PREALLOC_PC=!0),t==="ENABLE_SVC"&&e&&(ae.ENABLE_AUT_CC=!0),t==="NEW_FORCE_TURN"&&e&&(ae.NEW_TURN_MODE||(ae.NEW_TURN_MODE=4))))}function A(t){return ae[t]}Df||(ae.WEBCS_DOMAIN=["ap-web-1-oversea.agora.io","ap-web-1-north-america.agora.io"],ae.WEBCS_DOMAIN_BACKUP_LIST=["ap-web-2-oversea.agora.io","ap-web-2-north-america.agora.io"],ae.PROXY_CS=["proxy-ap-web-oversea.agora.io","proxy-ap-web-america.agora.io"],ae.CDS_AP=["cds-ap-web-oversea.agora.io","cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ae.ACCOUNT_REGISTER=["sua-ap-web-oversea.agora.io","sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],ae.UAP_AP=["uap-ap-web-oversea.agora.io","uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],ae.LOG_UPLOAD_SERVER="logservice-oversea.agora.io",ae.EVENT_REPORT_DOMAIN="statscollector-1-oversea.agora.io",ae.EVENT_REPORT_BACKUP_DOMAIN="statscollector-2-oversea.agora.io",ae.PROXY_SERVER_TYPE3="webrtc-cloud-proxy.agora.io",ae.AREAS=["NORTH_AMERICA","OVERSEA"]);let iw=function(t){return t[t.REALTIME=1]="REALTIME",t}({}),ir={};var Ot=function(t){return t.SET_SESSION_ID="SET_SESSION_ID",t.SET_P2P_ID="SET_P2P_id",t.SET_DC_ID="SET_DC_id",t.SET_UID="SET_UID",t.SET_INT_UID="SET_INT_UID",t.SET_PUB_ID="SET_PUB_ID",t.SET_CLOUD_PROXY_SERVER_MODE="SET_CLOUD_PROXY_SERVER_MODE",t.KEY_METRIC_CLIENT_CREATED="KEY_METRIC_CLIENT_CREATED",t.KEY_METRIC_JOIN_START="KEY_METRIC_JOIN_START",t.KEY_METRIC_JOIN_END="KEY_METRIC_JOIN_END",t.KEY_METRIC_REQUEST_AP_START="KEY_METRIC_REQUEST_AP_START",t.KEY_METRIC_REQUEST_AP_END="KEY_METRIC_REQUEST_AP_END",t.KEY_METRIC_JOIN_GATEWAY_START="KEY_METRIC_JOIN_GATEWAY_START",t.KEY_METRIC_JOIN_GATEWAY_END="KEY_METRIC_JOIN_GATEWAY_END",t.KEY_METRIC_PEER_CONNECTION_START="KEY_METRIC_PEER_CONNECTION_START",t.KEY_METRIC_PEER_CONNECTION_END="KEY_METRIC_PEER_CONNECTION_END",t.KEY_METRIC_DESCRIPTION_START="KEY_METRIC_DESCRIPTION_START",t.KEY_METRIC_ICE_CONNECTION_END="KEY_METRIC_ICE_CONNECTION_END",t.KEY_METRIC_SIGNAL_CHANNEL_OPEN="KEY_METRIC_SIGNAL_CHANNEL_OPEN",t.KEY_METRIC_PUBLISH="KEY_METRIC_PUBLISH",t.KEY_METRIC_SUBSCRIBE="KEY_METRIC_SUBSCRIBE",t.RECORD_JOIN_CHANNEL_SERVICE="RECORD_JOIN_CHANNEL_SERVICE",t.RESET_JOIN_CHANNEL_SERVICE_RECORDS="RESET_JOIN_CHANNEL_SERVICE_RECORDS",t.RESET_KEY_METRICS="RESET_KEY_METRICS",t.SET_USE_P2P="SET_USE_P2P",t.SET_TRANSPORT_TYPE="SET_TRANSPORT_TYPE",t}(Ot||{});let vh=function(t){return t.h264="h264",t.h265="h265",t.vp8="vp8",t.vp9="vp9",t.av1="av1",t}({});(function(t){t.opus="opus",t.pcma="pcma",t.pcmu="pcmu",t.g722="g722"})({});let nw=128,mK=96,rw=1e3,xa=10,EK=0;var ow=(()=>{var t={8:(n,r,o)=>{o.r(r),o.d(r,{Parser:()=>Y,Printer:()=>ne,parse:()=>K,print:()=>it});let s=`
`,a="".concat("\r").concat(s),c=" ",d;function l(G){return G>="0"&&G<="9"}function u(G){return G>="!"&&G<="~"}function h(G){return u(G)||G>="\x80"&&G<="\xFF"}function p(G){return G==="!"||G>="#"&&G<="'"||G>="*"&&G<="+"||G>="-"&&G<="."||G>="0"&&G<="9"||G>="A"&&G<="Z"||G>="^"&&G<="~"}function g(G){return G>="1"&&G<="9"}function E(G){return G>="A"&&G<="Z"||G>="a"&&G<="z"}function f(G){return G==="d"||G==="h"||G==="m"||G==="s"}function R(G){return G>""&&G<"	"||G>"\v"&&G<"\f"||G>""&&G<"\xFF"}function y(G){return E(G)||l(G)||G==="+"||G==="/"}function N(G){return l(G)||E(G)||G==="+"||G==="/"||G==="-"||G==="_"}function k(G){return E(G)||l(G)||G==="+"||G==="/"}function L(G,m){var w=Object.keys(G);if(Object.getOwnPropertySymbols){var D=Object.getOwnPropertySymbols(G);m&&(D=D.filter(function(H){return Object.getOwnPropertyDescriptor(G,H).enumerable})),w.push.apply(w,D)}return w}function P(G){for(var m=1;m<arguments.length;m++){var w=arguments[m]!=null?arguments[m]:{};m%2?L(Object(w),!0).forEach(function(D){V(G,D,w[D])}):Object.getOwnPropertyDescriptors?Object.defineProperties(G,Object.getOwnPropertyDescriptors(w)):L(Object(w)).forEach(function(D){Object.defineProperty(G,D,Object.getOwnPropertyDescriptor(w,D))})}return G}function V(G,m,w){return m in G?Object.defineProperty(G,m,{value:w,enumerable:!0,configurable:!0,writable:!0}):G[m]=w,G}(function(G){G.VERSION="v",G.ORIGIN="o",G.SESSION_NAME="s",G.INFORMATION="i",G.URI="u",G.EMAIL="e",G.PHONE="p",G.CONNECTION="c",G.BANDWIDTH="b",G.TIME="t",G.REPEAT="r",G.ZONE_ADJUSTMENTS="z",G.KEY="k",G.ATTRIBUTE="a",G.MEDIA="m"})(d||(d={}));class B{consumeText(m,w){let D=w;for(;D<m.length;){let H=m[D];if(H==="\0"||H==="\r"||H===s)break;D+=1}if(D-w==0)throw new Error("Invalid text, at ".concat(m));return D}consumeUnicastAddress(m,w,D){return this.consumeTill(m,w,c)}consumeOneOrMore(m,w,D){let H=w;for(;D(m[H]);)H++;if(H-w==0)throw new Error("Invalid rule at ".concat(w,"."));return H}consumeSpace(m,w){if(m[w]===c)return w+1;throw new Error("Invalid space at ".concat(w,"."))}consumeIP4Address(m,w){let D=w;for(let H=0;H<4;H++)if(D=this.consumeDecimalUChar(m,D),H!==3){if(m[D]!==".")throw new Error("Invalid IP4 address.");D++}return D}consumeDecimalUChar(m,w){let D=w;for(let St=0;St<3&&l(m[D]);St++,D++);if(D-w==0)throw new Error("Invalid decimal uchar.");let H=parseInt(m.slice(w,D));if(H>=0&&H<=255)return D;throw new Error("Invalid decimal uchar")}consumeIP6Address(m,w){let D=this.consumeHexpart(m,w);return m[D]===":"&&(D+=1,D=this.consumeIP4Address(m,D)),D}consumeHexpart(m,w){let D=w;if(m[D]===":"&&m[D+1]===":"){D+=2;try{D=this.consumeHexseq(m,D)}catch{}return D}if(D=this.consumeHexseq(m,D),m[D]===":"&&m[D+1]===":"){D+=2;try{D=this.consumeHexseq(m,D)}catch{}return D}return D}consumeHexseq(m,w){let D=w;for(;D=this.consumeHex4(m,D),m[D]===":"&&m[D+1]!==":";)D+=1;return D}consumeHex4(m,w){let D=0;for(;D<4;D++)if(!((H=m[w+D])>="0"&&H<="9"||H>="a"&&H<="f"||H>="A"&&H<="F")){if(D===0)throw new Error("Invalid hex 4");break}var H;return w+D}consumeFQDN(m,w){let D=w;for(;l(m[D])||E(m[D])||m[D]==="-"||m[D]===".";)D+=1;if(D-w<4)throw new Error("Invalid FQDN");return D}consumeExtnAddr(m,w){return this.consumeOneOrMore(m,w,h)}consumeMulticastAddress(m,w,D){switch(D){case"IP4":case"ip4":return this.consumeIP4MulticastAddress(m,w);case"IP6":case"ip6":return this.consumeIP6MulticastAddress(m,w);default:try{return this.consumeFQDN(m,w)}catch{return this.consumeExtnAddr(m,w)}}}consumeIP6MulticastAddress(m,w){let D=this.consumeHexpart(m,w);return m[D]==="/"?this.consumeInteger(m,D+1):D}consumeIP4MulticastAddress(m,w){let D=w+3,H=m.slice(w,D),St=parseInt(H);if(St<224||St>239)throw new Error("Invalid IP4 multicast address, IPv4 multicast addresses may be in the range 224.0.0.0 to 239.255.255.255.");for(let ee=0;ee<3;ee++){if(m[D]!==".")throw new Error("Invalid IP4 multicast address.");D+=1,D=this.consumeDecimalUChar(m,D)}return m[D]==="/"&&(D+=1),D=this.consumeTTL(m,D),m[D]==="/"&&(D=this.consumeInteger(m,D)),D}consumeInteger(m,w){if(!g(m[w]))throw new Error("Invalid integer.");for(w+=1;l(m[w]);)w+=1;return w}consumeTTL(m,w){if(m[w]==="0")return w+1;if(!g(m[w]))throw new Error("Invalid TTL.");w+=1;for(let D=0;D<2&&l(m[w]);D++)w+=1;return w}consumeToken(m,w){return this.consumeOneOrMore(m,w,p)}consumeTime(m,w){let D=w;if(m[D]==="0")return D+1;for(g(m[D])&&(D+=1);l(m[D]);)D++;if(D-w<10)throw new Error("Invalid time");return D}consumeAddress(m,w){return this.consumeTill(m,w,c)}consumeTypedTime(m,w){let D=w;return D=this.consumeOneOrMore(m,D,l),f(m[D])?D+1:D}consumeRepeatInterval(m,w){if(!g(m[w]))throw new Error("Invalid repeat interval");for(w+=1;l(m[w]);)w+=1;return f(m[w])&&(w+=1),w}consumePort(m,w){return this.consumeOneOrMore(m,w,l)}consume(m,w,D){for(let H=0;H<D.length;H++){if(w+H>=m.length)throw new Error("consume exceeding value length");if(m[w+H]!==D[H])throw new Error("consume ".concat(D," failed at ").concat(H))}return w+D.length}consumeTill(m,w,D){let H=w;for(;H<m.length&&(typeof D!="string"||m[H]!==D)&&(typeof D!="function"||!D(m[H]));)H++;return H}}class Y extends B{constructor(){super(),V(this,"records",[]),V(this,"currentLine",0)}parse(m){let w=this.probeEOL(m);this.records=m.split(w).filter(co=>!!ui(co).call(co)).map(this.parseLine),this.currentLine=0;let D=this.parseVersion(),H=this.parseOrigin(),St=this.parseSessionName(),ee=this.parseInformation(),Me=this.parseUri(),Sn=this.parseEmail(),qn=this.parsePhone(),cl=this.parseConnection(),Gs=this.parseBandWidth(),gc=this.parseTimeFields(),Op=this.parseKey(),Np=this.parseSessionAttribute(),Tn=this.parseMediaDescription();if(this.currentLine!==this.records.length)throw new Error("parsing failed, non exhaustive sdp lines.");return{version:D,origin:H,sessionName:St,information:ee,uri:Me,emails:Sn,phones:qn,connection:cl,bandwidths:Gs,timeFields:gc,key:Op,attributes:Np,mediaDescriptions:Tn}}getCurrentRecord(){let m=this.records[this.currentLine];if(!m)throw new Error("Record doesn't exit.");return m}probeEOL(m){for(let w=0;w<m.length;w++)if(m[w]===s)return m[w-1]==="\r"?a:s;throw new Error("Invalid newline character.")}parseLine(m,w){if(m.length<2)throw new Error("Invalid sdp line, sdp line should be of form <type>=<value>.");let D=m[0];if(m[1]!=="=")throw new Error('Invalid sdp line, <type> should be a single character followed by an "=" sign.');return{type:D,value:m.slice(2),line:w,cur:0}}parseSessionAttribute(){let m=new yt;for(;this.currentLine<this.records.length;){let w=this.getCurrentRecord();if(w.type!==d.ATTRIBUTE)break;let D={attField:this.extractOneOrMore(w,H=>p(H)&&H!==":"),_cur:0};w.value[w.cur]===":"&&(w.cur+=1,D.attValue=this.extractOneOrMore(w,R)),m.parse(D),this.currentLine++}return m.digest()}parseMediaAttributes(m){let w=new Rt(m);for(;this.currentLine<this.records.length;){let D=this.getCurrentRecord();if(D.type!==d.ATTRIBUTE)break;let H={attField:this.extractOneOrMore(D,St=>p(St)&&St!==":"),_cur:0};D.value[D.cur]===":"&&(D.cur+=1,H.attValue=this.extractOneOrMore(D,R)),w.parse(H),this.currentLine++}return w.digest()}parseKey(){let m=this.getCurrentRecord();if(m.type===d.KEY){if(m.value==="prompt"||m.value==="clear:"||m.value==="base64:"||m.value==="uri:")return m.value;throw this.currentLine++,new Error("Invalid key.")}}parseZone(){let m=this.getCurrentRecord();if(m.type===d.ZONE_ADJUSTMENTS){let w=[];for(;;)try{let D=this.extract(m,this.consumeTime);this.consumeSpaceForRecord(m);let H=!1;m.value[m.cur]==="-"&&(H=!0,m.cur+=1);let St=this.extract(m,this.consumeTypedTime);w.push({time:D,typedTime:St,back:H})}catch{break}if(w.length===0)throw new Error("Invalid zone adjustments");return this.currentLine++,w}return[]}parseRepeat(){let m=[];for(;;){let w=this.getCurrentRecord();if(w.type!==d.REPEAT)break;{let D=this.extract(w,this.consumeRepeatInterval),H=this.parseTypedTime(w);m.push({repeatInterval:D,typedTimes:H}),this.currentLine++}}return m}parseTypedTime(m){let w=[];for(;;)try{this.consumeSpaceForRecord(m),w.push(this.extract(m,this.consumeTypedTime))}catch{break}if(w.length===0)throw new Error("Invalid typed time.");return w}parseTime(){let m=this.getCurrentRecord(),w=this.extract(m,this.consumeTime);this.consumeSpaceForRecord(m);let D=this.extract(m,this.consumeTime);return this.currentLine++,{startTime:w,stopTime:D}}parseBandWidth(){let m=[];for(;this.currentLine<this.records.length;){let w=this.getCurrentRecord();if(w.type!==d.BANDWIDTH)break;{let D=this.extractOneOrMore(w,p);if(w.value[w.cur]!==":")throw new Error("Invalid bandwidth field.");w.cur++;let H=this.extractOneOrMore(w,l);m.push({bwtype:D,bandwidth:H}),this.currentLine++}}return m}parseVersion(){let m=this.getCurrentRecord();if(m.type!==d.VERSION)throw new Error("first sdp record must be version");let w=m.value.slice(0,this.consumeOneOrMore(m.value,0,l));if(w.length!==m.value.length)throw new Error('invalid proto version, "v='.concat(m.value,'"'));return this.currentLine++,w}parseOrigin(){let m=this.getCurrentRecord();if(m.type!==d.ORIGIN)throw new Error("second line of sdp must be origin");let w=this.extractOneOrMore(m,h);this.consumeSpaceForRecord(m);let D=this.extractOneOrMore(m,l);this.consumeSpaceForRecord(m);let H=this.extractOneOrMore(m,l);this.consumeSpaceForRecord(m);let St=this.extractOneOrMore(m,p);this.consumeSpaceForRecord(m);let ee=this.extractOneOrMore(m,p);this.consumeSpaceForRecord(m);let Me=this.extract(m,this.consumeUnicastAddress);return this.currentLine++,{username:w,sessId:D,sessVersion:H,nettype:St,addrtype:ee,unicastAddress:Me}}parseSessionName(){let m=this.getCurrentRecord();if(m.type===d.SESSION_NAME){let w=this.extract(m,this.consumeText);return this.currentLine++,w}}parseInformation(){let m=this.getCurrentRecord();if(m.type!==d.INFORMATION)return;let w=this.extract(m,this.consumeText);return this.currentLine++,w}parseUri(){let m=this.getCurrentRecord();if(m.type===d.URI)return this.currentLine++,m.value}parseEmail(){let m=[];for(;;){let w=this.getCurrentRecord();if(w.type!==d.EMAIL)break;m.push(w.value),this.currentLine++}return m}parsePhone(){let m=[];for(;;){let w=this.getCurrentRecord();if(w.type!==d.PHONE)break;m.push(w.value),this.currentLine++}return m}parseConnection(){let m=this.getCurrentRecord();if(m.type===d.CONNECTION){let w=this.extractOneOrMore(m,p);this.consumeSpaceForRecord(m);let D=this.extractOneOrMore(m,p);this.consumeSpaceForRecord(m);let H=this.extract(m,this.consumeAddress);return this.currentLine++,{nettype:w,addrtype:D,address:H}}}parseMedia(){let m=this.getCurrentRecord(),w=this.extract(m,this.consumeToken);this.consumeSpaceForRecord(m);let D=this.extract(m,this.consumePort);m.value[m.cur]==="/"&&(m.cur+=1,D+=this.extract(m,this.consumeInteger)),this.consumeSpaceForRecord(m);let H=[];for(H.push(this.extract(m,this.consumeToken));m.value[m.cur]==="/";)m.cur+=1,H.push(this.extract(m,this.consumeToken));if(H.length===0)throw new Error("Invalid proto");let St=this.parseFmt(m);return this.currentLine++,{mediaType:w,port:D,protos:H,fmts:St}}parseTimeFields(){let m=[];for(;this.getCurrentRecord().type===d.TIME;){let w=this.parseTime(),D=this.parseRepeat(),H=this.parseZone();m.push({time:w,repeats:D,zones:H})}return m}parseMediaDescription(){let m=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.MEDIA;){let w=this.parseMedia(),D=this.parseInformation(),H=this.parseConnections(),St=this.parseBandWidth(),ee=this.parseKey(),Me=this.parseMediaAttributes(w);m.push({media:w,information:D,connections:H,bandwidths:St,key:ee,attributes:Me})}return m}parseConnections(){let m=[];for(;this.currentLine<this.records.length&&this.getCurrentRecord().type===d.CONNECTION;)m.push(this.parseConnection());return m}parseFmt(m){let w=[];for(;;)try{this.consumeSpaceForRecord(m),w.push(this.extract(m,this.consumeToken))}catch{break}if(w.length===0)throw new Error("Invalid fmts");return w}extract(m,w){for(var D=arguments.length,H=new Array(D>2?D-2:0),St=2;St<D;St++)H[St-2]=arguments[St];let ee=w.call(this,m.value,m.cur,...H),Me=m.value.slice(m.cur,ee);return m.cur=ee,Me}extractOneOrMore(m,w){let D=this.consumeOneOrMore(m.value,m.cur,w),H=m.value.slice(m.cur,D);return m.cur=D,H}consumeSpaceForRecord(m){if(m.value[m.cur]!==c)throw new Error("Invalid space at ".concat(m.cur,"."));m.cur+=1}}class J extends B{constructor(){super(...arguments),V(this,"attributes",void 0),V(this,"digested",!1)}extractOneOrMore(m,w,D){let H=this.consumeOneOrMore(m.attValue,m._cur,w),St=m.attValue.slice(m._cur,H),[ee,Me]=D||[];if(typeof ee=="number"&&St.length<ee)throw new Error("error in length, should be more or equal than ".concat(ee," characters."));if(typeof Me=="number"&&St.length>Me)throw new Error("error in length, should be less or equal than ".concat(Me," characters."));return m._cur=H,St}consumeAttributeSpace(m){if(m.attValue[m._cur]!==c)throw new Error("Invalid space at ".concat(m._cur,"."));m._cur+=1}extract(m,w){if(!m.attValue)throw new Error("Nothing to extract from attValue.");for(var D=arguments.length,H=new Array(D>2?D-2:0),St=2;St<D;St++)H[St-2]=arguments[St];let ee=w.call(this,m.attValue,m._cur,...H),Me=m.attValue.slice(m._cur,ee);return m._cur=ee,Me}atEnd(m){if(!m.attValue)throw new Error;return m._cur>=m.attValue.length}peekChar(m){if(!m.attValue)throw new Error;return m.attValue[m._cur]}peek(m,w){if(!m.attValue)throw new Error;for(let D=0;D<w.length;D++)if(w[D]!==m.attValue[m._cur+D])return!1;return!0}parseIceUfrag(m){if(this.attributes.iceUfrag)throw new Error("Invalid ice-ufrag, should be only a single line if 'a=ice-ufrag'");this.attributes.iceUfrag=this.extractOneOrMore(m,y,[4,256])}parseIcePwd(m){if(this.attributes.icePwd)throw new Error("Invalid ice-pwd, should be only a single line if 'a=ice-pwd'");this.attributes.icePwd=this.extractOneOrMore(m,y,[22,256])}parseIceOptions(m){if(this.attributes.iceOptions)throw new Error("Invalid ice-options, should be only one 'ice-options' line");let w=[];for(;!this.atEnd(m);){w.push(this.extractOneOrMore(m,y));try{this.consumeAttributeSpace(m)}catch(D){if(this.atEnd(m))break;throw D}}this.attributes.iceOptions=w}parseFingerprint(m){let w=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m);let D=this.extract(m,this.consumeTill);this.attributes.fingerprints.push({hashFunction:w,fingerprint:D})}parseExtmap(m){let w=this.extractOneOrMore(m,l),D;this.peekChar(m)==="/"&&(this.extract(m,this.consume,"/"),D=this.extract(m,this.consumeToken)),this.consumeAttributeSpace(m);let H=this.extract(m,this.consumeTill,c),St=P(P({entry:parseInt(w,10)},D&&{direction:D}),{},{extensionName:H});this.peekChar(m)===c&&(this.consumeAttributeSpace(m),St.extensionAttributes=this.extract(m,this.consumeTill)),this.attributes.extmaps.push(St)}parseSetup(m){if(this.attributes.setup)throw new Error("must only be one single 'a=setup' line.");let w=this.extract(m,this.consumeTill);if(w!=="active"&&w!=="passive"&&w!=="actpass"&&w!=="holdconn")throw new Error("role must be one of 'active', 'passive', 'actpass', 'holdconn'.");this.attributes.setup=w}}class yt extends J{constructor(){super(...arguments),V(this,"attributes",{unrecognized:[],groups:[],extmaps:[],fingerprints:[],identities:[]})}parse(m){if(this.digested)throw new Error("already digested");try{switch(m.attField){case"group":this.parseGroup(m);break;case"ice-lite":this.parseIceLite();break;case"ice-ufrag":this.parseIceUfrag(m);break;case"ice-pwd":this.parseIcePwd(m);break;case"ice-options":this.parseIceOptions(m);break;case"fingerprint":this.parseFingerprint(m);break;case"setup":this.parseSetup(m);break;case"tls-id":this.parseTlsId(m);break;case"identity":this.parseIdentity(m);break;case"extmap":this.parseExtmap(m);break;case"msid-semantic":this.parseMsidSemantic(m);break;default:m.ignored=!0,this.attributes.unrecognized.push(m)}}catch(w){throw console.error("parsing session attribute ".concat(m.attField,' error, "a=').concat(m.attField,":").concat(m.attValue,'"')),w}if(!m.ignored&&m.attValue&&!this.atEnd(m))throw new Error("attribute parsing error")}digest(){return this.digested=!0,this.attributes}parseGroup(m){let w=this.extract(m,this.consumeToken),D=[];for(;!this.atEnd(m)&&this.peekChar(m)===c;)this.consumeAttributeSpace(m),D.push(this.extract(m,this.consumeToken));this.attributes.groups.push({semantic:w,identificationTag:D})}parseIceLite(){if(this.attributes.iceLite)throw new Error("Invalid ice-lite, should be only a single line of 'a=ice-lite'");this.attributes.iceLite=!0}parseTlsId(m){if(this.attributes.tlsId)throw new Error("must be only one tld-id line");this.attributes.tlsId=this.extractOneOrMore(m,N)}parseIdentity(m){let w=this.extractOneOrMore(m,k),D=[];for(;!this.atEnd(m)&&this.peekChar(m)===c;){this.consumeAttributeSpace(m);let H=this.extract(m,this.consumeToken);this.extract(m,this.consume,"=");let St=this.extractOneOrMore(m,ee=>ee!==c&&R(ee));D.push({name:H,value:St})}this.attributes.identities.push({assertionValue:w,extensions:D})}parseMsidSemantic(m){this.peekChar(m)===c&&this.consumeAttributeSpace(m);let w={semantic:this.extract(m,this.consumeToken),identifierList:[]};for(;;){try{this.consumeAttributeSpace(m)}catch{break}if(this.peekChar(m)==="*"){this.extract(m,this.consume,"*"),w.applyForAll=!0;break}{let D=this.extract(m,this.consumeTill,c);w.identifierList.push(D)}}this.attributes.msidSemantic=w}}class Rt extends J{constructor(m){super(),V(this,"attributes",void 0),m.protos.indexOf("RTP")!==-1||m.protos.indexOf("rtp"),this.attributes={unrecognized:[],candidates:[],extmaps:[],fingerprints:[],imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[]}}parse(m){if(this.digested)throw new Error("already digested");try{switch(m.attField){case"extmap":this.parseExtmap(m);break;case"setup":this.parseSetup(m);break;case"ice-ufrag":this.parseIceUfrag(m);break;case"ice-pwd":this.parseIcePwd(m);break;case"ice-options":this.parseIceOptions(m);break;case"candidate":this.parseCandidate(m);break;case"remote-candidate":this.parseRemoteCandidate(m);break;case"end-of-candidates":this.parseEndOfCandidates();break;case"fingerprint":this.parseFingerprint(m);break;case"rtpmap":this.parseRtpmap(m);break;case"ptime":this.parsePtime(m);break;case"maxptime":this.parseMaxPtime(m);break;case"sendrecv":case"recvonly":case"sendonly":case"inactive":this.parseDirection(m);break;case"ssrc":this.parseSSRC(m);break;case"fmtp":this.parseFmtp(m);break;case"rtcp-fb":this.parseRtcpFb(m);break;case"rtcp-mux":this.parseRTCPMux();break;case"rtcp-mux-only":this.parseRTCPMuxOnly();break;case"rtcp-rsize":this.parseRTCPRsize();break;case"rtcp":this.parseRTCP(m);break;case"mid":this.parseMid(m);break;case"msid":this.parseMsid(m);break;case"imageattr":this.parseImageAttr(m);break;case"rid":this.parseRid(m);break;case"simulcast":this.parseSimulcast(m);break;case"sctp-port":this.parseSctpPort(m);break;case"max-message-size":this.parseMaxMessageSize(m);break;case"ssrc-group":this.parseSSRCGroup(m);break;default:m.ignored=!0,this.attributes.unrecognized.push(m)}}catch(w){throw console.error("parsing media attribute ".concat(m.attField,' error, "a=').concat(m.attField,":").concat(m.attValue,'"')),w}if(!m.ignored&&m.attValue&&!this.atEnd(m))throw new Error("attribute parsing error")}parseCandidate(m){let w=this.extractOneOrMore(m,y,[1,32]);this.consumeAttributeSpace(m);let D=this.extractOneOrMore(m,l,[1,5]);this.consumeAttributeSpace(m);let H=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m);let St=this.extractOneOrMore(m,l,[1,10]);this.consumeAttributeSpace(m);let ee=this.extract(m,this.consumeAddress);this.consumeAttributeSpace(m);let Me=this.extract(m,this.consumePort);this.consumeAttributeSpace(m),this.extract(m,this.consume,"typ"),this.consumeAttributeSpace(m);let Sn={foundation:w,componentId:D,transport:H,priority:St,connectionAddress:ee,port:Me,type:this.extract(m,this.consumeToken),extension:{}};for(this.peek(m," raddr")&&(this.extract(m,this.consume," raddr"),this.consumeAttributeSpace(m),Sn.relAddr=this.extract(m,this.consumeAddress)),this.peek(m," rport")&&(this.extract(m,this.consume," rport"),this.consumeAttributeSpace(m),Sn.relPort=this.extract(m,this.consumePort));this.peekChar(m)===c;){this.consumeAttributeSpace(m);let qn=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m),Sn.extension[qn]=this.extractOneOrMore(m,u)}this.attributes.candidates.push(Sn)}parseRemoteCandidate(m){let w=[];for(;;){let D=this.extractOneOrMore(m,l,[1,5]);this.consumeAttributeSpace(m);let H=this.extract(m,this.consumeAddress);this.consumeAttributeSpace(m);let St=this.extract(m,this.consumePort);w.push({componentId:D,connectionAddress:H,port:St});try{this.consumeAttributeSpace(m)}catch{break}}this.attributes.remoteCandidatesList.push(w)}parseEndOfCandidates(){if(this.attributes.endOfCandidates)throw new Error("must be only one line of end-of-candidates");this.attributes.endOfCandidates=!0}parseRtpmap(m){let w=this.extract(m,this.consumeToken);this.consumeAttributeSpace(m);let D=this.extract(m,this.consumeTill,"/");this.extract(m,this.consume,"/");let H={encodingName:D,clockRate:this.extractOneOrMore(m,l)};this.atEnd(m)||this.peekChar(m)!=="/"||(this.extract(m,this.consume,"/"),H.encodingParameters=parseInt(this.extract(m,this.consumeTill),10));let St=this.attributes.payloads.find(ee=>ee.payloadType===parseInt(w,10));St?St.rtpMap=H:this.attributes.payloads.push({payloadType:parseInt(w,10),rtpMap:H,rtcpFeedbacks:[]})}parsePtime(m){if(this.attributes.ptime)throw new Error("must be only one line of ptime");this.attributes.ptime=this.extract(m,this.consumeTill)}parseMaxPtime(m){if(this.attributes.maxPtime)throw new Error("must be only one line of ptime");this.attributes.maxPtime=this.extract(m,this.consumeTill)}parseDirection(m){if(this.attributes.direction)throw new Error("must be only one line of direction info");this.attributes.direction=m.attField}parseSSRC(m){let w=this.extractOneOrMore(m,l);this.consumeAttributeSpace(m);let D=this.extract(m,this.consumeTill,":"),H;this.peekChar(m)===":"&&(this.extract(m,this.consume,":"),H=this.extract(m,this.consumeTill));let St=this.attributes.ssrcs.find(ee=>ee.ssrcId===parseInt(w,10));St?St.attributes[D]=H:this.attributes.ssrcs.push({ssrcId:parseInt(w,10),attributes:{[D]:H}})}parseFmtp(m){let w=this.extract(m,this.consumeTill,c);this.consumeAttributeSpace(m);let D=this.extract(m,this.consumeTill),H={};D.split(";").forEach(ee=>{let[Me,Sn]=ee.split("=");Me=ui(Me).call(Me);let qn=typeof Sn=="string"?ui(Sn).call(Sn):null;typeof Me=="string"&&Me.length>0&&(H[Me]=qn)});let St=this.attributes.payloads.find(ee=>ee.payloadType===parseInt(w,10));St?St.fmtp={parameters:H}:this.attributes.payloads.push({payloadType:parseInt(w,10),rtcpFeedbacks:[],fmtp:{parameters:H}})}parseFmtParameters(m){let w={},D=this.extract(m,this.consumeTill,"=");m._cur++;let H=this.extract(m,this.consumeTill,";");for(w[D]=H;m.attValue[m._cur]===";";){let St=this.extract(m,this.consumeTill,"=");m._cur++;let ee=this.extract(m,this.consumeTill,";");w[St]=ee}return w}parseRtcpFb(m){let w="";w=this.peekChar(m)==="*"?this.extract(m,this.consume,"*"):this.extract(m,this.consumeTill,c),this.consumeAttributeSpace(m);let D=this.extract(m,this.consumeTill,c),H;if(D==="trr-int")H={type:D,interval:this.extract(m,this.consumeTill)};else{let St={type:D};this.peekChar(m)===c&&(this.consumeAttributeSpace(m),St.parameter=this.extract(m,this.consumeToken),this.peekChar(m)===c&&(St.additional=this.extract(m,this.consumeTill))),H=St}if(w==="*")this.attributes.rtcpFeedbackWildcards.push(H);else{let St=this.attributes.payloads.find(ee=>ee.payloadType===parseInt(w,10));St?St.rtcpFeedbacks.push(H):this.attributes.payloads.push({payloadType:parseInt(w,10),rtcpFeedbacks:[H]})}}parseRTCPMux(){if(this.attributes.rtcpMux)throw new Error("must be single line of rtcp-mux");this.attributes.rtcpMux=!0}parseRTCPMuxOnly(){if(this.attributes.rtcpMuxOnly)throw new Error("must be single line of rtcp-only");this.attributes.rtcpMuxOnly=!0}parseRTCPRsize(){if(this.attributes.rtcpRsize)throw new Error("must be single line of rtcp-rsize");this.attributes.rtcpRsize=!0}parseRTCP(m){if(this.attributes.rtcp)throw new Error("must be single line of rtcp");let w={port:this.extract(m,this.consumePort)};this.peekChar(m)===c&&(this.consumeAttributeSpace(m),w.netType=this.extractOneOrMore(m,p),this.consumeAttributeSpace(m),w.addressType=this.extractOneOrMore(m,p),this.consumeAttributeSpace(m),w.address=this.extract(m,this.consumeAddress)),this.attributes.rtcp=w}parseMsid(m){let w={id:this.extractOneOrMore(m,p,[1,64])};this.peekChar(m)===c&&(this.consumeAttributeSpace(m),w.appdata=this.extractOneOrMore(m,p,[1,64])),this.attributes.msids.push(w)}parseImageAttr(m){this.attributes.imageattr.push(m.attValue)}parseRid(m){let w=this.extractOneOrMore(m,H=>E(H)||l(H)||H==="_"||H==="-");this.consumeAttributeSpace(m);let D={id:w,direction:this.extract(m,this.consumeToken),params:[]};if(this.peekChar(m)===c){if(this.consumeAttributeSpace(m),this.peek(m,"pt=")){this.extract(m,this.consume,"pt=");let H=[];for(;;){let St=this.extract(m,this.consumeToken);H.push(St);try{this.extract(m,this.consume,",")}catch{break}}D.payloads=H,this.peekChar(m)===c&&this.extract(m,this.consume,c)}for(;;){let H=this.extract(m,this.consumeToken);switch(H){case"depend":{let St={type:H,rids:this.extract(m,this.consume,"=").split(",")};D.params.push(St);break}default:{let St={type:H};this.peekChar(m)==="="&&(this.extract(m,this.consume,"="),St.val=this.extract(m,this.consumeTill,";")),D.params.push(St)}}try{this.extract(m,this.consume,";")}catch{break}}}this.attributes.rids.push(D)}parseSimulcast(m){if(this.attributes.simulcast)throw new Error("must be single line of simulcast");this.attributes.simulcast=m.attValue,this.extract(m,this.consumeTill)}parseSctpPort(m){this.attributes.sctpPort=this.extractOneOrMore(m,l,[1,5])}parseMaxMessageSize(m){this.attributes.maxMessageSize=this.extractOneOrMore(m,l,[1,void 0])}digest(){return this.digested=!0,this.attributes}parseMid(m){this.attributes.mid=this.extract(m,this.consumeToken)}parseSSRCGroup(m){let w=this.extract(m,this.consumeToken),D=[];for(;;)try{this.consumeAttributeSpace(m);let H=this.extract(m,this.consumeInteger);D.push(parseInt(H,10))}catch{break}this.attributes.ssrcGroups.push({semantic:w,ssrcIds:D})}}function _t(G,m,w){return m in G?Object.defineProperty(G,m,{value:w,enumerable:!0,configurable:!0,writable:!0}):G[m]=w,G}class ne{constructor(){_t(this,"eol",a)}print(m,w){let D="";return w&&(this.eol=w),D+=this.printVersion(m.version),D+=this.printOrigin(m.origin),D+=this.printSessionName(m.sessionName),D+=this.printInformation(m.information),D+=this.printUri(m.uri),D+=this.printEmail(m.emails),D+=this.printPhone(m.phones),D+=this.printConnection(m.connection),D+=this.printBandwidth(m.bandwidths),D+=this.printTimeFields(m.timeFields),D+=this.printKey(m.key),D+=this.printSessionAttributes(m.attributes),D+=this.printMediaDescription(m.mediaDescriptions),D}printVersion(m){return"v=".concat(m).concat(this.eol)}printOrigin(m){return"o=".concat(m.username," ").concat(m.sessId," ").concat(m.sessVersion," ").concat(m.nettype," ").concat(m.addrtype," ").concat(m.unicastAddress).concat(this.eol)}printSessionName(m){return m?"s=".concat(m).concat(this.eol):""}printInformation(m){return m?"i=".concat(m).concat(this.eol):""}printUri(m){return m?"u=".concat(m).concat(this.eol):""}printEmail(m){let w="";for(let D of m)w+="e=".concat(D).concat(this.eol);return w}printPhone(m){let w="";for(let D of m)w+="e=".concat(D).concat(this.eol);return w}printConnection(m){return m?"c=".concat(m.nettype," ").concat(m.addrtype," ").concat(m.address).concat(this.eol):""}printBandwidth(m){let w="";for(let D of m)w+="b=".concat(D.bwtype,":").concat(D.bandwidth).concat(this.eol);return w}printTimeFields(m){let w="";for(let D of m){w+="t=".concat(D.time.startTime," ").concat(D.time.startTime).concat(this.eol);for(let H of D.repeats)w+="r=".concat(H.repeatInterval," ").concat(H.typedTimes.join(" ")).concat(this.eol);D.zoneAdjustments&&(w+="z=",w+="z=".concat(D.zoneAdjustments.map(H=>"".concat(H.time," ").concat(H.back?"-":""," ").concat(H.typedTime)).join(" ")).concat(this.eol),w+=this.eol)}return w}printKey(m){return m?"k=".concat(m).concat(this.eol):""}printAttributes(m){let w="";for(let D of m)w+="a=".concat(D.attField).concat(D.attValue?":".concat(D.attValue):"").concat(this.eol);return w}printMediaDescription(m){let w="";for(let D of m)w+=this.printMedia(D.media),w+=this.printInformation(D.information),w+=this.printConnections(D.connections),w+=this.printBandwidth(D.bandwidths),w+=this.printKey(D.key),w+=this.printMediaAttributes(D);return w}printConnections(m){let w="";for(let D of m)w+=this.printConnection(D);return w}printMedia(m){return"m=".concat(m.mediaType," ").concat(m.port," ").concat(m.protos.join("/")," ").concat(m.fmts.join(" ")).concat(this.eol)}printSessionAttributes(m){return new Ni(this.eol).print(m)}printMediaAttributes(m){return new j(this.eol).print(m)}}class Qt{constructor(m){_t(this,"eol",void 0),this.eol=m}printIceUfrag(m){return m===void 0?"":"a=ice-ufrag:".concat(m).concat(this.eol)}printIcePwd(m){return m===void 0?"":"a=ice-pwd:".concat(m).concat(this.eol)}printIceOptions(m){return m===void 0?"":"a=ice-options:".concat(m.join(c)).concat(this.eol)}printFingerprints(m){return m.length>0?m.map(w=>"a=fingerprint:".concat(w.hashFunction).concat(c).concat(w.fingerprint)).join(this.eol)+this.eol:""}printExtmap(m){return m.map(w=>"a=extmap:".concat(w.entry).concat(w.direction?"/".concat(w.direction):"").concat(c).concat(w.extensionName).concat(w.extensionAttributes?"".concat(c).concat(w.extensionAttributes):"").concat(this.eol)).join("")}printSetup(m){return m===void 0?"":"a=setup:".concat(m).concat(this.eol)}printUnrecognized(m){return m.map(w=>"a=".concat(w.attField).concat(w.attValue?":".concat(w.attValue):"").concat(this.eol)).join("")}}class Ni extends Qt{print(m){let w="";return w+=this.printGroups(m.groups),w+=this.printMsidSemantic(m.msidSemantic),w+=this.printIceLite(m.iceLite),w+=this.printIceUfrag(m.iceUfrag),w+=this.printIcePwd(m.icePwd),w+=this.printIceOptions(m.iceOptions),w+=this.printFingerprints(m.fingerprints),w+=this.printSetup(m.setup),w+=this.printTlsId(m.tlsId),w+=this.printIdentity(m.identities),w+=this.printExtmap(m.extmaps),w+=this.printUnrecognized(m.unrecognized),w}printGroups(m){let w="";return m.length>0&&(w+=m.map(D=>"a=group:".concat(D.semantic).concat(D.identificationTag.map(H=>"".concat(c).concat(H)).join("")).concat(this.eol)).join("")),w}printIceLite(m){return m===void 0?"":"a=ice-lite"+this.eol}printTlsId(m){return m?"a=tls-id:".concat(m).concat(this.eol):""}printIdentity(m){return m.length===0?"":m.map(w=>"a=identity:".concat(w.assertionValue).concat(w.extensions.map(D=>"".concat(c).concat(D.name).concat(D.value?"=".concat(D.value):"")))).join(this.eol)+this.eol}printMsidSemantic(m){if(!m)return"";let w="a=msid-semantic:".concat(m.semantic);return m.applyForAll?w+="".concat(c,"*"):m.identifierList.length>0&&(w+=m.identifierList.map(D=>"".concat(c).concat(D))),w+this.eol}}class j extends Qt{print(m){let w=m.attributes,D="";return D+=this.printRTCP(w.rtcp),D+=this.printIceUfrag(w.iceUfrag),D+=this.printIcePwd(w.icePwd),D+=this.printIceOptions(w.iceOptions),D+=this.printCandidates(w.candidates),D+=this.printRemoteCandidatesList(w.remoteCandidatesList),D+=this.printEndOfCandidates(w.endOfCandidates),D+=this.printFingerprints(w.fingerprints),D+=this.printSetup(w.setup),D+=this.printMid(w.mid),D+=this.printExtmap(w.extmaps),D+=this.printRTPRelated(w),D+=this.printPtime(w.ptime),D+=this.printMaxPtime(w.maxPtime),D+=this.printDirection(w.direction),D+=this.printSSRCGroups(w.ssrcGroups),D+=this.printSSRC(w.ssrcs),D+=this.printRTCPMux(w.rtcpMux),D+=this.printRTCPMuxOnly(w.rtcpMuxOnly),D+=this.printRTCPRsize(w.rtcpRsize),D+=this.printMSId(w.msids),D+=this.printImageattr(w.imageattr),D+=this.printRid(w.rids),D+=this.printSimulcast(w.simulcast),D+=this.printSCTPPort(w.sctpPort),D+=this.printMaxMessageSize(w.maxMessageSize),D+=this.printUnrecognized(w.unrecognized),D}printCandidates(m){return m.map(w=>"a=candidate:".concat(w.foundation).concat(c).concat(w.componentId).concat(c).concat(w.transport).concat(c).concat(w.priority).concat(c).concat(w.connectionAddress).concat(c).concat(w.port).concat(c,"typ").concat(c).concat(w.type).concat(w.relAddr?"".concat(c,"raddr").concat(c).concat(w.relAddr):"").concat(w.relPort?"".concat(c,"rport").concat(c).concat(w.relPort):"").concat(Object.keys(w.extension).map(D=>"".concat(c).concat(D).concat(c).concat(w.extension[D])).join("")).concat(this.eol)).join("")}printRemoteCandidatesList(m){return m.map(w=>"a=remote-candidates:".concat(w.join(c)).concat(this.eol)).join("")}printEndOfCandidates(m){return m===void 0?"":"a=end-of-candidates"+this.eol}printRTPRelated(m){if(!m.payloads)return"";let w=m.payloads,D="";D+=m.rtcpFeedbackWildcards.map(H=>this.printRTCPFeedback("*",H)).join("");for(let H of w)D+=this.printRtpMap(H.payloadType,H.rtpMap),D+=this.printFmtp(H.payloadType,H.fmtp),D+=H.rtcpFeedbacks.map(St=>this.printRTCPFeedback(H.payloadType,St)).join("");return D}printFmtp(m,w){if(!w)return"";let D=Object.keys(w.parameters);return D.length===1&&w.parameters[D[0]]===null?"a=fmtp:".concat(m).concat(c).concat(D[0]).concat(this.eol):"a=fmtp:".concat(m).concat(c).concat(Object.keys(w.parameters).map(H=>"".concat(H,"=").concat(w.parameters[H])).join(";")).concat(this.eol)}printRtpMap(m,w){return w?"a=rtpmap:".concat(m).concat(c).concat(w.encodingName,"/").concat(w.clockRate).concat(w.encodingParameters?"/".concat(w.encodingParameters):"").concat(this.eol):""}printRTCPFeedback(m,w){let D="a=rtcp-fb:".concat(m).concat(c),H=w;return H.type==="trr-int"?D+="ttr-int".concat(c).concat(H.interval):(D+="".concat(H.type),H.parameter&&(D+="".concat(c).concat(H.parameter),H.additional&&(D+="".concat(c).concat(H.additional)))),D+this.eol}printPtime(m){return m===void 0?"":"a=ptime:".concat(m).concat(this.eol)}printMaxPtime(m){return m===void 0?"":"a=maxptime:".concat(m).concat(this.eol)}printDirection(m){return m===void 0?"":"a=".concat(m).concat(this.eol)}printSSRC(m){return m.map(w=>Object.keys(w.attributes).map(D=>"a=ssrc:".concat(w.ssrcId.toString(10)).concat(c).concat(D).concat(w.attributes[D]?":".concat(w.attributes[D]):"").concat(this.eol)).join("")).join("")}printRTCPMux(m){return m===void 0?"":"a=rtcp-mux".concat(this.eol)}printRTCPMuxOnly(m){return m===void 0?"":"a=rtcp-mux-only".concat(this.eol)}printRTCPRsize(m){return m===void 0?"":"a=rtcp-rsize".concat(this.eol)}printRTCP(m){if(m===void 0)return"";let w="a=rtcp:".concat(m.port);return m.netType&&(w+="".concat(c).concat(m.netType)),m.addressType&&(w+="".concat(c).concat(m.addressType)),m.address&&(w+="".concat(c).concat(m.address)),w+this.eol}printMSId(m){return m.map(w=>"a=msid:".concat(w.id).concat(w.appdata?"".concat(c).concat(w.appdata):"").concat(this.eol)).join("")}printImageattr(m){return m.map(w=>"a=imageattr:".concat(w).concat(this.eol)).join("")}printRid(m){return m.map(w=>{let D="a=rid:".concat(w.id).concat(c).concat(w.direction);return w.payloads&&(D+="".concat(c,"pt=").concat(w.payloads.join(","))),w.params.length>0&&(D+="".concat(c).concat(w.params.map(H=>H.type==="depend"?"depend=".concat(H.rids.join(",")):"".concat(H.type,"=").concat(H.val)).join(";"))),D+this.eol}).join("")}printSimulcast(m){return m===void 0?"":"a=simulcast:".concat(m).concat(this.eol)}printSCTPPort(m){return m===void 0?"":"a=sctp-port:".concat(m).concat(this.eol)}printMaxMessageSize(m){return m===void 0?"":"a=max-message-size:".concat(m).concat(this.eol)}printMid(m){return m===void 0?"":"a=mid:".concat(m).concat(this.eol)}printSSRCGroups(m){return m.map(w=>"a=ssrc-group:".concat(w.semantic).concat(w.ssrcIds.map(D=>"".concat(c).concat(D.toString(10))).join("")).concat(this.eol)).join("")}}function K(G){return new Y().parse(G)}function it(G,m){return new ne().print(G,m)}}},e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={exports:{}};return t[n](r,r.exports,i),r.exports}return i.d=(n,r)=>{for(var o in r)i.o(r,o)&&!i.o(n,o)&&Object.defineProperty(n,o,{enumerable:!0,get:r[o]})},i.o=(n,r)=>Object.prototype.hasOwnProperty.call(n,r),i.r=n=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(n,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(n,"__esModule",{value:!0})},i(8)})();function Li(t){return ow.parse(t)}function xo(t,e){return ow.print(t,e)}var fK=Cn("Array","keys"),gK=bo,SK=ai,TK=Wt,RK=fK,Mf=Array.prototype,vK={DOMTokenList:!0,NodeList:!0},yK=function(t){var e=t.keys;return t===Mf||TK(Mf,t)&&e===Mf.keys||SK(vK,gK(t))?RK:e},Zi=b(yK);function fe(t,e,i){return(e=function(n){var r=function(o,s){if(typeof o!="object"||!o)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(n);return typeof r=="symbol"?r:r+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function sw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function vt(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?sw(Object(i),!0).forEach(function(n){fe(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):sw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let aw=new class extends ue{constructor(){super(...arguments),fe(this,"currentUploadLogID",0)}reportLogUploadError(t){let{errorRange:e}=t;e[e.length-1]&&e[e.length-1]>this.currentUploadLogID&&(this.currentUploadLogID=e[e.length-1],this.emit("REPORT_LOG_UPLOAD",t))}};class CK{constructor(e){fe(this,"logger",void 0),fe(this,"prefixLists",[]),this.logger=e}debug(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.debug(...this.prefixLists,...i)}info(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.info(...this.prefixLists,...i)}warning(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.warning(...this.prefixLists,...i)}error(){for(var e=arguments.length,i=new Array(e),n=0;n<e;n++)i[n]=arguments[n];this.logger.error(...this.prefixLists,...i)}prefix(e){return this.prefixLists.push(e),this}popPrefix(){return this.prefixLists.pop(),this}}function Uf(){let t=new Date;return t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}function cw(){let t=new Date,e=/((\d+:){2}\d+)/.exec(new Date().toUTCString());return e?e?.[0]+":"+t.getUTCMilliseconds():t.toTimeString().split(" ")[0]+":"+t.getMilliseconds()}let pn={DEBUG:0,INFO:1,WARNING:2,ERROR:3,NONE:4},yh=Date.now(),yd=t=>{for(let e in pn)if(Object.prototype.hasOwnProperty.call(pn,e)&&pn[e]===t)return e;return"DEFAULT"},_=new class{constructor(){fe(this,"proxyServerURL",void 0),fe(this,"logLevel",pn.DEBUG),fe(this,"uploadState","collecting"),fe(this,"uploadLogWaitingList",[]),fe(this,"uploadLogUploadingList",[]),fe(this,"uploadErrorCount",0),fe(this,"currentLogID",0),fe(this,"url",void 0),fe(this,"extLog",(t,e)=>{this.appendLogToWaitingList(t,...e)})}debug(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];let n=[pn.DEBUG].concat(e);this.log.apply(this,n)}info(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];let n=[pn.INFO].concat(e);this.log.apply(this,n)}warning(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];let n=[pn.WARNING].concat(e);this.log.apply(this,n)}warn(){this.warning(...arguments)}error(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];let n=[pn.ERROR].concat(e);this.log.apply(this,n)}upload(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];let n=[pn.DEBUG].concat(e);this.uploadLog.apply(this,n)}setLogLevel(t){t=Math.min(Math.max(0,t),4),this.logLevel=t}enableLogUpload(){qt("UPLOAD_LOG",!0)}disableLogUpload(){qt("UPLOAD_LOG",!1),this.uploadLogUploadingList=[],this.uploadLogWaitingList=[]}setProxyServer(t){this.proxyServerURL=t}prefix(t){return new CK(this).prefix(t)}log(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(Date.now()-yh<100)return void setTimeout(()=>{this.log(...e)},Date.now()-yh);let n=Math.max(0,Math.min(4,e[0]));if(e[0]=Uf()+" Agora-SDK [".concat(yd(n),"]:"),this.appendLogToWaitingList(n,...e),n<this.logLevel)return;let r=Uf()+" %cAgora-SDK [".concat(yd(n),"]:"),o=[];if(!A("USE_NEW_LOG"))switch(n){case pn.DEBUG:o=[r,"color: #64B5F6;"].concat(e.slice(1)),console.log.apply(console,o);break;case pn.INFO:o=[r,"color: #1E88E5; font-weight: bold;"].concat(e.slice(1)),console.log.apply(console,o);break;case pn.WARNING:o=[r,"color: #FB8C00; font-weight: bold;"].concat(e.slice(1)),console.warn.apply(console,o);break;case pn.ERROR:o=[r,"color: #B00020; font-weight: bold;"].concat(e.slice(1)),console.error.apply(console,o)}}uploadLog(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];if(Date.now()-yh<100)return void setTimeout(()=>{this.uploadLog(...e)},Date.now()-yh);let n=Math.max(0,Math.min(4,e[0]));e[0]=Uf()+" Agora-SDK [".concat(yd(n),"]:"),this.appendLogToWaitingList(n,...e)}appendLogToWaitingList(t){if(!A("UPLOAD_LOG"))return;for(var e=arguments.length,i=new Array(e>1?e-1:0),n=1;n<e;n++)i[n-1]=arguments[n];Array.isArray(i[0])?i[0][0]=cw()+" Agora-SDK [".concat(yd(t),"]:"):i[0]=cw()+" Agora-SDK [".concat(yd(t),"]:");let r="";i.forEach(o=>{typeof o=="object"&&(o=JSON.stringify(o)),r+="".concat(o," ")}),this.uploadLogWaitingList.push({payload_str:r,log_level:t,log_item_id:this.currentLogID++}),this.uploadState==="uploading"&&this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}startUpload(){this.uploadState="uploading",this.uploadLogUploadingList.length===0&&this.uploadLogInterval()}uploadLogs(){return I(this,null,function*(){let t=this.uploadLogUploadingList,e={sdk_version:hn,process_id:A("PROCESS_ID"),payload:JSON.stringify(t)};return er(()=>I(this,null,function*(){let i=yield bi.post(this.url||(this.proxyServerURL?"https://".concat(this.proxyServerURL,"/ls/?h=").concat(A("LOG_UPLOAD_SERVER"),"&p=443&d=upload/v1"):"https://".concat(A("LOG_UPLOAD_SERVER"),"/upload/v1")),e,{responseType:"text"});if(i.data!=="OK"){let n=new Error("unexpected upload log response");throw n.response=i,n}}),()=>(this.uploadLogUploadingList=[],!1),i=>{let n={status:-1,message:i.message,errorRange:t.map(r=>r.log_item_id)};return i.response?(n.status=i.response.status,n.data=i.response.data,n.headers=i.response.headers):i.request&&(n.status=i.request.status),aw.reportLogUploadError(n),!0},{timeout:A("UPLOAD_LOG_REQUEST_RETRY_INTERVAL"),maxRetryTimeout:A("UPLOAD_LOG_REQUEST_MAX_RETRY_INTERVAL")})})}uploadLogInterval(){this.uploadLogUploadingList.length===0&&this.uploadLogWaitingList.length===0||(this.uploadLogUploadingList.length===0&&(this.uploadLogUploadingList=this.uploadLogWaitingList.splice(0,A("UPLOAD_LOG_LENGTH_EACH_TIME"))),this.uploadLogs().then(()=>{this.uploadErrorCount=0,this.uploadLogWaitingList.length>0&&window.setTimeout(()=>this.uploadLogInterval(),A("UPLOAD_LOG_INTERVAL"))}).catch(t=>{this.uploadErrorCount+=1,this.uploadErrorCount<2?window.setTimeout(()=>this.uploadLogInterval(),A("UPLOAD_LOG_TWICE_RETRY_INTERVAL_V1")):window.setTimeout(()=>this.uploadLogInterval(),A("UPLOAD_LOG_RETRY_INTERVAL_V1"))}))}};var dw;function bK(t){return Ke(t.reportId,"params.reportId",0,100,!1),Ke(t.category,"params.category",0,100,!1),Ke(t.event,"params.event",0,100,!1),Ke(t.label,"params.label",0,100,!1),Xt(t.value,"params.value",Number.MIN_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,!1),!0}(dw={}).FREE="free",dw.UPLOADING="uploading",function(t){t[t.MISC=0]="MISC",t[t.INTERNAL_EVENT=1]="INTERNAL_EVENT",t[t.PUBLIC_EVENT=2]="PUBLIC_EVENT",t[t.WEB_EVENT=3]="WEB_EVENT",t[t.INTERNAL_API=4]="INTERNAL_API",t[t.WEB_API=5]="WEB_API",t[t.PUBLIC_API=6]="PUBLIC_API"}({});let IK={sid:"",lts:0,success:null,cname:null,uid:null,peer:null,cid:null,elapse:null,extend:null,vid:0},Fe=function(t){return t.PUBLISH="publish",t.SUBSCRIBE="subscribe",t.WS_COMPRESSOR_INIT="ws_compressor_init",t.SESSION_INIT="session_init",t.JOIN_CHOOSE_SERVER="join_choose_server",t.REQ_USER_ACCOUNT="req_user_account",t.JOIN_GATEWAY="join_gateway",t.REJOIN_GATEWAY="rejoin_gateway",t.STREAM_SWITCH="stream_switch",t.REQUEST_PROXY_WORKER_MANAGER="request_proxy_worker_manager",t.REQUEST_PROXY_APPCENTER="request_proxy_appcenter",t.FIRST_VIDEO_RECEIVED="first_video_received",t.FIRST_AUDIO_RECEIVED="first_audio_received",t.FIRST_VIDEO_DECODE="first_video_decode",t.FIRST_AUDIO_DECODE="first_audio_decode",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_UPDATE_STREAM="on_update_stream",t.ON_REMOVE_STREAM="on_remove_stream",t.USER_ANALYTICS="req_user_analytics",t.PC_STATS="pc_stats",t.UPDATE_REMOTE_RTPCAPABILITIES="update_remote_rtpCapabilities",t.AB_TEST="ab_test",t}({}),ce=function(t){return t.SESSION="io.agora.pb.Wrtc.Session",t.JOIN_CHOOSE_SERVER="io.agora.pb.Wrtc.JoinChooseServer",t.REQ_USER_ACCOUNT="io.agora.pb.Wrtc.ReqUserAccount",t.JOIN_GATEWAY="io.agora.pb.Wrtc.JoinGateway",t.RE_JOIN_GATEWAY="io.agora.pb.Wrtc.ReJoinGateway",t.PUBLISH="io.agora.pb.Wrtc.Publish",t.SUBSCRIBE="io.agora.pb.Wrtc.Subscribe",t.WS_COMPRESSOR_INIT="io.agora.pb.Wrtc.WsCompressorInit",t.STREAM_SWITCH="io.agora.pb.Wrtc.StreamSwitch",t.AUDIO_SENDING_STOPPED="io.agora.pb.Wrtc.AudioSendingStopped",t.VIDEO_SENDING_STOPPED="io.agora.pb.Wrtc.VideoSendingStopped",t.REQUEST_PROXY_APPCENTER="io.agora.pb.Wrtc.RequestProxyAppCenter",t.REQUEST_PROXY_WORKER_MANAGER="io.agora.pb.Wrtc.RequestProxyWorkerManager",t.API_INVOKE="io.agora.pb.Wrtc.ApiInvoke",t.FIRST_VIDEO_RECEIVED="io.agora.pb.Wrtc.FirstVideoReceived",t.FIRST_AUDIO_RECEIVED="io.agora.pb.Wrtc.FirstAudioReceived",t.FIRST_VIDEO_DECODE="io.agora.pb.Wrtc.FirstVideoDecode",t.FIRST_AUDIO_DECODE="io.agora.pb.Wrtc.FirstAudioDecode",t.ON_ADD_AUDIO_STREAM="io.agora.pb.Wrtc.OnAddAudioStream",t.ON_ADD_VIDEO_STREAM="io.agora.pb.Wrtc.OnAddVideoStream",t.ON_UPDATE_STREAM="io.agora.pb.Wrtc.OnUpdateStream",t.ON_REMOVE_STREAM="io.agora.pb.Wrtc.OnRemoveStream",t.JOIN_CHANNEL_TIMEOUT="io.agora.pb.Wrtc.JoinChannelTimeout",t.PEER_PUBLISH_STATUS="io.agora.pb.Wrtc.PeerPublishStatus",t.WORKER_EVENT="io.agora.pb.Wrtc.WorkerEvent",t.AP_WORKER_EVENT="io.agora.pb.Wrtc.APWorkerEvent",t.JOIN_WEB_PROXY_AP="io.agora.pb.Wrtc.JoinWebProxyAP",t.WEBSOCKET_QUIT="io.agora.pb.Wrtc.WebSocketQuit",t.USER_ANALYTICS="io.agora.pb.Wrtc.UserAnalytics",t.AUTOPLAY_FAILED="io.agora.pb.Wrtc.AutoplayFailed",t.PC_STATS="io.agora.pb.Wrtc.PCStats",t.UPDATE_REMOTE_RTPCAPABILITIES="io.agora.pb.Wrtc.UpdateRemoteRTPCapabilities",t.AB_TEST="io.agora.pb.Wrtc.ABTest",t}({});(function(t){t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT"})({});let AK=function(t){return t[t.SESSION=26]="SESSION",t[t.JOIN_CHOOSE_SERVER=27]="JOIN_CHOOSE_SERVER",t[t.REQ_USER_ACCOUNT=196]="REQ_USER_ACCOUNT",t[t.JOIN_GATEWAY=28]="JOIN_GATEWAY",t[t.PUBLISH=30]="PUBLISH",t[t.SUBSCRIBE=29]="SUBSCRIBE",t[t.WS_COMPRESSOR_INIT=9430]="WS_COMPRESSOR_INIT",t[t.STREAM_SWITCH=32]="STREAM_SWITCH",t[t.AUDIO_SENDING_STOPPED=33]="AUDIO_SENDING_STOPPED",t[t.VIDEO_SENDING_STOPPED=34]="VIDEO_SENDING_STOPPED",t[t.REQUEST_PROXY_APPCENTER=35]="REQUEST_PROXY_APPCENTER",t[t.REQUEST_PROXY_WORKER_MANAGER=36]="REQUEST_PROXY_WORKER_MANAGER",t[t.API_INVOKE=41]="API_INVOKE",t[t.FIRST_VIDEO_RECEIVED=348]="FIRST_VIDEO_RECEIVED",t[t.FIRST_AUDIO_RECEIVED=349]="FIRST_AUDIO_RECEIVED",t[t.FIRST_VIDEO_DECODE=350]="FIRST_VIDEO_DECODE",t[t.FIRST_AUDIO_DECODE=351]="FIRST_AUDIO_DECODE",t[t.ON_ADD_AUDIO_STREAM=352]="ON_ADD_AUDIO_STREAM",t[t.ON_ADD_VIDEO_STREAM=353]="ON_ADD_VIDEO_STREAM",t[t.ON_UPDATE_STREAM=356]="ON_UPDATE_STREAM",t[t.ON_REMOVE_STREAM=355]="ON_REMOVE_STREAM",t[t.JOIN_CHANNEL_TIMEOUT=407]="JOIN_CHANNEL_TIMEOUT",t[t.PEER_PUBLISH_STATUS=408]="PEER_PUBLISH_STATUS",t[t.WORKER_EVENT=156]="WORKER_EVENT",t[t.AP_WORKER_EVENT=160]="AP_WORKER_EVENT",t[t.JOIN_WEB_PROXY_AP=700]="JOIN_WEB_PROXY_AP",t[t.WEBSOCKET_QUIT=671]="WEBSOCKET_QUIT",t[t.USER_ANALYTICS=1e4]="USER_ANALYTICS",t[t.AUTOPLAY_FAILED=9178]="AUTOPLAY_FAILED",t}({});function ut(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{};return function(e,i,n){let r=n.value;if(typeof r=="function"){let o=t.className||e.__className__||(e.constructor.name==="AgoraRTCClient"?"Client":e.constructor.name);n.value=function(){for(var s,a=arguments.length,c=new Array(a),d=0;d<a;d++)c[d]=arguments[d];let l=c;if(t.argsMap)try{l=t.argsMap(this,...c)}catch(h){_.warning(h),l=[]}try{JSON.stringify(l)}catch{_.warning("arguments for method ".concat(o,".").concat(String(i)," not serializable for apiInvoke.")),l=[]}let u=(t.report||ot).reportApiInvoke(this._sessionId||null,{id:this._clientId||((s=this.store)===null||s===void 0?void 0:s.clientId)||this._ID,name:"".concat(o,".").concat(String(i)),options:l,tag:Ee.TRACER,reportResult:t.reportResult},t.throttleTime);try{let h=r.apply(this,c);return h instanceof Q?h.then(p=>(u.onSuccess(t.reportResult&&p),p)).catch(p=>{throw u.onError(p),p}):(u.onSuccess(t.reportResult&&h),h)}catch(h){throw u.onError(h),h}}}return n}}let ot=new class{constructor(){fe(this,"baseInfoMap",new Map),fe(this,"proxyServer",void 0),fe(this,"eventUploadTimer",void 0),fe(this,"setSessionIdTimer",void 0),fe(this,"url",void 0),fe(this,"sids",new Set),fe(this,"backupUrl",void 0),fe(this,"_appId",void 0),fe(this,"_aid",0),fe(this,"keyEventUploadPendingItems",[]),fe(this,"normalEventUploadPendingItems",[]),fe(this,"apiInvokeUploadPendingItems",[]),fe(this,"apiInvokeCount",0),fe(this,"apiInvokeLoggedCount",0),fe(this,"ltsList",[]),fe(this,"lastSendNormalEventTime",Date.now()),fe(this,"customReportCounterTimer",void 0),fe(this,"customReportCount",0),fe(this,"extApiInvoke",t=>I(this,null,function*(){for(let e of t){let i=vt(vt({},e),{},{sid:null,invokeId:++this.apiInvokeCount,tag:Ee.TRACER});this.sendApiInvoke(i)}})),this.eventUploadTimer=window.setInterval(this.doSend.bind(this),A("EVENT_REPORT_SEND_INTERVAL")),this.setSessionIdTimer=window.setInterval(this.appendSessionId.bind(this),A("EVENT_REPORT_SEND_INTERVAL"))}getBaseInfoBySessionId(t){return this.baseInfoMap.get(t)}setAppId(t){this._appId=t,this._aid=parseInt(t.replace(/[a-fA-F0-9]{8}/g,e=>{let[i,n]=e;return i+n}),16)||0}reportApiInvoke(t,e,i){e.timeout=e.timeout||6e4,e.reportResult=e.reportResult===void 0||e.reportResult;let n=Date.now();this.apiInvokeCount+=1;let r=this.apiInvokeCount,o=!!A("SHOW_REPORT_INVOKER_LOG"),s=!!A("SHOW_REPORT_USER_INVOKER_LOG"),a=o||s&&e.id;a&&(this.apiInvokeLoggedCount+=1);let c=this.apiInvokeLoggedCount;function d(p,g){if(a){let E="[apiInvoke-".concat(c,"]");if(e.id&&(E+="[".concat(e.id,"]")),e.name&&(E+="[".concat(e.name,"]"),e.name===be.JOIN))return _.info("".concat(E," ").concat(p));_.info("".concat(E," ").concat(p),p==="start"?e.options:g||"")}}let l=()=>({tag:e.tag,invokeId:r,sid:t,name:e.name,apiInvokeTime:n,options:e.options,states:e.states||null});d("start");let u=!1;qe(e.timeout).then(()=>{u||(this.sendApiInvoke(vt(vt({},l()),{},{error:C.API_INVOKE_TIMEOUT,success:!1})),d("timeout"))});let h=new F(C.UNEXPECTED_ERROR,"".concat(e.name,": this api invoke is end"));return{onSuccess:p=>{let g=()=>{if(u)throw h;return u=!0,this.sendApiInvoke(vt(vt({},l()),{},{success:!0},e.reportResult&&{result:p})),d("onSuccess"),p};return i?GA(g,e.name+"Success",i,()=>u=!0):g()},onError:p=>{let g=()=>{if(u)throw p;u=!0,this.sendApiInvoke(vt(vt({},l()),{},{success:!1,error:p})),d("onFailure",p.toString())};return i?GA(g,e.name+"Error",i,()=>u=!0):g()}}}sessionInit(t,e){if(this.baseInfoMap.has(t))return;let i=Date.now(),n=this.createBaseInfo(t,i);n.cname=e.cname;let r=Object.assign({},{willUploadConsoleLog:A("UPLOAD_LOG"),maxTouchPoints:navigator.maxTouchPoints,areaVersion:Df?"global":"oversea",areas:A("AREAS")&&A("AREAS").join(",")},e.extend),{stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:d,clientRole:l}=e,u=Date.now(),h=vt(vt({},n),{},{eventType:Fe.SESSION_INIT,appid:e.appid,browser:navigator.userAgent,buildFormat:e.buildFormat,build:Lf,lts:u,elapse:u-i,extend:JSON.stringify(r),mode:e.mode,process:A("PROCESS_ID"),appType:A("APP_TYPE"),success:!0,version:hn,stringUid:o,channelProfile:s,channelMode:a,isABTestSuccess:c,lsid:d,clientType:z(p=window.navigator.userAgent).call(p,"AgoraWebView")?42:20,clientRole:l,serviceId:A("PROCESS_ID"),extensionID:A("PLUGIN_INFO").join(",")||""});var p;this.send({type:ce.SESSION,data:h},!0)}joinChooseServer(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt({},n),{},{role:e.role,eventType:Fe.JOIN_CHOOSE_SERVER,lts:r,eventElapse:e.elapse||r-e.lts,chooseServerAddr:e.csAddr,errorCode:e.ec,elapse:r-i.startTime,success:e.succ,chooseServerAddrList:JSON.stringify(e.serverList),uid:e.uid?parseInt(e.uid):null,cid:e.cid?parseInt(e.cid):null,chooseServerIp:e.csIp||"",opid:e.opid,unilbsServerIds:e.unilbsServerIds,extend:e.extend||void 0,isHttp3:e.isHttp3,corssRegionTagReq:e.corssRegionTagReq||void 0,corssRegionTagRes:e.corssRegionTagRes||void 0});this.send({type:ce.JOIN_CHOOSE_SERVER,data:o},!0)}reqUserAccount(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt({},n),{},{eventType:Fe.REQ_USER_ACCOUNT,lts:r,success:e.success,serverAddress:e.serverAddr,stringUid:e.stringUid,uid:e.uid,errorCode:e.errorCode,elapse:e.elapse||r-i.startTime,eventElapse:r-e.lts,extend:JSON.stringify(e.extend)});this.send({type:ce.REQ_USER_ACCOUNT,data:o},!0)}joinGateway(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info;e.vid&&(n.vid=e.vid),n.uid=e.uid,n.cid=e.cid;let r=Date.now(),{firstSuccess:o,addr:s,isProxy:a}=e,c=r-i.startTime,d=vt(vt({},n),{},{eventType:Fe.JOIN_GATEWAY,lts:r,gatewayAddr:e.addr,success:e.succ,errorCode:e.ec,errorMsg:e.errorMsg||"",elapse:c,eventElapse:r-e.lts,firstSuccess:o,signalChannel:e.signalChannel,preload:e.preload?1:0,installId:Nf(),isABTestSuccess:e.isABTestSuccess?1:0}),l=d.success?1:0;if(e.succ&&(i.lastJoinSuccessTime=r),o)this.send({type:ce.JOIN_GATEWAY,data:d},!0);else{let u;if(s)if(a){let p=s.match(/h=(\d{1,3}-){3}\d{1,3}/g),g=s.match(/p=[0-9]{1,6}/g);u={isSuccess:l,gatewayIp:p&&p.length?p[0].split("=")[1].replace(/-/g,"."):"",port:g&&g.length?g[0].split("=")[1]:"",isProxy:a?1:0}}else{let p=s.match(/wss:\/\/(\d{1,3}-){3}\d{1,3}/g),g=s.match(/(:|p=)[0-9]{1,6}/g);u={isSuccess:l,gatewayIp:p&&p.length?p[0].split("//")[1].replace(/-/g,"."):"",port:g&&g.length?g[0].split(/:|p=/g)[1]:"",isProxy:a?1:0}}else u={isSuccess:l,gatewayIp:"",port:"",isProxy:a?1:0};delete d.success,delete d.eventType,delete d.firstSuccess,d.vid=Number(d.vid);let h=Object.assign({},d,u,{eventType:Fe.REJOIN_GATEWAY});this.send({type:ce.RE_JOIN_GATEWAY,data:h},!0)}}joinChannelTimeout(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=Date.now(),r=vt(vt({},i.info),{},{lts:n,timeout:e,elapse:n-i.startTime});this.send({type:ce.JOIN_CHANNEL_TIMEOUT,data:r},!0)}publish(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt({},n),{},{eventType:Fe.PUBLISH,lts:r,eventElapse:e.eventElapse,elapse:r-i.startTime,success:e.succ,errorCode:e.ec,videoName:e.videoName,audioName:e.audioName,screenName:e.screenName,screenshare:e.screenshare,audio:e.audio,video:e.video,p2pid:e.p2pid,publishRequestid:e.publishRequestid});this.send({type:ce.PUBLISH,data:o},!0)}subscribe(t,e,i){let n=this.baseInfoMap.get(t);if(!n)return;let r=n.info,o=Date.now(),s=vt(vt({},r),{},{eventType:Fe.SUBSCRIBE,lts:o,eventElapse:e.eventElapse,elapse:o-n.startTime,success:e.succ,errorCode:e.ec,video:e.video,audio:e.audio,subscribeRequestid:e.subscribeRequestid,p2pid:e.p2pid,preSsrc:e.preSsrc?1:0},i&&{extend:JSON.stringify({isMassSubscribe:!0})});typeof e.peerid=="string"?s.peerSuid=e.peerid:s.peer=e.peerid,this.send({type:ce.SUBSCRIBE,data:s},!0)}wsCompressorInit(t){var e;let i=[...Zi(e=this.baseInfoMap).call(e)],n=i.length?i[0]:"UnableToGetSid",r=this.baseInfoMap.get(n);if(!r)return;let o=r.info,s=Date.now(),a=vt(vt({},o),{},{eventType:Fe.WS_COMPRESSOR_INIT,lts:s,eventElapse:t.eventElapse,elapse:s-r.startTime,status:t.status?1:2});this.send({type:ce.WS_COMPRESSOR_INIT,data:a},!0)}firstRemoteVideoDecode(t,e,i,n){let r=this.baseInfoMap.get(t);if(!r)return;let o=r.info,s=Date.now(),a=vt(vt(vt({},o),n),{},{elapse:s-r.startTime,eventType:e,lts:s,firstDecodeFrame:Math.max((n.firstFrame||s)-r.startTime,0),apEnd:Math.max(n.apEnd-r.startTime,0),apStart:Math.max(n.apStart-r.startTime,0),joinGwEnd:Math.max(n.joinGwEnd-r.startTime,0),joinGwStart:Math.max(n.joinGwStart-r.startTime,0),pcEnd:Math.max(n.pcEnd-r.startTime,0),pcStart:Math.max(n.pcStart-r.startTime,0),subscriberEnd:Math.max(n.subscriberEnd-r.startTime,0),subscriberStart:Math.max(n.subscriberStart-r.startTime,0),videoAddNotify:Math.max(n.videoAddNotify-r.startTime,0)});this.send({type:i,data:a},!0)}firstRemoteFrame(t,e,i,n){let r=this.baseInfoMap.get(t);if(!r)return;let o=r.info,s=Date.now(),a=vt(vt(vt({},o),n),{},{elapse:s-r.startTime,eventType:e,lts:s});this.send({type:i,data:a},!0)}abTest(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt(vt({},n),e),{},{vid:n.vid===void 0?0:Number(n.vid),elapse:r-i.startTime,eventType:Fe.AB_TEST,lts:r});this.send({type:ce.AB_TEST,data:o},!0)}pcStats(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt(vt({},n),e),{},{vid:n.vid===void 0?0:Number(n.vid),elapse:r-i.startTime,eventType:Fe.PC_STATS,lts:r,preallocation:e.preallocation?1:0});this.send({type:ce.PC_STATS,data:o},!0)}updateRemoteRTPCapabilities(t,e){if(t){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt(vt({},n),e),{},{vid:n.vid===void 0?0:Number(n.vid),eventType:Fe.UPDATE_REMOTE_RTPCAPABILITIES,lts:r});this.send({type:ce.UPDATE_REMOTE_RTPCAPABILITIES,data:o},!0)}}onGatewayStream(t,e,i,n){let r=this.baseInfoMap.get(t);if(!r)return;let o=r.info,s=Date.now(),a=vt(vt(vt({},o),n),{},{eventType:e,lts:s});this.send({type:i,data:a},!0)}streamSwitch(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt({},n),{},{eventType:Fe.STREAM_SWITCH,lts:r,isDual:e.isdual,elapse:r-i.startTime,success:e.succ});this.send({type:ce.STREAM_SWITCH,data:o},!0)}requestProxyAppCenter(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt({},n),{},{eventType:Fe.REQUEST_PROXY_APPCENTER,lts:r,eventElapse:r-e.lts,elapse:r-i.startTime,APAddr:e.APAddr,workerManagerList:e.workerManagerList,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:ce.REQUEST_PROXY_APPCENTER,data:o},!0)}requestProxyWorkerManager(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt({},n),{},{eventType:Fe.REQUEST_PROXY_WORKER_MANAGER,lts:r,eventElapse:r-e.lts,elapse:r-i.startTime,workerManagerAddr:e.workerManagerAddr,response:e.response,errorCode:e.ec,success:e.succ});this.send({type:ce.REQUEST_PROXY_WORKER_MANAGER,data:o},!0)}setProxyServer(t){this.proxyServer=t,t?_.debug("reportProxyServerurl: ".concat(t)):_.debug("disable reportProxyServerurl: ".concat(t))}peerPublishStatus(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt({},n),{},{subscribeElapse:e.subscribeElapse,peer:e.peer,peerPublishDuration:Math.max(e.audioPublishDuration,e.videoPublishDuration),audiotag:e.audioPublishDuration>0?1:-1,videotag:e.videoPublishDuration>0?1:-1,lts:r,elapse:r-i.startTime,joinChannelSuccessElapse:r-(i.lastJoinSuccessTime||r),peerPublishDurationVideo:e.videoPublishDuration,peerPublishDurationAudio:e.audioPublishDuration});this.send({type:ce.PEER_PUBLISH_STATUS,data:o},!0)}workerEvent(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now();(function(o,s,a){let c=o[s];if(!c||typeof c!="string")return[o];o[s]="";let d=vr(JSON.stringify(o)),l=0,u=[],h=0;for(let p=0;p<c.length;p++)h+=c.charCodeAt(p)<=127?1:3,h<=a-d||(u[u.length]=tt(tt({},o),{},{[s]:c.substring(l,p)}),l=p,h=c.charCodeAt(p)<=127?1:3);return l!==c.length-1&&(u[u.length]=tt(tt({},o),{},{[s]:c.substring(l)})),u})(vt(vt(vt({},n),e),{},{elapse:r-i.startTime,lts:r,productType:"WebRTC"}),"payload",1300).forEach(o=>this.send({type:ce.WORKER_EVENT,data:o},!0))}apworkerEvent(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt(vt({},n),e),{},{elapse:r-i.startTime,lts:r});this.send({type:ce.AP_WORKER_EVENT,data:o},!0)}joinWebProxyAP(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt(vt({},n),e),{},{elapse:r-i.startTime,lts:r,extend:e.extend||void 0});this.send({type:ce.JOIN_WEB_PROXY_AP,data:o},!0)}WebSocketQuit(t,e){let i=this.baseInfoMap.get(t);if(!i)return;let n=i.info,r=Date.now(),o=vt(vt(vt({},n),e),{},{elapse:r-i.startTime,lts:r});this.send({type:ce.WEBSOCKET_QUIT,data:o},!0)}sendCustomReportMessage(t,e){return I(this,null,function*(){if(this.customReportCount+=e.length,this.customReportCount>A("CUSTOM_REPORT_LIMIT"))throw new F(C.CUSTOM_REPORT_FREQUENCY_TOO_HIGH);this.customReportCounterTimer||(this.customReportCounterTimer=window.setInterval(()=>{this.customReportCount=0},5e3));let i=Date.now(),n=e.map(r=>({type:ce.USER_ANALYTICS,data:vt(vt({sid:t},r),{},{lts:i})}));try{A("NEW_REPORT_SERVER")?yield this.postDataToStatsCollector2(n):yield this.postDataToStatsCollector(n)}catch(r){throw _.error("send custom report message failed",r.toString()),new F(C.CUSTOM_REPORT_SEND_FAILED,r.message)}})}sendApiInvoke(t){let e=A("NOT_REPORT_EVENT");if(t.tag&&z(e)&&z(e).call(e,t.tag))return!1;if(t.sid===null)return this.apiInvokeUploadPendingItems.push(t),!1;let i=this.baseInfoMap.get(t.sid);if(!i)return this.apiInvokeUploadPendingItems.push(t),!1;let{cname:n,uid:r,cid:o}=i.info,s;if(t.lts=t.lts||Date.now(),t.error)if(t.error instanceof F){let{code:c,message:d}=t.error;s=c||d||t.error.toString()}else s=t.error.toString();let a={invokeId:t.invokeId,sid:t.sid,cname:n,cid:o,uid:r,lts:t.lts,success:t.success,elapse:t.lts-i.startTime,execElapse:t.lts-t.apiInvokeTime,apiName:t.name,options:t.options?JSON.stringify(t.options):void 0,execStates:t.states?JSON.stringify(t.states):void 0,execResult:t.result?JSON.stringify(t.result):void 0,errorCode:t.error?s:void 0,errorMsg:t.error?JSON.stringify(t.error):void 0};return this.send({type:ce.API_INVOKE,data:a},!1),!0}addSid(t){this.sids.add(t)}removeSid(t){this.sids.delete(t)}appendSessionId(){let t=this.apiInvokeUploadPendingItems;if(t.length===0)return;let e=Array.from(this.sids).find(i=>i!==null);e&&t.forEach(i=>{i&&(i.sid=e,this.sendApiInvoke(Object.assign({},i)))}),t.length=0}send(t,e){if(e)return this.keyEventUploadPendingItems.push(t),void this.sendItems(this.keyEventUploadPendingItems,!0);this.normalEventUploadPendingItems.push(t),this.normalEventUploadPendingItems.length>A("NORMAL_EVENT_QUEUE_CAPACITY")&&this.normalEventUploadPendingItems.splice(0,1),this.normalEventUploadPendingItems.length>=10&&this.sendItems(this.normalEventUploadPendingItems,!1)}doSend(){this.keyEventUploadPendingItems.length>0&&this.sendItems(this.keyEventUploadPendingItems,!0),this.normalEventUploadPendingItems.length>0&&Date.now()-this.lastSendNormalEventTime>=5e3&&this.sendItems(this.normalEventUploadPendingItems,!1)}sendItems(t,e){let i=[],n=[];for(;t.length;){let o=t.shift();i.length<20?i.push(o):n.push(o)}t.push(...n);for(let o of[...i]){var r;this.ltsList.indexOf(o.data.lts)!==-1?(o.data.lts=this.ltsList[this.ltsList.length-1]+1,this.ltsList.push(o.data.lts)):(this.ltsList.push(o.data.lts),ls(r=this.ltsList).call(r,(s,a)=>s-a))}return e||(this.lastSendNormalEventTime=Date.now()),A("ENABLE_EVENT_REPORT")&&i.length&&(A("NEW_REPORT_SERVER")?this.postDataToStatsCollector2(i):this.postDataToStatsCollector(i)).catch((o=>s=>{A("EVENT_REPORT_RETRY")&&(e?this.keyEventUploadPendingItems=this.keyEventUploadPendingItems.concat(o):(this.normalEventUploadPendingItems=this.normalEventUploadPendingItems.concat(o),this.normalEventUploadPendingItems.length>A("NORMAL_EVENT_QUEUE_CAPACITY")&&(this.normalEventUploadPendingItems.splice(0,this.normalEventUploadPendingItems.length-A("NORMAL_EVENT_QUEUE_CAPACITY")),_.warning("report: drop normal events"))))})(i)),t}postDataToStatsCollector2(t){return I(this,null,function*(){Ie.networkState===Wi.OFFLINE&&(yield Q.race([Ie.onlineWaiter,qe(2*Oe.maxRetryTimeout)]));let e=r=>{let o=new Uint8Array;return r.forEach(s=>{let a=ff(JSON.stringify(s.data)),c=new ArrayBuffer(5),d=(u=>{let h=0;return Object.entries(ce).forEach(p=>{let[g,E]=p;E===u.type&&(h=AK[g])}),h})(s),l=new DataView(c);l.setUint16(0,a.byteLength,!0),l.setUint8(2,255&d),l.setUint8(3,d>>>8&255),l.setUint8(4,d>>>16&255),o=LA(o,new Uint8Array(c)),o=LA(o,a)}),o},i="event",n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(A("NEW_REPORT_SERVER_DOMAINS")[0],"&p=443&d=").concat(i):"https://".concat(A("NEW_REPORT_SERVER_DOMAINS")[0],"/").concat(i);for(let r=0;r<2;r+=1){r===1&&(n=this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(A("NEW_REPORT_SERVER_DOMAINS")[1],"&p=443&d=").concat(i):"https://".concat(A("NEW_REPORT_SERVER_DOMAINS")[1],"/").concat(i));try{yield bf(n,{timeout:1e4,data:e(t),headers:vt(vt({biz:"webrtc",sendts:Math.round(Date.now()/1e3),debug:"false"},this._appId&&{appid:this._appId}),{},{"Content-Type":"application/octet-stream"})},!0)}catch(o){if(r===1)throw o;continue}return}})}postDataToStatsCollector(e){return I(this,arguments,function*(t){let i=arguments.length>1&&arguments[1]!==void 0&&arguments[1],n=(c=>{let d=c&&c.data.sid&&this.baseInfoMap.get(c.data.sid);return d&&d.info.vid&&+d.info.vid||0})(t[0]),r=n?void 0:this._aid,o={msgType:"EventMessages",sentTs:Math.round(Date.now()/1e3),payloads:t.map(c=>JSON.stringify(c)),vid:n,aid:r};Ie.networkState===Wi.OFFLINE&&(yield Q.race([Ie.onlineWaiter,qe(2*Oe.maxRetryTimeout)]));let s=i?"/events/proto-raws":"/events/messages",a=this.url||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(A("EVENT_REPORT_DOMAIN"),"&p=").concat(A("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(A("EVENT_REPORT_DOMAIN"),":").concat(A("STATS_COLLECTOR_PORT")).concat(s));for(let c=0;c<2;c+=1){c===1&&(a=this.backupUrl||(this.proxyServer?"https://".concat(this.proxyServer,"/rs/?h=").concat(A("EVENT_REPORT_BACKUP_DOMAIN"),"&p=").concat(A("STATS_COLLECTOR_PORT"),"&d=").concat(s):"https://".concat(A("EVENT_REPORT_BACKUP_DOMAIN"),":").concat(A("STATS_COLLECTOR_PORT")).concat(s)));try{i?yield hK(a,{timeout:1e4,data:o}):yield bf(a,{timeout:1e4,data:o})}catch(d){if(c===1)throw d;continue}return}})}createBaseInfo(t,e){let i=Object.assign({},IK);return i.sid=t,this.baseInfoMap.set(t,{info:i,startTime:e}),i}reportResourceTiming(t,e){let i=performance.getEntriesByName(t),n=i[i.length-1];n&&this.reportApiInvoke(e,{name:"Client.resourceTiming",options:n,tag:Ee.TRACER}).onSuccess()}};aw.on("REPORT_LOG_UPLOAD",t=>{t.networkState=Ie.networkState,ot.reportApiInvoke(null,{name:"logUploadError",options:t,tag:Ee.TRACER}).onSuccess("logUploadError")});class x extends F{constructor(e){super(e,arguments.length>1&&arguments[1]!==void 0?arguments[1]:"",arguments.length>2?arguments[2]:void 0),fe(this,"name","AgoraRTCException")}print(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:"error";return super.print(e,_)}throw(){super.throw(_)}}let Ye={getDisplayMedia:!1,getStreamFromExtension:!1,supportUnifiedPlan:!1,supportMinBitrate:!1,supportSetRtpSenderParameters:!1,supportDualStream:!0,webAudioMediaStreamDest:!1,supportReplaceTrack:!1,supportWebGL:!1,webAudioWithAEC:!1,supportRequestFrame:!1,supportShareAudio:!1,supportDualStreamEncoding:!1,supportDataChannel:!1,supportPCSetConfiguration:!1,supportWebRTCEncodedTransform:!1,supportWebRTCInsertableStream:!1,supportRequestVideoFrameCallback:!1,supportWebCrypto:!1};function Mt(){return Ye}function lw(){return"setSinkId"in HTMLAudioElement.prototype&&(!A("RESTRICTION_SET_PLAYBACK_DEVICE")||(Jr()||RA())&&!_f())}function uw(){return!Ye.supportUnifiedPlan||A("CHROME_FORCE_PLAN_B")&&Qr()}let ze=function(t){return t.IOS_15_16_INTERRUPTION_START="ios15_16-interruption-start",t.IOS_15_16_INTERRUPTION_END="ios15_16-interruption-end",t.IOS_INTERRUPTION_START="ios-interruption-start",t.IOS_INTERRUPTION_END="ios-interruption-end",t.STATE_CHANGE="state-change",t}({});function Va(t,e,i){return{sampleRate:t,stereo:e,bitrate:i}}function Ut(t,e,i,n,r){return{width:t,height:e,frameRate:i,bitrateMin:n,bitrateMax:r}}function kn(t,e,i,n,r){return{width:{max:t},height:{max:e},frameRate:i,bitrateMin:n,bitrateMax:r}}function xf(t,e){return{numSpatialLayers:t,numTemporalLayers:e}}let wK={"90p":Ut(160,90),"90p_1":Ut(160,90),"120p":Ut(160,120,15,30,65),"120p_1":Ut(160,120,15,30,65),"120p_3":Ut(120,120,15,30,50),"120p_4":Ut(212,120),"180p":Ut(320,180,15,30,140),"180p_1":Ut(320,180,15,30,140),"180p_3":Ut(180,180,15,30,100),"180p_4":Ut(240,180,15,30,120),"240p":Ut(320,240,15,40,200),"240p_1":Ut(320,240,15,40,200),"240p_3":Ut(240,240,15,40,140),"240p_4":Ut(424,240,15,40,220),"360p":Ut(640,360,15,80,400),"360p_1":Ut(640,360,15,80,400),"360p_3":Ut(360,360,15,80,260),"360p_4":Ut(640,360,30,80,600),"360p_6":Ut(360,360,30,80,400),"360p_7":Ut(480,360,15,80,320),"360p_8":Ut(480,360,30,80,490),"360p_9":Ut(640,360,15,80,800),"360p_10":Ut(640,360,24,80,800),"360p_11":Ut(640,360,24,80,1e3),"480p":Ut(640,480,15,100,500),"480p_1":Ut(640,480,15,100,500),"480p_2":Ut(640,480,30,100,1e3),"480p_3":Ut(480,480,15,100,400),"480p_4":Ut(640,480,30,100,750),"480p_6":Ut(480,480,30,100,600),"480p_8":Ut(848,480,15,100,610),"480p_9":Ut(848,480,30,100,930),"480p_10":Ut(640,480,10,100,400),"720p":Ut(1280,720,15,120,1130),"720p_auto":Ut(1280,720,30,900,3e3),"720p_1":Ut(1280,720,15,120,1130),"720p_2":Ut(1280,720,30,120,2e3),"720p_3":Ut(1280,720,30,120,1710),"720p_5":Ut(960,720,15,120,910),"720p_6":Ut(960,720,30,120,1380),"1080p":Ut(1920,1080,15,120,2080),"1080p_1":Ut(1920,1080,15,120,2080),"1080p_2":Ut(1920,1080,30,120,3e3),"1080p_3":Ut(1920,1080,30,120,3150),"1080p_5":Ut(1920,1080,60,120,4780),"1440p":Ut(2560,1440,30,120,4850),"1440p_1":Ut(2560,1440,30,120,4850),"1440p_2":Ut(2560,1440,60,120,7350),"4k":Ut(3840,2160,30,120,8910),"4k_1":Ut(3840,2160,30,120,8910),"4k_3":Ut(3840,2160,60,120,13500)},OK={"480p":kn(640,480,5),"480p_1":kn(640,480,5),"480p_2":kn(640,480,30),"480p_3":kn(640,480,15),"720p":kn(1280,720,5),"720p_auto":Ut(1280,720,30,900,3e3),"720p_1":kn(1280,720,5),"720p_2":kn(1280,720,30),"720p_3":kn(1280,720,15),"1080p":kn(1920,1080,5),"1080p_1":kn(1920,1080,5),"1080p_2":kn(1920,1080,30),"1080p_3":kn(1920,1080,15)},NK={"1SL1TL":xf(1,1),"3SL3TL":xf(3,3),"2SL3TL":xf(2,3)};function Mn(t){return t||(t="480p_1"),typeof t=="string"?Object.assign({},wK[t]):t}function Vf(t){return typeof t=="string"?Object.assign({},OK[t]):t}function Ch(t){return typeof t=="string"?Object.assign({},NK[t]):t}let DK={speech_low_quality:Va(16e3,!1),speech_standard:Va(32e3,!1,18),music_standard:Va(48e3,!1),standard_stereo:Va(48e3,!0,56),high_quality:Va(48e3,!1,128),high_quality_stereo:Va(48e3,!0,192)};function bh(t){return typeof t=="string"?Object.assign({},DK[t]):t}let Fa=[];function hw(t){return xe(t,"mediaSource",["screen","window","application"]),!0}let nt=function(t){return t.NEED_RENEGOTIATE="@need_renegotiate",t.NEED_REPLACE_TRACK="@need_replace_track",t.NEED_REPLACE_MIXING_TRACK="@need_replace_mixing_track",t.NEED_CLOSE="@need_close",t.NEED_ENABLE_TRACK="@need_enable_track",t.NEED_DISABLE_TRACK="@need_disable_track",t.NEED_SESSION_ID="@need_sid",t.SET_OPTIMIZATION_MODE="@set_optimization_mode",t.GET_STATS="@get_stats",t.GET_RTC_STATS="@get_rtc_stats",t.GET_LOW_VIDEO_TRACK="@get_low_video_track",t.NEED_RESET_REMOTE_SDP="@need_reset_remote_sdp",t.NEED_UPDATE_VIDEO_ENCODER="@need_update_video_encoder",t.NEED_UPDATE_VIDEO_SEND_PARAMETERS="@need_update_video_send_parameters",t.NEED_MUTE_TRACK="@need_mute_track",t.NEED_UNMUTE_TRACK="@need_unmute_track",t}({}),Jt=function(t){return t.SCREEN_TRACK="screen_track",t.CUSTOM_TRACK="custome_track",t.LOW_STREAM="low_stream",t.SCREEN_LOW_TRACK="screen_low_track",t}({}),Ba=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t}({}),PK=function(t){return t[t.HIGH_STREAM=0]="HIGH_STREAM",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.HIGH_STREAM_LAYER1=4]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=5]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=6]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=7]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=8]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=9]="HIGH_STREAM_LAYER6",t}({}),LK=function(t){return t[t.DISABLE=0]="DISABLE",t[t.LOW_STREAM=1]="LOW_STREAM",t[t.AUDIO_ONLY=2]="AUDIO_ONLY",t[t.HIGH_STREAM_LAYER1=3]="HIGH_STREAM_LAYER1",t[t.HIGH_STREAM_LAYER2=4]="HIGH_STREAM_LAYER2",t[t.HIGH_STREAM_LAYER3=5]="HIGH_STREAM_LAYER3",t[t.HIGH_STREAM_LAYER4=6]="HIGH_STREAM_LAYER4",t[t.HIGH_STREAM_LAYER5=7]="HIGH_STREAM_LAYER5",t[t.HIGH_STREAM_LAYER6=8]="HIGH_STREAM_LAYER6",t}({}),ys=function(t){return t.TRANSCEIVER_UPDATED="transceiver-updated",t.SEI_TO_SEND="sei-to-send",t.SEI_RECEIVED="sei-received",t.TRACK_UPDATED="track-updated",t}({}),ja=function(t){return t.SOURCE_STATE_CHANGE="source-state-change",t.TRACK_ENDED="track-ended",t.BEAUTY_EFFECT_OVERLOAD="beauty-effect-overload",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.CLOSED="closed",t}({}),Ga=function(t){return t.FIRST_FRAME_DECODED="first-frame-decoded",t.VIDEO_ELEMENT_VISIBLE_STATUS="video-element-visible-status",t.VIDEO_STATE_CHANGED="video-state-changed",t}({}),Wa=function(t){return t.AUDIO="audio",t.VIDEO="video",t.DATA="data",t}({}),$i=function(t){return t.AUDIO_SOURCE_STATE_CHANGE="audio_source_state_change",t.RECEIVE_TRACK_BUFFER="receive_track_buffer",t.ON_AUDIO_BUFFER="on_audio_buffer",t.UPDATE_SOURCE="update_source",t}({});(function(t){t.UPDATE_TRACK_SOURCE="update-track-source"})({});let Ff={sendVolumeLevel:0,sendBitrate:0,sendBytes:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,currentPacketLossRate:0},Bf={sendBytes:0,sendBitrate:0,sendPackets:0,sendPacketsLost:0,sendJitterMs:0,sendRttMs:0,sendResolutionHeight:0,sendResolutionWidth:0,captureResolutionHeight:0,captureResolutionWidth:0,targetSendBitrate:0,totalDuration:0,totalFreezeTime:0,currentPacketLossRate:0},pw={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveLevel:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receivePacketsDiscarded:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},kK={uplinkNetworkQuality:0,downlinkNetworkQuality:0},_w={transportDelay:0,end2EndDelay:0,receiveBitrate:0,receiveBytes:0,receiveDelay:0,receivePackets:0,receivePacketsLost:0,receiveResolutionHeight:0,receiveResolutionWidth:0,totalDuration:0,totalFreezeTime:0,freezeRate:0,packetLossRate:0,currentPacketLossRate:0,publishDuration:-1},gi=function(t){return t.ON_TRACK="on_track",t.ON_NODE="on_node",t}({}),tn=function(t){return t.REQUEST_UPDATE_CONSTRAINTS="request_update_constraints",t.REQUEST_CONSTRAINTS="request_constraints",t}({}),Cd=function(t){return t.IDLE="IDLE",t.INITING="INITING",t.INITEND="INITEND",t}({}),Cs=function(t){return t.STATE_CHANGE="state_change",t.RECORDING_DEVICE_CHANGED="recordingDeviceChanged",t.PLAYOUT_DEVICE_CHANGED="playoutDeviceChanged",t.CAMERA_DEVICE_CHANGED="cameraDeviceChanged",t}({}),di=function(t){return t.NONE="none",t.INIT="init",t.CANPLAY="canplay",t.PLAYING="playing",t.PAUSED="paused",t.SUSPEND="suspend",t.STALLED="stalled",t.WAITING="waiting",t.ERROR="error",t.DESTROYED="destroyed",t.ABORT="abort",t.ENDED="ended",t.EMPTIED="emptied",t.LOADEDDATA="loadeddata",t}({}),Cr=function(t){return t[t.VideoStateStopped=0]="VideoStateStopped",t[t.VideoStateStarting=1]="VideoStateStarting",t[t.VideoStateDecoding=2]="VideoStateDecoding",t[t.VideoStateFrozen=3]="VideoStateFrozen",t}({}),jf={uninit:100,none:110,init:120,loadeddata:130,canplay:200,playing:210,paused:220,suspend:300,stalled:310,waiting:320,error:330,destroyed:340,abort:350,ended:360,emptied:370},Ih=function(t){return t.OPEN="open",t.MESSAGE="message",t.CLOSE="close",t.CLOSING="closing",t.ERROR="error",t}({});function Nt(t,e,i,n,r){var o,s,a={};return Object.keys(n).forEach(function(c){a[c]=n[c]}),a.enumerable=!!a.enumerable,a.configurable=!!a.configurable,("value"in a||a.initializer)&&(a.writable=!0),a=bn(o=tR(s=i.slice()).call(s)).call(o,function(c,d){return d(t,e,c)||c},a),r&&a.initializer!==void 0&&(a.value=a.initializer?a.initializer.call(r):void 0,a.initializer=void 0),a.initializer===void 0?(Object.defineProperty(t,e,a),null):a}function U(t,e,i){return(e=function(n){var r=function(o,s){if(typeof o!="object"||!o)return o;var a=o[Symbol.toPrimitive];if(a!==void 0){var c=a.call(o,"string");if(typeof c!="object")return c;throw new TypeError("@@toPrimitive must return a primitive value.")}return String(o)}(n);return typeof r=="symbol"?r:r+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function mw(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function de(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?mw(Object(i),!0).forEach(function(n){U(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):mw(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class Ew extends ue{set _mediaStreamTrack(e){e!==this.mediaStreamTrack&&(this.safeEmit(ys.TRACK_UPDATED,e),this.mediaStreamTrack=e)}get _mediaStreamTrack(){return this.mediaStreamTrack}constructor(e,i){super(),U(this,"trackMediaType",void 0),U(this,"_ID",void 0),U(this,"_rtpTransceiver",void 0),U(this,"_lowRtpTransceiver",void 0),U(this,"_hints",[]),U(this,"_isClosed",!1),U(this,"_originMediaStreamTrack",void 0),U(this,"mediaStreamTrack",void 0),U(this,"_external",{}),this._ID=i||te(8,"track-"),this._originMediaStreamTrack=e,this.mediaStreamTrack=e,function(n){z(Fa).call(Fa,n)||Fa.push(n)}(this)}toString(){return this._ID}getTrackId(){return this._ID}getMediaStreamTrack(e){return e||Mo(()=>{var i;ot.reportApiInvoke(null,{name:be.GET_MEDIA_STREAM_TRACK,options:[],tag:Ee.TRACER}).onSuccess(((i=this._mediaStreamTrack)===null||i===void 0?void 0:i.label)||"")},this.mediaStreamTrack.id||this.getTrackId()),this._mediaStreamTrack}getRTCRtpTransceiver(e){return e===Ba.LOW_STREAM?this._lowRtpTransceiver:this._rtpTransceiver}getMediaStreamTrackSettings(){return this.getMediaStreamTrack(!0).getSettings()}close(){this._isClosed=!0,this._lowRtpTransceiver=void 0,this._rtpTransceiver=void 0,function(e){let i=Fa.indexOf(e);i!==-1&&Fa.splice(i,1)}(this),this.emit(ja.CLOSED),this.removeAllListeners(ys.SEI_RECEIVED)}_updateRtpTransceiver(e,i){if(i===Ba.LOW_STREAM){if(this._lowRtpTransceiver===e)return;this._lowRtpTransceiver=e}else{if(this._rtpTransceiver===e)return;this._rtpTransceiver=e}this.emit(ys.TRANSCEIVER_UPDATED,e,i)}}class Ha extends Ew{get isExternalTrack(){return this._isExternalTrack}get muted(){return this._muted}get enabled(){return this._enabled}get processorContext(){return this._processorContext}constructor(e,i){super(e,i),U(this,"_enabled",!0),U(this,"_muted",!1),U(this,"_isExternalTrack",!1),U(this,"_isClosed",!1),U(this,"_enabledMutex",void 0),U(this,"processor",void 0),U(this,"_processorContext",void 0),U(this,"_handleTrackEnded",()=>{this.onTrackEnded()}),this._enabledMutex=new ni("".concat(this.getTrackId())),e.addEventListener("ended",this._handleTrackEnded)}getTrackLabel(){var e,i;return(e=(i=this._originMediaStreamTrack)===null||i===void 0?void 0:i.label)!==null&&e!==void 0?e:""}close(){this._isClosed||(this.stop(),this._originMediaStreamTrack.stop(),this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack.stop(),this._mediaStreamTrack=null),this._originMediaStreamTrack=null,this._enabledMutex=null,_.debug("[".concat(this.getTrackId(),"] close")),this.emit(nt.NEED_CLOSE),super.close())}_updateOriginMediaStreamTrack(n,r){return I(this,arguments,function*(e,i){let o=arguments.length>2&&arguments[2]!==void 0&&arguments[2];this._isExternalTrack=o,e!==this._originMediaStreamTrack&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),i&&this._originMediaStreamTrack.stop()),e.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=e,this._muted&&(this._originMediaStreamTrack.enabled=!1),this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),yield Zt(this,nt.NEED_REPLACE_TRACK,this),this.processor&&this._processorContext&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this._processorContext}))})}_getDefaultPlayerConfig(){return{}}onTrackEnded(){_.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ja.TRACK_ENDED)}stateCheck(e,i){if(_.debug("check track state, [muted: ".concat(this._muted,", enabled: ").concat(this._enabled,"] to [").concat(e,": ").concat(i,"]")),Zr(i,e),this._enabled&&this._muted&&e==="enabled"&&i===!1)throw new F(C.TRACK_STATE_UNREACHABLE,"cannot set enabled while the track is muted").print("error",_);if(!this._enabled&&!this._muted&&e==="muted"&&i===!0)throw new F(C.TRACK_STATE_UNREACHABLE,"cannot set muted while the track is disabled").print("error",_)}getProcessorStats(){return this._processorContext&&this._processorContext.gatherStats()||[]}getProcessorUsage(){return this._processorContext?this._processorContext.gatherUsage():Q.resolve([])}}let fw=window.AudioContext||window.webkitAudioContext,en=null,Yt=new class extends ue{constructor(){super(...arguments),U(this,"prevState",void 0),U(this,"curState",void 0),U(this,"currentTime",void 0),U(this,"currentTimeStuckAt",void 0),U(this,"interruptDetectorTrack",void 0),U(this,"onLocalAudioTrackMute",()=>{_.info("ios15-interruption-start"),this.emit(ze.IOS_15_16_INTERRUPTION_START)}),U(this,"onLocalAudioTrackUnmute",()=>I(this,null,function*(){_.info("ios15-interruption-end"),this.curState!=="running"||this.duringInterruption?_.info("ios15-interruption-end-canceled"):(en&&(yield en.suspend()),this.emit(ze.IOS_15_16_INTERRUPTION_END))}))}get duringInterruption(){return this.prevState==="running"&&this.curState==="interrupted"}bindInterruptDetectorTrack(t){_.debug("webaudio bindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack||(this.interruptDetectorTrack=t,this.interruptDetectorTrack._mediaStreamTrack.onmute=this.onLocalAudioTrackMute,this.interruptDetectorTrack._mediaStreamTrack.onunmute=this.onLocalAudioTrackUnmute)}unbindInterruptDetectorTrack(t){_.debug("webaudio unbindInterruptDetectorTrack ".concat(t.getTrackId())),this.interruptDetectorTrack&&this.interruptDetectorTrack===t&&(this.interruptDetectorTrack._mediaStreamTrack&&(this.interruptDetectorTrack._mediaStreamTrack.onmute=null,this.interruptDetectorTrack._mediaStreamTrack.onunmute=null),this.interruptDetectorTrack=void 0)}};function Ka(){if(!en){if(function(){if(!fw)return void _.error("your browser is not support web audio");_.info("create audio context");let t=de({},A("WEBAUDIO_INIT_OPTIONS"));_.debug("audio context init option:",JSON.stringify(t)),en=new fw(t),Yt.curState=en.state,en.onstatechange=()=>{Yt.prevState=Yt.curState,Yt.curState=en?en.state:void 0;let{prevState:e,curState:i}=Yt,n=i==="running",r=i==="interrupted",o=e==="running",s=e==="suspended",a=e==="interrupted",c=kt().osVersion;(fi()||Pn())&&o&&r&&(_.info("ios".concat(c,"-interruption-start")),Yt.emit(ze.IOS_INTERRUPTION_START)),(fi()||Pn())&&(s||a)&&n&&(_.info("ios".concat(c,"-interruption-end")),Yt.emit(ze.IOS_INTERRUPTION_END)),e!==i&&Yt.emit(ze.STATE_CHANGE,i,e)},setInterval(()=>{var e;let i=(e=en)===null||e===void 0?void 0:e.currentTime;Yt.currentTime!==i?(Yt.currentTimeStuckAt&&(_.debug("AudioContext current time resume at ".concat(i)),Yt.currentTimeStuckAt=void 0),Yt.currentTime=i):(i!==Yt.currentTimeStuckAt&&(ot.reportApiInvoke(null,{name:"WEB_AUDIO_CURRENT_TIME_STUCK",options:{currentTime:i},tag:Ee.TRACER}).onSuccess(),_.warning("AudioContext current time stuck at ".concat(i))),Yt.currentTimeStuckAt=i)},5e3),function(e){return I(this,null,function*(){let i=["click","contextmenu","auxclick","dblclick","mousedown","mouseup","touchend","keydown","keyup"],n,r=!1,o=!1,s=!1;function a(E){e.state==="running"?c(!1):fi()||Pn()?e.state==="suspended"&&(c(!0),E&&e.resume().then(d,d)):e.state!=="closed"&&(c(!0),E&&e.resume().then(d,d))}function c(E){if(r!==E){r=E;for(let f=0,R=i;f<R.length;f+=1){let y=R[f];E?window.addEventListener(y,l,{capture:!0,passive:!0}):window.removeEventListener(y,l,{capture:!0,passive:!0})}}}function d(){a(!1)}function l(){a(!0)}function u(E){if(!s)if(n.paused)if(E){let f;h(!1),s=!0;try{f=n.play(),f?f.then(p,p):(n.addEventListener("playing",p),n.addEventListener("abort",p),n.addEventListener("error",p))}catch{p()}}else h(!0);else h(!1)}function h(E){if(o!==E){o=E;for(let f=0,R=i;f<R.length;f++){let y=R[f];E?window.addEventListener(y,g,{capture:!0,passive:!0}):window.removeEventListener(y,g,{capture:!0,passive:!0})}}}function p(){n.removeEventListener("playing",p),n.removeEventListener("abort",p),n.removeEventListener("error",p),s=!1,u(!1)}function g(){u(!0)}if(fi()){let E=e.createMediaStreamDestination(),f=document.createElement("div");f.innerHTML="<audio x-webkit-airplay='deny'></audio>",n=f.children.item(0),n.controls=!1,n.disableRemotePlayback=!0,n.preload="auto",n.srcObject=E.stream,u(!0)}Yt.on(ze.STATE_CHANGE,function(){a(!0)}),a(!1)})}(en)}(),!en)throw new F(C.NOT_SUPPORTED,"can not create audio context");return en}return en}function bs(t){if(function(){if(Gf!==null)return Gf;let n=Ka(),r=n.createBufferSource(),o=n.createGain(),s=n.createGain();r.connect(o),r.connect(s),r.disconnect(o);let a=!1;try{r.disconnect(o)}catch{a=!0}return r.disconnect(),Gf=a,a}())return;let e=t.connect,i=t.disconnect;t.connect=(n,r,o)=>{var s;return t._inputNodes||(t._inputNodes=[]),z(s=t._inputNodes).call(s,n)||(n instanceof AudioNode?(t._inputNodes.push(n),e.call(t,n,r,o)):e.call(t,n,r)),t},t.disconnect=(n,r,o)=>{i.call(t),n?mh(t._inputNodes,n):t._inputNodes=[];for(let s of t._inputNodes)e.call(t,s)}}let Gf=null;function Wf(t,e){let i=!1,n=1/e;if(A("DISABLE_WEBAUDIO")){let r=window.setInterval(()=>{i?window.clearInterval(r):t(performance.now()/1e3)},1e3*n)}else{let r=Ka(),o=r.createGain();o.gain.value=0,o.connect(r.destination);let s=()=>{if(i)return void(o=null);let a=r.createOscillator();a.onended=s,a.connect(o),a.start(0),a.stop(r.currentTime+n),t(r.currentTime)};s()}return()=>{i=!0}}class gw{constructor(){U(this,"context",void 0),U(this,"analyserNode",void 0),U(this,"sourceNode",void 0),this.context=Ka(),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4}updateSource(e){if(e!==this.sourceNode){if(this.sourceNode)try{this.sourceNode.disconnect(this.analyserNode)}catch{}this.sourceNode=e,e?.connect(this.analyserNode)}}getVolumeLevel(){if(!this.sourceNode||(!this.context||fi()||Pn()||this.context.state!=="running"&&this.context.resume(),!this.analyserNode))return 0;let e=new Float32Array(this.analyserNode.fftSize);if(this.analyserNode.getFloatTimeDomainData)this.analyserNode.getFloatTimeDomainData(e);else{let n=new Uint8Array(this.analyserNode.fftSize);this.analyserNode.getByteTimeDomainData(n);for(let r=0;r<e.length;++r)e[r]=n[r]/128-1}let i=bn(e).call(e,(n,r)=>n+r*r,0)/e.length;return Math.max(10*Math.log10(i)+100,0)/100}getAnalyserNode(){return this.analyserNode}rebuildAnalyser(){try{var e,i;(e=this.sourceNode)===null||e===void 0||e.disconnect(this.analyserNode),this.analyserNode=this.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNode.smoothingTimeConstant=.4,(i=this.sourceNode)===null||i===void 0||i.connect(this.analyserNode)}catch{_.warning("rebuild analyser node failed.")}}destroy(){this.updateSource(void 0)}}class Sw extends ue{get processSourceNode(){return this.sourceNode}set processedNode(e){var i;if(!this.isDestroyed&&this._processedNode!==e){try{var n;(n=this.sourceNode)===null||n===void 0||n.disconnect(this.outputNode)}catch{}(i=this._processedNode)===null||i===void 0||i.disconnect(),this._processedNode=e,this.connect()}}get processedNode(){return this._processedNode}constructor(){super(),U(this,"outputNode",void 0),U(this,"outputTrack",void 0),U(this,"isPlayed",!1),U(this,"sourceNode",void 0),U(this,"context",void 0),U(this,"audioBufferNode",void 0),U(this,"destNode",void 0),U(this,"audioOutputLevel",0),U(this,"volumeLevelAnalyser",void 0),U(this,"_processedNode",void 0),U(this,"playNode",void 0),U(this,"isDestroyed",!1),U(this,"onNoAudioInput",void 0),U(this,"isNoAudioInput",!1),U(this,"_noAudioInputCount",0),this.context=Ka(),this.playNode=this.context.destination,this.outputNode=this.context.createGain(),bs(this.outputNode),this.volumeLevelAnalyser=new gw}startGetAudioBuffer(e){this.audioBufferNode||(this.audioBufferNode=this.context.createScriptProcessor(e),this.outputNode.connect(this.audioBufferNode),this.audioBufferNode.connect(this.context.destination),this.audioBufferNode.onaudioprocess=i=>{this.emit($i.ON_AUDIO_BUFFER,function(n){for(let r=0;r<n.outputBuffer.numberOfChannels;r+=1){let o=n.outputBuffer.getChannelData(r);for(let s=0;s<o.length;s+=1)o[s]=0}return n.inputBuffer}(i))})}stopGetAudioBuffer(){this.audioBufferNode&&(this.audioBufferNode.onaudioprocess=null,this.outputNode.disconnect(this.audioBufferNode),this.audioBufferNode=void 0)}createOutputTrack(){if(!Mt().webAudioMediaStreamDest)throw new F(C.NOT_SUPPORTED,"your browser is not support audio processor");return this.destNode&&this.outputTrack||(this.destNode=this.context.createMediaStreamDestination(),this.outputNode.connect(this.destNode),this.outputTrack=this.destNode.stream.getAudioTracks()[0]),this.outputTrack}play(e){this.context.state!=="running"&&Eh(()=>{Yt.emit("autoplay-failed")}),this.isPlayed=!0,this.playNode=e||this.context.destination,this.outputNode.connect(this.playNode)}stop(){if(this.isPlayed)try{this.outputNode.disconnect(this.playNode)}catch{}this.isPlayed=!1}getAccurateVolumeLevel(){return this.volumeLevelAnalyser.getVolumeLevel()}checkHasAudioInput(){return I(this,arguments,function*(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:0;if(e>5)return this.isNoAudioInput=!0,this.onNoAudioInput&&this.onNoAudioInput(),!1;fi()||Pn()?this.context.state==="suspended"&&this.context.resume():this.context.state!=="running"&&this.context.resume();let i=this.volumeLevelAnalyser.getAnalyserNode(),n;i.getFloatTimeDomainData?(n=new Float32Array(i.fftSize),i.getFloatTimeDomainData(n)):(n=new Uint8Array(i.fftSize),i.getByteTimeDomainData(n));let r=!1;for(let o=0;o<n.length;o++)n[o]!==0&&(r=!0);return r?(this.isNoAudioInput=!1,!0):(yield qe(200),(yield this.checkHasAudioInput(e?e+1:1))&&r)})}getAudioVolume(){return this.outputNode.gain.value}setVolume(e){this.outputNode.gain.setValueAtTime(e,this.context.currentTime)}destroy(){this.disconnect(),this.stop(),this.isDestroyed=!0,this.onNoAudioInput=void 0}disconnect(){var e,i;(e=this.processedNode)===null||e===void 0||e.disconnect(),(i=this.sourceNode)===null||i===void 0||i.disconnect(),this.outputNode&&this.outputNode.disconnect()}connect(){var e;this.processedNode?(e=this.processedNode)===null||e===void 0||e.connect(this.outputNode):this.sourceNode&&this.sourceNode.connect(this.outputNode),this.volumeLevelAnalyser.updateSource(this.outputNode)}}class Tw extends Sw{get isFreeze(){return!1}constructor(e,i,n){var r;if(super(),U(this,"sourceNode",void 0),U(this,"track",void 0),U(this,"clonedTrack",void 0),U(this,"audioElement",void 0),U(this,"isCurrentTrackCloned",!1),U(this,"isRemoteTrack",!1),U(this,"originVolumeLevelAnalyser",void 0),U(this,"rebuildWebAudio",()=>I(this,null,function*(){if(_.debug("ready to rebuild web audio, state:",this.context.state),this.isNoAudioInput&&(yield this.checkHasAudioInput()),!this.isNoAudioInput||this.isDestroyed)return document.body.removeEventListener("click",this.rebuildWebAudio,!0),void _.debug("rebuild web audio success, current volume status",this.getAccurateVolumeLevel());this.context.resume().then(()=>_.info("resume success")),_.debug("rebuild web audio because of ios 12 bugs"),this.disconnect();let a=this.track;this.track=this.track.clone(),this.isCurrentTrackCloned?a.stop():this.isCurrentTrackCloned=!0;let c=new MediaStream([this.track]);this.sourceNode=this.context.createMediaStreamSource(c),bs(this.sourceNode),this.volumeLevelAnalyser.rebuildAnalyser();let d=this.outputNode.gain.value;this.outputNode=this.context.createGain(),this.outputNode.gain.setValueAtTime(d,this.context.currentTime),bs(this.outputNode),this.emit($i.UPDATE_SOURCE),this.connect(),this.audioElement.srcObject=c,this.isPlayed&&this.play(this.playNode),this.checkHasAudioInput()})),e.kind!=="audio")throw new F(C.UNEXPECTED_ERROR);this.track=e;let o=new MediaStream([this.track]);if(this.isRemoteTrack=!!i,this.sourceNode=this.context.createMediaStreamSource(o),bs(this.sourceNode),n){let a=n.clone();a.enabled=!0,this.clonedTrack=a,_.debug("create an unmuted track ".concat(a.id," from the original track ").concat(n.id," to get the volume"));let c=this.context.createMediaStreamSource(new MediaStream([a]));bs(c),this.originVolumeLevelAnalyser=new gw,this.originVolumeLevelAnalyser.updateSource(c)}this.connect(),this.audioElement=document.createElement("audio"),this.audioElement.srcObject=o;let s=kt();i&&s.os===Ve.IOS&&Number((r=s.osVersion)===null||r===void 0?void 0:r.split(".")[0])<15&&(Yt.on(ze.STATE_CHANGE,()=>{this.context.state==="suspended"?document.body.addEventListener("click",this.rebuildWebAudio,!0):this.context.state==="running"&&this.rebuildWebAudio()}),this.checkHasAudioInput().then(a=>{a||document.body.addEventListener("click",this.rebuildWebAudio,!0)}))}updateTrack(e){this.sourceNode.disconnect(),this.track=e,this.isCurrentTrackCloned=!1;let i=new MediaStream([e]);this.sourceNode=this.context.createMediaStreamSource(i),bs(this.sourceNode),this.processedNode||this.sourceNode.connect(this.outputNode),this.emit($i.UPDATE_SOURCE),this.audioElement.srcObject=i}destroy(){var e;this.audioElement.srcObject=null,this.audioElement.remove(),Yt.off("state-change",this.rebuildWebAudio),(e=this.originVolumeLevelAnalyser)===null||e===void 0||e.destroy(),this.clonedTrack=void 0,super.destroy()}createMediaStreamSourceNode(e){return this.context.createMediaStreamSource(new MediaStream([e]))}updateOriginTrack(e){let i=e.clone();i.enabled=!0,this.clonedTrack&&(this.clonedTrack.stop(),this.clonedTrack=i),_.debug("create an unmuted track ".concat(i.id," from the original track ").concat(e.id," to get the volume"));let n=this.context.createMediaStreamSource(new MediaStream([i]));bs(n),this.originVolumeLevelAnalyser&&this.originVolumeLevelAnalyser.updateSource(n)}getOriginVolumeLevel(){return this.originVolumeLevelAnalyser?this.originVolumeLevelAnalyser.getVolumeLevel():this.getAccurateVolumeLevel()}}function Rw(t,e,i){return I(this,null,function*(){let n=(o,s)=>o?typeof o!="number"?o.max||o.exact||o.ideal||o.min||s:o:s,r={audio:!!i&&{mandatory:{chromeMediaSource:"desktop"}},video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:t,maxHeight:n(e.height,1080),maxWidth:n(e.width,1920)}}};return e.frameRate&&typeof e.frameRate!="number"?(r.video.mandatory.maxFrameRate=e.frameRate.max,r.video.mandatory.minFrameRate=e.frameRate.min):typeof e.frameRate=="number"&&(r.video.mandatory.maxFrameRate=e.frameRate),yield navigator.mediaDevices.getUserMedia(r)})}function MK(t,e){return I(this,null,function*(){let i=yield vw(t.mediaSource),{sourceId:n,audio:r}=yield function(o){let s=arguments.length>1&&arguments[1]!==void 0&&arguments[1];return new Q((a,c)=>{let d=document.createElement("div");d.innerText="share screen",d.setAttribute("style","text-align: center; height: 25px; line-height: 25px; border-radius: 4px 4px 0 0; background: #D4D2D4; border-bottom:  solid 1px #B9B8B9;");let l=document.createElement("div");l.setAttribute("style","width: 100%; height: 500px; padding: 15px 25px ; box-sizing: border-box;");let u=document.createElement("div");u.innerText="Agora Web Screensharing wants to share the contents of your screen with webdemo.agorabeckon.com. Choose what you'd like to share.",u.setAttribute("style","height: 12%;");let h=document.createElement("div");h.setAttribute("style","width: 100%; height: 80%; background: #FFF; border:  solid 1px #CBCBCB; display: flex; flex-wrap: wrap; justify-content: space-around; overflow-y: scroll; padding: 0 15px; box-sizing: border-box;");let p=document.createElement("div");p.setAttribute("style","display: flex; justify-content: space-between; padding: 16px 0;");let g=document.createElement("button");g.innerHTML="cancel",g.setAttribute("style","width: 85px;"),g.onclick=()=>{document.body.removeChild(R);let y=new Error("NotAllowedError");y.name="NotAllowedError",c(y)};let E=s,f=document.createElement("div");if(s){let y=document.createElement("input");y.setAttribute("type","checkbox");let N=document.createElement("span");y.setAttribute("style","margin-right: 6px;"),N.innerText="Share audio",y.checked=E,y.onchange=()=>{E=y.checked},f.appendChild(y),f.appendChild(N)}p.appendChild(f),p.appendChild(g),l.appendChild(u),l.appendChild(h),l.appendChild(p);let R=document.createElement("div");R.setAttribute("style","position: fixed; z-index: 99999999; top: 50%; left: 50%; width: 620px; height: 525px; background: #ECECEC; border-radius: 4px; -webkit-transform: translate(-50%,-50%); transform: translate(-50%,-50%);"),R.appendChild(d),R.appendChild(l),document.body.appendChild(R),o.map(y=>{if(y.id){let N=document.createElement("div");N.setAttribute("style","width: 30%; height: 160px; padding: 20px 0; text-align: center;box-sizing: content-box;");let k=y.thumbnail;try{let{width:L}=k.getSize();L>1920&&(k=k.resize({width:1920}))}catch(L){throw L&&L.message.startsWith("Illegal invocation")&&console.error("Operate thumbnail error, please try to set contextIsolation: false. (https://github.com/electron/electron/issues/34953)"),L}N.innerHTML='<div style="height: 120px; display: table-cell; vertical-align: middle;"><img style="width: 100%; background: #333333; box-shadow: 1px 1px 1px 1px rgba(0, 0, 0, 0.2);" src='+k.toDataURL()+' /></div><span style="	height: 40px; line-height: 40px; display: inline-block; width: 70%; word-break: keep-all; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">'+y.name.replace(/[\u00A0-\u9999<>\&]/g,function(L){return"&#"+L.charCodeAt(0)+";"})+"</span>",N.onclick=()=>{document.body.removeChild(R),a({sourceId:y.id,audio:E})},h.appendChild(N)}})})}(i,e);return yield Rw(n,t,r)})}function vw(t){return I(this,null,function*(){let e=["window","screen"];t!=="application"&&t!=="window"||(e=["window"]),t==="screen"&&(e=["screen"]);let i=kA();if(!i)throw console.error("failed to fetch electron, please mount it to window"),new F(C.ELECTRON_IS_NULL);let n=null;try{var r;n=((r=i.desktopCapturer)===null||r===void 0?void 0:r.getSources({types:e}))||i.ipcRenderer.invoke("DESKTOP_CAPTURER_GET_SOURCES",{types:e})}catch{n=null}n&&n.then||(n=new Q((o,s)=>{i.desktopCapturer.getSources({types:e},(a,c)=>{a?s(a):o(c)})}));try{return yield n}catch(o){throw new F(C.ELECTRON_DESKTOP_CAPTURER_GET_SOURCES_ERROR,o.toString())}})}let Hf=new ni("safari"),yw=!1,Cw=!1;function nn(t,e){return I(this,null,function*(){let i=0,n=null;for(;i<2;)try{n=yield UK(t,e,i>0);break}catch(r){if(r instanceof F)throw _.error("[".concat(e,"] ").concat(r.toString())),r;let o=Ah(r.name||r.code||r,r.message);if(o.code===C.MEDIA_OPTION_INVALID){_.debug("[".concat(e,"] detect media option invalid, retry")),i+=1,yield qe(500);continue}throw _.error("[".concat(e,"] ").concat(o.toString())),o}if(!n)throw new F(C.UNEXPECTED_ERROR,"can not find stream after getUserMedia");return n})}function UK(t,e,i){return I(this,null,function*(){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new F(C.NOT_SUPPORTED,"can not find getUserMedia");i&&(t.video&&(delete t.video.width,delete t.video.height),t.screen&&(delete t.screen.width,delete t.screen.height));let n=Mt(),r=new MediaStream;if(t.audioSource&&r.addTrack(t.audioSource),t.videoSource&&r.addTrack(t.videoSource),!t.audio&&!t.video&&!t.screen)return _.debug("Using Video Source/ Audio Source"),r;if(t.screen)if(kA())t.screen.sourceId?qa(r,yield Rw(t.screen.sourceId,t.screen,!!t.screenAudio)):qa(r,yield MK(t.screen,!!t.screenAudio));else if(Jr()&&t.screen.extensionId&&t.screen.mandatory){if(!n.getStreamFromExtension)throw new F(C.NOT_SUPPORTED,"This browser does not support screen sharing");_.debug("[".concat(e,'] Screen access on chrome stable, looking for extension"'));let h=yield(s=t.screen.extensionId,a=e,new Q((p,g)=>{try{chrome.runtime.sendMessage(s,{getStream:!0},E=>{if(!E||!E.streamId)return _.error("[".concat(a,"] No response from Chrome Plugin. Plugin not installed properly"),E),void g(new F(C.CHROME_PLUGIN_NO_RESPONSE,"No response from Chrome Plugin. Plugin not installed properly"));p(E.streamId)})}catch(E){_.error("[".concat(a,"] AgoraRTC screensharing plugin is not accessible(").concat(s,")"),E.toString()),g(new F(C.CHROME_PLUGIN_NOT_INSTALL))}}));t.screen.mandatory.chromeMediaSourceId=h,qa(r,yield navigator.mediaDevices.getUserMedia({video:{mandatory:t.screen.mandatory}}))}else if(n.getDisplayMedia){var o;t.screen.mediaSource&&hw(t.screen.mediaSource);let h={width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate,displaySurface:(o=t.screen.displaySurface)!==null&&o!==void 0?o:t.screen.mediaSource==="screen"?"monitor":t.screen.mediaSource},{selfBrowserSurface:p,surfaceSwitching:g,systemAudio:E,preferCurrentTab:f}=t.screen,R={selfBrowserSurface:p,surfaceSwitching:g,systemAudio:E,preferCurrentTab:f};!p&&delete R.selfBrowserSurface,!g&&delete R.surfaceSwitching,!E&&delete R.systemAudio,!f&&delete R.preferCurrentTab,_.debug("[".concat(e,"] getDisplayMedia:"),JSON.stringify({video:h,audio:t.screenAudio,controls:R})),qa(r,yield navigator.mediaDevices.getDisplayMedia(de({video:h,audio:t.screenAudio},R)))}else{if(!_e())throw _.error("[".concat(e,"] This browser does not support screenSharing")),new F(C.NOT_SUPPORTED,"This browser does not support screen sharing");{t.screen.mediaSource&&hw(t.screen.mediaSource);let h={video:{mediaSource:t.screen.mediaSource,width:t.screen.width,height:t.screen.height,frameRate:t.screen.frameRate}};_.debug("[".concat(e,"] getUserMedia: ").concat(JSON.stringify(h))),qa(r,yield navigator.mediaDevices.getUserMedia(h))}}var s,a;if(!t.video&&!t.audio)return r;let c={video:t.video,audio:t.audio},d=A("MEDIA_DEVICE_CONSTRAINTS");if(d)try{typeof d=="string"&&(d=JSON.parse(d)),c=Tf(c,d)}catch{}_.debug("[".concat(e,"] GetUserMedia"),JSON.stringify(c)),kt();let l,u=null;(Qe()||fi()||ph())&&(u=yield Hf.lock());try{l=yield navigator.mediaDevices.getUserMedia(c)}catch(h){throw u&&u(),h}return c.audio&&(yw=!0),c.video&&(Cw=!0),qa(r,l),u&&u(),r})}function Ah(t,e){switch(t){case"Starting video failed":case"OverconstrainedError":case"TrackStartError":return new F(C.MEDIA_OPTION_INVALID,"".concat(t,": ").concat(e));case"NotFoundError":case"DevicesNotFoundError":return new F(C.DEVICE_NOT_FOUND,"".concat(t,": ").concat(e));case"NotSupportedError":return new F(C.NOT_SUPPORTED,"".concat(t,": ").concat(e));case"NotReadableError":return new F(C.NOT_READABLE,"".concat(t,": ").concat(e));case"InvalidStateError":case"NotAllowedError":case"PERMISSION_DENIED":case"PermissionDeniedError":return new F(C.PERMISSION_DENIED,"".concat(t,": ").concat(e));case"ConstraintNotSatisfiedError":return new F(C.CONSTRAINT_NOT_SATISFIED,"".concat(t,": ").concat(e));default:return _.error("getUserMedia unexpected error",t),new F(C.UNEXPECTED_ERROR,"".concat(t,": ").concat(e))}}function qa(t,e){let i=t.getVideoTracks()[0],n=t.getAudioTracks()[0],r=e.getVideoTracks()[0],o=e.getAudioTracks()[0];o&&(n&&t.removeTrack(n),t.addTrack(o)),r&&(i&&t.removeTrack(i),t.addTrack(r))}let rn=new class extends ue{get state(){return this._state}set state(t){t!==this._state&&(this.emit(Cs.STATE_CHANGE,t),this._state=t)}constructor(){super(),U(this,"_state",Cd.IDLE),U(this,"isAccessMicrophonePermission",!1),U(this,"isAccessCameraPermission",!1),U(this,"lastAccessMicrophonePermission",!1),U(this,"lastAccessCameraPermission",!1),U(this,"checkdeviceMatched",!1),U(this,"deviceInfoMap",new Map),this.init().then(()=>{navigator.mediaDevices.addEventListener&&navigator.mediaDevices.addEventListener("devicechange",this.updateDevicesInfo.bind(this)),window.setInterval(()=>{(A("ENUMERATE_DEVICES_INTERVAL")||(_h()||hh()===Ve.HARMONY_OS)&&Qr())&&this.updateDevicesInfo()},A("ENUMERATE_DEVICES_INTERVAL_TIME"))}).catch(t=>_.error(t.toString()))}enumerateDevices(i,n){return I(this,arguments,function*(t,e){let r=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!navigator.mediaDevices||!navigator.mediaDevices.enumerateDevices)return new F(C.NOT_SUPPORTED,"enumerateDevices() not supported.").throw();let o=yield navigator.mediaDevices.enumerateDevices(),s=this.checkMediaDeviceInfoIsOk(o),a=!this.isAccessMicrophonePermission&&t,c=!this.isAccessCameraPermission&&e;s.audio&&(a=!1),s.video&&(c=!1);let d=null,l=null,u=null;if(!r&&(a||c)){if(Hf.isLocked&&(_.debug("[device manager] wait GUM lock"),(yield Hf.lock())(),_.debug("[device manager] GUM unlock")),yw&&(a=!1,this.isAccessMicrophonePermission=!0),Cw&&(c=!1,this.isAccessCameraPermission=!0),_.debug("[device manager] check media device permissions",t,e,a,c),a&&c){try{u=yield navigator.mediaDevices.getUserMedia({audio:!0,video:!0})}catch(h){let p=Ah(h.name||h.code||h,h.message);if(p.code===C.PERMISSION_DENIED)throw p;_.warning("getUserMedia failed in getDevices",p)}this.isAccessCameraPermission=!0,this.isAccessMicrophonePermission=!0}else if(a){try{d=yield navigator.mediaDevices.getUserMedia({audio:t})}catch(h){let p=Ah(h.name||h.code||h,h.message);if(p.code===C.PERMISSION_DENIED)throw p;_.warning("getUserMedia failed in getDevices",p)}this.isAccessMicrophonePermission=!0}else if(c){try{l=yield navigator.mediaDevices.getUserMedia({video:e})}catch(h){let p=Ah(h.name||h.code||h,h.message);if(p.code===C.PERMISSION_DENIED)throw p;_.warning("getUserMedia failed in getDevices",p)}this.isAccessCameraPermission=!0}_.debug("[device manager] mic permission",t,"cam permission",e)}try{let h=yield navigator.mediaDevices.enumerateDevices();return d&&d.getTracks().forEach(p=>p.stop()),l&&l.getTracks().forEach(p=>p.stop()),u&&u.getTracks().forEach(p=>p.stop()),d=null,l=null,u=null,h}catch(h){return d&&d.getTracks().forEach(p=>p.stop()),l&&l.getTracks().forEach(p=>p.stop()),u&&u.getTracks().forEach(p=>p.stop()),d=null,l=null,u=null,new F(C.ENUMERATE_DEVICES_FAILED,h.toString()).throw()}})}getRecordingDevices(){return I(this,arguments,function*(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(yield this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audioinput")})}getCamerasDevices(){return I(this,arguments,function*(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(yield this.enumerateDevices(!1,!0,t)).filter(e=>e.kind==="videoinput")})}getSpeakers(){return I(this,arguments,function*(){let t=arguments.length>0&&arguments[0]!==void 0&&arguments[0];return(yield this.enumerateDevices(!0,!1,t)).filter(e=>e.kind==="audiooutput")})}searchDeviceIdByName(t){let e=null;return this.deviceInfoMap.forEach(i=>{i.device.label===t&&(e=i.device.deviceId)}),e}getDeviceById(t){return I(this,null,function*(){let e=(yield this.enumerateDevices(!0,!0,!0)).find(i=>i.deviceId===t);if(!e)throw new F(C.DEVICE_NOT_FOUND,"deviceId: ".concat(t));return e})}init(){return I(this,null,function*(){this.state=Cd.INITING;try{yield this.updateDevicesInfo(),this.state=Cd.INITEND}catch(t){throw _.warning("Device Detection functionality cannot start properly.",t.toString()),this.state=Cd.IDLE,(typeof isSecureContext=="boolean"?isSecureContext:location.protocol==="https:"||location.protocol==="file:"||location.hostname==="localhost"||location.hostname==="127.0.0.1"||location.hostname==="::1")||new F(C.WEB_SECURITY_RESTRICT,"Your context is limited by web security, please try using https protocol or localhost.").throw(),t}})}updateDevicesInfo(){return I(this,null,function*(){let t=yield this.enumerateDevices(!0,!0,!0),e=Date.now(),i=[];if(t[0]&&t[0].label&&this.checkdeviceMatched===!1){this.checkdeviceMatched=!0;let r=t.find(s=>s.kind==="audioinput"&&s.deviceId==="default"),o=t.find(s=>s.kind==="audiooutput"&&s.deviceId==="default");r&&o?o.groupId===r.groupId?_.debug("[device-check] default input ".concat(r.label," and output ").concat(o.label," is the same group")):_.debug("[device-check] default input ".concat(r.label," and output ").concat(o.label," is not the same group")):_.debug("[device-check] default input or output not found")}let n=this.checkMediaDeviceInfoIsOk(t);if(t.forEach(r=>{if(!r.deviceId)return;let o=this.deviceInfoMap.get("".concat(r.kind,"_").concat(r.deviceId));if((o?o.state:"INACTIVE")!=="ACTIVE"){let s={initAt:e,updateAt:e,device:r,state:"ACTIVE"};this.deviceInfoMap.set("".concat(r.kind,"_").concat(r.deviceId),s),i.push(s)}o&&(o.updateAt=e)}),this.deviceInfoMap.forEach((r,o)=>{r.state==="ACTIVE"&&r.updateAt!==e&&(r.state="INACTIVE",i.push(r))}),this.state!==Cd.INITEND)return n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),void(n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0));i.forEach(r=>{switch(r.device.kind){case"audioinput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Cs.RECORDING_DEVICE_CHANGED,r);break;case"videoinput":this.lastAccessCameraPermission&&this.isAccessCameraPermission&&this.emit(Cs.CAMERA_DEVICE_CHANGED,r);break;case"audiooutput":this.lastAccessMicrophonePermission&&this.isAccessMicrophonePermission&&this.emit(Cs.PLAYOUT_DEVICE_CHANGED,r)}}),n.audio&&(this.lastAccessMicrophonePermission=!0,this.isAccessMicrophonePermission=!0),n.video&&(this.lastAccessCameraPermission=!0,this.isAccessCameraPermission=!0)})}checkMediaDeviceInfoIsOk(t){let e=t.filter(r=>r.kind==="audioinput"),i=t.filter(r=>r.kind==="videoinput"),n={audio:!1,video:!1};for(let r of e)if(r.label&&r.deviceId){n.audio=!0;break}for(let r of i)if(r.label&&r.deviceId){n.video=!0;break}return n}},Kf=!1,on=new class extends ue{constructor(){super(...arguments),U(this,"onAutoplayFailed",void 0),U(this,"onAudioAutoplayFailed",void 0)}};function bw(){if(kt(),!Kf){let t=e=>{e.preventDefault(),Kf=!1,md()?document.body.removeEventListener("click",t,!0):(document.body.removeEventListener("touchstart",t,!0),document.body.removeEventListener("mousedown",t,!0))};Kf=!0,md()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0)),_.info("detect media autoplay failed, document: https://docs.agora.io/cn/Voice/autoplay_policy_web_ng?platform=Web"),on.onAutoplayFailed?on.onAutoplayFailed():on.onAudioAutoplayFailed?_.warning(`AgoraRTC.onAudioAutoplayFailed has been deprecated in favor of AgoraRTC.onAutoplayFailed.

  Please refer to the Agora document to migrate the newer API, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`):_.warning(`We have detected a media autoplay failed event, and found out that you haven't implemented AgoraRTC.onAutoplayFailed callback yet.

  It will cause audio/video element not playing automatically on some browsers without user interaction, possibly hurting user experiences.

  Please refer to the Agora document to properly handle autoplay failed event, https://docs.agora.io/en/Voice/autoplay_policy_web_ng?platform=Web .`),on.emit("autoplay-failed")}}function Iw(t,e,i,n){if(!t)return;let r=ot.getBaseInfoBySessionId(t);if(!r)return;let o=r.info,s=Date.now(),a=de(de({},o),{},{vid:o.vid===void 0?0:Number(o.vid),lts:s,elapse:s-r.startTime,cbRegistered:on.onAutoplayFailed||on.onAudioAutoplayFailed?1:-1,errorMsg:i,mediaType:e,trackId:n,extend:void 0});ot.send({type:ce.AUTOPLAY_FAILED,data:a},!0)}let xK=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","error"],Ii=new class{constructor(){U(this,"onAutoplayFailed",void 0),U(this,"elementMap",new Map),U(this,"elementStateMap",new Map),U(this,"elementsNeedToResume",[]),U(this,"sinkIdMap",new Map),U(this,"autoResumeAfterInterruption",t=>{Array.from(this.elementMap.entries()).forEach(e=>{let[i,n]=e,r=this.elementStateMap.get(i),o=n.srcObject.getAudioTracks()[0],s=o&&o.readyState;if(_.debug("resume after interrupted, ele: ".concat(r," audio: ").concat(s," ").concat(t)),s==="live"){if(t)return n.pause(),void n.play();if(Yt.curState==="running")return Pa()?(n.pause(),void n.play()):void(r&&r==="paused"&&n.play())}})}),U(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{Array.from(this.elementMap.entries()).forEach(t=>{let[e,i]=t,n=i.srcObject.getAudioTracks()[0];n&&n.readyState==="live"&&(_.debug("auto resume after interruption inside autoResumeAfterInterruptionOnIOS15"),i.pause(),i.play())})}),this.autoResumeAudioElement(),Yt.on(ze.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Yt.on(ze.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),Yt.on(ze.STATE_CHANGE,()=>{fi()&&Yt.prevState==="suspended"&&Yt.curState==="running"&&this.autoResumeAfterInterruption()})}setSinkID(t,e){return I(this,null,function*(){let i=this.elementMap.get(t);if(this.sinkIdMap.set(t,e),i)try{yield i.setSinkId(e)}catch(n){throw new F(C.PERMISSION_DENIED,"can not set sink id: "+n.toString())}})}play(t,e,i,n){if(this.elementMap.has(e))return;let r=document.createElement("audio");r.autoplay=!0,r.srcObject=new MediaStream([t]),this.bindAudioElementEvents(e,r),this.elementMap.set(e,r),this.elementStateMap.set(e,di.INIT),this.setVolume(e,i);let o=this.sinkIdMap.get(e);if(o)try{r.setSinkId(o).catch(a=>{_.warning("[".concat(e,"] set sink id failed"),a.toString())})}catch(a){_.warning("[".concat(e,"] set sink id failed"),a.toString())}let s=r.play();s&&s.then&&s.catch(a=>{n&&Iw(n,"audio",a.message,e),_.warning("audio element play warning",a.toString()),this.elementMap.has(e)&&a.name==="NotAllowedError"&&(_.warning("detected audio element autoplay failed"),this.elementsNeedToResume.push(r),Eh(()=>{this.onAutoplayFailed&&this.onAutoplayFailed(),bw()}))})}updateTrack(t,e){let i=this.elementMap.get(t);i&&(i.srcObject=new MediaStream([e]))}isPlaying(t){return this.elementMap.has(t)&&this.elementStateMap.get(t)==="playing"}setVolume(t,e){let i=this.elementMap.get(t);i&&(e=Math.max(0,Math.min(100,e)),i.volume=e/100)}stop(t){let e=this.elementMap.get(t);if(this.sinkIdMap.delete(t),!e)return;let i=this.elementsNeedToResume.indexOf(e);this.elementsNeedToResume.splice(i,1),e.srcObject=null,e.remove(),this.elementMap.delete(t),this.elementStateMap.delete(t)}bindAudioElementEvents(t,e){xK.forEach(i=>{e.addEventListener(i,n=>{let r=this.elementStateMap.get(t),o=n.type==="pause"?"paused":n.type;if(_.debug("[".concat(t,"] audio-element-status change ").concat(r," => ").concat(o)),n.type==="error"){let s=e?.error;s&&_.error("[".concat(t,"] media error, code: ").concat(s.code,", message: ").concat(s.message))}this.elementStateMap.set(t,o)})})}getPlayerState(t){return this.elementStateMap.get(t)||"uninit"}autoResumeAudioElement(){let t=()=>{this.elementsNeedToResume.forEach(e=>{e.play().then(i=>{_.debug("Auto resume audio element success")}).catch(i=>{_.warning("Auto resume audio element failed!",i)})}),this.elementsNeedToResume=[]};new Q(e=>{document.body?e():window.addEventListener("load",()=>e())}).then(()=>{md()?document.body.addEventListener("click",t,!0):(document.body.addEventListener("touchstart",t,!0),document.body.addEventListener("mousedown",t,!0))})}};function Re(){return function(t,e,i){let n=i.value;return typeof n=="function"&&(i.value=function(){this._isClosed&&new F(C.INVALID_OPERATION,"[".concat(this.getTrackId(),"] cannot operate a closed track")).print("warning",_);for(var r=arguments.length,o=new Array(r),s=0;s<r;s++)o[s]=arguments[s];let a=n.apply(this,o);return a instanceof Q?new Q((c,d)=>{a.then(c).catch(d)}):a}),i}}class Aw extends ue{constructor(e){super(),U(this,"name","VideoProcessorDestination"),U(this,"ID","0"),U(this,"_source",void 0),U(this,"videoContext",void 0),U(this,"inputTrack",void 0),this.videoContext=e}get kind(){return"video"}get enabled(){return!0}pipe(){throw new F(C.NOT_SUPPORTED,"VideoProcessor cannot pipe to any other Processor")}unpipe(){throw new F(C.NOT_SUPPORTED,"VideoProcessor cannot unpipe to any other Processor")}enable(){}disable(){}updateInput(e){if(e.context!==this.videoContext)throw new Error(`ProcessorContext passed to VideoTrack.processorDestination doesn't match it's belonging VideoTrack's context.
Probably you are making pipeline like this:
videoTrack1.pipe(processor).pipe(videoTrack2.processorDestination).`);e.track&&e.track!==this.inputTrack&&(this.videoContext.chained=!0,this.inputTrack=e.track,this.emit(gi.ON_TRACK,e.track))}reset(){this.inputTrack=void 0,this.videoContext.chained=!1,this.emit(gi.ON_TRACK,void 0)}}class ww extends ue{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,i){super(),U(this,"constraintsMap",new Map),U(this,"statsRegistry",[]),U(this,"usageRegistry",[]),U(this,"trackId",void 0),U(this,"direction",void 0),U(this,"_chained",!1),this.trackId=e,this.direction=i}getConstraints(){return I(this,null,function*(){return yield $e(this,tn.REQUEST_CONSTRAINTS)})}requestApplyConstraints(e,i){return I(this,null,function*(){var n;return _.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(i,e),Zt(this,tn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Bi(n=this.constraintsMap).call(n)))})}requestRevertConstraints(e){return I(this,null,function*(){var i;if(this.constraintsMap.has(e))return _.info("processor ".concat(e.name," requestRevertConstraints for ").concat(this.trackId)),this.constraintsMap.delete(e),Zt(this,tn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Bi(i=this.constraintsMap).call(i)))})}registerStats(e,i,n){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:i,cb:n})}unregisterStats(e,i){let n=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i);n!==-1&&this.statsRegistry.splice(n,1)}gatherStats(){let e=[];for(let{processorID:i,processorName:n,type:r,cb:o}of this.statsRegistry)try{let s=o();e.push({processorID:i,processorName:n,type:r,stats:s})}catch(s){_.error(new F(C.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,i){this.usageRegistry.find(n=>n.processorID===e.ID&&n.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:i})}unregisterUsage(e){let i=this.usageRegistry.findIndex(n=>n.processorID===e.ID&&n.processorName===e.name);i!==-1&&this.usageRegistry.splice(i,1)}gatherUsage(){return I(this,null,function*(){let e=[];if(!this.chained)return[];for(let{cb:i}of this.usageRegistry)try{let n=i();n instanceof Q&&(n=yield n),e.push(de(de({},n),{},{direction:this.direction}))}catch(n){_.error("gather extension usage error",n)}return e})}getDirection(){return this.direction}}class Ow extends ue{constructor(e){super(),U(this,"name","AudioProcessorDestination"),U(this,"ID","0"),U(this,"inputTrack",void 0),U(this,"inputNode",void 0),U(this,"audioProcessorContext",void 0),U(this,"_source",void 0),this.audioProcessorContext=e}get kind(){return"audio"}get enabled(){return!0}pipe(){throw new F(C.NOT_SUPPORTED,"AudioProcessorDestination cannot pipe to any other Processor")}unpipe(){throw new F(C.NOT_SUPPORTED,"AudioProcessor cannot unpipe to any other Processor")}enable(){}disable(){}reset(){this.inputTrack=void 0,this.inputNode=void 0,this.audioProcessorContext.chained=!1,this.emit(gi.ON_TRACK,void 0),this.emit(gi.ON_NODE,void 0)}updateInput(e){if(e.context!==this.audioProcessorContext)throw new Error(`ProcessorContext passed to AudioTrack.processorDestination doesn't match it's belonging AudioTrack's context.
        Probably you are making pipeline like this: audioTrack1.pipe(processor).pipe(audioTrack2.processorDestination).`);e.track&&this.inputTrack!==e.track&&(this.audioProcessorContext.chained=!0,this.inputTrack=e.track,this.emit(gi.ON_TRACK,this.inputTrack)),e.node&&this.inputNode!==e.node&&(this.audioProcessorContext.chained=!0,this.inputNode=e.node,this.emit(gi.ON_NODE,this.inputNode))}}class Nw extends ue{set chained(e){this._chained=e}get chained(){return this._chained}constructor(e,i,n){super(),U(this,"constraintsMap",new Map),U(this,"statsRegistry",[]),U(this,"audioContext",void 0),U(this,"trackId",void 0),U(this,"direction",void 0),U(this,"usageRegistry",[]),U(this,"_chained",!1),this.audioContext=e,this.trackId=i,this.direction=n}getConstraints(){return I(this,null,function*(){return $e(this,tn.REQUEST_CONSTRAINTS)})}getAudioContext(){return this.audioContext}requestApplyConstraints(e,i){return I(this,null,function*(){var n;return _.info("processor ".concat(i.name," requestApplyConstraints for ").concat(this.trackId)),e&&this.constraintsMap.set(i,e),Zt(this,tn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Bi(n=this.constraintsMap).call(n)))})}requestRevertConstraints(e){return I(this,null,function*(){var i;if(this.constraintsMap.has(e))return this.constraintsMap.delete(e),Zt(this,tn.REQUEST_UPDATE_CONSTRAINTS,Array.from(Bi(i=this.constraintsMap).call(i)))})}registerStats(e,i,n){this.statsRegistry.find(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i)||this.statsRegistry.push({processorName:e.name,processorID:e.ID,type:i,cb:n})}unregisterStats(e,i){let n=this.statsRegistry.findIndex(r=>r.processorID===e.ID&&r.processorName===e.name&&r.type===i);n!==-1&&this.statsRegistry.splice(n,1)}gatherStats(){let e=[];for(let{processorID:i,processorName:n,type:r,cb:o}of this.statsRegistry)try{let s=o();e.push({processorID:i,processorName:n,type:r,stats:s})}catch(s){_.error(new F(C.UNEXPECTED_ERROR,s.message))}return e}registerUsage(e,i){this.usageRegistry.find(n=>n.processorID===e.ID&&n.processorName===e.name)||this.usageRegistry.push({processorID:e.ID,processorName:e.name,cb:i})}unregisterUsage(e){let i=this.usageRegistry.findIndex(n=>n.processorID===e.ID&&n.processorName===e.name);i!==-1&&this.usageRegistry.splice(i,1)}gatherUsage(){return I(this,null,function*(){let e=[];if(!this.chained)return[];for(let{cb:i}of this.usageRegistry)try{let n=i();n instanceof Q&&(n=yield n),e.push(de(de({},n),{},{direction:this.direction}))}catch(n){_.error("gather extension usage error",n)}return e})}getDirection(){return this.direction}}class qf extends ue{get isPlayed(){return!0}get isFreeze(){return!1}constructor(){super(),U(this,"context",void 0),U(this,"processSourceNode",void 0),U(this,"outputTrack",void 0),U(this,"processedNode",void 0),U(this,"clonedTrack",void 0),U(this,"outputNode",void 0),this.outputNode=new VK}setVolume(){}createOutputTrack(){throw new F(C.NOT_SUPPORTED,"can not create output MediaStreamTrack when WebAudio disabled")}getOriginVolumeLevel(){return 0}getAccurateVolumeLevel(){return 0}stopGetAudioBuffer(){}startGetAudioBuffer(){}play(){}stop(){}destroy(){}updateTrack(){}updateOriginTrack(){}createMediaStreamSourceNode(){}}class VK{disconnect(){}connect(){}}function Dw(t){return new Q((e,i)=>{let n=!1,r=document.createElement("video");r.setAttribute("autoplay",""),r.setAttribute("muted",""),r.muted=!0,r.autoplay=!0,r.setAttribute("playsinline",""),r.setAttribute("style","position: fixed; top: 0; left: 0; width: 1px; height: 1px"),document.body.appendChild(r);let o=fi()?"canplay":"playing";r.addEventListener(o,()=>{let s=r.videoWidth,a=r.videoHeight;!s&&_e()||(n=!0,r.srcObject=null,r.remove(),e([s,a]))}),r.srcObject=new MediaStream([t]),r.play().catch(fh),setTimeout(()=>{n||(r.srcObject=null,r.remove(),e([r.videoWidth,r.videoHeight]))},4e3)})}function wh(t){let e={};t.facingMode&&(e.facingMode=t.facingMode),t.cameraId&&(e.deviceId={exact:t.cameraId});let i=Mn(t.encoderConfig);return i.width!=null&&(e.width=i.width),i.height!=null&&(e.height=i.height),!OA()&&i.frameRate&&(e.frameRate=i.frameRate),RA()&&typeof e.frameRate=="object"&&(e.frameRate.max=60),_e()&&(e.frameRate={ideal:30,max:30}),e}function Pw(t){let e={};return OA()||(t.AGC!==void 0&&(e.autoGainControl=t.AGC),t.AEC!==void 0&&(e.echoCancellation=t.AEC),t.ANS!==void 0&&(e.noiseSuppression=t.ANS,Jr()&&t.ANS&&(e.googHighpassFilter=t.ANS))),e}function Lw(t){let e=Pw(t);if(t.encoderConfig){let i=bh(t.encoderConfig);e.channelCount=i.stereo?2:1,e.sampleRate=i.sampleRate,e.sampleSize=i.sampleSize}return t.microphoneId&&(e.deviceId={exact:t.microphoneId}),_h()&&(e.sampleRate=void 0),e}let FK=t=>{let e=t._encoderConfig;if(!e)return;let{frameRate:i,width:n,height:r}=t.getMediaStreamTrackSettings(),{frameRate:o=i,width:s=n,height:a=r}=e;if(!o||!s||!a)return;s=Rf(s),a=Rf(a),o=Rf(o);let{max:c,min:d}=function(p,g,E){let f=200*Math.pow(E/15,.6)*Math.pow(p*g/640/360,.75);return{min:Math.floor(f),max:Math.floor(4*f)}}(s,a,o),{bitrateMax:l,bitrateMin:u}=e||{};l||_.debug("calculate bitrate: [w: ".concat(s,", h: ").concat(a,", fps: ").concat(o,"] => [brMax: ").concat(l,", brMin: ").concat(u,"]"));let{maxFramerate:h}=A("ENCODER_CONFIG_LIMIT");return h&&typeof h=="number"&&(o=Math.min(o,h)),{frameRate:o,bitrateMax:l||c,bitrateMin:u||d,scaleResolutionDownBy:1,scale:0}},kw=(t,e,i)=>I(null,null,function*(){return yield((n,r,o)=>I(null,null,function*(){let s=function(d){let l=[];for(let u=0;u<d.length;u+=2)l.push(parseInt(d.slice(u,u+2),16));return Uint8Array.from(l)}(KA(""+r+o)).slice(0,16),a=s.slice(0,12),c=yield window.crypto.subtle.importKey("raw",s,"AES-GCM",!0,["encrypt"]);return new Uint8Array(yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:a},c,n))}))(t.buffer,e,i)}),Yf=t=>{let e=document.createElement("canvas");return e.width=2,e.height=2,new Q((i,n)=>{e.toBlob(r=>I(null,null,function*(){if(e.remove(),r){let o=yield Mw(r);i({buffer:o,width:e.width,height:e.height})}else n(new F(C.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),t,1)})},Mw=t=>I(null,null,function*(){let e=yield t.arrayBuffer();return new Uint8Array(e)});var Uw,xw,Vw,Fw,Bw,jw,Gw,Ww,Hw,Kw,qw,Yw,zw,Xw,Jw,Qw,Zw,$w,pe,t0,e0,i0,n0,r0,o0,br,s0,a0,c0,d0,l0,u0,h0,p0,_0,m0,E0,f0,g0,ei;let ge=(Uw=ut({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),xw=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),Vw=Re(),Fw=Ma("LocalAudioTrack","_enabledMutex"),Bw=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),jw=Re(),Gw=Ma("LocalAudioTrack","_enabledMutex"),Ww=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),Hw=Re(),Kw=Re(),qw=Re(),Yw=ut({argsMap:t=>[t.getTrackId()]}),zw=Re(),Xw=ut({argsMap:t=>[t.getTrackId()]}),Jw=Re(),Qw=ut({argsMap:t=>[t.getTrackId()]}),Zw=ut({argsMap:(t,e)=>[t.getTrackId(),e.name]}),$w=ut({argsMap:t=>[t.getTrackId()]}),Nt((pe=class extends Ha{get _source(){return this.initWebAudio()}set _source(t){this._trackSource=t}get processorContext(){return this._processorContext||(this._processorContext=this.initProcessor().processorContext),this._processorContext}get processorDestination(){return this._processorDestination||(this._processorDestination=this.initProcessor().processorDestination),this._processorDestination}get isPlaying(){return this._useAudioElement?Ii.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"LocalAudioTrack"}constructor(t,e,i,n){super(t,i),U(this,"trackMediaType",Wa.AUDIO),U(this,"_encoderConfig",void 0),U(this,"_trackSource",void 0),U(this,"metadata",[]),U(this,"_enabled",!0),U(this,"_volume",100),U(this,"_useAudioElement",!0),U(this,"_bypassWebAudio",!1),U(this,"processor",void 0),U(this,"_processorContext",void 0),U(this,"_processorDestination",void 0),U(this,"_getOriginVolumeLevel",void 0),this._encoderConfig=e,this._getOriginVolumeLevel=!!n,this._trackSource=new qf,A("DISABLE_WEBAUDIO")&&(this._bypassWebAudio=!0),A("LOCAL_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1),Qe()&&!en?setTimeout(()=>this.initWebAudio()):this.initWebAudio()}setVolume(t){Xt(t,"volume",0,1e3),this._volume=t,this._source.setVolume(t/100),this._useAudioElement&&Ii.setVolume(this.getTrackId(),t);try{if(this._bypassWebAudio)return void _.debug("[".concat(this.getTrackId(),"] setVolume returned because no pass through WebAudio."));let e=this._source.createOutputTrack();this._mediaStreamTrack!==e&&(this._mediaStreamTrack=e,Zt(this,nt.NEED_REPLACE_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace web audio track success"))}).catch(i=>{_.warning("[".concat(this.getTrackId(),"] replace web audio track failed"),i)}))}catch{}}getVolumeLevel(){return this._muted&&this.enabled&&this._getOriginVolumeLevel?this._source.getOriginVolumeLevel():this._source.getAccurateVolumeLevel()}setPlaybackDevice(t){return I(this,null,function*(){if(!this._useAudioElement||!lw())throw new F(C.NOT_SUPPORTED,"your browser does not support setting the audio output device");yield Ii.setSinkID(this.getTrackId(),t)})}setEnabled(t,e,i){return I(this,null,function*(){return this._setEnabled(t,e,i)})}_setEnabled(t,e,i){return I(this,null,function*(){if(!i){if(t===this._enabled)return;this.stateCheck("enabled",t)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),t),t){this._originMediaStreamTrack.enabled=!0;try{i||(this._enabled=!0),yield Zt(this,nt.NEED_ENABLE_TRACK,this),_.info("[".concat(this.getTrackId(),"] setEnabled to ").concat(t," success"))}catch(n){throw i||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled to true error"),n.toString()),n}}else{this._originMediaStreamTrack.enabled=!1,i||(this._enabled=!1);try{yield Zt(this,nt.NEED_DISABLE_TRACK,this)}catch(n){throw i||(this._enabled=!0),_.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}}})}setMuted(t){return I(this,null,function*(){t!==this._muted&&(this.stateCheck("muted",t),this._muted=t,this._originMediaStreamTrack.enabled=!t,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(t)),t?yield Zt(this,nt.NEED_MUTE_TRACK,this):yield Zt(this,nt.NEED_UNMUTE_TRACK,this))})}getStats(){return Mo(()=>{_.warning("[deprecated] LocalAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalAudioStats instead")},"localAudioTrackGetStatsWarning"),Ji(this,nt.GET_STATS)||de({},Ff)}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners($i.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners($i.ON_AUDIO_BUFFER),this._source.on($i.ON_AUDIO_BUFFER,i=>t(i))}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] start audio playback in element")),Ii.play(this._mediaStreamTrack,this.getTrackId(),this._volume)):this._source.play()}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._useAudioElement?Ii.stop(this.getTrackId()):this._source.stop()}close(){super.close(),this._processorDestination&&this.unbindProcessorDestinationEvents(this._processorDestination),this._processorContext&&this.unbindProcessorContextEvents(this._processorContext),this.unpipe(),this._processorDestination&&this._processorDestination._source&&this._processorDestination._source.unpipe(),this._source.destroy()}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Ii.updateTrack(this.getTrackId(),this._mediaStreamTrack)}_updateOriginMediaStreamTrack(t,e){return I(this,null,function*(){this._originMediaStreamTrack!==t&&(this._originMediaStreamTrack&&(this._originMediaStreamTrack.removeEventListener("ended",this._handleTrackEnded),e&&this._originMediaStreamTrack.stop()),t.addEventListener("ended",this._handleTrackEnded),this._originMediaStreamTrack=t,this._muted&&(this._originMediaStreamTrack.enabled=!1),this.processor&&this._processorContext&&this.processor.updateInput({track:t,context:this._processorContext}),this._mediaStreamTrack!==this._source.outputTrack?(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),yield Zt(this,nt.NEED_REPLACE_TRACK,this)):this._source.updateTrack(this._originMediaStreamTrack),this._getOriginVolumeLevel&&this._source.updateOriginTrack(t))})}renewMediaStreamTrack(t){return Q.resolve(void 0)}pipe(t){if(this._bypassWebAudio)throw new F(C.INVALID_OPERATION,"Can not process AudioTrack when bypassWebAudio set to true.");if(this.processor===t)return t;if(t._source)throw new F(C.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(!this.processor)return;let e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(t){t.on(gi.ON_TRACK,e=>I(this,null,function*(){e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(e),yield Zt(this,nt.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),yield Zt(this,nt.NEED_REPLACE_TRACK,this))})),t.on(gi.ON_NODE,e=>{this._source.processedNode=e})}unbindProcessorDestinationEvents(t){t.removeAllListeners(gi.ON_TRACK),t.removeAllListeners(gi.ON_NODE)}bindProcessorContextEvents(t){t.on(tn.REQUEST_CONSTRAINTS,e=>I(this,null,function*(){e(this._originMediaStreamTrack.getSettings())}))}unbindProcessorContextEvents(t){t.removeAllListeners(tn.REQUEST_CONSTRAINTS)}initWebAudio(){return this._trackSource instanceof qf&&(this._trackSource=new Tw(this._mediaStreamTrack,!1,this._getOriginVolumeLevel?this._mediaStreamTrack:void 0)),this._trackSource}initProcessor(){let t=new Nw(this._source.context,this.getTrackId(),"local"),e=new Ow(t);return this._processorContext=t,this._processorDestination=e,this.bindProcessorContextEvents(t),this.bindProcessorDestinationEvents(e),this._source.on($i.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:t})}),this._useAudioElement&&(this._useAudioElement=!1,this.isPlaying&&(Ii.stop(this.getTrackId()),this._source.play()),Zt(this,nt.NEED_REPLACE_MIXING_TRACK,this).then(()=>{_.debug("[".concat(this.getTrackId(),"] replace from origin track to web audio track success"))}).catch(i=>{_.warning("[".concat(this.getTrackId(),"] replace from origin track to web audio track failed"),i)})),{processorContext:t,processorDestination:e}}}).prototype,"setVolume",[Uw],Object.getOwnPropertyDescriptor(pe.prototype,"setVolume"),pe.prototype),Nt(pe.prototype,"setPlaybackDevice",[xw,Vw],Object.getOwnPropertyDescriptor(pe.prototype,"setPlaybackDevice"),pe.prototype),Nt(pe.prototype,"setEnabled",[Fw,Bw,jw],Object.getOwnPropertyDescriptor(pe.prototype,"setEnabled"),pe.prototype),Nt(pe.prototype,"setMuted",[Gw,Ww,Hw],Object.getOwnPropertyDescriptor(pe.prototype,"setMuted"),pe.prototype),Nt(pe.prototype,"getStats",[Kw],Object.getOwnPropertyDescriptor(pe.prototype,"getStats"),pe.prototype),Nt(pe.prototype,"setAudioFrameCallback",[qw],Object.getOwnPropertyDescriptor(pe.prototype,"setAudioFrameCallback"),pe.prototype),Nt(pe.prototype,"play",[Yw,zw],Object.getOwnPropertyDescriptor(pe.prototype,"play"),pe.prototype),Nt(pe.prototype,"stop",[Xw,Jw],Object.getOwnPropertyDescriptor(pe.prototype,"stop"),pe.prototype),Nt(pe.prototype,"close",[Qw],Object.getOwnPropertyDescriptor(pe.prototype,"close"),pe.prototype),Nt(pe.prototype,"pipe",[Zw],Object.getOwnPropertyDescriptor(pe.prototype,"pipe"),pe.prototype),Nt(pe.prototype,"unpipe",[$w],Object.getOwnPropertyDescriptor(pe.prototype,"unpipe"),pe.prototype),pe),bd=(t0=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),e0=Re(),i0=Ma("MicrophoneAudioTrack","_enabledMutex"),n0=ut({argsMap:(t,e,i)=>[t.getTrackId(),e,i]}),r0=Re(),o0=ut({argsMap:t=>[t.getTrackId()]}),Nt((br=class t extends ge{get __className__(){return"MicrophoneAudioTrack"}constructor(e,i,n,r){super(e,i.encoderConfig?bh(i.encoderConfig):{},r,A("GET_VOLUME_OF_MUTED_AUDIO_TRACK")),U(this,"_config",void 0),U(this,"_deviceName","default"),U(this,"_constraints",void 0),U(this,"_originalConstraints",void 0),U(this,"_enabled",!0),this._config=i,this._constraints=n,this._originalConstraints=n,this._deviceName=e.label,typeof i.bypassWebAudio=="boolean"&&(this._bypassWebAudio=i.bypassWebAudio),(Pa()||pf())&&Yt.bindInterruptDetectorTrack(this)}setDevice(e){return I(this,null,function*(){if(_.info("[".concat(this.getTrackId(),"] start set device to ").concat(e)),this._enabled)try{let i=yield rn.getDeviceById(e),n={};n.audio=de({},this._constraints),n.audio.deviceId={exact:e},this._originMediaStreamTrack.stop();let r=null;try{r=yield nn(n,this.getTrackId())}catch(o){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),r=yield nn({audio:this._constraints},this.getTrackId()),yield this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),o}yield this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!1),this._deviceName=i.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(i){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}else try{let i=yield rn.getDeviceById(e);this._deviceName=i.label,this._config.microphoneId=e,this._constraints.deviceId={exact:e}}catch(i){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] set device to ").concat(e," success"))})}setEnabled(e,i,n){return I(this,null,function*(){if(i)return _.debug("[".concat(this.getTrackId(),"] setEnabled false (do not close microphone)")),yield SS(t.prototype,this,"_setEnabled").call(this,e);if(!n){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),A("AUTO_RESET_AUDIO_ROUTE")&&(fi()||Pn())){let a=navigator.audioSession;a&&(e||(a.type="playback"),a.type="auto")}if(!e){var r;this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop(),(r=this._source.clonedTrack)===null||r===void 0||r.stop(),n||(this._enabled=!1);try{yield Zt(this,nt.NEED_DISABLE_TRACK,this)}catch(a){throw _.error("[".concat(this.getTrackId(),"] setEnabled false failed"),a.toString()),a}return}let o=de({},this._constraints),s=rn.searchDeviceIdByName(this._deviceName);s&&!o.deviceId&&(o.deviceId=s);try{n||(this._enabled=!0);let a=yield nn({audio:this._constraints},this.getTrackId());yield this._updateOriginMediaStreamTrack(a.getAudioTracks()[0],!1),yield Zt(this,nt.NEED_ENABLE_TRACK,this)}catch(a){throw n||(this._enabled=!1),_.error("[".concat(this.getTrackId(),"] setEnabled true failed"),a.toString()),a}_.info("[".concat(this.getTrackId(),"] setEnabled success"))})}close(){super.close(),(Pa()||pf())&&Yt.unbindInterruptDetectorTrack(this)}onTrackEnded(){if((fi()||Pn())&&this._enabled&&!this._isClosed&&Yt.duringInterruption){let e=()=>I(this,null,function*(){Yt.off(ze.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture microphone media device for interrupted iOS device.")),yield this.setEnabled(!1),yield this.setEnabled(!0))});Yt.on(ze.IOS_INTERRUPTION_END,e)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ja.TRACK_ENDED)}renewMediaStreamTrack(e){return I(this,null,function*(){let i=e||this._constraints,n=rn.searchDeviceIdByName(this._deviceName);if(n&&!i.deviceId&&(i.deviceId=n),this._constraints=i,this._enabled){this._originMediaStreamTrack.stop();let r=yield nn({audio:this._constraints},this.getTrackId());yield this._updateOriginMediaStreamTrack(r.getAudioTracks()[0],!0)}})}bindProcessorContextEvents(e){super.bindProcessorContextEvents(e),e.on(tn.REQUEST_UPDATE_CONSTRAINTS,(i,n,r)=>I(this,null,function*(){try{let o=Object.assign({},this._originalConstraints,...i);yield this.renewMediaStreamTrack(o),n()}catch(o){r(o)}}))}unbindProcessorContextEvents(e){super.unbindProcessorContextEvents(e),e.removeAllListeners(tn.REQUEST_UPDATE_CONSTRAINTS)}}).prototype,"setDevice",[t0,e0],Object.getOwnPropertyDescriptor(br.prototype,"setDevice"),br.prototype),Nt(br.prototype,"setEnabled",[i0,n0,r0],Object.getOwnPropertyDescriptor(br.prototype,"setEnabled"),br.prototype),Nt(br.prototype,"close",[o0],Object.getOwnPropertyDescriptor(br.prototype,"close"),br.prototype),br),BK=(s0=ut({argsMap:(t,e)=>[t.getTrackId(),e,t.duration]}),a0=Re(),c0=ut({argsMap:t=>[t.getTrackId()]}),d0=Re(),l0=ut({argsMap:t=>[t.getTrackId()]}),u0=Re(),h0=ut({argsMap:t=>[t.getTrackId()]}),p0=Re(),_0=ut({argsMap:t=>[t.getTrackId()]}),m0=Re(),E0=ut({argsMap:t=>[t.getTrackId()]}),f0=ut({argsMap:t=>[t.getTrackId()]}),g0=Re(),Nt((ei=class extends ge{get __className__(){return"BufferSourceAudioTrack"}constructor(t,e,i,n){super(e.createOutputTrack(),i,n),U(this,"source",void 0),U(this,"_bufferSource",void 0),this._useAudioElement=!1,this.source=t,this._bufferSource=e,this._bufferSource.on($i.AUDIO_SOURCE_STATE_CHANGE,r=>{this.safeEmit(ja.SOURCE_STATE_CHANGE,r)});try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}}get currentState(){return this._bufferSource.currentState}get duration(){return this._bufferSource.duration}get playbackSpeed(){return this._bufferSource.playbackSpeed}getCurrentTime(){return this._bufferSource.currentTime}startProcessAudioBuffer(t){t&&this._bufferSource.updateOptions(t),this._bufferSource.startProcessAudioBuffer()}pauseProcessAudioBuffer(){this._bufferSource.pauseProcessAudioBuffer()}seekAudioBuffer(t){this._bufferSource.seekAudioBuffer(t)}resumeProcessAudioBuffer(){this._bufferSource.resumeProcessAudioBuffer()}stopProcessAudioBuffer(){this._bufferSource.stopProcessAudioBuffer()}close(){this.source=null,this._bufferSource.destroy(),super.close()}setAudioBufferPlaybackSpeed(t){Xt(t,"speed",0),this._bufferSource.setAudioBufferPlaybackSpeed(t)}}).prototype,"startProcessAudioBuffer",[s0,a0],Object.getOwnPropertyDescriptor(ei.prototype,"startProcessAudioBuffer"),ei.prototype),Nt(ei.prototype,"pauseProcessAudioBuffer",[c0,d0],Object.getOwnPropertyDescriptor(ei.prototype,"pauseProcessAudioBuffer"),ei.prototype),Nt(ei.prototype,"seekAudioBuffer",[l0,u0],Object.getOwnPropertyDescriptor(ei.prototype,"seekAudioBuffer"),ei.prototype),Nt(ei.prototype,"resumeProcessAudioBuffer",[h0,p0],Object.getOwnPropertyDescriptor(ei.prototype,"resumeProcessAudioBuffer"),ei.prototype),Nt(ei.prototype,"stopProcessAudioBuffer",[_0,m0],Object.getOwnPropertyDescriptor(ei.prototype,"stopProcessAudioBuffer"),ei.prototype),Nt(ei.prototype,"close",[E0],Object.getOwnPropertyDescriptor(ei.prototype,"close"),ei.prototype),Nt(ei.prototype,"setAudioBufferPlaybackSpeed",[f0,g0],Object.getOwnPropertyDescriptor(ei.prototype,"setAudioBufferPlaybackSpeed"),ei.prototype),ei);class Le extends ge{get __className__(){return"MixingAudioTrack"}get isActive(){for(let e of this.trackList)if(e._enabled&&!e._isClosed&&!e.muted)return!0;return!1}constructor(){let e=Ka().createMediaStreamDestination();super(e.stream.getAudioTracks()[0],void 0,te(8,"track-mix-")),U(this,"trackList",void 0),U(this,"destNode",void 0),this._useAudioElement=!1;try{this._mediaStreamTrack=this._source.createOutputTrack()}catch{}this.destNode=e,this.trackList=[]}hasAudioTrack(e){return this.trackList.indexOf(e)!==-1}addAudioTrack(e){this.trackList.indexOf(e)===-1?(_.debug("add ".concat(e.getTrackId()," to mixing track")),e._source.outputNode.connect(this.destNode),this.trackList.push(e),this.updateEncoderConfig()):_.debug("track ".concat(e.getTrackId()," is already added"))}removeAudioTrack(e){if(this.trackList.indexOf(e)!==-1){_.debug("remove ".concat(e.getTrackId()," from mixing track"));try{e._source.outputNode.disconnect(this.destNode)}catch{}mh(this.trackList,e),this.updateEncoderConfig()}}updateEncoderConfig(){let e={};this.trackList.forEach(i=>{i._encoderConfig&&((i._encoderConfig.bitrate||0)>(e.bitrate||0)&&(e.bitrate=i._encoderConfig.bitrate),(i._encoderConfig.sampleRate||0)>(e.sampleRate||0)&&(e.sampleRate=i._encoderConfig.sampleRate),(i._encoderConfig.sampleSize||0)>(e.sampleSize||0)&&(e.sampleSize=i._encoderConfig.sampleSize),i._encoderConfig.stereo&&(e.stereo=!0))}),this._encoderConfig=e}_updateRtpTransceiver(e){this._rtpTransceiver!==e&&(this._rtpTransceiver=e,this.trackList.forEach(i=>{i instanceof Le?i.emit(ys.TRANSCEIVER_UPDATED,e):i._updateRtpTransceiver(e)}))}}class jK extends Sw{set currentState(e){e!==this._currentState&&(this._currentState=e,this.safeEmit($i.AUDIO_SOURCE_STATE_CHANGE,this._currentState))}get currentState(){return this._currentState}constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};super(),U(this,"audioBuffer",void 0),U(this,"sourceNode",void 0),U(this,"startPlayTime",0),U(this,"startPlayOffset",0),U(this,"pausePlayTime",0),U(this,"options",void 0),U(this,"currentLoopCount",0),U(this,"currentPlaybackSpeed",100),U(this,"_currentState","stopped"),this.audioBuffer=e,this.options=i,this.startPlayOffset=this.options.startPlayTime||0}createWebAudioDiagram(){return this.context.createGain()}get duration(){return this.audioBuffer?this.audioBuffer.duration:0}get playbackSpeed(){return this.currentPlaybackSpeed}get currentTime(){return this.audioBuffer?this.currentState==="stopped"?0:this.currentState==="paused"?this.pausePlayTime:((this.context.currentTime-this.startPlayTime)*(this.playbackSpeed/100)+this.startPlayOffset)%this.audioBuffer.duration:0}updateOptions(e){this.currentState==="stopped"?(this.options=e,this.startPlayOffset=this.options.startPlayTime||0):_.warning("can not set audio source options")}startProcessAudioBuffer(){this.sourceNode&&this.stopProcessAudioBuffer(),this.sourceNode=this.createSourceNode(),this.startSourceNode(),this.currentState="playing"}pauseProcessAudioBuffer(){this.sourceNode&&this.currentState==="playing"&&(this.pausePlayTime=this.currentTime,this.sourceNode.onended=null,this.sourceNode.stop(),this.sourceNode.buffer=null,this.sourceNode=this.createSourceNode(),this.currentState="paused")}seekAudioBuffer(e){this.sourceNode&&(this.sourceNode.onended=null,this.currentState==="playing"&&this.sourceNode.stop(),this.sourceNode=this.createSourceNode(),this.currentState==="playing"?(this.startPlayOffset=e,this.startSourceNode()):this.currentState==="paused"&&(this.pausePlayTime=e))}resumeProcessAudioBuffer(){this.currentState==="paused"&&this.sourceNode&&(this.startPlayOffset=this.pausePlayTime,this.pausePlayTime=0,this.startSourceNode(),this.currentState="playing")}stopProcessAudioBuffer(){if(this.sourceNode){this.sourceNode.onended=null;try{this.sourceNode.stop()}catch{}this.reset()}}destroy(){this.audioBuffer=null,super.destroy()}setAudioBufferPlaybackSpeed(e){this.sourceNode&&(this.currentState==="playing"&&(this.startPlayOffset=this.currentTime,this.startPlayTime=this.context.currentTime),this.sourceNode.playbackRate.value=e/100),this.currentPlaybackSpeed=e}startSourceNode(){this.sourceNode&&this.sourceNode.buffer&&(this.sourceNode.start(0,this.startPlayOffset),this.startPlayTime=this.context.currentTime,this.sourceNode.onended=this.handleSourceNodeEnded.bind(this))}createSourceNode(){let e=this.context.createBufferSource();return e.buffer=this.audioBuffer,e.loop=!!this.options.loop,e.connect(this.outputNode),e.playbackRate.value=this.currentPlaybackSpeed/100,e}handleSourceNodeEnded(){if(this.currentLoopCount+=1,this.options.cycle&&this.options.cycle>this.currentLoopCount)return this.startPlayOffset=0,this.sourceNode=void 0,void this.startProcessAudioBuffer();this.reset()}reset(){this.startPlayOffset=this.options.startPlayTime||0,this.currentState="stopped",this.sourceNode&&(this.sourceNode.disconnect(),this.sourceNode=void 0),this.currentLoopCount=0}}let S0=new Map;function T0(t,e){if(t.length===0||e.length===0)return 1/0;let i=vf(t),n=vf(e);return Math.floor(n/i)}class zf{get rendFrameRate(){let e=Math.max(1,T0(this._render_interframe_delays_sizes,this._render_interframe_delays));return Math.floor(1e3/e)}get videoElementStatus(){return this._videoElementStatus}set videoElementStatus(e){e!==this._videoElementStatus&&(_.debug("[".concat(this.trackId,"] video-element-status change ").concat(this._videoElementStatus," => ").concat(e)),this._videoElementStatus=e)}get videoState(){return this._videoState}set videoState(e){var i;e!==this._videoState&&(this._videoState=e,(i=this.onVideoStateChanged)===null||i===void 0||i.call(this,this.videoState))}constructor(e){U(this,"trackId",void 0),U(this,"config",void 0),U(this,"onFirstVideoFrameDecoded",void 0),U(this,"onVideoStateChanged",void 0),U(this,"freezeTimeCounterList",[]),U(this,"renderFreezeAccTime",0),U(this,"renderFreezeAccTime2",0),U(this,"isKeepLastFrame",!1),U(this,"timeUpdatedCount",0),U(this,"freezeTime",0),U(this,"playbackTime",0),U(this,"lastTimeUpdatedTime",0),U(this,"autoplayFailed",!1),U(this,"videoTrack",void 0),U(this,"videoElement",void 0),U(this,"cacheVideoElement",void 0),U(this,"_render_interframe_delays",[]),U(this,"_render_interframe_delays_sizes",[]),U(this,"_videoState",Cr.VideoStateStopped),U(this,"videoElementCheckInterval",void 0),U(this,"videoElementFreezeTimeout",void 0),U(this,"_videoElementStatus",di.NONE),U(this,"isGettingVideoDimensions",!1),U(this,"startGetVideoDimensions",()=>{let i=()=>{if(this.isGettingVideoDimensions=!0,this.videoElement.videoWidth*this.videoElement.videoHeight>4)return _.debug("[".concat(this.trackId,"] current video dimensions:"),this.videoElement.videoWidth,this.videoElement.videoHeight),void(this.isGettingVideoDimensions=!1);setTimeout(i,500)};!this.isGettingVideoDimensions&&i()}),U(this,"autoResumeAfterInterruption",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&Yt.curState==="running"&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(TA())),AA()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),U(this,"handleVideoEvents",i=>{switch(i.type){case"play":case"playing":this.startGetVideoDimensions(),this.videoElementStatus=di.PLAYING;break;case"loadeddata":if(this.videoState=Cr.VideoStateStarting,this.onFirstVideoFrameDecoded&&this.onFirstVideoFrameDecoded(),this.cacheVideoElement){try{this.cacheVideoElement.srcObject=null,this.cacheVideoElement.remove()}catch{}this.cacheVideoElement=void 0}break;case"canplay":this.videoElementStatus=di.CANPLAY;break;case"stalled":this.videoElementStatus=di.STALLED;break;case"suspend":this.videoElementStatus=di.SUSPEND;break;case"pause":this.videoElementStatus=di.PAUSED,fi()||Pn()||Qe()&&this.autoplayFailed||!this.videoTrack||this.videoTrack.readyState!=="live"||(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume")),this.videoElement.play());break;case"waiting":this.videoElementStatus=di.WAITING;break;case"abort":this.videoElementStatus=di.ABORT;break;case"ended":this.videoElementStatus=di.ENDED;break;case"emptied":this.videoElementStatus=di.EMPTIED;break;case"error":{let n=this.videoElement.error;n&&(this.videoElementStatus=di.ERROR,_.error("[".concat(this.trackId,"] media error: ").concat(n.message," (").concat(n.code,")")));break}case"timeupdate":{let n=performance.now();if(this.timeUpdatedCount+=1,this.timeUpdatedCount<10)return void(this.lastTimeUpdatedTime=n);let r=n-this.lastTimeUpdatedTime,o=this.lastTimeUpdatedTime;if(this.lastTimeUpdatedTime=n,Ir.lastVisibleTime<Ir.lastHiddenTime||o<Ir.lastHiddenTime||o<Ir.lastVisibleTime)return;for(r>A("VIDEO_FREEZE_DURATION")&&(this.freezeTime+=r),this.playbackTime+=r;this.playbackTime>=6e3;){this.playbackTime-=6e3;let s=Math.min(6e3,this.freezeTime);this.freezeTimeCounterList.push(s),this.freezeTime=Math.max(0,this.freezeTime-6e3)}break}}}),U(this,"autoResumeAfterInterruptionOnIOS15_16",()=>{this.videoTrack&&this.videoTrack.readyState==="live"&&(_.debug("[track-".concat(this.trackId,"] video element paused, auto resume for ").concat(TA())),AA()?(this.videoElement.srcObject=null,this.videoElement.srcObject=new MediaStream([this.videoTrack]),this.videoElement.play()):(this.videoElement.pause(),this.videoElement.play()))}),this.trackId=e.trackId,this.config=e,e.element instanceof HTMLVideoElement?this.videoElement=e.element:this.videoElement=document.createElement("video"),Yt.on(ze.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Yt.on(ze.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16)}getVideoElement(){return this.videoElement}getContainerElement(){var e;return(e=this.videoElement.parentElement)!==null&&e!==void 0?e:void 0}updateConfig(e){this.config=e,this.trackId=e.trackId,e.element!==this.videoElement&&(this.destroy(),this.videoElement=e.element),this.videoTrack&&this.initVideoElement()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.initVideoElement())}play(e){let i=this.videoElement.play();i&&i.catch&&i.catch(r=>{e&&Iw(e,"video",r.message,this.trackId),r.name==="NotAllowedError"?(_.warning("detected video element autoplay failed",r),this.autoplayFailed=!0,this.handleAutoPlayFailed()):_.warning("[".concat(this.trackId,"] play warning: "),r)});let n=kt();if((n.name==="Safari"&&Number(n.version)===15||Pa())&&i&&i.then){let r=()=>{this.config.mirror&&(this.videoElement.style.transform="rotateY(180deg)")};i.then(r).catch(r)}}getCurrentFrame(){let e=document.createElement("canvas");e.width=this.videoElement.videoWidth,e.height=this.videoElement.videoHeight;let i=e.getContext("2d");if(!i)return _.error("create canvas context failed!"),new ImageData(2,2);i.drawImage(this.videoElement,0,0,e.width,e.height);let n=i.getImageData(0,0,e.width,e.height);return e.remove(),n}getCurrentFrameToUint8Array(i){return I(this,arguments,function*(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1,r=document.createElement("canvas");r.width=this.videoElement.videoWidth,r.height=this.videoElement.videoHeight;let o=r.getContext("2d");return o?(o.drawImage(this.videoElement,0,0,r.width,r.height),new Q((s,a)=>{r.toBlob(c=>I(this,null,function*(){if(r.remove(),c){let d=yield Mw(c);s({buffer:d,width:r.width,height:r.height})}else a(new F(C.CONVERTING_VIDEO_FRAME_TO_BLOB_FAILED))}),e,n<0?.1:n>1?1:n)})):yield Yf(e)})}destroy(){Yt.off(ze.IOS_INTERRUPTION_END,this.autoResumeAfterInterruption),Yt.off(ze.IOS_15_16_INTERRUPTION_END,this.autoResumeAfterInterruptionOnIOS15_16),this.videoElement.srcObject=null,this.resetVideoElement(),this.freezeTimeCounterList=[],this.videoState=Cr.VideoStateStopped}initVideoElement(){if(this.videoElementStatus=di.INIT,!this.videoElementCheckInterval&&(R0.forEach(o=>{this.videoElement.addEventListener(o,this.handleVideoEvents)}),this.videoElementCheckInterval=window.setInterval(()=>{(function(o){return o!==document.body&&document.body.contains(o)})(this.videoElement)||(this.videoElementStatus=di.DESTROYED)},1e3),A("ENABLE_VIDEO_FRAME_CALLBACK"))){var e,i;let o,s=()=>{document.visibilityState==="visible"&&(document.removeEventListener("visibilitychange",s),this.videoElementFreezeTimeout=window.setTimeout(a,A("VIDEO_FREEZE_DURATION")))},a=()=>{this.videoElementFreezeTimeout=void 0,this.videoState===Cr.VideoStateDecoding&&(document.visibilityState==="visible"?this.videoState=Cr.VideoStateFrozen:document.addEventListener("visibilitychange",s))},c=(d,l)=>{if(this.videoElementStatus===di.PLAYING){if(o){let p=l.presentationTime-o.presentationTime,g=l.presentedFrames-o.presentedFrames;this._render_interframe_delays_sizes.push(g),this._render_interframe_delays.push(p);let E=vf(this._render_interframe_delays_sizes),f=E-this._render_interframe_delays_sizes[0];if(E>30&&f>5&&(this._render_interframe_delays_sizes.shift(),this._render_interframe_delays.shift()),this.videoState===Cr.VideoStateStarting&&(this.videoState=Cr.VideoStateDecoding),this.videoState===Cr.VideoStateDecoding&&this.onVideoStateChanged&&(this.videoElementFreezeTimeout&&window.clearTimeout(this.videoElementFreezeTimeout),this.videoElementFreezeTimeout=window.setTimeout(a,A("VIDEO_FREEZE_DURATION"))),p<A("VIDEO_FREEZE_DURATION")&&this.videoState===Cr.VideoStateFrozen&&(this.videoState=Cr.VideoStateDecoding),p>A("VIDEO_FREEZE_DURATION")&&Ir.lastVisibleTime>=Ir.lastHiddenTime&&o.timestamp>Ir.lastVisibleTime&&o.timestamp>Ir.lastHiddenTime){let R=Math.min(66,T0(this._render_interframe_delays_sizes,this._render_interframe_delays)),y=Math.max(0,p-(g-1)*R);this.renderFreezeAccTime2+=y>R?y:0,this.renderFreezeAccTime+=p}}o=de(de({},l),{},{timestamp:d})}var u,h;A("ENABLE_VIDEO_FRAME_CALLBACK")&&((u=(h=this.videoElement).requestVideoFrameCallback)===null||u===void 0||u.call(h,c))};(e=(i=this.videoElement).requestVideoFrameCallback)===null||e===void 0||e.call(i,c)}this.videoElement.controls=!1,this.videoElement.setAttribute("playsinline",""),_h()&&!A("HIDE_NO_POSTER")&&(this.videoElement.poster="noposter");let n=kt();n.name==="Safari"&&Number(n.version)===15||Pa()||!this.config.mirror||(this.videoElement.style.transform="rotateY(180deg)"),this.config.fit?this.videoElement.style.objectFit=this.config.fit:this.videoElement.style.objectFit="cover",this.videoElement.setAttribute("muted",""),this.videoElement.muted=!0,this.videoElement.srcObject&&this.videoElement.srcObject instanceof MediaStream?this.videoElement.srcObject.getVideoTracks()[0]!==this.videoTrack&&(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,_e()&&this.videoElement.load()):(this.videoElement.srcObject=this.videoTrack?new MediaStream([this.videoTrack]):null,_e()&&this.videoElement.load());let r=this.videoElement.play();r!==void 0&&r.catch(o=>{_.debug("[".concat(this.trackId,"] playback interrupted"),o.toString())})}resetVideoElement(){R0.forEach(e=>{this.videoElement&&this.videoElement.removeEventListener(e,this.handleVideoEvents)}),this.videoElementCheckInterval&&(window.clearInterval(this.videoElementCheckInterval),this.videoElementCheckInterval=void 0),this.videoElementStatus=di.NONE}handleAutoPlayFailed(){let e=i=>{i.preventDefault(),this.videoElement.play().then(()=>{_.debug("[".concat(this.trackId,"] Video element for trackId:").concat(this.trackId," autoplay resumed."))}).catch(n=>{_.error(n)}),this.autoplayFailed=!1,md()?document.body.removeEventListener("click",e,!0):(document.body.removeEventListener("touchstart",e,!0),document.body.removeEventListener("mousedown",e,!0))};md()?document.body.addEventListener("click",e,!0):(document.body.addEventListener("touchstart",e,!0),document.body.addEventListener("mousedown",e,!0)),bw()}}let R0=["play","playing","loadeddata","canplay","pause","stalled","suspend","waiting","abort","emptied","ended","timeupdate","error"];class Oh extends zf{constructor(e){super(e),U(this,"container",void 0),U(this,"slot",void 0),this.slot=e.element,this.updateConfig(e)}updateConfig(e){this.config=e,this.trackId=e.trackId;let i=e.element;i!==this.slot&&(this.destroy(),this.slot=i),this.createElements()}updateVideoTrack(e){this.videoTrack!==e&&(this.videoTrack=e,this.createElements())}play(e){var i;(i=this.container)!==null&&i!==void 0&&i.contains(this.videoElement)&&super.play(e)}getCurrentFrame(){var e;return(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)?super.getCurrentFrame():new ImageData(2,2)}getCurrentFrameToUint8Array(i){return I(this,arguments,function*(e){var n;let r=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return(n=this.container)!==null&&n!==void 0&&n.contains(this.videoElement)?yield SS(Oh.prototype,this,"getCurrentFrameToUint8Array").call(this,e,r):yield Yf(e)})}destroy(){if(super.destroy(),this.videoElement.remove(),this.videoElement=document.createElement("video"),this.container){try{this.container.remove(),this.slot.removeChild(this.container)}catch{}this.container=void 0}}createElements(){this.container||(this.container=document.createElement("div")),this.container.id="agora-video-player-".concat(this.trackId),this.container.style.width="100%",this.container.style.height="100%",this.container.style.position="relative",this.container.style.overflow="hidden",this.videoTrack?(this.container.style.backgroundColor="black",A("KEEP_LAST_FRAME")&&this.isKeepLastFrame&&this.videoElement.paused&&this.resetVideoElement(),this.mountedVideoElement()):this.unmountedVideoElement(),this.slot.appendChild(this.container)}mountedVideoElement(){var e;!this.container||(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)||this.container.appendChild(this.videoElement),super.initVideoElement(),this.videoElement.id="video_".concat(this.trackId),this.videoElement.className="agora_video_player",this.videoElement.style.width="100%",this.videoElement.style.height="100%",this.videoElement.style.position="absolute",this.videoElement.style.left="0",this.videoElement.style.top="0"}unmountedVideoElement(){var e;if((e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)){super.resetVideoElement();try{this.container&&this.container.removeChild(this.videoElement)}catch{}this.videoElement=document.createElement("video")}}resetVideoElement(){var e;(e=this.container)!==null&&e!==void 0&&e.contains(this.videoElement)&&(super.resetVideoElement(),this.cacheVideoElement=this.videoElement,this.videoElement=document.createElement("video"))}getContainerElement(){return this.container}}var v0,y0,C0,b0,I0,A0,w0,O0,N0,D0,P0,L0,k0,M0,U0,x0,V0,F0,B0,j0,G0,W0,H0,K0,q0,Y0,At,z0,X0,J0,Q0,Z0,$0,tO,eO,sn;let re=(v0=ut({argsMap:(t,e,i)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),y0=Re(),C0=ut({argsMap:t=>[t.getTrackId()]}),b0=Ma("LocalVideoTrack","_enabledMutex"),I0=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),A0=Re(),w0=Ma("LocalVideoTrack","_enabledMutex"),O0=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),N0=Re(),D0=ut({argsMap:(t,e)=>[t.getTrackId(),e,t._saveEncodeBitrateRatio]}),P0=Re(),L0=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),k0=Re(),M0=Re(),U0=ut({argsMap:(t,e,i)=>[t.getTrackId(),e,i]}),x0=Re(),V0=Re(),F0=Re(),B0=Re(),j0=Re(),G0=Re(),W0=Re(),H0=ut({argsMap:(t,e)=>[t.getTrackId(),e.name]}),K0=ut({argsMap:t=>[t.getTrackId()]}),q0=ut({argsMap:t=>[t.getTrackId()]}),Y0=ut({argsMap:(t,e,i)=>[t.getTrackId(),e.label,i]}),At=class gM extends Ha{get videoHeight(){if(Qe()){let{height:e}=this._mediaStreamTrack.getSettings();return this._videoHeight=e,this._videoHeight}return this._videoHeight}get videoWidth(){if(Qe()){let{width:e}=this._mediaStreamTrack.getSettings();return this._videoWidth=e,this._videoWidth}return this._videoWidth}get isPlaying(){return!(!this._player||this._player.videoElementStatus!==di.PLAYING)}get processorDestination(){return this._processorDestination}get processorContext(){return this._processorContext}set processorContext(e){this._processorContext=e}get __className__(){return"LocalVideoTrack"}constructor(e,i,n,r,o,s){if(super(e,o),U(this,"trackMediaType",Wa.VIDEO),U(this,"_player",void 0),U(this,"isUseScaleResolutionDownBy",!1),U(this,"_videoVisibleTimer",null),U(this,"_previousVideoVisibleStatus",void 0),U(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),U(this,"_encoderConfig",void 0),U(this,"_scalabilityMode",{numSpatialLayers:1,numTemporalLayers:1}),U(this,"_optimizationMode",void 0),U(this,"_saveEncodeBitrateRatio",1),U(this,"_videoHeight",void 0),U(this,"_videoWidth",void 0),U(this,"_forceBitrateLimit",void 0),U(this,"_enabled",!0),U(this,"_processorDestination",void 0),U(this,"_processorContext",void 0),Qe()){let{width:a,height:c}=e.getSettings();this._videoWidth=a,this._videoHeight=c}else this.updateMediaStreamTrackResolution();if(this._scalabilityMode=n,this._optimizationMode=r,this._hints=s||[],i&&this._hints.indexOf(Jt.CUSTOM_TRACK)!==-1?this._encoderConfig=he(i):this._encoderConfig=i,this._hints.indexOf(Jt.SCREEN_TRACK)===-1)this.updateBitrateFromProfile();else if(lf(xt.CHROME,115)&&hh().indexOf("Windows")!==-1){let a=function(c,d){if("VideoFrame"in window&&"TransformStream"in window&&Mt().supportWebRTCInsertableStream){let l=new MediaStreamTrackProcessor(c),u=new MediaStreamTrackGenerator({kind:"video"}),h,p,g=Date.now(),E=()=>{f&&(clearInterval(f),f=void 0),h&&(h.close(),h=void 0),c.stop(),p=void 0,u.removeEventListener("ended",E)},f=window.setInterval(()=>{if(p&&h&&Date.now()-g>(d??1e3))try{u.readyState==="live"?p.enqueue(h.clone()):E()}catch{E()}},d??1e3),R=new TransformStream({transform:(y,N)=>{u.readyState==="live"?(p=N,g=Date.now(),h===void 0?(h=y,N.enqueue(y.clone())):(N.enqueue(h),h=y)):y.close()}});return u.addEventListener("ended",E),l.readable.pipeThrough(R).pipeTo(u.writable),u}}(e);a&&(_.info("local screen video track begin to inject frame"),this._mediaStreamTrack=a)}i&&this._hints.indexOf(Jt.CUSTOM_TRACK)!==-1&&this.setEncoderConfiguration(i),this._processorContext=new ww(this.getTrackId(),"local"),this._processorDestination=new Aw(this.processorContext),this.bindProcessorDestinationEvents()}play(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof e=="string"){let r=document.getElementById(e);r?e=r:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(e,'" element, use document.body')),e=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(i));let n=de(de(de({},this._getDefaultPlayerConfig()),i),{},{trackId:this.getTrackId(),element:e});this._player?this._player.updateConfig(n):(e instanceof HTMLVideoElement?this._player=new zf(n):this._player=new Oh(n),this._player.updateVideoTrack(this._mediaStreamTrack)),this._player.play(),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let r=this.getVideoElementVisibleStatus();this.safeEmit(ja.VIDEO_ELEMENT_VISIBLE_STATUS,r)}catch{}},A("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}setEnabled(e,i){return I(this,null,function*(){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),!e){this._originMediaStreamTrack.enabled=!1;try{yield Zt(this,nt.NEED_DISABLE_TRACK,this)}catch(n){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}return i||(this._enabled=!1),void _.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}this._originMediaStreamTrack.enabled=!0;try{yield Zt(this,nt.NEED_ENABLE_TRACK,this)}catch(n){throw _.error("[".concat(this.getTrackId(),"] setEnabled to true error"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)})}setMuted(e){return I(this,null,function*(){e!==this._muted&&(this.stateCheck("muted",e),this._muted=e,this._originMediaStreamTrack.enabled=!e,_.debug("[".concat(this.getTrackId(),"] start set muted: ").concat(e)),e?yield Zt(this,nt.NEED_MUTE_TRACK,this):yield Zt(this,nt.NEED_UNMUTE_TRACK,this))})}setSaveEncodeBitrateRatio(){return I(this,arguments,function*(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:this._saveEncodeBitrateRatio;if(this._saveEncodeBitrateRatio!==1&&this._encoderConfig&&this._encoderConfig.bitrateMax&&this._encoderConfig.bitrateMin){this._encoderConfig.bitrateMin=Math.floor(this._encoderConfig.bitrateMin*e),this._encoderConfig.bitrateMax=Math.floor(this._encoderConfig.bitrateMax*e),_.debug("[".concat(this.getTrackId(),"] set save encode bitrate ratio, ").concat(e)),this._saveEncodeBitrateRatio=1;try{yield Zt(this,nt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(_)}}})}setEncoderConfiguration(e,i){return I(this,null,function*(){if(!this._enabled)throw new F(C.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");if(e=Mn(e),A("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),e.width||e.height||e.frameRate){let n=wh({encoderConfig:e});(Qe()||fi()||Pn())&&(n.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(n));try{yield this._originMediaStreamTrack.applyConstraints(n),this.updateMediaStreamTrackResolution()}catch(r){let o=new F(C.UNEXPECTED_ERROR,r.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),o.toString()),o}}this._encoderConfig=e,this._hints.indexOf(Jt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{yield Zt(this,nt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(n){return n.throw(_)}})}getStats(){return Mo(()=>{_.warning("[deprecated] LocalVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getLocalVideoStats instead")},"localVideoTrackGetStatsWarning"),Ji(this,nt.GET_STATS)||de({},Bf)}setBeautyEffect(e){return I(this,null,function*(){_.error("LocalVideoTrack.setBeautyEffect was deprecated, please migrate to agora-extension-beauty-effect")})}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}getCurrentFrameImage(i){return I(this,arguments,function*(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:1;return this._player?this._player.getCurrentFrameToUint8Array(e,n):yield Yf(e)})}setBitrateLimit(e){return I(this,null,function*(){_.debug("[".concat(this.getTrackId(),"] set bitrate limit, ").concat(JSON.stringify(e))),e&&(this._forceBitrateLimit=e,this._encoderConfig&&(this._encoderConfig.bitrateMax?this._encoderConfig.bitrateMax=this._encoderConfig.bitrateMax<e.max_bitrate?this._encoderConfig.bitrateMax:e.max_bitrate:this._encoderConfig.bitrateMax=e.max_bitrate,this._encoderConfig.bitrateMin,this._encoderConfig.bitrateMin=e.min_bitrate))})}setOptimizationMode(e){return I(this,null,function*(){if(e!=="motion"&&e!=="detail"&&e!=="balanced")return void _.error(C.INVALID_PARAMS,"optimization mode must be motion, detail or balanced");let i=this._optimizationMode;try{this._optimizationMode=e,yield Zt(this,nt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this)}catch(n){throw this._optimizationMode=i,_.error("[".concat(this.getTrackId(),"] set optimization mode failed"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] set optimization mode success (").concat(e,")"))})}setScalabiltyMode(e){if(e.numSpatialLayers===1&&e.numTemporalLayers!==1)return _.error(C.INVALID_PARAMS,"scalability mode currently not supported, no SVC."),void(this._scalabilityMode={numSpatialLayers:1,numTemporalLayers:1});this._scalabilityMode=e,_.info("[".concat(this.getTrackId(),"] set scalability mode success (").concat(e,")"))}updateMediaStreamTrackResolution(){Dw(this._originMediaStreamTrack).then(e=>{let[i,n]=e;this._videoHeight=n,this._videoWidth=i}).catch(fh)}_updatePlayerSource(){this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}_getDefaultPlayerConfig(){return{fit:"contain"}}setSenderConfiguration(e){return I(this,null,function*(){if(!this._enabled)throw new F(C.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");_.debug("[".concat(this.getTrackId(),"] setSenderConfiguration applyConstraints"),JSON.stringify(e)),e=Mn(e),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate?this._forceBitrateLimit.max_bitrate:e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate?this._forceBitrateLimit.min_bitrate:e.bitrateMin),this._encoderConfig=e,this._hints.indexOf(Jt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{yield Zt(this,nt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(i){return i.throw(_)}})}updateBitrateFromProfile(){if(!this._encoderConfig)return;let{width:e,height:i,frameRate:n}=this.getMediaStreamTrackSettings();if(!e||!i||!n)return;let{bitrateMax:r,bitrateMin:o}=this._encoderConfig;if(o==null||r==null){let{max:s,min:a}=function(c,d,l,u,h){let p=A("BITRATE_ADAPTER_TYPE");if(p==="DEFAULT_BITRATE")return{min:u,max:h};if(h===void 0){let g=Math.floor(200*Math.pow(l/15,.6)*Math.pow(c*d/640/360,.75));h=p==="STANDARD_BITRATE"?4*g:2*g,u=u??g}else u=u??Math.floor(h/10);return{min:u,max:h}}(e,i,n,o,r);if(this._encoderConfig.bitrateMin=a,this._encoderConfig.bitrateMax=s,A("VIDEO_STANDARD_BITRATE_VERSION")&&o==null&&r==null){let[c,d]=function(l,u,h){let p=4*Math.floor(2e5*Math.pow(h/15,.6)*Math.pow(l*u/230400,.75)),g=l*u,E=new Map([[19200,.9],[230400,.85],[518400,.75],[921600,.7],[2073600,.6],[3686400,.5]]),f=new Map([[230400,.95],[518400,.9],[921600,.85],[2073600,.8]]),R=Bi(E).call(E).next().value,y=1;if(E.has(g))R=E.get(g);else{var N;let J=ls(N=Array.from(E.entries())).call(N,(Rt,_t)=>{let[ne]=Rt,[Qt]=_t;return ne-Qt}),yt=J.find(Rt=>{let[_t]=Rt;return _t>g});if(yt){let Rt=J.indexOf(yt);if(Rt>0){let _t=J[Rt-1],ne=(g-_t[0])/(yt[0]-_t[0]);R=_t[1]+ne*(yt[1]-_t[1])}else R=yt[1]}else R=J[J.length-1][1]}if(f.has(g))y=f.get(g);else{var k;let J=ls(k=Array.from(f.entries())).call(k,(Rt,_t)=>{let[ne]=Rt,[Qt]=_t;return ne-Qt}),yt=J.find(Rt=>{let[_t]=Rt;return _t>g});if(yt){let Rt=J.indexOf(yt);if(Rt>0){let _t=J[Rt-1],ne=(g-_t[0])/(yt[0]-_t[0]);y=_t[1]+ne*(yt[1]-_t[1])}else y=yt[1]}else y=J[J.length-1][1]}let L=A("VIDEO_NEW_BITRATE_RATIO");L&&L>0&&(R=L/100);let P=Math.floor(p*R),V=Math.floor(65e4*Math.pow(l*u/230400,.5)*Math.pow(h/15,.69)),B=P,Y=A("VIDEO_STANDARD_BITRATE_VERSION");return Y&&Y>0&&(Y===1?B=p:Y===2?B=P:Y===3&&(B=V)),[Math.floor(B/1e3),y]}(e,i,n);this._encoderConfig.bitrateMax=c,this._encoderConfig.bitrateMin=a?Math.min(a,c):c,this._saveEncodeBitrateRatio=d,_.debug("[".concat(this.getTrackId(),"] update new bitrate from profile, [w: ").concat(e,", h: ").concat(i,", fps: ").concat(n,"] => [brMax: ").concat(this._encoderConfig.bitrateMax,", brMin: ").concat(this._encoderConfig.bitrateMin,", save_bitrate_ratio: ").concat(this._saveEncodeBitrateRatio,"]"))}else _.debug("[".concat(this.getTrackId(),"] update bitrate from profile, [w: ").concat(e,", h: ").concat(i,", fps: ").concat(n,"] => [brMax: ").concat(s,", brMin: ").concat(a,"]")),this._saveEncodeBitrateRatio=1}}getVideoElementVisibleStatus(){try{var e,i;let n=this==null||(e=this._player)===null||e===void 0?void 0:e.getContainerElement(),r={track:this,element:this==null||(i=this._player)===null||i===void 0?void 0:i.getVideoElement(),slot:n?.parentElement},{element:o,slot:s}=r;if(this.isPlaying&&o instanceof HTMLVideoElement&&s instanceof HTMLElement){let a=PA.checkOneElementVisible(o),c=Object.assign({},a);if(c.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=c.visible;let d=ot.reportApiInvoke(null,{tag:Ee.TRACER,name:be.LOCAL_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});c.visible?d.onSuccess("Video is visible"):d.onSuccess("Invisible because of ".concat(c.reason))}return c}return}catch(n){throw new F(C.GET_VIDEO_ELEMENT_VISIBLE_ERROR,n.message)}}renewMediaStreamTrack(e){return I(this,null,function*(){})}pipe(e){if(this.processor===e)return e;if(e._source)throw new F(C.INVALID_OPERATION,"Processor ".concat(e.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=e,this.processor._source=this,e.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),e}unpipe(){if(!this.processor)return;let e=this.processor;this.processor._source=void 0,this.processor=void 0,e.reset()}close(){super.close(),this.unbindProcessorDestinationEvents(),this.unbindProcessorContextEvents(),this.unpipe(),this.processorDestination._source&&this.processorDestination._source.unpipe()}clone(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],n=this._encoderConfig;e&&(n=de(de({},n),Mn(e))),n=Ss(n);let r=te(8,"track-video-cloned-"),o=new gM(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,n,Ss(this._scalabilityMode),this._optimizationMode,r,Ss(this._hints));return e&&n&&o.setEncoderConfiguration(n),_.debug("clone video track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(i)),o}replaceTrack(e,i){return I(this,null,function*(){if(!(e instanceof MediaStreamTrack))throw new F(C.INVALID_PARAMS,"track should be an instance of MediaStreamTrack");if(e.kind!=="video")throw new F(C.INVALID_PARAMS,"track should be a video MediaStreamTrack");yield this._updateOriginMediaStreamTrack(e,i,!0),this.updateMediaStreamTrackResolution()})}sendSeiData(e){if(Mo(()=>{ot.reportApiInvoke(null,{name:be.LOCAL_VIDEO_SEND_SEI_DATA,options:[],tag:Ee.TRACER}).onSuccess("")},this._mediaStreamTrack.id||this.getTrackId()),!A("ENABLE_VIDEO_SEI")||!A("ENABLE_ENCODED_TRANSFORM"))return void _.warning('To send/receive SEI, please call AgoraRTC.setParameter("ENABLE_VIDEO_SEI", true) before instantiate IAgoraRtcClient');if(e instanceof Uint8Array==0)return new F(C.INVALID_PARAMS,"Invalid argument type, ILocalVideoTrack.sendSeiData() only accept Uint8Array argument.").throw();let i=this.getRTCRtpTransceiver();if(!i)return void _.warning("Video track is not published, SEI can not be send");let n=i.sender.getParameters();if(n.codecs.length===0)return;let r=n.codecs[0].mimeType.toLocaleLowerCase();r==="video/h264"?this.safeEmit("sei-to-send",e):_.warning("SEI is not supported by ".concat(r))}bindProcessorDestinationEvents(){this.processorDestination.on(gi.ON_TRACK,e=>I(this,null,function*(){e?e!==this._mediaStreamTrack&&(this._mediaStreamTrack=e,this._updatePlayerSource(),yield Zt(this,nt.NEED_REPLACE_TRACK,this)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource(),yield Zt(this,nt.NEED_REPLACE_TRACK,this))}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gi.ON_TRACK)}unbindProcessorContextEvents(){this.processorContext.removeAllListeners(tn.REQUEST_UPDATE_CONSTRAINTS),this.processorContext.removeAllListeners(tn.REQUEST_CONSTRAINTS)}},Nt(At.prototype,"play",[v0,y0],Object.getOwnPropertyDescriptor(At.prototype,"play"),At.prototype),Nt(At.prototype,"stop",[C0],Object.getOwnPropertyDescriptor(At.prototype,"stop"),At.prototype),Nt(At.prototype,"setEnabled",[b0,I0,A0],Object.getOwnPropertyDescriptor(At.prototype,"setEnabled"),At.prototype),Nt(At.prototype,"setMuted",[w0,O0,N0],Object.getOwnPropertyDescriptor(At.prototype,"setMuted"),At.prototype),Nt(At.prototype,"setSaveEncodeBitrateRatio",[D0,P0],Object.getOwnPropertyDescriptor(At.prototype,"setSaveEncodeBitrateRatio"),At.prototype),Nt(At.prototype,"setEncoderConfiguration",[L0,k0],Object.getOwnPropertyDescriptor(At.prototype,"setEncoderConfiguration"),At.prototype),Nt(At.prototype,"getStats",[M0],Object.getOwnPropertyDescriptor(At.prototype,"getStats"),At.prototype),Nt(At.prototype,"setBeautyEffect",[U0,x0],Object.getOwnPropertyDescriptor(At.prototype,"setBeautyEffect"),At.prototype),Nt(At.prototype,"getCurrentFrameData",[V0],Object.getOwnPropertyDescriptor(At.prototype,"getCurrentFrameData"),At.prototype),Nt(At.prototype,"getCurrentFrameImage",[F0],Object.getOwnPropertyDescriptor(At.prototype,"getCurrentFrameImage"),At.prototype),Nt(At.prototype,"setBitrateLimit",[B0],Object.getOwnPropertyDescriptor(At.prototype,"setBitrateLimit"),At.prototype),Nt(At.prototype,"setOptimizationMode",[j0],Object.getOwnPropertyDescriptor(At.prototype,"setOptimizationMode"),At.prototype),Nt(At.prototype,"setScalabiltyMode",[G0],Object.getOwnPropertyDescriptor(At.prototype,"setScalabiltyMode"),At.prototype),Nt(At.prototype,"updateMediaStreamTrackResolution",[W0],Object.getOwnPropertyDescriptor(At.prototype,"updateMediaStreamTrackResolution"),At.prototype),Nt(At.prototype,"pipe",[H0],Object.getOwnPropertyDescriptor(At.prototype,"pipe"),At.prototype),Nt(At.prototype,"unpipe",[K0],Object.getOwnPropertyDescriptor(At.prototype,"unpipe"),At.prototype),Nt(At.prototype,"close",[q0],Object.getOwnPropertyDescriptor(At.prototype,"close"),At.prototype),Nt(At.prototype,"replaceTrack",[Y0],Object.getOwnPropertyDescriptor(At.prototype,"replaceTrack"),At.prototype),At),Xf=(z0=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),X0=Re(),J0=Ma("CameraVideoTrack","_enabledMutex"),Q0=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),Z0=Re(),$0=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),tO=Re(),eO=ut({argsMap:t=>[t.getTrackId()]}),sn=class SM extends re{get __className__(){return"CameraVideoTrack"}constructor(e,i,n,r,o,s){super(e,Mn(i.encoderConfig),r,o,s),U(this,"_config",void 0),U(this,"_originalConstraints",void 0),U(this,"_constraints",void 0),U(this,"_enabled",!0),U(this,"_deviceName","default"),U(this,"tryResumeVideoForIOS15_16WeChat",()=>I(this,null,function*(){(Pa()||pf())&&!function(){let a=kt();if(a.os!==Ve.IOS||!a.osVersion)return!1;let c=a.osVersion.split(".");return Number(c[0])===15&&Number(c[1])>=2}()&&wA()&&this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS 15 device on WeChat.")),yield this.renewMediaStreamTrack())})),this._config=i,this._originalConstraints=n,this._constraints=n,this._deviceName=e.label,this._encoderConfig=Mn(this._config.encoderConfig),Yt.on(ze.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Yt.on(ze.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),this.bindProcessorContextEvents()}setDevice(e){return I(this,null,function*(){return typeof e=="string"?this._setDeviceById(e):e.deviceId?this._setDeviceById(e.deviceId):e.facingMode?this._setDeviceByFacingModel(e.facingMode):void 0})}_setDeviceById(e){return I(this,null,function*(){if(_.info("[".concat(this.getTrackId(),"] set device to ").concat(e)),this._enabled)try{let i=yield rn.getDeviceById(e),n={};n.video=de({},this._constraints),n.video.deviceId={exact:e},n.video.facingMode=void 0,this._originMediaStreamTrack.stop();let r=null;try{r=yield nn(n,this.getTrackId())}catch(o){throw _.error("[".concat(this.getTrackId(),"] setDevice failed"),o.toString()),r=yield nn({video:this._constraints},this.getTrackId()),yield this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),o}yield this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution(),this._deviceName=i.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(i){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}else try{let i=yield rn.getDeviceById(e);this._deviceName=i.label,this._config.cameraId=e,this._constraints.deviceId={exact:e}}catch(i){throw _.error("[".concat(this.getTrackId(),"] setDevice error"),i.toString()),i}_.info("[".concat(this.getTrackId(),"] setDevice success"))})}_setDeviceByFacingModel(e){return I(this,null,function*(){_.info("[".concat(this.getTrackId(),"] set facingMode ").concat(e));let i={video:de(de({},this._constraints),{},{deviceId:void 0,facingMode:{exact:e}})};if(this._enabled){this._originMediaStreamTrack.stop();let n=null;try{n=yield nn(i,this.getTrackId())}catch(r){throw _.error("[".concat(this.getTrackId(),"] setDeviceByFacingModel failed"),r.toString()),n=yield nn({video:this._constraints},this.getTrackId()),yield this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),r}yield this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1),this.updateMediaStreamTrackResolution()}this._deviceName="",this._config.facingMode=e,this._config.cameraId=void 0,this._constraints=de({},i.video),_.info("[".concat(this.getTrackId(),"] setDeviceByFacingModel success"))})}setEnabled(e,i){return I(this,null,function*(){if(!i){if(e===this._enabled)return;this.stateCheck("enabled",e)}if(_.info("[".concat(this.getTrackId(),"] start setEnabled"),e),e){try{if(this.isExternalTrack)this._originMediaStreamTrack.enabled=!0;else{let n=yield nn({video:this._constraints},this.getTrackId());yield this._updateOriginMediaStreamTrack(n.getVideoTracks()[0],!1)}yield Zt(this,nt.NEED_ENABLE_TRACK,this)}catch(n){throw _.error("[".concat(this.getTrackId(),"] setEnabled true error"),n.toString()),n}this.updateMediaStreamTrackResolution(),_.info("[".concat(this.getTrackId(),"] setEnabled to true success")),i||(this._enabled=!0)}else{this.isExternalTrack?this._originMediaStreamTrack.enabled=!1:(this._originMediaStreamTrack.onended=null,this._originMediaStreamTrack.stop()),i||(this._enabled=!1);try{yield Zt(this,nt.NEED_DISABLE_TRACK,this)}catch(n){throw _.error("[".concat(this.getTrackId(),"] setEnabled to false error"),n.toString()),n}_.info("[".concat(this.getTrackId(),"] setEnabled to false success"))}})}setEncoderConfiguration(e,i){return I(this,null,function*(){if(!this._enabled)throw new F(C.TRACK_IS_DISABLED,"can not set encoder configuration when track is disabled");e=Mn(e),A("USE_STANDARD_BITRATE_DEFAULT")&&(delete e.bitrateMax,delete e.bitrateMin),this._forceBitrateLimit&&(e.bitrateMax=this._forceBitrateLimit.max_bitrate||e.bitrateMax,e.bitrateMin=this._forceBitrateLimit.min_bitrate||e.bitrateMin);let n=he(this._config);n.encoderConfig=e;let r=wh(n);(Qe()||fi()||Pn())&&(r.deviceId=void 0),_.debug("[".concat(this.getTrackId(),"] setEncoderConfiguration applyConstraints"),JSON.stringify(e),JSON.stringify(r));try{yield this._originMediaStreamTrack.applyConstraints(r),this.updateMediaStreamTrackResolution()}catch(o){let s=new F(C.UNEXPECTED_ERROR,o.toString());throw _.error("[".concat(this.getTrackId(),"] applyConstraints error"),s.toString()),s}this._config=n,this._constraints=r,this._originalConstraints=r,this._encoderConfig=e,this._hints.indexOf(Jt.SCREEN_TRACK)===-1&&this.updateBitrateFromProfile();try{yield Zt(this,nt.NEED_UPDATE_VIDEO_ENCODER,this)}catch(o){return o.throw(_)}})}_getDefaultPlayerConfig(){return{mirror:!0,fit:"cover"}}onTrackEnded(){if((fi()||Pn())&&this._enabled&&!this._isClosed&&Yt.duringInterruption){let e=()=>I(this,null,function*(){Yt.off(ze.IOS_INTERRUPTION_END,e),this._enabled&&!this._isClosed&&(_.debug("[".concat(this.getTrackId(),"] try capture camera media device for interrupted iOS device.")),yield this.setEnabled(!1),yield this.setEnabled(!0))});Yt.on(ze.IOS_INTERRUPTION_END,e)}else _.debug("[".concat(this.getTrackId(),"] track ended")),this.safeEmit(ja.TRACK_ENDED)}renewMediaStreamTrack(e){return I(this,null,function*(){let i=e||this._constraints,n=rn.searchDeviceIdByName(this._deviceName);if(n&&!i.deviceId&&(i.deviceId={exact:n}),this._enabled){let r=yield nn({video:i},this.getTrackId());this._constraints=i,yield this._updateOriginMediaStreamTrack(r.getVideoTracks()[0],!0),this.updateMediaStreamTrackResolution()}})}close(){super.close(),Yt.off(ze.IOS_15_16_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat),Yt.off(ze.IOS_INTERRUPTION_END,this.tryResumeVideoForIOS15_16WeChat)}clone(e){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1],n=this._encoderConfig;e&&(n=de(de({},n),Mn(e))),n=Ss(n);let r=te(8,"track-cam-cloned-"),o=new SM(i?this._mediaStreamTrack.clone():this._mediaStreamTrack,Ss(de(de({},this._config),{},{encoderConfig:n})),Ss(this._constraints),Ss(this._scalabilityMode),this._optimizationMode,r);return e&&n&&o.setEncoderConfiguration(n),_.debug("clone track from ".concat(this.getTrackId()," to ").concat(r,", clone ").concat(i)),o}bindProcessorContextEvents(){this.processorContext.on(tn.REQUEST_UPDATE_CONSTRAINTS,(e,i,n)=>I(this,null,function*(){try{let r=Object.assign({},this._originalConstraints,...e);yield this.renewMediaStreamTrack(r),i()}catch(r){n(r)}})),this.processorContext.on(tn.REQUEST_CONSTRAINTS,e=>I(this,null,function*(){e(this._originMediaStreamTrack.getSettings())}))}},Nt(sn.prototype,"setDevice",[z0,X0],Object.getOwnPropertyDescriptor(sn.prototype,"setDevice"),sn.prototype),Nt(sn.prototype,"setEnabled",[J0,Q0,Z0],Object.getOwnPropertyDescriptor(sn.prototype,"setEnabled"),sn.prototype),Nt(sn.prototype,"setEncoderConfiguration",[$0,tO],Object.getOwnPropertyDescriptor(sn.prototype,"setEncoderConfiguration"),sn.prototype),Nt(sn.prototype,"close",[eO],Object.getOwnPropertyDescriptor(sn.prototype,"close"),sn.prototype),sn);function Jf(t,e,i,n){i.optimizationMode&&(n&&n.width&&n.height?(i.encoderConfig=de(de({},n),{},{bitrateMin:n.bitrateMin,bitrateMax:n.bitrateMax}),i.optimizationMode!=="motion"&&i.optimizationMode!=="detail"||(e.contentHint=i.optimizationMode,e.contentHint===i.optimizationMode?_.debug("[".concat(t,"] set content hint to"),i.optimizationMode):_.debug("[".concat(t,"] set content hint failed")))):_.warning("[".concat(t,"] can not apply optimization mode bitrate config, no encoderConfig")))}var iO,nO,rO,oO,_n,sO,aO,cO,dO,lO,uO,hi;class hO extends Ew{getUserId(){return this._userId}constructor(e,i,n,r){super(e,"track-".concat(e.kind,"-").concat(i,"-").concat(r.clientId,"_").concat(te(5,""))),U(this,"_userId",void 0),U(this,"_uintId",void 0),U(this,"_isDestroyed",!1),U(this,"store",void 0),U(this,"processor",void 0),U(this,"processorContext",void 0),this._userId=i,this._uintId=n,this.store=r}_updateOriginMediaStreamTrack(e){this._originMediaStreamTrack=e,this._mediaStreamTrack=e,this._updatePlayerSource(),this.processor&&this.processor.updateInput({track:this._originMediaStreamTrack,context:this.processorContext})}_destroy(){this._isDestroyed=!0,_.info("[".concat(this.getTrackId(),"] is destroyed")),this.stop(),super.close()}getProcessorStats(){return this.processorContext.gatherStats()}getProcessorUsage(){return this.processorContext.gatherUsage()}}let Ya=(iO=ut({argsMap:(t,e,i)=>[t.getTrackId(),typeof e=="string"?e:e instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement",i]}),nO=ut({argsMap:t=>[t.getTrackId()]}),rO=ut({argsMap:(t,e)=>[t.getTrackId(),e.name]}),oO=ut({argsMap:t=>[t.getTrackId()]}),Nt((_n=class extends hO{get isPlaying(){return!(!this._player||this._player.videoElementStatus!==di.PLAYING)}get __className__(){return"RemoteVideoTrack"}constructor(t,e,i,n){super(t,e,i,n),U(this,"_videoVisibleTimer",null),U(this,"_previousVideoVisibleStatus",void 0),U(this,"_clearPreviousVideoVisibleStatus",()=>this._previousVideoVisibleStatus=void 0),U(this,"trackMediaType",Wa.VIDEO),U(this,"_videoWidth",void 0),U(this,"_videoHeight",void 0),U(this,"_player",void 0),U(this,"processorDestination",void 0),U(this,"processorContext",void 0),this.updateMediaStreamTrackResolution(),this.processorContext=new ww(this.getTrackId(),"remote"),this.processorDestination=new Aw(this.processorContext),this.bindProcessorDestinationEvents()}getStats(){return Mo(()=>{_.warning("[deprecated] RemoteVideoTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteVideoStats instead")},"remoteVideoTrackGetStatsWarning"),Ji(this,nt.GET_STATS)||de({},_w)}play(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(typeof t=="string"){let n=document.getElementById(t);n?t=n:(_.warning("[".concat(this.getTrackId(),'] can not find "#').concat(t,'" element, use document.body')),t=document.body)}_.debug("[".concat(this.getTrackId(),"] start video playback in ").concat(t instanceof HTMLVideoElement?"HTMLVideoElement":"HTMLElement"),JSON.stringify(e));let i=de(de({fit:"cover"},e),{},{trackId:this.getTrackId(),element:t});this._player?this._player.updateConfig(i):(t instanceof HTMLVideoElement?this._player=new zf(i):this._player=new Oh(i),this._player.updateVideoTrack(this._mediaStreamTrack),this._player.onFirstVideoFrameDecoded=()=>{this.store.subscribe(this.getUserId(),"video",void 0,void 0,Date.now()),this.safeEmit(Ga.FIRST_FRAME_DECODED)},this._player.onVideoStateChanged=n=>{this.safeEmit(Ga.VIDEO_STATE_CHANGED,n)}),this._player.play(this.store.sessionId||void 0),this._videoVisibleTimer&&window.clearInterval(this._videoVisibleTimer),this._clearPreviousVideoVisibleStatus(),this._videoVisibleTimer=window.setInterval(()=>{try{let n=this.getVideoElementVisibleStatus();this.safeEmit(Ga.VIDEO_ELEMENT_VISIBLE_STATUS,n)}catch{}},A("CHECK_VIDEO_VISIBLE_INTERVAL"))}stop(){this._player&&(this._videoVisibleTimer&&(window.clearInterval(this._videoVisibleTimer),this._videoVisibleTimer=null),this._clearPreviousVideoVisibleStatus(),this._player.destroy(),this._player=void 0,_.debug("[".concat(this.getTrackId(),"] stop video playback")))}getCurrentFrameData(){return this._player?this._player.getCurrentFrame():new ImageData(2,2)}updateMediaStreamTrackResolution(){Dw(this._originMediaStreamTrack).then(t=>{let[e,i]=t;this._videoHeight=i,this._videoWidth=e}).catch(fh)}_updatePlayerSource(){_.debug("[".concat(this.getTrackId(),"] update player source track")),this._player&&this._player.updateVideoTrack(this._mediaStreamTrack)}getVideoElementVisibleStatus(){try{var t,e;let i=this==null||(t=this._player)===null||t===void 0?void 0:t.getContainerElement(),n={track:this,element:this==null||(e=this._player)===null||e===void 0?void 0:e.getVideoElement(),slot:i?.parentElement},{element:r,slot:o}=n;if(this.isPlaying&&r instanceof HTMLVideoElement&&o instanceof HTMLElement){let s=PA.checkOneElementVisible(r),a=Object.assign({},s);if(a.visible!==this._previousVideoVisibleStatus){this._previousVideoVisibleStatus=a.visible;let c=ot.reportApiInvoke(null,{tag:Ee.TRACER,name:be.REMOTE_VIDEO_TRACK_GET_VIDEO_VISIBLE,options:[this.getTrackId()]});a.visible?c.onSuccess("Video is visible"):c.onSuccess("Invisible because of ".concat(a.reason))}return a}return}catch(i){throw new F(C.GET_VIDEO_ELEMENT_VISIBLE_ERROR,i.message)}}pipe(t){if(this.processor===t)return t;if(t._source)throw new F(C.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,context:this.processorContext}),t}unpipe(){if(!this.processor)return;let t=this.processor;this.processor._source=void 0,this.processor=void 0,t.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(gi.ON_TRACK,t=>I(this,null,function*(){t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource()):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())}))}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gi.ON_TRACK)}_destroy(){super._destroy(),this.unbindProcessorDestinationEvents()}_onSei(t){this.emit(ys.SEI_RECEIVED,t)}}).prototype,"play",[iO],Object.getOwnPropertyDescriptor(_n.prototype,"play"),_n.prototype),Nt(_n.prototype,"stop",[nO],Object.getOwnPropertyDescriptor(_n.prototype,"stop"),_n.prototype),Nt(_n.prototype,"pipe",[rO],Object.getOwnPropertyDescriptor(_n.prototype,"pipe"),_n.prototype),Nt(_n.prototype,"unpipe",[oO],Object.getOwnPropertyDescriptor(_n.prototype,"unpipe"),_n.prototype),_n),za=(sO=ut({argsMap:(t,e)=>[t.getTrackId(),e],throttleTime:300}),aO=ut({argsMap:(t,e)=>[t.getTrackId(),e]}),cO=ut({argsMap:t=>[t.getTrackId()]}),dO=ut({argsMap:t=>[t.getTrackId()]}),lO=ut({argsMap:(t,e)=>[t.getTrackId(),e.name]}),uO=ut({argsMap:t=>[t.getTrackId()]}),Nt((hi=class extends hO{get isPlaying(){return this._useAudioElement?Ii.isPlaying(this.getTrackId()):this._source.isPlayed}get __className__(){return"RemoteAudioTrack"}constructor(t,e,i,n){super(t,e,i,n),U(this,"trackMediaType",Wa.AUDIO),U(this,"_source",void 0),U(this,"_useAudioElement",!0),U(this,"_volume",100),U(this,"processorContext",void 0),U(this,"processorDestination",void 0),U(this,"_played",!1),U(this,"_bypassWebAudio",!1),A("DISABLE_WEBAUDIO")?(this._source=new qf,this._bypassWebAudio=!0,this._useAudioElement=!0):(this._source=new Tw(t,!0),A("REMOTE_AUDIO_TRACK_USES_WEB_AUDIO")&&(this._useAudioElement=!1)),this._source.once($i.RECEIVE_TRACK_BUFFER,()=>{this.safeEmit(Ga.FIRST_FRAME_DECODED)}),this.processorContext=new Nw(this._source.context,this.getTrackId(),"remote"),this.processorDestination=new Ow(this.processorContext),this.bindProcessorDestinationEvents(),this._source.on($i.UPDATE_SOURCE,()=>{this.processor&&this.processor.updateInput({node:this._source.processSourceNode,context:this.processorContext})})}setAudioFrameCallback(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:4096;if(!t)return this._source.removeAllListeners($i.ON_AUDIO_BUFFER),void this._source.stopGetAudioBuffer();this._source.startGetAudioBuffer(e),this._source.removeAllListeners($i.ON_AUDIO_BUFFER),this._source.on($i.ON_AUDIO_BUFFER,i=>t(i))}setVolume(t){this._volume=t,this._useAudioElement?Ii.setVolume(this.getTrackId(),t):this._source.setVolume(t/100)}setPlaybackDevice(t){return I(this,null,function*(){if(!this._useAudioElement||!lw())throw new F(C.NOT_SUPPORTED,"your browser does not support setting the audio output device");yield Ii.setSinkID(this.getTrackId(),t)})}getVolumeLevel(){return this._source.getAccurateVolumeLevel()}getStats(){return Mo(()=>{_.warning("[deprecated] RemoteAudioTrack.getStats will be removed in the future, use AgoraRTCClient.getRemoteAudioStats instead")},"remoteAudioTrackGetStatsWarning"),Ji(this,nt.GET_STATS)||de({},pw)}play(){_.debug("[".concat(this.getTrackId(),"] start audio playback")),this._played=!0,this._useAudioElement?(_.debug("[".concat(this.getTrackId(),"] use audio element to play")),Ii.play(this._mediaStreamTrack,this.getTrackId(),this._volume,this.store.sessionId||void 0)):this._source.play()}stop(){_.debug("[".concat(this.getTrackId(),"] stop audio playback")),this._played=!1,this._useAudioElement?Ii.stop(this.getTrackId()):this._source.stop()}_destroy(){super._destroy(),this._played=!1,this.unbindProcessorDestinationEvents(),this._source.destroy()}_isFreeze(){return this._source.isFreeze}_updatePlayerSource(){let t=!(arguments.length>0&&arguments[0]!==void 0)||arguments[0];_.debug("[".concat(this.getTrackId(),"] update player source track")),t&&this._source.updateTrack(this._mediaStreamTrack),this._useAudioElement&&Ii.updateTrack(this.getTrackId(),this._mediaStreamTrack)}pipe(t){if(this._bypassWebAudio)throw new F(C.NOT_SUPPORTED,"can not pipe extension when WebAudio disabled");if(this.processor===t)return t;if(t._source)throw new F(C.INVALID_OPERATION,"Processor ".concat(t.name," already piped, please call unpipe beforehand."));return this.unpipe(),this.processor=t,this.processor._source=this,t.updateInput({track:this._originMediaStreamTrack,node:this._source.processSourceNode,context:this.processorContext}),t}unpipe(){var t;if(this._bypassWebAudio)throw new F(C.NOT_SUPPORTED,"can not unpipe extension when WebAudio disabled");if(!this.processor)return;let e=this.processor;(t=this._source.processSourceNode)===null||t===void 0||t.disconnect(),this.processor._source=!1,this.processor=void 0,e.reset()}bindProcessorDestinationEvents(){this.processorDestination.on(gi.ON_TRACK,t=>I(this,null,function*(){t?t!==this._mediaStreamTrack&&(this._mediaStreamTrack=t,this._updatePlayerSource(!1),this._source.processedNode=this._source.createMediaStreamSourceNode(t)):this._mediaStreamTrack!==this._originMediaStreamTrack&&(this._mediaStreamTrack=this._originMediaStreamTrack,this._updatePlayerSource())})),this.processorDestination.on(gi.ON_NODE,t=>{this._source.processedNode=t;let e=!t;this._useAudioElement!==e&&(this._played?(this.stop(),this._useAudioElement=e,this.play()):this._useAudioElement=e)})}unbindProcessorDestinationEvents(){this.processorDestination.removeAllListeners(gi.ON_TRACK),this.processorDestination.removeAllListeners(gi.ON_NODE)}}).prototype,"setVolume",[sO],Object.getOwnPropertyDescriptor(hi.prototype,"setVolume"),hi.prototype),Nt(hi.prototype,"setPlaybackDevice",[aO],Object.getOwnPropertyDescriptor(hi.prototype,"setPlaybackDevice"),hi.prototype),Nt(hi.prototype,"play",[cO],Object.getOwnPropertyDescriptor(hi.prototype,"play"),hi.prototype),Nt(hi.prototype,"stop",[dO],Object.getOwnPropertyDescriptor(hi.prototype,"stop"),hi.prototype),Nt(hi.prototype,"pipe",[lO],Object.getOwnPropertyDescriptor(hi.prototype,"pipe"),hi.prototype),Nt(hi.prototype,"unpipe",[uO],Object.getOwnPropertyDescriptor(hi.prototype,"unpipe"),hi.prototype),hi),Ir=new class extends ue{get visibility(){return document.visibilityState}get lastHiddenTime(){return this._lastHiddenTime}get lastVisibleTime(){return this._lastVisibleTime}constructor(){super(),U(this,"_lastHiddenTime",0),U(this,"_lastVisibleTime",0),document.addEventListener("visibilitychange",()=>{document.visibilityState==="hidden"?this._lastHiddenTime=performance.now():this._lastVisibleTime=performance.now(),_.debug("current web page is ".concat(document.visibilityState)),this.emit("VISIBILITY_CHANGE",document.visibilityState)})}};class pO extends ue{constructor(e,i){super(),U(this,"trackMediaType",Wa.DATA),U(this,"_version",1),U(this,"_type",3),U(this,"_config",void 0),U(this,"_originDataChannel",void 0),U(this,"_dataStreamPacketHeader",new ArrayBuffer(4)),U(this,"_dataStreamPacketHandler",{serialize:n=>n,deserialize:n=>n}),U(this,"_datachannelEventMap",new Map),this._config=e,i&&(this._originDataChannel=i,this._bandDataChannelEvents(i)),this._initPacketHeader()}useDataStream(e){this._dataStreamPacketHandler=e}get id(){return this._config.id}get ordered(){return this._config.ordered}get maxRetransmits(){return A("DATASTREAM_MAX_RETRANSMITS")}get metadata(){return this._config.metadata}get readyState(){var e,i;return(e=(i=this._originDataChannel)===null||i===void 0?void 0:i.readyState)!==null&&e!==void 0?e:"connecting"}get _originDataChannelId(){var e,i;return(e=(i=this._originDataChannel)===null||i===void 0?void 0:i.id)!==null&&e!==void 0?e:null}getChannelId(){return this.id}getConfig(){return this._config}_close(){this._originDataChannel&&(this._unbindDataChannelEvents(this._originDataChannel),this._originDataChannel=void 0)}_waitTillOpen(){return I(this,null,function*(){return new Q((e,i)=>{if(this._originDataChannel){this._originDataChannel.readyState==="open"&&e();let n=setTimeout(()=>{var r;i(new F(C.DATACHANNEL_CONNECTION_TIMEOUT,"Cannot create datachannel, id: ".concat((r=this._originDataChannel)===null||r===void 0?void 0:r.id)))},1e4);this._originDataChannel.onopen=()=>{clearTimeout(n),this._originDataChannel&&this._bandDataChannelEvents(this._originDataChannel),e()},this._originDataChannel.onerror=()=>{throw clearTimeout(n),new F(C.DATACHANNEL_CONNECTION_TIMEOUT)}}else i(new F(C.DATACHANNEL_CONNECTION_TIMEOUT,"cannot find dataChannel"))})})}_updateOriginDataChannel(e){this._originDataChannel=e,this._bandDataChannelEvents(e)}_initPacketHeader(){let e=new DataView(this._dataStreamPacketHeader);e.setUint16(0,this._version),e.setUint8(2,this._type),e.setUint8(3,this._config.id)}_bandDataChannelEvents(e){this._unbindDataChannelEvents(e),[Ih.OPEN,Ih.CLOSE,Ih.ERROR].forEach(i=>{let n=()=>{this.emit(i)};this._datachannelEventMap.set(i,n),e.addEventListener(i,n)})}_unbindDataChannelEvents(e){Array.from(this._datachannelEventMap.entries()).forEach(i=>{let[n,r]=i;e.removeEventListener(n,r)}),this._datachannelEventMap.clear()}}class GK extends pO{constructor(e){super(e),U(this,"_messageListener",void 0),this._messageListener=i=>{if(i.data.byteLength<this._dataStreamPacketHeader.byteLength)throw Error("invalid byteLength: the byte length must exceed "+this._dataStreamPacketHeader.byteLength);let n=i.data.slice(0,this._dataStreamPacketHeader.byteLength),r=new DataView(n).getUint8(3);if(r!==this.id)return void(A("SHOW_DATASTREAM2_LOG")&&_.debug("invalid datachannel id: ".concat(r," !== ").concat(this.id)));let o=i.data.slice(this._dataStreamPacketHeader.byteLength);o=this._dataStreamPacketHandler.deserialize(o),this.emit(Ih.MESSAGE,o)}}_updateOriginDataChannel(e){super._updateOriginDataChannel(e),this._bandRemoteDataChannelEvents()}_close(){this._originDataChannel&&(this._originDataChannel.removeEventListener("message",this._messageListener),super._close())}_bandRemoteDataChannelEvents(){this._originDataChannel&&this._originDataChannel.addEventListener("message",this._messageListener)}}class WK extends pO{send(e){if(this._originDataChannel){let i=e;i=this._dataStreamPacketHandler.serialize(e);let n=new Uint8Array(this._dataStreamPacketHeader.byteLength+i.byteLength);n.set(new Uint8Array(this._dataStreamPacketHeader),0),n.set(new Uint8Array(i),this._dataStreamPacketHeader.byteLength),this._originDataChannel.send(n.buffer)}}}function Nh(){let t=new Blob([atob("ZnVuY3Rpb24gdCh0LGUsbil7bGV0IGE9bmV3IFVpbnQ4QXJyYXkodCxlLG4pLG89W10scj0wO2Zvcig7by5sZW5ndGg8bjspciszPG4mJjA9PT1hW3JdJiYwPT09YVtyKzFdJiYzPT09YVtyKzJdJiYoMD09PWFbciszXXx8MT09PWFbciszXXx8Mj09PWFbciszXXx8Mz09PWFbciszXSk/KG8ucHVzaChhW3JdLGFbcisxXSxhW3IrM10pLHIrPTQpOihvLnB1c2goYVtyXSkscisrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkobyl9ZnVuY3Rpb24gZSh0LGUpe2NvbnN0IG49ZnVuY3Rpb24odCl7Y29uc3QgZT10Lmxlbmd0aDtsZXQgbj1bXSxhPTA7Zm9yKDthPGU7KWErMjxlJiYwPT09dFthXSYmMD09PXRbYSsxXSYmKDA9PT10W2ErMl18fDE9PT10W2ErMl18fDI9PT10W2ErMl18fDM9PT10W2ErMl0pPyhuLnB1c2godFthXSx0W2ErMV0sMyx0W2ErMl0pLGErPTMpOihuLnB1c2godFthXSksYSsrKTtyZXR1cm4gbmV3IFVpbnQ4QXJyYXkobil9KGUpLGE9bi5sZW5ndGgsbz1NYXRoLmZsb29yKGEvMjU1KSxyPWElMjU1LHM9bmV3IFVpbnQ4QXJyYXkoNitvKzErYSt0LmJ5dGVMZW5ndGgpO3NbMF09MCxzWzFdPTAsc1syXT0wLHNbM109MSxzWzRdPTYsc1s1XT0xMDE7bGV0IGk9MDtmb3IoO2k8bzspc1s2K2ldPTI1NSxpKys7cmV0dXJuIHNbNitpXT1yLGkrKyxzLnNldChuLDYraSkscy5zZXQobmV3IFVpbnQ4QXJyYXkodCksNitpK2EpLHMuYnVmZmVyfWNvbnN0IG49NzEsYT0xLG89MixyPTEscz0yO3ZhciBpOyFmdW5jdGlvbih0KXt0W3QuQVVESU9fTEVWRUw9MV09IkFVRElPX0xFVkVMIix0W3QuTUVUQURBVEE9Ml09Ik1FVEFEQVRBIix0W3QuQVVESU9fNjRfQklUX1BUUz0zXT0iQVVESU9fNjRfQklUX1BUUyJ9KGl8fChpPXt9KSk7bmF2aWdhdG9yLnVzZXJBZ2VudC5pbmRleE9mKCJTYWZhcmkiKT4tMSYmLTE9PT1uYXZpZ2F0b3IudXNlckFnZW50LmluZGV4T2YoIkNocm9tZSIpJiYoc2VsZi5vbnJ0Y3RyYW5zZm9ybT1mPT57Y29uc3QgdT1mLnRyYW5zZm9ybWVyO2xldCBkPVtdLGw9W107dS5vcHRpb25zLnBvcnQub25tZXNzYWdlPXQ9Pnt0LmRhdGEuc2VpJiZkLnB1c2godC5kYXRhLnNlaSksdC5kYXRhLm1ldGFkYXRhJiZsLnB1c2godC5kYXRhLm1ldGFkYXRhKX0sc2VsZi5wb3N0TWVzc2FnZSgic3RhcnRlZCIpO2NvbnN0IGc9dS5yZWFkYWJsZS5nZXRSZWFkZXIoKSxjPXUud3JpdGFibGUuZ2V0V3JpdGVyKCk7InNlaS1yeCI9PT11Lm9wdGlvbnMubmFtZT9mdW5jdGlvbiBlKG4pe2cucmVhZCgpLnRoZW4oKGE9PntpZighYS5kb25lKXtpZihhLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IGU9ZnVuY3Rpb24oZSl7Y29uc3Qgbj1uZXcgRGF0YVZpZXcoZS5kYXRhKTtsZXQgYT0wO2Zvcig7YSs0PGUuZGF0YS5ieXRlTGVuZ3RoOyl7aWYoMD09PW4uZ2V0VWludDgoYSswKSYmMD09PW4uZ2V0VWludDgoYSsxKSYmMD09PW4uZ2V0VWludDgoYSsyKSYmMT09PW4uZ2V0VWludDgoYSszKSYmNj09PW4uZ2V0VWludDgoYSs0KSl7bGV0IG89YSs2LHI9MCxzPTA7Zm9yKDsyNTU9PT0ocz1uLmdldFVpbnQ4KG8rKykpOylyKz0yNTU7cis9cztjb25zdCBpPXQoZS5kYXRhLG8scik7cmV0dXJuIG5ldyBVaW50OEFycmF5KGkpfWErK31yZXR1cm4gbnVsbH0oYS52YWx1ZSk7ZSYmbi5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3NlaTplfSl9Yy53cml0ZShhLnZhbHVlKSxuLm9wdGlvbnMucG9ydC5wb3N0TWVzc2FnZSh7dHJhbnNmb3JtZWQ6ITB9KSxlKG4pfX0pKX0odSk6InNlaS10eCI9PT11Lm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KG4pe2cucmVhZCgpLnRoZW4oKGE9PntpZighYS5kb25lKXtpZihhLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZFZpZGVvRnJhbWUpe2NvbnN0IHQ9ZC5zaGlmdCgpO3QmJihhLnZhbHVlLmRhdGE9ZShhLnZhbHVlLmRhdGEsdCkpfWMud3JpdGUoYS52YWx1ZSksbi5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3RyYW5zZm9ybWVkOiEwfSksdChuKX19KSl9KHUpOiJhdWRpby1tZXRhZGF0YS1yeCI9PT11Lm9wdGlvbnMubmFtZT9mdW5jdGlvbiB0KGUpe2cucmVhZCgpLnRoZW4oKGY9PntpZighZi5kb25lKXtpZihmLnZhbHVlIGluc3RhbmNlb2YgUlRDRW5jb2RlZEF1ZGlvRnJhbWUpe2NvbnN0IHQ9ZnVuY3Rpb24odCxlPSExKXtjb25zdCBmPXQuZ2V0VWludDgoMCk7aWYoZiE9PW4pcmV0dXJuO2NvbnN0IHU9dC5nZXRVaW50MTYoMSksZD1hK28rdSxsPW5ldyBVaW50OEFycmF5KHQuYnl0ZUxlbmd0aC1kKTtsLnNldChuZXcgVWludDhBcnJheSh0LmJ1ZmZlcixkLHQuYnl0ZUxlbmd0aC1kKSk7Y29uc3QgZz17bTpmLHRsdkxlbjp1LHRsdjpbXSxmcmFtZTpsfTtsZXQgYz1hK287Zm9yKDtjPGQ7KXtjb25zdCBuPXQuZ2V0VWludDgoYyksYT10LmdldFVpbnQxNihjK3IpLG89citzO2lmKG49PT1pLkFVRElPX0xFVkVMKXtsZXQgcj10LmdldFVpbnQ4KGMrbyk7Zm9yKGxldCBlPTE7ZTxhO2UrKylyPXI8PDh8dC5nZXRVaW50OChjK28rZSk7Zy50bHYucHVzaCh7dGFnOm4sbGVuZ3RoOmEsdmFsdWU6ZT8xMjdecj4+MToxMjcmcn0pfWVsc2UgaWYobj09PWkuTUVUQURBVEF8fG49PT1pLkFVRElPXzY0X0JJVF9QVFMpe2NvbnN0IGU9bmV3IFVpbnQ4QXJyYXkoYSk7Zm9yKGxldCBuPTA7bjxhO24rKyllW25dPXQuZ2V0VWludDgoYytvK24pO2cudGx2LnB1c2goe3RhZzpuLGxlbmd0aDphLHZhbHVlOmV9KX1jKz1vK2F9cmV0dXJuIGd9KG5ldyBEYXRhVmlldyhmLnZhbHVlLmRhdGEpKTtpZih0KXtjb25zdCBuPXQudGx2LmZpbmQoKHQ9PnQudGFnPT09aS5NRVRBREFUQXx8dC50YWc9PT1pLkFVRElPXzY0X0JJVF9QVFMpKTtuJiZuLnZhbHVlIGluc3RhbmNlb2YgVWludDhBcnJheSYmZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe21ldGFkYXRhOm4udmFsdWV9KSxmLnZhbHVlLmRhdGE9dC5mcmFtZS5idWZmZXJ9fWMud3JpdGUoZi52YWx1ZSksZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe3RyYW5zZm9ybWVkOiEwfSksdChlKX19KSl9KHUpOiJhdWRpby1tZXRhZGF0YS10eCI9PT11Lm9wdGlvbnMubmFtZSYmZnVuY3Rpb24gdChlKXtnLnJlYWQoKS50aGVuKChmPT57aWYoIWYuZG9uZSl7aWYoZS5vcHRpb25zLnBvcnQucG9zdE1lc3NhZ2Uoe2dldE1ldGFkYXRhOiEwfSksZi52YWx1ZSBpbnN0YW5jZW9mIFJUQ0VuY29kZWRBdWRpb0ZyYW1lKXtjb25zdCB0PWwuc2hpZnQoKTt0JiYoZi52YWx1ZS5kYXRhPWZ1bmN0aW9uKHQsZSxpKXtjb25zdCBmPWkuYnl0ZUxlbmd0aCx1PWYrcitzLGQ9YStvK3UsbD1uZXcgQXJyYXlCdWZmZXIodC5ieXRlTGVuZ3RoK2QpLGc9bmV3IERhdGFWaWV3KGwpO2cuc2V0VWludDgoMCxuKSxnLnNldFVpbnQxNigxLHUpLGcuc2V0VWludDgoMyxlKSxnLnNldFVpbnQxNig0LGYpO2ZvcihsZXQgdD0wO3Q8Zjt0KyspZy5zZXRVaW50OCg2K3QsaVt0XSk7Y29uc3QgYz1uZXcgVWludDhBcnJheShnLmJ1ZmZlcik7cmV0dXJuIGMuc2V0KG5ldyBVaW50OEFycmF5KHQpLGQpLGMuYnVmZmVyfShmLnZhbHVlLmRhdGEsaS5BVURJT182NF9CSVRfUFRTLHQpKX1jLndyaXRlKGYudmFsdWUpLGUub3B0aW9ucy5wb3J0LnBvc3RNZXNzYWdlKHt0cmFuc2Zvcm1lZDohMH0pLHQoZSl9fSkpfSh1KX0sc2VsZi5wb3N0TWVzc2FnZSgicmVnaXN0ZXJlZCIpKTsK")],{type:"text/javascript"});return setTimeout(()=>Ou.revokeObjectURL(t),0),new Worker(Ou.createObjectURL(t))}let _O=71,Qf=1,Zf=2,$f=1,mO=2;var to=function(t){return t[t.AUDIO_LEVEL=1]="AUDIO_LEVEL",t[t.METADATA=2]="METADATA",t[t.AUDIO_64_BIT_PTS=3]="AUDIO_64_BIT_PTS",t}(to||{});function EO(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],i=t.getUint8(0);if(i!==_O)return;let n=t.getUint16(1),r=Qf+Zf+n,o=new Uint8Array(t.byteLength-r);o.set(new Uint8Array(t.buffer,r,t.byteLength-r));let s={m:i,tlvLen:n,tlv:[],frame:o},a=Qf+Zf;for(;a<r;){let c=t.getUint8(a),d=t.getUint16(a+$f),l=$f+mO;if(c===to.AUDIO_LEVEL){let u=t.getUint8(a+l);for(let h=1;h<d;h++)u=u<<8|t.getUint8(a+l+h);s.tlv.push({tag:c,length:d,value:e?127^u>>1:127&u})}else if(c===to.METADATA||c===to.AUDIO_64_BIT_PTS){let u=new Uint8Array(d);for(let h=0;h<d;h++)u[h]=t.getUint8(a+l+h);s.tlv.push({tag:c,length:d,value:u})}a+=l+d}return s}let Dh=new Map,Ph=127,Is=1e-10,tg=139/13,Lh=new Map;function eg(t,e,i){let n="".concat(t,"-").concat(e,"-").concat(i),r=0;return Lh.has(n)?r=Lh.get(n):(r=Math.log(function(s,a){let c=s-a;a<c&&(a=c);let d=1;for(let l=s,u=1;l>a;l--,u++)d=d*l/u;return d}(e,t))+t*Math.log(.5)+(e-t)*Math.log(1-.5)-Math.log(i)+i*t,Lh.set(n,r)),r<Is&&(r=Is),r}function fO(t,e,i){let n=e.length,r=t.length/n,o=!1;for(let s=0,a=0;s<n;s++){let c=0;for(let d=a+r;a<d;a++)t[a]>i&&c++;e[s]!==c&&(e[s]=c,o=!0)}return o}window.cache=Lh;let HK=0;class gO{constructor(e){U(this,"id",void 0),U(this,"immediates",[]),U(this,"lastNonSilence",-1),U(this,"immediateSpeechActivityScore",Is),U(this,"lastLevelChangedTime",Date.now()),U(this,"levels",[]),U(this,"longs",[]),U(this,"longSpeechActivityScore",Is),U(this,"mediums",[]),U(this,"mediumSpeechActivityScore",Is),U(this,"minLevel",0),U(this,"nextMinLevel",0),U(this,"nextMinLevelWindowLength",0),U(this,"energyScore",0),this.id=e||"".concat(HK++),this.immediates.length=50,this.mediums.length=10,this.longs.length=1,this.levels.length=this.immediates.length}computeImmediates(){let e=this.immediates,i=this.levels,n=this.minLevel+tg,r=!1;for(let o=0;o<e.length;++o){let s=i[o];s<n&&(s=0);let a=Math.floor(s/tg);e[o]!==a&&(e[o]=a,r=!0)}return r}computeLongs(){return fO(this.mediums,this.longs,4)}computeMediums(){return fO(this.immediates,this.mediums,7)}evaluateImmediateSpeechActivityScore(){this.immediateSpeechActivityScore=eg(this.immediates[0],13,.78)}evaluateLongSpeechActivityScore(e){this.longSpeechActivityScore=eg(this.longs[0],10,47),this.longSpeechActivityScore>Is&&(this.lastNonSilence=e)}evaluateMediumSpeechActivityScore(){this.mediumSpeechActivityScore=eg(this.mediums[0],5,24)}evaluateSpeechActivityScores(e){this.computeImmediates()&&(this.evaluateImmediateSpeechActivityScore(),this.computeMediums()&&(this.evaluateMediumSpeechActivityScore(),this.computeLongs()&&this.evaluateLongSpeechActivityScore(e)))}getLastLevelChangedTime(){return this.lastLevelChangedTime}getLevels(){var e;return"[".concat(tR(e=[...this.levels]).call(e).join(),"]")}getSpeechActivityScore(e){switch(e){case 0:return this.immediateSpeechActivityScore;case 1:return this.mediumSpeechActivityScore;case 2:return this.longSpeechActivityScore;default:throw new Error("interval "+e)}}levelChanged(e,i){if(this.lastLevelChangedTime<=i){this.lastLevelChangedTime=i;let n=e;return e<0&&(n=0),e>Ph&&(n=Ph),this.levels.unshift(n),this.levels.length>this.immediates.length&&this.levels.pop(),this.updateMinLevel(n),n>=this.minLevel+tg?n:n/2}return-1}levelTimedOut(){this.levelChanged(0,this.lastLevelChangedTime)}updateMinLevel(e){if(e!==0){if(this.minLevel===0||this.minLevel>e)return this.minLevel=e,this.nextMinLevel=0,void(this.nextMinLevelWindowLength=0);if(this.nextMinLevel===0)return this.nextMinLevel=e,void(this.nextMinLevelWindowLength=1);if(this.nextMinLevel>e&&(this.nextMinLevel=e),this.nextMinLevelWindowLength++,this.nextMinLevelWindowLength>=750){let i=Math.sqrt(this.minLevel*this.nextMinLevel);i<0?i=0:i>Ph&&(i=Ph),this.minLevel=i,this.nextMinLevel=0,this.nextMinLevelWindowLength=0}}}}class KK{constructor(e){U(this,"algorithm",void 0),this.algorithm=e}execute(){let e=!this.algorithm;if(!e)try{let i=this.algorithm.runInDecisionMaker(this);i<=0?e=!0:setTimeout(this.execute.bind(this),i)}catch{e=!0}e&&this.algorithm&&this.algorithm.decisionMakerExited(this)}}class ig{constructor(e,i,n){U(this,"isDominant",void 0),U(this,"energyRanking",void 0),U(this,"energyScore",void 0),this.isDominant=e,this.energyRanking=i,this.energyScore=n}}class qK extends ue{constructor(e){super(),U(this,"dominantId",null),U(this,"lastDecisionTime",0),U(this,"lastLevelChangedTime",0),U(this,"lastLevelIdleTime",0),U(this,"relativeSpeechActivities",[]),U(this,"speakers",new Map),U(this,"enableSilence",!1),U(this,"timeoutToSilenceInterval",0),U(this,"decisionMaker",null),U(this,"loudest",[]),U(this,"numLoudestToTrack",3),U(this,"energyExpireTimeMs",250),U(this,"energyAlphaPct",50),this.timeoutToSilenceInterval=e,this.enableSilence=e>0,this.relativeSpeechActivities.length=3}setLoudestConfig(){let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:3,i=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0;this.numLoudestToTrack=e,i!=null&&(this.energyExpireTimeMs=i),n!=null&&(this.energyAlphaPct=n),this.loudest.length>e&&this.loudest.splice(e)}getDominantSpeaker(){return this.dominantId}isAmongLoudest(e){return this.loudest.some(i=>i.id===e)}levelChanged(e,i){let n=Date.now(),r=this.getOrCreateSpeaker(e);this.lastLevelChangedTime<n&&(this.lastLevelChangedTime=n,this.maybeStartDecisionMaker());let o=r.levelChanged(i,n);return this.updateLoudestList(r,o,n)}runInDecisionMaker(e){return this.decisionMaker!==e||this.lastDecisionTime>0&&this.lastDecisionTime-this.lastLevelChangedTime>=15e3?-1:this._runInDecisionMaker()}decisionMakerExited(e){this.decisionMaker===e&&(this.decisionMaker=null)}destroy(){this.decisionMaker=null,this.loudest.length=0,this.speakers.clear(),this.removeAllListeners()}addSpeakers(e){e.forEach(i=>{this.speakers.has(i.id)||this.speakers.set(i.id,i)})}removeSpeakers(e){e.forEach(i=>{this.speakers.delete(i.id)})}getOrCreateSpeaker(e){let i=this.speakers.get(e);return i||(i=new gO(e),this.speakers.set(e,i),this.maybeStartDecisionMaker()),i}updateLoudestList(e,i,n){let r=e.id===this.dominantId;if(i<0){let c=0;for(;c<this.loudest.length&&this.loudest[c]!==e;)++c;return new ig(r,c,e.energyScore)}if(e.energyScore=Math.floor((this.energyAlphaPct*i+(100-this.energyAlphaPct)*e.energyScore+50)/100),this.numLoudestToTrack===0)return new ig(r,0,e.energyScore);let o=n-this.energyExpireTimeMs,s=0;for(;s<this.loudest.length;){let c=this.loudest[s];if(c.getLastLevelChangedTime()<o&&this.loudest.length>=this.numLoudestToTrack)this.loudest.splice(s,1);else if(c.id!==e.id)++s;else if(this.loudest.splice(s,1),this.loudest.length<this.numLoudestToTrack)break}let a=0;for(;a<this.loudest.length&&!(this.loudest[a].energyScore<e.energyScore);)++a;return a<this.numLoudestToTrack&&(this.loudest.splice(a,0,e),this.loudest.length>this.numLoudestToTrack&&this.loudest.splice(this.numLoudestToTrack,1)),new ig(r,a,e.energyScore)}maybeStartDecisionMaker(){!this.decisionMaker&&this.speakers.size>0&&(this.decisionMaker=new KK(this),this.decisionMaker.execute())}makeDecision(e){let i=null,n=null,r=this.speakers.size,o=null;if(r===0)o=null;else if(r===1){var s;let a=Bi(s=this.speakers).call(s).next().value;this.enableSilence&&a&&(o=a.id,a.evaluateSpeechActivityScores(e),e-a.lastNonSilence>this.timeoutToSilenceInterval&&(o=null))}else{let a=this.dominantId==null?null:this.speakers.get(this.dominantId);if(a==null){let l=this.speakers.entries().next();l.value&&(o=l.value[0],a=l.value[1])}else o=a.id;a?.evaluateSpeechActivityScores(e);let c=this.relativeSpeechActivities,d=2;for(let l of this.speakers.entries()){let[u,h]=l;if(h===a)continue;h.evaluateSpeechActivityScores(e);for(let f=0;f<c.length;++f){let R=a==null?Is:a.getSpeechActivityScore(f);c[f]=Math.log(h.getSpeechActivityScore(f)/R)}let p=c[0],g=c[1],E=c[2];p>3&&g>2&&E>0&&g>d&&(d=g,o=u)}this.enableSilence&&a!=null&&o===a.id&&e-a.lastNonSilence>this.timeoutToSilenceInterval&&(o=null)}o==null&&!this.enableSilence||o===this.dominantId||(i=this.dominantId,this.dominantId=o,n=this.dominantId),n==null&&!this.enableSilence||n===i||this.emit("ActiveSpeakerChanged",n)}_runInDecisionMaker(){let e=Date.now(),i=300-(e-this.lastLevelIdleTime),n=0;i<=0?(this.lastLevelIdleTime!==0&&this.timeoutIdleLevels(e),this.lastLevelIdleTime=e):n=i;let r=300-(e-this.lastDecisionTime);return r<=0&&(this.lastDecisionTime=e,this.makeDecision(e),r=300-(Date.now()-e)),r>0&&n>r&&(n=r),n}timeoutIdleLevels(e){let i=[];for(let r of Bi(n=this.speakers).call(n)){var n;let o=e-r.getLastLevelChangedTime();36e5<o&&(this.dominantId==null||r.id!==this.dominantId)?i.push(r.id):300<o&&r.levelTimedOut()}i.forEach(r=>this.speakers.delete(r))}}let Xa=new Map,nr=null,kh=null,SO=3,As=[],rr=new Map,Mh=new Map;class YK{get samples(){return this.actives+this.inactives}get activeRate(){return this.actives/this.samples}constructor(e,i){U(this,"id",void 0),U(this,"track",void 0),U(this,"score",0),U(this,"active",!0),U(this,"muted",!1),U(this,"timer",0),U(this,"actives",0),U(this,"inactives",0),this.id=e,this.track=i,this.setActive(rr.size<3)}autoCheckActive(){this.autoSetActive(),this.autoAdjustActive(),this.resetTimer(),this.actives=0,this.inactives=0}autoSetActive(){let e=this.active;this.active=this.activeRate>=.8;let{actives:i,inactives:n}=function(){let r=[],o=[];return Array.from(Bi(rr).call(rr)).forEach(s=>{s.active?r.push(s):o.push(s)}),{actives:r,inactives:o}}();if(i.length>3){let r;i.forEach(o=>{(!r||r.score>o.score)&&(r=o)}),r&&r.setActive(!1)}if(i.length<3&&n.length>0){let r;n.forEach(o=>{(!r||r.score<o.score)&&o.id!==this.id&&(r=o)}),r&&e&&!this.active&&(r.samples>40&&r.activeRate-this.activeRate>.4?r.setActive(!0):this.active=!0)}this.setMuted(!this.active)}setActive(e){this.active=e,this.resetTimer(),this.setMuted(!e)}autoAdjustActive(){this.active?this.autoSwitchToInactive():this.autoSwitchToActive()}autoSwitchToActive(){let e=function(i){let n;return Array.from(Bi(rr).call(rr)).forEach(r=>{!r.active||r.id===i||r.samples<40||(!n||r.score<n.score)&&(n=r)}),n}(this.id);e&&this.activeRate-e.activeRate>.4&&(e.setActive(!1),this.setActive(!0))}autoSwitchToInactive(){let e=function(i){let n;return Array.from(Bi(rr).call(rr)).forEach(r=>{r.active||r.id===i||r.samples<40||(!n||r.score>n.score)&&(n=r)}),n}(this.id);e&&e.activeRate-this.activeRate>.4&&(e.setActive(!0),this.setActive(!1))}addSample(e){e?this.actives+=1:this.inactives+=1,this.samples>66.66666666666667&&this.autoCheckActive()}setMuted(e){this.track&&(this.track.enabled=!e,this.muted=e)}resetTimer(){this.clearTimer(),this.timer=window.setTimeout(()=>{if(this.samples!==0)return this.samples<50?this.resetTimer():void this.autoCheckActive()},1e3)}clearTimer(){this.timer&&(clearTimeout(this.timer),this.timer=0)}}let Uh;function TO(t){let e=rr.get(t);e&&(rr.delete(t),e.clearTimer())}let xh=new Map,zK=new Map;function XK(t,e,i){let n=new Uint8Array(t,e,i),r=[],o=0;for(;r.length<i;)o+3<i&&n[o]===0&&n[o+1]===0&&n[o+2]===3&&(n[o+3]===0||n[o+3]===1||n[o+3]===2||n[o+3]===3)?(r.push(n[o],n[o+1],n[o+3]),o+=4):(r.push(n[o]),o++);return new Uint8Array(r)}let Vh=new Map,Id=new Map;(function(){let t=kt();Ye.getDisplayMedia=!(!navigator.mediaDevices||!navigator.mediaDevices.getDisplayMedia),Ye.getStreamFromExtension=t.name===xt.CHROME&&Number(t.version)>34,Ye.supportUnifiedPlan=function(){if(!window.RTCRtpTransceiver||!("currentDirection"in RTCRtpTransceiver.prototype))return!1;let e=new RTCPeerConnection,i=!1;try{e.addTransceiver("audio"),i=!0}catch{}return e.close(),i}(),Ye.supportMinBitrate=t.name===xt.CHROME||t.name===xt.EDGE,Ye.supportSetRtpSenderParameters=function(){let e=kt();return!!(window.RTCRtpSender&&window.RTCRtpSender.prototype.setParameters&&window.RTCRtpSender.prototype.getParameters)&&(!!Qr()||!(!Qe()&&!ph())||e.name===xt.FIREFOX&&Number(e.version)>=64)}(),t.name===xt.SAFARI&&(Number(t.version)>=14?Ye.supportDualStream=!0:Ye.supportDualStream=!1),Ye.webAudioMediaStreamDest=function(){let e=kt();return!(e.name===xt.SAFARI&&Number(e.version)<12)}(),Ye.supportReplaceTrack=!!window.RTCRtpSender&&typeof RTCRtpSender.prototype.replaceTrack=="function",Ye.supportWebGL=typeof WebGLRenderingContext<"u",Ye.supportRequestFrame=!!window.CanvasCaptureMediaStreamTrack,Qr()||(Ye.webAudioWithAEC=!0),Ye.supportShareAudio=function(){let e=kt();return(e.os===Ve.WIN_10||e.os===Ve.WIN_81||e.os===Ve.WIN_7||e.os===Ve.LINUX||e.os===Ve.MAC_OS||e.os===Ve.CHROMIUM_OS)&&e.name===xt.CHROME&&Number(e.version)>=74}(),Ye.supportDataChannel=!!(_d(76)||function(e){let i=kt();return!(i.name!==xt.FIREFOX||!i.osVersion)&&Number(i.version)>=e}(68)||yA(14)),Ye.supportPCSetConfiguration=function(){let e=window.RTCPeerConnection;return!_e()&&!!e&&e.prototype.setConfiguration instanceof Function}(),Ye.supportWebRTCEncodedTransform=function(){let e=kt();return e.name==="Chrome"&&Number(e.version)>=87||e.name==="Safari"&&Number(e.version)>=15}(),Ye.supportWebRTCInsertableStream=function(){let e=kt();return(e.name===xt.CHROME||e.name===xt.EDGE)&&Number(e.version)>=94&&"MediaStreamTrackGenerator"in window&&"MediaStreamTrackProcessor"in window}(),Ye.supportRequestVideoFrameCallback="requestVideoFrameCallback"in HTMLVideoElement.prototype,Ye.supportWebCrypto=typeof window<"u"&&window.crypto!==void 0&&window.crypto.subtle!==void 0,Eh(()=>{Ye.supportDualStreamEncoding=function(){let e=kt();return!!A("DISABLE_WEBAUDIO")||e.name==="Safari"&&Number(e.version)>=14||!!(e.name==="Chrome"&&/Windows/i.test(e.os||"")&&Number(e.version)>=100&&A("CHROME_DUAL_STREAM_USE_ENCODING"))}(),_.debug("browser ua: ",navigator.userAgent),_.info("browser info: ",t),_.info("browser compatibility: ",Ye)})})();let JK=["CHINA","GLOBAL"],RO=[[0,1,2,3,4,5,5],[0,2,2,3,4,5,5],[0,3,3,3,4,5,5],[0,4,4,4,4,5,5],[0,5,5,5,5,5,5]],ws=[],Ja=[];function Os(t,e){return!!e&&ws.some(i=>i.uid===t&&i.channelName===e)}function ng(){return Ja.length>0}var QK=jb.forEach,vO=jl("forEach")?[].forEach:function(t){return QK(this,t,arguments.length>1?arguments[1]:void 0)};Ht({target:"Array",proto:!0,forced:[].forEach!==vO},{forEach:vO});var ZK=Cn("Array","forEach"),$K=bo,t6=ai,e6=Wt,i6=ZK,rg=Array.prototype,n6={DOMTokenList:!0,NodeList:!0},r6=function(t){var e=t.forEach;return t===rg||e6(rg,t)&&e===rg.forEach||t6(n6,$K(t))?i6:e},o6=b(r6),s6=Er,yO=Yl;Ht({target:"Object",stat:!0,forced:O(function(){yO(1)})},{keys:function(t){return yO(s6(t))}});var a6=b(dn.Object.keys),c6=b(QT),d6=b($T),l6=Ht,CO=Vc,u6=au,h6=yi,bO=b_,p6=Co,_6=vo,m6=Hm,E6=Pe,f6=Ao,g6=Db("slice"),S6=E6("species"),og=Array,T6=Math.max;l6({target:"Array",proto:!0,forced:!g6},{slice:function(t,e){var i,n,r,o=_6(this),s=p6(o),a=bO(t,s),c=bO(e===void 0?s:e,s);if(CO(o)&&(i=o.constructor,(u6(i)&&(i===og||CO(i.prototype))||h6(i)&&(i=i[S6])===null)&&(i=void 0),i===og||i===void 0))return f6(o,a,c);for(n=new(i===void 0?og:i)(T6(c-a,0)),r=0;a<c;a++,r++)a in o&&m6(n,r,o[a]);return n.length=r,n}});var R6=Cn("Array","slice"),v6=Wt,y6=R6,sg=Array.prototype,C6=function(t){var e=t.slice;return t===sg||v6(sg,t)&&e===sg.slice?y6:e},b6=b(C6);function rt(t,e,i,n,r){var o,s,a,c={};return o6(o=a6(n)).call(o,function(d){c[d]=n[d]}),c.enumerable=!!c.enumerable,c.configurable=!!c.configurable,("value"in c||c.initializer)&&(c.writable=!0),c=c6(s=d6(a=b6(i).call(i)).call(a)).call(s,function(d,l){return l(t,e,d)||d},c),r&&c.initializer!==void 0&&(c.value=c.initializer?c.initializer.call(r):void 0,c.initializer=void 0),c.initializer===void 0?(Ab(t,e,c),null):c}let Fh=function(t){return t[t.ACCESS_POINT=101]="ACCESS_POINT",t[t.UNILBS=201]="UNILBS",t[t.STRING_UID_ALLOCATOR=901]="STRING_UID_ALLOCATOR",t}({}),ag=function(t){return t[t.IIIEGAL_APPID=1]="IIIEGAL_APPID",t[t.IIIEGAL_UID=2]="IIIEGAL_UID",t[t.INTERNAL_ERROR=3]="INTERNAL_ERROR",t}({}),Un=function(t){return t[t.INVALID_VENDOR_KEY=5]="INVALID_VENDOR_KEY",t[t.INVALID_CHANNEL_NAME=7]="INVALID_CHANNEL_NAME",t[t.INTERNAL_ERROR=8]="INTERNAL_ERROR",t[t.NO_AUTHORIZED=9]="NO_AUTHORIZED",t[t.DYNAMIC_KEY_TIMEOUT=10]="DYNAMIC_KEY_TIMEOUT",t[t.NO_ACTIVE_STATUS=11]="NO_ACTIVE_STATUS",t[t.DYNAMIC_KEY_EXPIRED=13]="DYNAMIC_KEY_EXPIRED",t[t.STATIC_USE_DYNAMIC_KEY=14]="STATIC_USE_DYNAMIC_KEY",t[t.DYNAMIC_USE_STATIC_KEY=15]="DYNAMIC_USE_STATIC_KEY",t[t.USER_OVERLOAD=16]="USER_OVERLOAD",t[t.FORBIDDEN_REGION=18]="FORBIDDEN_REGION",t[t.CANNOT_MEET_AREA_DEMAND=19]="CANNOT_MEET_AREA_DEMAND",t}({}),Si=function(t){return t[t.NO_FLAG_SET=100]="NO_FLAG_SET",t[t.FLAG_SET_BUT_EMPTY=101]="FLAG_SET_BUT_EMPTY",t[t.INVALID_FALG_SET=102]="INVALID_FALG_SET",t[t.FLAG_SET_BUT_NO_RE=103]="FLAG_SET_BUT_NO_RE",t[t.INVALID_SERVICE_ID=104]="INVALID_SERVICE_ID",t[t.NO_SERVICE_AVAILABLE=200]="NO_SERVICE_AVAILABLE",t[t.NO_SERVICE_AVAILABLE_P2P=201]="NO_SERVICE_AVAILABLE_P2P",t[t.NO_SERVICE_AVAILABLE_VOICE=202]="NO_SERVICE_AVAILABLE_VOICE",t[t.NO_SERVICE_AVAILABLE_WEBRTC=203]="NO_SERVICE_AVAILABLE_WEBRTC",t[t.NO_SERVICE_AVAILABLE_CDS=204]="NO_SERVICE_AVAILABLE_CDS",t[t.NO_SERVICE_AVAILABLE_CDN=205]="NO_SERVICE_AVAILABLE_CDN",t[t.NO_SERVICE_AVAILABLE_TDS=206]="NO_SERVICE_AVAILABLE_TDS",t[t.NO_SERVICE_AVAILABLE_REPORT=207]="NO_SERVICE_AVAILABLE_REPORT",t[t.NO_SERVICE_AVAILABLE_APP_CENTER=208]="NO_SERVICE_AVAILABLE_APP_CENTER",t[t.NO_SERVICE_AVAILABLE_ENV0=209]="NO_SERVICE_AVAILABLE_ENV0",t[t.NO_SERVICE_AVAILABLE_VOET=210]="NO_SERVICE_AVAILABLE_VOET",t[t.NO_SERVICE_AVAILABLE_STRING_UID=211]="NO_SERVICE_AVAILABLE_STRING_UID",t[t.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS=212]="NO_SERVICE_AVAILABLE_WEBRTC_UNILBS",t[t.NO_SERVICE_AVAILABLE_UNILBS_FLV=213]="NO_SERVICE_AVAILABLE_UNILBS_FLV",t}({}),dt=function(t){return t[t.K_TIMESTAMP_EXPIRED=2]="K_TIMESTAMP_EXPIRED",t[t.K_CHANNEL_PERMISSION_INVALID=3]="K_CHANNEL_PERMISSION_INVALID",t[t.K_CERTIFICATE_INVALID=4]="K_CERTIFICATE_INVALID",t[t.K_CHANNEL_NAME_EMPTY=5]="K_CHANNEL_NAME_EMPTY",t[t.K_CHANNEL_NOT_FOUND=6]="K_CHANNEL_NOT_FOUND",t[t.K_TICKET_INVALID=7]="K_TICKET_INVALID",t[t.K_CHANNEL_CONFLICTED=8]="K_CHANNEL_CONFLICTED",t[t.K_SERVICE_NOT_READY=9]="K_SERVICE_NOT_READY",t[t.K_SERVICE_TOO_HEAVY=10]="K_SERVICE_TOO_HEAVY",t[t.K_UID_BANNED=14]="K_UID_BANNED",t[t.K_IP_BANNED=15]="K_IP_BANNED",t[t.K_CHANNEL_BANNED=16]="K_CHANNEL_BANNED",t[t.DATASTREAM2_NOT_AVAILABLE=27]="DATASTREAM2_NOT_AVAILABLE",t[t.K_AUTO_REBALANCE=28]="K_AUTO_REBALANCE",t[t.WARN_NO_AVAILABLE_CHANNEL=103]="WARN_NO_AVAILABLE_CHANNEL",t[t.WARN_LOOKUP_CHANNEL_TIMEOUT=104]="WARN_LOOKUP_CHANNEL_TIMEOUT",t[t.WARN_LOOKUP_CHANNEL_REJECTED=105]="WARN_LOOKUP_CHANNEL_REJECTED",t[t.WARN_OPEN_CHANNEL_TIMEOUT=106]="WARN_OPEN_CHANNEL_TIMEOUT",t[t.WARN_OPEN_CHANNEL_REJECTED=107]="WARN_OPEN_CHANNEL_REJECTED",t[t.WARN_REQUEST_DEFERRED=108]="WARN_REQUEST_DEFERRED",t[t.ERR_DYNAMIC_KEY_TIMEOUT=109]="ERR_DYNAMIC_KEY_TIMEOUT",t[t.ERR_NO_AUTHORIZED=110]="ERR_NO_AUTHORIZED",t[t.ERR_VOM_SERVICE_UNAVAILABLE=111]="ERR_VOM_SERVICE_UNAVAILABLE",t[t.ERR_NO_CHANNEL_AVAILABLE_CODE=112]="ERR_NO_CHANNEL_AVAILABLE_CODE",t[t.ERR_MASTER_VOCS_UNAVAILABLE=114]="ERR_MASTER_VOCS_UNAVAILABLE",t[t.ERR_INTERNAL_ERROR=115]="ERR_INTERNAL_ERROR",t[t.ERR_NO_ACTIVE_STATUS=116]="ERR_NO_ACTIVE_STATUS",t[t.ERR_INVALID_UID=117]="ERR_INVALID_UID",t[t.ERR_DYNAMIC_KEY_EXPIRED=118]="ERR_DYNAMIC_KEY_EXPIRED",t[t.ERR_STATIC_USE_DYANMIC_KE=119]="ERR_STATIC_USE_DYANMIC_KE",t[t.ERR_DYNAMIC_USE_STATIC_KE=120]="ERR_DYNAMIC_USE_STATIC_KE",t[t.ERR_NO_VOCS_AVAILABLE=2e3]="ERR_NO_VOCS_AVAILABLE",t[t.ERR_NO_VOS_AVAILABLE=2001]="ERR_NO_VOS_AVAILABLE",t[t.ERR_JOIN_CHANNEL_TIMEOUT=2002]="ERR_JOIN_CHANNEL_TIMEOUT",t[t.ERR_REPEAT_JOIN_CHANNEL=2003]="ERR_REPEAT_JOIN_CHANNEL",t[t.ERR_JOIN_BY_MULTI_IP=2004]="ERR_JOIN_BY_MULTI_IP",t[t.ERR_NOT_JOINED=2011]="ERR_NOT_JOINED",t[t.ERR_REPEAT_JOIN_REQUEST=2012]="ERR_REPEAT_JOIN_REQUEST",t[t.ERR_INVALID_VENDOR_KEY=2013]="ERR_INVALID_VENDOR_KEY",t[t.ERR_INVALID_CHANNEL_NAME=2014]="ERR_INVALID_CHANNEL_NAME",t[t.ERR_INVALID_STRINGUID=2015]="ERR_INVALID_STRINGUID",t[t.ERR_TOO_MANY_USERS=2016]="ERR_TOO_MANY_USERS",t[t.ERR_SET_CLIENT_ROLE_TIMEOUT=2017]="ERR_SET_CLIENT_ROLE_TIMEOUT",t[t.ERR_SET_CLIENT_ROLE_NO_PERMISSION=2018]="ERR_SET_CLIENT_ROLE_NO_PERMISSION",t[t.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE=2019]="ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",t[t.ERR_PUBLISH_REQUEST_INVALID=2020]="ERR_PUBLISH_REQUEST_INVALID",t[t.ERR_SUBSCRIBE_REQUEST_INVALID=2021]="ERR_SUBSCRIBE_REQUEST_INVALID",t[t.ERR_NOT_SUPPORTED_MESSAGE=2022]="ERR_NOT_SUPPORTED_MESSAGE",t[t.ERR_ILLEAGAL_PLUGIN=2023]="ERR_ILLEAGAL_PLUGIN",t[t.ERR_REJOIN_TOKEN_INVALID=2024]="ERR_REJOIN_TOKEN_INVALID",t[t.ERR_REJOIN_USER_NOT_JOINED=2025]="ERR_REJOIN_USER_NOT_JOINED",t[t.ERR_INVALID_OPTIONAL_INFO=2027]="ERR_INVALID_OPTIONAL_INFO",t[t.ILLEGAL_AES_PASSWORD=2028]="ILLEGAL_AES_PASSWORD",t[t.ILLEGAL_CLIENT_ROLE_LEVEL=2029]="ILLEGAL_CLIENT_ROLE_LEVEL",t[t.ERR_TOO_MANY_BROADCASTERS=2031]="ERR_TOO_MANY_BROADCASTERS",t[t.ERR_TOO_MANY_SUBSCRIBERS=2032]="ERR_TOO_MANY_SUBSCRIBERS",t[t.ERR_LICENSE_MISSING=32769]="ERR_LICENSE_MISSING",t[t.ERR_LICENSE_EXPIRED=32771]="ERR_LICENSE_EXPIRED",t[t.ERR_LICENSE_MINUTES_EXCEEDED=32773]="ERR_LICENSE_MINUTES_EXCEEDED",t[t.ERR_LICENSE_PERIOD_INVALID=32774]="ERR_LICENSE_PERIOD_INVALID",t[t.ERR_LICENSE_MULTIPLE_SDK_SERVICE=32778]="ERR_LICENSE_MULTIPLE_SDK_SERVICE",t[t.ERR_LICENSE_ILLEGAL=32783]="ERR_LICENSE_ILLEGAL",t[t.ERR_TEST_RECOVER=9e3]="ERR_TEST_RECOVER",t[t.ERR_TEST_TRYNEXT=9001]="ERR_TEST_TRYNEXT",t[t.ERR_TEST_RETRY=9002]="ERR_TEST_RETRY",t}({}),ie=function(t){return t.CONNECTING="connecting",t.CONNECTED="connected",t.RECONNECTING="reconnecting",t.CLOSED="closed",t}({}),Et=function(t){return t.WS_CONNECTED="ws_connected",t.WS_RECONNECTING="ws_reconnecting",t.WS_CLOSED="ws_closed",t.WS_RECONNECT_CREATE_CONNECTION="ws_reconnect_create_connection",t.ON_BINARY_DATA="on_binary_data",t.REQUEST_RECOVER="request_recover",t.REQUEST_JOIN_INFO="request_join_info",t.REQUEST_REJOIN_INFO="req_rejoin_info",t.IS_P2P_DISCONNECTED="is_p2p_dis",t.DISCONNECT_P2P="dis_p2p",t.ABORT_P2P_EXECUTION="abort_p2p_execution",t.NEED_RENEW_SESSION="need-sid",t.REPORT_JOIN_GATEWAY="report_join_gateway",t.REQUEST_TIMEOUT="request_timeout",t.REQUEST_SUCCESS="request_success",t.JOIN_RESPONSE="join_response",t.PRE_CONNECT_PC="pre_connect_pc",t.P2P_CONNECTION="p2p_connection",t.P2P_REMOTE_CANDIDATE_UPDATE="p2p_remote_candidate_update",t.P2P_SUBSCRIBE="p2p_subscribe",t.P2P_UNSUBSCRIBE="p2p_unsubscribe",t.P2P_EXCHANGE_SDP="p2p_exchange_sdp",t.P2P_ON_ADD_VIDEO_STREAM="p2p_on_add_video_stream",t.P2P_ON_ADD_AUDIO_STREAM="p2p_on_add_audio_stream",t.RECOVER_NOTIFICATION="recover_notification",t}({}),pt=function(t){return t.PING="ping",t.PING_BACK="ping_back",t.JOIN="join_v3",t.REJOIN="rejoin_v3",t.LEAVE="leave",t.SET_CLIENT_ROLE="set_client_role",t.PUBLISH="publish",t.PUBLISH_DATASTREAM="publish_datastream",t.UNPUBLISH="unpublish",t.UNPUBLISH_DATASTREAM="unpublish_datastream",t.SUBSCRIBE="subscribe",t.PRE_SUBSCRIBE="pre_subscribe",t.SUBSCRIBE_DATASTREAM="subscribe_datastream",t.SUBSCRIBE_STREAMS="subscribe_streams",t.UNSUBSCRIBE="unsubscribe",t.UNSUBSCRIBE_DATASTREAM="unsubscribe_datastream",t.UNSUBSCRIBE_STREAMS="unsubscribe_streams",t.SUBSCRIBE_CHANGE="subscribe_change",t.TRAFFIC_STATS="traffic_stats",t.RENEW_TOKEN="renew_token",t.SWITCH_VIDEO_STREAM="switch_video_stream",t.DEFAULT_VIDEO_STREAM="default_video_stream",t.SET_FALLBACK_OPTION="set_fallback_option",t.GATEWAY_INFO="gateway_info",t.CONTROL="control",t.SEND_METADATA="send_metadata",t.DATA_STREAM="data_stream",t.PICK_SVC_LAYER="pick_svc_layer",t.RESTART_ICE="restart_ice",t.CONNECT_PC="connect_pc",t.SET_VIDEO_PROFILE="set_video_profile",t.SET_PARAMETER="set_parameter",t.SET_RTM2_FLAG="set_rtm2_flag",t}({}),Ad=function(t){return t.WRTC_STATS="wrtc_stats",t.WS_INFLATE_DATA_LENGTH="ws_inflate_data_length",t.DENOISER_STATS="denoiser_stats",t.EXTENSION_USAGE_STATS="extension_usage_stats",t}({}),wt=function(t){return t.ON_USER_ONLINE="on_user_online",t.ON_USER_OFFLINE="on_user_offline",t.ON_STREAM_FALLBACK_UPDATE="on_stream_fallback_update",t.ON_PUBLISH_STREAM="on_publish_stream",t.ON_UPLINK_STATS="on_uplink_stats",t.ON_P2P_LOST="on_p2p_lost",t.ON_REMOVE_STREAM="on_remove_stream",t.ON_ADD_AUDIO_STREAM="on_add_audio_stream",t.ON_ADD_VIDEO_STREAM="on_add_video_stream",t.ON_TOKEN_PRIVILEGE_WILL_EXPIRE="on_token_privilege_will_expire",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="on_token_privilege_did_expire",t.ON_USER_BANNED="on_user_banned",t.ON_USER_LICENSE_BANNED="on_user_license_banned",t.ON_NOTIFICATION="on_notification",t.ON_CRYPT_ERROR="on_crypt_error",t.MUTE_AUDIO="mute_audio",t.MUTE_VIDEO="mute_video",t.UNMUTE_AUDIO="unmute_audio",t.UNMUTE_VIDEO="unmute_video",t.ON_P2P_OK="on_p2p_ok",t.RECEIVE_METADATA="receive_metadata",t.ON_DATA_STREAM="on_data_stream",t.ON_RTP_CAPABILITY_CHANGE="on_rtp_capability_change",t.ON_REMOTE_DATASTREAM_UPDATE="on_remote_datastream_update",t.ON_REMOTE_FULL_DATASTREAM_INFO="on_remote_full_datastream_info",t.ENABLE_LOCAL_VIDEO="enable_local_video",t.DISABLE_LOCAL_VIDEO="disable_local_video",t.ENABLE_LOCAL_AUDIO="enable_local_audio",t.DISABLE_LOCAL_AUDIO="disable_local_audio",t.ON_PUBLISHED_USER_LIST="on_published_user_list",t}({}),Ti=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({}),Tt=function(t){return t.CONNECTED="websocket:connected",t.RECONNECTING="websocket:reconnecting",t.WILL_RECONNECT="websocket:will_reconnect",t.CLOSED="websocket:closed",t.FAILED="websocket:failed",t.ON_MESSAGE="websocket:on_message",t.REQUEST_NEW_URLS="websocket:request_new_urls",t.RECONNECT_CREATE_CONNECTION="websocket:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="websocket:on_token_privilege_did_expire",t}({});function Bh(t){if(typeof t!="string"||!/^[a-zA-Z0-9 \!\#\$\%\&\(\)\+\-\:\;\<\=\.\>\?\@\[\]\^\_\{\}\|\~\,]{1,64}$/.test(t))throw _.error("Invalid Channel Name ".concat(t)),new x(C.INVALID_PARAMS,"The length must be within 64 bytes. The supported characters: a-z,A-Z,0-9,space,!, #, $, %, &, (, ), +, -, :, ;, <, =, ., >, ?, @, [, ], ^, _,  {, }, |, ~, ,")}function jh(t){if(e=t,!(typeof e=="number"&&Math.floor(e)===e&&0<=e&&e<=4294967295||DA(t,1,255)))throw new x(C.INVALID_PARAMS,"[String uid] Length of the string: [1,255]. ASCII characters only. [Number uid] The value range is [0,10000]");var e;typeof t=="string"&&_.warn("You input a string as the user ID, to ensure better end-user experience, Agora highly suggests not using a string as the user ID.")}let Ar=function(t){return t.TRANSCODE="mix_streaming",t.RAW="raw_streaming",t}({}),I6={alpha:1,height:640,width:360,x:0,y:0,zOrder:0,audioChannel:0},cg={x:0,y:0,width:160,height:160,zOrder:255,alpha:1};function dg(t,e){Ke(t.url,"".concat(e,".url"),1,1e3,!1),me(t.x)||Xt(t.x,"".concat(e,".x"),0,1e4),me(t.y)||Xt(t.y,"".concat(e,".y"),0,1e4),me(t.width)||Xt(t.width,"".concat(e,".width"),0,1e4),me(t.height)||Xt(t.height,"".concat(e,".height"),0,1e4),me(t.zOrder)||Xt(t.zOrder,"".concat(e,".zOrder"),0,255),me(t.alpha)||Xt(t.alpha,"".concat(e,".alpha"),0,1,!1)}let A6={audioBitrate:48,audioChannels:1,audioSampleRate:48e3,backgroundColor:0,height:360,lowLatency:!1,videoBitrate:400,videoCodecProfile:100,videoCodecType:1,videoFrameRate:15,videoGop:30,width:640,images:[],userConfigs:[],userConfigExtraInfo:""},Vo=function(t){return t.WARNING="@live_uap-warning",t.ERROR="@line_uap-error",t.PUBLISH_STREAM_STATUS="@live_uap-publish-status",t.WORKER_STATUS="@live_uap-worker-status",t.REQUEST_NEW_ADDRESS="@live_uap-request-address",t}({}),lg=function(t){return t.REQUEST_WORKER_MANAGER_LIST="@live_req_worker_manager",t}({}),ke=function(t){return t[t.LIVE_STREAM_RESPONSE_SUCCEED=200]="LIVE_STREAM_RESPONSE_SUCCEED",t[t.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM=454]="LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM",t[t.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR=450]="LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_BAD_STREAM=451]="LIVE_STREAM_RESPONSE_BAD_STREAM",t[t.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR=400]="LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR",t[t.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST=404]="LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST",t[t.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED=456]="LIVE_STREAM_RESPONSE_NOT_AUTHORIZED",t[t.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE=457]="LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE",t[t.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN=429]="LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN",t[t.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH=452]="LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH",t[t.LIVE_STREAM_RESPONSE_NOT_SUPPORTED=453]="LIVE_STREAM_RESPONSE_NOT_SUPPORTED",t[t.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM=455]="LIVE_STREAM_RESPONSE_MAX_STREAM_NUM",t[t.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR=500]="LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR",t[t.LIVE_STREAM_RESPONSE_WORKER_LOST=501]="LIVE_STREAM_RESPONSE_WORKER_LOST",t[t.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT=502]="LIVE_STREAM_RESPONSE_RESOURCE_LIMIT",t[t.LIVE_STREAM_RESPONSE_WORKER_QUIT=503]="LIVE_STREAM_RESPONSE_WORKER_QUIT",t[t.ERROR_FAIL_SEND_MESSAGE=504]="ERROR_FAIL_SEND_MESSAGE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE=30]="PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT=31]="PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT",t[t.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH=32]="PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH",t[t.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN=33]="PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN",t}({});function IO(t){if(!t.channelName)throw new x(C.INVALID_PARAMS,"invalid channelName in info");if(typeof t.uid!="number")throw new x(C.INVALID_PARAMS,"invalid uid in info, uid must be a number");return t.token&&Ke(t.token,"info.token",1,2047),jh(t.uid),Bh(t.channelName),!0}let Ri=function(t){return t[t.SetSdkProfile=0]="SetSdkProfile",t[t.SetSourceChannel=1]="SetSourceChannel",t[t.SetSourceUserId=2]="SetSourceUserId",t[t.SetDestChannel=3]="SetDestChannel",t[t.StartPacketTransfer=4]="StartPacketTransfer",t[t.StopPacketTransfer=5]="StopPacketTransfer",t[t.UpdateDestChannel=6]="UpdateDestChannel",t[t.Reconnect=7]="Reconnect",t[t.SetVideoProfile=8]="SetVideoProfile",t}({}),eo=function(t){return t.NETWORK_DISCONNECTED="NETWORK_DISCONNECTED",t.NETWORK_CONNECTED="NETWORK_CONNECTED",t.PACKET_JOINED_SRC_CHANNEL="PACKET_JOINED_SRC_CHANNEL",t.PACKET_JOINED_DEST_CHANNEL="PACKET_JOINED_DEST_CHANNEL",t.PACKET_SENT_TO_DEST_CHANNEL="PACKET_SENT_TO_DEST_CHANNEL",t.PACKET_RECEIVED_VIDEO_FROM_SRC="PACKET_RECEIVED_VIDEO_FROM_SRC",t.PACKET_RECEIVED_AUDIO_FROM_SRC="PACKET_RECEIVED_AUDIO_FROM_SRC",t.PACKET_UPDATE_DEST_CHANNEL="PACKET_UPDATE_DEST_CHANNEL",t.PACKET_UPDATE_DEST_CHANNEL_REFUSED="PACKET_UPDATE_DEST_CHANNEL_REFUSED",t.PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE="PACKET_UPDATE_DEST_CHANNEL_NOT_CHANGE",t}({}),ki=function(t){return t.RELAY_STATE_IDLE="RELAY_STATE_IDLE",t.RELAY_STATE_CONNECTING="RELAY_STATE_CONNECTING",t.RELAY_STATE_RUNNING="RELAY_STATE_RUNNING",t.RELAY_STATE_FAILURE="RELAY_STATE_FAILURE",t}({}),Qa=function(t){return t.RELAY_OK="RELAY_OK",t.SERVER_CONNECTION_LOST="SERVER_CONNECTION_LOST",t.SRC_TOKEN_EXPIRED="SRC_TOKEN_EXPIRED",t.DEST_TOKEN_EXPIRED="DEST_TOKEN_EXPIRED",t}({}),Gt=function(t){return t.High="high",t.Low="low",t.Audio="audio",t.Screen="screen",t.ScreenLow="screen_low",t}({}),je=function(t){return t.DISCONNECT="disconnect",t.CONNECTION_STATE_CHANGE="connection-state-change",t.NETWORK_QUALITY="network-quality",t.STREAM_TYPE_CHANGE="stream-type-change",t.IS_P2P_DISCONNECTED="is-p2p-dis",t.DISCONNECT_P2P="dis-p2p",t.REQUEST_NEW_GATEWAY_LIST="req-gate-url",t.NEED_RENEW_SESSION="need-sid",t.REQUEST_P2P_CONNECTION_PARAMS="request-p2p-connection-params",t.JOIN_RESPONSE="join-response",t.RESET_CONNECTION_EVENTS="reset-connection-events",t.PRE_CONNECT_PC="pre-connect_pc",t.UPDATE_GATEWAY_CONFIG="update-gateway-config",t}({}),Gh=function(t){return t.P2P_DISCONNECTED="P2P_DISCONNECTED",t.A_ROUND_WS_FAILED="A_ROUND_WS_FAILED",t.TIMEOUT="TIMEOUT",t.UNKNOWN_REASON="UNKNOWN_REASON",t}({}),Be=function(t){return t[t.Nothing=0]="Nothing",t[t.Audio=1]="Audio",t[t.LwoVideo=2]="LwoVideo",t[t.Video=4]="Video",t[t.Data=8]="Data",t[t.DataStream0=256]="DataStream0",t[t.DataStream1=512]="DataStream1",t[t.DataStream2=1024]="DataStream2",t[t.DataStream3=2048]="DataStream3",t[t.DataStream4=4096]="DataStream4",t[t.DataStream5=8192]="DataStream5",t[t.DataStream6=16384]="DataStream6",t[t.DataStream7=32768]="DataStream7",t}({}),Vt=function(t){return t.CHINA="CHINA",t.ASIA="ASIA",t.NORTH_AMERICA="NORTH_AMERICA",t.EUROPE="EUROPE",t.JAPAN="JAPAN",t.INDIA="INDIA",t.KOREA="KOREA",t.HKMC="HKMC",t.US="US",t.OCEANIA="OCEANIA",t.SOUTH_AMERICA="SOUTH_AMERICA",t.AFRICA="AFRICA",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="EXTENSIONS",t}({}),AO=[Vt.AFRICA,Vt.ASIA,Vt.CHINA,Vt.EUROPE,Vt.GLOBAL,Vt.INDIA,Vt.JAPAN,Vt.NORTH_AMERICA,Vt.OCEANIA,Vt.OVERSEA,Vt.SOUTH_AMERICA],ri=function(t){return t.CHINA="CN",t.ASIA="AS",t.NORTH_AMERICA="NA",t.EUROPE="EU",t.JAPAN="JP",t.INDIA="IN",t.KOREA="KR",t.HKMC="HK",t.US="US",t.OCEANIA="OC",t.SOUTH_AMERICA="SA",t.AFRICA="AF",t.OVERSEA="OVERSEA",t.GLOBAL="GLOBAL",t.EXTENSIONS="GLOBAL",t}({}),Wh={CHINA:{},ASIA:{CODE:ri.ASIA,WEBCS_DOMAIN:["ap-web-1-asia.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-asia.agora.io"],PROXY_CS:["proxy-ap-web-asia.agora.io"],CDS_AP:["cds-ap-web-asia.agora.io","cds-ap-web-asia2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-asia.agora.io","sua-ap-web-asia2.agora.io"],UAP_AP:["uap-ap-web-asia.agora.io","uap-ap-web-asia2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-asia.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-asia.agora.io"],LOG_UPLOAD_SERVER:["logservice-asia.agora.io"],PROXY_SERVER_TYPE3:["southeast-asia.webrtc-cloud-proxy.sd-rtn.com"]},NORTH_AMERICA:{CODE:ri.NORTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-north-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-north-america.agora.io"],PROXY_CS:["proxy-ap-web-america.agora.io"],CDS_AP:["cds-ap-web-america.agora.io","cds-ap-web-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-america.agora.io","sua-ap-web-america2.agora.io"],UAP_AP:["uap-ap-web-america.agora.io","uap-ap-web-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-north-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-north-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-north-america.agora.io"],PROXY_SERVER_TYPE3:["east-usa.webrtc-cloud-proxy.sd-rtn.com"]},EUROPE:{CODE:ri.EUROPE,WEBCS_DOMAIN:["ap-web-1-europe.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-europe.agora.io"],PROXY_CS:["proxy-ap-web-europe.agora.io"],CDS_AP:["cds-ap-web-europe.agora.io","cds-ap-web-europe2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-europe.agora.io","sua-ap-web-europe.agora.io"],UAP_AP:["uap-ap-web-europe.agora.io","uap-ap-web-europe2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-europe.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-europe.agora.io"],LOG_UPLOAD_SERVER:["logservice-europe.agora.io"],PROXY_SERVER_TYPE3:["europe.webrtc-cloud-proxy.sd-rtn.com"]},JAPAN:{CODE:ri.JAPAN,WEBCS_DOMAIN:["ap-web-1-japan.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-japan.agora.io"],PROXY_CS:["proxy-ap-web-japan.agora.io"],CDS_AP:["cds-ap-web-japan.agora.io","cds-ap-web-japan2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-japan.agora.io","sua-ap-web-japan2.agora.io"],UAP_AP:["uap-ap-web-japan.agora.io","uap-ap-web-japan2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-japan.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-japan.agora.io"],LOG_UPLOAD_SERVER:["logservice-japan.agora.io"],PROXY_SERVER_TYPE3:["japan.webrtc-cloud-proxy.sd-rtn.com"]},INDIA:{CODE:ri.INDIA,WEBCS_DOMAIN:["ap-web-1-india.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-india.agora.io"],PROXY_CS:["proxy-ap-web-india.agora.io"],CDS_AP:["cds-ap-web-india.agora.io","cds-ap-web-india2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-india.agora.io","sua-ap-web-india2.agora.io"],UAP_AP:["uap-ap-web-india.agora.io","uap-ap-web-india2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-india.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-india.agora.io"],LOG_UPLOAD_SERVER:["logservice-india.agora.io"],PROXY_SERVER_TYPE3:["india.webrtc-cloud-proxy.sd-rtn.com"]},KOREA:{CODE:ri.KOREA,WEBCS_DOMAIN:["ap-web-1-korea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-korea.agora.io"],PROXY_CS:["proxy-ap-web-korea.agora.io"],CDS_AP:["cds-ap-web-korea.agora.io","cds-ap-web-korea2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-korea.agora.io","sua-ap-web-korea2.agora.io"],UAP_AP:["uap-ap-web-korea.agora.io","uap-ap-web-korea2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-korea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-korea.agora.io"],LOG_UPLOAD_SERVER:["logservice-korea.agora.io"],PROXY_SERVER_TYPE3:["korea.webrtc-cloud-proxy.sd-rtn.com"]},HKMC:{CODE:ri.HKMC,WEBCS_DOMAIN:["ap-web-1-hkmc.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-hkmc.agora.io"],PROXY_CS:["proxy-ap-web-hkmc.agora.io"],CDS_AP:["cds-ap-web-hkmc.agora.io","cds-ap-web-hkmc2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-hkmc.agora.io","sua-ap-web-hkmc2.agora.io"],UAP_AP:["uap-ap-web-hkmc.agora.io","uap-ap-web-hkmc2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-hkmc.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-hkmc.agora.io"],LOG_UPLOAD_SERVER:["logservice-hkmc.agora.io"],PROXY_SERVER_TYPE3:["hkmc.webrtc-cloud-proxy.sd-rtn.com"]},US:{CODE:ri.US,WEBCS_DOMAIN:["ap-web-1-us.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-us.agora.io"],PROXY_CS:["proxy-ap-web-us.agora.io"],CDS_AP:["cds-ap-web-us.agora.io","cds-ap-web-us2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-us.agora.io","sua-ap-web-us2.agora.io"],UAP_AP:["uap-ap-web-us.agora.io","uap-ap-web-us2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-us.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-us.agora.io"],LOG_UPLOAD_SERVER:["logservice-us.agora.io"],PROXY_SERVER_TYPE3:["us.webrtc-cloud-proxy.sd-rtn.com"]},OVERSEA:{CODE:ri.OVERSEA,WEBCS_DOMAIN:["ap-web-1-oversea.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oversea.agora.io"],PROXY_CS:["proxy-ap-web-oversea.agora.io"],CDS_AP:["cds-ap-web-oversea.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oversea.agora.io"],UAP_AP:["uap-ap-web-oversea.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oversea.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oversea.agora.io"],LOG_UPLOAD_SERVER:["logservice-oversea.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.agora.io"]},GLOBAL:{CODE:ri.GLOBAL,WEBCS_DOMAIN:["webrtc2-ap-web-1.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-ap-web-3.agora.io"],PROXY_CS:["ap-proxy-1.agora.io","ap-proxy-2.agora.io"],CDS_AP:["cds-ap-web-1.agora.io","cds-ap-web-3.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-1.agora.io","sua-ap-web-3.agora.io"],UAP_AP:["uap-ap-web-1.agora.io","uap-ap-web-3.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2.agora.io"],LOG_UPLOAD_SERVER:["logservice.agora.io"],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy.sd-rtn.com"]},OCEANIA:{CODE:ri.OCEANIA,WEBCS_DOMAIN:["ap-web-1-oceania.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-oceania.agora.io"],PROXY_CS:["proxy-ap-web-oceania.agora.io"],CDS_AP:["cds-ap-web-oceania.agora.io","cds-ap-web-oceania2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-oceania.agora.io","sua-ap-web-oceania2.agora.io"],UAP_AP:["uap-ap-web-oceania.agora.io","uap-ap-web-oceania2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-oceania.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-oceania.agora.io"],LOG_UPLOAD_SERVER:["logservice-oceania.agora.io"],PROXY_SERVER_TYPE3:["oceania.webrtc-cloud-proxy.sd-rtn.com"]},SOUTH_AMERICA:{CODE:ri.SOUTH_AMERICA,WEBCS_DOMAIN:["ap-web-1-south-america.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-south-america.agora.io"],PROXY_CS:["proxy-ap-web-south-america.agora.io"],CDS_AP:["cds-ap-web-south-america.agora.io","cds-ap-web-south-america2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-south-america.agora.io","sua-ap-web-south-america2.agora.io"],UAP_AP:["uap-ap-web-south-america.agora.io","uap-ap-web-south-america2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-south-america.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-south-america.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-america.agora.io"],PROXY_SERVER_TYPE3:["south-america.webrtc-cloud-proxy.sd-rtn.com"]},AFRICA:{CODE:ri.AFRICA,WEBCS_DOMAIN:["ap-web-1-africa.agora.io"],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-africa.agora.io"],PROXY_CS:["proxy-ap-web-africa.agora.io"],CDS_AP:["cds-ap-web-africa.agora.io","cds-ap-web-africa2.agora.io"],ACCOUNT_REGISTER:["sua-ap-web-africa.agora.io","sua-ap-web-africa2.agora.io"],UAP_AP:["uap-ap-web-africa.agora.io","uap-ap-web-africa2.agora.io"],EVENT_REPORT_DOMAIN:["statscollector-1-africa.agora.io"],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-africa.agora.io"],LOG_UPLOAD_SERVER:["logservice-south-africa.agora.io"],PROXY_SERVER_TYPE3:["africa.webrtc-cloud-proxy.sd-rtn.com"]},EXTENSIONS:{}};Df&&(Wh.CHINA={CODE:ri.CHINA,WEBCS_DOMAIN:["webrtc2-2.ap.sd-rtn.com"],WEBCS_DOMAIN_BACKUP_LIST:["webrtc2-4.ap.sd-rtn.com"],PROXY_CS:["proxy-web.ap.sd-rtn.com"],CDS_AP:["cds-web-2.ap.sd-rtn.com","cds-web-4.ap.sd-rtn.com"],ACCOUNT_REGISTER:["sua-web-2.ap.sd-rtn.com","sua-web-4.ap.sd-rtn.com"],UAP_AP:["uap-web-2.ap.sd-rtn.com","uap-web-4.ap.sd-rtn.com"],EVENT_REPORT_DOMAIN:["web-3.statscollector.sd-rtn.com"],EVENT_REPORT_BACKUP_DOMAIN:["web-4.statscollector.sd-rtn.com"],LOG_UPLOAD_SERVER:["logservice-china.agora.io"],PROXY_SERVER_TYPE3:["east-cn.webrtc-cloud-proxy.sd-rtn.com"]});let wd=function(t){return t.UPDATE_BITRATE_LIMIT="update_bitrate_limit",t.UPDATE_CLIENT_ROLE_OPTIONS="update_client_role_options",t}({});function wO(t){return!!t&&!(!t.uplink||!t.id)&&t.uplink.max_bitrate!==void 0&&t.uplink.min_bitrate!==void 0}class OO extends ue{constructor(e,i){super(),T(this,"onICEConnectionStateChange",void 0),T(this,"onConnectionStateChange",void 0),T(this,"onDTLSTransportStateChange",void 0),T(this,"onDTLSTransportError",void 0),T(this,"onICETransportStateChange",void 0),T(this,"onFirstAudioReceived",void 0),T(this,"onFirstVideoReceived",void 0),T(this,"onFirstAudioDecoded",void 0),T(this,"onFirstVideoDecoded",void 0),T(this,"onFirstVideoDecodedTimeout",void 0),T(this,"onSelectedLocalCandidateChanged",void 0),T(this,"onSelectedRemoteCandidateChanged",void 0),T(this,"onICECandidateError",void 0),T(this,"getLocalVideoStats",void 0)}}class NO extends OO{constructor(e,i){super(e,i),T(this,"establishPromise",void 0)}}let $=function(t){return t.VIDEO="video",t.AUDIO="audio",t}({}),oi=function(t){return t.UDP_RELAY="udp_relay",t.UDP_TCP_RELAY="udp_tcp_relay",t.TCP_RELAY="tcp_relay",t.RELAY="relay",t}({}),io=function(t){return t[t.FIRST_CONNECTION=0]="FIRST_CONNECTION",t[t.UDP_TCP_RESTART=1]="UDP_TCP_RESTART",t[t.RELAY_RESTART=2]="RELAY_RESTART",t[t.TCP_RESTART=3]="TCP_RESTART",t[t.OLD_FIRST_CONNECTION=10]="OLD_FIRST_CONNECTION",t[t.OLD_RESTART=11]="OLD_RESTART",t[t.DISCONNECTED_OR_FAILED=20]="DISCONNECTED_OR_FAILED",t}({}),DO=["disconnected","failed"],W=function(t){return t.LocalVideoTrack="videoTrack",t.LocalAudioTrack="audioTrack",t.LocalVideoLowTrack="videoLowTrack",t}({}),Bt=function(t){return t.New="new",t.Connected="connected",t.Reconnecting="reconnecting",t.Disconnected="disconnected",t}({}),at=function(t){return t.AudioMetadata="audioMetadata",t.StateChange="stateChange",t.IceConnectionStateChange="iceConnectionStateChange",t.RequestMuteLocal="requestMuteLocal",t.RequestUnmuteLocal="requestUnmuteLocal",t.RequestRePublish="requestRePublish",t.RequestRePublishDataChannel="requestRePublishDataChannel",t.RequestReSubscribe="requestReSubscribe",t.RequestUploadStats="requestUploadStats",t.RequestUpload="requestUpload",t.MediaReconnectStart="MediaReconnectStart",t.MediaReconnectEnd="MediaReconnectEnd",t.NeedSignalRTT="NeedSignalRTT",t.RequestRestartICE="RequestRestartIce",t.PeerConnectionStateChange="PeerConnectionStateChange",t.RequestReconnect="RequestReconnect",t.RequestReconnectPC="RequestReconnectPC",t.RequestUnpublishForReconnectPC="RequestUnpublishForReconnectPC",t.P2PLost="P2PLost",t.UpdateVideoEncoder="UpdateVideoEncoder",t.ConnectionTypeChange="ConnectionTypeChange",t.RequestLowStreamParameter="RequestLowStreamParameter",t.QueryClientConnectionState="QueryClientConnectionState",t.LocalCandidate="LocalCandidate",t.RequestP2PMuteLocal="requestP2PMuteLocal",t.RequestP2PUnPublish="RequestP2PUnPublish",t.RequestP2PUnmuteRemote="RequestP2PUnmuteRemote",t.RequestP2PMuteRemote="RequestP2PMuteRemote",t.RequestP2PRestartICE="RequestP2PRestartICE",t}({}),xn=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),Vn=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),Ge=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),PO=function(t){return t.CONNECTED="transmitter:connected",t.RECONNECTING="transmitter:reconnecting",t.WILL_RECONNECT="transmitter:will_reconnect",t.CLOSED="transmitter:closed",t.FAILED="transmitter:failed",t.ON_MESSAGE="transmitter:on_message",t.REQUEST_NEW_URLS="transmitter:request_new_urls",t.RECONNECT_CREATE_CONNECTION="transmitter:reconnect_create_connection",t.ON_TOKEN_PRIVILEGE_DID_EXPIRE="transmitter:on_token_privilege_did_expire",t.TO_CONNECT_DATACHANNEL="transmitter:to_connect_datachannel",t.FAILBACK="transmitter:failback",t.PRE_CONNECT_PC="transmitter:pre_connect_pc",t}({}),wr=function(t){return t.CAMERA_CHANGED="camera-changed",t.MICROPHONE_CHANGED="microphone-changed",t.PLAYBACK_DEVICE_CHANGED="playback-device-changed",t.AUDIO_AUTOPLAY_FAILED="audio-autoplay-failed",t.AUTOPLAY_FAILED="autoplay-failed",t.AUDIO_CONTEXT_STATE_CHANGED="audio-context-state-changed",t.SECURITY_POLICY_VIOLATION="security-policy-violation",t}({}),mn=function(t){return t.CONNECTING="CONNECTING",t.RECONNECTING="RECONNECTING",t.CONNECTED="CONNECTED",t.CLOSED="CLOSED",t}({}),or=function(t){return t.CONNECTION_STATE_CHANGE="connection-state-change",t.STATE_CHANGE="state-change",t.INSPECT_RESULT="inspect-result",t.CLIENT_LOCAL_VIDEO_TRACK="client-local-video-track",t.REQUEST_NEW_WORKER_URL="request-new-worker-url",t}({}),Za=function(t){return t[t.CONNECT_AP=0]="CONNECT_AP",t[t.AP_CONNECTED=1]="AP_CONNECTED",t[t.CONNECT_WORKER_MANAGER=2]="CONNECT_WORKER_MANAGER",t[t.WORKER_MANAGER_CONNECTED=3]="WORKER_MANAGER_CONNECTED",t[t.GET_WORKER_MANAGER_RESPONSE=4]="GET_WORKER_MANAGER_RESPONSE",t[t.CONNECT_WORKER=5]="CONNECT_WORKER",t[t.WORKER_CONNECTED=6]="WORKER_CONNECTED",t[t.CLOSED=7]="CLOSED",t}({}),ye=function(t){return t.CALL="call",t.CANDIDATE="candidate",t.PUBLISH="publish",t.UNPUBLISH="unpublish",t.CONTROL="control",t.RESTART_ICE="restart_ice",t.ACK="ack",t.RESPONSE="response",t.JOIN="join",t.CHECK="check",t}({}),$a=function(t){return t.ABORT="abort",t}({}),Fo=function(t){return t.MUTE_LOCAL_AUDIO="mute_local_audio",t.MUTE_LOCAL_VIDEO="mute_local_video",t.UNMUTE_LOCAL_AUDIO="unmute_local_audio",t.UNMUTE_LOCAL_VIDEO="unmute_local_video",t}({}),w6=function(t){return t.P2P_TOKEN_TIMEOUT="p2p_token_timeout",t.P2P_TOKEN_CHANGED="p2p_token_changed",t}({}),O6={[Fh.ACCESS_POINT]:{[Si.NO_FLAG_SET]:{desc:"flag is zero",retry:!1},[Si.FLAG_SET_BUT_EMPTY]:{desc:"flag is empty",retry:!1},[Si.INVALID_FALG_SET]:{desc:"invalid flag",retry:!1},[Si.FLAG_SET_BUT_NO_RE]:{desc:"flag set unilbs but no request",retry:!1},[Si.INVALID_SERVICE_ID]:{desc:"invalid service id",retry:!1},[Si.NO_SERVICE_AVAILABLE]:{desc:"no service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_P2P]:{desc:"no unilbs p2p service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_VOICE]:{desc:"no unilbs voice service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_WEBRTC]:{desc:"no unilbs webrtc service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_CDS]:{desc:"no cds service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_CDN]:{desc:"no cdn dispatcher service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_TDS]:{desc:"no tds service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_REPORT]:{desc:"no unilbs report service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_APP_CENTER]:{desc:"no app center service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_ENV0]:{desc:"no unilbs sig env0 service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_VOET]:{desc:"no unilbs voet service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_STRING_UID]:{desc:"no string uid service available",retry:!0},[Si.NO_SERVICE_AVAILABLE_WEBRTC_UNILBS]:{desc:"no webrtc unilbs service available",retry:!0}},[Fh.UNILBS]:{[Un.INVALID_VENDOR_KEY]:{desc:"invalid vendor key, can not find appid",retry:!1},[Un.INVALID_CHANNEL_NAME]:{desc:"invalid channel name",retry:!1},[Un.INTERNAL_ERROR]:{desc:"unilbs internal error",retry:!1},[Un.NO_AUTHORIZED]:{desc:"invalid token, authorized failed",retry:!1},[Un.DYNAMIC_KEY_TIMEOUT]:{desc:"dynamic key or token timeout",retry:!1},[Un.NO_ACTIVE_STATUS]:{desc:"no active status",retry:!1},[Un.DYNAMIC_KEY_EXPIRED]:{desc:"dynamic key expired",retry:!1},[Un.STATIC_USE_DYNAMIC_KEY]:{desc:"static use dynamic key",retry:!1},[Un.DYNAMIC_USE_STATIC_KEY]:{desc:"dynamic use static key",retry:!1},[Un.USER_OVERLOAD]:{desc:"amount of users over load",retry:!1},[Un.FORBIDDEN_REGION]:{desc:"the request is forbidden in this area",retry:!1},[Un.CANNOT_MEET_AREA_DEMAND]:{desc:"unable to allocate services in this area",retry:!1}},[Fh.STRING_UID_ALLOCATOR]:{[ag.IIIEGAL_APPID]:{desc:"invalid appid",retry:!1},[ag.IIIEGAL_UID]:{desc:"invalid string uid",retry:!1},[ag.INTERNAL_ERROR]:{desc:"string uid allocator internal error",retry:!0}}};function tc(t){let e=O6[Math.floor(t/1e4)];if(!e)return{desc:"unknown error",retry:!1};let i=e[t%1e4];if(!i){if(Math.floor(t/1e4)===Fh.ACCESS_POINT){let n=t%1e4;if(n.toString()[0]==="1")return{desc:t.toString(),retry:!1};if(n.toString()[0]==="2")return{desc:t.toString(),retry:!0}}return{desc:"unknown error",retry:!1}}return i}let N6={[dt.K_TIMESTAMP_EXPIRED]:{desc:"K_TIMESTAMP_EXPIRED",action:"failed"},[dt.K_CHANNEL_PERMISSION_INVALID]:{desc:"K_CHANNEL_PERMISSION_INVALID",action:"failed"},[dt.K_CERTIFICATE_INVALID]:{desc:"K_CERTIFICATE_INVALID",action:"failed"},[dt.K_CHANNEL_NAME_EMPTY]:{desc:"K_CHANNEL_NAME_EMPTY",action:"failed"},[dt.K_CHANNEL_NOT_FOUND]:{desc:"K_CHANNEL_NOT_FOUND",action:"failed"},[dt.K_TICKET_INVALID]:{desc:"K_TICKET_INVALID",action:"failed"},[dt.K_CHANNEL_CONFLICTED]:{desc:"K_CHANNEL_CONFLICTED",action:"failed"},[dt.K_SERVICE_NOT_READY]:{desc:"K_SERVICE_NOT_READY",action:"tryNext"},[dt.K_SERVICE_TOO_HEAVY]:{desc:"K_SERVICE_TOO_HEAVY",action:"tryNext"},[dt.K_UID_BANNED]:{desc:"K_UID_BANNED",action:"failed"},[dt.K_IP_BANNED]:{desc:"K_IP_BANNED",action:"failed"},[dt.DATASTREAM2_NOT_AVAILABLE]:{desc:"DATASTREAM2_NOT_AVAILABLE",action:"quit"},[dt.K_AUTO_REBALANCE]:{desc:"k_AUTO_REBALANCE",action:"recover"},[dt.ERR_INVALID_VENDOR_KEY]:{desc:"ERR_INVALID_VENDOR_KEY",action:"failed"},[dt.ERR_INVALID_CHANNEL_NAME]:{desc:"ERR_INVALID_CHANNEL_NAME",action:"failed"},[dt.WARN_NO_AVAILABLE_CHANNEL]:{desc:"WARN_NO_AVAILABLE_CHANNEL",action:"failed"},[dt.WARN_LOOKUP_CHANNEL_TIMEOUT]:{desc:"WARN_LOOKUP_CHANNEL_TIMEOUT",action:"tryNext"},[dt.WARN_LOOKUP_CHANNEL_REJECTED]:{desc:"WARN_LOOKUP_CHANNEL_REJECTED",action:"failed"},[dt.WARN_OPEN_CHANNEL_TIMEOUT]:{desc:"WARN_OPEN_CHANNEL_TIMEOUT",action:"tryNext"},[dt.WARN_OPEN_CHANNEL_REJECTED]:{desc:"WARN_OPEN_CHANNEL_REJECTED",action:"failed"},[dt.WARN_REQUEST_DEFERRED]:{desc:"WARN_REQUEST_DEFERRED",action:"failed"},[dt.ERR_DYNAMIC_KEY_TIMEOUT]:{desc:"ERR_DYNAMIC_KEY_TIMEOUT",action:"failed"},[dt.ERR_NO_AUTHORIZED]:{desc:"ERR_NO_AUTHORIZED",action:"failed"},[dt.ERR_VOM_SERVICE_UNAVAILABLE]:{desc:"ERR_VOM_SERVICE_UNAVAILABLE",action:"tryNext"},[dt.ERR_NO_CHANNEL_AVAILABLE_CODE]:{desc:"ERR_NO_CHANNEL_AVAILABLE_CODE",action:"failed"},[dt.ERR_MASTER_VOCS_UNAVAILABLE]:{desc:"ERR_MASTER_VOCS_UNAVAILABLE",action:"tryNext"},[dt.ERR_INTERNAL_ERROR]:{desc:"ERR_INTERNAL_ERROR",action:"tryNext"},[dt.ERR_NO_ACTIVE_STATUS]:{desc:"ERR_NO_ACTIVE_STATUS",action:"failed"},[dt.ERR_INVALID_UID]:{desc:"ERR_INVALID_UID",action:"failed"},[dt.ERR_DYNAMIC_KEY_EXPIRED]:{desc:"ERR_DYNAMIC_KEY_EXPIRED",action:"failed"},[dt.ERR_STATIC_USE_DYANMIC_KE]:{desc:"ERR_STATIC_USE_DYANMIC_KE",action:"failed"},[dt.ERR_DYNAMIC_USE_STATIC_KE]:{desc:"ERR_DYNAMIC_USE_STATIC_KE",action:"failed"},[dt.ERR_NO_VOCS_AVAILABLE]:{desc:"ERR_NO_VOCS_AVAILABLE",action:"tryNext"},[dt.ERR_NO_VOS_AVAILABLE]:{desc:"ERR_NO_VOS_AVAILABLE",action:"tryNext"},[dt.ERR_JOIN_CHANNEL_TIMEOUT]:{desc:"ERR_JOIN_CHANNEL_TIMEOUT",action:"tryNext"},[dt.ERR_JOIN_BY_MULTI_IP]:{desc:"ERR_JOIN_BY_MULTI_IP",action:"recover"},[dt.ERR_NOT_JOINED]:{desc:"ERR_NOT_JOINED",action:"failed"},[dt.ERR_REPEAT_JOIN_REQUEST]:{desc:"ERR_REPEAT_JOIN_REQUEST",action:"quit"},[dt.ERR_REPEAT_JOIN_CHANNEL]:{desc:"ERR_REPEAT_JOIN_CHANNEL",action:"quit"},[dt.ERR_INVALID_STRINGUID]:{desc:"ERR_INVALID_STRINGUID",action:"failed"},[dt.ERR_TOO_MANY_USERS]:{desc:"ERR_TOO_MANY_USERS",action:"tryNext"},[dt.ERR_SET_CLIENT_ROLE_TIMEOUT]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[dt.ERR_SET_CLIENT_ROLE_NO_PERMISSION]:{desc:"ERR_SET_CLIENT_ROLE_TIMEOUT",action:"failed"},[dt.ERR_SET_CLIENT_ROLE_ALREADY_IN_USE]:{desc:"ERR_SET_CLIENT_ROLE_ALREADY_IN_USE",action:"success"},[dt.ERR_PUBLISH_REQUEST_INVALID]:{desc:"ERR_PUBLISH_REQUEST_INVALID",action:"failed"},[dt.ERR_SUBSCRIBE_REQUEST_INVALID]:{desc:"ERR_SUBSCRIBE_REQUEST_INVALID",action:"failed"},[dt.ERR_NOT_SUPPORTED_MESSAGE]:{desc:"ERR_NOT_SUPPORTED_MESSAGE",action:"failed"},[dt.ERR_ILLEAGAL_PLUGIN]:{desc:"ERR_ILLEAGAL_PLUGIN",action:"failed"},[dt.ILLEGAL_CLIENT_ROLE_LEVEL]:{desc:"ILLEGAL_CLIENT_ROLE_LEVEL",action:"failed"},[dt.ERR_REJOIN_TOKEN_INVALID]:{desc:"ERR_REJOIN_TOKEN_INVALID",action:"failed"},[dt.ERR_REJOIN_USER_NOT_JOINED]:{desc:"ERR_REJOIN_NOT_JOINED",action:"failed"},[dt.ERR_INVALID_OPTIONAL_INFO]:{desc:"ERR_INVALID_OPTIONAL_INFO",action:"quit"},[dt.ERR_TEST_RECOVER]:{desc:"ERR_TEST_RECOVER",action:"recover"},[dt.ERR_TEST_TRYNEXT]:{desc:"ERR_TEST_TRYNEXT",action:"recover"},[dt.ERR_TEST_RETRY]:{desc:"ERR_TEST_RETRY",action:"recover"},[dt.ILLEGAL_AES_PASSWORD]:{desc:"ERR_TEST_RETRY",action:"failed"},[dt.ERR_TOO_MANY_BROADCASTERS]:{desc:"ERR_TOO_MANY_BROADCASTERS",action:"failed"},[dt.ERR_TOO_MANY_SUBSCRIBERS]:{desc:"ERR_TOO_MANY_SUBSCRIBERS",action:"failed"},[dt.ERR_LICENSE_ILLEGAL]:{desc:"ERR_LICENSE_ILLEGAL",action:"quit"},[dt.ERR_LICENSE_MISSING]:{desc:"ERR_LICENSE_MISSING",action:"quit"},[dt.ERR_LICENSE_EXPIRED]:{desc:"ERR_LICENSE_EXPIRED",action:"quit"},[dt.ERR_LICENSE_MINUTES_EXCEEDED]:{desc:"ERR_LICENSE_MINUTES_EXCEEDED",action:"quit"},[dt.ERR_LICENSE_PERIOD_INVALID]:{desc:"ERR_LICENSE_PERIOD_INVALID",action:"quit"},[dt.ERR_LICENSE_MULTIPLE_SDK_SERVICE]:{desc:"ERR_LICENSE_MULTIPLE_SDK_SERVICE",action:"quit"}};function Od(t){return N6[t]||{desc:"UNKNOWN_ERROR_".concat(t),action:"failed"}}function LO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function ug(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?LO(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):LO(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function hg(t,e){if(typeof t=="string")return t;let{proxy:i,host:n,port:r}=t;if(e){let o=A("JOIN_GATEWAY_FALLBACK_PORT")||443;return o===443?"wss://".concat(n,"/ws/?p=").concat(Number(r)+150):"wss://".concat(n,":").concat(o,"/ws/?p=").concat(Number(r)+150)}return i?"wss://".concat(i,"/ws/?h=").concat(n,"&p=").concat(r):"wss://".concat(n,":").concat(r)}let D6=/wss:\/\/(.+)\/ws\/\?h=(.+)&p=([0-9]+)\/?/,P6=/wss:\/\/(.+)\/ws\/\?p=([0-9]+)\/?/,L6=/wss:\/\/(.+):([0-9]+)\/?/,k6=/wss:\/\/(.[^\/]+)\/?/,M6=0;class U6{constructor(e,i){T(this,"id",0),T(this,"store",void 0),T(this,"recordIndex",void 0),T(this,"websockets",[]),T(this,"try443PortDuration",2e3),T(this,"forceCloseWSDuration",5e3),T(this,"try443PortTimeout",null),T(this,"forceCloseTimeout",null),T(this,"isTry443PortFailed",!1),T(this,"isNormalPortFailed",!1),T(this,"useDoubleDomain",!1),T(this,"useProxy",!1),T(this,"startTime",Date.now()),this.id=++M6,this.try443PortDuration=A("JOIN_GATEWAY_TRY_443PORT_DURATION")||2e3,this.forceCloseWSDuration=e||5e3,this.store=i}closeAllWebsockets(){this.websockets.forEach(e=>{e.onopen=null,e.onclose=null,e.onmessage=null,e.close()}),this.websockets.length=0}clearTimeout(){this.forceCloseTimeout&&clearTimeout(this.forceCloseTimeout),this.try443PortTimeout&&clearTimeout(this.try443PortTimeout),this.forceCloseTimeout=null,this.try443PortTimeout=null}logger(){var e;let i=Date.now()-this.startTime;for(var n=arguments.length,r=new Array(n),o=0;o<n;o++)r[o]=arguments[o];_.debug("[choose-best-ws ".concat((e=this.store)===null||e===void 0?void 0:e.clientId," ").concat(this.id,"] ").concat(i,"ms:"),...r)}createWebSocket(e,i,n){this.logger("createWebSocket:",e,{isTry443Port:i,hasTimeoutDetection:n});let r=A("GATEWAY_DOMAINS"),o=Date.now(),s=[],a=r.find(h=>{var p;return z(p=e.host).call(p,h)});a||(this.useDoubleDomain=!1);let c=[];if(this.useDoubleDomain)r.forEach(h=>{c.push(hg(ug(ug({},e),{},{host:e.host.replace(a,h)}),i))});else{let h=ug({},e);if(i&&a){let p=r.find(g=>g!==a);p&&(h.host=h.host.replace(a,p))}c.push(hg(h,i))}try{c.forEach(h=>{let p=new WebSocket(h);p.binaryType="arraybuffer",s.push(p),this.logger("ws is connecting:",p.url)})}catch(h){if(this.logger("ws create failed"),s.forEach(p=>p.close()),s.length=0,this.useDoubleDomain)return this.useDoubleDomain=!1,this.createWebSocket(e,i,n);if(!i&&Number(e.port)!==443)return this.createWebSocket(e,!0,n);throw new x(C.WS_ERR,"init websocket failed! Error: ".concat(h.toString()))}let d=pd();this.store&&this.store.recordJoinChannelService({urls:s.map(h=>h.url),service:"gateway"},this.recordIndex),s.forEach(h=>{h.onopen=()=>{this.logger("onopen: ws ".concat(h.url," open cost ").concat(Date.now()-o,"ms")),this.websockets.forEach(p=>{p!==h&&(p.onopen=null,p.onclose=null,p.onmessage=null,p.close(),this.logger("close backup websocket: ".concat(p.url)))}),this.websockets.length=0,d.resolve(h)},h.onclose=p=>{this.logger("onclose: ws ".concat(h.url," closed cost ").concat(Date.now()-o,"ms state: ").concat(h.readyState));let g=s.every(E=>E.readyState===WebSocket.CLOSED||E.readyState===WebSocket.CLOSING);this.logger("".concat(i?"443":"47xx"," websocket closed, all failed: ").concat(g)),g&&(i||this.isTry443PortFailed||this.useProxy)?(this.logger("onclose: all websocket is closed, ".concat(p.reason)),d.reject({code:p.code,reason:Gh.A_ROUND_WS_FAILED})):!i&&g&&!this.isNormalPortFailed&&this.try443PortTimeout&&(this.logger("all 47xx websocket is closed, try 443 port"),this.clearTimeout(),u()),i?this.isTry443PortFailed=g:this.isNormalPortFailed=g},h.onmessage=p=>this.logger("".concat(h.url," onmessage: ").concat(p.data))}),this.websockets.push(...s);let l=()=>{this.websockets.forEach(h=>h.readyState!==WebSocket.OPEN&&h.close())},u=()=>{if(d.isResolved)return l();kt().os===Ve.MAC_OS&&_e()&&l(),this.createWebSocket(e,!0,!0).then(h=>{d.resolve(h)}).catch(h=>{this.isNormalPortFailed&&d.reject(h),this.logger("try 443 port to create ws failed")}),this.forceCloseTimeout=window.setTimeout(()=>{this.logger("5s timeout close un-opens, isWebsocket created: ",d.isResolved),this.forceCloseTimeout=null,l()},this.forceCloseWSDuration)};return n||(()=>{if(i||this.useProxy)return this.logger("add 5s timeout at ".concat(i?"try-443":"proxy"," condition")),this.forceCloseTimeout=window.setTimeout(()=>{this.forceCloseTimeout=null,l()},this.forceCloseWSDuration);this.try443PortTimeout=window.setTimeout(()=>{this.logger("2s timeout, isWebsocket created: ",d.isResolved),this.try443PortTimeout=null,u()},this.try443PortDuration)})(),d.promise}chooseBestWebsocket(e,i,n,r){return this.useDoubleDomain=!!i,typeof e=="string"&&(e=function(o){let s,a,c;return[,s,a,c]=o.match(D6)||[],s||([,a,c]=o.match(P6)||[]),a&&c||([,a,c]=o.match(L6)||[]),a&&c||([,a]=o.match(k6)||[]),a||_.warning("un-destructible url: ",o),{proxy:s,host:a,port:c||"443"}}(e)),this.recordIndex=r,this.useProxy=!!e.proxy,n&&this.useProxy&&(_.warn("cannot use 443 only when use proxy"),n=!1),this.createWebSocket(e,!!n,!1).finally(()=>this.clearTimeout())}}function kO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}class MO extends ue{get url(){return this.websocket&&this.websocket.url||this._websocketUrl}get reconnectMode(){return this._reconnectMode}set reconnectMode(e){var i;z(i=["tryNext","recover"]).call(i,e)&&this.resetReconnectCount(e),this._reconnectMode=e}get state(){return this._state}set state(e){e!==this._state&&(this._state=e,this._state==="reconnecting"?this.emit(Tt.RECONNECTING,this.reconnectReason):this._state==="connected"?this.emit(Tt.CONNECTED):this._state==="closed"?this.emit(Tt.CLOSED):this._state==="failed"&&this.emit(Tt.FAILED))}resetReconnectCount(e){_.debug("websocket reset reconnect count, reason: "+e),this.reconnectCount=0}constructor(e,i){let n=arguments.length>2&&arguments[2]!==void 0&&arguments[2],r=arguments.length>3&&arguments[3]!==void 0&&arguments[3],o=arguments.length>4&&arguments[4]!==void 0&&arguments[4],s=arguments.length>5?arguments[5]:void 0;super(),T(this,"_websocketUrl",null),T(this,"connectionID",0),T(this,"currentURLIndex",0),T(this,"urls",[]),T(this,"_reconnectMode","tryNext"),T(this,"reconnectReason",void 0),T(this,"_initMutex",void 0),T(this,"name",void 0),T(this,"_state","closed"),T(this,"reconnectInterrupter",void 0),T(this,"websocket",void 0),T(this,"retryConfig",void 0),T(this,"reconnectCount",0),T(this,"forceCloseTimeout",5e3),T(this,"onlineReconnectListener",void 0),T(this,"useCompress",void 0),T(this,"tryDoubleDomain",!1),T(this,"use443PortOnly",!1),T(this,"wsInflateLength",0),T(this,"wsDeflateLength",0),T(this,"closeEstablishingWs",()=>{}),T(this,"store",void 0),T(this,"joinGatewayRecordIndex",void 0),this.store=s,this.name=e,this.retryConfig=function(u){for(var h=1;h<arguments.length;h++){var p=arguments[h]!=null?arguments[h]:{};h%2?kO(Object(p),!0).forEach(function(g){T(u,g,p[g])}):Object.getOwnPropertyDescriptors?Object.defineProperties(u,Object.getOwnPropertyDescriptors(p)):kO(Object(p)).forEach(function(g){Object.defineProperty(u,g,Object.getOwnPropertyDescriptor(p,g))})}return u}({},i),this.useCompress=n,this.tryDoubleDomain=r,this.use443PortOnly=o,this._initMutex=new ni("websocket",s?s.clientId:void 0);let{timeout:a,timeoutFactor:c}=i,d=Math.max(300,Math.floor(3*a/5)),l=Math.max(1.2,Math.floor(8*c)/10);Wi.ONLINE&&(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l),Ie.on(La.NETWORK_STATE_CHANGE,(u,h)=>{u!==h&&(this.resetReconnectCount("network state change: ".concat(h," -> ").concat(u)),u===Wi.ONLINE?(this.retryConfig.timeout=d,this.retryConfig.timeoutFactor=l):(this.retryConfig.timeout=a,this.retryConfig.timeoutFactor=c))})}getConnection(){return this.websocket||void 0}init(i){return I(this,arguments,function*(e){let n=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,r=yield this._initMutex.lock();this._reconnectMode="tryNext",this.forceCloseTimeout=n,this.urls=e,this.state="connecting";try{let o=pd(),s=this.urls[this.currentURLIndex];A("ENABLE_PREALLOC_PC")&&this.emit(PO.PRE_CONNECT_PC),this.createWebSocketConnection(s).then(o.resolve).catch(o.reject),this.once(Tt.CLOSED,()=>{o.reject(new F(C.WS_DISCONNECT))}),this.once(Tt.CONNECTED,o.resolve),yield o.promise}catch{}finally{r()}})}close(e,i){if(this.currentURLIndex=0,this.resetReconnectCount("close"),this.reconnectInterrupter&&this.reconnectInterrupter(),this.websocket){this.websocket.onclose=null,this.websocket.onopen=null,this.websocket.onmessage=null;let n=this.websocket;i?setTimeout(()=>n.close(),500):n.close(),this.websocket=void 0,this._websocketUrl=null}this.state=e?"failed":"closed",this.closeEstablishingWs&&this.closeEstablishingWs()}reconnect(e,i){if(!this.websocket)return void _.warning("[".concat(this.name,"] can not reconnect, no websocket"));e!==void 0&&(this.reconnectMode=e),_.debug("[".concat(this.name,"] reconnect is triggered initiative")),typeof this.joinGatewayRecordIndex=="number"&&this.store&&this.store.recordJoinChannelService({status:"error",errors:[new Error(i)]},this.joinGatewayRecordIndex);let n=this.websocket.onclose;this.websocket.onclose=null,this.websocket.close(),n&&n.bind(this.websocket)({code:9999,reason:i})}sendMessage(e){let i=arguments.length>2&&arguments[2]!==void 0&&arguments[2];if(!this.websocket||this.websocket.readyState!==WebSocket.OPEN)throw new F(C.WS_ABORT,"websocket is not ready");try{i||(e=JSON.stringify(e)),this.websocket.send(e)}catch(n){throw new F(C.WS_ERR,"send websocket message error"+n.toString())}}setWsInflateData(e){this.wsDeflateLength=this.wsDeflateLength+e.originLength,this.wsInflateLength=this.wsInflateLength+e.compressedLength}getWsInflateData(){let e=this.wsInflateLength,i=this.wsDeflateLength;return this.clearWsInflateData(),{wsInflateLength:e,wsDeflateLength:i}}clearWsInflateData(){this.wsInflateLength=0,this.wsDeflateLength=0}createWebSocketConnection(e){return I(this,null,function*(){var i;let n=pd();this.connectionID+=1,this.joinGatewayRecordIndex=void 0;let r=l=>{var u;(u=this.store)===null||u===void 0||u.signalChannelOpen(),_.debug("[".concat(this.name,"] websocket opened:"),l),this.reconnectMode="retry",this.state="connected",this.resetReconnectCount("opened"),n.resolve()},o=l=>I(this,null,function*(){var u;if(_.debug("[".concat(this.name,"] websocket close ").concat((u=this.websocket)===null||u===void 0?void 0:u.url,", code: ").concat(l.code,", reason: ").concat(l.reason,", current mode: ").concat(this.reconnectMode)),this.reconnectCount>=this.retryConfig.maxRetryCount)n.reject(new F(C.WS_DISCONNECT,"websocket close: ".concat(l.code))),this.close();else{this.state==="connected"&&(this.reconnectReason=l.reason,this.state="reconnecting");let h=Ji(this,Tt.WILL_RECONNECT,this.reconnectMode,l.reason)||this.reconnectMode,p=yield this.reconnectWithAction(h);if(this.state==="closed")return void _.debug("[".concat(this.connectionID,"] ws is closed, no need to reconnect"));if(!p)return n.reject(new F(C.WS_DISCONNECT,"websocket reconnect failed: ".concat(l.code))),this.close(!0);n.resolve()}}),s=l=>{this.emit(Tt.ON_MESSAGE,l)},a=l=>{_.warn("[".concat(this.connectionID,"] ws open error ").concat(l))};this.websocket&&(this.websocket.onclose=null,this.websocket.close()),A("GATEWAY_WSS_ADDRESS")&&this.name.startsWith("gateway")&&(e=A("GATEWAY_WSS_ADDRESS")),_.debug("[".concat(this.name,"] start connect, url:"),e);let c=(i=this.store)===null||i===void 0?void 0:i.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"gateway"});try{var d;this._websocketUrl=hg(e);let l=yield this.chooseBestWebsocketConnection(e);this.websocket=l,r&&r(this.websocket.url),this.websocket.onclose=o,this.websocket.onmessage=s,this.websocket.onerror=a,(d=this.store)===null||d===void 0||d.recordJoinChannelService({endTs:Date.now(),status:"success"},c),this.joinGatewayRecordIndex=c}catch(l){let u=this.state==="closed",h=l instanceof F,p=h&&l.code===C.WS_ABORT,g=h&&l.code===C.WS_ERR,E=h?l.message:l&&(l.reason||l.toString());_.warning("[choose-best-ws] chooseBestWebsocket error: ".concat(E)),this.store&&this.store.recordJoinChannelService({endTs:Date.now(),status:p?"aborted":"error",errors:[l]},c),u||g?(n.reject(u?new F(C.WS_DISCONNECT,"websocket is closed: ".concat(E)):new F(C.WS_ERR,"init websocket failed: ".concat(E))),g&&_.error("[".concat(this.name,"] init websocket failed: ").concat(E))):o&&o(l)}return n.promise})}reconnectWithAction(i){return I(this,arguments,function*(e){let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(this.reconnectCount>=this.retryConfig.maxRetryCount||this.urls.length===0||this.state==="closed")return!1;_.warning("[choose-best-ws] action: =>",e),this.onlineReconnectListener||Ie.isOnline||!Ie.onlineWaiter||(this.onlineReconnectListener=Ie.onlineWaiter.then(()=>{this.onlineReconnectListener=void 0}));let r=!0;if(this.reconnectInterrupter=()=>r=!1,n){let a=yf(this.reconnectCount,this.retryConfig);_.debug("[".concat(this.name,"] wait ").concat(a,"ms to reconnect websocket, mode: ").concat(e)),yield Q.race([qe(a),this.onlineReconnectListener||new Q(()=>{})])}if(this._state==="closed"||!r)return!1;this.reconnectCount+=1;let o=(a,c)=>I(this,null,function*(){this.emit(Tt.RECONNECT_CREATE_CONNECTION,c),yield this.createWebSocketConnection(a)});try{if(e==="retry")yield o(this.urls[this.currentURLIndex],e);else if(e==="tryNext"){if(this.currentURLIndex+=1,this.currentURLIndex>=this.urls.length)return this.reconnectWithAction("recover",!1);_.debug("[".concat(this.name,"] websocket url length: ").concat(this.urls.length," current index: ").concat(this.currentURLIndex)),yield o(this.urls[this.currentURLIndex],e)}else e==="recover"&&(_.debug("[".concat(this.name,"] request new urls")),this.resetReconnectCount("recover mode"),this.urls=yield $e(this,Tt.REQUEST_NEW_URLS),this.currentURLIndex=0,yield o(this.urls[this.currentURLIndex],e))}catch(a){var s;_.error("[".concat(this.name,"] reconnect failed ").concat(a&&a.toString()));let c=a==null||(s=a.data)===null||s===void 0?void 0:s.desc;return Array.isArray(c)&&z(c).call(c,"dynamic key expired")?(this.emit(Tt.ON_TOKEN_PRIVILEGE_DID_EXPIRE),!1):this.reconnectWithAction(e,n)}return!0})}}class pg extends MO{constructor(e,i){super(e,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}chooseBestWebsocketConnection(e,i){return I(this,null,function*(){let n=pd(),r=function(s,a){return new U6(s,a)}(this.forceCloseTimeout,this.store);this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),r.closeAllWebsockets(),n.reject(new F(C.WS_ABORT,"choose best websocket aborted"))};let o=A("GATEWAY_DOMAINS");return _.debug("[choose-best-ws] currentDomain: ",e,", domains: ",o,"total: ".concat(this.urls.length),"current: ".concat(this.currentURLIndex+1)),r.chooseBestWebsocket(e,this.tryDoubleDomain,this.use443PortOnly,i).then(n.resolve).catch(n.reject),n.promise.finally(()=>{this.closeEstablishingWs=void 0})})}}class Nd extends MO{constructor(e,i){super(e,i,arguments.length>2&&arguments[2]!==void 0&&arguments[2],arguments.length>3&&arguments[3]!==void 0&&arguments[3],arguments.length>4&&arguments[4]!==void 0&&arguments[4],arguments.length>5?arguments[5]:void 0)}chooseBestWebsocketConnection(e,i){return I(this,null,function*(){return new Q((n,r)=>{let o=!1,s=[];this.closeEstablishingWs=()=>{_.debug("[choose-best-ws] close establishing websockets"),s.forEach(g=>{g.onclose=null,g.onopen=null,g.onmessage=null,g.close()}),r(new F(C.WS_ABORT,"choose best websocket aborted"))};let a=A("GATEWAY_DOMAINS"),c,d=e.indexOf("?h="),l=a.find(g=>d!==-1?z(e).call(e,g,d):z(e).call(e,g));_.debug("[choose-best-ws] currentDomain: ",l,", domains: ",a);let u=!this.tryDoubleDomain||!l;if(!u&&l){var h;let g=Date.now();try{a.forEach(E=>{let f=d===-1?e.replace(l,E):e.substr(0,d)+e.substr(d).replace(l,E),R=new WebSocket(f);R.binaryType="arraybuffer",s.push(R),_.debug("[choose-best-ws] ws is connecting:",R.url)})}catch{for(_.debug("[choose-best-ws] ws create failed, fallback to single url"),s.forEach(f=>f.close());s.length;)s.pop();u=!0}(h=this.store)===null||h===void 0||h.recordJoinChannelService({urls:s.map(E=>E.url),service:"gateway"},i),s.forEach(E=>{E.onopen=()=>{if(o)return;let f=Date.now()-g;_.debug("[choose-best-ws] ws open cost ".concat(f,"ms")),s.filter(R=>R!==E).forEach(R=>{_.debug("[choose-best-ws]close backup websocket: ".concat(R.url)),R.close()}),o=!0,n(E)},E.onclose=f=>{c=f,!o&&(s.find(R=>!(R.readyState===WebSocket.CLOSED||R.readyState===WebSocket.CLOSING))||(_.debug("[choose-best-ws] all websocket is closed"),o=!0,r(c)))},E.onmessage=f=>{_.debug("[choose-best-ws]".concat(E.url," onmessage: ").concat(f.data))}}),qe(this.forceCloseTimeout).then(()=>{s.forEach(E=>{E.readyState!==WebSocket.OPEN&&E.close()})})}if(u){var p;let g;_.debug("[choose-best-ws] use single url: ",e),(p=this.store)===null||p===void 0||p.recordJoinChannelService({urls:[e],service:"gateway"},i);try{g=new WebSocket(e),s.push(g),g.binaryType="arraybuffer"}catch(E){let f=new F(C.WS_ERR,"init websocket failed! Error: ".concat(E.toString()));return _.error("[".concat(this.name,"]").concat(f)),void r(f)}g.onopen=()=>{n(g)},g.onclose=E=>{r(E)},g.onmessage=E=>{_.debug("[choose-best-ws]".concat(g.url," onmessage: ").concat(E.data))},qe(this.forceCloseTimeout).then(()=>{g&&g.readyState!==WebSocket.OPEN&&g.close()})}}).then(n=>(this.closeEstablishingWs=void 0,n)).catch(n=>{throw this.closeEstablishingWs=void 0,n})})}}class x6 extends ue{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===ie.CONNECTED?this.emit(Et.WS_CONNECTED):e===ie.RECONNECTING?this.emit(Et.WS_RECONNECTING,this._websocketReconnectReason):e===ie.CLOSED&&this.emit(Et.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),T(this,"_disconnectedReason",void 0),T(this,"_websocketReconnectReason",void 0),T(this,"_connectionState",ie.CLOSED),T(this,"reconnectToken",void 0),T(this,"websocket",void 0),T(this,"openConnectionTime",void 0),T(this,"clientId",void 0),T(this,"lastMsgTime",Date.now()),T(this,"uploadCache",[]),T(this,"uploadCacheInterval",void 0),T(this,"rttRolling",new YA(5)),T(this,"pingpongTimer",void 0),T(this,"wsInflateDataTimer",void 0),T(this,"pingpongTimeoutCount",0),T(this,"joinResponse",void 0),T(this,"multiIpOption",void 0),T(this,"initError",void 0),T(this,"spec",void 0),T(this,"store",void 0),T(this,"onWebsocketMessage",n=>{if(n.data instanceof ArrayBuffer)return void this.emit(Et.ON_BINARY_DATA,n.data);let r=JSON.parse(n.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){if(this.emit(r._type,r._message),r._type===wt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===wt.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Ft.UID_BANNED);break;case 15:this.close(Ft.IP_BANNED);break;case 16:this.close(Ft.CHANNEL_BANNED)}if(r._type===wt.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case dt.ERR_LICENSE_MISSING:this.close(Ft.LICENSE_MISSING);break;case dt.ERR_LICENSE_EXPIRED:this.close(Ft.LICENSE_EXPIRED);break;case dt.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ft.LICENSE_MINUTES_EXCEEDED);break;case dt.ERR_LICENSE_PERIOD_INVALID:this.close(Ft.LICENSE_PERIOD_INVALID);break;case dt.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ft.LICENSE_MULTIPLE_SDK_SERVICE);break;case dt.ERR_LICENSE_ILLEGAL:this.close(Ft.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new pg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,A("JOIN_GATEWAY_USE_DUAL_DOMAIN"),A("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===ie.CONNECTED&&this.reconnect("retry",Ze.OFFLINE)})}request(e,i,n,r){return I(this,null,function*(){let o=te(6,""),s={_id:o,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new Q((g,E)=>{if(this.connectionState===ie.CONNECTED)return g();let f=()=>{this.off(Et.WS_CLOSED,R),g()},R=()=>{this.off(Et.WS_CONNECTED,f),E(new x(C.WS_ABORT))};this.once(Et.WS_CONNECTED,f),this.once(Et.WS_CLOSED,R),e!==pt.PUBLISH&&e!==pt.PUBLISH_DATASTREAM&&e!==pt.SUBSCRIBE&&e!==pt.SUBSCRIBE_DATASTREAM&&e!==pt.UNSUBSCRIBE&&e!==pt.UNSUBSCRIBE_DATASTREAM&&e!==pt.UNPUBLISH&&e!==pt.UNPUBLISH_DATASTREAM&&e!==pt.CONTROL&&e!==pt.RESTART_ICE||this.once(Et.DISCONNECT_P2P,()=>{E(new x(C.DISCONNECT_P2P))}),e!==pt.PUBLISH&&e!==pt.RESTART_ICE||this.once(Et.ABORT_P2P_EXECUTION,()=>{E(new x(C.DISCONNECT_P2P))})});if(this.connectionState!==ie.CONNECTING&&this.connectionState!==ie.RECONNECTING||e===pt.JOIN||e===pt.REJOIN||(yield c()),this.websocket.sendMessage(s,!0),r)return;let d=new Q((g,E)=>{let f=!1,R=(N,k)=>{f=!0,g({isSuccess:N==="success",message:k||{}}),this.off(Et.WS_CLOSED,y),this.off(Et.WS_RECONNECTING,y),this.emit(Et.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),R);let y=()=>{E(new x(C.WS_ABORT,"type: ".concat(e))),this.off(Et.WS_CLOSED,y),this.off(Et.WS_RECONNECTING,y),this.off("res-@".concat(o),R)};this.once(Et.WS_CLOSED,y),this.once(Et.WS_RECONNECTING,y),qe(A("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||f||(_.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Et.REQUEST_TIMEOUT,e,i))})}),l=null;try{l=yield d}catch(g){if(this.connectionState===ie.CLOSED||e===pt.LEAVE)throw new x(C.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?g.throw():e===pt.JOIN||e===pt.REJOIN?null:(yield c(),yield this.request(e,i))}if(l.isSuccess)return l.message;let u=Number(l.message.error_code||l.message.code),h=Od(u),p=new x(C.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message,desc:h.desc});return h.action==="success"?l.message:(_.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===dt.ERR_TOO_MANY_BROADCASTERS?((e===pt.JOIN||e===pt.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===dt.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Ze.MULTI_IP)):this.reconnect(h.action,Ze.SERVER_ERROR),e===pt.JOIN||e===pt.REJOIN?null:yield this.request(e,i)))})}waitMessage(e,i){return new Q(n=>{let r=o=>{(!i||i(o))&&(this.off(e,r),n(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Ad.WRTC_STATS,i)}upload(e,i){let n={_type:e,_message:i};try{this.websocket.sendMessage(n)}catch{let o=A("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==ie.CONNECTED)return;let s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},A("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,i){let n={_type:e,_message:i};this.websocket.sendMessage(n)}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Q((i,n)=>{this.once(Et.WS_CONNECTED,()=>i(this.joinResponse)),this.once(Et.WS_CLOSED,r=>n(this.initError||new x(C.WS_ABORT,r))),this.connectionState=ie.CONNECTING,this.websocket.init(e).catch(n),this.wsInflateDataTimer&&window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=window.setInterval(()=>{this.handleWsInflateData()},2e4)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.wsInflateDataTimer&&(this.handleWsInflateData(),window.clearInterval(this.wsInflateDataTimer),this.wsInflateDataTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._disconnectedReason=e||Ft.LEAVE,this.connectionState=ie.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close()}join(){return I(this,null,function*(){if(!this.joinResponse){this.emit(Et.ABORT_P2P_EXECUTION);let e=yield $e(this,Et.REQUEST_JOIN_INFO),i=yield this.request(pt.JOIN,e);if(!i)return this.emit(Et.REPORT_JOIN_GATEWAY,Gh.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(Et.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=ie.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0})}rejoin(){return I(this,null,function*(){if(!this.reconnectToken)throw new x(C.UNEXPECTED_ERROR,"can not rejoin, no rejoin token");let e=Sd(this,Et.REQUEST_REJOIN_INFO);e.token=this.reconnectToken;let i=yield this.request(pt.REJOIN,e);return!!i&&(this.connectionState=ie.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),i.peers&&i.peers.forEach(n=>{this.emit(wt.ON_USER_ONLINE,{uid:n.uid}),n.audio&&this.emit(wt.ON_ADD_AUDIO_STREAM,{uid:n.uid,uint_id:n.uint_id,audio:!0,ssrcId:n.audio_ssrc}),n.video&&this.emit(wt.ON_ADD_VIDEO_STREAM,{uid:n.uid,uint_id:n.uint_id,video:!0,ssrcId:n.video_ssrc}),n.audio_mute?this.emit(wt.MUTE_AUDIO,{uid:n.uid}):this.emit(wt.UNMUTE_AUDIO,{uid:n.uid}),n.video_mute?this.emit(wt.MUTE_VIDEO,{uid:n.uid}):this.emit(wt.UNMUTE_VIDEO,{uid:n.uid}),n.audio_enable_local?this.emit(wt.ENABLE_LOCAL_AUDIO,{uid:n.uid}):this.emit(wt.DISABLE_LOCAL_AUDIO,{uid:n.uid}),n.video_enable_local?this.emit(wt.ENABLE_LOCAL_VIDEO,{uid:n.uid}):this.emit(wt.DISABLE_LOCAL_VIDEO,{uid:n.uid}),n.audio||n.video||this.emit(wt.ON_REMOVE_STREAM,{uid:n.uid,uint_id:n.uint_id})}),!0)})}reconnect(e,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,i)}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);let i=Od(e.code);if(e.code===28&&"detail"in e&&(_.info("[".concat(this.clientId,"] receive recover notification: "),e.detail),this.emit(Et.RECOVER_NOTIFICATION,e.detail)),i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ft.UID_BANNED),void this.close()):void this.reconnect(i.action,Ze.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=A("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[".concat(this.clientId,"] PING-PONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>A("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Ze.TIMEOUT):this.request(pt.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let n=Date.now()-i;this.rttRolling.add(n),A("REPORT_STATS")&&this.send(pt.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleWsInflateData(){let{wsInflateLength:e,wsDeflateLength:i}=this.websocket.getWsInflateData();e!==0&&i!==0&&this.upload(Ad.WS_INFLATE_DATA_LENGTH,{ws_deflate_length:i,ws_inflate_length:e})}handleWebsocketEvents(){this.websocket.on(Tt.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Et.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Tt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Tt.CLOSED,()=>{this.connectionState=ie.CLOSED}),this.websocket.on(Tt.FAILED,()=>{this._disconnectedReason=Ft.NETWORK_ERROR,this.connectionState=ie.CLOSED}),this.websocket.on(Tt.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===ie.CONNECTED?this.connectionState=ie.RECONNECTING:this.connectionState=ie.CONNECTING}),this.websocket.on(Tt.WILL_RECONNECT,(e,i,n)=>{let r=Sd(this,Et.IS_P2P_DISCONNECTED),o=r||e!=="retry";r&&e==="retry"&&(_.debug("".concat(this.clientId," reconnect mode is retry, but p2p lost, change to tryNext")),e="tryNext",i=Gh.P2P_DISCONNECTED),o&&(_.debug("".concat(this.clientId," will renewSession, reconnect mode: ").concat(e)),this.emit(Et.REPORT_JOIN_GATEWAY,i||Gh.UNKNOWN_REASON,this.url||""),this.reconnectToken=void 0,this.emit(Et.DISCONNECT_P2P)),n(e)}),this.websocket.on(Tt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.reconnectToken?this.rejoin().catch(e=>{_.warning("[".concat(this.clientId,"] rejoin failed ").concat(e)),this.reconnect("tryNext",Ze.SERVER_ERROR)}):this.join().catch(e=>{if(this.emit(Et.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof x){if(e.code===C.UNEXPECTED_RESPONSE&&e.data.code===dt.ERR_NO_AUTHORIZED)return this.initError=new x(C.TOKEN_EXPIRE,"dynamic key expired"),void this.close(Ft.TOKEN_EXPIRE);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Ze.SERVER_ERROR):(this.initError=e,this.close())}})}),this.websocket.on(Tt.REQUEST_NEW_URLS,(e,i)=>{$e(this,Et.REQUEST_RECOVER,this.multiIpOption).then(e).catch(i)}),this.websocket.on(Tt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(wt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)}),this.websocket.on(PO.PRE_CONNECT_PC,()=>{this.emit(Et.PRE_CONNECT_PC)})}}let V6=function(t){return t.NATIVE_RTC="native_rtc",t.NATIVE_RTM="native_rtm",t.WEB_RTC="web_rtc",t.WEB_RTM="web_rtm",t}({}),Ae=function(t){return t[t.CHOOSE_SERVER=11]="CHOOSE_SERVER",t[t.CLOUD_PROXY=18]="CLOUD_PROXY",t[t.CLOUD_PROXY_5=20]="CLOUD_PROXY_5",t[t.CLOUD_PROXY_FALLBACK=26]="CLOUD_PROXY_FALLBACK",t}({});function UO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Hh(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?UO(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):UO(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function Bo(t){return t.match(/^[\.\:\d]+$/)?"".concat(t.replace(/[^\d]/g,"-"),".").concat(A("TURN_DOMAIN")):(_.debug("Cannot recognized as ip address: ".concat(t,", use as host")),t)}function _g(t,e){t.addresses||(t.addresses=[]);let i=function(a,c){if(A("CONNECT_GATEWAY_WITHOUT_DOMAIN"))return a.map(u=>{let{ip:h,port:p}=u;return{address:"".concat(h,":").concat(p)}});let d=A("GATEWAY_DOMAINS"),l=d[1]&&z(c).call(c,d[1])?1:0;return a.map(u=>{let{domain_prefix:h,port:p,ip:g}=u;if(h)return{address:"".concat(h,".").concat(d[l++%d.length],":").concat(p)};let E=/^[\.\:\d]+$/.test(g),f=E?"".concat(g.replace(/[^\d]/g,"-"),".").concat(d[l++%d.length],":").concat(p):"".concat(g,":").concat(p);return E||_.debug("Cannot recognized as ip address: ".concat(g,", use as host")),{ip:g,port:p,address:f}})}(t.addresses,e),n=Array.isArray(t.detail)&&t.detail[18];if(n&&typeof n=="string"){let a=n.split(";");for(let c=0;c<a.length;c++){var r;let d=ui(r=a[c]).call(r);i[c]&&d&&(i[c].ip6=d)}}let o=t.detail&&t.detail.candidate,s;if(o){let[a,c]=o.split(":");a&&c&&(s={port:Number(c),ip:a,address:"".concat(a,":").concat(c)})}return{gatewayAddrs:i,apGatewayAddress:s,uid:t.uid,cid:t.cid,cert:t.cert,vid:t.detail&&t.detail[8],uni_lbs_ip:t.detail&&t.detail[1],res:t,csIp:t.detail&&t.detail[502]}}function Hi(t){return typeof t=="number"?t:t.exact||t.ideal||t.max||t.min||0}function xO(t){let e=t._encoderConfig;if(!e)return{};let i={resolution:e.width&&e.height?"".concat(Hi(e.width),"x").concat(Hi(e.height)):void 0,maxVideoBW:e.bitrateMax,minVideoBW:e.bitrateMin};return typeof e.frameRate=="number"?(i.maxFrameRate=e.frameRate,i.minFrameRate=e.frameRate):e.frameRate&&(i.maxFrameRate=e.frameRate.max||e.frameRate.ideal||e.frameRate.exact||e.frameRate.min,i.minFrameRate=e.frameRate.min||e.frameRate.ideal||e.frameRate.exact||e.frameRate.max),i}function VO(t){return t>=0&&t<.17?1:t>=.17&&t<.36?2:t>=.36&&t<.59?3:t>=.59&&t<=1?4:t>1?5:0}function Dd(t,e){let i,n,r;switch(e){case Ae.CHOOSE_SERVER:n=4096,r="choose server";break;case Ae.CLOUD_PROXY:n=1048576,r="proxy";break;case Ae.CLOUD_PROXY_5:n=4194304,r="proxy5";break;case Ae.CLOUD_PROXY_FALLBACK:n=4194310,r="proxy fallback";break;default:throw new x(C.UNEXPECTED_ERROR,"multi unlibs response transformer get unknown service id",{csIp:t.detail&&t.detail[502],retry:!1})}if(t.response_body.forEach(o=>{o.buffer&&o.buffer.flag===n&&(i={code:o.buffer.code,addresses:(o.buffer.edges_services||[]).map(s=>Hh(Hh({},s),{},{ticket:o.buffer.cert})),server_ts:t.enter_ts,uid:o.buffer.uid,cid:o.buffer.cid,cname:o.buffer.cname,detail:Hh(Hh({},o.buffer.detail),t.detail),flag:o.buffer.flag,opid:t.opid,cert:o.buffer.cert})}),!i)throw new x(C.MULTI_UNILBS_RESPONSE_ERROR,"cannot parse response ".concat(r," from multi unilbs response"),{csIp:t.detail&&t.detail[502]});return i}function FO(t,e){return I(this,null,function*(){return yield Q.all(t.addresses.map(i=>I(null,null,function*(){return{address:A("USE_TURN_IP")?i.ip:Bo(i.ip),tcpport:i.port,udpport:i.port,username:e&&A("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?e.toString():ti.username,password:e&&A("ENCRYPT_PROXY_USERNAME_AND_PSW")&&window.isSecureContext?yield gf(e.toString()):ti.password}})))})}function mg(t,e){let i=e.getMediaStreamTrack(!0).getSettings(),n=e.videoHeight||i.height,r=e.videoWidth||i.width;return n&&r?Math.max(Math.min(n,r)/Math.min(Hi(t.height),Hi(t.width)),1):(_.warning("can't get ori-track's height, default scale down 4 times for low stream"),4)}function jo(t){let{candidateType:e,relayProtocol:i,type:n,address:r,port:o,protocol:s}=t,a={candidateType:e,relayProtocol:i,protocol:s};if(n!=="local-candidate"){let c=r.split(".");c.length>=4&&(c[1]="*",c[2]="*"),a.address=c.join("."),a.port=o}return a}function Kh(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:A("SVC_MODE");if(A("ENABLE_SVC"))return function(e){return e in Th}(t)?t:Th.L1T3}let BO={[$.VIDEO]:[{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"},{key:"video-orientation",extensionName:"urn:3gpp:video-orientation"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"playout-delay",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/playout-delay"},{key:"video-content-type",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-content-type"},{key:"color-space",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/color-space"},{key:"video-timing",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/video-timing"}],[$.AUDIO]:[{key:"ssrc-audio-level",extensionName:"urn:ietf:params:rtp-hdrext:ssrc-audio-level"},{key:"draft-holmer-rmcat-transport-wide-cc-extensions-01",extensionName:"http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"},{key:"abs-send-time",extensionName:"http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"}]};function qh(t,e,i){e.forEach(n=>{var r;let o=BO[t].find(a=>{var c;let{key:d}=a;return z(c=n.extensionName).call(c,d)});if(!o)return;let s=i.find(a=>{let{extensionName:c}=a;return z(c).call(c,o.key)});s&&z(r=s.extensionName).call(r,"gdpr_forbidden")&&(n.extensionName=s.extensionName)})}function ec(t,e){e.forEach(i=>{var n;let r=BO[t].find(o=>{var s;let{key:a}=o;return z(s=i.extensionName).call(s,a)});z(n=i.extensionName).call(n,"gdpr_forbidden")&&r&&(i.extensionName=r.extensionName)})}function jO(t){return t==="http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time"||z(t).call(t,"abs-send-time")}function Yh(t){return t==="http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01"||z(t).call(t,"draft-holmer-rmcat-transport-wide-cc-extensions-01")}function GO(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function WO(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?GO(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):GO(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function Pd(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},n=arguments.length>3?arguments[3]:void 0,{filterRTX:r,filterVideoFec:o,filterAudioFec:s,filterAudioCodec:a,filterVideoCodec:c}=e,{useXR:d}=i,l=[],u=[],h=[],p=[],g=!1,E=!1;if(Li(t).mediaDescriptions.forEach(R=>{n&&n!==R.attributes.direction||(R.media.mediaType!=="video"||g||(u=R.attributes.payloads,p=R.attributes.extmaps,g=!0),R.media.mediaType!=="audio"||E||(l=R.attributes.payloads,h=R.attributes.extmaps,E=!0))}),!p||u.length===0)throw new Error("Cannot get video capabilities from SDP.");if(!h||l.length===0)throw new Error("Cannot get audio capabilities from SDP.");if(u.forEach(R=>{var y;(y=R.rtpMap)!==null&&y!==void 0&&y.clockRate&&(R.rtpMap.clockRate=parseInt(R.rtpMap.clockRate)),d&&R.rtcpFeedbacks.push({type:"rrtr"})}),l.forEach(R=>{var y;(y=R.rtpMap)!==null&&y!==void 0&&y.clockRate&&(R.rtpMap.clockRate=parseInt(R.rtpMap.clockRate)),d&&R.rtcpFeedbacks.push({type:"rrtr"})}),r&&(l=l.filter(R=>{var y;return((y=R.rtpMap)===null||y===void 0?void 0:y.encodingName.toLowerCase())!=="rtx"}),u=u.filter(R=>{var y;return((y=R.rtpMap)===null||y===void 0?void 0:y.encodingName.toLowerCase())!=="rtx"})),o&&(u=u.filter(R=>{var y;return!/(red)|(ulpfec)|(flexfec)/i.test(((y=R.rtpMap)===null||y===void 0?void 0:y.encodingName)||"")})),s&&(l=l.filter(R=>{var y;return!/(red)|(ulpfec)|(flexfec)/i.test(((y=R.rtpMap)===null||y===void 0?void 0:y.encodingName)||"")})),a&&a?.length>0&&(l=l.filter(R=>{var y;return z(a).call(a,((y=R.rtpMap)===null||y===void 0?void 0:y.encodingName.toLowerCase())||"")})),c&&c?.length>0){let R=u.filter(y=>{var N;return z(c).call(c,((N=y.rtpMap)===null||N===void 0?void 0:N.encodingName.toLowerCase())||"")});u=R.concat(r?[]:gg(R,u))}let f=A("UNSUPPORTED_VIDEO_CODEC");return f&&f.length>0&&(u=u.filter(R=>!(R.rtpMap&&z(f).call(f,R.rtpMap.encodingName.toLowerCase())))),{audioCodecs:l,videoCodecs:u,audioExtensions:h,videoExtensions:p}}function Go(t){let e=Li(t),i,n;for(let r of e.mediaDescriptions){if(!i){let o=r.attributes.iceUfrag,s=r.attributes.icePwd;if(!o||!s)throw new Error("Cannot get iceUfrag or icePwd from SDP.");i={iceUfrag:o,icePwd:s}}if(!n){let o=r.attributes.fingerprints;o.length>0&&(n={fingerprints:o})}}if(!n&&e.attributes.fingerprints.length>0&&(n={fingerprints:e.attributes.fingerprints}),!n||!i)throw new Error("Cannot get iceParameters or dtlsParameters from SDP.");return{iceParameters:i,dtlsParameters:n}}function HO(t,e){let i=[],n=t.attributes.ssrcGroups.filter(s=>s.semantic==="FID"),r=t.attributes.ssrcGroups.find(s=>s.semantic==="SIM"),o=t.attributes.ssrcs;if(r)r.ssrcIds.forEach(s=>{var a;let c=(a=n.find(d=>d.ssrcIds[0]===s))===null||a===void 0?void 0:a.ssrcIds[1];i.push({ssrcId:s,rtx:e?c:void 0})});else if(n.length>0){let s=n[0].ssrcIds[0],a=n[0].ssrcIds[1];i.push({ssrcId:s,rtx:e?a:void 0})}else{if(o.length===0)throw new Error("No ssrcs found on local media description.");i.push({ssrcId:o[0].ssrcId})}return i}function KO(t,e,i){let{cname:n}=t,r=[];e&&(r=qO(e)),r.length===0&&(r=t.iceParameters.candidates.map(l=>({foundation:l.foundation,componentId:"1",transport:l.protocol,priority:l.priority.toString(),connectionAddress:l.ip,port:l.port.toString(),type:l.type,extension:{}})),_.debug("Using candidates from gateway."));let o={fingerprints:t.dtlsParameters.fingerprints.map(l=>({hashFunction:l.algorithm,fingerprint:l.fingerprint}))},s={iceUfrag:t.iceParameters.iceUfrag,icePwd:t.iceParameters.icePwd},a;switch(t.dtlsParameters.role){case"server":a="passive";break;case"client":a="active";break;case"auto":a="actpass"}let c=Xh(t.rtpCapabilities),d=[];return Array.isArray(i)&&i.length>0&&i.forEach(l=>{d.push({kind:$.VIDEO,ssrcId:l.v,rtx:l.v_rtx,mslabel:"".concat(l.v,"_").concat(l.a)},{kind:$.AUDIO,ssrcId:l.a,mslabel:"".concat(l.v,"_").concat(l.a)})}),{dtlsParameters:o,iceParameters:s,candidates:r,rtpCapabilities:c,setup:a,cname:n,preSSRCs:d}}function qO(t){let e=[];return t.ip&&typeof t.port=="number"&&(e=[{foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip,port:t.port.toString(),type:"host",extension:{}}],_.debug("Using remote candidate from AP ".concat(t.ip,":").concat(t.port)),t.ip6&&(e.push({foundation:"udpcandidate",componentId:"1",transport:"udp",priority:"2103266323",connectionAddress:t.ip6,port:t.port.toString(),type:"host",extension:{}}),_.debug("Using IPV6 remote candidate from AP ".concat(t.ip6,":").concat(t.port)))),e}function Ns(t,e,i){let n=[],r=[];return t.forEach(o=>{let{ssrcId:s,rtx:a}=o,c=te(8,"track-"),d={ssrcId:s,attributes:WO({label:c,mslabel:i=i||te(10,""),msid:"".concat(i," ").concat(c)},e&&{cname:e})};if(n.push(d),a!==void 0){let l={ssrcId:a,attributes:WO({label:c,mslabel:i,msid:"".concat(i," ").concat(c)},e&&{cname:e})};n.push(l),r.push({semantic:"FID",ssrcIds:[s,a]})}}),t.length>1&&r.push({semantic:"SIM",ssrcIds:t.map(o=>{let{ssrcId:s}=o;return s})}),{ssrcs:n,ssrcGroups:r}}function ic(t,e){e instanceof ge&&t.attributes.payloads.forEach(i=>{var n;let r=(n=i.rtpMap)===null||n===void 0?void 0:n.encodingName.toLowerCase();if(!r||["opus","pcmu","pcma","g722"].indexOf(r)===-1)return;i.fmtp||(i.fmtp={parameters:{}}),r==="opus"&&typeof A("OPUS_PTIME")=="number"?i.fmtp.parameters.ptime=A("OPUS_PTIME"):i.fmtp.parameters.minptime="10",i.fmtp.parameters.useinbandfec="1";let o=e._encoderConfig;o&&(r!=="pcmu"&&r!=="pcma"&&r!=="g722"&&(o.bitrate&&!_e()&&(i.fmtp.parameters.maxaveragebitrate="".concat(Math.floor(1e3*o.bitrate))),o.sampleRate&&(i.fmtp.parameters.maxplaybackrate="".concat(o.sampleRate),i.fmtp.parameters["sprop-maxcapturerate"]="".concat(o.sampleRate)),o.stereo&&(i.fmtp.parameters.stereo="1",i.fmtp.parameters["sprop-stereo"]="1")),e instanceof bd&&r==="opus"&&e._config.DTX&&(i.fmtp.parameters.usedtx="1"))})}function Eg(t){let e=t.attributes.unrecognized.findIndex(i=>i.attField==="x-google-flag"&&i.attValue==="conference");e!==-1&&t.attributes.unrecognized.splice(e,1)}function fg(t,e){var i;if(!(e instanceof re&&e._encoderConfig&&e._hints.indexOf(Jt.SCREEN_TRACK)===-1))return;let n=e._encoderConfig;Mt().supportMinBitrate&&n.bitrateMin&&t.attributes.payloads.forEach(r=>{var o,s;z(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-min-bitrate"]="".concat(n.bitrateMin))}),Mt().supportMinBitrate&&!z(i=e._hints).call(i,Jt.LOW_STREAM)&&n.bitrateMax&&t.attributes.payloads.forEach(r=>{var o,s;z(o=["h264","h265","vp8","vp9","av1"]).call(o,((s=r.rtpMap)===null||s===void 0?void 0:s.encodingName.toLowerCase())||"")&&(r.fmtp||(r.fmtp={parameters:{}}),r.fmtp.parameters["x-google-start-bitrate"]="".concat(A("X_GOOGLE_START_BITRATE")||Math.floor(n.bitrateMax)))})}function YO(t){if(t.media.mediaType!=="video")return;let e=kt();if(e.name!==xt.SAFARI&&e.os!==Ve.IOS)return;let i=t.attributes.extmaps.findIndex(n=>/video-orientation/g.test(n.extensionName));i!==-1&&t.attributes.extmaps.splice(i,1)}function zh(t,e,i){if(!e)return;let n,r;if(t.media.mediaType==="video"?(n=i.videoExtensions,r=i.videoCodecs):(n=i.audioExtensions,r=i.audioCodecs),e.twcc===!0){let o=n.find(s=>Yh(s.extensionName));if(o){let s=o.extensionName;t.attributes.extmaps.find(c=>Yh(c.extensionName))||t.attributes.extmaps.push({entry:o.entry,extensionName:s}),function(c,d){return d.filter(l=>!!c.find(u=>u.payloadType===l.payloadType&&!!u.rtcpFeedbacks.find(h=>h.type==="transport-cc")))}(r,t.attributes.payloads).forEach(c=>{c.rtcpFeedbacks.find(d=>d.type==="transport-cc")||c.rtcpFeedbacks.push({type:"transport-cc"})})}}else if(e.twcc===!1){let o=t.attributes.extmaps.findIndex(s=>Yh(s.extensionName));o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{let a=s.rtcpFeedbacks.findIndex(c=>c.type==="transport-cc");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}if(e.remb===!0){let o=n.find(s=>jO(s.extensionName));if(o){let s=o.extensionName;t.attributes.extmaps.find(c=>c.extensionName===s)||t.attributes.extmaps.push({entry:o.entry,extensionName:s}),function(c,d){return d.filter(l=>!!c.find(u=>u.payloadType===l.payloadType&&!!u.rtcpFeedbacks.find(h=>h.type==="goog-remb")))}(r,t.attributes.payloads).forEach(c=>{c.rtcpFeedbacks.find(d=>d.type==="goog-remb")||c.rtcpFeedbacks.push({type:"goog-remb"})})}}else if(e.remb===!1){let o=t.attributes.extmaps.findIndex(s=>jO(s.extensionName));o!==-1&&t.attributes.extmaps.splice(o,1),t.attributes.payloads.forEach(s=>{let a=s.rtcpFeedbacks.findIndex(c=>c.type==="goog-remb");a!==-1&&s.rtcpFeedbacks.splice(a,1)})}}function zO(t,e,i){if(_e()||t.media.mediaType!=="video"||!(e instanceof re)||i!=="vp9"&&i!=="vp8"||i==="vp8"&&!A("SIMULCAST")||i==="vp9"&&A("ENABLE_SVC")||e._scalabilityMode===void 0||e._scalabilityMode.numSpatialLayers<=1)return;let n=i==="vp8"?2:e._scalabilityMode.numSpatialLayers,r=t.attributes.ssrcs[0],o=t.attributes.ssrcGroups.find(a=>a.semantic==="FID"&&a.ssrcIds[0]===r.ssrcId),s={semantic:"SIM",ssrcIds:[r.ssrcId]};for(let a=1;a<n;a++)t.attributes.ssrcs.push({ssrcId:r.ssrcId+a,attributes:he(r.attributes)}),s.ssrcIds.push(r.ssrcId+a),o&&(t.attributes.ssrcs.push({ssrcId:o.ssrcIds[1]+a,attributes:he(r.attributes)}),t.attributes.ssrcGroups.push({semantic:"FID",ssrcIds:[r.ssrcId+a,o.ssrcIds[1]+a]}));t.attributes.ssrcGroups.unshift(s)}function XO(){return I(this,arguments,function*(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=new RTCPeerConnection;i.addTransceiver("video",{direction:"sendonly"}),i.addTransceiver("audio",{direction:"sendonly"}),i.addTransceiver("video",{direction:"recvonly"}),i.addTransceiver("audio",{direction:"recvonly"});let n=(yield i.createOffer()).sdp,{send:r,recv:o,sendrecv:s}=function(){let a=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},c=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},d=arguments.length>2?arguments[2]:void 0,l=Pd(d,a,c,"sendonly"),u=Pd(d,a,c,"recvonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},g={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Fn(l,u,"videoExtensions",h,p,g),Fn(l,u,"videoCodecs",h,p,g),Fn(l,u,"audioExtensions",h,p,g),Fn(l,u,"audioCodecs",h,p,g),A("RAISE_H264_BASELINE_PRIORITY")){let E=[],f=[];g.videoCodecs.forEach((R,y)=>{var N;if(((N=R.rtpMap)===null||N===void 0?void 0:N.encodingName.toLocaleLowerCase())==="h264"){var k,L;let P=g.videoCodecs[y+1],V=P&&tN(R,P),B=(k=R.fmtp)===null||k===void 0?void 0:k.parameters["profile-level-id"],Y=(L=R.fmtp)===null||L===void 0?void 0:L.parameters["packetization-mode"];!B||B!==A("FIRST_H264_PROFILE_LEVEL_ID")||A("FIRST_PACKETIZATION_MODE")&&Y!==A("FIRST_PACKETIZATION_MODE")?V?f.push([R,P]):f.push([R]):V?E.push([R,P]):E.push([R])}}),E.length>0&&f.length>0&&(_.debug("raising H264 baseline profile priority"),g.videoCodecs.forEach((R,y)=>{var N;if(((N=R.rtpMap)===null||N===void 0?void 0:N.encodingName.toLocaleLowerCase())==="h264"){let k=tN(R,g.videoCodecs[y+1]),L=E.shift()||f.shift()||[];L.length>0&&(k?g.videoCodecs.splice(y,2,...L):g.videoCodecs.splice(y,1,...L))}}),p.videoCodecs=p.videoCodecs.filter(R=>{var y,N;return!(((y=R.rtpMap)===null||y===void 0?void 0:y.encodingName.toLocaleLowerCase())==="h264"&&((N=R.fmtp)===null||N===void 0?void 0:N.parameters["profile-level-id"])!==A("FIRST_H264_PROFILE_LEVEL_ID"))}),A("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(R=>{var y,N;return!(((y=R.rtpMap)===null||y===void 0?void 0:y.encodingName.toLocaleLowerCase())==="h264"&&((N=R.fmtp)===null||N===void 0?void 0:N.parameters["profile-level-id"])!==A("FIRST_H264_PROFILE_LEVEL_ID"))})))}return{send:h,recv:p,sendrecv:g}}(t,e,n);try{i.close()}catch{}return{send:r,recv:o,sendrecv:s}})}function JO(){let t={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},e=Pd(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"recvonly"),i={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},n={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Fn(t,e,"videoExtensions",i,n,r),Fn(t,e,"videoCodecs",i,n,r),Fn(t,e,"audioExtensions",i,n,r),Fn(t,e,"audioCodecs",i,n,r),A("RAISE_H264_BASELINE_PRIORITY")){let o=r.videoCodecs.findIndex(s=>s.rtpMap&&s.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&s.fmtp&&s.fmtp.parameters["profile-level-id"]==="42001f");if(o!==-1){let s=r.videoCodecs.findIndex(a=>a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(s<o){_.debug("raising H264 baseline profile priority");let a=r.videoCodecs[o];r.videoCodecs.splice(o,1),r.videoCodecs.splice(s,0,a)}s!==-1&&(n.videoCodecs=n.videoCodecs.filter(a=>!(a.rtpMap&&a.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&a.fmtp&&a.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:i,recv:n,sendrecv:r}}function Fn(t,e,i,n,r,o){if(i==="videoExtensions"||i==="audioExtensions"){let s=[];return t[i].forEach(a=>{e[i].some((c,d)=>{if(a.entry===c.entry&&a.extensionName===c.extensionName)return s.push(d),!0})?o[i].push(a):n[i].push(a)}),void e[i].forEach((a,c)=>{s.indexOf(c)===-1&&r[i].push(a)})}if(i==="videoCodecs"||i==="audioCodecs"){let s=[];return t[i].forEach(a=>{e[i].some((c,d)=>{if(a.payloadType===c.payloadType&&JSON.stringify(a)===JSON.stringify(c))return s.push(d),!0})?o[i].push(a):n[i].push(a)}),void e[i].forEach((a,c)=>{s.indexOf(c)===-1&&r[i].push(a)})}}function Xh(t){let{send:e,recv:i,sendrecv:n}=t;if(!n){if(!e||!i)throw new Error("cannot merge rtp capabilities because one of send or recv is empty!");return{send:e,recv:i}}let r,o;return e?(r={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},r.audioCodecs=[...e.audioCodecs,...n.audioCodecs],r.videoCodecs=[...e.videoCodecs,...n.videoCodecs],r.audioExtensions=[...e.audioExtensions,...n.audioExtensions],r.videoExtensions=[...e.videoExtensions,...n.videoExtensions]):r=n,i?(o={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},o.audioCodecs=[...i.audioCodecs,...n.audioCodecs],o.videoCodecs=[...i.videoCodecs,...n.videoCodecs],o.audioExtensions=[...i.audioExtensions,...n.audioExtensions],o.videoExtensions=[...i.videoExtensions,...n.videoExtensions]):o=n,{send:r,recv:o}}function nc(t){t.media.mediaType==="audio"&&t.attributes.payloads.filter(e=>{var i;return((i=e.rtpMap)===null||i===void 0?void 0:i.encodingName.toLowerCase())==="opus"}).forEach(e=>{e.fmtp||(e.fmtp={parameters:{}}),e.fmtp.parameters.stereo="1",e.fmtp.parameters["sprop-stereo"]="1"})}function Ld(t,e,i,n){let r=[];if(t===$.VIDEO){if(A("H264_PROFILE_LEVEL_ID")&&n==="h264"&&(r=e.videoCodecs.filter(o=>{var s;return z(s=o.rtpMap&&o.rtpMap.encodingName.toLowerCase()||"").call(s,n)&&o&&o.fmtp&&o.fmtp.parameters["profile-level-id"]===A("H264_PROFILE_LEVEL_ID")})),!Array.isArray(r)||r.length===0){let o=[],s=[],a=[],c=[];if(i.videoCodecs.forEach(d=>{let l=d.rtpMap&&d.rtpMap.encodingName.toLowerCase()||"";z(l).call(l,n)?o.push(d):z(l).call(l,"vp9")?s.push(d):z(l).call(l,"vp8")?a.push(d):z(l).call(l,"h264")&&c.push(d)}),o.length===0){let d="";s.length!==0?(o=s,d="vp9"):a.length!==0?(o=a,d="vp8"):c.length!==0&&(o=c,d="h264"),_.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(d))}o.length!==0&&(r=e.videoCodecs.filter(d=>o.some(l=>l.payloadType===d.payloadType)))}if(r.length===0&&(_.warning("codec ".concat(n," not included in rtpCapabilities, fallback to default payloads: ").concat(e.videoCodecs[0].rtpMap&&e.videoCodecs[0].rtpMap.encodingName)),r=e.videoCodecs),A("USE_PUB_RTX")||A("USE_SUB_RTX")){let o=gg(r,e.videoCodecs);r=[...r,...o]}}else{r=e.audioCodecs.filter(s=>{var a;return z(a=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(a,n)});let o=e.audioCodecs.filter(s=>{var a;return z(a=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(a,"red")});r.length===0&&(_.warning("codec ".concat(n," not included in rtpCapabilities, fallback to opus")),r=e.audioCodecs.filter(s=>{var a;return z(a=s.rtpMap&&s.rtpMap.encodingName.toLowerCase()||"").call(a,"opus")})),A("ENABLE_AUDIO_RED")&&o.length!==0&&(r=[...o,...r])}return r}function gg(t,e){let i=t.map(n=>n.payloadType.toString());return e.filter(n=>n.rtpMap&&n.rtpMap.encodingName==="rtx"&&n.fmtp&&n.fmtp.parameters.apt&&z(i).call(i,n.fmtp&&n.fmtp.parameters.apt))}function kd(t,e,i){return I(this,null,function*(){let n=e.toString(),r=ZO(n,"offer","remote","exchangeSDP");yield t.setRemoteDescription({type:"offer",sdp:n});let o=yield t.createAnswer();if(!o.sdp)throw new Error("cannot get answer sdp");let s=o.sdp;s=QO(s,i||{}),r?.(s||""),yield t.setLocalDescription({type:"answer",sdp:s})})}function QO(t,e,i){let n=Li(t),{useXR:r}=e;return n.mediaDescriptions.forEach(o=>{var s;o.attributes.mid&&(Array.isArray(i)&&!z(i).call(i,o.attributes.mid)||(o.media.mediaType==="audio"&&nc(o),r&&z(s=["audio","video"]).call(s,o.media.mediaType)&&o.attributes.payloads.forEach(a=>{a.rtcpFeedbacks.findIndex(c=>c.type==="rrtr")===-1&&a.rtcpFeedbacks.push({type:"rrtr"})})))}),xo(n)}function ZO(t,e,i,n){if(A("SDP_LOGGING"))return _.upload("exchanging ".concat(i," ").concat(e," SDP during P2PConnection.").concat(n,`
`),t),e==="offer"?r=>{ZO(r,"answer",i==="local"?"remote":"local",n)}:void 0}function $O(t){let e=A("COMPATIBLE_SDP_EXTENSION");return!!(Array.isArray(e)&&e.length>0)&&e.some(i=>z(t).call(t,i))}function tN(t,e){try{var i;return((i=t.fmtp)===null||i===void 0?void 0:i.parameters.apt)===e.payloadType.toString()}catch{return!1}}function eN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Ki(t,e){return typeof A(t)===e?A(t):void 0}function F6(){try{let t=A("EXPERIMENTS")||{};return typeof t=="string"||Array.isArray(t)?{}:function(e){for(var i=1;i<arguments.length;i++){var n=arguments[i]!=null?arguments[i]:{};i%2?eN(Object(n),!0).forEach(function(r){T(e,r,n[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):eN(Object(n)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(n,r))})}return e}({},t)}catch(t){return _.debug("handle gateway attributes failed: ",t),{}}}let iN={};function Wo(t){(!(arguments.length>1&&arguments[1]!==void 0)||arguments[1])&&_.debug("install service ".concat(t.name)),iN[t.name]=t}function no(t){let e=iN[t];if(!e)throw new F(C.INVALID_OPERATION,"".concat(t," not found, please use AgoraRTC.use(").concat(t,"Service) to load it first"));return e}function nN(t,e){return no("DataStream").create(t,e)}function Jh(){return no("InterceptFrame").create()}function rN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Or(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?rN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):rN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let Sg=new Map;class B6 extends ue{get state(){return this._state}set state(e){if(e===this._state)return;let i=this._state;this._state=e,e==="DISCONNECTED"&&this._disconnectedReason?this.emit(je.CONNECTION_STATE_CHANGE,e,i,this._disconnectedReason):this.emit(je.CONNECTION_STATE_CHANGE,e,i)}get joinGatewayStartTime(){return this._joinGatewayStartTime}set joinGatewayStartTime(e){_.debug("[".concat(this.store.clientId,"] set joinGatewayStartTime at ").concat(e)),this._joinGatewayStartTime=e}constructor(e,i){var n,r,o;super(),T(this,"store",void 0),T(this,"joinInfo",void 0),T(this,"key",void 0),T(this,"ntpOffset",0),T(this,"signal",void 0),T(this,"role",void 0),T(this,"inChannelInfo",{joinAt:null,duration:0}),T(this,"spec",void 0),T(this,"_state","DISCONNECTED"),T(this,"_statsCollector",void 0),T(this,"_disconnectedReason",void 0),T(this,"isSignalRecover",!1),T(this,"hasChangeBGPAddress",!1),T(this,"trafficStatsInterval",void 0),T(this,"networkQualityInterval",void 0),T(this,"_joinGatewayStartTime",0),T(this,"_signalTimeout",!1),T(this,"_clientRoleOptions",void 0),T(this,"_isProactiveJoin",!1),this.store=e,this.spec=i,this.signal=this.store.useP2P?(n={spec:Or(Or({},i),{},{retryConfig:i.websocketRetryConfig}),store:e},(r=(o=no("P2PChannel")).createSubmodule)===null||r===void 0?void 0:r.call(o,n)):new x6(Or(Or({},i),{},{retryConfig:i.websocketRetryConfig}),e),this._statsCollector=i.statsCollector,this.role=i.role||"audience",this._clientRoleOptions=i.clientRoleOptions,this.handleSignalEvents()}join(e,i,n){return I(this,null,function*(){this.store.joinGatewayStart(),e.cloudProxyServer!=="disabled"&&(this.hasChangeBGPAddress=!0);let r=Date.now(),o=Sg.get(e.cname);if(o||(o=new Map,Sg.set(e.cname,o)),this._isProactiveJoin=!0,o.has(e.uid)){let d=new x(C.UID_CONFLICT);throw ot.joinGateway(e.sid,{lts:r,succ:!1,ec:d.code,addr:null,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,isProxy:!!e.proxyServer,signalChannel:"0",preload:e.preload}),d}o.set(e.uid,!0),this.joinInfo=e,this.key=i;let s=0;this.joinGatewayStartTime=r;let a=e.proxyServer;try{_.debug("[".concat(this.store.clientId,"] use websocket join uid ").concat(s));let d=e.gatewayAddrs.map(l=>{let{address:u}=l,[h,p]=u.split(":"),g={host:h,port:p};return e.proxyServer&&(g.proxy=e.proxyServer),g});s=(yield this.signal.init(d)).uid,_.debug("[".concat(this.store.clientId,"] websocket join uid ").concat(s," cost ").concat(Date.now()-this.joinGatewayStartTime))}catch(d){var c;throw _.error("[".concat(this.store.clientId,"] User join failed"),d.toString()),ot.joinGateway(e.sid,{lts:r,succ:!1,ec:((c=d.data)===null||c===void 0?void 0:c.desc)||d.code,errorMsg:d.message,addr:this.signal.url,uid:e.uid,cid:e.cid,firstSuccess:this._isProactiveJoin,isProxy:!!a,signalChannel:"0",preload:e.preload}),o.delete(e.uid),this.signal.close(),d}return this.state="CONNECTED",this.inChannelInfo.joinAt=Date.now(),_.debug("[".concat(this.store.clientId,"] Connected to gateway server")),this.trafficStatsInterval=window.setInterval(()=>{this.updateTrafficStats().catch(d=>{_.warning("[".concat(this.store.clientId,"] get traffic stats error"),d.toString())})},3e3),this.networkQualityInterval=window.setInterval(()=>{navigator&&navigator.onLine!==void 0&&!navigator.onLine?this.emit(je.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6}):this._signalTimeout?this.emit(je.NETWORK_QUALITY,{downlinkNetworkQuality:5,uplinkNetworkQuality:5}):this.state==="CONNECTED"&&this._statsCollector.trafficStats?this.emit(je.NETWORK_QUALITY,{uplinkNetworkQuality:VO(this._statsCollector.trafficStats.B_unq),downlinkNetworkQuality:VO(this._statsCollector.trafficStats.B_dnq)}):this.emit(je.NETWORK_QUALITY,{uplinkNetworkQuality:0,downlinkNetworkQuality:0})},2e3),this.store.joinGatewayEnd(),s})}leave(){return I(this,arguments,function*(){let e=arguments.length>0&&arguments[0]!==void 0&&arguments[0],i=arguments.length>1?arguments[1]:void 0;if(this.state!=="DISCONNECTED"){i!==Ft.FALLBACK&&(this.state="DISCONNECTING");try{e||this.signal.connectionState!==ie.CONNECTED||(yield function(n,r){return r===1/0?n:Q.race([n,lK(r)])}(this.signal.request(pt.LEAVE,void 0,!0),3e3))}catch(n){_.warning("[".concat(this.store.clientId,"] leave request failed, ignore"),n)}this.signal.close(i),i!==Ft.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}})}publish(e,i,n){return I(this,null,function*(){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let r={state:"offer",p2p_id:this.store.p2pId,ortc:i,mode:this.spec.mode,extend:A("PUB_EXTEND"),twcc:!!A("PUBLISH_TWCC"),rtx:!!A("USE_PUB_RTX")};try{return(yield this.signal.request(pt.PUBLISH,r,!0))._message}catch(o){if(n&&o.data&&o.data.code===dt.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish error code, retry"),o.toString()),yield this.tryUnpubBeforeRepub(e,i),this.publish(e,i,!1);throw o}})}publishDataChannel(e,i,n){return I(this,null,function*(){var r;if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));let o={stream_id:i.streamId,ordered:i.ordered?1:0,max_retrans_times:(r=i.maxRetransmits)!==null&&r!==void 0?r:10,channel_id:i.channelId,metadata:i.metadata};try{yield this.signal.request(pt.PUBLISH_DATASTREAM,o,!0)}catch(s){if(n&&s.data&&s.data.code===dt.ERR_PUBLISH_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receive publish datachannels error code, retry"),s.toString()),yield this.tryUnpubDataChannelBeforeRepub(e,i),this.publishDataChannel(e,i,!1);throw s}})}unpublish(e,i){return I(this,null,function*(){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));yield this.signal.request(pt.UNPUBLISH,{stream_id:i,ortc:e},!0)}catch(n){_.warning("[".concat(this.store.clientId,"] unpublish warning: "),n)}})}unpublishDataChannel(e){return I(this,null,function*(){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));yield Q.all(e.map(i=>this.signal.request(pt.UNPUBLISH_DATASTREAM,{channel_id:i},!0)))}catch(i){_.warning("unpublish datachannels warning: ",i)}})}presubscribe(e,i,n){return I(this,null,function*(){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not presubscribe when connection state is ".concat(this.state));let r={stream_id:e,stream_type:i,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!A("SUBSCRIBE_TWCC"),rtx:!!A("USE_SUB_RTX")||void 0,extend:A("SUB_EXTEND"),svc:Array.isArray(A("SVC"))&&A("SVC").length!==0?A("SVC"):void 0};try{return yield this.signal.request(pt.PRE_SUBSCRIBE,r,!0)}catch(o){if(n&&o.data&&o.data.code===dt.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] pre-subscribe error, retry"),o.toString()),this.presubscribe(e,i,!1);throw o}})}subscribe(e,i,n){return I(this,null,function*(){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not subscribe when connection state is ".concat(this.state));let r={stream_id:e,stream_type:i.stream_type,mode:this.spec.mode,codec:this.spec.codec,p2p_id:this.store.p2pId,twcc:!!A("SUBSCRIBE_TWCC"),rtx:!!A("USE_SUB_RTX"),extend:A("SUB_EXTEND"),ssrcId:i.ssrcId,svc:Array.isArray(A("SVC"))&&A("SVC").length!==0?A("SVC"):void 0};try{return(yield this.signal.request(pt.SUBSCRIBE,r,!0))._message}catch(o){if(n&&o.data&&o.data.code===dt.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe error code, retry"),o.toString()),yield this.tryUnsubBeforeResub(e,i),yield this.subscribe(e,i,!1);throw o}})}subscribeDataChannel(e,i,n){return I(this,null,function*(){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not subscribe datachannel when connection state is ".concat(this.state));let r={uid:e,stream_id:i.id,channel_id:i.datachannelId};try{return void(yield this.signal.request(pt.SUBSCRIBE_DATASTREAM,r,!0))}catch(o){if(n&&o.data&&o.data.code===dt.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver subscribe datachannel error code, retry"),o.toString()),yield this.tryUnsubDataChannelBeforeResub(e,i),yield this.subscribeDataChannel(e,i,!1);throw o}})}subscribeAll(e,i){return I(this,null,function*(){if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not massSubscribe when connection state is ".concat(this.state));let n={p2p_id:this.store.p2pId,users:e,dtx:!1,rtx:!!A("USE_SUB_RTX"),twcc:!!A("SUBSCRIBE_TWCC"),svc:Array.isArray(A("SVC"))&&A("SVC").length!==0?A("SVC"):void 0};try{return yield this.signal.request(pt.SUBSCRIBE_STREAMS,n,!0)}catch(r){if(i&&r.data&&r.data.code===dt.ERR_SUBSCRIBE_REQUEST_INVALID)return _.warning("[".concat(this.store.clientId,"] receiver massSubscribe error code, retry"),r.toString()),yield this.tryMassUnsubBeforeResub(e),yield this.subscribeAll(e,!1);throw r}})}setVideoProfile(e){return I(this,null,function*(){let i=function(n){if(!(n.bitrateMax&&n.bitrateMin&&n.frameRate&&n.height&&n.width))return;let r=n.frameRate,o=n.width,s=n.height,a=!0;return typeof r!="number"&&(r=r.exact||r.ideal||r.max||r.min||0,r||(a=!1)),typeof o!="number"&&(o=o.exact||o.ideal||o.max||o.min||0,o||(a=!1)),typeof s!="number"&&(s=s.exact||s.ideal||s.max||s.min||0,r||(a=!1)),a?{stream_type:0,width:o,height:s,fps:r,start_bps:1e3*n.bitrateMax,min_bps:1e3*n.bitrateMin,target_bps:1e3*n.bitrateMax}:void 0}(e);if(i)return this.signal.request(pt.SET_VIDEO_PROFILE,i);_.debug("[".concat(this.store.clientId,"] encoder config is not complete, do not report to gateway"))})}unsubscribe(e,i){return I(this,null,function*(){try{yield this.signal.request(pt.UNSUBSCRIBE,{p2p_id:this.store.p2pId,ortc:e,stream_id:i},!0)}catch(n){_.warning("[".concat(this.store.clientId,"] unsubscribe warning: "),n)}})}unsubscribeDataChannel(e,i){return I(this,null,function*(){try{if(this.state!=="CONNECTED"&&this.state!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not publish when connection state is ".concat(this.state));yield Q.all(e.map(n=>this.signal.request(pt.UNSUBSCRIBE_DATASTREAM,{stream_id:n,uid:i},!0)))}catch(n){_.warning("unsubscribeDataChannel warning: ",n)}})}massUnsubscribe(e){return I(this,null,function*(){try{yield this.signal.request(pt.UNSUBSCRIBE_STREAMS,e,!0)}catch(i){_.warning("[".concat(this.store.clientId,"] massUnsubscribeAll warning: "),i)}})}reconnectPC(e){return I(this,null,function*(){let{iceParameters:i,dtlsParameters:n,rtpCapabilities:r}=e;return{gatewayEstablishParams:yield this.signal.request(pt.CONNECT_PC,{p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:{iceParameters:i,dtlsParameters:n,rtpCapabilities:r}},!0),gatewayAddress:this.getCurrentGatewayAddress()}})}getGatewayInfo(){return this.signal.request(pt.GATEWAY_INFO)}renewToken(e){return I(this,null,function*(){yield this.signal.request(pt.RENEW_TOKEN,e),this.key=e.token})}updateClientRole(e,i){i&&(this._clientRoleOptions=Object.assign({},i)),A("CLIENT_ROLE_OPTIONS")&&(_.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(A("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," ")),this._clientRoleOptions=Object.assign({},A("CLIENT_ROLE_OPTIONS"))),this.role=e}setClientRole(e,i){return I(this,null,function*(){if(i&&(this._clientRoleOptions=Object.assign({},i)),A("CLIENT_ROLE_OPTIONS")&&(this._clientRoleOptions=Object.assign({},A("CLIENT_ROLE_OPTIONS")),_.debug("[".concat(this.store.clientId,"] Set roleOptions for ").concat(JSON.stringify(A("CLIENT_ROLE_OPTIONS"))," instead of ").concat(JSON.stringify(this._clientRoleOptions)," "))),this.state!=="CONNECTED")return void(this.role=e);let n,r=0;e==="audience"?this._clientRoleOptions&&this._clientRoleOptions.delay?(n=this._clientRoleOptions.delay,r=1):r=this._clientRoleOptions&&this._clientRoleOptions.level?this._clientRoleOptions.level:2:r=0,yield this.signal.request(pt.SET_CLIENT_ROLE,{role:e,level:r,delay:n,client_ts:Date.now()}),this.role=e})}setRemoteVideoStreamType(e,i){return I(this,null,function*(){yield this.signal.request(pt.SWITCH_VIDEO_STREAM,{stream_id:e,stream_type:i})})}setDefaultRemoteVideoStreamType(e){return I(this,null,function*(){yield this.signal.request(pt.DEFAULT_VIDEO_STREAM,{stream_type:e})})}setStreamFallbackOption(e,i){return I(this,null,function*(){yield this.signal.request(pt.SET_FALLBACK_OPTION,{stream_id:e,fallback_type:i})})}pickSVCLayer(e,i){return I(this,null,function*(){yield this.signal.request(pt.PICK_SVC_LAYER,{stream_id:e,spatial_layer:i.spatialLayer,temporal_layer:i.temporalLayer})})}setRTM2Flag(e){return I(this,null,function*(){yield this.signal.request(pt.SET_RTM2_FLAG,{rtm2_flag:e})})}sendExtensionMessage(e,i,n){return I(this,null,function*(){if(this.store.useP2P)return this.signal.sendExtensionMessage(e,i,n)})}getInChannelInfo(){return this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt),Or({},this.inChannelInfo)}getGatewayVersion(){return I(this,null,function*(){return(yield this.signal.request(pt.GATEWAY_INFO)).version})}reset(){if(this.inChannelInfo.joinAt&&(this.inChannelInfo.duration=Date.now()-this.inChannelInfo.joinAt,this.inChannelInfo.joinAt=null),this.trafficStatsInterval&&(window.clearInterval(this.trafficStatsInterval),this.trafficStatsInterval=void 0),this.joinInfo){let e=Sg.get(this.joinInfo.cname);e&&e.delete(this.joinInfo.uid)}this.joinInfo=void 0,this.key=void 0,this.networkQualityInterval&&(window.clearInterval(this.networkQualityInterval),this.networkQualityInterval=void 0)}updateTurnConfigFromSignal(){if(!this.joinInfo)return;let e=function(i){let n;return n=i.startsWith("dc")?i.match(/(dc\:\/\/)?([^:]+):(\d+)/):i.match(/(wss\:\/\/)?([^:]+):(\d+)/),n?{username:ti.username,password:ti.password,turnServerURL:n[2],tcpport:parseInt(n[3])+30,udpport:parseInt(n[3])+30,forceturn:!1}:null}((this.joinInfo.cloudProxyServer==="disabled"?this.signal.url:this.joinInfo.gatewayAddrs[this.signal.currentURLIndex].address)||"");this.joinInfo.turnServer.serversFromGateway=[],e&&this.joinInfo.turnServer.mode!=="off"&&this.joinInfo.cloudProxyServer==="disabled"&&this.joinInfo.turnServer.serversFromGateway.push(Or(Or({},ti),{},{turnServerURL:e.turnServerURL,tcpport:e.tcpport,udpport:e.udpport,username:this.joinInfo.uid.toString(),password:this.joinInfo.token}))}updateTrafficStats(){return I(this,null,function*(){if(this.state!=="CONNECTED")return;let e=yield this.signal.request(pt.TRAFFIC_STATS,void 0,!0);e.timestamp=Date.now(),e.ntp_offset!=null&&(this.ntpOffset=e.ntp_offset),e.peer_delay.forEach(i=>{let n=this._statsCollector.trafficStats&&this._statsCollector.trafficStats.peer_delay.find(r=>r.peer_uid===i.peer_uid);n&&n.B_st!==i.B_st&&Eh(()=>{this.emit(je.STREAM_TYPE_CHANGE,i.peer_uid,i.B_st)})}),this._statsCollector.updateTrafficStats(e)})}getJoinMessage(e){var i;if(!this.joinInfo||!this.key)throw new x(C.UNEXPECTED_ERROR,"can not generate join message, no join info");let n=Object.assign({},this.joinInfo.apResponse),r=A("REPORT_APP_SCENARIO");if(typeof r!="string")try{r=JSON.stringify(r)}catch{r=void 0}var o;r&&r.length>128&&(r=void 0),this.store.hasStartJoinChannel=!0,this.store.isABTestSuccess||this.emit(je.UPDATE_GATEWAY_CONFIG),o=this.store.clientId,z(Ja).call(Ja,o)||Ja.push(o);let s=!(_e()||vA(87)||uw())&&typeof A("ENABLE_PRE_SUB")=="boolean"&&A("ENABLE_PRE_SUB"),a=!uw()&&Ki("ENABLE_PREALLOC_PC","boolean"),c=F6(),d=_d(87)||function(){let u=kt();if(u.name!==xt.SAFARI||!u.browserVersion)return!1;let h=u.browserVersion.split(".");return Number(h[0])>15||Number(h[0])===15&&Number(h[1])>=4}(),l=Or({license:this.joinInfo.license,p2p_id:this.store.p2pId,session_id:this.joinInfo.sid,app_id:this.joinInfo.appId,channel_key:this.key,channel_name:this.joinInfo.cname,sdk_version:hn,browser:navigator.userAgent,process_id:A("PROCESS_ID"),mode:this.store.useP2P?"p2p":this.spec.mode,codec:this.spec.codec,role:this.role,has_changed_gateway:this.hasChangeBGPAddress,ap_response:n,extend:A("JOIN_EXTEND"),details:{6:this.joinInfo.stringUid,cservice_map:this.joinInfo.cloudProxyServer==="proxy3"?"1":this.joinInfo.cloudProxyServer==="proxy5"?"2":void 0},features:{rejoin:!0},optionalInfo:this.joinInfo.optionalInfo,appScenario:r,attributes:{userAttributes:Or(Or({enableEncodedTransform:!!A("ENABLE_AUDIO_METADATA")&&d||!!A("ENABLE_AUDIO_TOPN")&&lf(xt.CHROME,87,116)||void 0,enableAudioMetadata:!!A("ENABLE_AUDIO_METADATA")&&d,enableAudioPts:!!A("ENABLE_AUDIO_PTS_METADATA")&&d,topnSmoothLevel:A("TOPN_SMOOTH_LEVEL"),topnNewSpeakerDelay:A("TOPN_NEW_SPEAKER_DELAY"),topnSwitchHoldMs:A("TOPN_SWITCH_HOLD_MS"),topnAudioGain:A("TOPN_AUDIO_GAIN"),enablePublishedUserList:A("ENABLE_PUBLISHED_USER_LIST"),maxSubscription:A("MAX_SUBSCRIPTION"),subscribeAudioFilterTopN:Ki("SUBSCRIBE_AUDIO_FILTER_TOPN","number"),enablePublishAudioFilter:Ki("ENABLE_PUBLISH_AUDIO_FILTER","boolean"),enableUserLicenseCheck:Ki("ENABLE_USER_LICENSE_CHECK","boolean"),enableRTX:A("USE_PUB_RTX")===!0||A("USE_SUB_RTX")===!0||void 0,disableFEC:A("DISABLE_FEC"),enableNTPReport:!!A("ENABLE_NTP_REPORT")||void 0,enableInstantVideo:!!A("ENABLE_INSTANT_VIDEO")||void 0,enableFulllinkAvSync:!!A("ENABLE_FULL_LINK_AV_SYNC")||void 0,enableDataStream2:Ki("ENABLE_DATASTREAM_2","boolean"),enableAutFeedback:!!A("ENABLE_AUT_FEEDBACK")||void 0,rtm2Flag:typeof this.joinInfo.rtmFlag=="number"?this.joinInfo.rtmFlag:void 0,enableUserAutoRebalanceCheck:!!A("ENABLE_USER_AUTO_REBALANCE_CHECK"),enableXR:Ki("USE_XR","boolean"),enableLossbasedBwe:Ki("ENABLE_LOSSBASED_BWE","boolean"),enableAutCC:!!A("ENABLE_AUT_CC")||void 0,enableCCFallback:Ki("ENABLE_CC_FALLBACK","boolean"),enablePreallocPC:a,preSubNum:s?Ki("PRE_SUB_NUM","number"):void 0,enablePubTWCC:Ki("PUBLISH_TWCC","boolean"),enableSubTWCC:Ki("SUBSCRIBE_TWCC","boolean"),enablePubRTX:Ki("USE_PUB_RTX","boolean"),enableSubRTX:Ki("USE_SUB_RTX","boolean"),enableSubSVC:A("ENABLE_SVC")?A("ENABLE_SVC_DEFAULT_CODECS"):Array.isArray(A("SVC"))&&A("SVC").length!==0?A("SVC"):void 0,enableSvcExtended:A("ENABLE_SVC")&&Array.isArray(A("SVC_EXTENDED"))&&A("SVC_EXTENDED").length!==0?A("SVC_EXTENDED"):void 0},c),{},{audioDuplicate:Ki("ENABLE_AUDIO_RED","boolean")?(i=Ki("AUDIO_DUPLICATE_NUM","number"))!==null&&i!==void 0?i:2:void 0})},join_ts:this.joinGatewayStartTime},e);return this.joinInfo.stringUid&&(l.string_uid=this.joinInfo.stringUid),this.joinInfo.aesmode&&this.joinInfo.aespassword&&(l.aes_mode=this.joinInfo.aesmode,A("ENCRYPT_AES")?(l.aes_secret=this.joinInfo.aespassword,l.aes_encrypt=!0):l.aes_secret=this.joinInfo.aespassword,this.joinInfo.aessalt&&(l.aes_salt=this.joinInfo.aessalt)),n.addresses[this.signal.websocket.currentURLIndex]&&(l.ap_response.ticket=n.addresses[this.signal.websocket.currentURLIndex].ticket,delete n.addresses),this.joinInfo.defaultVideoStream!==void 0&&(l.default_video_stream=this.joinInfo.defaultVideoStream),l}getRejoinMessage(){if(!this.joinInfo)throw new x(C.UNEXPECTED_ERROR,"can not generate rejoin message, no join info");return{session_id:this.joinInfo.sid,channel_name:this.joinInfo.cname,cid:this.joinInfo.cid,uid:this.joinInfo.uid,vid:Number(this.joinInfo.vid)}}handleSignalEvents(){this.signal.on(Et.WS_RECONNECT_CREATE_CONNECTION,e=>{this.joinGatewayStartTime=Date.now()}),this.signal.on(Et.WS_RECONNECTING,e=>{this.joinInfo&&ot.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:e||Ze.NETWORK_ERROR}),this.joinInfo&&(this.state="RECONNECTING",ot.sessionInit(this.joinInfo.sid,{lts:new Date().getTime(),extend:this.isSignalRecover?{recover:!0}:{rejoin:!0},cname:this.joinInfo.cname,appid:this.joinInfo.appId,mode:this.spec.mode,stringUid:this.joinInfo.stringUid,channelProfile:this.spec.mode==="live"?1:0,channelMode:0,lsid:this.joinInfo.sid,clientRole:this.role==="audience"?2:1,buildFormat:1}),this.isSignalRecover=!1,this.joinGatewayStartTime=Date.now())}),this.signal.on(Et.WS_CLOSED,e=>{let i;switch(e){case Ft.LEAVE:i=Ze.LEAVE;break;case Ft.UID_BANNED:case Ft.IP_BANNED:case Ft.CHANNEL_BANNED:case Ft.SERVER_ERROR:i=Ze.SERVER_ERROR;break;case Ft.FALLBACK:i=Ze.FALLBACK;break;case Ft.LICENSE_MISSING:case Ft.LICENSE_EXPIRED:case Ft.LICENSE_MINUTES_EXCEEDED:case Ft.LICENSE_PERIOD_INVALID:case Ft.LICENSE_MULTIPLE_SDK_SERVICE:case Ft.LICENSE_ILLEGAL:case Ft.TOKEN_EXPIRE:i=e;break;default:i=Ze.NETWORK_ERROR}_.debug("[".concat(this.store.clientId,"] [signal] websocket closed, reason: ").concat(i||"undefined -> "+Ze.NETWORK_ERROR)),this.joinInfo&&ot.WebSocketQuit(this.joinInfo.sid,{lts:Date.now(),succ:e===Ft.LEAVE?1:-1,cname:this.joinInfo.cname,uid:this.joinInfo.uid,cid:this.joinInfo.cid,errorCode:i}),this._disconnectedReason=e,e!==Ft.FALLBACK&&(this.state="DISCONNECTED"),this.reset()}),this.signal.on(Et.WS_CONNECTED,()=>{if(this.updateTurnConfigFromSignal(),this.state="CONNECTED",this.joinInfo){if(this.role==="audience"){let e=A("CLIENT_ROLE_OPTIONS")||this._clientRoleOptions;e&&(e.level||e.delay)&&(_.debug("[".concat(this.store.clientId,"] patch to send set client role, role: ").concat(this.role,", mode: ").concat(this.spec.mode,", level: ").concat(e.level,", delay: ").concat(e.delay)),this.setClientRole(this.role,e))}if(ot.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!0,ec:null,vid:this.joinInfo.vid,addr:this.signal.url,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload,isABTestSuccess:this.store.isABTestSuccess}),this._isProactiveJoin=!1,this.joinInfo.useLocalAccessPoint&&this.joinInfo.setLocalAPVersion===1){let e=this.signal.url&&this.signal.url.match(/wss\:\/\/([^:]+):(\d+)/);if(!e)return void _.error("[".concat(this.store.clientId,"] set local access point after joined failed: ").concat(e));qt("EVENT_REPORT_DOMAIN",e[1]),qt("EVENT_REPORT_BACKUP_DOMAIN",e[1]),qt("LOG_UPLOAD_SERVER","".concat(e[1],":6444"))}}}),this.signal.on(wt.ON_UPLINK_STATS,e=>{this._statsCollector.updateUplinkStats(e)}),this.signal.on(Et.REQUEST_RECOVER,(e,i,n)=>{if(!this.joinInfo)return n(new x(C.UNEXPECTED_ERROR,"gateway: can not recover, no join info"));e&&(this.joinInfo.multiIP=e,this.hasChangeBGPAddress=!0),this.isSignalRecover=!0,$e(this,je.REQUEST_NEW_GATEWAY_LIST).then(i).catch(n)}),this.signal.on(Et.REQUEST_JOIN_INFO,(e,i,n)=>I(this,null,function*(){var r;if(this.updateTurnConfigFromSignal(),this.store.useP2P)return void e(this.getJoinMessage({ortc:{}}));let o=he((r=this.joinInfo)===null||r===void 0?void 0:r.turnServer);if(A("NEW_TURN_MODE")&&o){let d=o.servers,l=o.serversFromGateway,u=this.signal.currentURLIndex;d.length>0&&(d=[d[u%d.length]],o.servers=d),Array.isArray(l)&&l.length>0&&(l=[l[0]],o.serversFromGateway=l),_.debug("[".concat(this.store.clientId,"] use single turn, use turn server index: ").concat(u))}let{iceParameters:s,dtlsParameters:a,rtpCapabilities:c}=yield $e(this,je.REQUEST_P2P_CONNECTION_PARAMS,{turnServer:o});try{e(this.getJoinMessage({ortc:{iceParameters:s,dtlsParameters:a,rtpCapabilities:c,version:"2"}}))}catch(d){i(d)}})),this.signal.on(Et.REQUEST_REJOIN_INFO,e=>{e(this.getRejoinMessage())}),this.signal.on(Et.REPORT_JOIN_GATEWAY,(e,i)=>{if(!this.joinInfo)return;let n,r="";var o;e instanceof x?(n=((o=e.data)===null||o===void 0?void 0:o.desc)||e.code,r=e.message):n=e,ot.joinGateway(this.joinInfo.sid,{lts:this.joinGatewayStartTime,succ:!1,ec:n,errorMsg:r,addr:i,uid:this.joinInfo.uid,cid:this.joinInfo.cid,firstSuccess:this._isProactiveJoin,isProxy:!!this.joinInfo.proxyServer,signalChannel:"0",preload:this.joinInfo.preload})}),this.signal.on(Et.IS_P2P_DISCONNECTED,e=>{e(Sd(this,je.IS_P2P_DISCONNECTED))}),this.signal.on(Et.DISCONNECT_P2P,()=>{this.emit(je.DISCONNECT_P2P)}),this.signal.on(Et.REQUEST_SUCCESS,()=>{this._signalTimeout=!1}),this.signal.on(Et.REQUEST_TIMEOUT,()=>{this._signalTimeout=!0}),this.signal.on(Et.JOIN_RESPONSE,e=>{let i=this.getCurrentGatewayAddress();this.emit(je.JOIN_RESPONSE,e,i)}),this.signal.on(Et.PRE_CONNECT_PC,()=>I(this,null,function*(){if(this.joinInfo){this.updateTurnConfigFromSignal();let e=this.getCurrentGatewayAddress(),i=A("FINGERPRINT")||this.joinInfo.apResponse.addresses[this.signal.currentURLIndex].fingerprint;if(e&&i){let n=qO(e);this.emit(je.PRE_CONNECT_PC,{candidates:n,fingerprint:i})}}})),this.signal.on(Et.RECOVER_NOTIFICATION,e=>{this.joinInfo&&typeof A("AP_REQUEST_DETAIL")=="string"&&(this.joinInfo.apRequestDetail="".concat(A("AP_REQUEST_DETAIL"),";").concat(e))})}tryUnsubBeforeResub(e,i){return I(this,null,function*(){try{yield this.signal.request(pt.UNSUBSCRIBE,{p2p_id:this.store.p2pId,stream_id:e,ortc:[i]},!0)}catch(n){throw _.warning("[".concat(this.store.clientId,"] tryUnsubBeforeResub warning"),n),n}})}tryUnsubDataChannelBeforeResub(e,i){return I(this,null,function*(){try{yield this.signal.request(pt.UNSUBSCRIBE,{stream_id:i.id},!0)}catch(n){throw _.warning("unsubscribe datachannel warning",n),n}})}tryUnpubBeforeRepub(e,i){return I(this,null,function*(){try{yield this.signal.request(pt.UNPUBLISH,{stream_id:e,ortc:i},!0)}catch(n){throw _.warning("[".concat(this.store.clientId,"] tryUnpubBeforeRepub warning: "),n),n}})}tryUnpubDataChannelBeforeRepub(e,i){return I(this,null,function*(){try{yield this.signal.request(pt.UNPUBLISH_DATASTREAM,{channnel_id:i.channelId},!0)}catch(n){throw _.warning("unpublish datastream warning: ",n),n}})}tryMassUnsubBeforeResub(e){return I(this,null,function*(){let i={users:e.map(n=>({stream_id:n.stream_id,stream_type:n.stream_type}))};try{yield this.signal.request(pt.UNSUBSCRIBE_STREAMS,i,!0)}catch(n){throw _.warning("[".concat(this.store.clientId,"] tryMassUnsubBeforeResub warning"),n),n}})}muteLocal(e,i){return I(this,null,function*(){let n={action:e.find(r=>r.stream_type===Gt.Audio)?"mute_local_audio":"mute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{yield this.signal.request(pt.CONTROL,n,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway muteLocal warning: "),r),r}})}unmuteLocal(e,i){return I(this,null,function*(){let n={action:e.find(r=>r.stream_type===Gt.Audio)?"unmute_local_audio":"unmute_local_video",p2p_id:this.store.p2pId,ortc:e,stream_id:i};try{yield this.signal.request(pt.CONTROL,n,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway unmuteLocal warning: "),r),r}})}muteRemote(e,i){return I(this,null,function*(){let n={action:e===$.AUDIO?"mute_remote_audio":"mute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{yield this.signal.request(pt.CONTROL,n,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway muteRemote warning: "),r),r}})}unmuteRemote(e,i){return I(this,null,function*(){let n={action:e===$.AUDIO?"unmute_remote_audio":"unmute_remote_video",p2p_id:this.store.p2pId,stream_id:i};try{yield this.signal.request(pt.CONTROL,n,!0,!0)}catch(r){throw _.warning("[".concat(this.store.clientId,"] gateway unmuteRemote warning: "),r),r}})}uploadWRTCStats(e){this.signal.uploadWRTCStats(e)}upload(e,i){this.signal.upload(e,i)}getSignalRTT(){return this.signal.rtt}restartICE(e){return I(this,null,function*(){let i={p2p_id:this.store.p2pId,stream_id:this.store.uid,ortc:e};try{return yield this.signal.request(pt.RESTART_ICE,i,!0)}catch(n){throw _.warning("[".concat(this.store.clientId,"] P2PChannel.restartICE warning: "),n),n}})}reconnect(e,i){this.state==="CONNECTED"&&this.signal.reconnect(e||void 0,i||Ze.P2P_FAILED)}getCurrentGatewayAddress(){var e,i;if(!A("GATEWAY_WSS_ADDRESS"))return A("USE_CANDIDATE_FROM_AP_DETAIL")&&(e=this.joinInfo)!==null&&e!==void 0&&e.apGatewayAddress?(_.debug("[".concat(this.store.clientId,"] use candidate from ap detail, ").concat(JSON.stringify(this.joinInfo.apGatewayAddress))),this.joinInfo.apGatewayAddress):(i=this.joinInfo)!==null&&i!==void 0&&i.gatewayAddrs?this.joinInfo.gatewayAddrs[this.signal.currentURLIndex]:void 0}setPublishAudioFilterEnabled(e){return I(this,null,function*(){yield this.signal.request(pt.SET_PARAMETER,{enablePublishAudioFilter:e})})}}let Qh=0,Tg=0;function sr(t,e,i,n){return new Q((r,o)=>{e.timeout=e.timeout||A("HTTP_CONNECT_TIMEOUT"),e.responseType=e.responseType||"json",e.data&&!i?(e.data=JSON.stringify(e.data),Qh+=vr(e.data)):i&&(e.data.size?Qh+=e.data.size:e.data instanceof FormData?Qh+=BA(e.data):Qh+=vr(JSON.stringify(e.data))),e.headers=e.headers||{},e.headers["Content-Type"]=e.headers["Content-Type"]||"application/json",e.method="POST",e.url=t,bi.request(e).then(s=>{typeof s.data=="string"?Tg+=vr(s.data):s.data instanceof ArrayBuffer||s.data instanceof Uint8Array?Tg+=s.data.byteLength:Tg+=vr(JSON.stringify(s.data)),n&&r({data:s.data,headers:s.headers}),r(s.data)}).catch(s=>{bi.isCancel(s)?o(new x(C.OPERATION_ABORTED,"cancel token canceled")):s.code==="ECONNABORTED"?o(new x(C.NETWORK_TIMEOUT,s.message)):s.response?o(new x(C.NETWORK_RESPONSE_ERROR,s.response.status)):o(new x(C.NETWORK_ERROR,s.message))})})}(function(){var t;function e(j){var K=0;return function(){return K<j.length?{done:!1,value:j[K++]}:{done:!0}}}var i=typeof Object.defineProperties=="function"?Object.defineProperty:function(j,K,it){return j==Array.prototype||j==Object.prototype||(j[K]=it.value),j},n,r=function(j){j=[typeof globalThis=="object"&&globalThis,j,typeof window=="object"&&window,typeof self=="object"&&self,typeof S=="object"&&S];for(var K=0;K<j.length;++K){var it=j[K];if(it&&it.Math==Math)return it}throw Error("Cannot find global object")}(this);function o(j,K){if(K)t:{var it=r;j=j.split(".");for(var G=0;G<j.length-1;G++){var m=j[G];if(!(m in it))break t;it=it[m]}(K=K(G=it[j=j[j.length-1]]))!=G&&K!=null&&i(it,j,{configurable:!0,writable:!0,value:K})}}function s(j){return(j={next:j})[Symbol.iterator]=function(){return this},j}function a(j){var K=typeof Symbol<"u"&&Symbol.iterator&&j[Symbol.iterator];return K?K.call(j):{next:e(j)}}if(o("Symbol",function(j){function K(m,w){this.A=m,i(this,"description",{configurable:!0,writable:!0,value:w})}if(j)return j;K.prototype.toString=function(){return this.A};var it="jscomp_symbol_"+(1e9*Math.random()>>>0)+"_",G=0;return function m(w){if(this instanceof m)throw new TypeError("Symbol is not a constructor");return new K(it+(w||"")+"_"+G++,w)}}),o("Symbol.iterator",function(j){if(j)return j;j=Symbol("Symbol.iterator");for(var K="Array Int8Array Uint8Array Uint8ClampedArray Int16Array Uint16Array Int32Array Uint32Array Float32Array Float64Array".split(" "),it=0;it<K.length;it++){var G=r[K[it]];typeof G=="function"&&typeof G.prototype[j]!="function"&&i(G.prototype,j,{configurable:!0,writable:!0,value:function(){return s(e(this))}})}return j}),typeof Object.setPrototypeOf=="function")n=Object.setPrototypeOf;else{var c;t:{var d={};try{d.__proto__={a:!0},c=d.a;break t}catch{}c=!1}n=c?function(j,K){if(j.__proto__=K,j.__proto__!==K)throw new TypeError(j+" is not extensible");return j}:null}var l=n;function u(){this.m=!1,this.j=null,this.v=void 0,this.h=1,this.u=this.C=0,this.l=null}function h(j){if(j.m)throw new TypeError("Generator is already running");j.m=!0}function p(j,K){return j.h=3,{value:K}}function g(j){this.g=new u,this.G=j}function E(j,K,it,G){try{var m=K.call(j.g.j,it);if(!(m instanceof Object))throw new TypeError("Iterator result "+m+" is not an object");if(!m.done)return j.g.m=!1,m;var w=m.value}catch(D){return j.g.j=null,j.g.s(D),f(j)}return j.g.j=null,G.call(j.g,w),f(j)}function f(j){for(;j.g.h;)try{var K=j.G(j.g);if(K)return j.g.m=!1,{value:K.value,done:!1}}catch(it){j.g.v=void 0,j.g.s(it)}if(j.g.m=!1,j.g.l){if(K=j.g.l,j.g.l=null,K.F)throw K.D;return{value:K.return,done:!0}}return{value:void 0,done:!0}}function R(j){this.next=function(K){return j.o(K)},this.throw=function(K){return j.s(K)},this.return=function(K){return function(it,G){h(it.g);var m=it.g.j;return m?E(it,"return"in m?m.return:function(w){return{value:w,done:!0}},G,it.g.return):(it.g.return(G),f(it))}(j,K)},this[Symbol.iterator]=function(){return this}}function y(j,K){return K=new R(new g(K)),l&&j.prototype&&l(K,j.prototype),K}if(u.prototype.o=function(j){this.v=j},u.prototype.s=function(j){this.l={D:j,F:!0},this.h=this.C||this.u},u.prototype.return=function(j){this.l={return:j},this.h=this.u},g.prototype.o=function(j){return h(this.g),this.g.j?E(this,this.g.j.next,j,this.g.o):(this.g.o(j),f(this))},g.prototype.s=function(j){return h(this.g),this.g.j?E(this,this.g.j.throw,j,this.g.o):(this.g.s(j),f(this))},o("Array.prototype.entries",function(j){return j||function(){return function(K,it){K instanceof String&&(K+="");var G=0,m=!1,w={next:function(){if(!m&&G<K.length){var D=G++;return{value:it(D,K[D]),done:!1}}return m=!0,{done:!0,value:void 0}}};return w[Symbol.iterator]=function(){return w},w}(this,function(K,it){return[K,it]})}}),typeof Blob<"u"&&(typeof FormData>"u"||!FormData.prototype.keys)){var N=function(j,K){for(var it=0;it<j.length;it++)K(j[it])},k=function(j){return j.replace(/\r?\n|\r/g,`\r
`)},L=function(j,K,it){return K instanceof Blob?(it=it!==void 0?it+"":typeof K.name=="string"?K.name:"blob",K.name===it&&Object.prototype.toString.call(K)!=="[object Blob]"||(K=new File([K],it)),[String(j),K]):[String(j),String(K)]},P=function(j,K){if(j.length<K)throw new TypeError(K+" argument required, but only "+j.length+" present.")},V=typeof globalThis=="object"?globalThis:typeof window=="object"?window:typeof self=="object"?self:this,B=V.FormData,Y=V.XMLHttpRequest&&V.XMLHttpRequest.prototype.send,J=V.Request&&V.fetch,yt=V.navigator&&V.navigator.sendBeacon,Rt=V.Element&&V.Element.prototype,_t=V.Symbol&&Symbol.toStringTag;_t&&(Blob.prototype[_t]||(Blob.prototype[_t]="Blob"),"File"in V&&!File.prototype[_t]&&(File.prototype[_t]="File"));try{new File([],"")}catch{V.File=function(K,it,G){return K=new Blob(K,G||{}),Object.defineProperties(K,{name:{value:it},lastModified:{value:+(G&&G.lastModified!==void 0?new Date(G.lastModified):new Date)},toString:{value:function(){return"[object File]"}}}),_t&&Object.defineProperty(K,_t,{value:"File"}),K}}var ne=function(j){return j.replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},Qt=function(j){this.i=[];var K=this;j&&N(j.elements,function(it){if(it.name&&!it.disabled&&it.type!=="submit"&&it.type!=="button"&&!it.matches("form fieldset[disabled] *"))if(it.type==="file"){var G=it.files&&it.files.length?it.files:[new File([],"",{type:"application/octet-stream"})];N(G,function(m){K.append(it.name,m)})}else it.type==="select-multiple"||it.type==="select-one"?N(it.options,function(m){!m.disabled&&m.selected&&K.append(it.name,m.value)}):it.type==="checkbox"||it.type==="radio"?it.checked&&K.append(it.name,it.value):(G=it.type==="textarea"?k(it.value):it.value,K.append(it.name,G))})};if((t=Qt.prototype).append=function(j,K,it){P(arguments,2),this.i.push(L(j,K,it))},t.delete=function(j){P(arguments,1);var K=[];j=String(j),N(this.i,function(it){it[0]!==j&&K.push(it)}),this.i=K},t.entries=function j(){var K,it=this;return y(j,function(G){if(G.h==1&&(K=0),G.h!=3)return K<it.i.length?G=p(G,it.i[K]):(G.h=0,G=void 0),G;K++,G.h=2})},t.forEach=function(j,K){P(arguments,1);for(var it=a(this),G=it.next();!G.done;G=it.next()){var m=a(G.value);G=m.next().value,m=m.next().value,j.call(K,m,G,this)}},t.get=function(j){P(arguments,1);var K=this.i;j=String(j);for(var it=0;it<K.length;it++)if(K[it][0]===j)return K[it][1];return null},t.getAll=function(j){P(arguments,1);var K=[];return j=String(j),N(this.i,function(it){it[0]===j&&K.push(it[1])}),K},t.has=function(j){P(arguments,1),j=String(j);for(var K=0;K<this.i.length;K++)if(this.i[K][0]===j)return!0;return!1},t.keys=function j(){var K,it,G,m,w=this;return y(j,function(D){if(D.h==1&&(K=a(w),it=K.next()),D.h!=3)return it.done?void(D.h=0):(G=it.value,m=a(G),p(D,m.next().value));it=K.next(),D.h=2})},t.set=function(j,K,it){P(arguments,2),j=String(j);var G=[],m=L(j,K,it),w=!0;N(this.i,function(D){D[0]===j?w&&(w=!G.push(m)):G.push(D)}),w&&G.push(m),this.i=G},t.values=function j(){var K,it,G,m,w=this;return y(j,function(D){if(D.h==1&&(K=a(w),it=K.next()),D.h!=3)return it.done?void(D.h=0):(G=it.value,(m=a(G)).next(),p(D,m.next().value));it=K.next(),D.h=2})},Qt.prototype._asNative=function(){for(var j=new B,K=a(this),it=K.next();!it.done;it=K.next()){var G=a(it.value);it=G.next().value,G=G.next().value,j.append(it,G)}return j},Qt.prototype._blob=function(){var j="----formdata-polyfill-"+Math.random(),K=[],it="--"+j+`\r
Content-Disposition: form-data; name="`;return this.forEach(function(G,m){return typeof G=="string"?K.push(it+ne(k(m))+`"\r
\r
`+k(G)+`\r
`):K.push(it+ne(k(m))+'"; filename="'+ne(G.name)+`"\r
Content-Type: `+(G.type||"application/octet-stream")+`\r
\r
`,G,`\r
`)}),K.push("--"+j+"--"),new Blob(K,{type:"multipart/form-data; boundary="+j})},Qt.prototype[Symbol.iterator]=function(){return this.entries()},Qt.prototype.toString=function(){return"[object FormData]"},Rt&&!Rt.matches&&(Rt.matches=Rt.matchesSelector||Rt.mozMatchesSelector||Rt.msMatchesSelector||Rt.oMatchesSelector||Rt.webkitMatchesSelector||function(j){for(var K=(j=(this.document||this.ownerDocument).querySelectorAll(j)).length;0<=--K&&j.item(K)!==this;);return-1<K}),_t&&(Qt.prototype[_t]="FormData"),Y){var Ni=V.XMLHttpRequest.prototype.setRequestHeader;V.XMLHttpRequest.prototype.setRequestHeader=function(j,K){Ni.call(this,j,K),j.toLowerCase()==="content-type"&&(this.B=!0)},V.XMLHttpRequest.prototype.send=function(j){j instanceof Qt?(j=j._blob(),this.B||this.setRequestHeader("Content-Type",j.type),Y.call(this,j)):Y.call(this,j)}}J&&(V.fetch=function(j,K){return K&&K.body&&K.body instanceof Qt&&(K.body=K.body._blob()),J.call(this,j,K)}),yt&&(V.navigator.sendBeacon=function(j,K){return K instanceof Qt&&(K=K._asNative()),yt.call(this,j,K)}),V.FormData=Qt}})();let Md=()=>{let t=A("AREAS");return t.length===0&&t.push(Vt.GLOBAL),bn(t).call(t,(e,i,n)=>{let r=oN(i);return r?n===0?r:"".concat(e,",").concat(r):e},"")},oN=t=>t===Vt.OVERSEA?"".concat(ri.ASIA,",").concat(ri.EUROPE,",").concat(ri.AFRICA,",").concat(ri.NORTH_AMERICA,",").concat(ri.SOUTH_AMERICA,",").concat(ri.OCEANIA):ri[t],j6=t=>{let e={CODE:"",WEBCS_DOMAIN:[],WEBCS_DOMAIN_BACKUP_LIST:[],PROXY_CS:[],CDS_AP:[],ACCOUNT_REGISTER:[],UAP_AP:[],EVENT_REPORT_DOMAIN:[],EVENT_REPORT_BACKUP_DOMAIN:[],LOG_UPLOAD_SERVER:[],PROXY_SERVER_TYPE3:[]};return t.map(i=>{let n=Wh[i],r=Object.keys(n);r&&r.map(o=>{o!=="CODE"&&(e[o]=e[o].concat(n[o]))})}),e},Zh={GLOBAL:{ASIA:[Vt.CHINA,Vt.JAPAN,Vt.INDIA,Vt.KOREA,Vt.HKMC],EUROPE:[],NORTH_AMERICA:[Vt.US],SOUTH_AMERICA:[],OCEANIA:[],AFRICA:[]}},$h=Object.keys(Zh[Vt.GLOBAL]),Rg=[Vt.CHINA,Vt.NORTH_AMERICA,Vt.EUROPE,Vt.ASIA,Vt.JAPAN,Vt.INDIA,Vt.OCEANIA,Vt.SOUTH_AMERICA,Vt.AFRICA,Vt.KOREA,Vt.HKMC,Vt.US],G6=function(t,e){let i=[];if(z(t).call(t,Vt.GLOBAL)){let o=[Vt.GLOBAL,Vt.OVERSEA],s=Object.keys(Wh);if(e===Vt.GLOBAL)throw new x(C.INVALID_PARAMS,"GLOBAL is an invalid excludedArea value");if(e===Vt.CHINA)i=[Vt.OVERSEA];else if(r=e,z($h).call($h,r)){let a=(n=e,Zh[Vt.GLOBAL][n]||[]),c=[...o,e,...a];i=s.filter(d=>!z(c).call(c,d))}else if(function(a){let c=!1;return $h.forEach(d=>{var l;z(l=Zh[Vt.GLOBAL][d]).call(l,a)&&(c=!0)}),c}(e)){let a=function(d){let l;return $h.forEach(u=>{var h;z(h=Zh[Vt.GLOBAL][u]).call(h,d)&&(l=u)}),l}(e),c=[...o,a,e];i=s.filter(d=>!z(c).call(c,d))}else i=t;i=function(a){let c=[];return Rg.forEach(d=>{z(a).call(a,d)&&c.push(d)}),c.concat(a.filter(d=>!z(Rg).call(Rg,d)))}(i)}else i=t;var n,r;return i};function sN(t){var e,i;if(!t&&z(e=A("AREAS")).call(e,Vt.EXTENSIONS))return _.debug("update area from ap : reset"),void vg(JK,!0);if(!z(i=A("AREAS")).call(i,Vt.GLOBAL)||!t)return;let n=Wh.EXTENSIONS;n&&(n={CODE:oN(Vt.EXTENSIONS),WEBCS_DOMAIN:["ap-web-1-".concat(t,".agora.io")],WEBCS_DOMAIN_BACKUP_LIST:["ap-web-2-".concat(t,".ap.sd-rtn.com")],PROXY_CS:["proxy-ap-web-".concat(t,".agora.io")],CDS_AP:["cds-ap-web-1-".concat(t,".agora.io"),"cds-ap-web-2-".concat(t,".ap.sd-rtn.com")],ACCOUNT_REGISTER:["sua-ap-web-1-".concat(t,".agora.io"),"sua-ap-web-2-".concat(t,".ap.sd-rtn.com")],UAP_AP:["uap-ap-web-1-".concat(t,".agora.io"),"uap-ap-web-2-".concat(t,".ap.sd-rtn.com")],EVENT_REPORT_DOMAIN:["statscollector-1-".concat(t,".agora.io")],EVENT_REPORT_BACKUP_DOMAIN:["statscollector-2-".concat(t,".agora.io")],LOG_UPLOAD_SERVER:["logservice-".concat(t,".agora.io")],PROXY_SERVER_TYPE3:["webrtc-cloud-proxy-".concat(t,".agora.io")]},_.debug("update area from ap success: ".concat(t,",config is "),n),qt("AREAS",[Vt.EXTENSIONS],!0),Object.keys(n).map(r=>{r==="LOG_UPLOAD_SERVER"||r==="EVENT_REPORT_DOMAIN"||r==="EVENT_REPORT_BACKUP_DOMAIN"||r==="PROXY_SERVER_TYPE3"?qt(r,n[r][0]):qt(r,n[r])}))}function vg(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],i=ot.reportApiInvoke(null,{name:be.SET_AREA,options:t,tag:Ee.TRACER});try{let n=[];if(typeof t=="string"&&(n=[t]),Array.isArray(t)&&(t.forEach(o=>{if(!z(AO).call(AO,o))throw new x(C.INVALID_PARAMS,"invalid area code")}),n=t),Object.prototype.toString.call(t)==="[object Object]"){let{areaCode:o,excludedArea:s}=t;if(!o)throw new x(C.INVALID_PARAMS,"area code is needed");let a=o;typeof o=="string"&&(a=[o]),n=s?G6(a,s):a}if(!e){if(ir.AREAS){let o=new x(C.PROHIBITED_OPERATION,"setArea is prohibited because of config-distribute");return i.onError(o),void _.warning("setArea is prohibited because of config-distribute")}if(z(n).call(n,Vt.GLOBAL)&&A("AREAS")===Vt.EXTENSIONS){let o=new x(C.PROHIBITED_OPERATION,"setArea is prohibited because of ap extensions");return i.onError(o),void _.warning("setArea is prohibited because of ap extensions")}}qt("AREAS",n,e);let r=j6(n);Object.keys(r).map(o=>{o==="LOG_UPLOAD_SERVER"||o==="EVENT_REPORT_DOMAIN"||o==="EVENT_REPORT_BACKUP_DOMAIN"||o==="PROXY_SERVER_TYPE3"?qt(o,r[o][0]):qt(o,r[o])}),_.debug("set area success:",n.join(","))}catch(n){throw i.onError(n),n}i.onSuccess()}function aN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Nr(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?aN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):aN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let yg=1;function W6(t,e,i,n,r){yg+=1;let o={sid:i.sid,command:"convergeAllocateEdge",uid:"666",appId:i.appId,ts:Math.floor(Date.now()/1e3),seq:yg,requestId:yg,version:hn,cname:i.cname},s={service_name:e,json_body:JSON.stringify(o)},a,c,d=t[0];return er(()=>I(null,null,function*(){a=Date.now();let l=yield sr(d,{data:s,cancelToken:n,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"}});if(c=Date.now()-a,l.code!==0){let p=new x(C.UNEXPECTED_RESPONSE,"live streaming ap error, code"+l.code,{retry:!0,responseTime:c});throw _.error(p.toString()),p}let u=JSON.parse(l.json_body);if(u.code!==200){let p=new x(C.UNEXPECTED_RESPONSE,"live streaming app center error, code: ".concat(u.code,", reason: ").concat(u.reason),{code:u.code,responseTime:c});throw _.error(p.toString()),p}if(!u.servers||u.servers.length===0){let p=new x(C.UNEXPECTED_RESPONSE,"live streaming app center empty server",{code:u.code,responseTime:c});throw _.error(p.toString()),p}let h=function(p,g){return{addressList:p.servers.map(E=>"wss://".concat(E.address.replace(/\./g,"-"),".").concat(A("WORKER_DOMAIN"),":").concat(E.wss,"?serviceName=").concat(encodeURIComponent(g))),workerToken:p.workerToken,vid:p.vid}}(u,e);return A("LIVE_STREAMING_ADDRESS")&&(h.addressList=A("LIVE_STREAMING_ADDRESS")instanceof Array?A("LIVE_STREAMING_ADDRESS"):[A("LIVE_STREAMING_ADDRESS")]),Nr(Nr({},h),{},{responseTime:c})}),(l,u)=>(ot.apworkerEvent(i.sid,{success:!0,sc:200,serviceName:e,responseDetail:JSON.stringify(l.addressList),firstSuccess:u===0,responseTime:c,serverIp:t[u%t.length]}),!1),(l,u)=>(ot.apworkerEvent(i.sid,{success:!1,sc:l.data&&l.data.code||200,serviceName:e,responseTime:c,serverIp:t[u%t.length]}),!!(l.code!==C.OPERATION_ABORTED&&l.code!==C.UNEXPECTED_RESPONSE||l.data&&l.data.retry)&&(d=t[(u+1)%t.length],!0)),r)}let Cg=1;function cN(t,e,i,n){let{url:r,areaCode:o}=t,{clientId:s,sid:a}=e,c=Date.now(),d,l=e.role,[u,h]=Ig(e,o,[Ae.CHOOSE_SERVER]),p=Ie.networkState;return er(()=>I(null,null,function*(){p&&Ie.networkState===Wi.OFFLINE&&Ie.onlineWaiter&&(yield Q.race([Ie.onlineWaiter,qe(n&&n.maxRetryTimeout||Oe.maxRetryTimeout)])),p=Ie.networkState;let{data:g,headers:E}=yield sr(r,{data:u,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);d=E.http3==="1"?1:-1,ot.reportResourceTiming(r,a),lN(g,r,e,c,[Ae.CHOOSE_SERVER],d);let f=Dd(g,Ae.CHOOSE_SERVER);return bg(f),_g(f,r)}),g=>(g&&ot.joinChooseServer(a,{role:l,lts:c,succ:!0,csAddr:r,opid:h,serverList:g.gatewayAddrs.map(E=>E.address),ec:null,cid:g.cid.toString(),uid:g.uid.toString(),csIp:g.csIp,unilbsServerIds:[Ae.CHOOSE_SERVER].toString(),isHttp3:d,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:g.res.detail&&g.res.detail[38]}),!1),g=>g.code!==C.OPERATION_ABORTED&&(g.code===C.CAN_NOT_GET_GATEWAY_SERVER?g.data.retry:(ot.joinChooseServer(a,{role:l,lts:c,succ:!1,csAddr:r,serverList:null,opid:h,ec:g.code,csIp:g.data&&g.data.csIp,unilbsServerIds:[Ae.CHOOSE_SERVER].toString(),extend:JSON.stringify({networkState:p}),isHttp3:d,corssRegionTagReq:e.apRequestDetail}),_.warning("[".concat(s||"sid-".concat(a.slice(0,6)),"] Choose server network error, retry"),g),!0)),n)}function dN(t,e,i,n){let r,{url:o,areaCode:s,serviceIds:a}=t,c=Date.now(),d=e.role,[l,u]=Ig(e,s,a),h;return er(()=>I(null,null,function*(){h&&Ie.networkState===Wi.OFFLINE&&Ie.onlineWaiter&&(yield Q.race([Ie.onlineWaiter,qe(n&&n.maxRetryTimeout||Oe.maxRetryTimeout)])),h=Ie.networkState;let{data:p,headers:g}=yield sr(o,{data:l,cancelToken:i,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);r=g.http3==="1"?1:-1,ot.reportResourceTiming(o,e.sid),lN(p,o,e,c,a,r);let E=Dd(p,Ae.CHOOSE_SERVER),f=Dd(p,e.cloudProxyServer==="proxy5"?Ae.CLOUD_PROXY_5:e.cloudProxyServer==="proxy3"||e.cloudProxyServer==="proxy4"?Ae.CLOUD_PROXY:Ae.CLOUD_PROXY_FALLBACK);return bg(E),{gatewayInfo:_g(E,o),proxyInfo:f,url:o}}),p=>(p.gatewayInfo&&ot.joinChooseServer(e.sid,{role:d,lts:c,succ:!0,csAddr:o,serverList:p.gatewayInfo.gatewayAddrs.map(g=>g.address),ec:null,opid:u,cid:p.gatewayInfo.cid.toString(),uid:p.gatewayInfo.uid.toString(),csIp:p.gatewayInfo.csIp,unilbsServerIds:a.toString(),isHttp3:r,corssRegionTagReq:e.apRequestDetail,corssRegionTagRes:p.gatewayInfo.res.detail&&p.gatewayInfo.res.detail[38]}),p.proxyInfo&&ot.joinWebProxyAP(e.sid,{lts:c,sucess:1,apServerAddr:o,turnServerAddrList:p.proxyInfo.addresses.map(g=>g.ip).join(","),errorCode:null,eventType:e.cloudProxyServer,unilbsServerIds:a.toString()}),!1),p=>p.code!==C.OPERATION_ABORTED&&(p.code===C.CAN_NOT_GET_GATEWAY_SERVER?p.data.retry:(ot.joinWebProxyAP(e.sid,{lts:c,sucess:0,apServerAddr:o,turnServerAddrList:null,errorCode:p.code,eventType:e.cloudProxyServer,unilbsServerIds:a.toString(),extend:JSON.stringify({networkState:h})}),_.warning("[".concat(e.clientId,"] multi unilbs network error, retry"),p),!0)),n)}let lN=(t,e,i,n,r,o)=>{let{sid:s,clientId:a,cloudProxyServer:c}=i,d=[],l=u=>{u.flag===4096?ot.joinChooseServer(s,{role:i.role,lts:n,succ:!1,csAddr:e,opid:t.opid,serverList:null,ec:u.error.message,csIp:u.error.data&&u.error.data.csIp,unilbsServerIds:r.toString(),isHttp3:o,corssRegionTagReq:i.apRequestDetail}):u.flag!==1048576&&u.flag!==4194304&&u.flag!==4194310||ot.joinWebProxyAP(s,{lts:n,sucess:0,apServerAddr:e,turnServerAddrList:null,errorCode:u.error.code,eventType:c,unilbsServerIds:r.toString()})};if(t.response_body.forEach(u=>{let h=u.buffer.code;if(u.uri===23&&h===0&&!u.buffer.edges_services)if(u.buffer.flag===4194310)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers"),u.buffer.edges_services=[];else{let p={error:new x(C.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:t.detail[502]}),flag:u.buffer.flag};d.push(p),l(p)}if(h!==0){let p=tc(h),g={error:new x(C.CAN_NOT_GET_GATEWAY_SERVER,p.desc,{desc:p.desc,retry:p.retry,csIp:t.detail[502]}),flag:u.buffer.flag};u.buffer.flag===4194310?_.warning(g.error.toString()):d.push(g),l(g)}}),d.length)throw _.warning("[".concat(a||"sid-".concat(s.slice(0,6)),"] multi unilbs ").concat(e," failed, ").concat(d.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message,", retry: ").concat(u.error.data.retry)).join(" | "))),new x(C.CAN_NOT_GET_GATEWAY_SERVER,d.map(u=>"flag: ".concat(u.flag,", message: ").concat(u.error.message)).join(" | "),{retry:!!d.find(u=>u.error.data.retry),csIp:t.detail[502],desc:[...new Set(d.map(u=>{var h;return u==null||(h=u.error)===null||h===void 0||(h=h.data)===null||h===void 0?void 0:h.desc}).filter(u=>!!u))]})},bg=t=>{var e,i,n,r;if(t.addresses&&t.addresses.length===0&&t.code===0)throw new x(C.CAN_NOT_GET_GATEWAY_SERVER,"void gateway address",{retry:!0,csIp:t.detail&&t.detail[502]});if(A("AP_AREA")&&((n=t.detail)!==null&&n!==void 0&&n[23]&&typeof((r=t.detail)===null||r===void 0?void 0:r[23])=="string"?sN(t.detail[23].toLowerCase()):sN()),(e=t.detail)!==null&&e!==void 0&&e[19]&&typeof((i=t.detail)===null||i===void 0?void 0:i[19])=="string"){let s=t.detail[19],a=s?.split(";");for(let c=0;c<a.length;c++){var o;let d=ui(o=a[c]).call(o);t.addresses[c]&&a&&(t.addresses[c].fingerprint=d)}}if(A("GATEWAY_ADDRESS")&&A("GATEWAY_ADDRESS").length>0){_.debug("assign gateway address to",A("GATEWAY_ADDRESS"));let s=A("GATEWAY_ADDRESS").map(a=>{var c,d;let l=(c=(d=t.addresses.find(u=>u.ip===a.ip&&u.port===a.port))===null||d===void 0?void 0:d.fingerprint)!==null&&c!==void 0?c:"";return{ip:a.ip,port:a.port,ticket:t.addresses[0]&&t.addresses[0].ticket,fingerprint:l}});t.addresses=s}},H6=(t,e)=>{if(t.response_body&&t.response_body.length){let i=t.response_body[0];if(i.buffer.code!==0){let n=tc(i.buffer.code);throw new x(C.UPDATE_TICKET_FAILED,"[".concat(i.buffer.code,"]: ").concat(n.desc),{retry:n.retry})}return i.buffer.ticket}throw _.debug("update ticket request received ap response without response body:",e),new x(C.UPDATE_TICKET_FAILED,"cannot find response body from ap response",{retry:!1})},Ig=(t,e,i)=>{let n=Math.floor(Math.random()*1e12),r=t.role==="host"?"1":t.role==="audience"?"2":void 0,o={appid:t.appId,client_ts:Date.now(),opid:n,sid:t.sid,request_bodies:[{uri:22,buffer:{cname:t.cname,detail:Nr(Nr(Nr({6:t.stringUid,11:e,12:A("USE_NEW_TOKEN")?"1":void 0},r?{17:r}:{}),{},{22:e},t.apRequestDetail?{33:t.apRequestDetail}:{}),t.apRTM?{26:"RTM2"}:{}),key:t.token,service_ids:i,uid:t.uid||0}}]};o.request_bodies.forEach(a=>{t.multiIP&&t.multiIP.gateway_ip&&(a.buffer.detail[5]=JSON.stringify({vocs_ip:[t.multiIP.uni_lbs_ip],vos_ip:[t.multiIP.gateway_ip]}))});let s=new FormData;return s.append("request",JSON.stringify(o)),[s,n]},K6=(t,e)=>{let i=Math.floor(Math.random()*1e12),n={appid:t.appId,client_ts:Date.now(),opid:i,sid:t.sid,request_bodies:[{uri:28,buffer:{cname:t.cname,detail:{1:"",6:t.stringUid,12:"1"},token:t.token,service_ids:e,uid:t.uid||0,edges_services:t.apResponse.addresses.map(o=>({ip:o.ip,port:o.port}))}}]},r=new FormData;return r.append("request",JSON.stringify(n)),[r,i]},rc=0;function oc(t){return Q.all(t.map(e=>e.then(i=>{throw i},i=>i))).then(e=>{throw e},e=>e)}let Ud=t=>I(null,null,function*(){let{fragementLength:e,referenceList:i,asyncMapHandler:n,allFailedhandler:r,promisesCollector:o}=t,s=0,a=e,c,d=0,l=()=>I(null,null,function*(){let u=(()=>{let h=s*a,p=h+a;return i.slice(h,p).map(n)})();o&&o.push(...u);try{c=yield oc(u)}catch(h){if(d+=a,s++,!(d>=i.length))return void(yield l());r(h)}u.forEach(h=>h.cancel())});return yield l(),c}),uN=t=>I(null,null,function*(){let{referenceList:e,asyncMapHandler:i,closeFn:n}=t,r=e.length,o=0,s=()=>I(null,null,function*(){let a=i(e.shift());try{return yield a}catch(c){if(o++,o>=r||n!=null&&n(c))throw c;return s()}});return s()});function Ag(t,e,i,n){return I(this,null,function*(){return{gatewayInfo:yield function(o,s,a,c){return I(this,null,function*(){let d=null,l=[],u=()=>I(null,null,function*(){let p=A("WEBCS_DOMAIN").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(f=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(f+"/api/v2/transpond/webrtc?v=2"):"https://".concat(f,"/api/v2/transpond/webrtc?v=2"),areaCode:Md()})),g=c.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),E=yield Ud({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(o.clientId,"] Connect to choose_server:"),f.url),cN(f,o,s,a)),allFailedhandler:f=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},g),f[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},g),E}),h=()=>I(null,null,function*(){if(yield qe(1e3),d!==null)return d;let p=A("WEBCS_DOMAIN_BACKUP_LIST").map(f=>({url:o.proxyServer?"https://".concat(o.proxyServer,"/ap/?url=").concat(f+"/api/v2/transpond/webrtc?v=2"):"https://".concat(f,"/api/v2/transpond/webrtc?v=2"),areaCode:Md()})),g=c.recordJoinChannelService({endTs:void 0,startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),E=yield Ud({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(o.clientId,"] Connect to backup choose_server:"),f.url),cN(f,o,s,a)),allFailedhandler:f=>{throw c.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},g),f[0]},promisesCollector:l});return c.recordJoinChannelService({endTs:Date.now(),status:"success"},g),E});try{return d=yield oc([u(),h()]),l.length&&l.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),d}catch(p){throw p[0]}})}(t,e,i,n)}})}function hN(t,e,i,n,r){return I(this,null,function*(){let o=t.cloudProxyServer;if(o==="disabled"){if(!n)return;if(t.useLocalAccessPoint)return yield Ag(t,e,i,r);if(A("JOIN_WITH_FALLBACK_MEDIA_PROXY")){let{gatewayInfo:h,proxyInfo:p}=yield mN(t,e,i,r);if(t.turnServer&&t.turnServer.mode!=="auto")return{gatewayInfo:h};let g=p.map(E=>({turnServerURL:E.address,tcpport:E.tcpport||ti.tcpport,udpport:E.udpport||ti.udpport,username:E.username||ti.username,password:E.password||ti.password,forceturn:!1,security:!0}));if(r.useP2P){var s;let E=(s=t.uid)!==null&&s!==void 0?s:h.uid,f="glb:".concat(E.toString()),R=yield gf(f),y=p.map(N=>({turnServerURL:N.address,tcpport:N.tcpport||ti.tcpport,udpport:N.udpport||ti.udpport,username:f,password:R,forceturn:!1,security:!0}));g.push(...y)}return t.turnServer={mode:"manual",servers:g},{gatewayInfo:h}}return yield Ag(t,e,i,r)}let{proxyInfo:a,gatewayInfo:c}=yield mN(t,e,i,r),d={gatewayInfo:c},l=a.map(h=>({turnServerURL:h.address,tcpport:o==="proxy3"?void 0:h.tcpport?h.tcpport:ti.tcpport,udpport:o==="proxy4"?void 0:h.udpport?h.udpport:ti.udpport,username:h.username||ti.username,password:h.password||ti.password,forceturn:o!=="proxy4",security:o==="proxy5"}));if(r.useP2P){var u;let h=(u=t.uid)!==null&&u!==void 0?u:c.uid,p="glb:".concat(h.toString()),g=yield gf(p),E=a.map(f=>({turnServerURL:f.address,tcpport:o==="proxy3"?void 0:f.tcpport||ti.tcpport,udpport:o==="proxy4"?void 0:f.udpport||ti.udpport,username:p,password:g,forceturn:o!=="proxy4",security:o==="proxy5"}));l.push(...E)}return t.turnServer={mode:"manual",servers:l},_.debug("[".concat(t.clientId,"] set proxy server: ").concat(t.proxyServer,", mode: ").concat(o)),d})}function pN(t,e,i,n,r){return I(this,null,function*(){let o=A("ACCOUNT_REGISTER").slice(0,A("AJAX_REQUEST_CONCURRENT")),s=[];s=e.proxyServer?o.map(c=>"https://".concat(e.proxyServer,"/ap/?url=").concat(c+"/api/v1")):o.map(c=>"https://".concat(c,"/api/v1"));let a=r?.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"stringUID",urls:s});try{let c=yield function(d,l,u,h,p){return I(this,null,function*(){let g=Date.now(),E={sid:u.sid,opid:10,appid:u.appId,string_uid:l},f=d[0],R=yield er(()=>sr(f+"".concat(f.indexOf("?")===-1?"?":"&","action=stringuid"),{data:E,cancelToken:h,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}}),(y,N)=>{if(y.code===0){if(y.uid<=0||y.uid>=Math.pow(2,32))throw _.error("Invalid Uint Uid ".concat(l," => ").concat(y.uid),y),ot.reqUserAccount(E.sid,{lts:g,success:!1,serverAddr:f,stringUid:E.string_uid,uid:y.uid,errorCode:C.INVALID_UINT_UID_FROM_STRING_UID,extend:E}),new x(C.INVALID_UINT_UID_FROM_STRING_UID);return ot.reqUserAccount(E.sid,{lts:g,success:!0,serverAddr:f,stringUid:E.string_uid,uid:y.uid,errorCode:null,extend:E}),!1}let k=tc(y.code);return k.retry&&(f=d[(N+1)%d.length]),ot.reqUserAccount(E.sid,{lts:g,success:!1,serverAddr:f,stringUid:E.string_uid,uid:y.uid,errorCode:k.desc,extend:E}),k.retry},(y,N)=>y.code!==C.OPERATION_ABORTED&&(ot.reqUserAccount(E.sid,{lts:g,success:!1,serverAddr:f,stringUid:E.string_uid,uid:null,errorCode:y.code,extend:E}),f=d[(N+1)%d.length],!0),p);if(R.code!==0){let y=tc(R.code);throw new x(C.UNEXPECTED_RESPONSE,y.desc)}return R})}(s,t,e,i,n);return r?.recordJoinChannelService({status:"success",endTs:Date.now()},a),c.uid}catch(c){throw r?.recordJoinChannelService({status:"error",endTs:Date.now(),errors:[c]},a),c}})}function q6(t,e,i){return I(this,null,function*(){let n=A("ACCOUNT_REGISTER"),r=[];r=e.proxyServer?n.map(o=>"https://".concat(e.proxyServer,"/ap/?url=").concat(o+"/api/v1")):n.map(o=>"https://".concat(o,"/api/v1"));try{return yield uN({referenceList:r,asyncMapHandler:s=>function(a,c,d,l){return I(this,null,function*(){let u=Date.now(),h={sid:d.sid,opid:10,appid:d.appId,string_uid:c};try{let p=yield sr(a+"".concat(a.indexOf("?")===-1?"?":"&","action=stringuid"),{data:h,cancelToken:l,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":72}});if(p.code!==0){let g=tc(p.code);throw new x(C.UNEXPECTED_RESPONSE,"preload sua error:".concat(g.desc),g)}if(p.uid<=0||p.uid>=Math.pow(2,32))throw new x(C.INVALID_UINT_UID_FROM_STRING_UID);return{requestTime:u,url:a,req:h,uid:p.uid,elapse:Date.now()-u}}catch(p){throw p}})}(s,t,e,i),closeFn:s=>s.code===C.OPERATION_ABORTED||s.code===C.UNEXPECTED_RESPONSE&&!s.data.retry})}catch(o){throw o}})}function Y6(t,e,i){return I(this,null,function*(){let n=A("CDS_AP").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v1"):"https://".concat(c,"/api/v1?action=config")),r=n.map(c=>function(d,l,u,h){let p=kt(),g={flag:64,cipher_method:0,features:Nr(Nr(Nr(Nr(Nr({install_id:Nf(),device:p.name,system:p.os,system_general:navigator.userAgent,vendor:l.appId,version:hn,cname:l.cname,session_id:l.sid,proxyServer:l.proxyServer,sdk_type:V6.WEB_RTC,browser_name:p.name,browser_version:p.version,user_agent:navigator.userAgent,channel_name:l.cname},l.stringUid&&{string_uid:l.stringUid}),l.uid&&{uid:l.uid+""}),p.os&&{os_name:p.os}),p.osVersion&&{os_version:p.osVersion}),{},{detail:""})};return er(()=>sr(d,{data:g,timeout:1e3,cancelToken:u,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":54}}),void 0,E=>E.code!==C.OPERATION_ABORTED,h)}(c,t,e,i)),o=null,s=null,a={};try{o=yield oc(r)}catch(c){if(c.code===C.OPERATION_ABORTED)throw c;s=c}if(r.forEach(c=>c.cancel()),ot.reportApiInvoke(t.sid,{name:be.REQUEST_CONFIG_DISTRIBUTE,options:{error:s,res:o}}).onSuccess(),o&&o.test_tags)try{a=function(c){if(!c.test_tags)return{};let d=c.test_tags,l=Object.keys(d),u={};return l.forEach(h=>{var p;let g=ui(p=h.slice(4)).call(p),E=JSON.parse(d[h]),f=E[1];u[g]={tag:E[0]||"",value:f}}),u}(o)}catch{}return a})}function _N(t,e){return I(this,null,function*(){let i=A("WEBCS_DOMAIN").concat(A("WEBCS_DOMAIN_BACKUP_LIST")).map(n=>({url:"https://".concat(n,"/api/v2/transpond/webrtc?v=2"),areaCode:Md(),serviceIds:[Ae.CHOOSE_SERVER,Ae.CLOUD_PROXY_FALLBACK]}));try{return yield uN({referenceList:i,asyncMapHandler:r=>function(o,s,a){return I(this,null,function*(){let c,{url:d,areaCode:l,serviceIds:u}=o,h=Date.now(),[p,g]=Ig(s,l,u),E=Ie.networkState;try{E&&Ie.networkState===Wi.OFFLINE&&Ie.onlineWaiter&&(yield Q.race([Ie.onlineWaiter,qe(Oe.maxRetryTimeout)])),E=Ie.networkState;let{data:f,headers:R}=yield sr(d,{data:p,cancelToken:a,headers:{"Content-Type":"multipart/form-data;"}},!0,!0);c=R.http3==="1"?1:-1,(L=>{let P=[];if(L.response_body.forEach(V=>{let B=V.buffer.code;if(V.uri===23&&B===0&&!V.buffer.edges_services)if(V.buffer.flag===4194310)V.buffer.edges_services=[];else{let Y={error:new x(C.CAN_NOT_GET_GATEWAY_SERVER,"no edge services in ap response",{retry:!0,csIp:L.detail[502]}),flag:V.buffer.flag};P.push(Y)}if(B!==0){let Y=tc(B),J={error:new x(C.CAN_NOT_GET_GATEWAY_SERVER,Y.desc,{desc:Y.desc,retry:Y.retry,csIp:L.detail[502]}),flag:V.buffer.flag};V.buffer.flag===4194310?_.warning(J.error.toString()):P.push(J)}}),P.length)throw new x(C.CAN_NOT_GET_GATEWAY_SERVER,P.map(V=>"flag: ".concat(V.flag,", message: ").concat(V.error.message)).join(" | "),{retry:!!P.find(V=>V.error.data.retry),csIp:L.detail[502],desc:[...new Set(P.map(V=>{var B;return V==null||(B=V.error)===null||B===void 0||(B=B.data)===null||B===void 0?void 0:B.desc}).filter(V=>!!V))]})})(f);let N=Dd(f,Ae.CHOOSE_SERVER),k=Dd(f,Ae.CLOUD_PROXY_FALLBACK);return bg(N),{gatewayInfo:_g(N,d),proxyInfo:k,opid:g,requestTime:h,url:d,isHttp3:c,elapse:Date.now()-h}}catch(f){throw f}})}(r,t,e),closeFn:r=>r.code===C.OPERATION_ABORTED||r.code===C.CAN_NOT_GET_GATEWAY_SERVER&&!r.data.retry})}catch(n){throw n}})}function mN(t,e,i,n){return I(this,null,function*(){let r=A("PROXY_SERVER_TYPE3"),o=(p,g,E)=>{let f=E||r;return Array.isArray(f)&&(f=g%2==0?r[1]:r[0]),"https://".concat(f,"/ap/?url=").concat(p)},s=null,a=[],c=()=>I(null,null,function*(){let p=A("WEBCS_DOMAIN").slice(0,A("AJAX_REQUEST_CONCURRENT")).map((f,R)=>{let y;return y=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(f,"/api/v2/transpond/webrtc?v=2"),R,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(f,"/api/v2/transpond/webrtc?v=2"):o("".concat(f,"/api/v2/transpond/webrtc?v=2"),R),{url:y,areaCode:Md(),serviceIds:[Ae.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?Ae.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Ae.CLOUD_PROXY:Ae.CLOUD_PROXY_FALLBACK]}}),g=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),E=yield Ud({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(t.clientId,"] Connect to choose_server:"),f.url),dN(f,t,e,i)),allFailedhandler:f=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},g),f[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},g),E}),d=()=>I(null,null,function*(){if(yield qe(1e3),s!==null)return s;let p=A("WEBCS_DOMAIN_BACKUP_LIST").map((f,R)=>{let y;return y=t.cloudProxyServer==="disabled"&&t.proxyServer?o("".concat(f,"/api/v2/transpond/webrtc?v=2"),R,t.proxyServer):t.cloudProxyServer==="disabled"||t.cloudProxyServer==="fallback"?"https://".concat(f,"/api/v2/transpond/webrtc?v=2"):o("".concat(f,"/api/v2/transpond/webrtc?v=2"),R),{url:y,areaCode:Md(),serviceIds:[Ae.CHOOSE_SERVER,t.cloudProxyServer==="proxy5"?Ae.CLOUD_PROXY_5:t.cloudProxyServer==="proxy3"||t.cloudProxyServer==="proxy4"?Ae.CLOUD_PROXY:Ae.CLOUD_PROXY_FALLBACK]}}),g=n.recordJoinChannelService({startTs:Date.now(),status:"pending",service:"chooseServer",urls:p.map(f=>f.url)}),E=yield Ud({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:p,asyncMapHandler:f=>(_.debug("[".concat(t.clientId,"] Connect to backup choose_server:"),f.url),dN(f,t,e,i)),allFailedhandler:f=>{throw n.recordJoinChannelService({endTs:Date.now(),status:"error",errors:f},g),f[0]},promisesCollector:a});return n.recordJoinChannelService({endTs:Date.now(),status:"success"},g),E}),l,u,h;try{({gatewayInfo:l,proxyInfo:u,url:h}=yield oc([c(),d()]))}catch(p){throw p[0]}if(a.length&&a.forEach(p=>p.cancel&&typeof p.cancel=="function"&&p.cancel()),!l||!u)throw new x(C.UNEXPECTED_ERROR,"missing gateway or proxy response").print();if(t.apUrl=h,t.cloudProxyServer!=="disabled"&&Array.isArray(r)&&h){let p=/^https?:\/\/(.+?)(\/.*)?$/.exec(h)[1];z(r).call(r,p)&&(t.proxyServer=p,_.setProxyServer(p),ot.setProxyServer(p))}return s={gatewayInfo:l,proxyInfo:yield FO(u,l.uid)},s})}function z6(t,e,i){return I(this,null,function*(){let n=A("UAP_AP").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(o=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(o+"/api/v1?action=uap"):"https://".concat(o,"/api/v1?action=uap")),r=n.map(o=>function(s,a,c,d){let l={command:"convergeAllocateEdge",sid:a.sid,appId:a.appId,token:a.token,ts:Date.now(),version:hn,cname:a.cname,uid:a.uid.toString(),requestId:Cg,seq:Cg};Cg+=1;let u={service_name:"tele_channel",json_body:JSON.stringify(l)};return er(()=>I(null,null,function*(){let h=yield sr(s,{data:u,cancelToken:c,headers:{"X-Packet-Service-Type":0,"X-Packet-URI":61}});if(h.code!==0){let g=new x(C.UNEXPECTED_RESPONSE,"cross channel ap error, code"+h.code,{retry:!0});throw _.error(g.toString()),g}let p=JSON.parse(h.json_body);if(p.code!==200){let g=new x(C.UNEXPECTED_RESPONSE,"cross channel app center error, code: ".concat(p.code,", reason: ").concat(p.reason));throw _.error(g.toString()),g}if(!p.servers||p.servers.length===0){let g=new x(C.UNEXPECTED_RESPONSE,"cross channel app center empty server");throw _.error(g.toString()),g}return{vid:p.vid,workerToken:p.workerToken,addressList:(A("CHANNEL_MEDIA_RELAY_SERVERS")||p.servers).map(g=>"wss://".concat(g.address.replace(/\./g,"-"),".").concat(A("WORKER_DOMAIN"),":").concat(g.wss))}}),void 0,h=>!!(h.code!==C.OPERATION_ABORTED&&h.code!==C.UNEXPECTED_RESPONSE||h.data&&h.data.retry),d)}(o,t,e,i));try{let o=yield oc(r);return r.forEach(s=>s.cancel()),o}catch(o){throw o[0]}})}function X6(t,e,i){return I(this,null,function*(){let n=null,r=[],o=s=>I(null,null,function*(){let a=A(s?"WEBCS_DOMAIN_BACKUP_LIST":"WEBCS_DOMAIN").map(c=>t.proxyServer?"https://".concat(t.proxyServer,"/ap/?url=").concat(c+"/api/v2/transpond/webrtc?v=2"):"https://".concat(c,"/api/v2/transpond/webrtc?v=2"));return s&&(yield qe(1e3),n!==null)?n:yield Ud({fragementLength:A("FRAGEMENT_LENGTH"),referenceList:a,asyncMapHandler:c=>(_.debug("[".concat(t.clientId,"] update ticket, Connect to ").concat(s?"backup":""," choose_server:"),c),function(d,l,u,h){let[p]=K6(l,[Ae.CHOOSE_SERVER]),g=Ie.networkState;return er(()=>I(null,null,function*(){g&&Ie.networkState===Wi.OFFLINE&&Ie.onlineWaiter&&(yield Q.race([Ie.onlineWaiter,qe(h&&h.maxRetryTimeout||Oe.maxRetryTimeout)])),g=Ie.networkState;let E=yield sr(d,{data:p,cancelToken:u,headers:{"Content-Type":"multipart/form-data;"}},!0);return H6(E,d)}),()=>!1,E=>E.code!==C.OPERATION_ABORTED&&(E.code===C.UPDATE_TICKET_FAILED?E.data.retry:(_.warning("[".concat(l.clientId,"] update ticket network error, retry"),E),!0)),h)}(c,t,e,i)),allFailedhandler:c=>{throw c[0]},promisesCollector:r})});try{return n=yield oc([o(!1),o(!0)]),r.length&&r.forEach(s=>s.cancel&&typeof s.cancel=="function"&&s.cancel()),n}catch(s){throw s[0]}})}function EN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function wg(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?EN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):EN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class J6 extends ue{get isSuccess(){return!!this.configs}constructor(e,i){super(),T(this,"configs",void 0),T(this,"store",void 0),T(this,"joinInfo",void 0),T(this,"cancelToken",void 0),T(this,"retryConfig",{timeout:3e3,timeoutFactor:1.5,maxRetryCount:1,maxRetryTimeout:1e4}),T(this,"interval",void 0),T(this,"mutex",void 0),T(this,"mutableParamsRead",!1),T(this,"configCache",{}),T(this,"limit_bitrate",void 0),this.mutex=new ni("config-distribute",e),this.store=i}startGetConfigDistribute(e,i){this.joinInfo=e,this.cancelToken=i,this.interval&&this.stopGetConfigDistribute(),A("ENABLE_CONFIG_DISTRIBUTE")&&(this.updateConfigDistribute(),this.interval=window.setInterval(()=>{this.updateConfigDistribute()},A("CONFIG_DISTRIBUTE_INTERVAL")))}stopGetConfigDistribute(){this.interval&&clearInterval(this.interval),this.interval=void 0,this.joinInfo=void 0,this.cancelToken=void 0,this.configs=void 0,this.limit_bitrate=void 0}awaitConfigDistributeComplete(){return I(this,null,function*(){this.mutex.isLocked&&(yield this.mutex.lock())()})}updateConfigDistribute(){return I(this,null,function*(){if(this.mutableParamsRead||(this.mutableParamsRead=!0,ot.reportApiInvoke(null,{options:void 0,name:be.LOAD_CONFIG_FROM_LOCALSTORAGE,tag:Ee.TRACER}).onSuccess(JSON.stringify(ir))),!this.joinInfo||!this.cancelToken||!this.retryConfig)return void _.debug("[config-distribute] get config distribute interrupted have no joininfo");let e,i=yield this.mutex.lock();try{e=yield Y6(this.joinInfo,this.cancelToken,this.retryConfig),_.debug("[config-distribute] get config distribute",JSON.stringify(e));let n=function(r){var o;let s=ls(o=Object.keys(r).filter(d=>/^webrtc_ng_global_parameter/.test(d))).call(o);for(let d=0;d<s.length;d++)for(let l=s.length-1;l>d;l--){let u=s[l],h=r[u].value;if(typeof h.__priority=="number"){let p=h.__priority,g=s[l-1],E=r[g].value;if(typeof E.__priority=="number"){if(!(p>E.__priority))continue;{let f=u;s[l]=s[l-1],s[l-1]=f}}else{let f=u;s[l]=s[l-1],s[l-1]=f}}}let a=Date.now(),c={};return s.forEach(d=>{let l=r[d].value.__expires;l&&l<=a||(c[d]=r[d])}),c}(e);this.cacheGlobalParameterConfig(n),this.store.hasStartJoinChannel||(this.store.isABTestSuccess=!0),this.configs=n}catch(n){let r=new x(C.NETWORK_RESPONSE_ERROR,n);_.warning("[config-distribute] ".concat(r.toString()))}finally{i()}})}getBitrateLimit(){return this.limit_bitrate||void 0}handleBitrateLimit(e){wO(e)&&(this.limit_bitrate?this.limit_bitrate&&this.limit_bitrate.id!==e.id&&this.emit(wd.UPDATE_BITRATE_LIMIT,e):this.emit(wd.UPDATE_BITRATE_LIMIT,e))}getLowStreamConfigDistribute(){return this.limit_bitrate&&wg({},this.limit_bitrate.low_stream_uplink)}handleABTestConfigDistribute(e){try{let i={},n=Object.keys(e),r=[];n.forEach(o=>{let s=e[o].value;i[o]=s;let a=s.__id;if(a&&this.configCache[o]&&this.configCache[o].__id===a)return;let c=s.__type,d=e[o].value,l=e[o].tag,u=0;c?c===iw.REALTIME&&(u=1):Object.keys(d).some(h=>Object.prototype.hasOwnProperty.call(kf,h)||!ng()&&Object.prototype.hasOwnProperty.call(Rh,h)?(u=1,!0):void 0),r.push({tag:l,isApplied:u,feature:o,params:JSON.stringify(s)})}),r.forEach(o=>{let{tag:s,feature:a,params:c,isApplied:d}=o;this.store.sessionId&&ot.abTest(this.store.sessionId,{intSucc:1,isApplied:d,tag:s,feature:a,params:c,cid:this.store.cid,uid:this.store.intUid})}),this.configCache=i}catch(i){_.debug("handleABTestConfigDistribute error",i)}}cacheGlobalParameterConfig(e){let i=function(r){let o={};return Object.keys(r).forEach(s=>{let a=r[s].value,c=a.__expires,d=a.__type;Object.keys(a).forEach(l=>{l==="__id"||l==="__type"||l==="__priority"||l==="__expires"||Object.prototype.hasOwnProperty.call(o,l)||(o[l]=wg(wg({value:a[l]},c&&{expires:c}),d&&{type:d}))})}),o}(e);try{var n;let r=(n=i.LIMIT_BITRATE)===null||n===void 0?void 0:n.value;delete i.LIMIT_BITRATE,r&&wO(r)&&this.handleBitrateLimit(r),this.limit_bitrate=r,this.handleGlobalParameterConfig(i),this.handleABTestConfigDistribute(e),function(a){try{let c=Date.now();Object.keys(a).forEach(d=>{let{value:l,type:u,expires:h}=a[d];h&&h<=c||((u===iw.REALTIME||Object.prototype.hasOwnProperty.call(kf,d))&&(ir[d]=l,ae[d]=l,_.debug("Update realtime parameters from config distribute",d,l)),u||ng()||!Object.prototype.hasOwnProperty.call(Rh,d)||(ir[d]=l,ae[d]=l,_.debug("Update gateway parameters from config distribute",d,l)))})}catch(c){_.error("Error update config immediately: ".concat(a),c.message)}}(i);let o=JSON.stringify(i),s=window.btoa(o);window.localStorage.setItem("websdk_ng_global_parameter",s),_.debug("Caching global parameters ".concat(o))}catch(r){_.error("Error caching global parameters:",r.message)}}handleGlobalParameterConfig(e){try{let i=Date.now();Object.keys(e).forEach(n=>{if(n==="CLIENT_ROLE_OPTIONS"&&Object.prototype.hasOwnProperty.call(ae,n)){let{value:r,expires:o}=e[n];if(o&&o<=i)return;(function(s,a){try{return typeof s=="object"&&typeof a=="object"&&JSON.stringify(s)===JSON.stringify(a)}catch{return!1}})(ae[n],r)||(ir[n]=r,ae[n]=r,this.emit(wd.UPDATE_CLIENT_ROLE_OPTIONS,r),_.debug("Updating client role options: ".concat(JSON.stringify(r))))}})}catch(i){_.error("Error handling global parameter config:",i.message)}}}class Q6 extends ue{constructor(){super(...arguments),T(this,"resultStorage",new Map)}setLocalAudioStats(e,i,n){this.record("AUDIO_INPUT_LEVEL_TOO_LOW",e,this.checkAudioInputLevel(n,i)),this.record("SEND_AUDIO_BITRATE_TOO_LOW",e,this.checkSendAudioBitrate(n,i))}setLocalVideoStats(e,i,n){this.record("SEND_VIDEO_BITRATE_TOO_LOW",e,this.checkSendVideoBitrate(n,i)),this.record("FRAMERATE_INPUT_TOO_LOW",e,this.checkFramerateInput(n,i)),this.record("FRAMERATE_SENT_TOO_LOW",e,this.checkFramerateSent(n))}setRemoteAudioStats(e,i){let n=e.getUserId();this.record("AUDIO_OUTPUT_LEVEL_TOO_LOW",n,this.checkAudioOutputLevel(i))}setRemoteVideoStats(e,i){let n=e.getUserId();this.record("RECV_VIDEO_DECODE_FAILED",n,this.checkVideoDecode(i))}record(e,i,n){if(A("STATS_UPDATE_INTERVAL")>500)return;this.resultStorage.has(e)||this.resultStorage.set(e,{result:[],isPrevNormal:!0});let r=this.resultStorage.get(e);if(r&&(r.result.push(n),r.result.length>=5)){var o;let s=z(o=r.result).call(o,!0);r.isPrevNormal&&!s&&this.emit("exception",fN[e],e,i),!r.isPrevNormal&&s&&this.emit("exception",fN[e]+2e3,e+"_RECOVER",i),r.isPrevNormal=s,r.result=[]}}checkAudioOutputLevel(e){return!(e.receiveBitrate>0&&e.receiveLevel===0)}checkAudioInputLevel(e,i){return i instanceof Le&&!i.isActive||!!i.muted||e.sendVolumeLevel!==0}checkFramerateInput(e,i){let n=null;i._encoderConfig&&i._encoderConfig.frameRate&&(n=Hi(i._encoderConfig.frameRate));let r=e.captureFrameRate;return!n||!r||!(n>10&&r<5||n<10&&n>=5&&r<=1)}checkFramerateSent(e){return!(e.captureFrameRate&&e.sendFrameRate&&e.captureFrameRate>5&&e.sendFrameRate<=1)}checkSendVideoBitrate(e,i){return!!i.muted||e.sendBitrate!==0}checkSendAudioBitrate(e,i){return i instanceof Le&&!i.isActive||!!i.muted||e.sendBitrate!==0}checkVideoDecode(e){return e.receiveBitrate===0||e.decodeFrameRate!==0}}let fN={FRAMERATE_INPUT_TOO_LOW:1001,FRAMERATE_SENT_TOO_LOW:1002,SEND_VIDEO_BITRATE_TOO_LOW:1003,RECV_VIDEO_DECODE_FAILED:1005,AUDIO_INPUT_LEVEL_TOO_LOW:2001,AUDIO_OUTPUT_LEVEL_TOO_LOW:2002,SEND_AUDIO_BITRATE_TOO_LOW:2003},si=new class{markSubscribeStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/subscribe-").concat(e))}markPublishStart(t,e){performance.mark("agora-web-sdk/".concat(t,"/publish-").concat(e))}measureFromSubscribeStart(t,e){let i=performance.getEntriesByName("agora-web-sdk/".concat(t,"/subscribe-").concat(e));if(i.length>0){let n=i[i.length-1];return Math.round(performance.now()-n.startTime)}return 0}measureFromPublishStart(t,e){let i=performance.getEntriesByName("agora-web-sdk/".concat(t,"/publish-").concat(e));if(i.length>0){let n=i[i.length-1];return Math.round(performance.now()-n.startTime)}return 0}};function gN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Ds(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?gN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):gN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class xd{constructor(e){T(this,"store",void 0),T(this,"onStatsException",void 0),T(this,"onUploadPublishDuration",void 0),T(this,"onStatsChanged",void 0),T(this,"onVideoCodecChanged",void 0),T(this,"localStats",new Map),T(this,"remoteStats",new Map),T(this,"updateStatsInterval",void 0),T(this,"trafficStats",void 0),T(this,"trafficStatsPeerList",[]),T(this,"uplinkStats",void 0),T(this,"exceptionMonitor",void 0),T(this,"p2pChannel",void 0),T(this,"scalabilityMode",Th.L1T1),T(this,"updateStats",()=>{this.p2pChannel&&(this.updateRemoteStats(this.p2pChannel),this.updateLocalStats(this.p2pChannel))}),this.store=e,this.exceptionMonitor=new Q6,this.exceptionMonitor.on("exception",(i,n,r)=>{this.onStatsException&&this.onStatsException(i,n,r)})}startUpdateStats(){this.updateStatsInterval||(this.updateStatsInterval=window.setInterval(this.updateStats,1e3))}stopUpdateStats(){this.updateStatsInterval&&(window.clearInterval(this.updateStatsInterval),this.updateStatsInterval=void 0)}reset(){this.localStats=new Map,this.remoteStats=new Map,this.trafficStats=void 0,this.trafficStatsPeerList=[],this.uplinkStats=void 0}getLocalAudioTrackStats(){return this.localStats.get(W.LocalAudioTrack)||Ds({},Ff)}getLocalVideoTrackStats(){return this.localStats.get(W.LocalVideoTrack)||Ds({},Bf)}getRemoteAudioTrackStats(e){let i=(o,s)=>{if(!this.trafficStats)return s;let a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppad+(Date.now()-this.trafficStats.timestamp)),s},n={};if(e){var r;let o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.audioStats;o&&(n[e]=i(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{audioStats:a}]=o;a&&(n[s]=i(s,a))});return n}getRemoteNetworkQualityStats(e){let i={};if(e){var n;let r=(n=this.remoteStats.get(e))===null||n===void 0?void 0:n.networkStats;r&&(i[e]=r)}else Array.from(this.remoteStats.entries()).forEach(r=>{let[o,{networkStats:s}]=r;s&&(i[o]=s)});return i}getRemoteVideoTrackStats(e){let i=(o,s)=>{if(!this.trafficStats)return s;let a=this.trafficStats.peer_delay.find(c=>c.peer_uid===o);return a&&(s.publishDuration=a.B_ppvd+(Date.now()-this.trafficStats.timestamp)),s},n={};if(e){var r;let o=(r=this.remoteStats.get(e))===null||r===void 0?void 0:r.videoStats;o&&(n[e]=i(e,o))}else Array.from(this.remoteStats.entries()).forEach(o=>{let[s,{videoStats:a}]=o;a&&(n[s]=i(s,a))});return n}getRTCStats(){let e=0,i=0,n=0,r=0,o=this.localStats.get(W.LocalAudioTrack);o&&(e+=o.sendBytes,i+=o.sendBitrate);let s=this.localStats.get(W.LocalVideoTrack);s&&(e+=s.sendBytes,i+=s.sendBitrate);let a=this.localStats.get(W.LocalVideoLowTrack);a&&(e+=a.sendBytes,i+=a.sendBitrate),this.remoteStats.forEach(d=>{let{audioStats:l,videoStats:u}=d;l&&(n+=l.receiveBytes,r+=l.receiveBitrate),u&&(n+=u.receiveBytes,r+=u.receiveBitrate)});let c=1;return this.trafficStats&&(c+=this.trafficStats.peer_delay.length),{Duration:0,UserCount:c,SendBitrate:i,SendBytes:e,RecvBytes:n,RecvBitrate:r,OutgoingAvailableBandwidth:this.uplinkStats?this.uplinkStats.B_uab/1e3:0,RTT:this.trafficStats?2*this.trafficStats.B_acd:0}}addLocalStats(e){this.localStats.set(e,void 0)}removeLocalStats(e){e?this.localStats.delete(e):this.localStats.clear()}addRemoteStats(e){this.remoteStats.set(e,{})}removeRemoteStats(e){e?this.remoteStats.delete(e):this.remoteStats.clear()}addP2PChannel(e){this.p2pChannel=e}updateTrafficStats(e){e.peer_delay=e.peer_delay.filter(i=>i.B_ppad!==void 0||i.B_ppvd!==void 0),e.peer_delay.filter(i=>this.trafficStatsPeerList.indexOf(i.peer_uid)===-1).forEach(i=>{var n;let r=(n=this.p2pChannel)===null||n===void 0?void 0:n.getRemoteMedia(i.peer_uid),o=r!=null&&r.videoSSRC?si.measureFromSubscribeStart(this.store.clientId,r.videoSSRC):0,s=r!=null&&r.audioSSRC?si.measureFromSubscribeStart(this.store.clientId,r.audioSSRC):0;i.B_ppad!==void 0&&i.B_ppvd!==void 0&&(this.onUploadPublishDuration&&this.onUploadPublishDuration(i.peer_uid,i.B_ppad,i.B_ppvd,o>s?o:s),this.trafficStatsPeerList.push(i.peer_uid))}),this.trafficStats=e}updateUplinkStats(e){this.uplinkStats&&this.uplinkStats.B_fir!==e.B_fir&&_.debug("[".concat(this.store.clientId,"]: Period fir changes to ").concat(e.B_fir)),this.uplinkStats=e}static isRemoteVideoFreeze(e,i,n){if(!e)return!1;let r=!!n&&i.framesDecodeFreezeTime>n.framesDecodeFreezeTime,o=!n||i.framesDecodeCount>n.framesDecodeCount;return r||!o}static isRemoteAudioFreeze(e){return!!e&&e._isFreeze()}isLocalVideoFreeze(e){return!(!e.inputFrame||!e.sentFrame)&&e.inputFrame.frameRate>5&&e.sentFrame.frameRate<3}updateLocalStats(e){Array.from(this.localStats.entries()).forEach(i=>{let[n,r]=i;switch(n){case W.LocalVideoTrack:case W.LocalVideoLowTrack:{let a=r,c=Ds({},Bf),d=e.getStats(),l=e.getLocalMedia(n);if(d){let u=d.videoSend.find(h=>h.ssrc===l?.ssrcs[0].ssrcId);if(u){let h=e.getLocalVideoSize(),p=e.getEncoderConfig(W.LocalVideoTrack);var o;(u.codec==="H264"||u.codec==="H265"||u.codec==="VP8"||u.codec==="VP9"||u.codec==="AV1X"||u.codec==="AV1")&&(c.codecType=u.codec,a?.codecType!==u.codec&&((o=this.onVideoCodecChanged)===null||o===void 0||o.call(this,u.codec.toLocaleLowerCase()))),c.sendBytes=u.bytes,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0,u.inputFrame?(c.captureFrameRate=u.inputFrame.frameRate,c.captureResolutionHeight=u.inputFrame.height,c.captureResolutionWidth=u.inputFrame.width):h&&(c.captureResolutionWidth=h.width,c.captureResolutionHeight=h.height),u.sentFrame?(c.sendFrameRate=u.sentFrame.frameRate,c.sendResolutionHeight=u.sentFrame.height,c.sendResolutionWidth=u.sentFrame.width):h&&(c.sendResolutionWidth=h.width,c.sendResolutionHeight=h.height),u.avgEncodeMs&&(c.encodeDelay=u.avgEncodeMs),p&&p.bitrateMax?c.targetSendBitrate=1e3*p.bitrateMax:u.targetBitrate&&(c.targetSendBitrate=u.targetBitrate),c.sendPackets=u.packets,c.sendPacketsLost=u.packetsLost,c.sendJitterMs=u.jitterMs,c.sendRttMs=u.rttMs,c.totalDuration=a?a.totalDuration+1:1,c.totalFreezeTime=a?a.totalFreezeTime:0,this.isLocalVideoFreeze(u)&&(c.totalFreezeTime+=1),u.scalabilityMode&&this.scalabilityMode!==u.scalabilityMode&&(_.debug("[".concat(this.store.clientId,"]: The scalabilityMode of the video sending stream is ").concat(u.scalabilityMode)),this.scalabilityMode=u.scalabilityMode)}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_pvlr4||0)/100)}var s;this.localStats.set(n,c),(a?.sendResolutionWidth!==c.sendResolutionWidth||a?.sendResolutionHeight!==c.sendResolutionHeight)&&((s=this.onStatsChanged)===null||s===void 0||s.call(this,"resolution",{width:c.sendResolutionWidth,height:c.sendResolutionHeight})),c&&l&&this.exceptionMonitor.setLocalVideoStats(this.store.uid,l.track,c);break}case W.LocalAudioTrack:{let a=r,c=Ds({},Ff),d=e.getStats(),l=e.getLocalMedia(n);if(d){let u=d.audioSend.find(h=>h.ssrc===l?.ssrcs[0].ssrcId);if(u){if(u.codec!=="opus"&&u.codec!=="aac"&&u.codec!=="PCMU"&&u.codec!=="PCMA"&&u.codec!=="G722"||(c.codecType=u.codec),u.inputLevel)c.sendVolumeLevel=Math.round(32767*u.inputLevel);else{let h=e.getLocalAudioVolume();h&&(c.sendVolumeLevel=Math.round(32767*h))}c.sendBytes=u.bytes,c.sendPackets=u.packets,c.sendPacketsLost=u.packetsLost,c.sendJitterMs=u.jitterMs,c.sendRttMs=u.rttMs,c.sendBitrate=a?8*Math.max(0,c.sendBytes-a.sendBytes):0}}this.trafficStats&&(c.currentPacketLossRate=(this.trafficStats.B_palr4||0)/100),this.localStats.set(W.LocalAudioTrack,c),c&&l&&this.exceptionMonitor.setLocalAudioStats(this.store.uid,l.track,c);break}}})}updateRemoteStats(e){Array.from(this.remoteStats.entries()).forEach(i=>{var n,r;let[o,{videoStats:s,audioStats:a,videoPcStats:c}]=i,d=a,l=s,u=c,h=Ds({},pw),p=Ds({},_w),g=Ds({},kK),{audioTrack:E,videoTrack:f,audioSSRC:R,videoSSRC:y}=e.getRemoteMedia(o),N;N=this.store.useP2P?e.getStats(!0):e.getStats();let k=(n=N)===null||n===void 0?void 0:n.audioRecv.find(B=>B.ssrc===R),L=(r=N)===null||r===void 0?void 0:r.videoRecv.find(B=>B.ssrc===y),P=this.trafficStats&&this.trafficStats.peer_delay.find(B=>B.peer_uid===o);if(k&&(k.codec!=="opus"&&k.codec!=="aac"&&k.codec!=="PCMU"&&k.codec!=="PCMA"&&k.codec!=="G722"||(h.codecType=k.codec),k.outputLevel?h.receiveLevel=Math.round(32767*k.outputLevel):E&&(h.receiveLevel=Math.round(32767*E.getVolumeLevel())),h.receiveBytes=k.bytes,h.receivePackets=k.packets,h.receivePacketsLost=k.packetsLost,h.receivePacketsDiscarded=k.packetsDiscarded,h.packetLossRate=h.receivePacketsLost/(h.receivePackets+h.receivePacketsLost),h.receiveBitrate=d?8*Math.max(0,h.receiveBytes-d.receiveBytes):0,h.totalDuration=d?d.totalDuration+1:1,h.totalFreezeTime=d?d.totalFreezeTime:0,h.freezeRate=h.totalFreezeTime/h.totalDuration,h.receiveDelay=k.jitterBufferMs,h.totalDuration>10&&xd.isRemoteAudioFreeze(E)&&(h.totalFreezeTime+=1)),L){var V;L.codec!=="H264"&&L.codec!=="H265"&&L.codec!=="VP8"&&L.codec!=="VP9"&&L.codec!=="AV1X"&&L.codec!=="AV1"||(p.codecType=L.codec),p.receiveBytes=L.bytes,p.receiveBitrate=l?8*Math.max(0,p.receiveBytes-l.receiveBytes):0,p.decodeFrameRate=L.decodeFrameRate<0?0:L.decodeFrameRate,p.renderFrameRate=L.decodeFrameRate<0?0:L.decodeFrameRate,L.outputFrame&&(p.renderFrameRate=L.outputFrame.frameRate),L.receivedFrame?(p.receiveFrameRate=L.receivedFrame.frameRate,p.receiveResolutionHeight=L.receivedFrame.height,p.receiveResolutionWidth=L.receivedFrame.width):f&&(p.receiveResolutionHeight=f._videoHeight||0,p.receiveResolutionWidth=f._videoWidth||0),L.framesRateFirefox!==void 0&&(p.receiveFrameRate=Math.round(L.framesRateFirefox)),p.receivePackets=L.packets,p.receivePacketsLost=L.packetsLost,p.packetLossRate=p.receivePacketsLost/(p.receivePackets+p.receivePacketsLost);let B=l?l.totalFreezeTime:0,Y=l?l.totalDuration:0;p.totalDuration=l?l.totalDuration+1:1,p.totalFreezeTime=(V=L.totalFreezesDuration)!==null&&V!==void 0?V:B||0,p.receiveDelay=L.jitterBufferMs||0;let J=!!y&&e.getRemoteVideoIsReady(y);L.totalFreezesDuration===void 0&&f&&J&&xd.isRemoteVideoFreeze(f,L,u)&&(p.totalFreezeTime+=1),p.freezeRate=Math.max(0,Math.min((p.totalFreezeTime-B)/(p.totalDuration-Y),1))}P&&(h.end2EndDelay=P.B_ad,p.end2EndDelay=P.B_vd,h.transportDelay=P.B_ed,p.transportDelay=P.B_ed,h.currentPacketLossRate=P.B_ealr4/100,p.currentPacketLossRate=P.B_evlr4/100,g.uplinkNetworkQuality=P.B_punq?P.B_punq:0,g.downlinkNetworkQuality=P.B_pdnq?P.B_pdnq:0),this.remoteStats.set(o,{audioStats:h,videoStats:p,videoPcStats:L,networkStats:g}),E&&this.exceptionMonitor.setRemoteAudioStats(E,h),f&&this.exceptionMonitor.setRemoteVideoStats(f,p)})}}class SN{constructor(){T(this,"destChannelMediaInfos",new Map),T(this,"srcChannelMediaInfo",void 0)}setSrcChannelInfo(e){IO(e),this.srcChannelMediaInfo=e}addDestChannelInfo(e){IO(e),this.destChannelMediaInfos.set(e.channelName,e)}removeDestChannelInfo(e){Bh(e),this.destChannelMediaInfos.delete(e)}getSrcChannelMediaInfo(){return this.srcChannelMediaInfo}getDestChannelMediaInfo(){return this.destChannelMediaInfos}}function TN(t){if(!(t instanceof SN))return new x(C.INVALID_PARAMS,"Config should be instance of [ChannelMediaRelayConfiguration]").throw();let e=t.getSrcChannelMediaInfo(),i=t.getDestChannelMediaInfo();if(!e)return new x(C.INVALID_PARAMS,"srcChannelMediaInfo should not be empty").throw();if(i.size===0)return new x(C.INVALID_PARAMS,"destChannelMediaInfo should not be empty").throw()}class Ho{get hasVideo(){return this._video_enabled_&&!this._video_muted_&&this._video_added_}get hasAudio(){return this._audio_enabled_&&!this._audio_muted_&&this._audio_added_}get audioTrack(){if(this.hasAudio||this._audio_pre_subscribed)return this._audioTrack}get videoTrack(){if(this.hasVideo||this._video_pre_subscribed)return this._videoTrack}get dataChannels(){return this._dataChannels}constructor(e,i){T(this,"uid",void 0),T(this,"_uintid",void 0),T(this,"_trust_in_room_",!0),T(this,"_trust_audio_enabled_state_",!0),T(this,"_trust_video_enabled_state_",!0),T(this,"_trust_audio_mute_state_",!0),T(this,"_trust_video_mute_state_",!0),T(this,"_audio_muted_",!1),T(this,"_video_muted_",!1),T(this,"_audio_enabled_",!0),T(this,"_video_enabled_",!0),T(this,"_audio_added_",!1),T(this,"_video_added_",!1),T(this,"_is_pre_created",!1),T(this,"_video_pre_subscribed",!1),T(this,"_audio_pre_subscribed",!1),T(this,"_trust_video_stream_added_state_",!0),T(this,"_trust_audio_stream_added_state_",!0),T(this,"_audioTrack",void 0),T(this,"_videoTrack",void 0),T(this,"_dataChannels",[]),T(this,"_audioSSRC",void 0),T(this,"_videoSSRC",void 0),T(this,"_audioOrtc",void 0),T(this,"_videoOrtc",void 0),T(this,"_cname",void 0),T(this,"_rtxSsrcId",void 0),T(this,"_videoMid",void 0),T(this,"_audioMid",void 0),this.uid=e,this._uintid=i}}function RN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function vN(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?RN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):RN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let Vd="9",yN=4e4;function CN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function ro(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?CN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):CN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}var sc=function(t){return t[t.DOWN=0]="DOWN",t[t.UP=1]="UP",t}(sc||{});let tp=new Map;function bN(t,e,i,n){let{scale:r}=t;if(r===0&&n===sc.UP||r>=e.length-1&&n===sc.DOWN)return t;let o=ro(ro({},t),{},{scale:n===sc.DOWN?++r:--r});switch(i){case"maintain-framerate":o=ro(ro({},o),e[r].motion);break;case"maintain-resolution":o=ro(ro({},o),e[r].detail);break;case"balanced":o=ro(ro({},o),e[r].balanced)}return o}function IN(t,e){if(e){let i={overUse:0,underUse:0,adaptationList:AN(e)};tp.set(t,i)}else tp.delete(t)}function AN(t){let e=ro({},t),{bitrateMax:i,frameRate:n,scaleResolutionDownBy:r,bitrateMin:o}=e,{MIN_FRAME_RATE:s,MAX_THRESHOLD_FRAMERATE:a,MAX_SCALE:c,BITRATE_MIN_THRESHOLD:d,BITRATE_MAX_THRESHOLD:l,BWE_SCALE_UP_THRESHOLD:u,BWE_SCALE_DOWN_THRESHOLD:h,PERF_SCALE_DOWN_THRESHOLD:p,PERF_SCALE_UP_THRESHOLD:g,BALANCE_BITRATE_FACTOR:E,BALANCE_FRAMERATE_FACTOR:f,BALANCE_RESOLUTION_FACTOR:R,MOTION_RESOLUTION_FACTOR:y,MOTION_BITRATE_FACTOR:N,DETAIL_FRAMERATE_FACTOR:k,DETAIL_BITRATE_FACTOR:L}=Pf,P=Math.min(e.frameRate,a),V=[{scale:0,threshold:{bwe_down:Math.round(Math.pow(h,1)*i),bwe_up:i,fps_down:Math.round(Math.pow(p,1)*P),fps_up:n},balanced:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:o},motion:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:o},detail:{scaleResolutionDownBy:1,frameRate:n,bitrateMax:i,bitrateMin:o}}];for(let B=1;B<=c;B++){let Y={bwe_up:Math.round(Math.pow(u,B)*i),bwe_down:Math.round(Math.pow(h,B+1)*i),fps_up:Math.round(Math.pow(g,B)*P),fps_down:Math.round(Math.pow(p,B+1)*P)},J={scaleResolutionDownBy:r/Math.pow(R,B),frameRate:Math.max(Math.round(Math.pow(f,B)*n),s),bitrateMax:Math.max(Math.round(Math.pow(E,B)*i),l),bitrateMin:Math.max(Math.round(Math.pow(E,B)*o),d)},yt={scaleResolutionDownBy:r/Math.pow(y,B),frameRate:n,bitrateMax:Math.max(Math.round(Math.pow(N,B)*i),l),bitrateMin:Math.max(Math.round(Math.pow(N,B)*o),d)},Rt={scaleResolutionDownBy:1,frameRate:Math.max(Math.round(Math.pow(k,B)*n),s),bitrateMax:Math.max(Math.round(Math.pow(L,B)*i),l),bitrateMin:Math.max(Math.round(Math.pow(L,B)*o),d)};V.push({scale:B,threshold:Y,balanced:J,motion:yt,detail:Rt})}return V}function Z6(t,e,i,n,r,o){let s=tp.get(t)||{overUse:0,underUse:0,adaptationList:AN(r)},{adaptationList:a}=s;tp.set(t,s);let{OVERUSE_TIMES_THRESHOLD:c,UNDERUSE_TIMES_THRESHOLD:d}=Pf,{scale:l}=n,u,h;return typeof e=="number"&&e>0&&function(p,g,E,f){if(g>=E.length)return!1;let{threshold:{fps_down:R}}=E[g];return A("FORCE_AG_HIGH_FRAMERATE")&&f==="maintain-framerate"&&(R=E[0].threshold.fps_down),p<R}(e,l,a,o)&&(s.overUse++,h=Rd.CPU,s.overUse>c)||typeof i=="number"&&i>0&&function(p,g,E){if(g>=E.length)return!1;let{threshold:{bwe_down:f}}=E[g];return p<f}(i,l,a)&&(s.overUse++,h=Rd.BANDWIDTH,s.overUse>c)?(s.overUse=0,s.underUse=0,u=bN(n,a,o,sc.DOWN),[u,h]):(typeof e=="number"&&e>0&&typeof i=="number"&&i>0&&function(p,g,E,f){if(g===0)return;let{threshold:{fps_up:R}}=E[g];return A("FORCE_AG_HIGH_FRAMERATE")&&f==="maintain-framerate"&&(R=E[1].threshold.fps_up),p>R}(e,l,a,o)&&function(p,g,E){if(g===0)return;let{threshold:{bwe_up:f}}=E[g];return p>f}(i,l,a)&&(s.underUse++,s.underUse>d&&(s.overUse=0,s.underUse=0,u=bN(n,a,o,sc.UP),u.scale===0&&(h=Rd.NONE))),[u,h])}function wN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Og(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?wN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):wN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function $6(t){var e;return!!A("ENABLE_AG_ADAPTATION")&&!!(t instanceof Xf||z(e=t._hints).call(e,Jt.CUSTOM_TRACK))&&(!!A("FORCE_SUPPORT_AG_ADAPTATION")||!!(function(i){let n=kt();if(n.os!==Ve.IOS||!n.osVersion)return!1;let r=n.osVersion.split(".");return Number(r[0])>=i}(14)&&CA(17,4,!0)||yA(14)&&bA(17,4,!0)))}let ep=new Map;function ip(t,e){let i=ep.get(t);if(i){let{timer:n}=i;window.clearTimeout(n),ep.delete(t)}e.qualityLimitationReason=Rd.NONE,IN(t)}function tq(t,e){var i;let n;switch(e){case W.LocalAudioTrack:n=Gt.Audio;break;case W.LocalVideoTrack:n=z(i=t._hints).call(i,Jt.SCREEN_TRACK)?Gt.Screen:Gt.High;break;case W.LocalVideoLowTrack:n=Gt.Low}return n}function Ng(t){let e=Mt();if(t.some(i=>i._bypassWebAudio))throw new F(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");if(!e.webAudioMediaStreamDest)throw new F(C.NOT_SUPPORTED,"cannot publish multiple tracks because your browser does not support audio mixing")}function Dg(t,e){Ng(t);let i=e||new Le;return t.forEach(n=>i.addAudioTrack(n)),i}let eq=!Mt().supportUnifiedPlan||A("CHROME_FORCE_PLAN_B")&&Qr();function np(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};var i;return eq?(i={spec:e,store:t},no("PlanBConnection").create(i)):new Dr(e,t)}function Pg(t){return t&&(t.iceConnectionState==="disconnected"||t.iceConnectionState==="checking"||t.iceConnectionState==="failed")}function ON(t){try{if(t.iceServers)return!1;if(t.turnServer&&t.turnServer.mode!=="off"){if(gd(t.turnServer.servers))return!1;if(A("FORCE_TURN_TCP")||t.turnServer.servers.concat(t.turnServer.serversFromGateway||[]).some(e=>e.forceturn))return!0}return!1}catch{return!1}}var Dt;function NN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function ar(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?NN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):NN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let Dr=(Dt=class $s extends NO{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,i;return(e=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&e!==void 0?e:null}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.send.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var i;return z(i=Object.keys(vh)).call(i,e)}))]}constructor(e,i){super(e,i),T(this,"id",te(5,"connection-")),T(this,"store",void 0),T(this,"peerConnection",void 0),T(this,"forceTurn",!1),T(this,"remoteSDP",void 0),T(this,"initialOffer",void 0),T(this,"transportEventReceiver",void 0),T(this,"statsFilter",void 0),T(this,"extension",{useXR:A("USE_XR")}),T(this,"localCapabilities",void 0),T(this,"remoteCodecs",void 0),T(this,"localCandidateCount",0),T(this,"allCandidatesReceived",!1),T(this,"isPreallocation",!1),T(this,"preSSRCMap",new Map),T(this,"dataStreamChannelMap",new Map),T(this,"establishPromise",void 0),T(this,"recoveredDataChannelIds",[]),T(this,"currentDataChannelId",1),T(this,"supportAV1RtpSpec",!1),T(this,"mutex",void 0),T(this,"qualityLimitationReason",Rd.NONE),T(this,"isFirstConnected",!1),this.store=i,this.forceTurn=ON(e),this.mutex=new ni("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection($s.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.isFirstConnected=!1,this.statsFilter=Of(this.peerConnection,A("STATS_UPDATE_INTERVAL"),void 0,_e()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}getPreMedia(e){let i=this.preSSRCMap.get(e);if(i!==void 0){let n=this.peerConnection.getTransceivers().find(r=>r.mid===i);if(n)return{transceiver:n,track:n.receiver.track,id:i}}}updateRemoteRTPCapabilities(e,i){return I(this,null,function*(){if(this.remoteCodecs=i,!this.remoteSDP)return void _.debug("[P2PConnection] cannot updateRemoteRTPCapabilities before remote SDP created, local codecs: ".concat(this.localCodecs,", codecs: ").concat(i));if(this.remoteSDP.updateRemoteCodec(e,i,this.store.codec)){let n=yield this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");yield this.peerConnection.setLocalDescription(n);let o=this.remoteSDP.toString();r?.(o),yield this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}else _.debug("[P2PConnection] updateRemoteRTPCapabilities no need to exchange SDP.")})}establish(){return I(this,null,function*(){try{this.peerConnection.addTransceiver("video",{direction:"recvonly"}),this.peerConnection.addTransceiver("audio",{direction:"recvonly"});let n=yield this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let r=Go(n.sdp),o=yield XO({filterRTX:!A("USE_PUB_RTX")&&!A("USE_SUB_RTX"),filterVideoFec:A("FILTER_VIDEO_FEC"),filterAudioFec:A("FILTER_AUDIO_FEC"),filterVideoCodec:A("FILTER_VIDEO_CODEC")},this.extension);if(this.localCapabilities=Xh(o),this.initialOffer=n,A("ENABLE_SVC")&&this.store.codec=="av1"){let a=yield function(){return I(this,null,function*(){try{let c=new RTCPeerConnection;c.addTransceiver("video",{direction:"sendonly",sendEncodings:[{scalabilityMode:Th.L1T3}]});let d=yield c.createOffer();if(!d.sdp)return void c.close();let l=Li(d.sdp).mediaDescriptions[0];if(!l)return;let u=l.attributes.extmaps.find(h=>h.extensionName==="https://aomediacodec.github.io/av1-rtp-spec/#dependency-descriptor-rtp-header-extension");return c.close(),u}catch{return}})}();var e;a&&(this.supportAV1RtpSpec=!0,(e=o.send)===null||e===void 0||e.videoExtensions.push(a))}let s;return n.sdp&&$O(n.sdp)&&(s=he(o),(i=s).send&&(ec($.VIDEO,i.send.videoExtensions),ec($.AUDIO,i.send.audioExtensions)),i.recv&&(ec($.VIDEO,i.recv.videoExtensions),ec($.AUDIO,i.recv.audioExtensions)),i.sendrecv&&(ec($.VIDEO,i.sendrecv.videoExtensions),ec($.AUDIO,i.sendrecv.audioExtensions))),ar(ar({},r),{},{rtpCapabilities:s||o,offerSDP:n.sdp})}catch(n){throw new F(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,n.toString())}var i})}connect(e){return I(this,null,function*(){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.initialOffer.sdp&&$O(this.initialOffer.sdp)&&(i=e.rtpCapabilities,n=this.localCapabilities,i.send&&(qh($.VIDEO,i.send.videoExtensions,n.send.videoExtensions),qh($.AUDIO,i.send.audioExtensions,n.send.audioExtensions)),i.recv&&(qh($.VIDEO,i.recv.videoExtensions,n.recv.videoExtensions),qh($.AUDIO,i.recv.audioExtensions,n.recv.audioExtensions))),this.remoteSDP=new class{get localCapabilities(){return he(this._localCapabilities)}get rtpCapabilities(){return he(this._rtpCapabilities)}get candidates(){return he(this._candidates)}get iceParameters(){return he(this._iceParameters)}get dtlsParameters(){return he(this._dtlsParameters)}constructor(d){let l=arguments.length>1&&arguments[1]!==void 0&&arguments[1];T(this,"sessionDesc",void 0),T(this,"_localCapabilities",void 0),T(this,"_rtpCapabilities",void 0),T(this,"_candidates",void 0),T(this,"_originCandidates",void 0),T(this,"_iceParameters",void 0),T(this,"_isUseExtmapAllowMixed",void 0),T(this,"_dtlsParameters",void 0),T(this,"setup",void 0),T(this,"currentMidIndex",void 0),T(this,"cname",void 0),T(this,"firefoxSsrcMidMap",new Map),this._isUseExtmapAllowMixed=l,d=he(d);let{iceParameters:u,dtlsParameters:h,candidates:p,rtpCapabilities:g,setup:E,localCapabilities:f,cname:R}=d;this._rtpCapabilities=g,this._candidates=p,this._originCandidates=he(p),this._iceParameters=u,this._dtlsParameters=h,this._localCapabilities=f,this.setup=E,this.cname=R,this.sessionDesc=this.updateRemoteRTPCapabilities(g),this.currentMidIndex=this.sessionDesc.mediaDescriptions.length-1}preloadRemoteMedia(d){let l=this.candidates,u=this.dtlsParameters,h=this.iceParameters,p=this.rtpCapabilities.send,g=this.sessionDesc.mediaDescriptions.length-1;for(let E=1;E<d;E++){let f=2*E+2e4,R=2*E+yN,{ssrcs:y,ssrcGroups:N}=Ns([{ssrcId:f}],this.cname),{ssrcs:k,ssrcGroups:L}=Ns([{ssrcId:R,rtx:A("USE_SUB_RTX")?R+1:void 0}],this.cname);this.sessionDesc.mediaDescriptions.push({media:{mediaType:"video",port:Vd,protos:["UDP","TLS","RTP","SAVPF"],fmts:p.videoCodecs.map(P=>P.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:h.iceUfrag,icePwd:h.icePwd,unrecognized:[],candidates:l,extmaps:p.videoExtensions,fingerprints:u.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:k,ssrcGroups:L,rtcpFeedbackWildcards:[],payloads:p.videoCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++g)}}),this.sessionDesc.mediaDescriptions.push({media:{mediaType:"audio",port:Vd,protos:["UDP","TLS","RTP","SAVPF"],fmts:p.audioCodecs.map(P=>P.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:h.iceUfrag,icePwd:h.icePwd,unrecognized:[],candidates:l,extmaps:p.audioExtensions,fingerprints:u.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:y,ssrcGroups:N,rtcpFeedbackWildcards:[],payloads:p.audioCodecs,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:"sendonly",rtcpMux:!0,rtcpRsize:!0,mid:"".concat(++g)}}),this.currentMidIndex+=2}this.updateBundleMids()}toString(){return xo(this.sessionDesc)}send(d,l,u,h){let{ssrcs:p,ssrcGroups:g}=Ns(l,this.cname,A("SYNC_GROUP")?u:void 0),E=this.findPreloadMediaDesc(p);if(E){if(_e()&&this.firefoxSsrcMidMap.set(p[0].ssrcId,E.attributes.mid),h&&(h.twcc||h.remb)){let f=this.sessionDesc.mediaDescriptions.indexOf(E);return this.sessionDesc.mediaDescriptions[f]=this.mungSendMediaDesc(E,h),{mid:E.attributes.mid,needExchangeSDP:!0}}return{mid:E.attributes.mid,needExchangeSDP:!1}}{let f=this.findAvailableMediaIndex(d,p),R;return f===-1||f===1&&(Qe()||function(){let y=kt();return!(y.name!==xt.CHROME||!y.osVersion)&&Number(y.version)<=90}()||A("ENABLE_ENCODED_TRANSFORM")&&Jr())||f===0&&A("USE_SUB_RTX")||IA()?(R=this.createOrRecycleSendMedia(d,p,g,"sendonly",h),this.updateBundleMids()):(R=he(this.sessionDesc.mediaDescriptions[f]),R.attributes.direction="sendonly",R.attributes.ssrcs=p,R.attributes.ssrcGroups=g,this.sessionDesc.mediaDescriptions[f]=this.mungSendMediaDesc(R,h)),_e()&&this.firefoxSsrcMidMap.set(p[0].ssrcId,R.attributes.mid),{mid:R.attributes.mid,needExchangeSDP:!0}}}sendDataChannel(){let{mediaDesc:d,needExchangeSDP:l}=this.createOrRecycleDataChannel();return this.updateBundleMids(),{mid:d.attributes.mid,needExchangeSDP:l}}batchSend(d){let l=d.map(p=>{let{kind:g,ssrcMsg:E,mslabel:f}=p;return this.send(g,E,f)}),u=[],h=!1;return l.forEach(p=>{let{mid:g,needExchangeSDP:E}=p;E&&(h=!0),u.push(g)}),{mids:u,needExchangeSDP:h}}stopSending(d){let l=this.sessionDesc.mediaDescriptions.filter(u=>u.attributes.mid&&d.indexOf(u.attributes.mid)!==-1);if(l.length!==d.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");l.forEach(u=>{u.attributes.mid==="0"||_e()||IA()?u.attributes.ssrcs=[]:(u.attributes.ssrcs=[],u.attributes.direction="inactive",u.media.port="0")}),this.updateBundleMids()}mute(d){let l=this.sessionDesc.mediaDescriptions.find(u=>u.attributes.mid===d);if(!l)throw new Error("mediaDescription not found with ".concat(d," in remote SDP when calling RemoteSDP.mute."));l.attributes.direction="inactive"}unmute(d){let l=this.sessionDesc.mediaDescriptions.find(u=>u.attributes.mid===d);if(!l)throw new Error("mediaDescription not found with ".concat(d," in remote SDP when calling RemoteSDP.unmute."));l.attributes.direction="sendonly"}muteRemote(d){let l=this.sessionDesc.mediaDescriptions.filter(u=>z(d).call(d,u.attributes.mid||""));if(l.length!==d.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");l.forEach(u=>{u.attributes.direction="inactive"})}unmuteRemote(d){let l=this.sessionDesc.mediaDescriptions.filter(u=>z(d).call(d,u.attributes.mid||""));if(l.length!==d.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");l.forEach(u=>{u.attributes.direction="recvonly"})}receive(d,l,u,h){d.forEach((p,g)=>{this.createOrRecycleRecvMedia(p,[],"recvonly",l,u,h[g])}),this.updateBundleMids()}stopReceiving(d){let l=this.sessionDesc.mediaDescriptions.filter(u=>d.indexOf(u.attributes.mid)!==-1);if(l.length!==d.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");l.forEach(u=>{u.media.port="0",u.attributes.direction="inactive"}),this.updateBundleMids()}updateRemoteRTPCapabilities(d){let l=this.sessionDesc||Li((u=this._isUseExtmapAllowMixed,`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=ice-lite`.concat(u?`
a=extmap-allow-mixed`:"",`
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`)));var u;this._rtpCapabilities=d;let h=this.rtpCapabilities.send,p=this.localCapabilities.send;for(let g of l.mediaDescriptions){if(g.attributes.iceUfrag=this._iceParameters.iceUfrag,g.attributes.icePwd=this._iceParameters.icePwd,g.attributes.fingerprints=this._dtlsParameters.fingerprints,g.attributes.candidates=this._candidates,g.attributes.setup=this.setup,g.media.mediaType==="application"&&(g.attributes.sctpPort="5000"),g.media.mediaType==="video"){if(h.videoCodecs.length===0){let E=p.videoCodecs.filter(f=>{var R,y;return(R=f.rtpMap)===null||R===void 0?void 0:z(y=R.encodingName.toLowerCase()).call(y,"vp8")})||[p.videoCodecs[0]];g.media.fmts=E.map(f=>f.payloadType.toString(10)),g.attributes.payloads=E,g.attributes.extmaps=[]}else if(g.media.fmts=h.videoCodecs.map(E=>E.payloadType.toString(10)),g.attributes.payloads=h.videoCodecs,g.attributes.extmaps=h.videoExtensions,A("PRELOAD_MEDIA_COUNT")>0){let{ssrcs:E,ssrcGroups:f}=Ns([{ssrcId:yN,rtx:A("USE_SUB_RTX")?40001:void 0}],this.cname);g.attributes.ssrcs=E,g.attributes.ssrcGroups=f}}if(g.media.mediaType==="audio"){if(h.audioCodecs.length===0){let E=p.audioCodecs.filter(f=>{var R,y;return(R=f.rtpMap)===null||R===void 0?void 0:z(y=R.encodingName.toLowerCase()).call(y,"opus")})||[p.audioCodecs[0]];g.media.fmts=E.map(f=>f.payloadType.toString(10)),g.attributes.payloads=E,g.attributes.extmaps=[]}else if(g.media.fmts=h.audioCodecs.map(E=>E.payloadType.toString(10)),g.attributes.payloads=h.audioCodecs,g.attributes.extmaps=h.audioExtensions,nc(g),A("PRELOAD_MEDIA_COUNT")>0){let{ssrcs:E,ssrcGroups:f}=Ns([{ssrcId:2e4}],this.cname);g.attributes.ssrcs=E,g.attributes.ssrcGroups=f}}}return this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1,this.sessionDesc}updateCandidates(d){let l=this._originCandidates.filter(h=>h.transport==="udp"),u=[];if(l.forEach(h=>{u.push(vN(vN({},h),{},{foundation:"tcpcandidate",priority:Number(h.priority)-1+"",transport:"tcp",port:Number(h.port)+90+""}))}),l.length!==0){switch(d){case oi.TCP_RELAY:this._candidates=u;break;case oi.UDP_TCP_RELAY:case oi.RELAY:this._candidates=[...l,...u];break;default:this._candidates=l}for(let h of this.sessionDesc.mediaDescriptions)h.attributes.candidates=this.candidates}}restartICE(d){d=he(d),this._iceParameters=d,this.sessionDesc.mediaDescriptions.forEach(l=>{l.attributes.iceUfrag=d.iceUfrag,l.attributes.icePwd=d.icePwd})}predictReceivingMids(d){let l=[];for(let u=0;u<d;u++)l.push((this.currentMidIndex+u+1).toString(10));return l}findAvailableMediaIndex(d,l){return this.sessionDesc.mediaDescriptions.findIndex(u=>{let h=u.media.mediaType===d&&u.media.port!=="0"&&(u.attributes.direction==="sendonly"||u.attributes.direction==="sendrecv")&&u.attributes.ssrcs.length===0;if(_e()){if(h){let p=this.firefoxSsrcMidMap.get(l[0].ssrcId);return!(p||u.attributes.mid!=="0"&&u.attributes.mid!=="1")||!(!p||p!==u.attributes.mid)}return!1}return h})}createOrRecycleDataChannel(){for(let u of this.sessionDesc.mediaDescriptions)if(u.media.mediaType==="application")return{mediaDesc:u,needExchangeSDP:!1};this.currentMidIndex+=1;let d="".concat(this.currentMidIndex),l={media:{mediaType:"application",port:Vd,protos:["UDP","DTLS","SCTP"],fmts:["webrtc-datachannel"]},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:[],fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:[],ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:[],rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,mid:"".concat(d),sctpPort:"5000"}};return this.sessionDesc.mediaDescriptions.push(l),{mediaDesc:l,needExchangeSDP:!0}}createOrRecycleRecvMedia(d,l,u,h,p,g){let E=d._mediaStreamTrack.kind,f=this.rtpCapabilities.recv,R=Ld(E,f,this.localCapabilities.send,E===$.VIDEO?h:p),y=E===$.VIDEO?f.videoExtensions:f.audioExtensions;this.currentMidIndex+=1;let N="".concat(this.currentMidIndex),k={media:{mediaType:E,port:Vd,protos:["UDP","TLS","RTP","SAVPF"],fmts:R.map(P=>P.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:y,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:R,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:u,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(N)}};k=this.mungRecvMediaDsec(k,d,g);let L=this.findFirstClosedMedia(E);if(L){let P=this.sessionDesc.mediaDescriptions.indexOf(L);this.sessionDesc.mediaDescriptions[P]=k}else this.sessionDesc.mediaDescriptions.push(k);return k}updateRemoteCodec(d,l,u){let h=[...new Set(this._rtpCapabilities.recv.videoCodecs.map(k=>k.rtpMap&&k.rtpMap.encodingName.toLowerCase()||"").filter(k=>{var L;return z(L=Object.keys(vh)).call(L,k)}))],p=new Set(l);if(h.every(k=>p.has(k)))return _.debug("codecs has not changed, no need to updateRemoteCodec, codecs: ".concat(l)),!1;let g=this._rtpCapabilities.recv.videoCodecs.filter(k=>l.some(L=>{var P;return z(P=k.rtpMap&&k.rtpMap.encodingName.toLowerCase()||"").call(P,L)}));if(g.length===0)return _.debug("updateRemoteCodec failed, because cannot find matched codec, remoteCapabilities codecs: ".concat(h," codecs: ").concat(l)),!1;let E=[...new Set(g.map(k=>k.rtpMap&&k.rtpMap.encodingName.toLowerCase()||""))],f;if(_.debug("updateRemoteCodec, from ".concat(h," to ").concat(E)),d.length===0)f=this.sessionDesc.mediaDescriptions.filter(k=>k.media.mediaType==="video"&&k.attributes.direction==="recvonly");else if(f=this.sessionDesc.mediaDescriptions.filter(k=>k.attributes.mid&&k.media.mediaType==="video"&&z(d).call(d,k.attributes.mid)&&k.attributes.direction==="recvonly"),f.length!==d.length)return _.debug("updateRemoteCodec failed, because cannot find mids, mids: ".concat(d,", codecs: ").concat(l)),!1;if(A("USE_PUB_RTX")||A("USE_SUB_RTX")){let k=gg(g,this.rtpCapabilities.recv.videoCodecs);g.push(...k)}this._rtpCapabilities.recv.videoCodecs=g;let R=this.localCapabilities.send,y=this.rtpCapabilities.recv,N=Ld($.VIDEO,y,R,u);return f.forEach(k=>{let L=N.map(P=>P.payloadType.toString(10));_.debug("updateRemoteCodec mid: ".concat(k.attributes.mid,", from"),k.attributes.payloads,"to",N),k.attributes.payloads=N,k.media.fmts=L}),!0}createOrRecycleSendMedia(d,l,u,h,p){let g=this.rtpCapabilities.send,E=d===$.VIDEO?g.videoCodecs:g.audioCodecs,f=d===$.VIDEO?g.videoExtensions:g.audioExtensions;this.currentMidIndex+=1;let R="".concat(this.currentMidIndex),y={media:{mediaType:d,port:Vd,protos:["UDP","TLS","RTP","SAVPF"],fmts:E.map(k=>k.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:this.candidates,extmaps:f,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:l,ssrcGroups:u,rtcpFeedbackWildcards:[],payloads:E,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:h,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(R)}};y=this.mungSendMediaDesc(y,p);let N=this.findFirstClosedMedia(d);if(N){let k=this.sessionDesc.mediaDescriptions.indexOf(N);this.sessionDesc.mediaDescriptions[k]=y}else this.sessionDesc.mediaDescriptions.push(y);return y}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(d=>d.media.port!=="0").map(d=>d.attributes.mid)}mungRecvMediaDsec(d,l,u){let h=he(d);return Eg(h),ic(h,l),fg(h,l),YO(h),zh(h,u,this.localCapabilities.send),h}mungSendMediaDesc(d,l){let u=he(d);return zh(u,l,this.localCapabilities.recv),nc(u),u}updateRecvMedia(d,l){let u=this.sessionDesc.mediaDescriptions.findIndex(h=>h.attributes.mid===d);if(u!==-1){let h=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[u],l);this.sessionDesc.mediaDescriptions[u]=h}}bumpMid(d){this.currentMidIndex+=d}findFirstClosedMedia(d){return this.sessionDesc.mediaDescriptions.find(l=>_e()?l.media.port==="0"&&l.media.mediaType===d:l.media.port==="0")}findPreloadMediaDesc(d){return this.sessionDesc.mediaDescriptions.find(l=>{var u;return((u=l.attributes)===null||u===void 0||(u=u.ssrcs[0])===null||u===void 0?void 0:u.ssrcId)===d[0].ssrcId})}getSSRC(d){var l;return(l=this.sessionDesc.mediaDescriptions.find(u=>u.attributes.mid===d))===null||l===void 0?void 0:l.attributes.ssrcs}}(ar(ar({},e),{},{localCapabilities:this.localCapabilities}),this.supportAV1RtpSpec),e.preallocation&&(this.isPreallocation=!0),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let r=this.remoteSDP.toString(),o=QO(this.initialOffer.sdp,this.extension),s=this.logSDPExchange(o||"","offer","local","connect");this.store.descriptionStart(),yield this.peerConnection.setLocalDescription({type:"offer",sdp:o}),s?.(r),yield this.peerConnection.setRemoteDescription({type:"answer",sdp:r});let a=this.peerConnection.getTransceivers()[0];if(a!=null&&a.receiver&&this.tryBindTransportEvents(a.receiver),A("PRELOAD_MEDIA_COUNT")>0){this.remoteSDP.preloadRemoteMedia(A("PRELOAD_MEDIA_COUNT"));let d=this.remoteSDP.toString();yield this.peerConnection.setRemoteDescription({type:"offer",sdp:d});let l=yield this.peerConnection.createAnswer();yield this.peerConnection.setLocalDescription(l)}let{preSSRCs:c}=e;if(Array.isArray(c)&&c.length>0){let{mids:d}=this.remoteSDP.batchSend(c.map(l=>({kind:l.kind,ssrcMsg:[{ssrcId:l.ssrcId,rtx:l.rtx}],mslabel:l.mslabel})));d.forEach((l,u)=>{this.preSSRCMap.set(c[u].ssrcId,l)}),yield kd(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] pre-batchReceive exchange SDP."))}}catch(r){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(r.toString()))}var i,n})}updateRemoteConnect(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateRemoteConnect before remote SDP created");let{rtpCapabilities:i}=e;this.remoteSDP.updateRemoteRTPCapabilities(i),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec([],this.remoteCodecs,this.store.codec);let{preSSRCs:n}=e;if(Array.isArray(n)&&n.length>0){let{mids:r}=this.remoteSDP.batchSend(n.map(o=>Object.assign({},{kind:o.kind,ssrcMsg:[{ssrcId:o.ssrcId,rtx:o.rtx}],mslabel:o.mslabel})));r.forEach((o,s)=>{this.preSSRCMap.set(n[s].ssrcId,o)})}yield kd(this.peerConnection,this.remoteSDP,this.extension),_.debug("[P2PConnection] updateRemoteRTPCapabilities by exchanging SDP.")}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.updateRemoteConnect failed; ".concat(i.toString()))}})}send(e,i,n){var r=this;return un(function*(){let o=yield Lt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let s=[],a=Kh();e.forEach(f=>{let R=r.peerConnection.addTransceiver(f._mediaStreamTrack,ar({direction:"sendonly"},f.trackMediaType==="video"&&r.supportAV1RtpSpec&&a?{sendEncodings:[{scalabilityMode:a}]}:{}));s.push(R),f._updateRtpTransceiver(R)}),_e()&&A("SIMULCAST")===!0&&(yield Lt(r.applySimulcastForFirefox(s,e)));let c=yield Lt(r.peerConnection.createOffer()),d=r.remoteSDP.predictReceivingMids(e.length),l=r.mungSendOfferSDP(c.sdp,e,d),u=Li(l),h=d.map(f=>{let R=u.mediaDescriptions.find(y=>y.attributes.mid===f);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return HO(R,A("USE_PUB_RTX"))}),p;try{p=yield h}catch(f){p=[],r.remoteSDP.receive(e,i,n,p);let R=r.remoteSDP.toString();throw yield Lt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Lt(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield Lt(r.stopSending(d,!0)),f}r.remoteSDP.receive(e,i,n,p);let g=r.remoteSDP.toString(),E=r.logSDPExchange(l,"offer","local","send");return yield Lt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Lt(r.applySimulcastEncodings(s,e)),yield Lt(r.applySendEncodings(s,e)),E?.(g),yield Lt(r.peerConnection.setRemoteDescription({type:"answer",sdp:g})),s.map((f,R)=>{let y=d[R];return{localSSRC:h[R],id:y,transceiver:f}})}catch(s){throw s instanceof F?s:new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}createDataChannels(e,i){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.createDataChannels before remote SDP created");let n=this.dataStreamChannelMap.get(e);if(n&&n.readyState==="open")_.debug("[P2PConnection] Channels are already available and can be reused directly.");else{let o=this.currentDataChannelId<1023?this.currentDataChannelId++:this.recoveredDataChannelIds.shift();if(typeof o!="number")throw new Error("create DataChannel error, because cannot get dc id");n=this.peerConnection.createDataChannel("datastream-channel",{id:o,negotiated:!0,ordered:!1,maxRetransmits:A("DATASTREAM_MAX_RETRANSMITS")}),n.binaryType="arraybuffer",this.dataStreamChannelMap.set(e,n)}i.forEach(o=>{o._updateOriginDataChannel(n)});let{needExchangeSDP:r}=this.remoteSDP.sendDataChannel();if(r){let o=this.remoteSDP.toString();yield this.peerConnection.setRemoteDescription({type:"offer",sdp:o});let s=yield this.peerConnection.createAnswer();yield this.peerConnection.setLocalDescription(s),_.debug("[P2PConnection] createDataChannels by exchanging SDP.")}else _.debug("[P2PConnection] createDataChannels no need to exchange SDP.");return}catch(n){throw n instanceof F?n:new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.createDataChannels failed; ".concat(n.toString()))}})}stopDataChannels(e){return I(this,null,function*(){try{let i=this.dataStreamChannelMap.get(e);return i&&(i.id&&this.recoveredDataChannelIds.push(i.id),i.close()),void this.dataStreamChannelMap.delete(e)}catch(i){throw i instanceof F?i:new F(C.DATACHANNEL_FAILED,"P2PConnection.stopDataChannels failed; ".concat(i.toString()))}})}stopSending(e,i){return I(this,null,function*(){let n=i?void 0:yield this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");r.map(c=>{var d;ip(this.id+c.mid,this),c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});let o=yield this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");yield this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s?.(a),yield this.peerConnection.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{n&&n()}})}receive(e,i,n,r){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,i,n,r);s&&(yield kd(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP.")));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,id:o,transceiver:a}}catch(o){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}})}batchReceive(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let{mids:i,needExchangeSDP:n}=this.remoteSDP.batchSend(e);return n&&(yield kd(this.peerConnection,this.remoteSDP,this.extension),_.debug("[".concat(this.store.clientId,"] [P2PConnection] batchReceive by exchanging SDP."))),i.map(r=>{let o=this.peerConnection.getTransceivers().find(s=>s.mid===r);if(!o)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:o.receiver.track,id:r,transceiver:o}})}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}})}stopReceiving(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");e.forEach(o=>{Array.from(this.preSSRCMap.entries()).some(s=>{let[a,c]=s;if(c===o)return this.preSSRCMap.delete(a),!0})}),this.remoteSDP.stopSending(e);let i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","stopReceiving");yield this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let r=yield this.peerConnection.createAnswer();n?.(r.sdp||""),yield this.peerConnection.setLocalDescription(r)}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}})}muteRemote(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.mute(e);let i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","muteRemote");yield this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let r=yield this.peerConnection.createAnswer();n?.(r.sdp||""),yield this.peerConnection.setLocalDescription(r)}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteRemote failed; ".concat(i.toString()))}})}unmuteRemote(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteRemote mid=".concat(e," before remote SDP created."));this.remoteSDP.unmute(e);let i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","unmuteRemote");yield this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let r=yield this.peerConnection.createAnswer();n?.(r.sdp||""),yield this.peerConnection.setLocalDescription(r)}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteRemote failed; ".concat(i.toString()))}})}muteLocal(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(s=>{s.direction="inactive"});let n=yield this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");yield this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r?.(o),yield this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}})}unmuteLocal(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map((s,a)=>I(this,null,function*(){s.direction="sendonly"}));let n=yield this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");yield this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e),Array.isArray(this.remoteCodecs)&&this.remoteCodecs.length>0&&this.remoteSDP.updateRemoteCodec(e,this.remoteCodecs,this.store.codec);let o=this.remoteSDP.toString();r?.(o),yield this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}})}restartICE(e){var i=this;return un(function*(){let n=yield Lt(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");let r=Mt().supportPCSetConfiguration,o=A("FORCE_TURN_TCP")||i.forceTurn;if(e===oi.RELAY&&!r)return;if(r&&!o){let u=e===oi.RELAY?"relay":"all",h=i.peerConnection.getConfiguration();h.iceTransportPolicy!==u&&(_.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(h.iceTransportPolicy,"] to [").concat(u,"]")),h.iceTransportPolicy=u,i.peerConnection.setConfiguration(h))}i.remoteSDP.updateCandidates(e);let s=yield Lt(i.peerConnection.createOffer({iceRestart:!0}));if(!s.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let a=Go(s.sdp),{remoteIceParameters:c}=yield a.iceParameters;i.remoteSDP.restartICE(c);let d=i.remoteSDP.toString(),l=i.logSDPExchange(s.sdp||"","offer","local","restartICE");i.store.descriptionStart(),yield Lt(i.peerConnection.setLocalDescription(s)),l?.(d),yield Lt(i.peerConnection.setRemoteDescription({type:"answer",sdp:d}))}catch(r){_.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),r)}finally{n()}})()}extendCandidate(){return I(this,null,function*(){if(!this.remoteSDP||this.isFirstConnected)return;let e=yield this.mutex.lock("From P2PConnection.extendCandidate");try{this.remoteSDP.updateCandidates(oi.TCP_RELAY),yield kd(this.peerConnection,this.remoteSDP,this.extension)}catch(i){_.warning("[".concat(this.store.clientId,"] extend candidate failed, abort operation"),i)}finally{e()}})}close(){var e;this.peerConnection.getTransceivers().forEach(i=>{ip(this.id+i.mid,this)}),this.preSSRCMap.clear(),this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.transportEventReceiver=void 0,this.statsFilter.destroy(),this.dataStreamChannelMap.clear(),this.recoveredDataChannelIds=[],this.currentDataChannelId=1}getStats(){return ar(ar({},this.statsFilter.getStats()),{},{qualityLimitationReason:this.qualityLimitationReason})}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}updateEncoderConfig(e,i){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let n=yield this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[i],[e]);this.remoteSDP.updateRecvMedia(e,i);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");yield this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s?.(o),yield this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new F(C.EXCHANGE_SDP_FAILED,n.toString())}})}updateSendParameters(e,i){return I(this,null,function*(){let n=this.peerConnection.getTransceivers().filter(r=>r.mid===e);n.length===1&&(this.isVP8Simulcast(i)?_e()||(yield this.applySimulcastEncodings(n,[i])):yield this.applySendEncodings(n,[i]))})}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}replaceTrack(e,i){return I(this,null,function*(){let n=this.peerConnection.getTransceivers().find(r=>r.mid===i);n&&(yield n.sender.replaceTrack(e._mediaStreamTrack))})}getSelectedCandidatePair(){return I(this,null,function*(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let i=e[0].transport.iceTransport,{local:n,remote:r}=i.getSelectedCandidatePair();return{local:ar(ar({},yr),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:ar(ar({},yr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.isFirstConnected=!0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidateerror=e=>{if(e&&(e.errorCode||e.errorText)){var i;let n="code: ".concat(e.errorCode,", message: ").concat(e.errorText),r=e.port?"local: ".concat(e.port):"";_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICECandidateError(").concat(n,"), url: ").concat(e.url||"",", host_candidate:").concat(r)),(i=this.onICECandidateError)===null||i===void 0||i.call(this,n)}},this.peerConnection.onicegatheringstatechange=e=>{e&&e.target&&"iceGatheringState"in e.target&&_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] RTCPeerConnection.onicegatheringstatechange(").concat(e.target.iceGatheringState,")"))},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},A("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let i={iceServers:[]};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&(gd(e.turnServer.servers)?i.iceServers=e.turnServer.servers:A("NEW_TURN_MODE")&&i.iceServers?(A("USE_TURN_SERVER_OF_GATEWAY")?e.turnServer.serversFromGateway&&i.iceServers.push(...$s.newTurnServerConfigToIceServers(e.turnServer.serversFromGateway)):i.iceServers.push(...$s.newTurnServerConfigToIceServers(e.turnServer.servers)),A("NEW_FORCE_TURN")&&(i.iceTransportPolicy="relay")):e.turnServer.mode!=="off"&&(i.iceServers&&i.iceServers.push(...$s.turnServerConfigToIceServers(e.turnServer.servers)),A("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...$s.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),A("FORCE_TURN_TCP")?i.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(i.iceTransportPolicy="relay")}))),A("ENABLE_ENCODED_TRANSFORM")&&Mt().supportWebRTCEncodedTransform&&(i.encodedInsertableStreams=!0),i}static turnServerConfigToIceServers(e){let i=[];return e.forEach(n=>{n.security?n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(Bo(n.turnServerURL),":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&!A("FORCE_TURN_TCP")&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),i}static newTurnServerConfigToIceServers(e){let i=[];return e.forEach(n=>{let r=A("NEW_TURN_MODE");r===1?i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=udp")}):r===2?i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=tcp")}):r===3?i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(Bo(n.turnServerURL),":443?transport=tcp")}):r===4&&(i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=udp")}),i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":3478?transport=tcp")}),i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(Bo(n.turnServerURL),":443?transport=tcp")}))}),i}tryBindTransportEvents(e){let i=e.transport;if(i){this.transportEventReceiver=e,i.onstatechange=()=>{var r;i!=null&&i.state&&((r=this.onDTLSTransportStateChange)===null||r===void 0||r.call(this,i.state))},i.onerror=r=>{var o;(o=this.onDTLSTransportError)===null||o===void 0||o.call(this,"error"in r?r.error:r)};let n=i.iceTransport;n&&(n.onstatechange=()=>{let r=i?.iceTransport.state;var o;r&&((o=this.onICETransportStateChange)===null||o===void 0||o.call(this,r))},n.getSelectedCandidatePair&&(n.onselectedcandidatepairchange=()=>{if(n.getSelectedCandidatePair()){let{local:r,remote:o}=n.getSelectedCandidatePair();_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol}),", remote ").concat(JSON.stringify({candidateType:o.type,protocol:o.protocol,address:o.address,port:o.port})," )"))}}))}}tryUnbindTransportEvents(){this.transportEventReceiver&&this.transportEventReceiver.transport&&(this.transportEventReceiver.transport.onstatechange=null,this.transportEventReceiver.transport.onerror=null,this.transportEventReceiver.transport.iceTransport&&(this.transportEventReceiver.transport.iceTransport.onstatechange=null))}updateRtpSenderEncodings(e,i){return I(this,null,function*(){var n,r;if(i||(i=this.peerConnection.getSenders().find(f=>f.track===e._mediaStreamTrack)),!i)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Mt().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let o={},s={};switch(e._optimizationMode){case"motion":o.degradationPreference="maintain-framerate";break;case"detail":o.degradationPreference="maintain-resolution";break;case"balanced":o.degradationPreference="balanced"}let a=function(E,f){return E.getTransceivers().find(R=>R.sender.track===f||R.receiver.track===f)}(this.peerConnection,e._mediaStreamTrack),c=FK(e);if($6(e)&&a&&i&&c&&this.getLocalVideoStats&&z(n=["vp8","vp9"]).call(n,this.store.codec)){var d;let E=o.degradationPreference||(z(d=e._hints).call(d,Jt.CUSTOM_TRACK)?A("CUSTOM_ADAPTATION_DEFAULT_MODE"):"maintain-framerate");(function(f,R,y,N,k,L){if(ip(f,y),k(R),N!=="balanced"&&N!=="maintain-framerate"&&N!=="maintain-resolution")return;let P=-1;IN(f,R);let V=window.setInterval(()=>{let Y=ep.get(f);if(!A("ENABLE_AG_ADAPTATION")||!Y)return ip(f,y),void k(R);let J=L();if(J.sendPackets>0&&J.OutgoingAvailableBandwidth>0){if(P===-1)return void(P=Date.now());if(Date.now()-P<1e3)return;let yt=J.sendFrameRate,Rt=J.OutgoingAvailableBandwidth,[_t,ne]=Z6(f,yt,Rt,Y.adaptationConfig,R,N);ne&&(y.qualityLimitationReason=ne),_t&&Y.adaptationConfig.scale!==_t.scale&&(_.debug("[".concat(f,"] applyAdaptation: ").concat(y.qualityLimitationReason,`
           sendFps `).concat(yt,", bwe ").concat(Rt,", switch from ").concat(Y.adaptationConfig.scale," to ").concat(_t.scale," ")),Y.adaptationConfig=Og(Og({},Y.adaptationConfig),_t),k(_t))}},A("CHECK_LOCAL_STATS_INTERVAL")),B=Og({},R);ep.set(f,{timer:V,adaptationConfig:B,originConfig:R,adaptationFunc:k}),_.debug("[".concat(f,"] start adaptation, originConfig: ").concat(JSON.stringify(R),", degradationPreference: ").concat(N))})(this.id+a.mid,c,this,E,f=>{i&&this.updateAdaptation(i,f)},this.getLocalVideoStats.bind(this))}if(e._encoderConfig){var l;let{bitrateMax:E,frameRate:f,scaleResolutionDownBy:R}=e._encoderConfig;E&&(s.maxBitrate=1e3*E),(z(l=e._hints).call(l,Jt.LOW_STREAM)||e.isUseScaleResolutionDownBy)&&(f&&(s.maxFramerate=Hi(f)),R&&R>=1&&(s.scaleResolutionDownBy=R))}let{maxFramerate:u}=A("ENCODER_CONFIG_LIMIT");if(u&&typeof u=="number"&&(s.maxFramerate=s.maxFramerate?Math.min(s.maxFramerate,u):u),A("DSCP_TYPE")&&Qr()){var h;let E=A("DSCP_TYPE");z(h=["very-low","low","medium","high"]).call(h,E)&&(s.networkPriority=E)}let p=i.getParameters(),g=(r=p.encodings)===null||r===void 0?void 0:r[0];_e()&&!g&&(o.encodings=[s]),g&&Object.assign(g,s),Object.assign(p,o),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(p.encodings))),yield i.setParameters(p),yield function(E,f,R){return I(this,null,function*(){try{var y;if(!Mt().supportSetRtpSenderParameters||!function(V){return V==="vp9"||V==="av1"}(E)||!A("ENABLE_SVC"))return;let N={},k={},L=f.getParameters(),P=(y=L.encodings)===null||y===void 0?void 0:y[0];k.scalabilityMode=Kh(R),P&&Object.assign(P,k),Object.assign(L,N),yield f.setParameters(L),_.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode success: ".concat(JSON.stringify(L.encodings)))}catch(N){_.debug("[updateAdaptation] updateRtpSenderEncodings scalabilityMode failed",N)}})}(this.store.codec,i,A("SVC_MODE"))})}updateAdaptation(e,i){return I(this,null,function*(){var n,r;if(!e)return _.debug("[updateAdaptation] no rtpSender found");if(!Mt().supportSetRtpSenderParameters)return _.debug("[updateAdaptation] Browser not support set rtp-sender parameters");let o={},{bitrateMax:s,frameRate:a,scaleResolutionDownBy:c}=i;s&&(o.maxBitrate=1e3*s),a&&(o.maxFramerate=Hi(a)),c&&c>=1&&z(n=["vp8","vp9"]).call(n,this.store.codec)&&(o.scaleResolutionDownBy=c);let d=e.getParameters(),l=(r=d.encodings)===null||r===void 0?void 0:r[0];l&&Object.assign(l,o),Object.assign(d,{});try{yield e.setParameters(d),_.debug("[updateAdaptation] updateRtpSenderEncodings: ".concat(JSON.stringify(d.encodings)))}catch(u){!("transport"in e)||e.transport&&e.transport.state==="connected"?this.peerConnectionState!=="connected"?_.debug("[updateAdaptation] peerConnection not connected}"):_.debug("[updateAdaptation] updateRtpSenderEncodings failed",u):_.debug("[updateAdaptation] rtpSender transport not connected}")}})}applySendEncodings(e,i){return I(this,null,function*(){try{if(!Mt().supportSetRtpSenderParameters||e.length!==i.length)return;for(let n=0;n<e.length;n++){let r=e[n],o=i[n];o instanceof re&&!this.isVP8Simulcast(o)&&(yield this.updateRtpSenderEncodings(o,r.sender))}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}})}mungSendOfferSDP(e,i,n){let r=Li(e);return i.forEach((o,s)=>{let a=n[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(ic(c,o),zO(c,o,this.store.codec))}),xo(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,i,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}applySimulcastForFirefox(e,i){return I(this,null,function*(){if(e.length===i.length)for(let c=0;c<e.length;c++){var n,r,o,s,a;let d=e[c],l=i[c];if(l instanceof re&&!z(n=l._hints).call(n,Jt.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];let p=d.sender.getParameters();yield d.sender.setParameters(Object.assign(p,u))}}})}applySimulcastEncodings(e,i){return I(this,null,function*(){if(!_e()&&e.length===i.length)for(let n=0;n<e.length;n++){let r=i[n];if(r instanceof re&&this.isVP8Simulcast(r)){let o=e[n],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();yield o.sender.setParameters(Object.assign(c,s))}}})}isVP8Simulcast(e){var i,n,r,o,s;return!!(e instanceof re&&A("SIMULCAST")&&this.store.codec==="vp8"&&!z(i=e._hints).call(i,Jt.LOW_STREAM)&&(n=e._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,i,n,r){if(A("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(r,`
`),e),i==="offer"?o=>{this.logSDPExchange(o,"answer",n==="local"?"remote":"local",r)}:void 0}getRemoteSSRC(e){return I(this,null,function*(){if(!this.remoteSDP)return;let i=this.remoteSDP.getSSRC(e);return i&&i.length!==0?i[0].ssrcId:void 0})}setConfiguration(e){if(Mt().supportPCSetConfiguration){let i=$s.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}},rt(Dt.prototype,"updateRemoteRTPCapabilities",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"updateRemoteRTPCapabilities"),Dt.prototype),rt(Dt.prototype,"connect",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"connect"),Dt.prototype),rt(Dt.prototype,"updateRemoteConnect",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"updateRemoteConnect"),Dt.prototype),rt(Dt.prototype,"createDataChannels",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"createDataChannels"),Dt.prototype),rt(Dt.prototype,"receive",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"receive"),Dt.prototype),rt(Dt.prototype,"batchReceive",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"batchReceive"),Dt.prototype),rt(Dt.prototype,"stopReceiving",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"stopReceiving"),Dt.prototype),rt(Dt.prototype,"muteRemote",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"muteRemote"),Dt.prototype),rt(Dt.prototype,"unmuteRemote",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"unmuteRemote"),Dt.prototype),rt(Dt.prototype,"muteLocal",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"muteLocal"),Dt.prototype),rt(Dt.prototype,"unmuteLocal",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"unmuteLocal"),Dt.prototype),rt(Dt.prototype,"close",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"close"),Dt.prototype),rt(Dt.prototype,"updateEncoderConfig",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"updateEncoderConfig"),Dt.prototype),rt(Dt.prototype,"updateSendParameters",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"updateSendParameters"),Dt.prototype),rt(Dt.prototype,"replaceTrack",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"replaceTrack"),Dt.prototype),rt(Dt.prototype,"updateAdaptation",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"updateAdaptation"),Dt.prototype),rt(Dt.prototype,"getRemoteSSRC",[Ai],Object.getOwnPropertyDescriptor(Dt.prototype,"getRemoteSSRC"),Dt.prototype),Dt);function Ai(t,e,i){let n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=function(){return I(this,arguments,function*(){let r=this.mutex,o=yield r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return yield n.apply(this,a)}finally{o()}})},i}function Lg(t,e){let i=document.createElement("video"),n=document.createElement("canvas");i.setAttribute("style","display:none"),n.setAttribute("style","display:none"),i.setAttribute("muted",""),i.muted=!0,i.setAttribute("autoplay",""),i.autoplay=!0,i.setAttribute("playsinline",""),n.width=Hi(e.width),n.height=Hi(e.height);let r=Hi(e.framerate||15);document.body.append(i),document.body.append(n);let o=t._mediaStreamTrack;i.srcObject=new MediaStream([o]),i.play();let s=n.getContext("2d");if(!s)throw new x(C.UNEXPECTED_ERROR,"can not get canvas context");let a=Mt(),c=n.captureStream(a.supportRequestFrame?0:r).getVideoTracks()[0];c.canvas||(c.canvas=n),n.startCapture=()=>{if(!i)return n.stopCapture&&n.stopCapture();if(i.paused&&i.play(),i.videoHeight>2&&i.videoWidth>2){let l=i.videoWidth,u=i.videoHeight/l,h=n.width*u;Math.abs(h-n.height)>=2&&(_.debug("adjust low stream resolution","".concat(n.width,"x").concat(n.height," -> ").concat(n.width,"x").concat(h)),n.height=h)}s.drawImage(i,0,0,n.width,n.height),c.requestFrame&&c.requestFrame(),o!==t._mediaStreamTrack&&(o=t._mediaStreamTrack,i.srcObject=new MediaStream([o]))},n.stopCapture=Wf(()=>n.startCapture&&n.startCapture(),r);let d=c.stop;return c.stop=()=>{d.call(c),i&&(i.remove(),i.srcObject=null,i=null),n&&(n.width=0,n.remove(),n.stopCapture&&n.stopCapture(),n.startCapture=void 0,n.stopCapture=void 0,n=null),_.debug("clean low stream renderer")},c}var Bn=function(t){return t[t.Video_Send_Qp_Sum=2143]="Video_Send_Qp_Sum",t[t.Video_Send_Freeze=2082]="Video_Send_Freeze",t[t.Video_Recv_Qp_Sum=2144]="Video_Recv_Qp_Sum",t[t.Video_Recv_Freeze=2084]="Video_Recv_Freeze",t[t.Video_Render_Freeze_Time=2109]="Video_Render_Freeze_Time",t[t.Video_Render_Freeze_Time_Render=2147]="Video_Render_Freeze_Time_Render",t[t.Video_Render_Freeze_Time_Render2=2223]="Video_Render_Freeze_Time_Render2",t[t.Audio_Recv_Freeze=2083]="Audio_Recv_Freeze",t[t.Video_Send_Type=2225]="Video_Send_Type",t}(Bn||{}),gt=function(t){return t[t.Video_Send_Retransmit=2062]="Video_Send_Retransmit",t[t.Video_Send_Target_Encoded=2064]="Video_Send_Target_Encoded",t[t.Video_Send_Actual_Encoded=2060]="Video_Send_Actual_Encoded",t[t.Video_Send_Transmit=2066]="Video_Send_Transmit",t[t.Video_Send_Bandwidth=2061]="Video_Send_Bandwidth",t[t.Video_Capture_Height=2033]="Video_Capture_Height",t[t.Video_Capture_Width=2035]="Video_Capture_Width",t[t.Video_Capture_Frame_Rate=2034]="Video_Capture_Frame_Rate",t[t.Video_Send_Low_Height=2073]="Video_Send_Low_Height",t[t.Video_Send_Low_Frame_Rate=2075]="Video_Send_Low_Frame_Rate",t[t.Video_Send_Low_Width=2077]="Video_Send_Low_Width",t[t.Video_Send_Low_Bitrate=2069]="Video_Send_Low_Bitrate",t[t.Video_Send_Low_Package_Lost=2070]="Video_Send_Low_Package_Lost",t[t.Video_Send_Low_Package_Rate=2071]="Video_Send_Low_Package_Rate",t[t.Video_Send_Frame_Rate=2002]="Video_Send_Frame_Rate",t[t.Video_Send_Width=2003]="Video_Send_Width",t[t.Video_Send_Height=2004]="Video_Send_Height",t[t.Video_Send_Disabled=2095]="Video_Send_Disabled",t[t.Video_Send_Adaptation=2032]="Video_Send_Adaptation",t[t.Video_Send_Player_Status=2128]="Video_Send_Player_Status",t[t.Video_Send_Nacks=2009]="Video_Send_Nacks",t[t.Video_Send_Plis=2010]="Video_Send_Plis",t[t.Video_Send_Firs=2011]="Video_Send_Firs",t[t.Video_Send_Avg_Encode=2007]="Video_Send_Avg_Encode",t[t.Video_Send_Huge_Frame_Sent=2174]="Video_Send_Huge_Frame_Sent",t[t.Video_Send_Bytes_Retransmit=2173]="Video_Send_Bytes_Retransmit",t[t.Video_Send_Packages_Retransmit=2172]="Video_Send_Packages_Retransmit",t[t.Video_Send_Key_Frames_Encoded=2207]="Video_Send_Key_Frames_Encoded",t[t.Video_Send_Bitrate=2012]="Video_Send_Bitrate",t[t.Video_Send_Package_Rate=2031]="Video_Send_Package_Rate",t[t.Video_Send_Package_Lost=2005]="Video_Send_Package_Lost",t[t.Audio_Capture_PCM_Level=2104]="Audio_Capture_PCM_Level",t[t.Audio_Send_Level=2038]="Audio_Send_Level",t[t.Audio_Send_Bitrate=2039]="Audio_Send_Bitrate",t[t.Audio_Send_Package_Rate=2040]="Audio_Send_Package_Rate",t[t.Audio_Send_AEC_Return_Loss=2041]="Audio_Send_AEC_Return_Loss",t[t.Audio_Send_AEC_Return_Loss_Enhancement=2042]="Audio_Send_AEC_Return_Loss_Enhancement",t[t.Audio_Send_Freeze=2081]="Audio_Send_Freeze",t[t.Audio_Send_Disabled=2096]="Audio_Send_Disabled",t[t.Audio_Send_Bytes_Retransmit=2179]="Audio_Send_Bytes_Retransmit",t[t.Audio_Send_Packages_Retransmit=2180]="Audio_Send_Packages_Retransmit",t[t.Video_Recv_Height=2019]="Video_Recv_Height",t[t.Video_Recv_Width=2018]="Video_Recv_Width",t[t.Video_Recv_Frame_Rate_Output=2155]="Video_Recv_Frame_Rate_Output",t[t.Video_Recv_Jitter_Buffer=2023]="Video_Recv_Jitter_Buffer",t[t.Video_Recv_Current_Delay=2024]="Video_Recv_Current_Delay",t[t.Video_Recv_Nacks=2026]="Video_Recv_Nacks",t[t.Video_Recv_Plis=2027]="Video_Recv_Plis",t[t.Video_Recv_Firs=2028]="Video_Recv_Firs",t[t.Video_Recv_Disabled=2101]="Video_Recv_Disabled",t[t.Video_Recv_Player_Status=2129]="Video_Recv_Player_Status",t[t.Video_Recv_I_Frame_Delay=2149]="Video_Recv_I_Frame_Delay",t[t.Video_Render_Frame_Rate_Render=2022]="Video_Render_Frame_Rate_Render",t[t.Video_Render_Freeze_Duration=2156]="Video_Render_Freeze_Duration",t[t.Audio_Render_Level=2043]="Audio_Render_Level",t[t.Audio_Render_Freeze_Time_80ms=2226]="Audio_Render_Freeze_Time_80ms",t[t.Audio_Render_Freeze_Time_200ms=2227]="Audio_Render_Freeze_Time_200ms",t[t.Audio_Render_Freeze_Samples_80ms=2228]="Audio_Render_Freeze_Samples_80ms",t[t.Audio_Render_Freeze_Samples_200ms=2229]="Audio_Render_Freeze_Samples_200ms",t[t.Audio_Recv_PCM_Level=2105]="Audio_Recv_PCM_Level",t[t.Audio_Recv_Disabled=2102]="Audio_Recv_Disabled",t[t.Audio_Recv_Jitter_Buffer=2054]="Audio_Recv_Jitter_Buffer",t[t.Audio_Recv_Current_Delay=2047]="Audio_Recv_Current_Delay",t[t.Audio_Recv_Player_Status=2130]="Audio_Recv_Player_Status",t[t.Audio_Recv_Bitrate=2044]="Audio_Recv_Bitrate",t[t.Audio_Recv_Concealed_Samples=2148]="Audio_Recv_Concealed_Samples",t[t.Audio_Recv_Total_Samples_Received=2224]="Audio_Recv_Total_Samples_Received",t}(gt||{}),Xe=function(t){return t[t.Video_Render_Frame_Rate_Decode=2021]="Video_Render_Frame_Rate_Decode",t[t.Video_Recv_Frame_Rate=2020]="Video_Recv_Frame_Rate",t[t.Video_Recv_Frame_Dropped=2181]="Video_Recv_Frame_Dropped",t[t.Video_Recv_Bytes_Retransmit=2175]="Video_Recv_Bytes_Retransmit",t[t.Video_Recv_Packages_Retransmit=2176]="Video_Recv_Packages_Retransmit",t[t.Video_Recv_Packages_Discarded=2198]="Video_Recv_Packages_Discarded",t[t.Video_Recv_Avg_Decode=2200]="Video_Recv_Avg_Decode",t[t.Video_Recv_Avg_Processing_Delay=2202]="Video_Recv_Avg_Processing_Delay",t[t.Video_Recv_Avg_Assembly_Time=2203]="Video_Recv_Avg_Assembly_Time",t[t.Video_Recv_Avg_Inter_Frame_Delay=2204]="Video_Recv_Avg_Inter_Frame_Delay",t[t.Video_Recv_Key_Frames_Decoded=2206]="Video_Recv_Key_Frames_Decoded",t[t.Video_Recv_Package_Lost=2014]="Video_Recv_Package_Lost",t[t.Video_Recv_Bitrate=2029]="Video_Recv_Bitrate",t[t.Video_Recv_Package_Rate=2078]="Video_Recv_Package_Rate",t[t.Audio_Recv_Jitter=2055]="Audio_Recv_Jitter",t[t.Audio_Recv_Bytes_Retransmit=2178]="Audio_Recv_Bytes_Retransmit",t[t.Audio_Recv_Packages_Retransmit=2177]="Audio_Recv_Packages_Retransmit",t[t.Audio_Recv_Packages_Discarded=2199]="Audio_Recv_Packages_Discarded",t[t.Audio_Recv_Avg_Processing_Delay=2201]="Audio_Recv_Avg_Processing_Delay",t[t.Audio_Recv_Package_Rate=2046]="Audio_Recv_Package_Rate",t[t.Audio_Recv_Package_Lost=2045]="Audio_Recv_Package_Lost",t}(Xe||{}),wi=function(t){return t[t.RTT=2006]="RTT",t[t.CONN_TYPE=801]="CONN_TYPE",t[t.STATS_UPDATE_INTERVAL=2205]="STATS_UPDATE_INTERVAL",t}(wi||{}),rp=function(t){return t[t.RTC_PEER_CONNECTION_STATE=2219]="RTC_PEER_CONNECTION_STATE",t}(rp||{});let Ps=1e3,op=6,Fd=3,iq=Math.max(op,Fd);function lt(t,e,i){i!=null&&Number.isFinite(i)&&(t[e]=Math.round(Math.max(0,i)))}function DN(t){let e={[wi.CONN_TYPE]:0,[wi.RTT]:t.rtt,[wi.STATS_UPDATE_INTERVAL]:t.updateInterval?Math.round(Math.max(0,t.updateInterval)):void 0};switch(t.selectedCandidatePair.localCandidate.candidateType){case"relay":{let i=t.selectedCandidatePair.localCandidate.relayProtocol;i==="udp"&&(e[wi.CONN_TYPE]=1),i==="tcp"&&(e[wi.CONN_TYPE]=3),i==="tls"&&(e[wi.CONN_TYPE]=4);break}case"srflx":e[wi.CONN_TYPE]=2;break;case"unknown":e[wi.CONN_TYPE]=5;break;default:e[wi.CONN_TYPE]=0}return e}function PN(t){let e=0;switch(t){case"none":e=0;break;case"cpu":e=1;break;case"bandwidth":e=2;break;case"other":e=3}return e}class LN extends ue{constructor(e){super(),T(this,"store",void 0),T(this,"uploadWRTCStatsTimer",void 0),T(this,"uploadOutboundDenoiserStatsTimer",void 0),T(this,"uploadExtStatsTimer",void 0),T(this,"uploadExtUsageStatsTimer",void 0),T(this,"uploadInboundExtStatsTimer",void 0),T(this,"requestStats",void 0),T(this,"requestTransportStats",void 0),T(this,"requestLocalMedia",void 0),T(this,"requestRemoteMedia",void 0),T(this,"requestAllTracks",void 0),T(this,"requestVideoIsReady",void 0),T(this,"requestUploadStats",void 0),T(this,"requestUpload",void 0),T(this,"uploadOutboundStarted",!1),T(this,"uploadInboundStarted",!1),T(this,"uploadTransportStarted",!1),T(this,"uploadBaseStatsStarted",!1),T(this,"uploadExtensionUsageStarted",!1),T(this,"lastRecvStats",void 0),T(this,"lastSendStats",void 0),T(this,"lastRefRecvStats",void 0),T(this,"lastRefSendStats",void 0),T(this,"lastNormalRecvStats",void 0),T(this,"lastNormalSendStats",void 0),T(this,"needUploadRenderFreezeTime",!0),T(this,"lastUploadCompensateTime",-1),T(this,"uploadCompensateDeltaTime",0),this.store=e}uploadWRTCStats(e){if(!this.requestStats||!this.requestUploadStats)return;let i=e%Fd==0,n=e%op==0,r,o;if(this.uploadTransportStarted&&(r=this.requestStats(),this.store.useP2P&&(o=this.requestStats(!0))),!r&&this.uploadOutboundStarted&&(r=this.requestStats()),!o&&this.uploadInboundStarted&&(o=this.requestStats(!0)),r||o){var s;let a={};if(this.uploadTransportStarted&&r){let d=this.getTransportStats(r,o,i);d&&(a.misc=[d])}if(this.uploadOutboundStarted&&r){let d=this.getOutboundStats(r,n?this.lastNormalSendStats:void 0,i?this.lastRefSendStats:void 0,this.lastSendStats);d&&(a.outbound=[d])}if(this.uploadInboundStarted&&o){this.uploadCompensateStats(e);let d=this.getInboundStats(o,n?this.lastNormalRecvStats:void 0,i?this.lastRefRecvStats:void 0,this.lastRecvStats);d&&(a.inbound=d)}let c=(s=this.requestTransportStats)===null||s===void 0?void 0:s.call(this).connectState;c&&(Array.isArray(a.misc)?a.misc[0]&&a.misc[0].addition&&(a.misc[0].addition[rp.RTC_PEER_CONNECTION_STATE]=wf[c]):a.misc=[{addition:{[rp.RTC_PEER_CONNECTION_STATE]:wf[c]}}]),this.requestUploadStats(a)}this.lastRecvStats=o,this.lastSendStats=r,n&&(this.lastNormalRecvStats=o,this.lastNormalSendStats=r),i&&(this.lastRefRecvStats=o,this.lastRefSendStats=r)}startUploadWRTCStats(){if(this.uploadWRTCStatsTimer)return;this.uploadBaseStatsStarted=!0;let e=1;this.uploadWRTCStatsTimer=window.setInterval(()=>{if(!this.uploadTransportStarted&&!this.uploadInboundStarted&&!this.uploadOutboundStarted){if(this.uploadBaseStatsStarted){var i,n;let r=(i=this.requestTransportStats)===null||i===void 0?void 0:i.call(this);return void(r&&((n=this.requestUploadStats)===null||n===void 0||n.call(this,{misc:[{addition:{[rp.RTC_PEER_CONNECTION_STATE]:wf[r.connectState]}}]})))}return this.stopUploadWRTCStats()}this.uploadWRTCStats(e),++e===iq+1&&(e=1)},Ps)}uploadCompensateStats(e){if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;let i=e%Fd==0&&this.needUploadRenderFreezeTime;if(!this.uploadInboundStarted||!i)return;if(this.lastUploadCompensateTime===-1)return void(this.lastUploadCompensateTime=Date.now());let n=Math.max(-6e3,Date.now()-this.lastUploadCompensateTime-6e3);if(this.uploadCompensateDeltaTime+=n,this.lastUploadCompensateTime=Date.now(),this.uploadCompensateDeltaTime<6e3)return;let r=Math.min(Math.floor(this.uploadCompensateDeltaTime/6e3),10);this.uploadCompensateDeltaTime-=6e3*r;let o=this.requestStats(!0);new Array(r).fill(0).forEach(()=>{if(!this.requestStats||!this.requestUploadStats||!this.requestRemoteMedia)return;let s={};if(this.uploadInboundStarted&&o){let a=this.requestRemoteMedia()||[],c=[];a.forEach(d=>{let[l,u]=d,h={peer:l.uid};if(l._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(l._videoSSRC)&&u.has($.VIDEO)&&l.videoTrack){let p=function(g,E,f){if(!E.videoRecv.find(y=>y.ssrc===g))return;let R={};if(f&&f._player){let y=f._player,{renderFreezeAccTime2:N,videoElementStatus:k}=y;if(Ir.visibility==="visible"&&k===di.PLAYING&&Mt().supportRequestVideoFrameCallback){let L=Math.min(6e3,N);y.renderFreezeAccTime2=Math.max(0,N-L),lt(R,Bn.Video_Render_Freeze_Time_Render2,L),A("USE_NEW_RENDER_FREEZE_TIME")&&lt(R,Bn.Video_Render_Freeze_Time_Render,L)}}return R}(l._videoSSRC,o,l.videoTrack);p&&(h.video=p)}h.video&&c.push(h)}),c.length>0&&(s.inbound=c,this.requestUploadStats(s))}})}stopUploadWRTCStats(){window.clearInterval(this.uploadWRTCStatsTimer),this.uploadWRTCStatsTimer=void 0,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0}getTransportStats(e,i,n){if(!this.requestStats)return;if(!n)return e.rtt==null?void 0:{addition:{[wi.RTT]:e.rtt,[wi.CONN_TYPE]:void 0,[wi.STATS_UPDATE_INTERVAL]:e.updateInterval||void 0}};let r=DN(e);if(this.store.useP2P){if(i){let o=DN(i);r[wi.CONN_TYPE]+=o[wi.CONN_TYPE]<<3}r[wi.CONN_TYPE]+=110}else r[wi.CONN_TYPE]+=100;return{addition:r}}getOutboundStats(e,i,n,r){if(!this.requestUploadStats||!this.requestLocalMedia)return;let o=this.requestLocalMedia();if(!o||o.length===0)return;let s,a,c;return o.forEach(d=>{let[l,{track:u,ssrcs:h}]=d;switch(l){case W.LocalVideoLowTrack:case W.LocalVideoTrack:if(l===W.LocalVideoTrack){let p=function(f,R,y,N,k,L){let P=R.videoSend.find(yt=>yt.ssrc===f);if(!P)return;let V={},{sentFrame:B,inputFrame:Y}=P;if(N&&(lt(V,Bn.Video_Send_Qp_Sum,P.qpSumPerFrame),Y&&B)){var J;let yt=Y.frameRate,Rt=B.frameRate;V[Bn.Video_Send_Freeze]=function(_t,ne){let Qt=!0;return Qt=!(_t<=5)&&(_t<=10?ne<3:_t<=20?ne<4:ne<5),Qt}(yt,Rt)?1:0,V[Bn.Video_Send_Type]=y.__className__==="CameraVideoTrack"?0:z(J=y._hints).call(J,Jt.SCREEN_TRACK)?1:2}if(k){switch(B&&(lt(V,gt.Video_Send_Height,B.height),lt(V,gt.Video_Send_Width,B.width),lt(V,gt.Video_Send_Frame_Rate,B.frameRate)),V[gt.Video_Send_Disabled]=y._originMediaStreamTrack&&!y._originMediaStreamTrack.enabled||y._mediaStreamTrack&&!y._mediaStreamTrack.enabled?1:0,P.adaptionChangeReason){case"none":V[gt.Video_Send_Adaptation]=0;break;case"cpu":V[gt.Video_Send_Adaptation]=1;break;case"bandwidth":V[gt.Video_Send_Adaptation]=2;break;case"other":V[gt.Video_Send_Adaptation]=3}let yt=0;P.adaptionChangeReason&&(yt+=PN(P.adaptionChangeReason)),R.qualityLimitationReason&&(yt+=PN(R.qualityLimitationReason)<<3),V[gt.Video_Send_Adaptation]=yt,V[gt.Video_Send_Player_Status]=jf[y._player?y._player.videoElementStatus:"uninit"],lt(V,gt.Video_Send_Nacks,P.nacksCount),lt(V,gt.Video_Send_Plis,P.plisCount),lt(V,gt.Video_Send_Firs,P.firsCount),lt(V,gt.Video_Send_Avg_Encode,P.avgEncodeMs),lt(V,gt.Video_Send_Huge_Frame_Sent,P.hugeFramesSent),lt(V,gt.Video_Send_Bytes_Retransmit,P.retransmittedBytesSent),lt(V,gt.Video_Send_Packages_Retransmit,P.retransmittedPacketsSent),lt(V,gt.Video_Send_Key_Frames_Encoded,P.keyFramesEncoded);let Rt=k.videoSend.find(_t=>_t.ssrc===f);if(Rt){let _t=Ps*Fd;Rt.timestamp&&P.timestamp&&(_t=P.timestamp-Rt.timestamp),Rt.packets!=null&&P.packets!=null&&lt(V,gt.Video_Send_Package_Rate,1e3*(P.packets-Rt.packets)/_t),P.packetsLost!=null&&Rt.packetsLost!=null&&lt(V,gt.Video_Send_Package_Lost,P.packetsLost-Rt.packetsLost),Rt.bytes!=null&&P.bytes!=null&&lt(V,gt.Video_Send_Bitrate,8*(P.bytes-Rt.bytes)/_t)}}return V}(h[0].ssrcId,e,u,i,n),g=u&&function(f,R,y,N){let k=R.videoSend.find(P=>P.ssrc===f);if(!k)return null;let L={};if(N){let P=k.inputFrame,V=P&&P.height||y.videoHeight||0,B=P&&P.width||y.videoWidth||0,Y=P&&P.frameRate||0;lt(L,gt.Video_Capture_Height,V),lt(L,gt.Video_Capture_Width,B),lt(L,gt.Video_Capture_Frame_Rate,Y)}return L}(h[0].ssrcId,e,u,!!n),E=function(f,R){let y={};return R&&(lt(y,gt.Video_Send_Retransmit,f.bitrate.retransmit),lt(y,gt.Video_Send_Target_Encoded,f.bitrate.targetEncoded),lt(y,gt.Video_Send_Actual_Encoded,f.bitrate.actualEncoded),lt(y,gt.Video_Send_Transmit,f.bitrate.transmit),lt(y,gt.Video_Send_Bandwidth,f.sendBandwidth)),y}(e,!!n);a=Object.assign({},p,g,E)}else c=function(p,g,E,f,R){let y=g.videoSend.find(k=>k.ssrc===p);if(!y)return;let N={};if(f){let k=y.sentFrame;k&&(lt(N,gt.Video_Send_Low_Height,k.height),lt(N,gt.Video_Send_Low_Width,k.width),lt(N,gt.Video_Send_Low_Frame_Rate,k.frameRate));let L=f.videoSend.find(P=>P.ssrc===p);if(L){let P=Ps*op;L.timestamp&&y.timestamp&&(P=y.timestamp-L.timestamp),L.packets!=null&&y.packets!=null&&lt(N,gt.Video_Send_Low_Package_Rate,1e3*(y.packets-L.packets)/P),y.packetsLost!=null&&L.packetsLost!=null&&lt(N,gt.Video_Send_Low_Package_Lost,y.packetsLost-L.packetsLost),L.bytes!=null&&y.bytes!=null&&lt(N,gt.Video_Send_Low_Bitrate,8*(y.bytes-L.bytes)/P)}}return N}(h[0].ssrcId,e,0,n);break;case W.LocalAudioTrack:s=u&&function(p,g,E,f,R,y){let N=g.audioSend.find(L=>L.ssrc===p);if(!N)return;let k={};if(R){k[gt.Audio_Send_Disabled]=E._originMediaStreamTrack&&!E._originMediaStreamTrack.enabled||E._mediaStreamTrack&&!E._mediaStreamTrack.enabled?1:0;let L=100*E._source.getAccurateVolumeLevel(),P=N.inputLevel;if(P!=null){let B=Math.ceil(50*Math.log10(100*P+1));lt(k,gt.Audio_Send_Level,B)}lt(k,gt.Audio_Capture_PCM_Level,L),lt(k,gt.Audio_Send_AEC_Return_Loss,N.aecReturnLoss),lt(k,gt.Audio_Send_AEC_Return_Loss_Enhancement,N.aecReturnLossEnhancement),lt(k,gt.Audio_Send_Bytes_Retransmit,N.retransmittedBytesSent),lt(k,gt.Audio_Send_Packages_Retransmit,N.retransmittedPacketsSent),k[gt.Audio_Send_Freeze]=0;let V=R.audioSend.find(B=>B.ssrc===p);if(V){let B=Ps*op;V.timestamp&&N.timestamp&&(B=N.timestamp-V.timestamp),V.bytes!=null&&N.bytes!=null&&lt(k,gt.Audio_Send_Bitrate,8*(N.bytes-V.bytes)/B),V.packets!=null&&N.packets!=null&&lt(k,gt.Audio_Send_Package_Rate,1e3*(N.packets-V.packets)/B)}}return k}(h[0].ssrcId,e,u,0,n)}}),{high:a,low:c,audio:s}}getInboundStats(e,i,n,r){if(!this.requestRemoteMedia)return;let o=this.requestRemoteMedia()||[],s=[];return o.forEach(a=>{let[c,d]=a,l={peer:c.uid};if(d.has($.VIDEO)&&c.videoTrack){let u=c._videoSSRC&&this.requestVideoIsReady&&this.requestVideoIsReady(c._videoSSRC)||!1,h=c.videoTrack?function(p,g,E,f,R,y,N,k){let L=g.videoRecv.find(_t=>_t.ssrc===p);if(!L)return;let P={},{receivedFrame:V,outputFrame:B,decodeFrameRate:Y}=L;lt(P,Xe.Video_Render_Frame_Rate_Decode,Y),L.framesRateFirefox&&lt(P,Xe.Video_Recv_Frame_Rate,L.framesRateFirefox),V&&lt(P,Xe.Video_Recv_Frame_Rate,V.frameRate),lt(P,Xe.Video_Recv_Frame_Dropped,L.framesDroppedCount),lt(P,Xe.Video_Recv_Bytes_Retransmit,L.retransmittedBytesReceived),lt(P,Xe.Video_Recv_Packages_Retransmit,L.retransmittedPacketsReceived),lt(P,Xe.Video_Recv_Packages_Discarded,L.packetsDiscarded),lt(P,Xe.Video_Recv_Avg_Decode,L.avgDecodeMs),lt(P,Xe.Video_Recv_Avg_Processing_Delay,L.avgProcessingDelayMs),lt(P,Xe.Video_Recv_Avg_Assembly_Time,L.avgFramesAssembledFromMultiplePacketsMs),lt(P,Xe.Video_Recv_Avg_Inter_Frame_Delay,L.avgInterFrameDelayMs),lt(P,Xe.Video_Recv_Key_Frames_Decoded,L.keyFramesDecoded);let J=k&&k.videoRecv.find(_t=>_t.ssrc===p);if(J){let _t=g.timestamp-k.timestamp||Ps;L.packetsLost!=null&&J.packetsLost!=null&&lt(P,Xe.Video_Recv_Package_Lost,L.packetsLost-J.packetsLost),J.bytes!=null&&L.bytes!=null&&lt(P,Xe.Video_Recv_Bitrate,8*(L.bytes-J.bytes)/_t),J.packets!=null&&L.packets!=null&&lt(P,Xe.Video_Recv_Package_Rate,1e3*(L.packets-J.packets)/_t)}let yt=y&&y.videoRecv.find(_t=>_t.ssrc===p);if(yt&&(lt(P,Bn.Video_Recv_Qp_Sum,L.qpSumPerFrame),P[Bn.Video_Recv_Freeze]=f&&xd.isRemoteVideoFreeze(E,L,yt)?1:0),N){var Rt;let _t=N.videoRecv.find(Qt=>Qt.ssrc===p);V?(lt(P,gt.Video_Recv_Height,V.height),lt(P,gt.Video_Recv_Width,V.width)):E&&(lt(P,gt.Video_Recv_Height,E._videoHeight||0),lt(P,gt.Video_Recv_Width,E._videoWidth||0)),B&&lt(P,gt.Video_Recv_Frame_Rate_Output,B.frameRate);let ne=(Rt=E._player)===null||Rt===void 0?void 0:Rt.rendFrameRate.toFixed(0);if(ne&&lt(P,gt.Video_Render_Frame_Rate_Render,+ne),lt(P,gt.Video_Recv_Jitter_Buffer,L.jitterBufferMs),lt(P,gt.Video_Recv_Current_Delay,L.currentDelayMs),lt(P,gt.Video_Recv_Firs,L.firsCount),lt(P,gt.Video_Recv_Nacks,L.nacksCount),lt(P,gt.Video_Recv_Plis,L.plisCount),E){P[gt.Video_Recv_Disabled]=E._originMediaStreamTrack.enabled&&E._mediaStreamTrack.enabled?0:1;let Qt=E._player;if(Qt){let{freezeTimeCounterList:Ni,renderFreezeAccTime:j,renderFreezeAccTime2:K,videoElementStatus:it}=Qt;if(Ni&&Ni.length>0&&lt(P,Bn.Video_Render_Freeze_Time,Ni.splice(0,1)[0]),R&&Ir.visibility==="visible"&&it===di.PLAYING&&Mt().supportRequestVideoFrameCallback){let G=Math.min(6e3,K);Qt.renderFreezeAccTime2=Math.max(0,K-G),lt(P,Bn.Video_Render_Freeze_Time_Render2,G);let m=Math.min(6e3,j);Qt.renderFreezeAccTime=Math.max(0,j-m),lt(P,Bn.Video_Render_Freeze_Time_Render,A("USE_NEW_RENDER_FREEZE_TIME")?G:m)}if(typeof L.totalFreezesDuration=="number"){let G=_t&&_t.totalFreezesDuration?L.totalFreezesDuration-_t.totalFreezesDuration:L.totalFreezesDuration;lt(P,gt.Video_Render_Freeze_Duration,1e3*G)}}}if(P[gt.Video_Recv_Player_Status]=jf[E._player?E._player.videoElementStatus:"uninit"],_t&&L.totalInterFrameDelay!==void 0&&L.totalSquaredInterFrameDelay!==void 0&&_t.totalInterFrameDelay!==void 0&&_t.totalSquaredInterFrameDelay!==void 0){let Qt=L.totalInterFrameDelay-_t.totalInterFrameDelay,Ni=L.totalSquaredInterFrameDelay-_t.totalSquaredInterFrameDelay,j=L.framesDecodeCount-_t.framesDecodeCount,K=Qt/j*1e3,it=Math.round(1e3*Math.sqrt((Ni-Math.pow(Qt,2)/j)/j));!isNaN(it)&&K+it>Math.max(3*K,K+150)&&(P[gt.Video_Recv_I_Frame_Delay]=it)}}return P}(c._videoSSRC,e,c.videoTrack,u===!0,this.needUploadRenderFreezeTime,i,n,r):void 0;h&&(l.video=h)}if(d.has($.AUDIO)&&c.audioTrack){let u=c.audioTrack?function(h,p,g,E,f,R){let y=p.audioRecv.find(P=>P.ssrc===h);if(!y)return;let N={};lt(N,Xe.Audio_Recv_Jitter,y.jitterMs),lt(N,Xe.Audio_Recv_Bytes_Retransmit,y.retransmittedBytesReceived),lt(N,Xe.Audio_Recv_Packages_Retransmit,y.retransmittedPacketsReceived),lt(N,Xe.Audio_Recv_Packages_Discarded,y.packetsDiscarded),lt(N,Xe.Audio_Recv_Avg_Processing_Delay,y.avgProcessingDelayMs);let k=R&&R.audioRecv.find(P=>P.ssrc===h);if(k){let P=Ps;y.packets!=null&&k.packets!=null&&lt(N,Xe.Audio_Recv_Package_Rate,1e3*(y.packets-k.packets)/P),y.packetsLost!=null&&k.packetsLost!=null&&lt(N,Xe.Audio_Recv_Package_Lost,y.packetsLost-k.packetsLost)}if(E){let{receivedFrames:P,droppedFrames:V}=y;P!=null&&V!=null&&(N[Bn.Audio_Recv_Freeze]=(L=P)===0||100*V/L>20?1:0)}var L;if(f){let P=100*g._source.getAccurateVolumeLevel(),V=y.outputLevel;if(V!=null){let Y=Math.ceil(50*Math.log10(100*V+1));lt(N,gt.Audio_Render_Level,Y)}lt(N,gt.Audio_Recv_PCM_Level,P),g&&(N[gt.Audio_Recv_Disabled]=g._originMediaStreamTrack.enabled&&g._mediaStreamTrack.enabled?0:1),lt(N,gt.Audio_Recv_Jitter_Buffer,y.jitterBufferMs),lt(N,gt.Audio_Recv_Current_Delay,y.jitterBufferMs),N[gt.Audio_Recv_Player_Status]=jf[Ii.getPlayerState(g.getTrackId())];let B=f.audioRecv.find(Y=>Y.ssrc===h);if(B){B.bytes!=null&&y.bytes!=null&&lt(N,gt.Audio_Recv_Bitrate,8*(y.bytes-B.bytes)/(Ps*Fd));let Y=y.concealedSamples-B.concealedSamples;Y>0&&lt(N,gt.Audio_Recv_Concealed_Samples,Y);let J=y.totalSamplesReceived-B.totalSamplesReceived;J>0&&lt(N,gt.Audio_Recv_Total_Samples_Received,J);let yt=y.freezeSamples80-B.freezeSamples80;yt>0&&lt(N,gt.Audio_Render_Freeze_Samples_80ms,yt);let Rt=y.freezeSamples200-B.freezeSamples200;Rt>0&&lt(N,gt.Audio_Render_Freeze_Samples_200ms,Rt);let _t=y.freezeMs80-B.freezeMs80;lt(N,gt.Audio_Render_Freeze_Time_80ms,_t<0?0:_t);let ne=y.freezeMs200-B.freezeMs200;lt(N,gt.Audio_Render_Freeze_Time_200ms,ne<0?0:ne)}}return N}(c._audioSSRC,e,c.audioTrack,i,n,r):void 0;u&&(l.audio=u)}(l.video||l.audio)&&s.push(l)}),this.needUploadRenderFreezeTime=!this.needUploadRenderFreezeTime,s}startUploadTransportStats(){this.uploadTransportStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats()}stopUploadTransportStats(){this.uploadTransportStarted=!1}startUploadOutboundStats(){this.uploadOutboundStarted||(this.uploadOutboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=window.setInterval(()=>{if(!this.requestAllTracks||!this.requestUpload)return;let e=(this.requestAllTracks()||[]).find(i=>i instanceof bd);if(e&&e._external.getDenoiserStats){let i=e._external.getDenoiserStats();i&&this.requestUpload(Ad.DENOISER_STATS,i)}},2e3),this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=window.setInterval(()=>{!this.requestAllTracks||!this.requestUpload||this.requestAllTracks().forEach(e=>{e.getProcessorStats().forEach(i=>{this.requestUpload&&this.requestUpload(i.type,i.stats)})})},2e3))}stopUploadOutboundStats(){this.uploadOutboundStarted&&(this.uploadOutboundStarted=!1,this.lastSendStats&&(this.lastSendStats.videoSend=[],this.lastSendStats.audioSend=[],this.lastSendStats=void 0),this.lastRefSendStats&&(this.lastRefSendStats.videoSend=[],this.lastRefSendStats.audioSend=[],this.lastRefSendStats=void 0),this.lastNormalSendStats&&(this.lastNormalSendStats.videoSend=[],this.lastNormalSendStats.audioSend=[],this.lastNormalSendStats=void 0),this.uploadOutboundDenoiserStatsTimer&&window.clearInterval(this.uploadOutboundDenoiserStatsTimer),this.uploadOutboundDenoiserStatsTimer=void 0,this.uploadExtStatsTimer&&window.clearInterval(this.uploadExtStatsTimer),this.uploadExtStatsTimer=void 0)}startUploadInboundStats(){this.uploadInboundStarted||(this.uploadInboundStarted=!0,this.uploadWRTCStatsTimer||this.startUploadWRTCStats(),this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=window.setInterval(()=>{!this.requestUpload||!this.requestRemoteMedia||(this.requestRemoteMedia()||[]).forEach(e=>{let[i,n]=e;n.has($.VIDEO)&&i.videoTrack&&i.videoTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)}),n.has($.AUDIO)&&i.audioTrack&&i.audioTrack.getProcessorStats().forEach(r=>{this.requestUpload&&this.requestUpload(r.type,r.stats)})})},2e3))}stopUploadInboundStats(){this.uploadInboundStarted&&(this.uploadInboundStarted=!1,this.lastRecvStats&&(this.lastRecvStats.videoRecv=[],this.lastRecvStats.audioRecv=[],this.lastRecvStats=void 0),this.lastRefRecvStats&&(this.lastRefRecvStats.videoRecv=[],this.lastRefRecvStats.audioRecv=[],this.lastRefRecvStats=void 0),this.lastNormalRecvStats&&(this.lastNormalRecvStats.videoRecv=[],this.lastNormalRecvStats.audioRecv=[],this.lastNormalRecvStats=void 0),this.lastUploadCompensateTime=-1,this.uploadCompensateDeltaTime=0,this.needUploadRenderFreezeTime=!0,this.uploadInboundExtStatsTimer&&window.clearInterval(this.uploadInboundExtStatsTimer),this.uploadInboundExtStatsTimer=void 0)}startUploadExtensionUsageStats(){if(this.uploadExtensionUsageStarted)return;this.uploadExtensionUsageStarted=!0,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer);let e=new Map;this.uploadExtUsageStatsTimer=window.setInterval(()=>I(this,null,function*(){let i=Date.now(),n={connectionInterval:A("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3,details:[],lts:i},r=[],o=this.requestAllTracks&&this.requestAllTracks()||[];for(let d of o)!d.muted&&d.enabled&&(r=r.concat(yield d.getProcessorUsage()));let s=this.requestRemoteMedia&&this.requestRemoteMedia()||[];for(let[d,l]of s)l.has($.VIDEO)&&d.videoTrack&&(r=r.concat(yield d.videoTrack.getProcessorUsage())),l.has($.AUDIO)&&d.audioTrack&&(r=r.concat(yield d.audioTrack.getProcessorUsage()));if(r.length===0)return;n.details=function(d,l){let u={};for(let{id:E,value:f,level:R,direction:y}of d){var h;let N=(h=l.get(E))!==null&&h!==void 0?h:0,k=f===2?N+A("EXTENSION_USAGE_UPLOAD_INTERVAL")/1e3:N;var p,g;l.set(E,k),u[E]?(f===2&&(u[E].value=f),R>u[E].level&&(u[E].level=R),y==="remote"&&(u[E].remoteUidCount+=1),u[E].totalTs=(p=l.get(E))!==null&&p!==void 0?p:0):u[E]={value:f,level:R,remoteUidCount:y==="local"?0:1,totalTs:(g=l.get(E))!==null&&g!==void 0?g:0}}return Object.keys(u).map(E=>{let{level:f,value:R,totalTs:y}=u[E];return{id:E,level:f,value:R,totalTs:y}})}(r,e);let a=Date.now(),c=a>i?a:i+1;this.requestUpload&&this.requestUpload(Ad.EXTENSION_USAGE_STATS,{usageStats:n,sendTs:c})}),A("EXTENSION_USAGE_UPLOAD_INTERVAL"))}stopUploadExtensionUsageStats(){this.uploadExtensionUsageStarted&&(this.uploadExtensionUsageStarted=!1,this.uploadExtUsageStatsTimer&&window.clearInterval(this.uploadExtUsageStatsTimer),this.uploadExtUsageStatsTimer=void 0)}stopUploadBaseStats(){this.uploadBaseStatsStarted=!1}}let nq=A("ICE_RESTART_INTERVAL"),sp=new Map,ac=new Map,Ko=[oi.UDP_TCP_RELAY,oi.TCP_RELAY,oi.RELAY],kg=A("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Mt().supportPCSetConfiguration;function kN(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1],i=sp.get(t.id);i&&(window.clearTimeout(i),sp.delete(t.id));let n=ac.get(t.id);e&&n&&n.index===Ko.length-1&&(_.debug("[".concat(t.id,"] reset ICE restart policy")),ac.delete(t.id))}function MN(t,e,i){if(sp.size===0&&ac.size===0&&(Array.isArray(A("RESTART_SEQUENCE"))&&A("RESTART_SEQUENCE").length>0&&!function(a,c){if(a.length!==c.length)return!1;for(let d=0;d<a.length;d+=1){let l=a[d];if(a.filter(u=>u===l).length!==c.filter(u=>u===l).length)return!1}return!0}(Ko,A("RESTART_SEQUENCE"))&&(Ko=A("RESTART_SEQUENCE").filter(a=>{var c;if(z(c=Object.values(oi)).call(c,a))return!0}),_.debug("use reconnection policy from config distribution, queues: ".concat(Ko.join(" => ")))),kg=A("JOIN_WITH_FALLBACK_MEDIA_PROXY_FORCE")&&Mt().supportPCSetConfiguration),Ko.length===0)return void i();let n,{index:r=0,type:o}=ac.get(t.id)||{};if(kg&&o===oi.RELAY)return void i();let s=o&&r>=Ko.length-1;if(kg)o=oi.RELAY;else{if(s)return void i();o?(r++,o=Ko[r]):(o=Ko[0],r=0)}_.debug("[".concat(t.id,"] choose ICE restart policy: ").concat(o,", index: ").concat(r)),e(o),ac.set(t.id,{index:r,type:o}),n=window.setTimeout(()=>MN(t,e,i),nq),sp.set(t.id,n)}var Ct;function UN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Pr(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?UN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):UN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}function xN(t){var e,i,n,r=2;for(typeof Symbol<"u"&&(i=tf,n=Symbol.iterator);r--;){if(i&&(e=t[i])!=null)return e.call(t);if(n&&(e=t[n])!=null)return new ap(e.call(t));i="@@asyncIterator",n="@@iterator"}throw new TypeError("Object is not async iterable")}function ap(t){function e(i){if(Object(i)!==i)return Q.reject(new TypeError(i+" is not an object."));var n=i.done;return Q.resolve(i.value).then(function(r){return{value:r,done:n}})}return ap=function(i){this.s=i,this.n=i.next},ap.prototype={s:null,n:null,next:function(){return e(this.n.apply(this.s,arguments))},return:function(i){var n=this.s.return;return n===void 0?Q.resolve({value:i,done:!0}):e(n.apply(this.s,arguments))},throw:function(i){var n=this.s.return;return n===void 0?Q.reject(i):e(n.apply(this.s,arguments))}},new ap(t)}let Bd=(Ct=class extends ue{get state(){return this._state}set state(t){let e=this._state;this._state=t,this.emit(at.StateChange,e,this._state)}constructor(t,e){super(),T(this,"isPlanB",void 0),T(this,"store",void 0),T(this,"statsUploader",void 0),T(this,"connection",void 0),T(this,"localTrackMap",new Map),T(this,"remoteUserMap",new Map),T(this,"localDataChannels",[]),T(this,"remoteDataChannelMap",new Map),T(this,"pendingLocalTracks",[]),T(this,"pendingRemoteTracks",[]),T(this,"pendingLocalDataChannels",[]),T(this,"pendingRemoteDataChannels",[]),T(this,"statsCollector",void 0),T(this,"shouldForwardP2PCreation",void 0),T(this,"iceFailedCount",0),T(this,"dtlsFailedCount",0),T(this,"mutex",void 0),T(this,"_state",Bt.Disconnected),T(this,"_pcStatsUploadType",A("NEW_ICE_RESTART")?io.FIRST_CONNECTION:io.OLD_FIRST_CONNECTION),T(this,"_isStartRestartIce",!1),T(this,"_restartTimer",void 0),T(this,"_isTryConnecting",!1),T(this,"_iceError",null),T(this,"_forceTurn",!1),T(this,"_isWaitPcToRePub",!1),T(this,"handleMuteLocalTrack",(i,n,r)=>I(this,null,function*(){let o=yield this.mutex.lock("Locking from P2PChannel.handleMuteLocalTrack");try{if(!this.connection||this.state!==Bt.Connected)return void r(new F(C.INVALID_OPERATION,"Cannot call P2PChannel.handleMuteLocalTrack before connection established."));let s=this.filterTobeMutedTracks(i);if(s.length===0)return void n();let a=s.find(d=>d[0]==="videoLowTrack");a&&a[1].track._originMediaStreamTrack.stop(),yield this.connection.muteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let c=this.createMuteMessage(s);yield Zt(this,at.RequestMuteLocal,c),n()}catch(s){r(s)}finally{o()}})),T(this,"handleUnmuteLocalTrack",(i,n,r)=>I(this,null,function*(){let o=yield this.mutex.lock("Locking from P2PChannel.handleUnmuteLocalTrack");try{if(!this.connection||this.state!==Bt.Connected)return void r(new F(C.INVALID_OPERATION,"Cannot call P2PChannel.handleUnmuteLocalTrack before connection established."));let s=this.filterTobeUnmutedTracks(i);if(s.length===0)return void n();let a=s.find(d=>d[0]==="videoLowTrack");if(a){let d=a[1];if(d.track._originMediaStreamTrack.stop(),!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding){let l=i._mediaStreamTrack.clone();d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}else{let l=Lg(i,Sd(this,at.RequestLowStreamParameter));d.track._mediaStreamTrack=l,d.track._originMediaStreamTrack=l}yield new Q((l,u)=>{this.handleReplaceTrack(d.track,l,u,!0)})}yield this.connection.unmuteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let c=this.createUnmuteMessage(s);yield Zt(this,at.RequestUnmuteLocal,c),n()}catch(s){r(s)}finally{o()}})),T(this,"handleUpdateVideoEncoder",(i,n,r,o)=>I(this,null,function*(){let s;o||(s=yield this.mutex.lock("Locking from P2PChannel.handleUpdateVideoEncoder"));try{let c=this.localTrackMap.get(W.LocalVideoTrack);if(!this.connection||!c||c.track!==i||this.state!==Bt.Connected)return void n();let{id:d,track:l}=c;yield this.connection.updateSendParameters(d,l),yield this.connection.updateEncoderConfig(d,l),this.emit(at.UpdateVideoEncoder,l),n()}catch(c){r(c)}finally{var a;(a=s)===null||a===void 0||a()}})),T(this,"handleUpdateVideoSendParameters",(i,n,r)=>I(this,null,function*(){let o=yield this.mutex.lock("Locking from P2PChannel.handleUpdateVideoSendParameters");try{let s=this.localTrackMap.get(W.LocalVideoTrack);if(!this.connection||!s||s.track!==i||this.state!==Bt.Connected)return void n();let{id:a,track:c}=s;yield this.connection.updateSendParameters(a,c),n()}catch(s){r(s)}finally{o()}})),T(this,"handleReplaceMixingTrack",(i,n,r,o)=>I(this,null,function*(){if(!this.connection||this.state!==Bt.Connected)return void n();let s=Dg([i]),a;_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(s.getTrackId(),"]")),typeof o=="boolean"&&o||(a=yield this.mutex.lock("From P2PChannel.handleReplaceMixingTrack"));try{yield this.replaceTrack(i,s),n()}catch(d){r(d)}finally{var c;(c=a)===null||c===void 0||c()}})),T(this,"handleReplaceTrack",(i,n,r,o)=>I(this,null,function*(){let s;_.debug("[".concat(this.store.clientId,"] P2PChannel handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),typeof o=="boolean"&&o||(s=yield this.mutex.lock("From P2PChannel.handleReplaceTrack"));try{var a;let d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:u}]=l;return i===u});if(!this.connection||!d||this.state!==Bt.Connected)return void n();if(yield(a=this.connection)===null||a===void 0?void 0:a.replaceTrack(i,d[1].id),this.isPlanB){let l=d[1];l.id=i._mediaStreamTrack.id,this.localTrackMap.set(d[0],l)}if(d[0]===W.LocalVideoTrack&&!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding){let l=this.localTrackMap.get(W.LocalVideoLowTrack);if(l){let u=i._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,yield new Q((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)})}}n()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}})),T(this,"handleGetRTCStats",i=>{i(this.statsCollector.getRTCStats())}),T(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),T(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),T(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),T(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new LN(this.store),this.bindStatsUploaderEvents(),this.mutex=new ni("P2PChannel-mutex",this.store.clientId),this.isPlanB=!Mt().supportUnifiedPlan||A("CHROME_FORCE_PLAN_B")&&Qr(),this.shouldForwardP2PCreation=A("FORWARD_P2P_CREATION")&&Mt().supportPCSetConfiguration&&_f(),this.shouldForwardP2PCreation&&(this.connection=np(this.store),this.emit(at.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection))}startP2PConnection(t){return I(this,null,function*(){var e;this.state=Bt.New,this._forceTurn=ON(t),_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] forceTurn: ").concat(this._forceTurn));let i=this.shouldForwardP2PCreation&&((e=this.connection)===null||e===void 0?void 0:e.peerConnectionState)==="closed";if(this.shouldForwardP2PCreation&&!i||(i&&this.connection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2PConnection ForwardP2P closed.")),this.resetConnection(this.connection)),this.connection=np(this.store,t),this.emit(at.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),!this.connection)throw new F(C.UNEXPECTED_ERROR,"Cannot P2PChannel.startConnection before P2PConnection initialization .");return this._pcStatsUploadType=A("NEW_ICE_RESTART")?io.FIRST_CONNECTION:io.OLD_FIRST_CONNECTION,this._isTryConnecting=!0,this._isStartRestartIce=!1,this._iceError=null,this.connection.setConfiguration(t),this.connection.establishPromise})}connect(t){return I(this,null,function*(){if(!this.connection)throw new F(C.UNEXPECTED_ERROR,"Cannot P2PChannel.connect before P2PChannel.startP2PConnection .");A("ENABLE_PREALLOC_PC")&&this.state===Bt.Connected?yield this.connection.updateRemoteConnect(t):(this.store.peerConnectionStart(),yield this.connection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Bt.Connected)})}updateRemoteRTPCapabilities(t){let e=Array.from(this.localTrackMap.entries()).filter(r=>{var o;let[s]=r;return z(o=[W.LocalVideoLowTrack,W.LocalVideoTrack]).call(o,s)}),i=e.map(r=>{let[,{id:o}]=r;return o}),n=e.map(r=>{let[o]=r;return o});if(this.connection instanceof Dr){if(ot.updateRemoteRTPCapabilities(this.store.sessionId,{trackTypes:JSON.stringify(n),localCodecs:JSON.stringify(this.connection.localCodecs),remoteCodecs:JSON.stringify(t)}),!z(t).call(t,this.store.codec)){let r=["vp9","vp8","h264"].find(o=>z(t).call(t,o));r&&(this.store.codec=r,_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId," updateRemoteRTPCapabilities] default codec is not available, hence the fallback to ").concat(r,".")))}this.connection.updateRemoteRTPCapabilities(i,t)}}getEstablishParams(){return I(this,null,function*(){var t;if(this.connection instanceof Dr&&this.connection.peerConnectionState!=="closed"&&z(t=[Bt.New,Bt.Connected]).call(t,this.state))return this.connection.establishPromise})}publishDataChannel(t){return I(this,null,function*(){if(!this.connection||this.state!==Bt.Connected){if(this.state===Bt.Disconnected)throw new F(C.UNEXPECTED_ERROR,"PeerConnection already disconnected.");return t.forEach(i=>{var n;z(n=this.pendingLocalDataChannels).call(n,i)||this.pendingLocalDataChannels.push(i)}),[]}let e=this.filterTobePublishedDataChannels(t);return e.length===0?[]:(e.forEach(i=>{let n=Date.now();this.store.publish(i.id.toString(),"datachannel",n)}),yield this.connection.createDataChannels(this.store.uid,e),e.forEach(i=>{this.localDataChannels.push(i);let n=Date.now();this.store.publish(i.id+"","datachannel",void 0,n)}),t.map(i=>({streamId:i.id,ordered:i.ordered,maxRetransmits:i.maxRetransmits,metadata:i.metadata,channelId:i._originDataChannelId})))})}publish(t,e,i){var n=this;return un(function*(){let r=yield Lt(n.mutex.lock("From P2PChannel.publish"));try{var o;let s=n.connection&&z(o=["disconnected","failed"]).call(o,n.connection.peerConnectionState);if(!n.connection||n.state!==Bt.Connected||s){if(n.state===Bt.Disconnected)throw new F(C.UNEXPECTED_ERROR,"PeerConnection already disconnected.");n.throwIfTrackTypeNotMatch(t);let c=t.filter(d=>n.pendingLocalTracks.indexOf(d)===-1);return n.pendingLocalTracks=n.pendingLocalTracks.concat(c),void(s&&(n._isWaitPcToRePub=!0))}n.store.pubId=n.store.pubId+1,si.markPublishStart(n.store.clientId,n.store.pubId);let a=n.filterTobePublishedTracks(t,e,i);if(a.length===0)return void(yield Lt(n.tryToUnmuteAudio(t)));yield*dl(ih(xN(n.doPublish(n.connection,a))))}finally{r()}})()}doPublish(t,e){var i=this;return un(function*(){e.forEach(h=>{let{track:p,type:g}=h,E=Date.now();i.store.publish(p.getTrackId(),g===W.LocalAudioTrack?"audio":"video",E)}),i.bindLocalTrackEvents(e);let n=e.map(h=>{let{track:p}=h;return p}),r=yield Lt(t.send(n,i.store.codec,i.store.audioCodec)),o=(yield Lt(r.next())).value,s=i.createGatewayPublishMessage(e,o),a;try{a=yield s}catch(h){throw r.throw(h),h?.code===C.WS_ABORT&&e.forEach(p=>{let{track:g}=p;i.pendingLocalTracks.indexOf(g)===-1&&i.pendingLocalTracks.push(g)}),i.unbindLocalTrackEvents(e),h}let c=i.mapPubResToRemoteConfig(s,a,n),d=(yield Lt(r.next(c))).value;if(i.state===Bt.Disconnected)throw new F(C.UNEXPECTED_ERROR,"PeerConnection already disconnected.");A("ENABLE_VIDEO_SEI");let l=A("ENABLE_ENCODED_TRANSFORM"),u=A("ENABLE_AUDIO_METADATA");n.forEach(h=>I(null,null,function*(){let p=h.getRTCRtpTransceiver();if(!p||!l)return;let{interceptLocalVideoFrame:g,interceptLocalAudioFrame:E}=Jh();h.trackMediaType===$.VIDEO?yield g(p.sender,h):h.trackMediaType===$.AUDIO&&(yield E(p.sender,{metadata:u?()=>{let f=h.metadata.shift();return f&&f.value}:void 0}))})),e.forEach(h=>{let{type:p}=h;i.statsCollector.addLocalStats(p)}),i.assignLocalTracks(e,d),i.statsUploader.startUploadOutboundStats(),e.forEach(h=>{let{track:p,type:g}=h,E=Date.now();i.store.publish(p.getTrackId(),g===W.LocalAudioTrack?"audio":"video",void 0,E)})})()}updateVideoStreamParameter(t,e){return I(this,null,function*(){let i=this.localTrackMap.get(e);if(!i||!this.connection)return;if(!(i.track instanceof re))return _.warn("[updateVideoStreamParameter]: track is not an instance of LocalVideoTrack");let{track:n}=i,r=function(o,s){let a={};return o.height&&o.width&&(a.scaleResolutionDownBy=mg(o,s)),a.maxFramerate=o.framerate?Hi(o.framerate):void 0,a.maxBitrate=o.bitrate?1e3*o.bitrate:void 0,a}(t,n);if(n._encoderConfig||(n._encoderConfig={}),e!==W.LocalVideoLowTrack||!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding)r.scaleResolutionDownBy!=null&&(n._encoderConfig.scaleResolutionDownBy=r.scaleResolutionDownBy);else{let o=n._originMediaStreamTrack;if(!o.canvas)return _.warn("[".concat(n.getTrackId(),"] no canvas on track"));(function(s,a){let c=s.canvas;a.width&&(c.width=Hi(a.width)),a.height&&(c.height=Hi(a.height)),a.framerate&&(c.stopCapture&&c.stopCapture(),c.stopCapture=Wf(()=>{!c.startCapture&&c.stopCapture&&c.stopCapture(),c.startCapture&&c.startCapture()},Hi(a.framerate)))})(o,t)}r.maxBitrate!=null&&(n._encoderConfig.bitrateMax=r.maxBitrate/1e3),r.maxFramerate!=null&&(n._encoderConfig.frameRate&&typeof n._encoderConfig.frameRate=="object"?n._encoderConfig.frameRate.max=r.maxFramerate:n._encoderConfig.frameRate={max:r.maxFramerate}),_.debug("[".concat(n.getTrackId(),"] LowStreamEncoderConfig: , ").concat(JSON.stringify(n._encoderConfig))),yield this.connection.updateRtpSenderEncodings(n)})}publishLowStream(t){var e=this;return un(function*(){if(!e.connection||e.state!==Bt.Connected)return;let i=yield Lt(e.mutex.lock("Locking from P2PChannel.publishLowStream"));try{let r=e.localTrackMap.get(W.LocalVideoTrack);if(!r)throw new F(C.UNEXPECTED_ERROR,"Could not find high stream");if(e.localTrackMap.has(W.LocalVideoLowTrack))throw new F(C.UNEXPECTED_ERROR,"[".concat(e.store.clientId,"] Can't publish low stream when stream already publish"));let o=[{track:e.getLowVideoTrack(r.track,t),type:W.LocalVideoLowTrack}];if(yield*dl(ih(xN(e.doPublish(e.connection,o)))),r.track.muted||!r.track.enabled){var n;let s=(n=e.localTrackMap.get(W.LocalVideoLowTrack))===null||n===void 0?void 0:n.id;s!==void 0&&(yield Lt(e.connection.muteLocal([s])))}}finally{i()}})()}republish(){return I(this,null,function*(){this.pendingLocalTracks.length>0&&(_.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),yield $e(this,at.RequestRePublish,this.pendingLocalTracks),this.emit(at.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[]),this.pendingLocalDataChannels.length>0&&(_.debug("Emit P2PChannelEvents.RequestRePublishDataChannel to republish datachannels."),yield $e(this,at.RequestRePublishDataChannel,this.pendingLocalDataChannels),this.pendingLocalDataChannels=[]),this._isWaitPcToRePub=!1})}reSubscribe(t){return I(this,null,function*(){for(let e=this.pendingRemoteTracks.length-1;e>=0;e--){let{user:i,kind:n}=this.pendingRemoteTracks[e];(n!==$.AUDIO||i._audio_added_&&i._audioSSRC)&&(n!==$.VIDEO||i._video_added_&&i._videoSSRC)||this.pendingRemoteTracks.splice(e,1)}if(t)yield $e(this,at.RequestReSubscribe,this.pendingRemoteTracks);else for(let{user:e,kind:i}of this.pendingRemoteTracks)yield this.subscribe(e,i,i===$.VIDEO?e._videoSSRC:e._audioSSRC);this.pendingRemoteTracks.forEach(e=>{let{user:i}=e;this.emit(at.MediaReconnectEnd,i.uid)}),this.pendingRemoteTracks=[]})}unpublish(t){return I(this,null,function*(){if(!this.connection||this.state!==Bt.Connected)return void t.forEach(n=>{let r=this.pendingLocalTracks.indexOf(n);r!==-1&&this.pendingLocalTracks.splice(r,1)});let e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;let i=e.find(n=>n[0]==="videoLowTrack");return i&&i[1].track.close(),this.doUnpublish(this.connection,e)})}unpublishDataChannel(t){return I(this,null,function*(){if(!this.connection||this.state!==Bt.Connected)return void t.forEach(i=>{let n=this.pendingLocalDataChannels.indexOf(i);n!==-1&&this.pendingLocalDataChannels.splice(n,1)});let e=this.filterTobeUnpublishedDataChannels(t);return e.length!==0?(e.forEach(i=>{let n=this.localDataChannels.indexOf(i);n!==-1&&this.localDataChannels.splice(n,1)}),this.localDataChannels.length===0&&(yield this.connection.stopDataChannels(this.store.uid)),e.map(i=>i.id)):void 0})}unpublishLowStream(){return I(this,null,function*(){if(!this.connection||this.state!==Bt.Connected)return;let t=this.localTrackMap.get(W.LocalVideoLowTrack);if(!t)return;t.track.close();let e=[[W.LocalVideoLowTrack,t]];return this.doUnpublish(this.connection,e)})}doUnpublish(t,e){return I(this,null,function*(){let i=this.createGatewayUnpublishMessage(e);return yield t.stopSending(e.map(n=>{let[,{id:r}]=n;return r})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(n=>{let[r,{track:o}]=n;return{type:r,track:o}})),e.forEach(n=>{let[r]=n;this.statsCollector.removeLocalStats(r)}),this.localTrackMap.size===0&&this.statsUploader.stopUploadOutboundStats(),i})}subscribeDataChannel(t,e){return I(this,null,function*(){if(!this.connection||this.state!==Bt.Connected)throw new F(C.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");let i=e.filter(n=>{var r;return!((r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.get(n.id))});if(i.length!==0)return yield this.connection.createDataChannels(t.uid,i),i.forEach(n=>{var r;this.remoteDataChannelMap.has(t)?(r=this.remoteDataChannelMap.get(t))===null||r===void 0||r.set(n.id,n):this.remoteDataChannelMap.set(t,new Map([[n.id,n]]));let o=this.pendingRemoteDataChannels.findIndex(s=>{let{user:a,id:c}=s;return a.uid===t.uid&&c===n.id});o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),i.map(n=>n.id)})}subscribe(t,e,i,n,r){return I(this,null,function*(){var o;if(!this.connection||this.state!==Bt.Connected)throw new F(C.INVALID_OPERATION,"Cannot subscribe remote user when peerConnection disconnected.");if((o=this.remoteUserMap.get(t))!==null&&o!==void 0&&o.has(e))return;let s,a,c,d=this.connection.getPreMedia(i);if(d)_.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] preSSRCMap has ssrcId: ").concat(i,", no need to send sub to gateway.")),c=d.transceiver,s=d.track,a=d.id;else if(r){let h=r.find(g=>{let{stream_type:E}=g;return E===e});if(!h)throw new F(C.UNEXPECTED_ERROR,"Cannot subscribe to remote ".concat(e," for user: ").concat(t.uid," because subscribe answer from gateway does not contain stream_type: ").concat(e,"."));let p=yield this.connection.receive(e,h.ssrcs,String(t._uintid),h.attributes);this.connection instanceof Dr&&(c=p.transceiver),s=p.track,a=p.id}else{let h=yield this.connection.receive(e,[{ssrcId:i,rtx:n}],String(t._uintid),void 0);this.connection instanceof Dr&&(c=h.transceiver),s=h.track,a=h.id}if(e===$.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(s):(t._audioTrack=new za(s,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),c&&t._audioTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(s):(t._videoTrack=new Ya(s,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),c&&t._videoTrack._updateRtpTransceiver(c),this.bindRemoteTrackEvents(t,t._videoTrack)),c&&A("ENABLE_ENCODED_TRANSFORM")){let{interceptRemoteVideoFrame:h,interceptRemoteAudioFrame:p}=Jh();e==$.VIDEO?yield h(c.receiver,{onSei:A("ENABLE_VIDEO_SEI")&&(g=>{var E;return(E=t._videoTrack)===null||E===void 0?void 0:E._onSei(g)})}):e==$.AUDIO&&(yield p(c.receiver,{enableTopn:!!A("ENABLE_AUDIO_TOPN"),enableMetadata:!!A("ENABLE_AUDIO_METADATA"),onMetadata:g=>{this.safeEmit(at.AudioMetadata,g)}}))}let l=this.remoteUserMap.get(t);l?l.set(e,a):this.remoteUserMap.set(t,new Map([[e,a]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats();let u=this.pendingRemoteTracks.findIndex(h=>{let{user:p,kind:g}=h;return p.uid===t.uid&&e===g});u!==-1&&(this.pendingRemoteTracks.splice(u,1),this.emit(at.MediaReconnectEnd,t.uid))})}massSubscribe(t){return I(this,null,function*(){return this.massSubscribeNoLock(t)})}massSubscribeNoLock(t){return I(this,null,function*(){if(!this.connection||this.state!==Bt.Connected)throw new F(C.INVALID_OPERATION,"Cannot subscribeAll remote users when peerConnection disconnected.");t=t.filter(r=>{var o;let{user:s,mediaType:a}=r;return!((o=this.remoteUserMap.get(s))!==null&&o!==void 0&&o.has(a))});let e=[],i=new Map;t.forEach(r=>{if(!this.connection)return;let o=this.connection.getPreMedia(r.ssrcId);o?i.set(r.ssrcId,o):e.push(r)});let n=yield this.connection.batchReceive(e.map(r=>{let{user:o,mediaType:s,ssrcId:a,rtxSsrcId:c}=r;return{kind:s,ssrcMsg:[{ssrcId:a,rtx:c}],mslabel:String(o._uintid)}}));e.forEach((r,o)=>{i.set(r.ssrcId,n[o])});for(let{user:r,mediaType:o,ssrcId:s}of t){let a=i.get(s);if(!a)return void _.debug("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] cannot find ").concat(r.uid," subscribe data,").concat(o,", ").concat(s));let{track:c,id:d,transceiver:l}=a;if(l&&A("ENABLE_ENCODED_TRANSFORM")){let{interceptRemoteVideoFrame:p,interceptRemoteAudioFrame:g}=Jh();o==$.VIDEO?yield p(l.receiver,{onSei:A("ENABLE_VIDEO_SEI")&&(E=>{var f;return(f=r._videoTrack)===null||f===void 0?void 0:f._onSei(E)})}):o==$.AUDIO&&(yield g(l.receiver,{enableTopn:!!A("ENABLE_AUDIO_TOPN"),enableMetadata:!!A("ENABLE_AUDIO_METADATA"),onMetadata:E=>{this.safeEmit(at.AudioMetadata,E)}}))}if(o===$.AUDIO?(r._audioTrack?r._audioTrack._updateOriginMediaStreamTrack(c):(r._audioTrack=new za(c,r.uid,r._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(r._audioTrack.getTrackId()))),l&&r._audioTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._audioTrack)):(r._videoTrack?r._videoTrack._updateOriginMediaStreamTrack(c):(r._videoTrack=new Ya(c,r.uid,r._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(r._videoTrack.getTrackId()))),l&&r._videoTrack._updateRtpTransceiver(l),this.bindRemoteTrackEvents(r,r._videoTrack)),A("ENABLE_VIDEO_SEI")&&l){let{interceptRemoteVideoFrame:p,interceptRemoteAudioFrame:g}=Jh();o==$.VIDEO?yield p(l.receiver,{onSei:E=>{var f;(f=r._videoTrack)===null||f===void 0||f._onSei(E)}}):o==$.AUDIO&&(yield g(l.receiver))}let u=this.remoteUserMap.get(r);u?u.set(o,d):this.remoteUserMap.set(r,new Map([[o,d]])),this.statsCollector.addRemoteStats(r.uid),this.statsUploader.startUploadInboundStats();let h=this.pendingRemoteTracks.findIndex(p=>{let{user:g,kind:E}=p;return g.uid===r.uid&&o===E});h!==-1&&(this.pendingRemoteTracks.splice(h,1),this.emit(at.MediaReconnectEnd,r.uid))}})}unsubscribe(t,e,i){return I(this,null,function*(){let n=this.pendingRemoteTracks.filter(s=>{let{user:a,kind:c}=s;return e!==void 0?a.uid===t.uid&&e===c:a.uid===t.uid});if(n.forEach(s=>{let a=this.pendingRemoteTracks.indexOf(s);this.pendingRemoteTracks.splice(a,1)}),this.connection&&this.state===Bt.Connected||i||n.forEach(s=>{let{kind:a}=s;var c;if(a===$.AUDIO)(c=t._audioTrack)===null||c===void 0||c._destroy(),t._audioTrack=void 0;else if(a===$.VIDEO){var d;(d=t._videoTrack)===null||d===void 0||d._destroy(),t._videoTrack=void 0}}),!this.connection||this.state!==Bt.Connected)return;let r=this.filterTobeUnSubscribedTracks(t,e);if(r.length===0)return;yield this.connection.stopReceiving(r.map(s=>{let[,{id:a}]=s;return a}));let o=this.createUnsubscribeMessage(r);return this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),r.forEach(s=>{let[a,{kind:c}]=s;var d,l;if(c===$.VIDEO&&a._videoSSRC&&((d=this.connection)===null||d===void 0||d.setStatsRemoteVideoIsReady(a._videoSSRC,!1)),c===$.VIDEO)this.unbindRemoteTrackEvents(a._videoTrack),i||((l=a._videoTrack)===null||l===void 0||l._destroy(),a._videoTrack=void 0);else if(c===$.AUDIO){var u;this.unbindRemoteTrackEvents(a._audioTrack),!i&&((u=a._audioTrack)===null||u===void 0||u._destroy(),a._audioTrack=void 0)}}),o})}unsubscribeDataChannel(t,e){return I(this,null,function*(){if(e.forEach(r=>{let o=this.pendingRemoteDataChannels.findIndex(s=>s.id===r.id);o!==-1&&this.pendingRemoteDataChannels.splice(o,1)}),!this.connection)return;let i=this.filterTobeUnSubscribedDataChannels(t,e);if(i.length===0)return;e.forEach(r=>{r._close()});let n=this.remoteDataChannelMap.get(t);return i.forEach(r=>{n&&n.delete(r.id)}),n&&n.size===0&&(this.remoteDataChannelMap.delete(t),yield this.connection.stopDataChannels(t.uid)),i.map(r=>r.id)})}massUnsubscribe(t){return I(this,null,function*(){return this.massUnsubscribeNoLock(t)})}massUnsubscribeNoLock(t){return I(this,null,function*(){let e=[];for(let{user:r,mediaType:o}of t){let s=this.pendingRemoteTracks.filter(a=>{let{user:c,kind:d}=a;return o!==void 0?c.uid===r.uid&&o===d:c.uid===r.uid});s.forEach(a=>{let c=this.pendingRemoteTracks.indexOf(a);this.pendingRemoteTracks.splice(c,1)}),e=e.concat(s)}if(!this.connection||this.state!==Bt.Connected)return void e.forEach(r=>{let{user:o,kind:s}=r;var a;if(s===$.AUDIO)(a=o._audioTrack)===null||a===void 0||a._destroy(),o._audioTrack=void 0;else if(s===$.VIDEO){var c;(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0}});let i=bn(t).call(t,(r,o)=>{let{user:s,mediaType:a}=o,c=this.filterTobeUnSubscribedTracks(s,a);return r.concat(c)},[]);if(i.length===0)return;yield this.connection.stopReceiving(i.map(r=>{let[,{id:o}]=r;return o}));let n=this.createUnsubscribeAllMessage(i);return this.withdrawRemoteTracks(i),this.remoteUserMap.size===0&&this.statsUploader.stopUploadInboundStats(),i.forEach(r=>{let[o,{kind:s}]=r;var a,c;if(s===$.VIDEO&&o._videoSSRC&&((a=this.connection)===null||a===void 0||a.setStatsRemoteVideoIsReady(o._videoSSRC,!1)),s===$.VIDEO)this.unbindRemoteTrackEvents(o._videoTrack),(c=o._videoTrack)===null||c===void 0||c._destroy(),o._videoTrack=void 0;else if(s===$.AUDIO){var d;this.unbindRemoteTrackEvents(o._audioTrack),(d=o._audioTrack)===null||d===void 0||d._destroy(),o._audioTrack=void 0}}),n})}isPreSubScribe(t){return!this.connection||this.state!==Bt.Connected?!1:!!this.connection.getPreMedia(t)}muteRemote(t,e){return I(this,null,function*(){if(!this.connection)return;let i=this.remoteUserMap.get(t);if(!i)return void _.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid,"."));if(!i.get(e))return void _.warning("[".concat(this.store.clientId,"] P2PChannel.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));let n=e===$.VIDEO?t._videoSSRC:t._audioSSRC;n!==void 0&&this.connection.setStatsRemoteVideoIsReady(n,!1)})}unmuteRemote(t,e){return I(this,null,function*(){return this.unmuteRemoteNoLock(t,e)})}unmuteRemoteNoLock(t,e){return I(this,null,function*(){if(!this.connection)return;let i=this.remoteUserMap.get(t);if(!i)return void _.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid,"."));i.get(e)||_.warning("[".concat(this.store.clientId,"] P2PChannel.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))})}addAudioMetadata(t){let e=this.localTrackMap.get(W.LocalAudioTrack),i=e&&e.track;i&&i.metadata.push(t)}getAllTracks(t){let e=this.localTrackMap.get(W.LocalAudioTrack);if(e?.track instanceof Le){let i=e.track;return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return r!==W.LocalAudioTrack}).filter(n=>{let[r]=n;return!(t&&r===W.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[n]=i;return!(t&&n===W.LocalVideoLowTrack)}).map(i=>{let[,{track:n}]=i;return n})}getAllDataChannels(){return this.localDataChannels}reportPublishEvent(t,e,i,n,r){if(t){let s=this.localTrackMap.get(W.LocalAudioTrack),a=n?this.localTrackMap.get(W.LocalVideoLowTrack):this.localTrackMap.get(W.LocalVideoTrack);ot.publish(this.store.sessionId,{eventElapse:si.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(Jt.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;i||(i=[]);let s=i.find(c=>c instanceof ge),a=n?(o=this.localTrackMap.get(W.LocalVideoTrack))===null||o===void 0?void 0:o.track:i.find(c=>c instanceof re);ot.publish(this.store.sessionId,{eventElapse:si.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(Jt.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,i,n){let r=n===$.VIDEO?i._videoSSRC:i._audioSSRC;r&&ot.subscribe(this.store.sessionId,{succ:t,ec:e,video:n===$.VIDEO,audio:n===$.AUDIO,peerid:i.uid,subscribeRequestid:r,p2pid:this.store.p2pId,eventElapse:si.measureFromSubscribeStart(this.store.clientId,r),preSsrc:this.isPreSubScribe(r)})}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel.reset")),this.mutex=new ni("P2PChannel-mutex",this.store.clientId),this.connection&&(this.resetConnection(this.connection),this.connection=void 0),this.shouldForwardP2PCreation&&(this.connection=np(this.store),this.emit(at.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.statsUploader.stopUploadBaseStats(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let t=this.localTrackMap.get(W.LocalAudioTrack);if(t?.track instanceof Le){if(t.track.trackList.length>0){let e=t.track;t.track.trackList.forEach(i=>{e.removeAudioTrack(i)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.iceFailedCount=0,this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.localDataChannels=[],this.remoteDataChannelMap.clear(),this.pendingLocalDataChannels=[],this.pendingRemoteDataChannels=[],this.state=Bt.Disconnected}getStats(){var t;return(t=this.connection)===null||t===void 0?void 0:t.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.connection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){let t=this.localTrackMap.get(W.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){let t=this.localTrackMap.get(W.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){let e=this.localTrackMap.get(t);return e&&e.track instanceof re||e&&e.track instanceof ge?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;let i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}hasRemoteMediaWithLock(t,e){return I(this,null,function*(){if(!t)return this.remoteUserMap.size>0;let i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))})}getRemoteMedia(t){var e;let i=Array.from(Zi(e=this.remoteUserMap).call(e)).find(n=>n.uid===t);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(i=>{let[n]=i;return{uid:n.uid,level:n.audioTrack?100*n.audioTrack._source.getAccurateVolumeLevel():0}}),e=this.localTrackMap.get(W.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=ls(t).call(t,(i,n)=>i.level-n.level),t}disconnectForReconnect(){return I(this,null,function*(){this.connection&&(_.debug("[".concat(this.store.clientId,"] P2PChannel.disconnectForReconnect closing P2PConnection")),this.state=Bt.Reconnecting,A("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var i;e._videoTrack&&e._videoTrack._player&&((i=e._videoTrack._player.getVideoElement())===null||i===void 0||i.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.resetConnection(this.connection),this.connection=void 0,this.shouldForwardP2PCreation&&(this.connection=np(this.store),this.emit(at.PeerConnectionStateChange,this.connection.peerConnectionState),this.bindConnectionEvents(this.connection)),this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[i,{track:n}]=t;switch(i){case W.LocalVideoTrack:z(e=n._hints).call(e,Jt.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case W.LocalAudioTrack:n instanceof Le?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case W.LocalVideoLowTrack:}}),this.emit(at.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;Array.from(Zi(i).call(i)).forEach(n=>{this.setPendingRemoteMedia(e,n)}),this.emit(at.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.localDataChannels.length!==0&&(this.localDataChannels.forEach(t=>{this.pendingLocalDataChannels.push(t)}),this.localDataChannels.length=0),this.remoteDataChannelMap.size!==0&&(Array.from(this.remoteDataChannelMap.entries()).forEach(t=>{let[e,i]=t;Array.from(Zi(i).call(i)).forEach(n=>{this.setPendingRemoteDataChannel(e,n)})}),this.remoteDataChannelMap.clear()),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),_.debug("[".concat(this.store.clientId,"] P2PChannel disconnected, waiting to reconnect.")))})}hasPendingRemoteDataChannel(t,e){for(let i of this.pendingRemoteDataChannels){let{user:n,id:r}=i;if((t instanceof Ho?t.uid:t)===n.uid&&r===e)return!0}return!1}setPendingRemoteDataChannel(t,e){this.hasPendingRemoteDataChannel(t,e)||this.pendingRemoteDataChannels.push({user:t,id:e})}hasPendingRemoteMedia(t,e){for(let i of this.pendingRemoteTracks){let{user:n,kind:r}=i;if((t instanceof Ho?t.uid:t)===n.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t){var e=this;return un(function*(){if(!e.connection||e.state!==Bt.Connected)return;let i=yield Lt(e.mutex.lock("From P2PChannel.restartICE")),n;try{n=yield Lt(e.connection.restartICE(t));let o=yield Lt(n.next());if(o.done)return;let s=o.value,a=yield s;switch(Pg(e.connection)&&e.reportPCStats(Date.now(),!1,e._pcStatsUploadType),t){case oi.UDP_TCP_RELAY:e._pcStatsUploadType=io.UDP_TCP_RESTART;break;case oi.TCP_RELAY:e._pcStatsUploadType=io.TCP_RESTART;break;case oi.RELAY:e._pcStatsUploadType=io.RELAY_RESTART;break;default:e._pcStatsUploadType=io.OLD_RESTART}e._isTryConnecting=!0,n.next(a)}catch(o){var r;(r=n)===null||r===void 0||r.throw(o)}finally{i()}})()}getUplinkNetworkQuality(){if(!this.connection)return 0;let t=this.connection.getStats(),e=this.localTrackMap.get(W.LocalVideoTrack),i=this.localTrackMap.get(W.LocalAudioTrack),n=t.videoSend.find(p=>p.ssrc===e?.ssrcs[0].ssrcId),r=t.audioSend.find(p=>p.ssrc===i?.ssrcs[0].ssrcId);if(!n||!r)return 1;let o=Ji(this,at.NeedSignalRTT),s=n?n.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=e?.track;if(h&&h._encoderConfig&&h._hints.indexOf(Jt.SCREEN_TRACK)===-1){let p=h._encoderConfig.bitrateMax,g=t.bitrate.actualEncoded;if(p&&g){let E=(1e3*p-g)/(1e3*p);return RO[E<.15?0:E<.3?1:E<.45?2:E<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.connection)return 0;let t=this.connection.getStats(),e=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[n]=i,r=n._audioSSRC,o=n._videoSSRC,s=t.audioRecv.find(g=>g.ssrc===r),a=t.videoRecv.find(g=>g.ssrc===o);if(!s&&!a)return void(e+=1);let c=Ji(this,at.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=s?s.jitterMs:void 0,h=t.recvPacketLossRate,p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}muteLocalTrack(t){return I(this,null,function*(){return new Q((e,i)=>{this.handleMuteLocalTrack(t,e,i)})})}replaceTrack(t,e){return I(this,null,function*(){var i;if(_.debug("[".concat(this.store.clientId,"] P2PChannel replaceTrack from [").concat(t.getTrackId(),"] to [").concat(e.getTrackId(),"]")),!this.connection||this.state!==Bt.Connected)return;let n=Array.from(this.localTrackMap.entries()).find(o=>{let[,{track:s}]=o;return t===s});if(!n)return;let r=n[0];if(t!==e&&(this.unbindLocalTrackEvents([{track:t,type:r}]),this.bindLocalTrackEvents([{track:e,type:r}]),n[1].track=e),yield(i=this.connection)===null||i===void 0?void 0:i.replaceTrack(e,n[1].id),this.isPlanB){let o=n[1];o.id=e._mediaStreamTrack.id,this.localTrackMap.set(r,o)}if(r===W.LocalVideoTrack&&!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding){let o=this.localTrackMap.get(W.LocalVideoLowTrack);if(o){let s=t._mediaStreamTrack.clone();o.track._originMediaStreamTrack.stop(),o.track._mediaStreamTrack=s,o.track._originMediaStreamTrack=s,yield new Q((a,c)=>{this.handleReplaceTrack(o.track,a,c,!0)})}}})}filterTobePublishedTracks(t,e,i){let n=[],r=this.getAllTracks();t=ka(t=t.filter(c=>r.indexOf(c)===-1));let o,s=!1,a=this.localTrackMap.get(W.LocalAudioTrack);for(let c of t){if(c instanceof re&&(this.localTrackMap.has(W.LocalVideoTrack)||s?new F(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:c,type:W.LocalVideoTrack}),s=!0),e)){let d=this.getLowVideoTrack(c,i);n.push({track:d,type:W.LocalVideoLowTrack})}if(c instanceof ge)if(a){let d=a.track;if(d instanceof Le)Ng([c]),d.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0);else{let l=Dg([d,c]);_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will replace audioTrack [").concat(l.getTrackId(),"]")),this.replaceTrack(d,l)}}else o instanceof Le?(Ng([c]),o.addAudioTrack(c)):o||!c._useAudioElement&&Mt().webAudioMediaStreamDest&&!c._bypassWebAudio?o=Dg(o?[c,o]:[c]):o=c}return o&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection will send audioTrack [").concat(o.getTrackId(),"]")),n.push({track:o,type:W.LocalAudioTrack})),n}filterTobeUnpublishedTracks(t){let e=[],i=this.getAllTracks();t=ka(t=t.filter(n=>i.indexOf(n)!==-1));for(let n of t){if(n instanceof ge){let r=this.localTrackMap.get(W.LocalAudioTrack);if(!r)continue;r.track instanceof Le?(r.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),r.track.trackList.length===0&&(e.push([W.LocalAudioTrack,r]),r.track.close())):e.push([W.LocalAudioTrack,r])}if(n instanceof re){let r=this.localTrackMap.get(W.LocalVideoTrack);if(!r)continue;e.push([W.LocalVideoTrack,r]);let o=this.localTrackMap.get(W.LocalVideoLowTrack);o&&e.push([W.LocalVideoLowTrack,o])}}return e}filterTobePublishedDataChannels(t){return t=(t=ka(t)).filter(e=>this.localDataChannels.findIndex(i=>i.id===e.id)===-1)}filterTobeUnpublishedDataChannels(t){return t=(t=(t=ka(t)).filter(e=>this.localDataChannels.indexOf(e)!==-1)).filter(e=>e._originDataChannel)}bindLocalTrackEvents(t){t.forEach(e=>{let{track:i,type:n}=e;switch(n){case W.LocalVideoTrack:i.addListener(nt.GET_STATS,this.handleGetLocalVideoStats),i.addListener(nt.GET_RTC_STATS,this.handleGetRTCStats),i.addListener(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(nt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(nt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.addListener(nt.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case W.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);case W.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof Le?t.trackList.forEach(i=>{i.addListener(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(nt.GET_STATS,this.handleGetLocalAudioStats),i.addListener(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(nt.GET_STATS,this.handleGetLocalAudioStats),t.addListener(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||(t.addListener(nt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.addListener(nt.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack)))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[i,{track:n}]=e;return{track:n,type:i}})),t.forEach(e=>{let{track:i,type:n}=e;switch(n){case W.LocalVideoTrack:i.off(nt.GET_STATS,this.handleGetLocalVideoStats),i.off(nt.GET_RTC_STATS,this.handleGetRTCStats),i.off(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(nt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(nt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.off(nt.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case W.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);case W.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof Le?t.trackList.forEach(e=>{e.off(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(nt.GET_STATS,this.handleGetLocalAudioStats),e.off(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(nt.GET_STATS,this.handleGetLocalAudioStats),t.off(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(nt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(nt.NEED_REPLACE_MIXING_TRACK,this.handleReplaceMixingTrack),t.off(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Ya&&e.addListener(nt.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(t))}),e instanceof za&&e.addListener(nt.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(nt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;i.has($.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),i.has($.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((i,n)=>{var r;let o,s,{track:a,type:c}=i;switch(c){case W.LocalAudioTrack:o=Gt.Audio,s={dtx:a instanceof bd&&a._config.DTX,hq:!1,lq:!1,stereo:!1,speech:!1};break;case W.LocalVideoTrack:o=z(r=a._hints).call(r,Jt.SCREEN_TRACK)?Gt.Screen:Gt.High,s=Pr(Pr({},xO(a)),{},{codec:this.store.codec,svc_mode:Kh()});break;case W.LocalVideoLowTrack:o=Gt.Low,s=Pr(Pr({},xO(a)),{},{codec:this.store.codec,svc_mode:Kh()})}return{stream_type:o,attributes:s,ssrcs:e[n]}})}createGatewayUnpublishMessage(t){return t.map(e=>{var i;let n,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case W.LocalVideoTrack:n=z(i=o._hints).call(i,Jt.SCREEN_TRACK)?Gt.Screen:Gt.High;break;case W.LocalAudioTrack:n=Gt.Audio;break;case W.LocalVideoLowTrack:n=Gt.Low}return{stream_type:n,ssrcs:s,mid:a}})}assignLocalTracks(t,e){t.forEach((i,n)=>{let{track:r,type:o}=i;this.localTrackMap.set(o,{track:r,id:e[n].id,ssrcs:e[n].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[i]=e;this.localTrackMap.delete(i)})}bindConnectionEvents(t){t.onConnectionStateChange=e=>I(this,null,function*(){if(_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onConnectionStateChange(").concat(e,")")),this.emit(at.PeerConnectionStateChange,e),e==="connecting"&&t instanceof Dr&&!_e()&&A("FIRST_TCP_CANDIDATE")&&window.setTimeout(()=>{e==="connecting"&&t.extendCandidate()},A("FIRST_TCP_CANDIDATE_INTERVAL")),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(this._restartTimer&&(window.clearTimeout(this._restartTimer),this._restartTimer=void 0),t instanceof Dr&&kN(t,!0),this._isTryConnecting&&this.reportPCStats(Date.now(),!0,this._pcStatsUploadType),this._isTryConnecting=!1,this._isStartRestartIce=!1,this._pcStatsUploadType=io.DISCONNECTED_OR_FAILED,Ji(this,at.QueryClientConnectionState)==="CONNECTED"&&this._isWaitPcToRePub)){let i=this.pendingLocalTracks.map(r=>r.getTrackId()),n=this.pendingLocalDataChannels.map(r=>"dc_".concat(r.id));ot.reportApiInvoke(this.store.sessionId,{name:be.REPUB_AFTER_PC_CONNECTED,options:i.concat(n),tag:Ee.TRACER}).onSuccess(),this.republish()}if(A("NEW_ICE_RESTART")&&t instanceof Dr&&!_e()&&!this._forceTurn){if(z(DO).call(DO,e)){if(this._isStartRestartIce)return;this._isStartRestartIce=!0;let i=r=>{Pg(t)&&(_.debug("[".concat(this.store.clientId,"] [P2PChannel] try to restartICE, type is ").concat(r)),Ji(this,at.QueryClientConnectionState)==="CONNECTED"&&this.emit(at.RequestRestartICE,r))},n=()=>{Pg(t)&&(this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),_.debug("[".concat(this.store.clientId,"] P2PConnection disconnected timeout, force reconnect")),setTimeout(()=>this.emit(at.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())};return void(this._restartTimer=window.setTimeout(()=>{MN(t,i,n)},800))}}else{if(e==="disconnected"&&t.iceConnectionState==="disconnected")return setTimeout(()=>{t.iceConnectionState==="disconnected"&&A("ICE_RESTART")&&Ji(this,at.QueryClientConnectionState)==="CONNECTED"&&this.emit(at.RequestRestartICE)},800),void setTimeout(()=>{t.peerConnectionState==="disconnected"&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection disconnected timeout 4000ms, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),this._isTryConnecting=!1,setTimeout(()=>this.emit(at.P2PLost),0),this.iceFailedCount+=1,this.requestReconnect())},4e3);e==="failed"&&(_.debug("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection state failed, force reconnect")),this.reportPCStats(Date.now(),!1,this._pcStatsUploadType),setTimeout(()=>this.emit(at.P2PLost),0),this.iceFailedCount+=1,yield this.requestReconnect())}}),t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),ot.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Ee.TRACER}).onSuccess(),this.emit(at.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var i;let n=Array.from(Zi(i=this.remoteUserMap).call(i)).find(o=>o._audioSSRC===e);var r;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(r=n.audioTrack)===null||r===void 0||r.emit(Ga.FIRST_FRAME_DECODED),ot.firstRemoteFrame(this.store.sessionId,Fe.FIRST_AUDIO_DECODE,ce.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:si.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var i;let n=Array.from(Zi(i=this.remoteUserMap).call(i)).find(r=>r._audioSSRC===e);n&&ot.firstRemoteFrame(this.store.sessionId,Fe.FIRST_AUDIO_RECEIVED,ce.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:si.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,i,n)=>{this.reportVideoFirstFrameDecoded(e,i,n)},t.onFirstVideoReceived=e=>{var i;let n=Array.from(Zi(i=this.remoteUserMap).call(i)).find(r=>r._videoSSRC===e);n&&ot.firstRemoteFrame(this.store.sessionId,Fe.FIRST_VIDEO_RECEIVED,ce.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:si.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,i)=>{let n=e.candidateType==="relay",r=i.candidateType==="relay";i.candidateType!=="unknown"&&n===r||this.emit(at.ConnectionTypeChange,n),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(jo(i))," -> ").concat(JSON.stringify(jo(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,i)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(jo(i))," -> ").concat(JSON.stringify(jo(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.getLocalVideoStats=()=>{let e=this.statsCollector.getLocalVideoTrackStats(),i=this.statsCollector.getRTCStats();return Pr(Pr({},e),i)},t.onICECandidateError=e=>{this._iceError=e}}resetConnection(t){t instanceof Dr&&function(e){ac.delete(e.id),kN(e)}(t),t.close(),this.emit(at.PeerConnectionStateChange,"closed"),function(e){e.onConnectionStateChange=void 0,e.onICEConnectionStateChange=void 0,e.onICETransportStateChange=void 0,e.onDTLSTransportStateChange=void 0,e.onDTLSTransportError=void 0,e.onFirstAudioDecoded=void 0,e.onFirstAudioReceived=void 0,e.onFirstVideoDecoded=void 0,e.onFirstVideoReceived=void 0,e.onSelectedLocalCandidateChanged=void 0,e.onSelectedRemoteCandidateChanged=void 0,e.onFirstVideoDecodedTimeout=void 0,e.getLocalVideoStats=void 0}(t),this._isWaitPcToRePub=!1}filterTobeMutedTracks(t){let e=[];if(this.getAllTracks().indexOf(t)===-1)return e;let i=this.localTrackMap.get(W.LocalAudioTrack);if(t instanceof ge&&i?.track instanceof Le)return i.track.isActive||e.push([W.LocalAudioTrack,i]),e;let n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(n&&(e.push(n),n[0]===W.LocalVideoTrack)){let r=this.localTrackMap.get(W.LocalVideoLowTrack);r&&e.push([W.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){let e=[],i=this.localTrackMap.get(W.LocalAudioTrack);if(t instanceof ge&&i?.track instanceof Le)return i.track.isActive&&e.push([W.LocalAudioTrack,i]),e;let n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(n)if(n[0]===W.LocalVideoTrack){e.push(n);let r=this.localTrackMap.get(W.LocalVideoLowTrack);r&&e.push([W.LocalVideoLowTrack,r])}else e.push(n);return e}createMuteMessage(t){return t.map(e=>{var i;let n,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case W.LocalAudioTrack:n=Gt.Audio;break;case W.LocalVideoTrack:n=z(i=o._hints).call(i,Jt.SCREEN_TRACK)?Gt.Screen:Gt.High;break;case W.LocalVideoLowTrack:n=Gt.Low}return{stream_type:n,ssrcs:s,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var i;let n,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case W.LocalAudioTrack:n=Gt.Audio;break;case W.LocalVideoTrack:n=z(i=o._hints).call(i,Jt.SCREEN_TRACK)?Gt.Screen:Gt.High;break;case W.LocalVideoLowTrack:n=Gt.Low}return{stream_type:n,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(t,e){let i=[],n=this.remoteUserMap.get(t);if(!n)return i;if(e){let r=n.get(e);if(!r)return i;i.push([t,{kind:e,id:r}])}else Array.from(n.entries()).forEach(r=>{let[o,s]=r;i.push([t,{kind:o,id:s}])});return i}filterTobeUnSubscribedDataChannels(t,e){let i=[];return e.forEach(n=>{var r;(r=this.remoteDataChannelMap.get(t))!==null&&r!==void 0&&r.has(n.id)&&i.push(n)}),i}createUnsubscribeMessage(t){let e=[];return t.forEach(i=>{let[n,{kind:r,id:o}]=i;switch(r){case $.VIDEO:return void(n._videoSSRC&&e.push({stream_type:$.VIDEO,ssrcId:n._videoSSRC}));case $.AUDIO:return void(n._audioSSRC&&e.push({stream_type:$.AUDIO,ssrcId:n._audioSSRC}))}}),e}createUnsubscribeAllMessage(t){let e=new Map;return t.forEach(i=>{let[n,{kind:r}]=i;if(e.has(n)){let o=e.get(n);r===$.VIDEO?o|=Be.Video:o|=Be.Audio,e.set(n,o)}else r===$.VIDEO?e.set(n,Be.Video):e.set(n,Be.Audio)}),{users:Array.from(e.entries()).map(i=>{let[n,r]=i;return{stream_id:n.uid,stream_type:r}})}}withdrawRemoteTracks(t){t.forEach(e=>{let[i,{kind:n}]=e,r=this.remoteUserMap.get(i);r&&(r.delete(n),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(i))})}updateBitrateLimit(t){return I(this,null,function*(){let e=this.localTrackMap.get(W.LocalVideoTrack),i=this.localTrackMap.get(W.LocalVideoLowTrack);e&&(yield e.track.setBitrateLimit(t.uplink),yield new Q((n,r)=>{this.handleUpdateVideoEncoder(e.track,n,r,!0)})),i&&t.low_stream_uplink&&(yield i.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}),yield new Q((n,r)=>{this.handleUpdateVideoEncoder(i.track,n,r,!0)}))})}isP2PDisconnected(){return this.connection?this.connection.peerConnectionState!=="connected":!0}mapPubResToRemoteConfig(t,e,i){return t.map((n,r)=>{var o;let{stream_type:s}=n,a=(o=e.find(c=>{let{stream_type:d}=c;return s===d}))===null||o===void 0?void 0:o.attributes;if(a&&A("DISABLE_SCREEN_SHARE_REMB")){let c=i[r]._hints;(z(c).call(c,Jt.SCREEN_TRACK)||z(c).call(c,Jt.SCREEN_LOW_TRACK))&&(a.remb=!1,_.debug("disable remb for screen share, hints:",c))}return a})}tryToUnmuteAudio(t){return I(this,null,function*(){for(let i=0;i<t.length;i++)if(t[i]instanceof ge){var e;let n=this.filterTobeUnmutedTracks(t[i]);if(n.length===0)continue;yield(e=this.connection)===null||e===void 0?void 0:e.unmuteLocal(n.map(o=>{let[,{id:s}]=o;return s}));let r=this.createUnmuteMessage(n);return void(yield Zt(this,at.RequestUnmuteLocal,r))}})}bindStatsUploaderEvents(){this.statsUploader.requestStats=()=>this.getStats(),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.connection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(at.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(at.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks(),this.statsUploader.requestTransportStats=()=>{var t;return{connectState:((t=this.connection)===null||t===void 0?void 0:t.peerConnectionState)||"closed"}}}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}requestReconnect(){return I(this,null,function*(){this.dtlsFailedCount+=1,yield qe(yf(this.dtlsFailedCount,Oe)),this.emit(at.RequestReconnect)})}reconnectP2P(){return I(this,null,function*(){let t=Array.from(this.localTrackMap.entries()),e=this.createGatewayUnpublishMessage(t);Array.from(this.remoteUserMap.entries()),e.length>0&&(yield $e(this,at.RequestUnpublishForReconnectPC,e)),this.disconnectForReconnect(),this.emit(at.RequestReconnectPC)})}canPublishLowStream(){return this.localTrackMap.has(W.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof re)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof re).length>1)throw new F(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof ge).length>1&&(t.some(e=>e instanceof ge&&e._bypassWebAudio)||!Mt().webAudioMediaStreamDest))throw new F(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let e of t){if(e instanceof re&&this.pendingLocalTracks.some(i=>i instanceof re))throw new F(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ge&&this.pendingLocalTracks.some(i=>i instanceof ge)&&(!Mt().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof ge&&i._bypassWebAudio)))throw new F(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){var i;let n=!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding,r=Pr(Pr({},{width:160,height:120,framerate:15,bitrate:50}),e),o;o=n?t._mediaStreamTrack.clone():Lg(t,r);let s=te(8,"track-low-"),a=new re(o,Pr(Pr({},n&&{scaleResolutionDownBy:mg(r,t)}),{},{frameRate:r.framerate,bitrateMax:r.bitrate,bitrateMin:r.bitrate}),void 0,void 0,s);return a.on(ys.TRANSCEIVER_UPDATED,c=>{t._updateRtpTransceiver(c,Ba.LOW_STREAM)}),a._hints.push(Jt.LOW_STREAM),z(i=t._hints).call(i,Jt.SCREEN_TRACK)&&a._hints.push(Jt.SCREEN_LOW_TRACK),t.on("sei-to-send",c=>{a.emit("sei-to-send",c)}),t.addListener(nt.NEED_CLOSE,()=>{a.close()}),a}globalLock(){return I(this,null,function*(){return this.mutex.lock("From P2PChannel.globalLock")})}reportPCStats(n,r,o){return I(this,arguments,function*(t,e,i){let s=arguments.length>3&&arguments[3]!==void 0?arguments[3]:null;if(this.connection&&this.connection instanceof Dr){var a,c,d,l;let u=this.store.keyMetrics.descriptionStart||0,{iceConnectionState:h,dtlsTransportState:p,peerConnectionState:g}=this.connection,{local:E,remote:f}=yield this.connection.getSelectedCandidatePair();ot.pcStats(this.store.sessionId,{startTime:u,eventElapse:t-u||0,iceconnectionsate:h,dtlsstate:p,connectionstate:g,intSucc:e?1:2,error:this._iceError||s||"",selectedLocalCandidateProtocol:(a=E?.protocol)!==null&&a!==void 0?a:"",selectedLocalCandidateType:(c=E.candidateType)!==null&&c!==void 0?c:"",selectedLocalCandidateAddress:"".concat(E.address,":").concat(E.port),selectedRemoteCandidateProtocol:(d=f.protocol)!==null&&d!==void 0?d:"",selectedRemoteCandidateType:(l=f.candidateType)!==null&&l!==void 0?l:"",selectedRemoteCandidateAddress:"".concat(f.address,":").concat(f.port),restartCnt:i,preallocation:this.connection.isPreallocation}),this._iceError=null}})}reportVideoFirstFrameDecoded(t,e,i,n){var r;let o=Array.from(Zi(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===t);if(o){n||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());let s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");ot.firstRemoteVideoDecode(this.store.sessionId,Fe.FIRST_VIDEO_DECODE,ce.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:i,subscribeElapse:si.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:n?1:0,firstFrame:a?.firstFrame||0})}}remoteMediaSsrcChanged(t,e,i){return I(this,null,function*(){if(!this.connection)return!1;let n=this.remoteUserMap.get(t);if(!n)return!1;let r=n.get(e);if(!r)return!1;let o=yield this.connection.getRemoteSSRC(r);return o!==void 0&&o!==i})}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:i}]=t;e===W.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,Ba.LOW_STREAM):i._updateRtpTransceiver(void 0)})}},rt(Ct.prototype,"startP2PConnection",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"startP2PConnection"),Ct.prototype),rt(Ct.prototype,"connect",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"connect"),Ct.prototype),rt(Ct.prototype,"updateRemoteRTPCapabilities",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"updateRemoteRTPCapabilities"),Ct.prototype),rt(Ct.prototype,"publishDataChannel",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"publishDataChannel"),Ct.prototype),rt(Ct.prototype,"unpublish",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"unpublish"),Ct.prototype),rt(Ct.prototype,"unpublishDataChannel",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"unpublishDataChannel"),Ct.prototype),rt(Ct.prototype,"unpublishLowStream",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"unpublishLowStream"),Ct.prototype),rt(Ct.prototype,"subscribeDataChannel",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"subscribeDataChannel"),Ct.prototype),rt(Ct.prototype,"subscribe",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"subscribe"),Ct.prototype),rt(Ct.prototype,"massSubscribe",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"massSubscribe"),Ct.prototype),rt(Ct.prototype,"unsubscribe",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"unsubscribe"),Ct.prototype),rt(Ct.prototype,"unsubscribeDataChannel",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"unsubscribeDataChannel"),Ct.prototype),rt(Ct.prototype,"massUnsubscribe",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"massUnsubscribe"),Ct.prototype),rt(Ct.prototype,"muteRemote",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"muteRemote"),Ct.prototype),rt(Ct.prototype,"unmuteRemote",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"unmuteRemote"),Ct.prototype),rt(Ct.prototype,"hasRemoteMediaWithLock",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"hasRemoteMediaWithLock"),Ct.prototype),rt(Ct.prototype,"disconnectForReconnect",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"disconnectForReconnect"),Ct.prototype),rt(Ct.prototype,"updateBitrateLimit",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"updateBitrateLimit"),Ct.prototype),rt(Ct.prototype,"remoteMediaSsrcChanged",[pi],Object.getOwnPropertyDescriptor(Ct.prototype,"remoteMediaSsrcChanged"),Ct.prototype),Ct);function pi(t,e,i){let n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=function(){return I(this,arguments,function*(){let r=this.mutex,o=yield r.lock("From P2PChannel.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return yield n.apply(this,a)}finally{o()}})},i}function VN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function FN(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?VN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):VN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let rq=Date.now(),oq=20,Mg=new Map,cp=new Map;function BN(t){return I(this,null,function*(){let e=Mg.get(t),i=Array.isArray(e)&&e[e.length-1],n=cp.get(t);if(!i)return void(n.isSyncing=!1);let r={uid:i.uid,payload:i.payload};n.firstRecvTs===0&&(n.firstRecvTs=i.recvTs,n.firstSendTs=i.sendTs);let o=i.sendTs-n.firstSendTs,s=o-(Date.now()-n.firstRecvTs);s>0&&(n.firstRecvTs=Date.now()-o);let a=i.mediaDelay+s;a<=0?(e.pop(),jN(i.context,r),a=0):a=Math.min(a,oq),setTimeout(()=>e.length&&BN(t),a)})}function jN(t,e){t.safeEmit(It.STREAM_MESSAGE,e.uid,e.payload),t.onStreamMessage&&t.onStreamMessage(e)}function sq(t){let e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:0,i=arguments.length>2?arguments[2]:void 0;if(!t.syncWithAudio)return jN(i,{uid:t.uid,payload:t.payload});let n="".concat(i.id,"-").concat(t.uid),r=Mg.get(n)||[],o=r.findIndex(d=>t.sendTs>=d.sendTs),s=FN(FN({},t),{},{context:i,mediaDelay:e,recvTs:Date.now()});o===-1?r.push(s):r.splice(o,0,s),Mg.set(n,r);let a=!1;var c;cp.has(n)?a=!((c=cp.get(n))===null||c===void 0||!c.isSyncing):cp.set(n,{isSyncing:a,firstRecvTs:0,firstSendTs:0}),a||BN(n)}let aq=kt().name;function GN(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function WN(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?GN(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):GN(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let cc="websdk_ng_cache_parameter",cq=A("MAX_PRELOAD_ASYNC_LENGTH"),dq=1e4,Ls=new Map,ks=[],Ug=null,xg=0,Vg=0,dp=new Map,lq=function(t,e){let i=[],n=0,r=()=>I(null,null,function*(){let o=i.shift();o&&(yield o()),i.length>0&&n<e?r():n--});return function(){return I(this,arguments,function*(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];return new Q((c,d)=>I(null,null,function*(){i.push(()=>I(null,null,function*(){try{let l=yield t(...s);c(l)}catch(l){d(l)}})),n<e&&(n++,r())}))})}}(HN,cq),Fg=bi.CancelToken.source();function HN(t,e,i,n,r,o){return I(this,null,function*(){try{if(!A("ENABLE_PRELOAD"))return;if(!Mt().supportWebCrypto)return void Mo(()=>{_.warn("Your browser does not support preloading, this feature  be run in a secure environment")},"preload_webcrypto_not_supported");if(!i&&i!==null)throw new F(C.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&Ke(i,"token",1,2047),Ke(t,"appid",1,2047),Bh(e),n&&jh(n);let s=Rs();_.debug("preload channel ".concat(e,", uid is ").concat(n));let a={appId:t,cname:e,token:i||t,uid:typeof n!="string"?n:null,sid:s,proxyServer:r},c,d;typeof n=="string"?(a.stringUid=n,[d,c]=yield Q.all([q6(n,{sid:s,appId:t},Fg.token),_N(WN(WN({},a),{},{token:i||t,uid:0}),Fg.token)]),a.uid=d.uid,c.gatewayInfo.uid=a.uid,c.gatewayInfo.res.uid=a.uid):(o&&(a.stringUid=o),c=yield _N(a,Fg.token));let l={sid:s,appId:t,cname:e,token:i||t,uid:a.stringUid||n,intUid:a.uid||c.gatewayInfo.uid,stringUid:a.stringUid,ts:Date.now(),sua:d,ap:c};yield function(u){return I(this,null,function*(){let h;try{u.uid&&qN({appId:u.appId,cname:u.cname,token:u.token,uid:u.uid,stringUid:u.stringUid});let p=JN(u),g=yield function(f,R){return I(this,null,function*(){try{let y=yield window.crypto.subtle.importKey("raw",VA(R),"AES-GCM",!1,["encrypt"]),N=yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:new Uint8Array(1)},y,Ts(window.btoa(JSON.stringify(f))));return Uo(new Uint8Array(N))}catch{return}})}(u,u.token||u.appId);if(!g)return;h=XN(cc);let E=h?JSON.parse(h):[];E.push({[p]:g}),E.length>A("AP_CACHE_NUM")&&E.shift(),lp(cc,JSON.stringify(E))}catch(p){_.warn("Error caching server parameters:",p.message),lp(cc,"")}})}(l),xg++}catch(s){throw Vg++,function(a){Ug||(Ug=window.setTimeout(()=>{let d="";dp.forEach((l,u)=>{d+="".concat(u,": ").concat(l," ;")}),ot.reportApiInvoke(null,{name:be.PRELOAD,options:{success:xg,failed:Vg,err:d}}).onError(a),xg=0,Vg=0,dp.clear(),Ug=null},dq));let c=dp.get(a.code)||0;dp.set(a.code,c+1)}(s),s}})}function KN(t){return I(this,null,function*(){try{if(A("AP_REQUEST_DETAIL")||A("ENABLE_ROLE_SELECT_EDGE"))return;let e=qN(t);if(!e||t.cloudProxyServer!=="disabled")return;let i=yield function(n,r){return I(this,null,function*(){try{let o=yield window.crypto.subtle.importKey("raw",VA(r),"AES-GCM",!1,["decrypt"]),s=yield window.crypto.subtle.decrypt({name:"AES-GCM",iv:new Uint8Array(1)},o,Ts(n));return JSON.parse(window.atob(Uo(new Uint8Array(s))))}catch{return}})}(e,t.token||t.appId);if(!i||!function(n,r){return n.cname===r.cname&&n.appId===r.appId&&n.token===r.token?r.stringUid?n.stringUid===r.stringUid:typeof r.uid=="number"?n.uid===r.uid:n.uid==r.uid:!1}(i,t))return;if(i&&Date.now()-i.ts<A("AP_CACHE_LIFETIME"))return i}catch(e){_.warn("Error get preloadInfo",e.message)}})}function qN(t){let e;try{if(e=XN(cc),!e)return;let i=JSON.parse(e),n=JN(t),r=function(s,a){for(let c=s.length-1;c>=0;c--)if(a(s[c]))return c;return-1}(i,s=>n in s);if(r===-1)return;let o=i.splice(r,1)[0];return lp(cc,JSON.stringify(i)),o[n]}catch(i){_.warn("Error delete preload info: ".concat(e),i.message),lp(cc,"")}}function Bg(t){if(t){let e=Ls.get(t);e&&(window.clearTimeout(e),e=null,Ls.delete(t)),z(ks).call(ks,t)||t.cloudProxyServer!=="disabled"||ks.push(t)}if(Ls.size<A("AP_CACHE_NUM")&&ks.length>0){let e=ks.shift();Ls.set(e,window.setTimeout(()=>I(null,null,function*(){let{appId:i,cname:n,token:r,stringUid:o,uid:s,proxyServer:a}=e;try{yield lq(i,n,r,s,a,o),Ls.has(e)&&Bg(e)}catch(c){_.warn("update preload failed",c.message),YN(e)}}),A("AP_UPDATE_INTERVAL")))}}function YN(t){let e=ks.indexOf(t);e!==-1&&ks.splice(e,1);let i=Ls.get(t);i&&(window.clearTimeout(i),i=null,Ls.delete(t),Bg())}function zN(t,e){let i=t.sua,n=t.ap;e&&i&&ot.reqUserAccount(t.sid,{lts:i.requestTime,elapse:i.elapse,success:!0,serverAddr:i.url,stringUid:e,uid:t.intUid,errorCode:null,extend:i.req}),ot.reportResourceTiming(t.ap.url,t.sid),ot.joinWebProxyAP(t.sid,{lts:n.requestTime,elapse:n.elapse,sucess:1,apServerAddr:n.url,turnServerAddrList:n.proxyInfo.addresses.map(r=>r.ip).join(","),eventType:"disabled",unilbsServerIds:[Ae.CHOOSE_SERVER,Ae.CLOUD_PROXY_FALLBACK].toString()}),ot.joinChooseServer(t.sid,{lts:n.requestTime,elapse:n.elapse,succ:!0,csAddr:n.url,opid:n.opid,serverList:n.gatewayInfo.gatewayAddrs.map(r=>r.address),ec:null,cid:n.gatewayInfo.cid.toString(),uid:n.gatewayInfo.uid.toString(),csIp:n.gatewayInfo.csIp,unilbsServerIds:[Ae.CHOOSE_SERVER].toString(),isHttp3:n.isHttp3})}function XN(t){return window.atob(window.localStorage.getItem(t)||"")}function lp(t,e){window.localStorage.setItem(t,window.btoa(e))}function JN(t){let e="".concat(t.appId,"_").concat(t.cname);return typeof t.uid=="string"&&(e+="_s_".concat(t.uid)),typeof t.uid=="number"&&(e+="_".concat(t.uid)),t.token&&(e+="_".concat(t.token)),KA(e)}function uq(t){let e=function(){let i=_q.pop();return i?(i.offset=i.limit=0,i):{bytes:new Uint8Array(64),offset:0,limit:0}}();return function(i,n){let r=i.appId;r!==void 0&&(we(n,10),qo(n,r));let o=i.cid;o!==void 0&&(we(n,16),we(n,o));let s=i.cname;s!==void 0&&(we(n,26),qo(n,s));let a=i.deviceId;a!==void 0&&(we(n,34),qo(n,a));let c=i.elapse;c!==void 0&&(we(n,40),Yo(n,c));let d=i.fileSize;d!==void 0&&(we(n,48),Yo(n,dc(d)));let l=i.height;l!==void 0&&(we(n,56),Yo(n,dc(l)));let u=i.jpg;u!==void 0&&(we(n,66),we(n,u.length),ZN(n,u));let h=i.networkType;h!==void 0&&(we(n,72),Yo(n,dc(h)));let p=i.osType;p!==void 0&&(we(n,80),Yo(n,dc(p)));let g=i.requestId;g!==void 0&&(we(n,90),qo(n,g));let E=i.sdkVersion;E!==void 0&&(we(n,98),qo(n,E));let f=i.sequence;f!==void 0&&(we(n,104),Yo(n,dc(f)));let R=i.sid;R!==void 0&&(we(n,114),qo(n,R));let y=i.timestamp;y!==void 0&&(we(n,120),Yo(n,y));let N=i.uid;N!==void 0&&(we(n,128),we(n,N));let k=i.vid;k!==void 0&&(we(n,136),we(n,k));let L=i.width;L!==void 0&&(we(n,144),Yo(n,dc(L)));let P=i.service;P!==void 0&&(we(n,152),we(n,P));let V=i.callbackData;V!==void 0&&(we(n,162),we(n,V.length),ZN(n,V));let B=i.ticket;B!==void 0&&(we(n,170),qo(n,B));let Y=i.vendorConfigs;Y!==void 0&&(we(n,178),qo(n,Y))}(t,e),function(i){let n=i.bytes,r=i.limit;return n.length===r?n:n.subarray(0,r)}(e)}function hq(t){return function(i){let n={};t:for(;!mq(i);){let r=jd(i);switch(r>>>3){case 0:break t;case 1:n.code=jd(i);break;case 2:n.msg=$N(i,jd(i));break;case 3:n.requestId=$N(i,jd(i));break;case 4:n.timestamp=Eq(i,!1);break;default:pq(i,7&r)}}return n}({bytes:e=t,offset:0,limit:e.length});var e}function pq(t,e){switch(e){case 0:for(;128&jn(t););break;case 2:jg(t,jd(t));break;case 5:jg(t,4);break;case 1:jg(t,8);break;default:throw new Error("Unimplemented type: "+e)}}function dc(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let _q=[];function jg(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function mq(t){return t.offset>=t.limit}function up(t,e){let i=t.bytes,n=t.offset,r=t.limit,o=n+e;if(o>i.length){let s=new Uint8Array(2*o);s.set(i),t.bytes=s}return t.offset=o,o>r&&(t.limit=o),n}function QN(t,e){let i=t.offset;if(i+e>t.limit)throw new Error("Read past limit");return t.offset+=e,i}function ZN(t,e){let i=up(t,e.length);t.bytes.set(e,i)}function $N(t,e){let i=QN(t,e),n=String.fromCharCode,r=t.bytes,o="\uFFFD",s="";for(let a=0;a<e;a++){let c,d,l,u,h=r[a+i];(128&h)==0?s+=n(h):(224&h)==192?a+1>=e?s+=o:(c=r[a+i+1],(192&c)!=128?s+=o:(u=(31&h)<<6|63&c,u<128?s+=o:(s+=n(u),a++))):(240&h)==224?a+2>=e?s+=o:(c=r[a+i+1],d=r[a+i+2],(49344&(c|d<<8))!=32896?s+=o:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?s+=o:(s+=n(u),a+=2))):(248&h)==240?a+3>=e?s+=o:(c=r[a+i+1],d=r[a+i+2],l=r[a+i+3],(12632256&(c|d<<8|l<<16))!=8421504?s+=o:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?s+=o:(u-=65536,s+=n(55296+(u>>10),56320+(1023&u)),a+=3))):s+=o}return s}function qo(t,e){let i=e.length,n=0;for(let s=0;s<i;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<i&&(a=(a<<10)+e.charCodeAt(++s)-56613888),n+=a<128?1:a<2048?2:a<65536?3:4}we(t,n);let r=up(t,n),o=t.bytes;for(let s=0;s<i;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<i&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function jn(t){return t.bytes[QN(t,1)]}function tD(t,e){let i=up(t,1);t.bytes[i]=e}function jd(t){let e,i=0,n=0;do e=jn(t),i<32&&(n|=(127&e)<<i),i+=7;while(128&e);return n}function we(t,e){for(e>>>=0;e>=128;)tD(t,127&e|128),e>>>=7;tD(t,e)}function Eq(t,e){let i,n=0,r=0,o=0;return i=jn(t),n=127&i,128&i&&(i=jn(t),n|=(127&i)<<7,128&i&&(i=jn(t),n|=(127&i)<<14,128&i&&(i=jn(t),n|=(127&i)<<21,128&i&&(i=jn(t),r=127&i,128&i&&(i=jn(t),r|=(127&i)<<7,128&i&&(i=jn(t),r|=(127&i)<<14,128&i&&(i=jn(t),r|=(127&i)<<21,128&i&&(i=jn(t),o=127&i,128&i&&(i=jn(t),o|=(127&i)<<7))))))))),{low:n|r<<28,high:r>>>4|o<<24,unsigned:e}}function Yo(t,e){let i=e.low>>>0,n=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?n===0?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:r<128?9:10,s=up(t,o),a=t.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?n>>>21|128:n>>>21&127;case 7:a[s+6]=o!==7?n>>>14|128:n>>>14&127;case 6:a[s+5]=o!==6?n>>>7|128:n>>>7&127;case 5:a[s+4]=o!==5?128|n:127&n;case 4:a[s+3]=o!==4?i>>>21|128:i>>>21&127;case 3:a[s+2]=o!==3?i>>>14|128:i>>>14&127;case 2:a[s+1]=o!==2?i>>>7|128:i>>>7&127;case 1:a[s]=o!==1?128|i:127&i}}let eD={},iD={},hp=4294967296,nD=hp*hp,rD=nD/2,Gg=sD(0,!0),oD=sD(0),fq=lc(0,-2147483648,!1),gq=lc(-1,2147483647,!1),Sq=lc(-1,-1,!0);function sD(t,e){let i,n,r;return e?(r=0<=(t>>>=0)&&t<256)&&(n=iD[t],n)?n:(i=lc(t,0,!0),r&&(iD[t]=i),i):(r=-128<=(t|=0)&&t<128)&&(n=eD[t],n)?n:(i=lc(t,t<0?-1:0,!1),r&&(eD[t]=i),i)}function lc(t,e,i){return{low:0|t,high:0|e,unsigned:!!i}}function aD(t,e){if(isNaN(t))return e?Gg:oD;if(e){if(t<0)return Gg;if(t>=nD)return Sq}else{if(t<=-rD)return fq;if(t+1>=rD)return gq}return t<0?e?Gg:oD:lc(t%hp|0,t/hp|0,e)}function cD(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}class Wg extends ue{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;let i=this._connectionState;this._connectionState=e,this.emit(or.CONNECTION_STATE_CHANGE,e,i)}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this._qualityTimer&&(window.clearTimeout(this._qualityTimer),this._qualityTimer=null),this._quality>=1||(this._qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this._qualityRatio},6e4))}constructor(e){var i;super(),T(this,"name","AgoraRTCImageModeration"),T(this,"_connectionState",mn.CONNECTING),T(this,"_sequence",0),T(this,"_moderationStartTime",void 0),T(this,"_workerConnection",void 0),T(this,"_workerMessageLengthLimit",void 0),T(this,"_qualityRatio",void 0),T(this,"_connectInfo",void 0),T(this,"_cancelTokenSource",bi.CancelToken.source()),T(this,"_retryConfig",void 0),T(this,"_moderationInterval",void 0),T(this,"_moderationTimer",null),T(this,"_moderationMode",1),T(this,"_quality",1),T(this,"_qualityTimer",null),T(this,"_ticket",void 0),T(this,"_moderationIntervalMinimum",void 0),T(this,"_uploadFailedNum",0),T(this,"_uploadNum",0),T(this,"_uploadTimer",null),T(this,"_extraInfo",void 0),T(this,"_vendor",""),T(this,"_encoder",new TextEncoder),T(this,"_moderationId",void 0),T(this,"inspectImage",()=>{if(this.connectionState!==mn.CONNECTED)throw new x(C.OPERATION_ABORTED,"image moderation service connection status is ".concat(this.connectionState));this._moderationTimer&&(window.clearInterval(this._moderationTimer),this._moderationTimer=null),this._moderationTimer=window.setInterval(()=>{this.connectionState===mn.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._moderationId,"] Moderation State is not connected , "),this.connectionState)},this._moderationInterval<this._moderationIntervalMinimum?this._moderationIntervalMinimum:this._moderationInterval),this.requestToInspectImage()}),this._moderationId=te(5,"image-moderation-"),this._workerMessageLengthLimit=A("IMAGE_MODERATION_WORKER_MESSAGE_LENGTH_LIMIT"),this._moderationIntervalMinimum=A("IMAGE_MODERATION_INTERVAL_MINIMUM"),this._moderationInterval=(i=e.interval)!==null&&i!==void 0?i:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),this._qualityRatio=A("IMAGE_MODERATION_QUALITY_RATIO"),this._moderationStartTime=Number(Date.now()),this._workerConnection=new Nd("worker-"+this._moderationId,Oe),this.on(or.STATE_CHANGE,(n,r)=>{_.debug("[".concat(this._moderationId,"] Moderation operation :").concat(Za[n]," ").concat(r||""))}),this.handleWorkerEvents()}init(e,i){return I(this,null,function*(){this.emit(or.STATE_CHANGE,Za.CONNECT_AP),this._connectInfo=e;let n=this._cancelTokenSource.token;return this._retryConfig=i,new Q((r,o)=>{this.on(or.CONNECTION_STATE_CHANGE,(s,a)=>{s===mn.CONNECTED&&r()}),this.requestAP(e,n,i).then(s=>{this.connectWorker(s)}).catch(s=>{o(s)})})})}updateConfig(e){var i;this._moderationInterval=(i=e.interval)!==null&&i!==void 0?i:1e3,e.extraInfo&&(this._extraInfo=this._encoder.encode(e.extraInfo)),e.vendor&&(this._vendor=e.vendor),_.debug("[".concat(this._moderationId,"] updateConfig: ").concat(JSON.stringify(e))),this.connectionState===mn.CONNECTED&&this.inspectImage()}requestAP(e,i,n){return I(this,null,function*(){let r=A("WEBCS_DOMAIN").map(c=>"https://".concat(c,"/api/v1")),o=yield function(c,d,l,u){let{appId:h,areaCode:p,cname:g,sid:E,token:f,uid:R}=d;rc++;let y="moderation_plugin",N={service_name:y,json_body:JSON.stringify({appId:h,areaCode:p,cname:g,command:"allocateEdge",requestId:rc,seq:rc,sid:E,appToken:f,ts:Date.now(),uid:R+""})},k,L,P=c[0];return er(()=>I(null,null,function*(){k=Date.now();let V=yield sr(P,{data:N,cancelToken:l,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(L=Date.now()-k,V.code!==0){let J=new x(C.UNEXPECTED_RESPONSE,"moderation plugin ap error, code"+V.code,{retry:!0,responseTime:L});throw _.error(J.toString()),J}let B=JSON.parse(V.json_body);if(B.code!==200){let J=new x(C.UNEXPECTED_RESPONSE,"moderation plugin ap error, code: ".concat(B.code,", reason: ").concat(B.reason),{code:B.code,responseTime:L});throw _.error(J.toString()),J}if(!B.servers||!Array.isArray(B.servers)||B.servers.length===0){let J=new x(C.UNEXPECTED_RESPONSE,"moderation plugin ap empty server",{code:B.code,responseTime:L});throw _.error(J.toString()),J}if(!B.servers.some(J=>!!J.wss)){let J=new x(C.UNEXPECTED_RESPONSE,"moderation plugin ap empty port",{code:B.code,responseTime:L});throw _.error(J.toString()),J}let Y=A("IMAGE_MODERATION_WORKER_HOST");return{addressList:B.servers.map(J=>{let{address:yt,wss:Rt}=J;if(yt&&Rt)return"wss://".concat(yt.replace(/\./g,"-"),".").concat(Y,":").concat(Rt,"/moderation")}).filter(J=>!!J),workerToken:B.workerToken,vid:B.vid,ticket:B.appTicket,responseTime:L}}),(V,B)=>(ot.apworkerEvent(E,{success:!0,sc:200,serviceName:y,responseDetail:JSON.stringify(V.addressList),firstSuccess:B===0,responseTime:L,serverIp:c[B%c.length]}),!1),(V,B)=>(ot.apworkerEvent(E,{success:!1,sc:V.data&&V.data.code||200,serviceName:y,responseTime:L,serverIp:c[B%c.length]}),!!(V.code!==C.OPERATION_ABORTED&&V.code!==C.UNEXPECTED_RESPONSE||V.data&&V.data.retry)&&(P=c[(B+1)%c.length],!0)),u)}(r,e,i,n);this.emit(or.STATE_CHANGE,Za.AP_CONNECTED);let{addressList:s,ticket:a}=o;return this._ticket=a,s})}connectWorker(e){return I(this,null,function*(){this.emit(or.STATE_CHANGE,Za.CONNECT_WORKER),yield this._workerConnection.init(e,1e4)})}handleWorkerEvents(){this._workerConnection.on(Tt.CONNECTED,()=>I(this,null,function*(){this.emit(or.STATE_CHANGE,Za.WORKER_CONNECTED,this._workerConnection.url),this.connectionState=mn.CONNECTED})),this._workerConnection.on(Tt.CLOSED,()=>{this.connectionState=mn.CLOSED}),this._workerConnection.on(Tt.FAILED,()=>{this.connectionState=mn.CLOSED}),this._workerConnection.on(Tt.RECONNECTING,()=>{this.connectionState=this.connectionState===mn.CONNECTED?mn.RECONNECTING:mn.CONNECTING}),this._workerConnection.on(Tt.ON_MESSAGE,e=>I(this,null,function*(){if(e.data instanceof ArrayBuffer){let i=hq(new Uint8Array(e.data));A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("[".concat(this._moderationId,"] Response message for worker of image moderation "),JSON.stringify(i)),this._uploadNum++,i.code===void 0||i.code===0||(this._uploadFailedNum++,_.error("[".concat(this._moderationId,"] Error response from worke, code is ").concat(i.code,", msg is ").concat(i.msg)),this._uploadTimer||(this._uploadTimer=window.setTimeout(()=>{ot.reportApiInvoke(this._connectInfo.sid||null,{name:be.IMAGE_MODERATION_UPLOAD,options:[this._uploadFailedNum,this._uploadNum,i.code],tag:Ee.TRACER}).onError(new x(C.IMAGE_MODERATION_UPLOAD_FAILED,i.msg)),this._uploadTimer=null},A("IMAGE_MODERATION_UPLOAD_REPORT_INTERVAL"))))}else _.error("[".concat(this._moderationId,"] Unexpected message type from worker"))})),this._workerConnection.on(Tt.WILL_RECONNECT,(e,i,n)=>{e==="recover"&&n(e),n("tryNext")}),this._workerConnection.on(Tt.REQUEST_NEW_URLS,(e,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(i)})}static intToLong(e){return{low:e|=0,high:e>>31,unsigned:e>=0}}requestToInspectImage(){return I(this,null,function*(){let e=Ji(this,or.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void(A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being played can be inspected"));this._sequence++;let n=yield this.generateRequestData(e,i);this._workerConnection.sendMessage(n,!0,!0)}else A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")&&_.debug("Only the track being published can be inspected")})}generateRequestData(e,i){return I(this,null,function*(){let{appId:n,cname:r,cid:o,vid:s,sid:a,uid:c}=i,d=Date.now(),l=yield e.getCurrentFrameImage("image/jpeg",this.quality),u=yield kw(l,n,r),h=this._sequence+"-"+o+"-"+c+"-"+d+"-"+te(12,""),p={appId:n,cid:o,cname:r,deviceId:"",elapse:Wg.intToLong(Number(d-this._moderationStartTime)),fileSize:l.buffer.byteLength,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.23.4",sequence:this._sequence,sid:a,timestamp:aD(d),uid:c,vid:s,service:this._moderationMode,ticket:this._ticket,callbackData:this._extraInfo,vendorConfigs:this._vendor};this._extraInfo===void 0&&delete p.callbackData;let g=uq(p);if(g.byteLength<this._workerMessageLengthLimit){if(A("SHOW_IMAGE_MODERATION_WORKER_MESSAGE")){let E=function(f){for(var R=1;R<arguments.length;R++){var y=arguments[R]!=null?arguments[R]:{};R%2?cD(Object(y),!0).forEach(function(N){T(f,N,y[N])}):Object.getOwnPropertyDescriptors?Object.defineProperties(f,Object.getOwnPropertyDescriptors(y)):cD(Object(y)).forEach(function(N){Object.defineProperty(f,N,Object.getOwnPropertyDescriptor(y,N))})}return f}({},p);delete E.jpg,_.debug("[".concat(this._moderationId,"] Request message for worker of image moderation service: "),JSON.stringify(E))}return g}{let E=this.quality*this._qualityRatio;return this.quality=E,yield this.generateRequestData(e,{appId:n,cname:r,cid:o,vid:s,sid:a,uid:c})}})}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=bi.CancelToken.source(),this._workerConnection&&this._workerConnection.close(),this._moderationTimer&&window.clearInterval(this._moderationTimer),this._moderationTimer=null,this._uploadTimer&&window.clearTimeout(this._uploadTimer),this._uploadTimer=null,this.connectionState=mn.CLOSED,this.emit(or.STATE_CHANGE,Za.CLOSED)}}function dD(t){if(Xt(t.interval,"interval",1e3,1/0),t&&t.extraInfo&&t.extraInfo.length>1024)throw new x(C.INVALID_PARAMS,"config.extraInfo length cannot exceed 1024 bytes");if(t&&t.vendor&&t.vendor.length>1024)throw new x(C.INVALID_PARAMS,"config.vendor length cannot exceed 1024 bytes")}let Tq={name:"ImageModeration",create:function(t){let{config:e}=t;return dD(e),new Wg(e)}};var lD,uD,hD,pD,_D,mD,ED,fD,gD,SD,TD,RD,vD,yD,CD,bD,ID,AD,wD,OD,ND,DD,PD,LD,kD,MD,UD,xD,VD,FD,BD,jD,GD,WD,HD,KD,qD,YD,zD,XD,JD,Z;function QD(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Gn(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?QD(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):QD(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}ni.setLogger(_);let Rq=(lD=ut(),uD=ut({argsMap:(t,e)=>{if(!Array.isArray(e)){if(!(e instanceof Ha))return[e];e=[e]}return e.map(i=>i?Object(i).toString():"null")}}),hD=ut({argsMap:(t,e)=>(e||(e=[]),Array.isArray(e)||e.trackMediaType!==Wa.DATA?(Array.isArray(e)||(e=[e]),e.map(i=>i.getTrackId())):[e.getChannelId()])}),pD=ut({argsMap:(t,e,i,n)=>[typeof e=="object"?e.uid:e,i,n]}),_D=ut({argsMap:(t,e,i)=>[e,i]}),mD=ut({argsMap:(t,e)=>e.map(i=>{let{user:n,mediaType:r}=i;return[n?.uid,r]})}),ED=ut({argsMap:(t,e,i,n)=>[typeof e=="object"?e.uid:e,i,n]}),fD=ut({argsMap:(t,e)=>e.map(i=>{let{user:n,mediaType:r}=i;return{uid:n?.uid,mediaType:r}})}),gD=ut(),SD=ut(),TD=ut(),RD=ut(),vD=ut(),yD=ut(),CD=ut(),bD=ut(),ID=ut(),AD=ut(),wD=ut(),OD=ut(),ND=ut(),DD=ut(),PD=ut(),LD=ut({argsMap:(t,e)=>[e]}),kD=ut(),MD=ut(),UD=ut(),xD=ut(),VD=ut(),FD=ut(),BD=ut(),jD=ut(),GD=ut({argsMap:(t,e)=>(Array.isArray(e)||(e=[e]),[JSON.stringify(e)])}),WD=ut(),HD=ut(),KD=ut(),qD=ut(),YD=ut(),zD=ut(),XD=ut({reportResult:!0}),JD=ut(),Z=class extends ue{get connectionState(){return this._gateway.state}get remoteUsers(){return this._users}get localTracks(){return this._p2pChannel.getAllTracks(!0)}get uid(){return this._uid}get channelName(){return this._channelName}get localDataChannels(){return this._p2pChannel.getAllDataChannels()}get mode(){return this._config.mode}get role(){var t;return((t=this._config)===null||t===void 0?void 0:t.role)||"audience"}get codec(){return this._config.codec}get audioCodec(){return this._config.audioCodec||"opus"}get isStringUID(){return!!this._joinInfo&&!!this._joinInfo.stringUid}get __className__(){return"Client"}constructor(t,e){let i;if(super(),T(this,"store",void 0),T(this,"_uid",void 0),T(this,"_channelName",void 0),T(this,"_uintUid",void 0),T(this,"_users",[]),T(this,"_config",void 0),T(this,"_clientId",void 0),T(this,"_appId",void 0),T(this,"_sessionId",null),T(this,"_key",void 0),T(this,"_rtmConfig",{}),T(this,"_joinInfo",void 0),T(this,"_gateway",void 0),T(this,"_statsCollector",void 0),T(this,"_configDistribute",void 0),T(this,"_leaveMutex",void 0),T(this,"_publishMutex",void 0),T(this,"_renewTokenMutex",void 0),T(this,"_subscribeMutex",void 0),T(this,"_encryptionMode","none"),T(this,"_encryptionSecret",null),T(this,"_encryptionSalt",null),T(this,"_encryptDataStream",!1),T(this,"_encryptDataStreamKey",null),T(this,"_encryptDataStreamIv",null),T(this,"_proxyServer",void 0),T(this,"_turnServer",{servers:[],mode:"auto"}),T(this,"_cloudProxyServerMode","disabled"),T(this,"_isDualStreamEnabled",!1),T(this,"_defaultStreamFallbackType",void 0),T(this,"_lowStreamParameter",void 0),T(this,"_streamFallbackTypeCacheMap",new Map),T(this,"_remoteStreamTypeCacheMap",new Map),T(this,"_axiosCancelSource",bi.CancelToken.source()),T(this,"_audioVolumeIndicationInterval",void 0),T(this,"_networkQualityInterval",void 0),T(this,"_userOfflineTimeout",void 0),T(this,"_streamRemovedTimeout",void 0),T(this,"_liveTranscodeStreamingClient",void 0),T(this,"_liveRawStreamingClient",void 0),T(this,"_channelMediaRelayClient",void 0),T(this,"_networkQualitySensitivity","normal"),T(this,"_p2pChannel",void 0),T(this,"_useLocalAccessPoint",!1),T(this,"_setLocalAPVersion",void 0),T(this,"_joinAndNotLeaveYet",!1),T(this,"_numberOfJoinCount",0),T(this,"_remoteDefaultVideoStreamType",void 0),T(this,"_inspect",void 0),T(this,"_moderation",void 0),T(this,"_license",void 0),T(this,"_pendingPublishedUsers",[]),T(this,"ntpAlignErrorCount",0),T(this,"remoteInboundOffset",0),T(this,"_peerConnectionState",void 0),T(this,"_handleLocalTrackEnable",(r,o,s)=>{this.publish(r,!1).then(o).catch(s)}),T(this,"_handleLocalTrackDisable",(r,o,s)=>{this.unpublish(r).then(o).catch(s)}),T(this,"_handleUserOnline",r=>{if(A("BLOCK_LOCAL_CLIENT")&&Os(r.uid,this.channelName))return void _.debug("[".concat(r.uid,"] will be ignored in local"));this.isStringUID&&typeof r.uid!="string"&&_.error("[".concat(this._clientId,"] StringUID is Mixed with UintUID"));let o=this._users.find(s=>s.uid===r.uid);if(o)o._trust_in_room_=!0,o._is_pre_created&&(o._is_pre_created=!1,this.safeEmit(It.USER_JOINED,o));else{let s=new Ho(r.uid,r.uint_id||r.uid);this._users.push(s),_.debug("[".concat(this._clientId,"] user online"),r.uid),this.safeEmit(It.USER_JOINED,s)}}),T(this,"_handleUserOffline",r=>{if(A("BLOCK_LOCAL_CLIENT")&&Os(r.uid,this.channelName))return;let o=this._users.find(s=>s.uid===r.uid);o&&(this._handleRemoveStream(r),this._handleRemoveDataChannels(r),o._audio_pre_subscribed||o._video_pre_subscribed?o._is_pre_created=!0:mh(this._users,o),this._remoteStreamTypeCacheMap.delete(o.uid),this._streamFallbackTypeCacheMap.delete(o.uid),_.debug("[".concat(this._clientId,"] user offline"),r.uid,"reason:",r.reason),this.safeEmit(It.USER_LEAVED,o,r.reason))}),T(this,"_handleAddAudioOrVideoStream",(r,o,s,a,c,d,l)=>{if(A("BLOCK_LOCAL_CLIENT")&&Os(o,this.channelName))return;let u=this._users.find(p=>p.uid===o);if(!u)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(r)),this.store.subscribe(u.uid,r,void 0,void 0,void 0,Date.now());let h=r==="audio"?u.hasAudio:u.hasVideo;u._uintid||(u._uintid=c||o),r==="audio"?u._trust_audio_stream_added_state_=!0:u._trust_video_stream_added_state_=!0,r==="audio"?(u._audio_added_=!0,s!==void 0&&(u._audioSSRC=s),a!==void 0&&(u._cname=a),d&&(u._audioOrtc=d)):(u._video_added_=!0,s!==void 0&&(u._videoSSRC=s),a!==void 0&&(u._cname=a),l!==void 0&&(u._rtxSsrcId=l),d&&(u._videoOrtc=d)),(r==="audio"?u.hasAudio:u.hasVideo)&&!h&&(_.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published ").concat(r)),this.safeEmit(It.USER_PUBLISHED,u,r)),r==="video"?ot.onGatewayStream(this._sessionId,Fe.ON_ADD_VIDEO_STREAM,ce.ON_ADD_VIDEO_STREAM,{peer:c||o,ssrc:u._videoSSRC}):ot.onGatewayStream(this._sessionId,Fe.ON_ADD_AUDIO_STREAM,ce.ON_ADD_AUDIO_STREAM,{peer:c||o,ssrc:u._audioSSRC}),this._p2pChannel.remoteMediaSsrcChanged(u,r,s).then(p=>{if(p&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(u.uid," after rejoin because SSRC id changed.")),this._p2pChannel instanceof Bd))return this._p2pChannel.unsubscribe(u,r,!0).then(()=>this._subscribe(u,r,!0).catch(g=>{_.error("[".concat(this._clientId,"] resubscribe error"),g.toString())}))}),this._p2pChannel.hasPendingRemoteMedia(u,r)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(u.uid," after reconnect.")),this._subscribe(u,r,!0).catch(p=>{_.error("[".concat(this._clientId,"] resubscribe error"),p.toString())}))}),T(this,"_handleRemoveStream",r=>{if(A("BLOCK_LOCAL_CLIENT")&&Os(r.uid,this.channelName))return;let o=this._users.find(a=>a.uid===r.uid);if(!o)return void _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_stream)"));_.debug("[".concat(this._clientId,"] stream removed with uid ").concat(r.uid));let s=()=>{};o.hasAudio&&o.hasVideo?s=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(It.USER_UNPUBLISHED,o,"audio"),_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(It.USER_UNPUBLISHED,o,"video")}:o.hasVideo?s=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished video track")),this.safeEmit(It.USER_UNPUBLISHED,o,"video")}:o.hasAudio&&(s=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(o.uid," unpublished audio track")),this.safeEmit(It.USER_UNPUBLISHED,o,"audio")}),o._video_pre_subscribed||o._audio_pre_subscribed||(o._trust_audio_stream_added_state_=!0,o._trust_video_stream_added_state_=!0,o._audio_added_=!1,o._video_added_=!1,this._p2pChannel instanceof Bd&&this._p2pChannel.unsubscribe(o).then(a=>{if(a)return this._gateway.unsubscribe(a,o.uid)}),o._audioSSRC=void 0,o._videoSSRC=void 0,o._audioOrtc=void 0,o._videoOrtc=void 0,o._rtxSsrcId=void 0),ot.onGatewayStream(this._sessionId,Fe.ON_REMOVE_STREAM,ce.ON_REMOVE_STREAM,{peer:r.uint_id||r.uid}),s()}),T(this,"_handleSetStreamLocalEnable",(r,o,s)=>{if(A("BLOCK_LOCAL_CLIENT")&&Os(o,this.channelName))return;let a=this._users.find(l=>l.uid===o);if(!a)return void _.error("[".concat(this._clientId,"] can not find target user!(disable_local)"));_.debug("[".concat(this._clientId,"] local ").concat(r," ").concat(s?"enabled":"disabled"," with uid ").concat(o));let c=r==="audio"?a.hasAudio:a.hasVideo;if(r==="audio"){a._trust_audio_enabled_state_=!0;let l=a._audio_enabled_;if(a._audio_enabled_=s,a._audio_enabled_===l)return;{let u=a._audio_enabled_?"enable-local-audio":"disable-local-audio";_.debug("[".concat(this._clientId,"] user-info-updated, uid: ").concat(o,", msg: ").concat(u)),this.safeEmit(It.USER_INFO_UPDATED,o,u)}}else{a._trust_video_enabled_state_=!0;let l=a._video_enabled_;if(a._video_enabled_=s,a._video_enabled_===l)return;{let u=a._video_enabled_?"enable-local-video":"disable-local-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(o,", msg: ").concat(u)),this.safeEmit(It.USER_INFO_UPDATED,o,u)}}let d=r==="audio"?a.hasAudio:a.hasVideo;return c!==d?!c&&d?(_.info("[".concat(this._clientId,"] remote user ").concat(o," published ").concat(r)),void this.safeEmit(It.USER_PUBLISHED,a,r)):(r==="video"&&a._videoTrack&&a._videoTrack._destroy(),r==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,r),_.info("[".concat(this._clientId,"] remote user ").concat(o," unpublished ").concat(r)),void this.safeEmit(It.USER_UNPUBLISHED,a,r)):void 0}),T(this,"_handleMuteStream",(r,o,s)=>{if(A("BLOCK_LOCAL_CLIENT")&&Os(r,this.channelName))return;_.debug("[".concat(this._clientId,"] receive mute message"),r,o,s);let a=this._users.find(l=>l.uid===r);if(!a)return void _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r));let c=o==="audio"?a.hasAudio:a.hasVideo;if(o==="audio"){a._trust_audio_mute_state_=!0;let l=a._audio_muted_;if(a._audio_muted_=s,a._audio_muted_===l)return;{let u=a._audio_muted_?"mute-audio":"unmute-audio";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(It.USER_INFO_UPDATED,r,u)}}else{a._trust_video_mute_state_=!0;let l=a._video_muted_;if(a._video_muted_=s,a._video_muted_===l)return;{let u=a._video_muted_?"mute-video":"unmute-video";_.debug("[".concat(this._clientId,"] user-info-update, uid: ").concat(r,", msg: ").concat(u)),this.safeEmit(It.USER_INFO_UPDATED,r,u)}}let d=o==="audio"?a.hasAudio:a.hasVideo;if(c!==d){if(!c&&d)return(o==="audio"?a._audioSSRC:a._videoSSRC)?(_.info("[".concat(this._clientId,"] remote user ").concat(r," published ").concat(o)),void this.safeEmit(It.USER_PUBLISHED,a,o)):void _.warning("[".concat(this._clientId,"] remote user ").concat(r," receive ").concat(o," unmute message  before add stream message, ").concat(o," SSRC doesn't exist yet."));o==="video"&&a._videoTrack&&!a._video_pre_subscribed&&a._videoTrack._destroy(),o==="audio"&&a._audioTrack,this._p2pChannel.muteRemote(a,o),_.info("[".concat(this._clientId,"] remote user ").concat(r," unpublished ").concat(o)),this.safeEmit(It.USER_UNPUBLISHED,a,o)}}),T(this,"_handleP2PLost",r=>I(this,null,function*(){_.debug("[".concat(this._clientId,"] receive p2p lost"),r),parseInt(r.p2pid,10)===this.store.p2pId?yield this._p2pChannel.requestReconnect():_.warning("[".concat(this._clientId,"] P2PLost stream not found"),r)})),T(this,"_handleTokenWillExpire",()=>{_.debug("[".concat(this._clientId,"] received message onTokenPrivilegeWillExpire")),this.safeEmit(It.ON_TOKEN_PRIVILEGE_WILL_EXPIRE)}),T(this,"_handleBeforeUnload",r=>{r.type==="beforeunload"&&r.returnValue!==void 0&&r.returnValue!==""||(this.leave(),_.info("[".concat(this._clientId,"] auto leave onbeforeunload or pagehide")))}),T(this,"_handleUpdateNetworkQuality",()=>{if(this._networkQualitySensitivity==="normal")return;if(navigator&&navigator.onLine!==void 0&&!navigator.onLine)return void this.safeEmit(It.NETWORK_QUALITY,{downlinkNetworkQuality:6,uplinkNetworkQuality:6});let r={downlinkNetworkQuality:0,uplinkNetworkQuality:0};r.uplinkNetworkQuality=this._p2pChannel.getUplinkNetworkQuality(),r.downlinkNetworkQuality=this._p2pChannel.getDownlinkNetworkQuality(),this.safeEmit(It.NETWORK_QUALITY,r)}),T(this,"_handleP2PAddAudioOrVideoStream",(r,o,s,a)=>{let c=this._users.find(l=>l.uid===o);if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_stream)"));_.debug("[".concat(this._clientId,"] stream added with uid ").concat(o,", type ").concat(r)),this.store.subscribe(c.uid,r,void 0,void 0,void 0,Date.now());let d=r==="audio"?c.hasAudio:c.hasVideo;r==="audio"?c._trust_audio_stream_added_state_=!0:c._trust_video_stream_added_state_=!0,r==="audio"?(c._audio_added_=!0,s!==void 0&&(c._audioSSRC=s),a!==void 0&&(c._audioMid=a)):(c._video_added_=!0,s!==void 0&&(c._videoSSRC=s),a!==void 0&&(c._videoMid=a)),(r==="audio"?c.hasAudio:c.hasVideo)&&!d&&(_.info("[".concat(this._clientId,"] remote user ").concat(c.uid," published ").concat(r)),this.safeEmit(It.USER_PUBLISHED,c,r)),this._p2pChannel.hasPendingRemoteMedia(c,r)&&(_.debug("[".concat(this._clientId,"] resubscribe ").concat(r," for user ").concat(c.uid," after reconnect.")),this._subscribe(c,r,!0).catch(l=>{_.error("[".concat(this._clientId,"] resubscribe error"),l.toString())}))}),this._config=t,this._clientId=e||te(5,"client-"),this.store=new class{constructor(r,o,s,a){ft(this,"state",void 0),this.state={codec:r,audioCodec:o,mode:s,clientId:a,sessionId:null,p2pId:0,dcId:0,pubId:0,subId:0,keyMetrics:{publish:[],subscribe:[]},joinChannelServiceRecords:[],cloudProxyServerMode:"disabled",useP2P:!1,p2pTransport:vs.Default,hasStartJoinChannel:!1,isABTestSuccess:!1}}dispatch(r){this.state=function(o,s){switch(s.type){case Ot.SET_SESSION_ID:return tt(tt({},o),{},{sessionId:s.sessionId});case Ot.SET_P2P_ID:return tt(tt({},o),{},{p2pId:s.p2pId});case Ot.SET_UID:return tt(tt({},o),{},{uid:s.uid});case Ot.SET_INT_UID:return tt(tt({},o),{},{intUid:s.intUid});case Ot.SET_PUB_ID:return tt(tt({},o),{},{pubId:s.pubId});case Ot.KEY_METRIC_CLIENT_CREATED:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{clientCreated:s.metric})});case Ot.KEY_METRIC_JOIN_START:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{joinStart:s.metric})});case Ot.KEY_METRIC_JOIN_END:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{joinEnd:s.metric})});case Ot.KEY_METRIC_REQUEST_AP_START:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{requestAPStart:s.metric})});case Ot.KEY_METRIC_REQUEST_AP_END:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{requestAPEnd:s.metric})});case Ot.KEY_METRIC_JOIN_GATEWAY_START:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{joinGatewayStart:s.metric})});case Ot.KEY_METRIC_JOIN_GATEWAY_END:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{joinGatewayEnd:s.metric})});case Ot.KEY_METRIC_PEER_CONNECTION_START:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{peerConnectionStart:s.metric})});case Ot.KEY_METRIC_PEER_CONNECTION_END:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{peerConnectionEnd:s.metric})});case Ot.KEY_METRIC_DESCRIPTION_START:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{descriptionStart:s.metric})});case Ot.KEY_METRIC_SIGNAL_CHANNEL_OPEN:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{signalChannelOpen:s.metric})});case Ot.KEY_METRIC_ICE_CONNECTION_END:return tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{iceConnectionEnd:s.metric})});case Ot.KEY_METRIC_PUBLISH:{let a=o.keyMetrics.publish,c=a.findIndex(d=>d.trackId===s.metric.trackId);return c!==-1?(a[c]=tt(tt({},a[c]),s.metric),tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{publish:[...a]})})):tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{publish:[...o.keyMetrics.publish,s.metric]})})}case Ot.KEY_METRIC_SUBSCRIBE:{let a=o.keyMetrics.subscribe,c=a.findIndex(d=>d.userId===s.metric.userId&&d.type===s.metric.type);return c!==-1?(a[c]=tt(tt({},a[c]),s.metric),tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{subscribe:[...a]})})):tt(tt({},o),{},{keyMetrics:tt(tt({},o.keyMetrics),{},{subscribe:[...o.keyMetrics.subscribe,s.metric]})})}case Ot.SET_CLOUD_PROXY_SERVER_MODE:return o.cloudProxyServerMode=s.mode,o;case Ot.RECORD_JOIN_CHANNEL_SERVICE:return typeof s.index!="number"?o.joinChannelServiceRecords=[...o.joinChannelServiceRecords,s.record]:(o.joinChannelServiceRecords[s.index]=tt(tt({},o.joinChannelServiceRecords[s.index]),s.record),o.joinChannelServiceRecords=[...o.joinChannelServiceRecords]),o;case Ot.RESET_JOIN_CHANNEL_SERVICE_RECORDS:return o.joinChannelServiceRecords=[],o;case Ot.RESET_KEY_METRICS:return o.keyMetrics={publish:[],subscribe:[]},o;case Ot.SET_USE_P2P:return tt(tt({},o),{},{useP2P:s.val});case Ot.SET_TRANSPORT_TYPE:return tt(tt({},o),{},{p2pTransport:s.val});default:return o}}(this.state,r)}set sessionId(r){this.dispatch({type:Ot.SET_SESSION_ID,sessionId:r})}get sessionId(){return this.state.sessionId}set cid(r){this.state.cid=r}get cid(){return this.state.cid}set codec(r){this.state.codec=r}get codec(){return this.state.codec}get mode(){return this.state.mode}get audioCodec(){return this.state.audioCodec}get clientId(){return this.state.clientId}set p2pId(r){this.dispatch({type:Ot.SET_P2P_ID,p2pId:r})}get p2pId(){return this.state.p2pId}set dcId(r){this.dispatch({type:Ot.SET_DC_ID,dcId:r})}get dcId(){return this.state.dcId}set uid(r){this.dispatch({type:Ot.SET_UID,uid:r})}get uid(){return this.state.uid}set intUid(r){this.dispatch({type:Ot.SET_INT_UID,intUid:r})}get intUid(){return this.state.intUid}set pubId(r){this.dispatch({type:Ot.SET_PUB_ID,pubId:r})}get pubId(){return this.state.pubId}set cloudProxyServerMode(r){this.dispatch({type:Ot.SET_CLOUD_PROXY_SERVER_MODE,mode:r})}get cloudProxyServerMode(){return this.state.cloudProxyServerMode}set useP2P(r){this.dispatch({type:Ot.SET_USE_P2P,val:r})}get useP2P(){return this.state.useP2P}set p2pTransport(r){this.dispatch({type:Ot.SET_TRANSPORT_TYPE,val:r})}get p2pTransport(){return this.state.p2pTransport}set hasStartJoinChannel(r){this.state.hasStartJoinChannel=r}get hasStartJoinChannel(){return this.state.hasStartJoinChannel}set isABTestSuccess(r){this.state.isABTestSuccess=r}get isABTestSuccess(){return this.state.isABTestSuccess}clientCreated(){this.dispatch({type:Ot.KEY_METRIC_CLIENT_CREATED,metric:Date.now()})}joinStart(){this.dispatch({type:Ot.KEY_METRIC_JOIN_START,metric:Date.now()})}joinEnd(){this.dispatch({type:Ot.KEY_METRIC_JOIN_END,metric:Date.now()})}requestAPStart(){this.dispatch({type:Ot.KEY_METRIC_REQUEST_AP_START,metric:Date.now()})}requestAPEnd(){this.dispatch({type:Ot.KEY_METRIC_REQUEST_AP_END,metric:Date.now()})}joinGatewayStart(){this.dispatch({type:Ot.KEY_METRIC_JOIN_GATEWAY_START,metric:Date.now()})}joinGatewayEnd(){this.dispatch({type:Ot.KEY_METRIC_JOIN_GATEWAY_END,metric:Date.now()})}peerConnectionStart(){this.dispatch({type:Ot.KEY_METRIC_PEER_CONNECTION_START,metric:Date.now()})}peerConnectionEnd(){this.dispatch({type:Ot.KEY_METRIC_PEER_CONNECTION_END,metric:Date.now()})}descriptionStart(){this.dispatch({type:Ot.KEY_METRIC_DESCRIPTION_START,metric:Date.now()})}signalChannelOpen(){this.dispatch({type:Ot.KEY_METRIC_SIGNAL_CHANNEL_OPEN,metric:Date.now()})}iceConnectionEnd(){this.dispatch({type:Ot.KEY_METRIC_ICE_CONNECTION_END,metric:Date.now()})}publish(r,o,s,a){this.dispatch({type:Ot.KEY_METRIC_PUBLISH,metric:tt(tt({trackId:r,type:o},s&&{publishStart:s}),a&&{publishEnd:a})})}subscribe(r,o,s,a,c,d,l){this.dispatch({type:Ot.KEY_METRIC_SUBSCRIBE,metric:tt(tt(tt(tt(tt({userId:r,type:o},s&&{subscribeStart:s}),a&&{subscribeEnd:a}),c&&{firstFrame:c}),d&&{streamAdded:d}),l&&{firstDecoded:l})})}massSubscribe(r,o,s,a){r.forEach(c=>{this.dispatch({type:Ot.KEY_METRIC_SUBSCRIBE,metric:tt(tt(tt({userId:c.userId,type:c.type},o&&{subscribeStart:o}),s&&{subscribeEnd:s}),a&&{firstFrame:a})})})}get keyMetrics(){return this.state.keyMetrics}recordJoinChannelService(r,o){r.service==="gateway"&&Array.isArray(r.urls)&&(r.urls=r.urls.map(s=>s.replace(/(\d+)-\d+-\d+-(\d+)/,"$1-*-*-$2")));try{return typeof o!="number"?(this.dispatch({type:Ot.RECORD_JOIN_CHANNEL_SERVICE,record:tt(tt({},r),{},{sessionId:this.sessionId,cloudProxyMode:this.cloudProxyServerMode,uid:this.uid})}),this.state.joinChannelServiceRecords.length-1):(o<0||o>=this.state.joinChannelServiceRecords.length||this.dispatch({type:Ot.RECORD_JOIN_CHANNEL_SERVICE,record:r,index:o}),o)}catch{return 0}}resetJoinChannelServiceRecords(){this.dispatch({type:Ot.RESET_JOIN_CHANNEL_SERVICE_RECORDS})}resetKeyMetrics(){this.dispatch({type:Ot.RESET_KEY_METRICS})}get joinChannelServiceRecords(){try{return this.state.joinChannelServiceRecords}catch{return[]}}}(t.codec,t.audioCodec,t.mode,this._clientId),this._leaveMutex=new ni("client-leave",this._clientId),this._publishMutex=new ni("client-publish",this._clientId),this._renewTokenMutex=new ni("client-renewtoken",this._clientId),this._subscribeMutex=new ni("client-subscribe",this._clientId),this.store.clientCreated(),t.proxyServer&&this.setProxyServer(t.proxyServer,!0),t.turnServer&&this.setTurnServer(t.turnServer,!0),_.info("[".concat(this._clientId,"] Initializing AgoraRTC client v").concat(hn," build: ").concat(Lf,", mode: ").concat(this.mode,", codec: ").concat(this.codec)),t.clientRoleOptions)try{Sf(t.clientRoleOptions),i=Object.assign({},t.clientRoleOptions)}catch(r){_.warning("[".concat(this._clientId,"] ").concat(r.toString()))}var n;this._statsCollector=new xd(this.store),this._statsCollector.onStatsException=(r,o,s)=>{_.warn("[".concat(this._clientId,"] receive exception msg, code: ").concat(r,", msg: ").concat(o,", uid: ").concat(s)),this.safeEmit(It.EXCEPTION,{code:r,msg:o,uid:s})},this._statsCollector.onUploadPublishDuration=(r,o,s,a)=>{let c=this._users.find(d=>d.uid===r);c&&ot.peerPublishStatus(this._sessionId,{subscribeElapse:a,audioPublishDuration:o,videoPublishDuration:s,peer:c._uintid})},this._statsCollector.onVideoCodecChanged=r=>{if(A("VIDEO_STANDARD_BITRATE_VERSION")&&(r==="av1"||r==="h265"||r==="h264")){let o=this.localTracks.find(s=>s instanceof re);o&&o._saveEncodeBitrateRatio!==1&&o.setSaveEncodeBitrateRatio(r==="h264"?A("BASELINE_MORE_H264_BITRATE_RATIO"):void 0)}},this.store.useP2P=t.mode==="p2p",this._gateway=new B6(this.store,{clientId:this._clientId,mode:this.mode,codec:this.codec,websocketRetryConfig:t.websocketRetryConfig||Oe,httpRetryConfig:t.httpRetryConfig||Oe,forceWaitGatewayResponse:t.forceWaitGatewayResponse===void 0||t.forceWaitGatewayResponse,statsCollector:this._statsCollector,role:t.role,clientRoleOptions:i}),this._configDistribute=new J6(this._clientId,this.store),this.store.useP2P?(this._p2pChannel=(n={store:this.store,statsCollector:this._statsCollector},no("P2PChannel").create(n)),this._handleP2PEvents()):this._p2pChannel=new Bd(this.store,this._statsCollector),this._handleP2PChannelEvents(),this._handleGatewayEvents(),this._handleGatewaySignalEvents()}joinMeta(o,s,a,c,d){return I(this,arguments,function*(t,e,i,n,r){let l=!(arguments.length>5&&arguments[5]!==void 0)||arguments[5],u=arguments.length>6&&arguments[6]!==void 0&&arguments[6];qt("JOIN_GATEWAY_USE_443PORT_ONLY",l),qt("JOIN_GATEWAY_USE_DUAL_DOMAIN",u);let h=this._gateway.signal.websocket;return h instanceof pg&&(h.use443PortOnly=l,h.tryDoubleDomain=u),function(f,R,y){return I(this,arguments,function*(p,g,E){lh.get(p)||lh.set(p,[]),uh.get(p)||uh.set(p,g),Rr.get(p)||Rr.set(p,0);let N=lh.get(p),k=uh.get(p);if(!N||!k)throw new Error("concurrent: deferQueue or maxConcurrency is null");if(Rr.get(p)===k){let Y=pd();N.push(Y),yield Y.promise}Rr.set(p,Rr.get(p)+1);for(var L=arguments.length,P=new Array(L>3?L-3:0),V=3;V<L;V++)P[V-3]=arguments[V];let B=yield E(...P);return Rr.set(p,Rr.get(p)-1),Rr.get(p)===k-1&&N.length>0&&(N[0].resolve(),N.shift()),Rr.get(p)===0&&(lh.set(p,[]),uh.set(p,0),Rr.set(p,0)),B})}("client.join",A("JOIN_MAX_CONCURRENCY"),this.join.bind(this),t,e,i,n,r)})}join(t,e,i,n,r){return I(this,null,function*(){let o=++this._numberOfJoinCount;this.store.joinStart(),n&&(this.store.uid=n);let s=(gh||gh||(gh=(window.location.protocol.split(":")[0]||"").toUpperCase(),gh))==="HTTPS",a=zA()?window.isSecureContext:"Browser Not Support";(!zA()&&!s||!window.isSecureContext)&&_.warning("The website must be running in a secure context (About secure context: https://developer.mozilla.org/en-US/docs/Web/Security/Secure_Contexts ), otherwise the media collection will be restricted by the browser"),ot.setAppId(t);try{if(!i&&i!==null)throw new x(C.INVALID_PARAMS,"Invalid token: ".concat(i,". If you don not use token, set it to null"));i&&Ke(i,"token",1,2047),Ke(t,"appid",1,2047),Bh(e),n&&jh(n),r&&Ke(r,"optionalInfo",1,2047)}catch(E){throw ot.reportApiInvoke(Rs(),{name:be.JOIN,options:[t,e,i,n],states:{isHttps:s,isSecureContext:a},tag:Ee.TRACER}).onError(E),E}if(this._leaveMutex.isLocked&&(_.debug("[".concat(this._clientId,"] join: waiting leave operation")),(yield this._leaveMutex.lock())(),_.debug("[".concat(this._clientId,"] join: continue"))),this._joinAndNotLeaveYet=!0,this.connectionState!=="DISCONNECTED"){let E=new x(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already in connecting/connected state"));throw ot.reportApiInvoke(Rs(),{name:be.JOIN,options:[t,e,i,n],states:{isHttps:s,isSecureContext:a},tag:Ee.TRACER}).onError(E),E}this._gateway.state="CONNECTING";let c=yield KN({appId:t,cname:e,uid:n,stringUid:typeof n=="string"?n:void 0,token:i||t,cloudProxyServer:this._cloudProxyServerMode});if(!this._joinAndNotLeaveYet)throw new x(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));let d=c?.sid||Rs();_.info("[".concat(this._clientId,"] start join channel ").concat(e,", join number: ").concat(o)),this._sessionId||(this._sessionId=d,this.store.sessionId=this._sessionId);let l=ot.reportApiInvoke(d,{id:this._clientId,name:be.JOIN,options:[t,e,i,n],states:{isHttps:s,isSecureContext:a},tag:Ee.TRACER}),u=Gn(Gn(Gn({},this._rtmConfig),{},{role:this.role,clientId:this._clientId,appId:t,sid:this._sessionId,cname:e,uid:typeof n!="string"?n:null,turnServer:this._turnServer,proxyServer:this._proxyServer,token:i||t,cloudProxyServer:this._cloudProxyServerMode,optionalInfo:r,license:this._license,useLocalAccessPoint:this._useLocalAccessPoint,preload:!!c},this._remoteDefaultVideoStreamType!==void 0&&{defaultVideoStream:this._remoteDefaultVideoStreamType}),{},{apRequestDetail:A("AP_REQUEST_DETAIL")||void 0});if(this._useLocalAccessPoint&&(u.setLocalAPVersion=this._setLocalAPVersion),typeof n=="string"&&(u.stringUid=n,this._uintUid?(u.uid=this._uintUid,this._uintUid=void 0):u.uid=0),this._encryptionMode!=="none"&&this._encryptionSecret){if(u.aesmode=this._encryptionMode,u.aespassword=yield(E=>I(this,null,function*(){let f=function(k){let L=window.atob(`MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQDCMnXAHkKIGAM+x4N22gCI+Wyu
STM9ztkT3uYslTT2PuKmZfPzhH6kVdO7PTjGCOZnAsyb3oTtWat0KcxQ4jxvqQV+
HvYl3iI1Yd4vl2c3qRMJPLtRDfNxa2Mcxgq7e9aEUibzdd0st+OJAy3tOj/Y0aVy
xQiYDz3vqa6bP29adwIDAQAB`),P=new Uint8Array(new ArrayBuffer(L.length));for(let V=0;V<L.length;V+=1)P[V]=L.charCodeAt(V);return P}(),R=yield window.crypto.subtle.importKey("spki",f,{name:"RSA-OAEP",hash:"SHA-256"},!0,["encrypt"]),y=ff(E),N=yield window.crypto.subtle.encrypt({name:"RSA-OAEP"},R,y);return function(k){let L="";for(let P=0;P<k.length;P+=1)L+=String.fromCharCode(k[P]);return window.btoa(L)}(new Uint8Array(N))}))(this._encryptionSecret),!this._joinAndNotLeaveYet)throw new x(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));this._encryptionSalt&&(u.aessalt=this._encryptionSalt)}if(this._encryptDataStream&&(this._encryptionMode==="aes-128-gcm2"||this._encryptionMode==="aes-256-gcm2"))if(this._encryptionSalt&&this._encryptionSecret)if(window.crypto.subtle){let E=new TextEncoder,f=A("USE_PURE_ENCRYPTION_MASTER_KEY")?E.encode(u.appId+this._encryptionSecret+this._encryptionSecret):E.encode(u.appId+u.cname+this._encryptionSecret);this._encryptDataStreamIv=yield function(R,y,N){return I(this,null,function*(){let k=yield window.crypto.subtle.importKey("raw",y,"PBKDF2",!1,["deriveBits","deriveKey"]),L=R==="aes-128-gcm2"?128:256,P=yield window.crypto.subtle.deriveBits({name:"PBKDF2",iterations:rw,hash:"SHA-256",salt:N},k,L+mK);return new Uint8Array(P).subarray(L/8)})}(this._encryptionMode,f,Ts(this._encryptionSalt)),this._encryptDataStreamKey=yield function(R,y,N){return I(this,null,function*(){let k=yield window.crypto.subtle.importKey("raw",y,"PBKDF2",!1,["deriveBits","deriveKey"]),L=R==="aes-128-gcm2"?128:256;return yield window.crypto.subtle.deriveKey({name:"PBKDF2",iterations:rw,hash:"SHA-256",salt:N},k,{name:"AES-GCM",length:L},!0,["encrypt","decrypt"])})}(this._encryptionMode,f,Ts(this._encryptionSalt))}else a?_.warning("[".concat(this._clientId,"] encrypt datastream must be running in a secure context, fallback to plain data stream")):_.warning("[".concat(this._clientId,"] current browser do not support WebCrypto ,fallback to plain data stream")),this._encryptDataStream=!1;else this._encryptDataStream=!1,_.debug("[".concat(this._clientId,"] no salt / secret, cannot support encrypt data stream, fallback to plain data stream"));this._startSession(this._sessionId,{channel:e,appId:t,stringUid:u.stringUid});let h=this._sessionId;setTimeout(()=>{this.connectionState==="CONNECTING"&&h===this._sessionId&&ot.joinChannelTimeout(this._sessionId,5)},5e3);try{var p;let E,f=u.cloudProxyServer;if(z(p=["proxy3","proxy4","proxy5"]).call(p,f)){let L=A("PROXY_SERVER_TYPE3");Array.isArray(L)?u.proxyServer=L[0]:u.proxyServer=L}if(ot.setProxyServer(u.proxyServer),_.setProxyServer(u.proxyServer),this.store.requestAPStart(),c){if(_.debug("[".concat(this._clientId,"] get serverInfo Success from Preload Cache ").concat(u.stringUid?", ".concat(u.stringUid," => ").concat(c.intUid):""," ")),u.stringUid&&!u.uid&&(u.uid=c.intUid),E={gatewayInfo:c.ap.gatewayInfo},A("JOIN_WITH_FALLBACK_MEDIA_PROXY")&&u.turnServer.mode==="auto")if(c.ap.proxyInfo.addresses.length===0)_.warning("no edge services in ap response of proxy fallback, will not set proxy in iceServers");else{let L=(yield FO(c.ap.proxyInfo,c.ap.gatewayInfo.uid)).map(P=>({turnServerURL:P.address,tcpport:P.tcpport||ti.tcpport,udpport:P.udpport||ti.udpport,username:P.username||ti.username,password:P.password||ti.password,forceturn:!1,security:!0}));u.turnServer={mode:"manual",servers:L}}zN(c,u.stringUid)}else{if(u.stringUid&&!u.uid){let L;[L,E]=yield Q.all([pN(u.stringUid,u,this._axiosCancelSource.token,this._config.httpRetryConfig||Oe,this.store),hN(u,this._axiosCancelSource.token,this._config.httpRetryConfig||Oe,!0,this.store)]),_.debug("[".concat(this._clientId,"] getUserAccount Success ").concat(u.stringUid," => ").concat(L)),u.uid=L,E.gatewayInfo.uid=L,E.gatewayInfo.res.uid=L}else E=yield hN(u,this._axiosCancelSource.token,this._config.httpRetryConfig||Oe,!0,this.store);if(!this._joinAndNotLeaveYet)throw new x(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"))}this.store.requestAPEnd(),setTimeout(()=>{this._configDistribute.startGetConfigDistribute(u,this._axiosCancelSource.token),this._configDistribute.on(wd.UPDATE_BITRATE_LIMIT,L=>{this._p2pChannel.updateBitrateLimit(L)}),this._configDistribute.on(wd.UPDATE_CLIENT_ROLE_OPTIONS,L=>{this._setClientRoleOptions(L)})},0),this._key=i||t;let R=E.gatewayInfo,y=u.uid?u.uid:R.uid;this._joinInfo=Gn(Gn({},u),{},{cid:R.cid,uid:y,vid:R.vid,apResponse:R.res,apGatewayAddress:R.apGatewayAddress,uni_lbs_ip:R.uni_lbs_ip,gatewayAddrs:R.gatewayAddrs}),this.store.intUid=y,this.store.cid=R.cid;let N=yield this._joinGateway();if(!this._joinAndNotLeaveYet)throw new x(C.INVALID_OPERATION,"[".concat(this._clientId,"] Client already left"));l.onSuccess(N),this._appId=t,this._channelName=u.cname,this._uid=N,this.store.uid=N,setTimeout(()=>{this._networkQualityInterval&&window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=window.setInterval(this._handleUpdateNetworkQuality,2e3),window.addEventListener(Qe()?"beforeunload":"pagehide",this._handleBeforeUnload),this._statsCollector.startUpdateStats()},0);let k=u.stringUid?"string uid: ".concat(u.stringUid,",uid: ").concat(u.uid):"uid: ".concat(this._uid);return _.info("[".concat(this._clientId,"] Joining channel success: channel: ").concat(e,",").concat(k)),setTimeout(()=>{_.startUpload()},5e3),this.store.joinEnd(),g=this,z(ws).call(ws,g)||ws.push(g),this._cloudProxyServerMode==="disabled"&&Mt().supportWebCrypto&&A("ENABLE_PRELOAD")&&Bg(this._joinInfo),N}catch(E){let f=Array.isArray(E)?E[0]:E;throw f&&f.code===C.OPERATION_ABORTED?_.warning("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),f):_.error("[".concat(this._clientId,"] join number: ").concat(o,", Joining channel failed, rollback"),f),f.code!==C.OPERATION_ABORTED&&this._numberOfJoinCount===o&&(this._gateway.state="DISCONNECTED",this._reset()),l.onError(f),f}var g})}_joinGateway(){if(!this._joinInfo||!this._key)throw new x(C.INVALID_OPERATION);return this._gateway.join(this._joinInfo,this._key,!(this._joinInfo.cloudProxyServer!=="disabled"||this._joinInfo.proxyServer||!A("JOIN_WITH_FALLBACK_SIGNAL_PROXY")))}leave(){return I(this,null,function*(){_.info("[".concat(this._clientId,"] Leaving channel")),window.removeEventListener(Qe()?"beforeunload":"pagehide",this._handleBeforeUnload),this._reset(),function(e){let i=ws.indexOf(e);i!==-1&&ws.splice(i,1)}(this),this._statsCollector.stopUpdateStats();let t=yield this._leaveMutex.lock();if(this.connectionState==="DISCONNECTED")return _.info("[".concat(this._clientId,"] Leaving channel repeated, success")),void t();yield this._gateway.leave(this.connectionState!=="CONNECTED",Ft.LEAVE),_.info("[".concat(this._clientId,"] Leaving channel success")),this._joinAndNotLeaveYet=!1,this.store.resetJoinChannelServiceRecords(),t()})}publish(e){return I(this,arguments,function*(t){let i=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!Array.isArray(t)){if(!(t instanceof Ha))return this._publishDataChannel(t);t=[t]}if(t.length===0)throw new x(C.INVALID_PARAMS,"param list is empty");let n=t;if(this._gateway.role==="audience")throw new x(C.INVALID_OPERATION,"audience can not publish stream");for(let o of n){if(!(o instanceof Ha))throw new x(C.INVALID_PARAMS,"parameter is not local track");if(!o._enabled&&i)throw new x(C.TRACK_IS_DISABLED,"can not publish a disabled track: ".concat(o.getTrackId()))}_.info("[".concat(this._clientId,"] Publishing tracks, id ").concat(n.map(o=>"".concat(o.getTrackId()," "))));let r=yield this._publishMutex.lock();yield this._configDistribute.awaitConfigDistributeComplete(),i&&n.forEach(o=>{let s=this._configDistribute.getBitrateLimit();o instanceof re&&s&&o.setBitrateLimit(s.uplink)});try{yield this._publishHighStream(n),_.info("[".concat(this._clientId,"] Publish success, id ").concat(n.map(o=>"".concat(o.getTrackId()," "))))}catch(o){throw _.error("[".concat(this._clientId,"] publish error"),o.toString()),o}finally{r()}})}_publishDataChannel(t){return I(this,null,function*(){Xt(t.id,"id",0,65535,!0),Zr(t.ordered,"ordered"),Ke(t.metadata,"metadata",0,512),_.info("[".concat(this._clientId,"] Publishing datachannels, id ").concat(t.id));let e=yield this._publishMutex.lock();try{if(this._p2pChannel.getAllDataChannels().findIndex(r=>r.id===t.id)!==-1)throw new x(C.INVALID_PARAMS,"Invalid id: ".concat(t.id,". If you want to republish the datachannel, unpublish first"));if(!this._joinInfo||this._uid===void 0)throw new x(C.INVALID_OPERATION,"Can't publish datachannel, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not publish datachannel in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&A("FORCE_TURN")&&!A("TURN_ENABLE_TCP")&&!A("TURN_ENABLE_UDP"))throw new x(C.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");let i=function(r){return nN(r,!1)}(t),n=yield this._p2pChannel.publishDataChannel([i]);if(n.length>0){if(typeof i._originDataChannelId!="number")throw _.error("[".concat(this._clientId,"] can not publish with mediaType datachannel, cannot get RTCDatachannel id")),new x(C.CREATE_DATACHANNEL_ERROR);try{yield Q.all(n.map(r=>this._uid&&this._gateway.publishDataChannel(this._uid,r,!0))),yield i._waitTillOpen()}catch(r){if(r.code!==C.DISCONNECT_P2P)throw r}}return _.info("[".concat(this._clientId,"] Publish dataChannels success, id ").concat(i.id)),i}catch(i){throw _.error("[".concat(this._clientId,"] publish datachannels error"),i.toString()),i}finally{e()}})}unpublish(t){return I(this,null,function*(){if(!this._joinInfo||this._uid===void 0)throw new x(C.INVALID_OPERATION,"Can't unpublish stream, haven't joined yet!");let e=[];if(t)if(Array.isArray(t))e=t;else{if(!(t instanceof Ha))return this._unpublishDataChannel([t]);e=[t]}else this.store.useP2P||(yield this._unpublishDataChannel()),e=this._p2pChannel.getAllTracks(!0);_.info("[".concat(this._clientId,"] Unpublish tracks, tracks ").concat(e.map(n=>"".concat(n.getTrackId()," "))," "));let i=yield this._publishMutex.lock();try{if(this.store.useP2P){let n=yield this._p2pChannel.unpublish(e);n&&(yield this._gateway.sendExtensionMessage(ye.UNPUBLISH,{unpubMsg:n},!0))}else{let n=yield this._p2pChannel.unpublish(e);n&&(yield this._gateway.unpublish(n,this._uid)),_.info("[".concat(this._clientId,"] Unpublish success,tracks ").concat(e.map(r=>"".concat(r.getTrackId()))))}}catch(n){throw _.error("[".concat(this._clientId,"] unpublish error"),n.toString()),n}finally{i&&i()}})}_unpublishDataChannel(t){return I(this,null,function*(){t!==void 0&&t.length!==0||(t=this._p2pChannel.getAllDataChannels()),_.info("[".concat(this._clientId,"] Unpublish datachannels, datachannels ").concat(t.map(i=>"".concat(i.id," "))," "));let e=yield this._publishMutex.lock();try{let i=yield this._p2pChannel.unpublishDataChannel(t);i&&(yield this._gateway.unpublishDataChannel(i)),_.info("[".concat(this._clientId,"] Unpublish dataChannel success,dataChannel ").concat(t.map(n=>"".concat(n.id))))}catch(i){throw _.error("[".concat(this._clientId,"] unpublish dataChannel error"),i.toString()),i}finally{e&&e()}})}subscribe(t,e,i){return I(this,null,function*(){if(!(t instanceof Ho)){let n=this.remoteUsers.find(r=>r.uid===t);if(!n)throw new x(C.INVALID_REMOTE_USER,"user is not in the channel");t=n}return e==="datachannel"?this._subscribeDataChannel(t,i):this._subscribe(t,e)})}presubscribe(t,e){return I(this,null,function*(){if(xe(e,"mediaType",["audio","video"]),this.store.useP2P)throw new x(C.INVALID_OPERATION,"can't presub at p2p mode");if(!this._joinInfo)throw new x(C.INVALID_OPERATION,"can't presub when not join");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can't presub in ".concat(this.connectionState," state"));let i=e===$.AUDIO,n=e===$.VIDEO,r=yield this._subscribeMutex.lock();try{let{ssrcId:o,ortc:s,rtxSsrcId:a,cname:c,uint_id:d}=yield this._gateway.presubscribe(t,e,!0);if(o==null)throw new x(C.UNEXPECTED_RESPONSE,"no ssrc id");let l=this._users.find(h=>h.uid===t);l||(l=new Ho(t,d||t),l._is_pre_created=!0,this._users.push(l)),c&&(l._cname=c),l._uintid||(l._uintid=d||t),i&&(l._audioSSRC=o,l._audio_pre_subscribed=!0,s&&(l._audioOrtc=s)),n&&(l._videoSSRC=o,l._video_pre_subscribed=!0,s&&(l._videoOrtc=s),a!=null&&(l._rtxSsrcId=a)),_.info("[".concat(this._clientId,"] presub succeed ssrc: ").concat(o)),yield this._p2pChannel.subscribe(l,e,o,a,s);let u=i?l._audioTrack:l._videoTrack;if(!u)throw new x(C.UNEXPECTED_ERROR,"can not find remote track in user");return i&&(l._trust_audio_stream_added_state_=!0,l._audio_added_=!0),n&&(l._trust_video_stream_added_state_=!0,l._video_added_=!0),u}catch(o){throw _.error("[".concat(this._clientId,"] presub user ").concat(t," error"),o),o}finally{r()}})}_subscribeDataChannel(t,e){return I(this,null,function*(){var i;if(Xt(e,"channelId",0,65535,!0),!this._joinInfo)throw new x(C.INVALID_OPERATION,"Can't subscribe datachannel, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"Can't subscribe datachannel in ".concat(this.connectionState," state"));if(!this._users.find(a=>a===t))throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),new x(C.INVALID_REMOTE_USER,"user is not in the channel");if(!t.hasAudio&&!t.hasVideo&&t._dataChannels.length===0)throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),new x(C.INVALID_REMOTE_USER,"user is not published");let r=(i=t._dataChannels)===null||i===void 0?void 0:i.find(a=>a.id===e);if(!r)throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, remote datachannel is not published")),new x(C.REMOTE_USER_IS_NOT_PUBLISHED);let o=yield this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: datachannel"));try{let a=yield this._p2pChannel.subscribeDataChannel(t,[r]);if(a&&z(a).call(a,r.id))try{var s;if(typeof r._originDataChannelId!="number")throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType datachannel, cannot get RTCDatachannel")),new x(C.CREATE_DATACHANNEL_ERROR);let c={id:r.id,datachannelId:r._originDataChannelId,ordered:r.ordered,maxRetransmits:r.maxRetransmits,metadata:(s=r.metadata)!==null&&s!==void 0?s:""};yield this._gateway.subscribeDataChannel(t.uid,c,!0),yield r._waitTillOpen()}catch(c){if(c?.code!==C.WS_ABORT)throw yield this._p2pChannel.unsubscribeDataChannel(t,[r]),c;yield this._p2pChannel.unsubscribeDataChannel(t,[r]),this._p2pChannel.setPendingRemoteDataChannel(t,r.id)}return _.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: datachannel")),r}finally{o()}})}_p2pSubscribe(t,e,i){return I(this,null,function*(){if(xe(e,"mediaType",["audio","video"]),!this._joinInfo)throw new x(C.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(o=>o===t)){let o=new x(C.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),o}if(!t.hasAudio&&!t.hasVideo){let o=new x(C.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),o}if(!i&&(e==="audio"&&!t.hasAudio||e==="video"&&!t.hasVideo)){let o=new x(C.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),o}let r=yield this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(yield this._p2pChannel.hasRemoteMediaWithLock(t,e))yield this._p2pChannel.unmuteRemote(t,e);else try{let s=e==="audio"?t._audioSSRC:t._videoSSRC,a=e==="audio"?t._audioMid:t._videoMid;this.store.subscribe(t.uid,e,Date.now()),this.store.useP2P&&(yield this._p2pChannel.subscribe(t,e,s,a))}catch(s){throw s}_.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(s=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),s)});let o=e==="audio"?t._audioTrack:t._videoTrack;if(!o)throw new x(C.UNEXPECTED_ERROR,"can not find remote track in user object");return o}catch(o){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),o),o}finally{r()}})}_subscribe(t,e,i){return I(this,null,function*(){if(this.store.useP2P)return this._p2pSubscribe(t,e);if(xe(e,"mediaType",["audio","video"]),!this._joinInfo)throw new x(C.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));if(!this._users.find(d=>d===t)){let d=new x(C.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", this user is not in the channel")),d}if(!t.hasAudio&&!t.hasVideo){let d=new x(C.INVALID_REMOTE_USER,"user is not published");throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid,", user is not published")),d}if(!(i||(e!=="audio"||t.hasAudio&&t._audioSSRC!==void 0)&&(e!=="video"||t.hasVideo&&t._videoSSRC!==void 0))){let d=new x(C.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not subscribe ").concat(t.uid," with mediaType ").concat(e,", remote track is not published")),d}let r=e==="audio"?t._audioSSRC:t._videoSSRC,o=e==="audio"?t._audioOrtc:t._videoOrtc,s=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?$.AUDIO:$.VIDEO,ssrcId:r},c=yield this._subscribeMutex.lock();_.info("[".concat(this._clientId,"] subscribe user ").concat(t.uid,", mediaType: ").concat(e));try{if(yield this._p2pChannel.hasRemoteMediaWithLock(t,e))yield this._p2pChannel.unmuteRemote(t,e);else try{let l=e==="audio"?t._audioSSRC:t._videoSSRC;l!==void 0&&l!==r&&(r=l,o=e==="audio"?t._audioOrtc:t._videoOrtc,s=e==="video"?t._rtxSsrcId:void 0,a={stream_type:e==="audio"?$.AUDIO:$.VIDEO,ssrcId:r}),si.markSubscribeStart(this.store.clientId,r),this.store.subscribe(t.uid,e,Date.now()),yield this._p2pChannel.subscribe(t,e,r,s,o);try{this._p2pChannel.isPreSubScribe(r)||(yield this._gateway.subscribe(t.uid,a,!0))}catch(u){if(u?.code!==C.WS_ABORT)throw yield this._p2pChannel.unsubscribe(t,e),u;yield this._p2pChannel.unsubscribe(t,e,!0),this._p2pChannel.setPendingRemoteMedia(t,e)}this.store.subscribe(t.uid,e,void 0,Date.now()),this._p2pChannel.reportSubscribeEvent(!0,null,t,e)}catch(l){throw this._p2pChannel.reportSubscribeEvent(!1,l?.code,t,e),l}_.info("[".concat(this._clientId,"] subscribe success user ").concat(t.uid,", mediaType: ").concat(e)),this._defaultStreamFallbackType&&this.setStreamFallbackOption(t.uid,this._defaultStreamFallbackType).catch(l=>{_.warning("[".concat(this._clientId,"] auto set fallback failed"),l)});let d=e==="audio"?t._audioTrack:t._videoTrack;if(!d)throw new x(C.UNEXPECTED_ERROR,"can not find remote track in user object");return d}catch(d){throw _.error("[".concat(this._clientId,"] subscribe user ").concat(t.uid," error"),d),d}finally{c()}})}massSubscribe(t){return I(this,null,function*(){if($r(t,"subscribeList"),!this._joinInfo)throw new x(C.INVALID_OPERATION,"Can't subscribe stream, not joined");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"Can't subscribe stream in ".concat(this.connectionState," state"));let e=Date.now(),i=new Map,n=yield this._subscribeMutex.lock();_.info("[".concat(this._clientId,"]start massSubscribe user ").concat(t.map(a=>{let{user:c,mediaType:d}=a;return"user: ".concat(c?.uid,", mediaType: ").concat(d)}).join("; ")));let r=(t=[...t]).map(a=>{let{user:c,mediaType:d}=a;return{user:c,mediaType:d}}),o=yield this._p2pChannel.globalLock();try{var s;for(let c=t.length-1;c>=0;c--){let d=t[c],{user:l,mediaType:u}=d;if(xe(u,"mediaType",["audio","video"]),!l){let E=new x(C.INVALID_PARAMS,"user property does not exist in subscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in subscribeList item")),E}if(!this._users.find(E=>E===l)){let E=new x(C.INVALID_REMOTE_USER,"user is not in the channel");_.error("[".concat(this._clientId,"] can not massSubscribe ").concat(l.uid,", this user is not in the channel")),r[c].error=E,t.splice(c,1);continue}if(u==="audio"&&(!l.hasAudio||l._audioSSRC===void 0)||u==="video"&&(!l.hasVideo||l._videoSSRC===void 0)){let E=new x(C.REMOTE_USER_IS_NOT_PUBLISHED);_.error("[".concat(this._clientId,"] can not subscribe ").concat(l.uid," with mediaType ").concat(u,", remote user is not published")),r[c].error=E,t.splice(c,1);continue}let p=Be.Video|Be.LwoVideo,g=i.get(l);if(g){if(u==="video"?g&p:g&Be.Audio){t.splice(c,1),_.warning("[".concat(this._clientId,"] repeat massSubscribe user:").concat(l.uid,", mediaType:").concat(u," twice"));continue}i.set(l,g|(u==="video"?p:Be.Audio))}else i.set(l,u==="video"?p:Be.Audio)}for(let c=t.length-1;c>=0;c--){let d=t[c],{user:l,mediaType:u}=d,h=Be.Video|Be.LwoVideo;if(this._p2pChannel.hasRemoteMedia(l,u)){yield this._p2pChannel.unmuteRemoteNoLock(l,u);let p=i.get(l);i.set(l,u==="video"?p^h:p^Be.Audio),t.splice(c,1)}}this.store.massSubscribe(t.map(c=>({userId:c.user.uid,type:c.mediaType})),e);let a=bn(s=Array.from(i.entries())).call(s,(c,d)=>{let[l,u]=d;if(u===0)return c;let h={stream_id:l.uid,stream_type:u};return u&Be.Audio&&(h.audio_ssrc=l._audioSSRC),u&Be.Video&&(h.video_ssrc=l._videoSSRC),c.push(h),c},[]);try{t.length>0&&(yield this._p2pChannel.massSubscribeNoLock(t.map(d=>{let{user:l,mediaType:u}=d;return{user:l,mediaType:u,ssrcId:u===$.VIDEO?l._videoSSRC:l._audioSSRC,rtxSsrcId:u===$.VIDEO?l._rtxSsrcId:void 0}})));let c=new Map;if(a=a.filter(d=>d.video_ssrc&&!this._p2pChannel.isPreSubScribe(d.video_ssrc)||d.audio_ssrc&&!this._p2pChannel.isPreSubScribe(d.audio_ssrc)||!d.video_ssrc&&!d.audio_ssrc),a.length>0){let d=yield this._gateway.subscribeAll(a,!0);(d?.users||[]).forEach(l=>{let{stream_id:u,video_error_code:h,audio_error_code:p,error_code:g}=l;(h||p||g)&&c.set(u,{video_error_code:h,audio_error_code:p,error_code:g})})}if(Array.from(c.entries()).length>0){let d=[];Array.from(c.entries()).forEach(l=>{let[u,h]=l,p=this.remoteUsers.find(g=>g.uid===u);if(p){let g;h.error_code||h.video_error_code&&h.audio_error_code?g=void 0:h.video_error_code?g=$.VIDEO:h.audio_error_code&&(g=$.AUDIO),d.push({user:p,mediaType:g})}}),d.length>0&&(yield this._p2pChannel.massUnsubscribeNoLock(d))}for(let d of r){let l=c.get(d.user.uid);if(l){let u=l.error_code||d.mediaType==="audio"&&l.audio_error_code||d.mediaType==="video"&&l.video_error_code;if(u){let h=Od(u);_.error("user:".concat(d.user.uid," mediaType:").concat(d.mediaType," has massSubscribe error ").concat(h.desc)),d.error=new x(C.SUBSCRIBE_FAILED,"code ".concat(u,": ").concat(h.desc))}}d.error||(d.mediaType==="video"?d.track=d.user.videoTrack:d.track=d.user.audioTrack)}return this.store.massSubscribe(r.filter(d=>!d.error).map(d=>({userId:d.user.uid,type:d.mediaType})),void 0,Date.now()),r.forEach(d=>{var l;ot.subscribe(this.store.sessionId,{succ:!!d.error,ec:((l=d.error)===null||l===void 0?void 0:l.code)||null,video:d.mediaType===$.VIDEO,audio:d.mediaType===$.AUDIO,peerid:d.user.uid,subscribeRequestid:d.mediaType===$.VIDEO?d.user._videoSSRC:d.user._audioSSRC,p2pid:this.store.p2pId,eventElapse:Math.floor(performance.now()-e),preSsrc:this._p2pChannel.isPreSubScribe(d.user._videoSSRC)},!0)}),_.info("[".concat(this._clientId,"] massSubscribe success ").concat(t.map(d=>{let{user:l,mediaType:u}=d;return"user: ".concat(l?.uid,", mediaType: ").concat(u)}).join("; "))),r}catch(c){throw yield this._p2pChannel.massUnsubscribeNoLock(t),c}}finally{o(),n()}})}unsubscribe(t,e,i){return I(this,null,function*(){if(!(t instanceof Ho)){let o=this.remoteUsers.find(s=>s.uid===t);if(!o)throw new x(C.INVALID_REMOTE_USER,"user is not in the channel");t=o}if(e||this.store.useP2P){if(e==="datachannel")return this._unsubscribeDataChannel(t,i)}else yield this._unsubscribeDataChannel(t,i);if(e&&xe(e,"mediaType",["audio","video"]),!this._joinInfo)throw new x(C.INVALID_OPERATION,"Can't unsubscribe stream, haven't joined yet!");if(!this._users.find(o=>o===t)){let o=new x(C.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),o}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: ").concat(e));let r=yield this._subscribeMutex.lock();try{if(this.store.useP2P)yield this._p2pChannel.unsubscribe(t,e);else{let o=yield this._p2pChannel.unsubscribe(t,e);o&&(yield this._gateway.unsubscribe(o,t.uid)),e&&e!=="audio"||(t._audio_pre_subscribed=!1),e&&e!=="video"||(t._video_pre_subscribed=!1),t._is_pre_created&&mh(this._users,t),_.info("[".concat(this._clientId,"] unsubscribe success uid: ").concat(t.uid,", mediaType: ").concat(e))}}catch(o){if(o.code===C.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),o.toString()),o}finally{r()}})}_unsubscribeDataChannel(t,e){return I(this,null,function*(){if(e&&Xt(e,"id",0,65535,!0),!this._joinInfo)throw new x(C.INVALID_OPERATION,"Can't unsubscribe datachannel, haven't joined yet!");if(!this._users.find(r=>r===t)){let r=new x(C.INVALID_REMOTE_USER,"user is not in the channel");throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid,", user is not in the channel")),r}let n;if(typeof e=="number"){let r=t._dataChannels.find(o=>o.id===e);r&&(n=[r])}else n=t._dataChannels;if(n===void 0){let r=new x(C.REMOTE_USER_IS_NOT_PUBLISHED);throw _.error("[".concat(this._clientId,"] can not unsubscribe ").concat(t.uid," with channelId ").concat(e,", remote datachannel is not published")),r}_.info("[".concat(this._clientId,"] unsubscribe uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(n.map(r=>r.id)));try{let r=yield this._p2pChannel.unsubscribeDataChannel(t,n);r&&(yield this._gateway.unsubscribeDataChannel(r,t.uid)),_.info("[".concat(this._clientId,"] unsubscribe datachannel success uid: ").concat(t.uid,", mediaType: datachannel, ids: ").concat(r))}catch(r){if(r.code===C.DISCONNECT_P2P)return void _.warning("disconnecting p2p, abort unsubscribe request.");throw _.error("[".concat(this._clientId,"] unsubscribe user ").concat(t.uid," error"),r.toString()),r}})}massUnsubscribe(t){return I(this,null,function*(){if($r(t,"unsubscribeList"),!this._joinInfo)throw new x(C.INVALID_OPERATION,"Can't unsubscribeAll stream, haven't joined yet!");_.info("[".concat(this._clientId,"] start massUnsubscribe ").concat(t.map(i=>{let{user:n,mediaType:r}=i;return"user: ".concat(n?.uid,", mediaType: ").concat(r,";")}).join())),t=[...t];let e=new Map;for(let i=t.length-1;i>=0;i--){let{user:n,mediaType:r}=t[i];if(!n){let a=new x(C.INVALID_PARAMS,"user property does not exist in unsubscribeList item");throw _.error("[".concat(this._clientId,"] user property does not exist in unsubscribeList item")),a}if(xe(r,"mediaType",["video","audio",void 0]),!this._users.find(a=>a===n)){_.warning("[".concat(this._clientId,"] can not unsubscribe ").concat(n.uid,", user is not in the channel")),t.splice(i,1);continue}let s=Be.Video|Be.LwoVideo;if(e.has(n)){let a=e.get(n),c;switch(r){case"video":c=a&s;break;case"audio":c=a&Be.Audio;break;default:c=a&(Be.Audio|s)}if(c){_.warning("[".concat(this._clientId,"] repeat massUnsubscribe user:").concat(n.uid,",mediaType:").concat(r," twice.")),t.splice(i,1);continue}r?r==="audio"?e.set(n,a|Be.Audio):r==="video"&&e.set(n,a|s):e.set(n,a|Be.Audio|s)}else r?r==="audio"?e.set(n,Be.Audio):r==="video"&&e.set(n,s):e.set(n,Be.Audio|s)}try{let i=yield this._p2pChannel.massUnsubscribe(t);i&&(yield this._gateway.massUnsubscribe(i)),_.info("[".concat(this._clientId,"] massUnsubscribe success ").concat(t.map(n=>{let{user:r,mediaType:o}=n;return"user: ".concat(r?.uid,", mediaType: ").concat(o,";")}).join()))}catch(i){if(i.code===C.DISCONNECT_P2P)return void _.warning("[".concat(this._clientId,"] disconnecting p2p, abort unsubscribe request."));throw _.error("[".concat(this._clientId,"] massUnsubscribe error"),i.toString()),i}})}setLowStreamParameter(t){return I(this,null,function*(){(function(i){if(!i)throw new F(C.INVALID_PARAMS);me(i.width)||mf(i.width,"streamParameter.width"),me(i.height)||mf(i.height,"streamParameter.height"),me(i.framerate)||mf(i.framerate,"streamParameter.framerate"),me(i.bitrate)||Xt(i.bitrate,"streamParameter.bitrate")})(t),(!t.width&&t.height||t.width&&!t.height)&&_.warning("[".concat(this._clientId,"] The width and height parameters take effect only when both are set")),_.info("[".concat(this._clientId,"] set low stream parameter to"),JSON.stringify(t));let e=this._configDistribute.getLowStreamConfigDistribute();if(e&&e.bitrate&&t.bitrate&&e.bitrate<t.bitrate&&(t.bitrate=e.bitrate),this._lowStreamParameter=t,this._isDualStreamEnabled)return this._p2pChannel.updateVideoStreamParameter(t,W.LocalVideoLowTrack)})}enableDualStream(){return I(this,null,function*(){if(!Mt().supportDualStream)throw ot.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),new x(C.NOT_SUPPORTED,"Your browser is not support dual stream");if(this._isDualStreamEnabled)throw new x(C.INVALID_OPERATION,"Dual stream is already enabled");if(this._p2pChannel.canPublishLowStream())try{yield this._publishLowStream()}catch(t){throw ot.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!1}),t}this._isDualStreamEnabled=!0,ot.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!0,succ:!0}),_.info("[".concat(this._clientId,"] enable dual stream"))})}disableDualStream(){return I(this,null,function*(){if(this._isDualStreamEnabled){if(!this._joinInfo)throw new x(C.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this._p2pChannel.getLocalMedia(W.LocalVideoLowTrack))try{let t=yield this._p2pChannel.unpublishLowStream();t&&(yield this._gateway.unpublish(t,this._joinInfo.stringUid||this._joinInfo.uid))}catch(t){throw ot.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!1}),t}this._isDualStreamEnabled=!1,ot.streamSwitch(this._sessionId,{lts:Date.now(),isdual:!1,succ:!0}),_.info("[".concat(this._clientId,"] disable dual stream"))}})}setClientRole(t,e){return I(this,null,function*(){if(function(n){xe(n,"role",["audience","host"])}(t),e&&Sf(e),this.mode==="rtc"||this.mode==="p2p")throw _.warning("[".concat(this._clientId,"]").concat(this.mode," mode can not use setClientRole")),new x(C.INVALID_OPERATION,"".concat(this.mode," mode can not use setClientRole"));if(e&&e.level&&t==="host")throw new x(C.INVALID_OPERATION,"host mode can not set audience latency level");if(t==="audience"&&this._p2pChannel.hasLocalMedia())throw new x(C.INVALID_OPERATION,"can not set client role to audience when publishing stream");let i=this._config.role;this._joinInfo&&(this._joinInfo.role=t),t!==i&&A("ENABLE_ROLE_SELECT_EDGE")?(this._gateway.updateClientRole(t,e),this._config.role=t,this._gateway.reconnect("recover",Ze.REGIONAL_DISTRIBUTION)):(yield this._gateway.setClientRole(t,e),this._config.role=t),_.info("[".concat(this._clientId,"] set client role to ").concat(t,", level: ").concat(e&&e.level))})}_setClientRoleOptions(t){return I(this,null,function*(){if(this.mode==="rtc"||this.mode==="p2p"||this._config.role!=="audience"||this._p2pChannel.hasLocalMedia())return;let e=!1;try{t&&Sf(t),yield this._gateway.setClientRole(this._config.role,t),e=!0}catch{}finally{_.info("[".concat(this._clientId,"] set client role options ").concat(e?"succeed":"failed",", options is ").concat(t))}})}getRemoteInboundOffset(){var t;let e=(t=this._p2pChannel.getStats())===null||t===void 0?void 0:t.audioSend[0];if(!e||!e.timestamp)return 0;let i=e.timestamp-Date.now();return Math.abs(i)>1e3+e.rttMs+100?this.ntpAlignErrorCount+=1:this.ntpAlignErrorCount=0,this.ntpAlignErrorCount>=3?i:0}getNtpWallTimeInMs(){return document.visibilityState==="visible"&&(this.remoteInboundOffset=this.getRemoteInboundOffset()),this.remoteInboundOffset+Date.now()+this._gateway.ntpOffset}setProxyServer(t,e){if(Ke(t,"proxyServer"),!e){if(this.connectionState!=="DISCONNECTED")throw new x(C.INVALID_OPERATION,"Set proxy server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new x(C.INVALID_OPERATION,"You have already set the proxy")}this._proxyServer=t,ot.setProxyServer(this._proxyServer),_.setProxyServer(this._proxyServer),_.info("[".concat(this._clientId,"] Set proxy server ").concat(e?"by initialize call":""," success."))}setTurnServer(t,e){if(Array.isArray(t)||(t=[t]),!e){if(this.connectionState!=="DISCONNECTED")throw new x(C.INVALID_OPERATION,"Set turn server before join channel");if(this._cloudProxyServerMode!=="disabled"||this._useLocalAccessPoint)throw new x(C.INVALID_OPERATION,"You have already set the proxy")}if(gd(t))return this._turnServer={servers:t,mode:"original-manual"},void _.info("[".concat(this._clientId,"] Set original turnserver ").concat(e?"by initialize call":""," success: ").concat(t.map(i=>i.urls).join(","),"."));t.forEach(i=>UA(i)),this._turnServer={servers:t,mode:"manual"},_.info("[".concat(this._clientId,"] Set turnserver ").concat(e?"by initialize call":""," success."))}setLicense(t){if(this.connectionState!=="DISCONNECTED")throw new x(C.INVALID_OPERATION,"you should set license before join channel");if(Ke(t,"license",32,32),!/^[A-Za-z\d]+$/.test(t))throw new x(C.INVALID_PARAMS,"license should only contains characters from A-Z a-z 0-9");this._license=t,_.info("[".concat(this._clientId,"] set license success"),t)}startProxyServer(t){if(this.connectionState!=="DISCONNECTED")throw new x(C.INVALID_OPERATION,"Start proxy server before join channel");if(this._proxyServer||this._turnServer.mode==="manual"||this._useLocalAccessPoint)throw new x(C.INVALID_OPERATION,"You have already set the proxy");let e=[3,4,5],i;switch(t===void 0&&(t=3),t){case 1:case 2:throw new x(C.NOT_SUPPORTED,"proxy mode 1/2 has been deprecated and not supported.");case 3:i="proxy3";break;case 4:i="proxy4";break;case 5:i="proxy5";break;default:throw new x(C.INVALID_PARAMS,"proxy server mode must be ".concat(e.join("|")))}this._cloudProxyServerMode=i,this.store.cloudProxyServerMode=i,_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode)}stopProxyServer(){if(this.connectionState!=="DISCONNECTED")throw new x(C.INVALID_OPERATION,"Stop proxy server after leave channel");ot.setProxyServer(),_.setProxyServer(),this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled",_.info("[".concat(this._clientId,"] set cloud proxy server mode to"),this._cloudProxyServerMode),this._proxyServer=void 0,this._turnServer={mode:"auto",servers:[]}}setLocalAccessPointsV2(t){if(!t.accessPoints)throw new x(C.INVALID_PARAMS,"accessPoints is required.");$r(t.accessPoints.serverList,"accessPoints.serverList"),Ke(t.accessPoints.domain,"accessPoints.domain");let e=(h,p)=>{Xt(h,p,0,65535,!0)},i=443;if(t.accessPoints.port&&(e(t.accessPoints.port,"accessPoints.port"),i=t.accessPoints.port),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new x(C.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");A("CLOSE_AFB_FOR_LOCAL_AP")&&(qt("JOIN_WITH_FALLBACK_SIGNAL_PROXY",!1),qt("JOIN_WITH_FALLBACK_MEDIA_PROXY",!1));let n=/^((\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.){3}(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/,r=t.accessPoints.domain,o=t.accessPoints.serverList.map(h=>n.test(h)?"".concat(h.replace(/\./g,"-"),".").concat(r):h),s=o.map(h=>"".concat(h,":").concat(i));this._useLocalAccessPoint=!0,this._setLocalAPVersion=2,qt("WEBCS_DOMAIN",s),qt("WEBCS_DOMAIN_BACKUP_LIST",s),qt("GATEWAY_DOMAINS",[r]),t.report&&t.report.hostname&&Array.isArray(t.report.hostname)&&t.report.hostname.length?($r(t.report.hostname,"report.hostname"),qt("EVENT_REPORT_DOMAIN",t.report.hostname[0]),qt("EVENT_REPORT_BACKUP_DOMAIN",t.report.hostname[1]||t.report.hostname[0])):(qt("EVENT_REPORT_DOMAIN",o[0]),qt("EVENT_REPORT_BACKUP_DOMAIN",o[1]||o[0]));let a=6443;t.report&&t.report.port&&(e(t.report.port,"report.port"),a=t.report.port),qt("STATS_COLLECTOR_PORT",a),t.report?qt("ENABLE_EVENT_REPORT",!0):qt("ENABLE_EVENT_REPORT",!1);let c="";t.log&&t.log.hostname&&Array.isArray(t.log.hostname)&&t.log.hostname.length?($r(t.log.hostname,"log.hostname"),c=t.log.hostname[0]):c=o[0];let d=6444;t.log&&t.log.port&&(e(t.log.port,"log.port"),d=t.log.port),qt("LOG_UPLOAD_SERVER","".concat(c,":").concat(d));let l=[];t.cds&&t.cds.hostname&&Array.isArray(t.cds.hostname)&&t.cds.hostname.length?($r(t.cds.hostname,"cds.hostname"),l=t.cds.hostname):l=o;let u=443;t.cds&&t.cds.port&&(e(t.cds.port,"cds.port"),u=t.cds.port),qt("CDS_AP",l.map(h=>"".concat(h,":").concat(u))),t.cds?qt("ENABLE_CONFIG_DISTRIBUTE",!0):qt("ENABLE_CONFIG_DISTRIBUTE",!1),_.info("set local access point v2 success")}setLocalAccessPoints(t,e){if($r(t,"serverList"),Ke(e,"domain"),this._proxyServer||this._cloudProxyServerMode!=="disabled")throw new x(C.INVALID_OPERATION,"set local access point failed, You have already set the cloud proxy");let i=/^(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])\.(\d{1,2}|1\d\d|2[0-4]\d|25[0-5])$/;t=t.map(n=>i.test(n)?"".concat(n.replace(/\./g,"-"),".").concat(e):n),this._useLocalAccessPoint=!0,this._setLocalAPVersion=1,qt("WEBCS_DOMAIN",t),qt("WEBCS_DOMAIN_BACKUP_LIST",t),qt("GATEWAY_DOMAINS",[e]),qt("EVENT_REPORT_DOMAIN",t[0]),qt("EVENT_REPORT_BACKUP_DOMAIN",t[1]||t[0]),qt("LOG_UPLOAD_SERVER","".concat(t[0],":6444")),_.info("[".concat(this._clientId,"] set local access point success"))}setRemoteDefaultVideoStreamType(t){return I(this,null,function*(){if(xe(t,"streamType",[0,1,4,5,6,7,8,9]),this._remoteDefaultVideoStreamType=t,this._joinInfo)try{yield this._gateway.setDefaultRemoteVideoStreamType(t),this._joinInfo.defaultVideoStream=this._remoteDefaultVideoStreamType}catch(e){throw _.error("[".concat(this._clientId,"] set default remote video stream type error"),e.toString()),e}else _.debug("[".concat(this._clientId,"] haven't joined yet, cache remoteDefaultVideoStreamType ").concat(t))})}setRemoteVideoStreamType(t,e){return I(this,null,function*(){xe(e,"streamType",[0,1,4,5,6,7,8,9]);try{yield this._gateway.setRemoteVideoStreamType(t,e),setTimeout(()=>{let i=this._users.find(n=>n.uid===t);i&&i.videoTrack&&i.videoTrack.updateMediaStreamTrackResolution()},2e3)}catch(i){throw _.error("[".concat(this._clientId,"] set remote video stream type error"),i.toString()),i}_.info("[".concat(this._clientId,"] set remote ").concat(t," video stream type to ").concat(e)),this._remoteStreamTypeCacheMap.set(t,e)})}setStreamFallbackOption(t,e){return I(this,null,function*(){xe(e,"fallbackType",[0,1,2,3,4,5,6,7,8]);try{yield this._gateway.setStreamFallbackOption(t,e)}catch(i){throw _.error("[".concat(this._clientId,"] set stream fallback option"),i.toString()),i}_.info("[".concat(this._clientId,"] set remote ").concat(t," stream fallback type to ").concat(e)),this._streamFallbackTypeCacheMap.set(t,e)})}setEncryptionConfig(t,e,i,n){(function(o){xe(o,"encryptionMode",["aes-128-xts","aes-256-xts","aes-128-ecb","sm4-128-ecb","aes-128-gcm","aes-256-gcm","aes-128-gcm2","aes-256-gcm2","none"])})(t),Ke(e,"secret");let r=["aes-128-gcm2","aes-256-gcm2"];if(z(r).call(r,t)){if(!i||!(i instanceof Uint8Array&&i.length===32))throw new x(C.INVALID_PARAMS,"salt must be an Uint8Array and exactly equal to 32 bytes")}else if(i)throw new x(C.INVALID_PARAMS,"current encrypt mode does not need salt");if(n){if(Zr(n,"encryptDataStream"),!z(r).call(r,t))throw new x(C.INVALID_PARAMS,"current encrypt mode does not support data stream");this._encryptDataStream=!0}new RegExp(`^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*,.<>?/:;'"|{}\\[\\]])(?=.{8,})`).test(e)||_.warning(`The secret is not strong:
      The secret must contain at least 1 lowercase alphabetical character,
      The secret must contain at least 1 uppercase alphabetical character,
      The secret must contain at least 1 numeric character,
      The secret must contain at least one special character,
      The secret must be eight characters or longer.
      `),this._encryptionMode=t,this._encryptionSecret=e,i&&(this._encryptionSalt=Uo(i))}renewToken(t){return I(this,null,function*(){if(Ke(t,"token",1,2047),!this._key||!this._joinInfo)throw new x(C.INVALID_OPERATION,"renewToken should not be called before user join");let e=this._key;this._key=t,this._joinInfo&&(this._joinInfo.token=t);let i=yield this._renewTokenMutex.lock();try{if(A("USE_NEW_TOKEN")){_.debug("[".concat(this._clientId,"] start renew token with ticket from unilbs"));let n=yield X6(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Oe);_.debug("[".concat(this._clientId,"] get ticket from unilbs success")),yield this._gateway.renewToken({token:t,ticket:n})}else _.debug("[".concat(this._clientId,"] start renew token without ticket")),yield this._gateway.renewToken({token:t});_.debug("[".concat(this._clientId,"] renewToken success"))}catch(n){throw this._key=e,this._joinInfo.token=e,_.error("[".concat(this._clientId,"] renewToken failed"),n.toString()),n}finally{i()}})}enableAudioVolumeIndicator(){this._audioVolumeIndicationInterval?_.warning("you have already enabled audio volume indicator!"):this._audioVolumeIndicationInterval=window.setInterval(()=>{let t=this._p2pChannel.getAudioLevels();this.safeEmit(It.VOLUME_INDICATOR,t)},A("AUDIO_VOLUME_INDICATION_INTERVAL")||2e3)}getRTCStats(){let t=this._statsCollector.getRTCStats(),e=this._gateway.getInChannelInfo();return t.Duration=Math.round(e.duration/1e3),t}startLiveStreaming(t,e){return I(this,null,function*(){if(!e){if(this.codec!=="h264")throw new x(C.LIVE_STREAMING_INVALID_RAW_STREAM,"raw streaming is only support h264");if(!this._p2pChannel.hasLocalMedia())throw new x(C.LIVE_STREAMING_INVALID_RAW_STREAM,"can not find stream to raw streaming")}if(this._liveRawStreamingClient&&this._liveRawStreamingClient.hasUrl(t)||this._liveTranscodeStreamingClient&&this._liveTranscodeStreamingClient.hasUrl(t))throw new x(C.LIVE_STREAMING_TASK_CONFLICT);let i=e?Ar.TRANSCODE:Ar.RAW;return this._createLiveStreamingClient(i).startLiveStreamingTask(t,i)})}setLiveTranscoding(t){return this._createLiveStreamingClient(Ar.TRANSCODE).setTranscodingConfig(t)}stopLiveStreaming(t){return I(this,null,function*(){let e=[this._liveRawStreamingClient,this._liveTranscodeStreamingClient].filter(i=>i&&i.hasUrl(t));if(!e.length)throw new x(C.INVALID_PARAMS,"can not find live streaming url to stop");yield Q.all(e.map(i=>i&&i.stopLiveStreamingTask(t)))})}startChannelMediaRelay(t){return I(this,null,function*(){TN(t),yield this._createChannelMediaRelayClient().startChannelMediaRelay(t)})}updateChannelMediaRelay(t){return I(this,null,function*(){TN(t),yield this._createChannelMediaRelayClient().updateChannelMediaRelay(t)})}stopChannelMediaRelay(){return I(this,null,function*(){yield this._createChannelMediaRelayClient().stopChannelMediaRelay(),this._statsCollector.onStatsChanged&&(this._statsCollector.onStatsChanged=void 0)})}sendAudioMetadata(t){this._p2pChannel instanceof Bd&&this._p2pChannel.addAudioMetadata(t)}sendStreamMessage(e){return I(this,arguments,function*(t){var i;let n=!(arguments.length>1&&arguments[1]!==void 0)||arguments[1];if(!this._joinInfo)throw new x(C.INVALID_OPERATION,"can not send data stream, not joined");if((typeof t=="string"||t instanceof Uint8Array)&&(t={payload:t}),typeof t.payload=="string"){let o=new TextEncoder;t.payload=o.encode(t.payload)}let r=!1;if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&z(i=["aes-128-gcm2","aes-256-gcm2"]).call(i,this._encryptionMode)&&(r=!0,t.payload=yield function(o,s,a){return I(this,null,function*(){var c;let d=bn(c=Array.from(a)).call(c,(f,R)=>f+R,0),l={serverTs:0,seq:EK++,length:a.length,checkSum:d},u=new Uint8Array(HA(d,2)),h=new ArrayBuffer(xa),p=new DataView(h);p.setUint32(0,l.serverTs),p.setUint16(4,l.seq),p.setUint16(6,l.length),p.setUint16(8,l.checkSum);let g=16-a.length%16;a=FA(a,new Uint8Array(g));let E=yield window.crypto.subtle.encrypt({name:"AES-GCM",iv:o,tagLength:nw,additionalData:u},s,a);return FA(new Uint8Array(h),new Uint8Array(E))})}(this._encryptDataStreamIv,this._encryptDataStreamKey,t.payload)),new Blob([t.payload]).size>1024)throw new x(C.INVALID_PARAMS,r?"encrypted stream message out of range.":"stream message out of range.");return this._gateway.signal.request(pt.DATA_STREAM,{payload:Uo(t.payload),syncWithAudio:t.syncWithAudio,sendTs:Date.now()-rq},!n)})}sendMetadata(t){if(!this._joinInfo)throw new x(C.INVALID_OPERATION,"can not send metadata, not joined");if(new Blob([t]).size>1024)throw new x(C.METADATA_OUT_OF_RANGE);return this._gateway.signal.request(pt.SEND_METADATA,{session_id:this._joinInfo.sid,metadata:Uo(t)})}sendCustomReportMessage(t){return I(this,null,function*(){if(Array.isArray(t)||(t=[t]),t.forEach(bK),!this._joinInfo)throw new x(C.INVALID_OPERATION,"can not send custom report, not joined");yield ot.sendCustomReportMessage(this._joinInfo.sid,t)})}getLocalAudioStats(){return this._statsCollector.getLocalAudioTrackStats()}getRemoteAudioStats(){return this._statsCollector.getRemoteAudioTrackStats()}getLocalVideoStats(){return this._statsCollector.getLocalVideoTrackStats()}getRemoteVideoStats(){return this._statsCollector.getRemoteVideoTrackStats()}getRemoteNetworkQuality(){return this._statsCollector.getRemoteNetworkQualityStats()}pickSVCLayer(t,e){return I(this,null,function*(){xe(e.spatialLayer,"spatialLayer",[0,1,2,3]),xe(e.temporalLayer,"temporalLayer",[0,1,2,3]);try{yield this._gateway.pickSVCLayer(t,e)}catch(i){throw _.error("[".concat(this._clientId,"] pick SVC layer failed"),i.toString()),i}})}setRTMConfig(t){return I(this,null,function*(){let{apRTM:e=!1,rtmFlag:i}=t;if(Zr(e,"apRTM"),Xt(i,"rtmFlag",0),this._rtmConfig.apRTM=e,this._rtmConfig.rtmFlag=i,_.debug("[".concat(this._clientId,"] setRTMconfig ").concat(JSON.stringify(t)," in ").concat(this.connectionState," state")),(this.connectionState==="CONNECTED"||this.connectionState==="RECONNECTING")&&this._joinInfo)return this._joinInfo.apRTM=e,this._joinInfo.rtmFlag=i,this._gateway.setRTM2Flag(i)})}_reset(){if(_.debug("[".concat(this._clientId,"] reset client")),function(t){let e=Ja.indexOf(t);e!==-1&&Ja.splice(e,1)}(this._clientId),this.store.hasStartJoinChannel=!1,this.store.isABTestSuccess=!1,this._axiosCancelSource.cancel(),this._axiosCancelSource=bi.CancelToken.source(),this._streamFallbackTypeCacheMap=new Map,this._remoteStreamTypeCacheMap=new Map,this._configDistribute.stopGetConfigDistribute(),this._joinInfo&&YN(this._joinInfo),this._joinInfo=void 0,this._proxyServer=void 0,this._defaultStreamFallbackType=void 0,this._sessionId&&ot.removeSid(this._sessionId),this._sessionId=null,this.store.sessionId=null,this._statsCollector.reset(),this._key=void 0,this._appId=void 0,this._uid=void 0,this.store.uid=void 0,this._channelName=void 0,this._encryptionMode="none",this._encryptionSecret=null,this._encryptionSalt=null,this._encryptDataStreamKey=null,this._encryptDataStreamIv=null,this._pendingPublishedUsers=[],this._users.forEach(t=>{t._audioTrack&&t._audioTrack._destroy(),t._videoTrack&&t._videoTrack._destroy(),t._dataChannels&&(t._dataChannels.forEach(e=>e._close()),t._dataChannels.length=0)}),this._users=[],this._audioVolumeIndicationInterval&&(window.clearInterval(this._audioVolumeIndicationInterval),this._audioVolumeIndicationInterval=void 0),this._cloudProxyServerMode==="fallback"&&(this._cloudProxyServerMode="disabled",this.store.cloudProxyServerMode="disabled"),this._p2pChannel.reset(),this._publishMutex=new ni("client-publish",this._clientId),this._subscribeMutex=new ni("client-subscribe",this._clientId),this._networkQualityInterval&&(window.clearInterval(this._networkQualityInterval),this._networkQualityInterval=void 0),this._liveRawStreamingClient&&(this._liveRawStreamingClient.terminate(),this._liveRawStreamingClient.removeAllListeners(),this._liveRawStreamingClient=void 0),this._liveTranscodeStreamingClient&&(this._liveTranscodeStreamingClient.terminate(),this._liveTranscodeStreamingClient.removeAllListeners(),this._liveTranscodeStreamingClient=void 0),this._channelMediaRelayClient&&(this._channelMediaRelayClient.dispose(),this._channelMediaRelayClient=void 0),this._inspect)try{this._inspect.close(),this._inspect=void 0}catch{}if(this._moderation)try{this.setImageModeration(!1)}catch{}}_startSession(t,e){var i;let n=t||Rs();t?_.debug("[".concat(this._clientId,"] new Session ").concat(n)):_.debug("[".concat(this._clientId,"] renewSession ").concat(this._sessionId," => ").concat(n));let r=t?"":this._sessionId||"";this._sessionId=n,this.store.sessionId=n,ot.addSid(n);let o={lts:new Date().getTime(),mode:this.mode,buildFormat:1,stringUid:e?.stringUid||((i=this._joinInfo)===null||i===void 0?void 0:i.stringUid),channelProfile:this.mode==="live"?1:0,channelMode:0,isABTestSuccess:Number(this._configDistribute.isSuccess),lsid:r,clientRole:this.role==="audience"?2:1};ot.sessionInit(this._sessionId,Gn({cname:e.channel,appid:e.appId},o)),this._joinInfo&&(this._joinInfo.sid=n),this._gateway.joinInfo&&(this._gateway.joinInfo.sid=n)}_publishHighStream(t){return I(this,null,function*(){if(!this._joinInfo||this._uid===void 0)throw new x(C.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));if(this._turnServer.mode==="auto"&&A("FORCE_TURN")&&!A("TURN_ENABLE_TCP")&&!A("TURN_ENABLE_UDP"))throw new x(C.UNEXPECTED_ERROR,"force TURN With No TURN Configuration");_.debug("[".concat(this._clientId,"] publish high stream"));try{let i=yield this._p2pChannel.publish(t,this._isDualStreamEnabled,this._lowStreamParameter);if(this.store.useP2P){let n=(yield i.next()).value;if(n){try{yield this._gateway.sendExtensionMessage(ye.PUBLISH,n,!0)}catch(r){throw i.throw(r),r}yield i.next()}this._p2pChannel.reportPublishEvent(!0,null)}else{let n=(yield i.next()).value;if(n){var e;let r;try{r=yield this._gateway.publish(this._uid,n,!0)}catch(o){if(o.code!==C.DISCONNECT_P2P)throw i.throw(o),o}yield i.next(((e=r)===null||e===void 0?void 0:e.ortc)||[])}this._p2pChannel.reportPublishEvent(!0,null);for(let r of t)r instanceof re&&r._encoderConfig&&this._gateway.setVideoProfile(r._encoderConfig).catch(o=>{_.debug("[".concat(this._clientId,"] stop setVideoProfile, because websocket is closed"))}),!r.muted&&r.enabled||(yield this._p2pChannel.muteLocalTrack(r))}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i?.code,t),i?.code===C.WS_ABORT)return;throw i}})}_publishLowStream(){return I(this,null,function*(){if(!this._joinInfo||this._uid===void 0)throw new x(C.INVALID_OPERATION,"Can't publish stream, haven't joined yet!");if(this.connectionState!=="CONNECTED"&&this.connectionState!=="RECONNECTING")throw new x(C.INVALID_OPERATION,"can not publish stream in ".concat(this.connectionState," state"));_.debug("[".concat(this._clientId,"] publish low stream"));let t=this._configDistribute.getLowStreamConfigDistribute();t&&t.bitrate&&(this._lowStreamParameter||(this._lowStreamParameter={width:160,height:120,framerate:15,bitrate:50}),this._lowStreamParameter&&this._lowStreamParameter.bitrate&&t.bitrate<this._lowStreamParameter.bitrate&&(this._lowStreamParameter.bitrate=t.bitrate));try{let i=yield this._p2pChannel.publishLowStream(this._lowStreamParameter),n=(yield i.next()).value;if(n){var e;let r;try{r=yield this._gateway.publish(this._uid,n,!0)}catch(o){if(o.code!==C.DISCONNECT_P2P)throw i.throw(o),o}i.next(((e=r)===null||e===void 0?void 0:e.ortc)||[]),this._p2pChannel.reportPublishEvent(!0,null,void 0,!0)}}catch(i){if(this._p2pChannel.reportPublishEvent(!1,i?.code,void 0,!0),i?.code===C.WS_ABORT)return;throw i}})}_createLiveStreamingClient(t){let e=()=>{if(!this._joinInfo||!this._appId)return new x(C.INVALID_OPERATION,"can not create live streaming client, please join channel first").throw();let i=(n={joinInfo:this._joinInfo,appId:this._appId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig},no("LiveStreaming").create(n));var n;return i.onLiveStreamError=(r,o)=>{ot.reportApiInvoke(this._sessionId,{name:be.ON_LIVE_STREAM_ERROR,options:[r,o],tag:Ee.TRACER}).onSuccess(),this.safeEmit(It.LIVE_STREAMING_ERROR,r,o)},i.onLiveStreamWarning=(r,o)=>{ot.reportApiInvoke(this._sessionId,{name:be.ON_LIVE_STREAM_WARNING,options:[r,o],tag:Ee.TRACER}).onSuccess(),this.safeEmit(It.LIVE_STREAMING_WARNING,r,o)},i.on(lg.REQUEST_WORKER_MANAGER_LIST,(r,o,s)=>{if(!this._joinInfo)return s(new x(C.INVALID_OPERATION,"can not find join info to get worker manager"));(function(a,c,d,l){return I(this,null,function*(){let u=A("UAP_AP").slice(0,A("AJAX_REQUEST_CONCURRENT")).map(h=>c.proxyServer?"https://".concat(c.proxyServer,"/ap/?url=").concat(h+"/api/v1?action=uap"):"https://".concat(h,"/api/v1?action=uap"));return yield W6(u,a,c,d,l)})})(r,this._joinInfo,this._axiosCancelSource.token,Oe).then(o).catch(s)}),i};return t===Ar.RAW?(this._liveRawStreamingClient=this._liveRawStreamingClient||e(),this._liveRawStreamingClient):(this._liveTranscodeStreamingClient=this._liveTranscodeStreamingClient||e(),this._liveTranscodeStreamingClient)}_createChannelMediaRelayClient(){if(!this._joinInfo)return new x(C.INVALID_OPERATION,"can not create channel media relay client, please join channel first").throw();if(!this._channelMediaRelayClient){let{sendResolutionWidth:e,sendResolutionHeight:i}=this.getLocalVideoStats(),n=(t={joinInfo:this._joinInfo,clientId:this._clientId,websocketRetryConfig:this._config.websocketRetryConfig,httpRetryConfig:this._config.httpRetryConfig,resolution:{width:e,height:i}},no("ChannelMediaRelay").create(t));n.on("state",r=>{r===ki.RELAY_STATE_FAILURE&&n&&n.dispose(),this.safeEmit(It.CHANNEL_MEDIA_RELAY_STATE,r)}),n.on("event",r=>{this.safeEmit(It.CHANNEL_MEDIA_RELAY_EVENT,r)}),this._channelMediaRelayClient=n,this._statsCollector.onStatsChanged=(r,o)=>{var s;r==="resolution"&&((s=this._channelMediaRelayClient)===null||s===void 0||s.setVideoProfile(o))}}var t;return this._channelMediaRelayClient}_handleUpdateDataChannel(t,e){let{added:i,deleted:n}=t,r=[];if(e){let o=[];this._users.forEach(s=>{s._dataChannels.forEach(a=>{i.every(c=>c.uid!==s._uintid||c.stream_id!==a.id)&&o.push({uid:s._uintid,stream_id:a.id,ordered:a.ordered,max_retrans_times:a.maxRetransmits,metadata:a.metadata})})}),o.length>0&&this._handleUpdateDataChannel({added:[],deleted:o})}Array.isArray(i)&&i.length>0&&i.forEach(o=>{let{uid:s,stream_id:a,ordered:c,max_retrans_times:d,metadata:l}=o,u=this._users.find(h=>h._uintid===s);if(!u)return void _.error("[".concat(this._clientId,"] can not find target user!(on_add_data_channel)"));if(_.debug("[".concat(this._clientId,"] data_channel added with uid ").concat(s)),z(r).call(r,u)||r.push(u),u._uintid||(u._uintid=s),u._dataChannels.findIndex(h=>h.id===o.stream_id)===-1){let h={id:a,ordered:!!c,maxRetransmits:d,metadata:l},p=function(g){return nN(g,!0)}(h);u._dataChannels.push(p),_.info("[".concat(this._clientId,"] remote user ").concat(u.uid," published datachannel")),e||this.safeEmit(It.USER_PUBLISHED,u,"datachannel",h)}this._p2pChannel.hasPendingRemoteDataChannel(u,o.stream_id)&&(_.debug("[".concat(this._clientId,"] resubscribe datachannel for user ").concat(u.uid," after reconnect.")),this._subscribeDataChannel(u,o.stream_id).catch(h=>{_.error("[".concat(this._clientId,"] resubscribe datachannel error"),h.toString())}))}),e&&(this.safeEmit(It.PUBLISHED_USER_LIST,this._pendingPublishedUsers),this._pendingPublishedUsers=[]),Array.isArray(n)&&n.length>0&&n.forEach(o=>{let{uid:s,stream_id:a}=o,c=this._users.find(l=>l._uintid===s);if(!c)return void _.error("[".concat(this._clientId,"] can not find target user!(on_delete_data_channel)"));let d=c._dataChannels.find(l=>l.id===o.stream_id);d&&(_.debug("[".concat(this._clientId,"] data_stream delete with uid ").concat(s)),this._p2pChannel.unsubscribeDataChannel(c,[d]).then(l=>{if(c._dataChannels=c._dataChannels.filter(u=>u!==d),l)return this._gateway.unsubscribeDataChannel(l,c.uid)}),_.info("[".concat(this._clientId,"] remote user ").concat(s," unpublished datachannel ,id:").concat(d.id)),this.safeEmit(It.USER_UNPUBLISHED,c,"datachannel",d._config))})}_handleRemoveDataChannels(t){let e=this._users.find(i=>i.uid===t.uid);if(e){if(e._dataChannels!==void 0&&e._dataChannels.length>0){_.debug("[".concat(this._clientId,"] datachannel removed with uid ").concat(t.uid));let i=()=>{_.info("[".concat(this._clientId,"] remote user ").concat(e.uid," unpublished datachannel")),e._dataChannels.forEach(n=>{this.safeEmit(It.USER_UNPUBLISHED,e,"datachannel",n._config)})};this._p2pChannel.unsubscribeDataChannel(e,e._dataChannels).then(n=>{if(n)return this._gateway.unsubscribeDataChannel(n,e.uid)}),i()}}else _.warning("[".concat(this._clientId,"] can not find target user!(on_remove_datachannel)"))}_handleGatewayEvents(){this._gateway.on(je.UPDATE_GATEWAY_CONFIG,()=>{(function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void _.error("Error loading sdk config",e.message)}if(t)try{let e=JSON.parse(window.atob(t)),i=Date.now();Object.keys(e).forEach(n=>{let{value:r,type:o,expires:s}=e[n];s&&s<=i||o||ng()||!Object.prototype.hasOwnProperty.call(Rh,n)||(ir[n]=r,ae[n]=r,_.debug("Update gateway parameters from config distribute",n,r))})}catch(e){_.error("Error update config from local cache",e.message)}})()}),this._gateway.on(je.DISCONNECT_P2P,()=>I(this,null,function*(){yield this._p2pChannel.disconnectForReconnect()})),this._gateway.on(je.CONNECTION_STATE_CHANGE,(t,e,i)=>{var n;if(i===Ft.FALLBACK)return;let r=()=>{this.safeEmit(It.CONNECTION_STATE_CHANGE,t,e,i)};if(ot.reportApiInvoke(this._sessionId||((n=this._gateway.joinInfo)===null||n===void 0?void 0:n.sid)||null,{name:be.CONNECTION_STATE_CHANGE,options:[t,e,i],tag:Ee.TRACER}).onSuccess(JSON.stringify({cur:t,prev:e,reason:i})),_.info("[".concat(this._clientId,"] signal connection state change: ").concat(e," -> ").concat(t)),t==="DISCONNECTED")return this._reset(),void r();if(t==="RECONNECTING")this._users.forEach(s=>{s._trust_in_room_=!1,s._trust_audio_enabled_state_=!1,s._trust_video_enabled_state_=!1,s._trust_audio_mute_state_=!1,s._trust_video_mute_state_=!1,s._trust_audio_stream_added_state_=!1,s._trust_video_stream_added_state_=!1,s._is_pre_created||(s._audio_pre_subscribed||(s._audioSSRC=void 0,s._audioOrtc=void 0),s._video_pre_subscribed||(s._videoSSRC=void 0,s._videoOrtc=void 0,s._rtxSsrcId=void 0),s._cname=void 0)}),this._userOfflineTimeout&&window.clearTimeout(this._userOfflineTimeout),this._streamRemovedTimeout&&window.clearTimeout(this._streamRemovedTimeout),this._userOfflineTimeout=void 0,this._streamRemovedTimeout=void 0;else if(t==="CONNECTED"){var o;this._streamFallbackTypeCacheMap.forEach((s,a)=>{this._gateway.setStreamFallbackOption(a,s).catch(c=>{_.warning("[".concat(this._clientId,"] auto set stream fallback option failed"),c)})}),this._remoteStreamTypeCacheMap.forEach((s,a)=>{this._gateway.setRemoteVideoStreamType(a,s).catch(c=>{_.warning("[".concat(this._clientId,"] auto set remote stream type failed"),c)})}),this._remoteDefaultVideoStreamType!==void 0&&((o=this._joinInfo)===null||o===void 0?void 0:o.defaultVideoStream)===void 0&&this.setRemoteDefaultVideoStreamType(this._remoteDefaultVideoStreamType).then(()=>{_.debug("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway connected"))}).catch(s=>{_.error("[".concat(this._clientId,"] setRemoteDefaultVideoStreamType after gateway failed, ").concat(s))}),this.store.useP2P||(this._p2pChannel.republish(),this._userOfflineTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._userOfflineTimeout=void 0,this._users.filter(s=>!s._trust_in_room_).forEach(s=>{_.debug("[".concat(this._clientId,"] user offline timeout, emit user offline ").concat(s.uid)),this._handleUserOffline({uid:s.uid})}))},3e3),this._streamRemovedTimeout=window.setTimeout(()=>{this.connectionState==="CONNECTED"&&(this._streamRemovedTimeout=void 0,this._users.forEach(s=>{s._trust_audio_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch audio unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,$.AUDIO,!1)),s._trust_video_mute_state_||(_.debug("[".concat(this._clientId,"] auto dispatch video unmute event ").concat(s.uid)),this._handleMuteStream(s.uid,$.VIDEO,!1)),s._trust_audio_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local audio ").concat(s.uid)),this._handleSetStreamLocalEnable("audio",s.uid,!0)),s._trust_video_enabled_state_||(_.debug("[".concat(this._clientId,"] auto dispatch enable local video ").concat(s.uid)),this._handleSetStreamLocalEnable("video",s.uid,!0)),s._trust_video_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset video stream added ").concat(s.uid)),this._handleResetAddStream(s,"video")),s._trust_audio_stream_added_state_||(_.debug("[".concat(this._clientId,"] auto dispatch reset audio stream added ").concat(s.uid)),this._handleResetAddStream(s,"audio")),s._video_added_||s._audio_added_||(_.debug("[".concat(this._clientId,"] auto dispatch stream remove ").concat(s.uid)),this._handleRemoveStream({uid:s.uid,uint_id:s._uintid}))}))},1e3))}r()}),this._gateway.on(je.REQUEST_NEW_GATEWAY_LIST,(t,e)=>I(this,null,function*(){if(!this._joinInfo)return e(new x(C.UNEXPECTED_ERROR,"can not recover, no join info"));try{let i,n=yield KN(Gn(Gn({},this._joinInfo),{},{uid:this._joinInfo.uid,stringUid:void 0}));n?(i=n.ap,zN(n),this._joinInfo.preload=!0):(i=yield Ag(this._joinInfo,this._axiosCancelSource.token,this._config.httpRetryConfig||Oe,this.store),this._joinInfo.preload=!1),this._joinInfo&&(this._joinInfo.apResponse=i.gatewayInfo.res,this._joinInfo.gatewayAddrs=i.gatewayInfo.gatewayAddrs,this._joinInfo.uni_lbs_ip=i.gatewayInfo.uni_lbs_ip);let r=[];i.gatewayInfo.gatewayAddrs.forEach(o=>{let{address:s}=o,[a,c]=s.split(":");this._joinInfo&&this._joinInfo.proxyServer?r.push({proxy:this._joinInfo.proxyServer,host:a,port:c}):r.push({host:a,port:c})}),t(r)}catch(i){e(i)}})),this._gateway.on(je.NETWORK_QUALITY,t=>{this._networkQualitySensitivity==="normal"&&this.safeEmit(It.NETWORK_QUALITY,t)}),this._gateway.on(je.STREAM_TYPE_CHANGE,(t,e)=>{this.safeEmit(It.STREAM_TYPE_CHANGED,t,e),ot.reportApiInvoke(this._sessionId,{name:be.STREAM_TYPE_CHANGE,options:[t,e],tag:Ee.TRACER}).onSuccess(JSON.stringify({uid:t,streamType:e}))}),this._gateway.on(je.IS_P2P_DISCONNECTED,t=>{this._p2pChannel.isP2PDisconnected()?t(!0):this._p2pChannel.hasLocalMedia()||this._p2pChannel.hasRemoteMedia()?t(!1):t(!0)}),this._gateway.on(je.REQUEST_P2P_CONNECTION_PARAMS,(t,e,i)=>I(this,null,function*(){try{let n=yield this._p2pChannel.getEstablishParams();A("ENABLE_PREALLOC_PC")&&n||(n=yield this._p2pChannel.startP2PConnection(t)),e(n)}catch(n){i(n)}})),this._gateway.on(je.JOIN_RESPONSE,(t,e)=>{if(this.store.useP2P)return;let i;t.attributes?i=t.attributes.userAttributes.preSubSsrcs:_.debug("no attributes in joinResponse");let n=KO(t.ortc,e,i);this._p2pChannel.connect(n)}),this._gateway.on(je.PRE_CONNECT_PC,t=>I(this,null,function*(){let{candidates:e,fingerprint:i}=t;if(this._joinInfo&&e.length>0&&!this._p2pChannel.isPlanB){var n;yield this._p2pChannel.startP2PConnection({turnServer:this._joinInfo.turnServer});let{cert:r,cid:o}=this._joinInfo.apResponse;yield this._p2pChannel.connect({iceParameters:{iceUfrag:"".concat(o,"_").concat(r),icePwd:"".concat(o,"_").concat(r)},dtlsParameters:{fingerprints:[{hashFunction:"sha-256",fingerprint:(n=A("FINGERPRINT"))!==null&&n!==void 0?n:i}]},candidates:e,rtpCapabilities:{send:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},recv:{audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]}},setup:"active",cname:"o/i14u9pJrxRKAsu",preallocation:!0})}}))}_handleGatewaySignalEvents(){this._gateway.signal.on(wt.ON_USER_ONLINE,this._handleUserOnline),this._gateway.signal.on(wt.ON_USER_OFFLINE,this._handleUserOffline),this._gateway.signal.on(wt.ON_ADD_AUDIO_STREAM,t=>this._handleAddAudioOrVideoStream("audio",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc)),this._gateway.signal.on(wt.ON_ADD_VIDEO_STREAM,t=>this._handleAddAudioOrVideoStream("video",t.uid,t.ssrcId,t.cname,t.uint_id,t.ortc,t.rtxSsrcId)),this._gateway.signal.on(wt.ON_REMOTE_DATASTREAM_UPDATE,t=>{this._handleUpdateDataChannel(t)}),this._gateway.signal.on(wt.ON_REMOTE_FULL_DATASTREAM_INFO,t=>{this._handleUpdateDataChannel({added:t.datastreams||[],deleted:[]},!0)}),this._gateway.signal.on(wt.ON_REMOVE_STREAM,this._handleRemoveStream),this._gateway.signal.on(wt.ON_P2P_LOST,this._handleP2PLost),this._gateway.signal.on(wt.MUTE_AUDIO,t=>this._handleMuteStream(t.uid,$.AUDIO,!0)),this._gateway.signal.on(wt.UNMUTE_AUDIO,t=>this._handleMuteStream(t.uid,$.AUDIO,!1)),this._gateway.signal.on(wt.MUTE_VIDEO,t=>this._handleMuteStream(t.uid,$.VIDEO,!0)),this._gateway.signal.on(wt.UNMUTE_VIDEO,t=>this._handleMuteStream(t.uid,$.VIDEO,!1)),this._gateway.signal.on(wt.RECEIVE_METADATA,t=>{let e=Ts(t.metadata);this.safeEmit(It.RECEIVE_METADATA,t.uid,e)}),this._gateway.signal.on(wt.ON_DATA_STREAM,t=>I(this,null,function*(){var e;if(!t)return;let i=Ts(t.payload);if(this._encryptDataStream&&this._encryptDataStreamIv&&this._encryptDataStreamKey&&window.crypto.subtle&&z(e=["aes-128-gcm2","aes-256-gcm2"]).call(e,this._encryptionMode)){if(t.payload.length<xa)throw new x(C.UNEXPECTED_RESPONSE,"payload length ".concat(t.payload.length," is less than header length ").concat(xa));i=yield function(o,s,a){return I(this,null,function*(){let c=a.subarray(0,xa),d=c.slice(8,xa),l=(d[0]<<8)+d[1],u=(c[6]<<8)+c[7],h=yield window.crypto.subtle.decrypt({name:"AES-GCM",iv:o,tagLength:nw,additionalData:new Uint8Array(HA(l,2))},s,a.subarray(xa));return new Uint8Array(h).subarray(0,u)})}(this._encryptDataStreamIv,this._encryptDataStreamKey,i)}let n=0;if(t.ordered||t.syncWithAudio){let r=this._p2pChannel.getStats(),o=this.remoteUsers.find(a=>a.uid===t.uid),s=r?.audioRecv.find(a=>a.ssrc===o?._audioSSRC);n=s?.jitterBufferMs}(n==null||Number.isNaN(n))&&(n=0),sq(Gn(Gn({},t),{},{payload:i}),n,{id:this._clientId,onStreamMessage:typeof this.onStreamMessage=="function"?this.onStreamMessage.bind(this):void 0,safeEmit:this.safeEmit.bind(this)})})),this._gateway.signal.on(wt.ON_CRYPT_ERROR,()=>{Mo(()=>{_.warning("[".concat(this._clientId,"] on crypt error")),this.safeEmit(It.CRYPT_ERROR)},this._sessionId)}),this._gateway.signal.on(wt.ON_TOKEN_PRIVILEGE_WILL_EXPIRE,this._handleTokenWillExpire),this._gateway.signal.on(wt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{_.warning("[".concat(this._clientId,"] received message onTokenPrivilegeDidExpire, please get new token and join again")),this._gateway.leave(!0,Ft.TOKEN_EXPIRE),this.safeEmit(It.ON_TOKEN_PRIVILEGE_DID_EXPIRE),this._reset()}),this._gateway.signal.on(wt.ON_STREAM_FALLBACK_UPDATE,t=>{_.debug("[".concat(this._clientId,"] stream fallback peerId: ").concat(t.stream_id,", attr: ").concat(t.stream_type)),this.safeEmit(It.STREAM_FALLBACK,t.stream_id,t.stream_type===1?"fallback":"recover")}),this._gateway.signal.on(wt.ON_PUBLISH_STREAM,t=>{this.uid===this._uid&&(this._p2pChannel.reportPublishEvent(!0,null,void 0,!1,JSON.stringify({proxy:t.proxy})),_.info("[".concat(this._clientId,"] on publish stream, ").concat(JSON.stringify(t))))}),this._gateway.signal.on(wt.ENABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!0)}),this._gateway.signal.on(wt.DISABLE_LOCAL_VIDEO,t=>{this._handleSetStreamLocalEnable("video",t.uid,!1)}),this._gateway.signal.on(Et.REQUEST_TIMEOUT,(t,e)=>{if(this._joinInfo)switch(t){case pt.PUBLISH:{if(!e)return;let r=e.ortc;if(r){var i,n;let o=r.some(c=>{let{stream_type:d}=c;return d===Gt.Audio}),s=r.some(c=>{let{stream_type:d}=c;return d!==Gt.Audio}),a=r.some(c=>{let{stream_type:d}=c;return d===Gt.Screen||d===Gt.ScreenLow});e.state==="offer"&&ot.publish(this._joinInfo.sid,{eventElapse:si.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:!1,ec:C.TIMEOUT,audio:o,video:s,p2pid:e.p2p_id,publishRequestid:this.store.pubId,screenshare:a,audioName:o?(i=r.find(c=>{let{stream_type:d}=c;return d===Gt.Audio}))===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId.toString():void 0,videoName:s?(n=r.find(c=>{let{stream_type:d}=c;return d!==Gt.Audio}))===null||n===void 0||(n=n.ssrcs[0])===null||n===void 0?void 0:n.ssrcId.toString():void 0})}break}case pt.SUBSCRIBE:e&&ot.subscribe(this._joinInfo.sid,{succ:!1,ec:C.TIMEOUT,audio:e.stream_type===$.AUDIO,video:e.stream_type===$.VIDEO,peerid:e.stream_id,subscribeRequestid:e.ssrcId,p2pid:this.store.p2pId,eventElapse:si.measureFromSubscribeStart(this.store.clientId,e.ssrcId),preSsrc:this._p2pChannel.isPreSubScribe(e.ssrcId)})}}),this._gateway.signal.on(wt.ON_P2P_OK,t=>{this.uid,this._uid}),this._gateway.signal.on(wt.ON_PUBLISHED_USER_LIST,t=>{if(t==null||!t.users)return;A("BLOCK_LOCAL_CLIENT")&&(t.users=t.users.filter(n=>!Os(n.string_id||n.stream_id,this.channelName)));let e=[],i=[];for(let n of t.users){let r=this._users.find(l=>l._uintid===n.stream_id);r?r._trust_in_room_=!0:(r=new Ho(n.string_id||n.stream_id,n.stream_id),this._users.push(r),this.getListeners(It.PUBLISHED_USER_LIST).length===0&&(_.debug("[".concat(this._clientId,"] user online"),n.stream_id),this.safeEmit(It.USER_JOINED,r)));let o=Be.Audio&n.stream_type,s=(Be.Video|Be.LwoVideo)&n.stream_type,a=(65280&n.stream_type)!=0,c=o&&r.hasAudio,d=s&&r.hasVideo;s&&(r._trust_video_stream_added_state_=!0,r._video_added_=!0,r._videoSSRC=n.video_ssrc,r._rtxSsrcId=n.video_rtx),o&&(r._trust_audio_stream_added_state_=!0,r._audio_added_=!0,r._audioSSRC=n.audio_ssrc),o&&!c&&this.getListeners(It.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published audio")),this.safeEmit(It.USER_PUBLISHED,r,"audio")),s&&!d&&this.getListeners(It.PUBLISHED_USER_LIST).length===0&&(_.info("[".concat(this._clientId,"] remote user ").concat(r.uid," published video")),this.safeEmit(It.USER_PUBLISHED,r,"video")),(o&&!c||s&&!d||a)&&e.push(r),s&&this._p2pChannel.hasPendingRemoteMedia(r,"video")&&i.push({user:r,mediaType:"video"}),o&&this._p2pChannel.hasPendingRemoteMedia(r,"audio")&&i.push({user:r,mediaType:"audio"})}i.length>0&&(_.debug("[".concat(this._clientId,"] RE massSubscribe after reconnect ").concat(i.map(n=>"user: ".concat(n.user.uid,", mediaType: ").concat(n.mediaType)).join("; ")," ")),this.massSubscribe(i).catch(n=>{_.error("[".concat(this._clientId,"] mass resubscribe error"),n.toString())})),this.getListeners(It.PUBLISHED_USER_LIST).length>0?A("ENABLE_DATASTREAM_2")?this._pendingPublishedUsers=e:(_.info("[".concat(this._clientId,"] client emit user-list event, users: ").concat(e.map(n=>n.uid).join(", "))),this.safeEmit(It.PUBLISHED_USER_LIST,e)):_.info("[".concat(this._clientId,"] client not emit user-list event case there is no user-list listener, users: ").concat(e.map(n=>n.uid).join(", ")))}),this._gateway.signal.on(wt.ON_RTP_CAPABILITY_CHANGE,t=>{let{video_codec:e}=t;this._p2pChannel instanceof Bd&&this._p2pChannel.updateRemoteRTPCapabilities(e.map(i=>i.toLowerCase()).filter(i=>{var n;return z(n=Object.keys(vh)).call(n,i)}))})}_handleP2PEvents(){this._gateway.signal.on(wt.ON_USER_OFFLINE,()=>{this._p2pChannel.disconnectForReconnect()}),this._gateway.signal.on(ye.PUBLISH,(t,e,i)=>{let{uid:n}=t;t.forEach(r=>{let{kind:o,ssrcs:s,mid:a,isMuted:c}=r;this._handleP2PAddAudioOrVideoStream(o,n,s[0].ssrcId,a);let d=this._users.find(l=>l.uid===n);return d&&this.store.useP2P?this._p2pChannel.mockSubscribe(d,o,s[0].ssrcId,a).then(()=>{e()}).catch(i):e(),this._handleMuteStream(n,o,!!c)})}),this._gateway.signal.on(ye.CALL,(t,e,i)=>I(this,null,function*(){if(this.store.useP2P)try{var n;e(yield this._p2pChannel.startP2P({turnServer:(n=this._joinInfo)===null||n===void 0?void 0:n.turnServer},t))}catch(r){i(r)}})),this._gateway.signal.on(Et.P2P_CONNECTION,t=>I(this,null,function*(){this.store.useP2P&&(yield this._p2pChannel).p2pConnect(t)})),this._gateway.signal.on(ye.UNPUBLISH,(t,e,i)=>I(this,null,function*(){if(this.store.useP2P){let{unpubMsg:n,uid:r}=t,o=this._users.find(s=>s.uid===r);if(!o)return _.warning("[".concat(this._clientId,"] can not find remote user, ignore mute event, uid: ").concat(r)),void e();try{n.forEach(s=>I(this,null,function*(){let{stream_type:a}=s,c=a===Gt.Audio?$.AUDIO:$.VIDEO;yield this._p2pChannel.unsubscribe(o,c),this._handleMuteStream(r,c,!0)})),e()}catch(s){i(s)}}})),this._gateway.signal.on(ye.CONTROL,(t,e)=>I(this,null,function*(){let{action:i}=t;switch(i){case Fo.MUTE_LOCAL_VIDEO:this._handleMuteStream(e,$.VIDEO,!0);break;case Fo.MUTE_LOCAL_AUDIO:this._handleMuteStream(e,$.AUDIO,!0);break;case Fo.UNMUTE_LOCAL_VIDEO:this._handleP2PAddAudioOrVideoStream("video",e),this._handleMuteStream(e,$.VIDEO,!1);break;case Fo.UNMUTE_LOCAL_AUDIO:this._handleP2PAddAudioOrVideoStream("audio",e),this._handleMuteStream(e,$.AUDIO,!1)}})),this._gateway.signal.on(ye.RESTART_ICE,(t,e,i)=>I(this,null,function*(){if(this.store.useP2P)try{let{direction:n,iceParameter:r}=t;n!==Ti.SEND_ONLY||r?e(yield this._p2pChannel.restartICE(n,r)):(this._p2pChannel.handleDisconnect(n),e())}catch(n){i(n)}})),this._gateway.signal.on(ye.CANDIDATE,t=>{if(this.store.useP2P){let{candidate:e,direction:i}=t;this._p2pChannel.addRemoteCandidate(e,i)}}),this._p2pChannel.on(at.RequestP2PRestartICE,(t,e,i)=>I(this,null,function*(){try{let{direction:n}=t;e(yield this._gateway.sendExtensionMessage(ye.RESTART_ICE,t,n===Ti.SEND_ONLY))}catch(n){i(n)}})),this._p2pChannel.on(at.LocalCandidate,t=>{this._gateway.sendExtensionMessage(ye.CANDIDATE,JSON.stringify(t),!0)}),this._p2pChannel.on(at.RequestP2PMuteLocal,(t,e,i)=>I(this,null,function*(){try{yield this._gateway.sendExtensionMessage(ye.CONTROL,t,!0),e()}catch(n){i(n)}})),this._p2pChannel.on(at.RequestP2PUnmuteRemote,(t,e,i)=>I(this,null,function*(){if(this._joinInfo)try{yield this._gateway.unmuteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(n){n.code===C.DISCONNECT_P2P?e():i(n)}else e()})),this._p2pChannel.on(at.RequestP2PMuteRemote,(t,e,i)=>I(this,null,function*(){if(this._joinInfo)try{yield this._gateway.muteRemote(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(n){n.code===C.DISCONNECT_P2P?e():i(n)}else e()})),this._p2pChannel.on(at.StateChange,(t,e)=>{e===Bt.Connected&&this._p2pChannel.republish()})}_handleP2PChannelEvents(){this._p2pChannel.on(at.PeerConnectionStateChange,t=>{let e=this._peerConnectionState;t!==e&&(this.safeEmit(It.PEERCONNECTION_STATE_CHANGE,t,e),this._peerConnectionState=t)}),this._p2pChannel.on(at.RequestMuteLocal,(t,e,i)=>I(this,null,function*(){if(this._joinInfo)try{yield this._gateway.muteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(n){n.code===C.DISCONNECT_P2P?e():i(n)}else e()})),this._p2pChannel.on(at.RequestUnmuteLocal,(t,e,i)=>I(this,null,function*(){if(this._joinInfo)try{yield this._gateway.unmuteLocal(t,this._joinInfo.stringUid||this._joinInfo.uid),e()}catch(n){n.code===C.DISCONNECT_P2P?e():i(n)}else e()})),this._p2pChannel.on(at.RequestRePublish,(t,e,i)=>{this.publish(t,!1).then(e).catch(i)}),this._p2pChannel.on(at.RequestRePublishDataChannel,(t,e,i)=>{Q.all(t.map(n=>I(this,null,function*(){let r=yield this._p2pChannel.publishDataChannel([n]);try{r.forEach(o=>{this._uid&&this._gateway.publishDataChannel(this._uid,o,!0)})}catch(o){if(o.code!==C.DISCONNECT_P2P)throw o}}))).then(e).catch(i)}),this._p2pChannel.on(at.RequestReSubscribe,(t,e,i)=>I(this,null,function*(){try{for(let{user:n,kind:r}of t)r===$.VIDEO?yield this.subscribe(n,"video"):yield this.subscribe(n,"audio");e()}catch(n){i(n)}})),this._p2pChannel.on(at.RequestUpload,(t,e)=>{this._gateway.upload(t,e)}),this._p2pChannel.on(at.RequestUploadStats,t=>{this._gateway.uploadWRTCStats(t)}),this._p2pChannel.on(at.MediaReconnectStart,t=>{this.safeEmit(It.MEDIA_RECONNECT_START,t)}),this._p2pChannel.on(at.MediaReconnectEnd,t=>{this.safeEmit(It.MEDIA_RECONNECT_END,t)}),this._p2pChannel.on(at.NeedSignalRTT,t=>{t(this._gateway.getSignalRTT())}),this._p2pChannel.on(at.RequestRestartICE,t=>I(this,null,function*(){if(this.store.useP2P)return;let e=yield this._p2pChannel.restartICE(t),i=yield e.next();if(i.done)return;let n=i.value,r;try{r=yield this._gateway.restartICE({iceParameters:n})}catch(s){return void e.throw(s)}let{iceParameters:o}=function(s){let a=s.iceParameters;return{iceParameters:{iceUfrag:a.iceUfrag,icePwd:a.icePwd}}}(r);yield e.next({remoteIceParameters:o})})),this._p2pChannel.on(at.RequestReconnect,()=>I(this,null,function*(){this._gateway.reconnect()})),this._p2pChannel.on(at.RequestReconnectPC,()=>I(this,null,function*(){var t;let{iceParameters:e,dtlsParameters:i,rtpCapabilities:n}=yield this._p2pChannel.startP2PConnection({turnServer:(t=this._joinInfo)===null||t===void 0?void 0:t.turnServer}),{gatewayEstablishParams:r,gatewayAddress:o}=yield this._gateway.reconnectPC({iceParameters:e,dtlsParameters:i,rtpCapabilities:n}),s=KO(r,o);yield this._p2pChannel.connect(s),yield this._p2pChannel.republish(),yield this._p2pChannel.reSubscribe()})),this._p2pChannel.on(at.RequestUnpublishForReconnectPC,(t,e,i)=>I(this,null,function*(){this._joinInfo&&this._uid!==void 0?(yield this._gateway.unpublish(t,this._uid),e()):i()})),this._p2pChannel.on(at.P2PLost,()=>{this.safeEmit(It.P2P_LOST,this.store.uid)}),this._p2pChannel.on(at.UpdateVideoEncoder,t=>{t._encoderConfig&&this._gateway.setVideoProfile(t._encoderConfig)}),this._p2pChannel.on(at.ConnectionTypeChange,t=>{this.safeEmit(It.IS_USING_CLOUD_PROXY,t)}),this._p2pChannel.on(at.RequestLowStreamParameter,t=>{t(this._lowStreamParameter||{width:160,height:120,framerate:15,bitrate:50})}),this._p2pChannel.on(at.QueryClientConnectionState,t=>{t(this.connectionState)}),this._p2pChannel.on(at.AudioMetadata,t=>{this.safeEmit(It.AUDIO_METADATA,t)})}getKeyMetrics(){return this.store.keyMetrics}enableContentInspect(t){return I(this,null,function*(){if(!this._joinInfo||this.connectionState!=="CONNECTED")throw new x(C.INVALID_OPERATION,"[".concat(this._clientId,"] can not create content inspect, please join channel first"));if(this._inspect)throw new x(C.INVALID_OPERATION,"[".concat(this._clientId,"] Inspect content service already in connecting/connected state"));try{let i=(e={config:t},no("ContentInspect").create(e));this._inspect=i,this.handleVideoInspectEvents(i);let{appId:n,cname:r,sid:o,token:s,uid:a,cid:c,vid:d}=this._joinInfo;yield i.init({appId:n,areaCode:"",cname:r,sid:o,token:s,uid:a,cid:c,vid:d?Number(d):0},Oe)}catch(i){throw Array.isArray(i)?i[0]:i}var e})}handleVideoInspectEvents(t){t.on(Ge.CONNECTION_STATE_CHANGE,(e,i)=>{if(this.safeEmit(It.CONTENT_INSPECT_CONNECTION_STATE_CHANGE,e,i),i===xn.CONNECTED){if(this.connectionState!=="CONNECTED")return void this.safeEmit(It.CONTENT_INSPECT_ERROR,new x(C.OPERATION_ABORTED,"Content inspect was cancelled because it left the channel"));t.inspectImage()}}),t.on(Ge.INSPECT_RESULT,(e,i)=>{var n;if(i?.code===C.INVALID_OPERATION&&this.connectionState==="DISCONNECTED")return _.debug("Stop inspect content because that has left channel"),this==null||(n=this._inspect)===null||n===void 0||n.close(),void(this._inspect=void 0);this.safeEmit(It.CONTENT_INSPECT_RESULT,e,i)}),t.on(Ge.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}disableContentInspect(){return I(this,null,function*(){if(!this._inspect)throw new x(C.INVALID_OPERATION,"[".concat(this._clientId,"] inspectVideoContent not started"));try{this._inspect.close(),this._inspect=void 0}catch(t){throw Array.isArray(t)?t[0]:t}})}setImageModeration(t,e){return I(this,null,function*(){if(Zr(t,"enabled"),t){if(!e)throw new x(C.INVALID_PARAMS,"config is required");if(dD(e),!this._joinInfo)throw new x(C.INVALID_OPERATION,"can not create image moderation, please join channel first");try{if(this._moderation)this._moderation.updateConfig(e);else{let n=(i={config:e},no("ImageModeration").create(i));this._moderation=n,this.handleImageModerationEvents(n);let{appId:r,cname:o,sid:s,token:a,uid:c,cid:d,vid:l}=this._joinInfo;yield n.init({appId:r,areaCode:"",cname:o,sid:s,token:a,uid:c,cid:d,vid:l?Number(l):0},Oe)}}catch(n){throw Array.isArray(n)?n[0]:n}}else{var i;if(!this._moderation)throw new x(C.INVALID_OPERATION,"[".concat(this._clientId,"] image moderation not started"));try{this._moderation.close(),this._moderation.removeAllListeners(),this._moderation=void 0}catch(n){throw Array.isArray(n)?n[0]:n}}})}handleImageModerationEvents(t){t.on(or.CONNECTION_STATE_CHANGE,(e,i)=>{if(this.safeEmit(It.IMAGE_MODERATION_CONNECTION_STATE_CHANGE,e,i),e===mn.CONNECTED){if(this.connectionState!=="CONNECTED")throw this.setImageModeration(!1),new x(C.OPERATION_ABORTED,"Image moderation was cancelled because it left the channel");t.inspectImage()}}),t.on(or.CLIENT_LOCAL_VIDEO_TRACK,e=>{e(this.localTracks.filter(i=>i.trackMediaType==="video")[0])})}setP2PTransport(t){if(function(e){xe(e,"transport",["default","auto","relay","sd-rtn"])}(t),this.mode!=="p2p")throw new x(C.INVALID_OPERATION,"only p2p mode can set p2pTransport");this.store.p2pTransport=t,_.info("[".concat(this._clientId,"] set client p2pTransport to ").concat(t))}getJoinChannelServiceRecords(){return _.debug("getJoinChannelServiceRecords"),this.store.joinChannelServiceRecords}setPublishAudioFilterEnabled(t){return I(this,null,function*(){Zr(t,"enabled"),qt("ENABLE_PUBLISH_AUDIO_FILTER",t),this._joinInfo&&(yield this._gateway.setPublishAudioFilterEnabled(t))})}_handleResetAddStream(t,e){switch(e){case"audio":t._audio_added_=!1,t._trust_audio_stream_added_state_=!0;break;case"video":t._video_added_=!1,t._trust_video_stream_added_state_=!0}}},rt(Z.prototype,"leave",[lD],Object.getOwnPropertyDescriptor(Z.prototype,"leave"),Z.prototype),rt(Z.prototype,"publish",[uD],Object.getOwnPropertyDescriptor(Z.prototype,"publish"),Z.prototype),rt(Z.prototype,"unpublish",[hD],Object.getOwnPropertyDescriptor(Z.prototype,"unpublish"),Z.prototype),rt(Z.prototype,"subscribe",[pD],Object.getOwnPropertyDescriptor(Z.prototype,"subscribe"),Z.prototype),rt(Z.prototype,"presubscribe",[_D],Object.getOwnPropertyDescriptor(Z.prototype,"presubscribe"),Z.prototype),rt(Z.prototype,"massSubscribe",[mD],Object.getOwnPropertyDescriptor(Z.prototype,"massSubscribe"),Z.prototype),rt(Z.prototype,"unsubscribe",[ED],Object.getOwnPropertyDescriptor(Z.prototype,"unsubscribe"),Z.prototype),rt(Z.prototype,"massUnsubscribe",[fD],Object.getOwnPropertyDescriptor(Z.prototype,"massUnsubscribe"),Z.prototype),rt(Z.prototype,"setLowStreamParameter",[gD],Object.getOwnPropertyDescriptor(Z.prototype,"setLowStreamParameter"),Z.prototype),rt(Z.prototype,"enableDualStream",[SD],Object.getOwnPropertyDescriptor(Z.prototype,"enableDualStream"),Z.prototype),rt(Z.prototype,"disableDualStream",[TD],Object.getOwnPropertyDescriptor(Z.prototype,"disableDualStream"),Z.prototype),rt(Z.prototype,"setClientRole",[RD],Object.getOwnPropertyDescriptor(Z.prototype,"setClientRole"),Z.prototype),rt(Z.prototype,"_setClientRoleOptions",[vD],Object.getOwnPropertyDescriptor(Z.prototype,"_setClientRoleOptions"),Z.prototype),rt(Z.prototype,"setProxyServer",[yD],Object.getOwnPropertyDescriptor(Z.prototype,"setProxyServer"),Z.prototype),rt(Z.prototype,"setTurnServer",[CD],Object.getOwnPropertyDescriptor(Z.prototype,"setTurnServer"),Z.prototype),rt(Z.prototype,"setLicense",[bD],Object.getOwnPropertyDescriptor(Z.prototype,"setLicense"),Z.prototype),rt(Z.prototype,"startProxyServer",[ID],Object.getOwnPropertyDescriptor(Z.prototype,"startProxyServer"),Z.prototype),rt(Z.prototype,"stopProxyServer",[AD],Object.getOwnPropertyDescriptor(Z.prototype,"stopProxyServer"),Z.prototype),rt(Z.prototype,"setLocalAccessPointsV2",[wD],Object.getOwnPropertyDescriptor(Z.prototype,"setLocalAccessPointsV2"),Z.prototype),rt(Z.prototype,"setLocalAccessPoints",[OD],Object.getOwnPropertyDescriptor(Z.prototype,"setLocalAccessPoints"),Z.prototype),rt(Z.prototype,"setRemoteDefaultVideoStreamType",[ND],Object.getOwnPropertyDescriptor(Z.prototype,"setRemoteDefaultVideoStreamType"),Z.prototype),rt(Z.prototype,"setRemoteVideoStreamType",[DD],Object.getOwnPropertyDescriptor(Z.prototype,"setRemoteVideoStreamType"),Z.prototype),rt(Z.prototype,"setStreamFallbackOption",[PD],Object.getOwnPropertyDescriptor(Z.prototype,"setStreamFallbackOption"),Z.prototype),rt(Z.prototype,"setEncryptionConfig",[LD],Object.getOwnPropertyDescriptor(Z.prototype,"setEncryptionConfig"),Z.prototype),rt(Z.prototype,"renewToken",[kD],Object.getOwnPropertyDescriptor(Z.prototype,"renewToken"),Z.prototype),rt(Z.prototype,"enableAudioVolumeIndicator",[MD],Object.getOwnPropertyDescriptor(Z.prototype,"enableAudioVolumeIndicator"),Z.prototype),rt(Z.prototype,"startLiveStreaming",[UD],Object.getOwnPropertyDescriptor(Z.prototype,"startLiveStreaming"),Z.prototype),rt(Z.prototype,"setLiveTranscoding",[xD],Object.getOwnPropertyDescriptor(Z.prototype,"setLiveTranscoding"),Z.prototype),rt(Z.prototype,"stopLiveStreaming",[VD],Object.getOwnPropertyDescriptor(Z.prototype,"stopLiveStreaming"),Z.prototype),rt(Z.prototype,"startChannelMediaRelay",[FD],Object.getOwnPropertyDescriptor(Z.prototype,"startChannelMediaRelay"),Z.prototype),rt(Z.prototype,"updateChannelMediaRelay",[BD],Object.getOwnPropertyDescriptor(Z.prototype,"updateChannelMediaRelay"),Z.prototype),rt(Z.prototype,"stopChannelMediaRelay",[jD],Object.getOwnPropertyDescriptor(Z.prototype,"stopChannelMediaRelay"),Z.prototype),rt(Z.prototype,"sendCustomReportMessage",[GD],Object.getOwnPropertyDescriptor(Z.prototype,"sendCustomReportMessage"),Z.prototype),rt(Z.prototype,"pickSVCLayer",[WD],Object.getOwnPropertyDescriptor(Z.prototype,"pickSVCLayer"),Z.prototype),rt(Z.prototype,"setRTMConfig",[HD],Object.getOwnPropertyDescriptor(Z.prototype,"setRTMConfig"),Z.prototype),rt(Z.prototype,"enableContentInspect",[KD],Object.getOwnPropertyDescriptor(Z.prototype,"enableContentInspect"),Z.prototype),rt(Z.prototype,"disableContentInspect",[qD],Object.getOwnPropertyDescriptor(Z.prototype,"disableContentInspect"),Z.prototype),rt(Z.prototype,"setImageModeration",[YD],Object.getOwnPropertyDescriptor(Z.prototype,"setImageModeration"),Z.prototype),rt(Z.prototype,"setP2PTransport",[zD],Object.getOwnPropertyDescriptor(Z.prototype,"setP2PTransport"),Z.prototype),rt(Z.prototype,"getJoinChannelServiceRecords",[XD],Object.getOwnPropertyDescriptor(Z.prototype,"getJoinChannelServiceRecords"),Z.prototype),rt(Z.prototype,"setPublishAudioFilterEnabled",[JD],Object.getOwnPropertyDescriptor(Z.prototype,"setPublishAudioFilterEnabled"),Z.prototype),Z);class Gd{constructor(e,i){T(this,"id",0),T(this,"element",void 0),T(this,"peerPair",void 0),T(this,"context",void 0),T(this,"audioPlayerElement",void 0),T(this,"audioTrack",void 0),Gd.count+=1,this.id=Gd.count,this.element=e,this.context=i}initPeers(){this.peerPair=[new RTCPeerConnection,new RTCPeerConnection],this.peerPair[1].ontrack=e=>{let i=document.createElement("audio");i.srcObject=new MediaStream([e.track]),i.play(),this.audioPlayerElement=i}}switchSdp(){return I(this,null,function*(){if(!this.peerPair)return;let e=(n,r)=>I(this,null,function*(){let o=r==="offer"?yield n.createOffer():yield n.createAnswer();return yield n.setLocalDescription(o),n.iceGatheringState==="complete"?n.localDescription:new Q(s=>{n.onicegatheringstatechange=()=>{n.iceGatheringState==="complete"&&s(n.localDescription)}})}),i=(n,r)=>I(this,null,function*(){return yield n.setRemoteDescription(r)});try{let n=yield e(this.peerPair[0],"offer");yield i(this.peerPair[1],n);let r=yield e(this.peerPair[1],"answer");yield i(this.peerPair[0],r)}catch(n){throw new x(C.LOCAL_AEC_ERROR,n.toString()).print()}})}getTracksFromMediaElement(e){return I(this,null,function*(){if(this.audioTrack)return this.audioTrack;let i;try{e instanceof HTMLVideoElement&&(e.captureStream?e.captureStream():e.mozCaptureStream()),i=this.context.createMediaStreamDestination(),this.context.createMediaElementSource(e).connect(i)}catch(r){throw new x(C.LOCAL_AEC_ERROR,r.toString()).print()}if(!i)throw new x(C.LOCAL_AEC_ERROR,"no dest node when local aec").print();let n=i.stream.getAudioTracks()[0];return this.audioTrack=n,n})}getElement(){return this.element}startEchoCancellation(){return I(this,null,function*(){this.context.resume(),this.peerPair&&this.close(),this.initPeers();let e=this.element,i=yield this.getTracksFromMediaElement(e);this.peerPair&&this.peerPair[0].addTrack(i),yield this.switchSdp()})}close(){_.debug("close echo cancellation unit, id is",this.id),this.audioPlayerElement&&this.audioPlayerElement.pause(),this.peerPair&&this.peerPair.forEach(e=>{e.close()}),this.peerPair=void 0,this.audioPlayerElement=void 0}}var ZD,pp;T(Gd,"count",0);let vq=window.AudioContext||window.webkitAudioContext,yq=new(ZD=ut({report:ot}),rt((pp=class{constructor(){T(this,"units",[]),T(this,"context",void 0)}processExternalMediaAEC(t){if(!this._doesEnvironmentNeedAEC())return _.debug("the system does not need to process local aec"),-1;this.context||(this.context=new vq);let e=this.units.find(i=>i&&i.getElement()===t);return e||(e=new Gd(t,this.context),this.units.push(e)),e.startEchoCancellation(),_.debug("start processing local audio echo cancellation, id is",e.id),e.id}_doesEnvironmentNeedAEC(){return kt().name!==xt.SAFARI}}).prototype,"processExternalMediaAEC",[ZD],Object.getOwnPropertyDescriptor(pp.prototype,"processExternalMediaAEC"),pp.prototype),pp);function $D(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function tP(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?$D(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):$D(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let Hg=window||document;function eP(t){let e=arguments.length>1&&arguments[1]!==void 0&&arguments[1];if(!Hg)return;let i=Ne._cspEventHandlerPointer;if(i&&e)return void console.error(i,e);let n=r=>{if(!(r&&r.blockedURI&&(Ne.onSecurityPolicyViolation||Ne.getListeners(wr.SECURITY_POLICY_VIOLATION).length>0)))return;let o=r.blockedURI;A("CSP_DETECTED_HOSTNAME_LIST").some(s=>z(o).call(o,s))&&(Ne.onSecurityPolicyViolation&&typeof Ne.onSecurityPolicyViolation=="function"&&Ne.onSecurityPolicyViolation(r),Ne.getListeners(wr.SECURITY_POLICY_VIOLATION).length>0&&Ne.safeEmit(wr.SECURITY_POLICY_VIOLATION,r))};i&&Hg.removeEventListener("securitypolicyviolation",i),(e||t&&typeof t=="function"||Ne.getListeners(wr.SECURITY_POLICY_VIOLATION).length>0)&&Hg.addEventListener("securitypolicyviolation",n),Ne._cspEventHandlerPointer=n}var Cq=Wt,bq=FI,iP=RegExp.prototype,Iq=function(t){return t===iP||Cq(iP,t)?bq(t):t.flags},_i=b(Iq);function uc(t){let e=t.length;for(;--e>=0;)t[e]=0}let Kg=256,nP=286,Wd=30,Hd=15,qg=new Uint8Array([0,0,0,0,0,0,0,0,1,1,1,1,2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,0]),_p=new Uint8Array([0,0,0,0,1,1,2,2,3,3,4,4,5,5,6,6,7,7,8,8,9,9,10,10,11,11,12,12,13,13]),Aq=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,3,7]),rP=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),oo=new Array(576);uc(oo);let Kd=new Array(60);uc(Kd);let qd=new Array(512);uc(qd);let Yd=new Array(256);uc(Yd);let Yg=new Array(29);uc(Yg);let mp=new Array(Wd);function zg(t,e,i,n,r){this.static_tree=t,this.extra_bits=e,this.extra_base=i,this.elems=n,this.max_length=r,this.has_stree=t&&t.length}let oP,sP,aP;function Xg(t,e){this.dyn_tree=t,this.max_code=0,this.stat_desc=e}uc(mp);let cP=t=>t<256?qd[t]:qd[256+(t>>>7)],zd=(t,e)=>{t.pending_buf[t.pending++]=255&e,t.pending_buf[t.pending++]=e>>>8&255},an=(t,e,i)=>{t.bi_valid>16-i?(t.bi_buf|=e<<t.bi_valid&65535,zd(t,t.bi_buf),t.bi_buf=e>>16-t.bi_valid,t.bi_valid+=i-16):(t.bi_buf|=e<<t.bi_valid&65535,t.bi_valid+=i)},Lr=(t,e,i)=>{an(t,i[2*e],i[2*e+1])},dP=(t,e)=>{let i=0;do i|=1&t,t>>>=1,i<<=1;while(--e>0);return i>>>1},lP=(t,e,i)=>{let n=new Array(16),r,o,s=0;for(r=1;r<=Hd;r++)s=s+i[r-1]<<1,n[r]=s;for(o=0;o<=e;o++){let a=t[2*o+1];a!==0&&(t[2*o]=dP(n[a]++,a))}},uP=t=>{let e;for(e=0;e<nP;e++)t.dyn_ltree[2*e]=0;for(e=0;e<Wd;e++)t.dyn_dtree[2*e]=0;for(e=0;e<19;e++)t.bl_tree[2*e]=0;t.dyn_ltree[512]=1,t.opt_len=t.static_len=0,t.sym_next=t.matches=0},hP=t=>{t.bi_valid>8?zd(t,t.bi_buf):t.bi_valid>0&&(t.pending_buf[t.pending++]=t.bi_buf),t.bi_buf=0,t.bi_valid=0},pP=(t,e,i,n)=>{let r=2*e,o=2*i;return t[r]<t[o]||t[r]===t[o]&&n[e]<=n[i]},Jg=(t,e,i)=>{let n=t.heap[i],r=i<<1;for(;r<=t.heap_len&&(r<t.heap_len&&pP(e,t.heap[r+1],t.heap[r],t.depth)&&r++,!pP(e,n,t.heap[r],t.depth));)t.heap[i]=t.heap[r],i=r,r<<=1;t.heap[i]=n},_P=(t,e,i)=>{let n,r,o,s,a=0;if(t.sym_next!==0)do n=255&t.pending_buf[t.sym_buf+a++],n+=(255&t.pending_buf[t.sym_buf+a++])<<8,r=t.pending_buf[t.sym_buf+a++],n===0?Lr(t,r,e):(o=Yd[r],Lr(t,o+Kg+1,e),s=qg[o],s!==0&&(r-=Yg[o],an(t,r,s)),n--,o=cP(n),Lr(t,o,i),s=_p[o],s!==0&&(n-=mp[o],an(t,n,s)));while(a<t.sym_next);Lr(t,256,e)},Qg=(t,e)=>{let i=e.dyn_tree,n=e.stat_desc.static_tree,r=e.stat_desc.has_stree,o=e.stat_desc.elems,s,a,c,d=-1;for(t.heap_len=0,t.heap_max=573,s=0;s<o;s++)i[2*s]!==0?(t.heap[++t.heap_len]=d=s,t.depth[s]=0):i[2*s+1]=0;for(;t.heap_len<2;)c=t.heap[++t.heap_len]=d<2?++d:0,i[2*c]=1,t.depth[c]=0,t.opt_len--,r&&(t.static_len-=n[2*c+1]);for(e.max_code=d,s=t.heap_len>>1;s>=1;s--)Jg(t,i,s);c=o;do s=t.heap[1],t.heap[1]=t.heap[t.heap_len--],Jg(t,i,1),a=t.heap[1],t.heap[--t.heap_max]=s,t.heap[--t.heap_max]=a,i[2*c]=i[2*s]+i[2*a],t.depth[c]=(t.depth[s]>=t.depth[a]?t.depth[s]:t.depth[a])+1,i[2*s+1]=i[2*a+1]=c,t.heap[1]=c++,Jg(t,i,1);while(t.heap_len>=2);t.heap[--t.heap_max]=t.heap[1],((l,u)=>{let h=u.dyn_tree,p=u.max_code,g=u.stat_desc.static_tree,E=u.stat_desc.has_stree,f=u.stat_desc.extra_bits,R=u.stat_desc.extra_base,y=u.stat_desc.max_length,N,k,L,P,V,B,Y=0;for(P=0;P<=Hd;P++)l.bl_count[P]=0;for(h[2*l.heap[l.heap_max]+1]=0,N=l.heap_max+1;N<573;N++)k=l.heap[N],P=h[2*h[2*k+1]+1]+1,P>y&&(P=y,Y++),h[2*k+1]=P,k>p||(l.bl_count[P]++,V=0,k>=R&&(V=f[k-R]),B=h[2*k],l.opt_len+=B*(P+V),E&&(l.static_len+=B*(g[2*k+1]+V)));if(Y!==0){do{for(P=y-1;l.bl_count[P]===0;)P--;l.bl_count[P]--,l.bl_count[P+1]+=2,l.bl_count[y]--,Y-=2}while(Y>0);for(P=y;P!==0;P--)for(k=l.bl_count[P];k!==0;)L=l.heap[--N],L>p||(h[2*L+1]!==P&&(l.opt_len+=(P-h[2*L+1])*h[2*L],h[2*L+1]=P),k--)}})(t,e),lP(i,d,t.bl_count)},mP=(t,e,i)=>{let n,r,o=-1,s=e[1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),e[2*(i+1)+1]=65535,n=0;n<=i;n++)r=s,s=e[2*(n+1)+1],++a<c&&r===s||(a<d?t.bl_tree[2*r]+=a:r!==0?(r!==o&&t.bl_tree[2*r]++,t.bl_tree[32]++):a<=10?t.bl_tree[34]++:t.bl_tree[36]++,a=0,o=r,s===0?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4))},EP=(t,e,i)=>{let n,r,o=-1,s=e[1],a=0,c=7,d=4;for(s===0&&(c=138,d=3),n=0;n<=i;n++)if(r=s,s=e[2*(n+1)+1],!(++a<c&&r===s)){if(a<d)do Lr(t,r,t.bl_tree);while(--a!=0);else r!==0?(r!==o&&(Lr(t,r,t.bl_tree),a--),Lr(t,16,t.bl_tree),an(t,a-3,2)):a<=10?(Lr(t,17,t.bl_tree),an(t,a-3,3)):(Lr(t,18,t.bl_tree),an(t,a-11,7));a=0,o=r,s===0?(c=138,d=3):r===s?(c=6,d=3):(c=7,d=4)}},fP=!1,gP=(t,e,i,n)=>{an(t,0+(n?1:0),3),hP(t),zd(t,i),zd(t,~i),i&&t.pending_buf.set(t.window.subarray(e,e+i),t.pending),t.pending+=i};var wq=t=>{fP||((()=>{let e,i,n,r,o,s=new Array(16);for(n=0,r=0;r<28;r++)for(Yg[r]=n,e=0;e<1<<qg[r];e++)Yd[n++]=r;for(Yd[n-1]=r,o=0,r=0;r<16;r++)for(mp[r]=o,e=0;e<1<<_p[r];e++)qd[o++]=r;for(o>>=7;r<Wd;r++)for(mp[r]=o<<7,e=0;e<1<<_p[r]-7;e++)qd[256+o++]=r;for(i=0;i<=Hd;i++)s[i]=0;for(e=0;e<=143;)oo[2*e+1]=8,e++,s[8]++;for(;e<=255;)oo[2*e+1]=9,e++,s[9]++;for(;e<=279;)oo[2*e+1]=7,e++,s[7]++;for(;e<=287;)oo[2*e+1]=8,e++,s[8]++;for(lP(oo,287,s),e=0;e<Wd;e++)Kd[2*e+1]=5,Kd[2*e]=dP(e,5);oP=new zg(oo,qg,257,nP,Hd),sP=new zg(Kd,_p,0,Wd,Hd),aP=new zg(new Array(0),Aq,0,19,7)})(),fP=!0),t.l_desc=new Xg(t.dyn_ltree,oP),t.d_desc=new Xg(t.dyn_dtree,sP),t.bl_desc=new Xg(t.bl_tree,aP),t.bi_buf=0,t.bi_valid=0,uP(t)},Oq=(t,e,i,n)=>{let r,o,s=0;t.level>0?(t.strm.data_type===2&&(t.strm.data_type=(a=>{let c,d=4093624447;for(c=0;c<=31;c++,d>>>=1)if(1&d&&a.dyn_ltree[2*c]!==0)return 0;if(a.dyn_ltree[18]!==0||a.dyn_ltree[20]!==0||a.dyn_ltree[26]!==0)return 1;for(c=32;c<Kg;c++)if(a.dyn_ltree[2*c]!==0)return 1;return 0})(t)),Qg(t,t.l_desc),Qg(t,t.d_desc),s=(a=>{let c;for(mP(a,a.dyn_ltree,a.l_desc.max_code),mP(a,a.dyn_dtree,a.d_desc.max_code),Qg(a,a.bl_desc),c=18;c>=3&&a.bl_tree[2*rP[c]+1]===0;c--);return a.opt_len+=3*(c+1)+5+5+4,c})(t),r=t.opt_len+3+7>>>3,o=t.static_len+3+7>>>3,o<=r&&(r=o)):r=o=i+5,i+4<=r&&e!==-1?gP(t,e,i,n):t.strategy===4||o===r?(an(t,2+(n?1:0),3),_P(t,oo,Kd)):(an(t,4+(n?1:0),3),((a,c,d,l)=>{let u;for(an(a,c-257,5),an(a,d-1,5),an(a,l-4,4),u=0;u<l;u++)an(a,a.bl_tree[2*rP[u]+1],3);EP(a,a.dyn_ltree,c-1),EP(a,a.dyn_dtree,d-1)})(t,t.l_desc.max_code+1,t.d_desc.max_code+1,s+1),_P(t,t.dyn_ltree,t.dyn_dtree)),uP(t),n&&hP(t)},Nq=(t,e,i)=>(t.pending_buf[t.sym_buf+t.sym_next++]=e,t.pending_buf[t.sym_buf+t.sym_next++]=e>>8,t.pending_buf[t.sym_buf+t.sym_next++]=i,e===0?t.dyn_ltree[2*i]++:(t.matches++,e--,t.dyn_ltree[2*(Yd[i]+Kg+1)]++,t.dyn_dtree[2*cP(e)]++),t.sym_next===t.sym_end),Dq=t=>{an(t,2,3),Lr(t,256,oo),(e=>{e.bi_valid===16?(zd(e,e.bi_buf),e.bi_buf=0,e.bi_valid=0):e.bi_valid>=8&&(e.pending_buf[e.pending++]=255&e.bi_buf,e.bi_buf>>=8,e.bi_valid-=8)})(t)},Pq={_tr_init:wq,_tr_stored_block:gP,_tr_flush_block:Oq,_tr_tally:Nq,_tr_align:Dq},Xd=(t,e,i,n)=>{let r=65535&t|0,o=t>>>16&65535|0,s=0;for(;i!==0;){s=i>2e3?2e3:i,i-=s;do r=r+e[n++]|0,o=o+r|0;while(--s);r%=65521,o%=65521}return r|o<<16|0};let Lq=new Uint32Array((()=>{let t,e=[];for(var i=0;i<256;i++){t=i;for(var n=0;n<8;n++)t=1&t?3988292384^t>>>1:t>>>1;e[i]=t}return e})());var vi=(t,e,i,n)=>{let r=Lq,o=n+i;t^=-1;for(let s=n;s<o;s++)t=t>>>8^r[255&(t^e[s])];return-1^t},Ms={2:"need dictionary",1:"stream end",0:"","-1":"file error","-2":"stream error","-3":"data error","-4":"insufficient memory","-5":"buffer error","-6":"incompatible version"},hc={Z_NO_FLUSH:0,Z_PARTIAL_FLUSH:1,Z_SYNC_FLUSH:2,Z_FULL_FLUSH:3,Z_FINISH:4,Z_BLOCK:5,Z_TREES:6,Z_OK:0,Z_STREAM_END:1,Z_NEED_DICT:2,Z_ERRNO:-1,Z_STREAM_ERROR:-2,Z_DATA_ERROR:-3,Z_MEM_ERROR:-4,Z_BUF_ERROR:-5,Z_NO_COMPRESSION:0,Z_BEST_SPEED:1,Z_BEST_COMPRESSION:9,Z_DEFAULT_COMPRESSION:-1,Z_FILTERED:1,Z_HUFFMAN_ONLY:2,Z_RLE:3,Z_FIXED:4,Z_DEFAULT_STRATEGY:0,Z_BINARY:0,Z_TEXT:1,Z_UNKNOWN:2,Z_DEFLATED:8};let{_tr_init:kq,_tr_stored_block:Zg,_tr_flush_block:Mq,_tr_tally:zo,_tr_align:Uq}=Pq,{Z_NO_FLUSH:Xo,Z_PARTIAL_FLUSH:xq,Z_FULL_FLUSH:Vq,Z_FINISH:Wn,Z_BLOCK:SP,Z_OK:Oi,Z_STREAM_END:TP,Z_STREAM_ERROR:kr,Z_DATA_ERROR:Fq,Z_BUF_ERROR:$g,Z_DEFAULT_COMPRESSION:Bq,Z_FILTERED:jq,Z_HUFFMAN_ONLY:Ep,Z_RLE:Gq,Z_FIXED:Wq,Z_DEFAULT_STRATEGY:Hq,Z_UNKNOWN:Kq,Z_DEFLATED:fp}=hc,tS=286,qq=30,Yq=19,zq=2*tS+1,Xq=15,Us=258,Mr=262,pc=42,xs=113,Jd=666,Vs=(t,e)=>(t.msg=Ms[e],e),RP=t=>2*t-(t>4?9:0),Jo=t=>{let e=t.length;for(;--e>=0;)t[e]=0},Jq=t=>{let e,i,n,r=t.w_size;e=t.hash_size,n=e;do i=t.head[--n],t.head[n]=i>=r?i-r:0;while(--e);e=r,n=e;do i=t.prev[--n],t.prev[n]=i>=r?i-r:0;while(--e)},Qo=(t,e,i)=>(e<<t.hash_shift^i)&t.hash_mask,En=t=>{let e=t.state,i=e.pending;i>t.avail_out&&(i=t.avail_out),i!==0&&(t.output.set(e.pending_buf.subarray(e.pending_out,e.pending_out+i),t.next_out),t.next_out+=i,e.pending_out+=i,t.total_out+=i,t.avail_out-=i,e.pending-=i,e.pending===0&&(e.pending_out=0))},fn=(t,e)=>{Mq(t,t.block_start>=0?t.block_start:-1,t.strstart-t.block_start,e),t.block_start=t.strstart,En(t.strm)},ve=(t,e)=>{t.pending_buf[t.pending++]=e},Qd=(t,e)=>{t.pending_buf[t.pending++]=e>>>8&255,t.pending_buf[t.pending++]=255&e},eS=(t,e,i,n)=>{let r=t.avail_in;return r>n&&(r=n),r===0?0:(t.avail_in-=r,e.set(t.input.subarray(t.next_in,t.next_in+r),i),t.state.wrap===1?t.adler=Xd(t.adler,e,r,i):t.state.wrap===2&&(t.adler=vi(t.adler,e,r,i)),t.next_in+=r,t.total_in+=r,r)},vP=(t,e)=>{let i,n,r=t.max_chain_length,o=t.strstart,s=t.prev_length,a=t.nice_match,c=t.strstart>t.w_size-Mr?t.strstart-(t.w_size-Mr):0,d=t.window,l=t.w_mask,u=t.prev,h=t.strstart+Us,p=d[o+s-1],g=d[o+s];t.prev_length>=t.good_match&&(r>>=2),a>t.lookahead&&(a=t.lookahead);do if(i=e,d[i+s]===g&&d[i+s-1]===p&&d[i]===d[o]&&d[++i]===d[o+1]){o+=2,i++;do;while(d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&d[++o]===d[++i]&&o<h);if(n=Us-(h-o),o=h-Us,n>s){if(t.match_start=e,s=n,n>=a)break;p=d[o+s-1],g=d[o+s]}}while((e=u[e&l])>c&&--r!=0);return s<=t.lookahead?s:t.lookahead},_c=t=>{let e=t.w_size,i,n,r;do{if(n=t.window_size-t.lookahead-t.strstart,t.strstart>=e+(e-Mr)&&(t.window.set(t.window.subarray(e,e+e-n),0),t.match_start-=e,t.strstart-=e,t.block_start-=e,t.insert>t.strstart&&(t.insert=t.strstart),Jq(t),n+=e),t.strm.avail_in===0)break;if(i=eS(t.strm,t.window,t.strstart+t.lookahead,n),t.lookahead+=i,t.lookahead+t.insert>=3)for(r=t.strstart-t.insert,t.ins_h=t.window[r],t.ins_h=Qo(t,t.ins_h,t.window[r+1]);t.insert&&(t.ins_h=Qo(t,t.ins_h,t.window[r+3-1]),t.prev[r&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=r,r++,t.insert--,!(t.lookahead+t.insert<3)););}while(t.lookahead<Mr&&t.strm.avail_in!==0)},yP=(t,e)=>{let i,n,r,o=t.pending_buf_size-5>t.w_size?t.w_size:t.pending_buf_size-5,s=0,a=t.strm.avail_in;do{if(i=65535,r=t.bi_valid+42>>3,t.strm.avail_out<r||(r=t.strm.avail_out-r,n=t.strstart-t.block_start,i>n+t.strm.avail_in&&(i=n+t.strm.avail_in),i>r&&(i=r),i<o&&(i===0&&e!==Wn||e===Xo||i!==n+t.strm.avail_in)))break;s=e===Wn&&i===n+t.strm.avail_in?1:0,Zg(t,0,0,s),t.pending_buf[t.pending-4]=i,t.pending_buf[t.pending-3]=i>>8,t.pending_buf[t.pending-2]=~i,t.pending_buf[t.pending-1]=~i>>8,En(t.strm),n&&(n>i&&(n=i),t.strm.output.set(t.window.subarray(t.block_start,t.block_start+n),t.strm.next_out),t.strm.next_out+=n,t.strm.avail_out-=n,t.strm.total_out+=n,t.block_start+=n,i-=n),i&&(eS(t.strm,t.strm.output,t.strm.next_out,i),t.strm.next_out+=i,t.strm.avail_out-=i,t.strm.total_out+=i)}while(s===0);return a-=t.strm.avail_in,a&&(a>=t.w_size?(t.matches=2,t.window.set(t.strm.input.subarray(t.strm.next_in-t.w_size,t.strm.next_in),0),t.strstart=t.w_size,t.insert=t.strstart):(t.window_size-t.strstart<=a&&(t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,t.insert>t.strstart&&(t.insert=t.strstart)),t.window.set(t.strm.input.subarray(t.strm.next_in-a,t.strm.next_in),t.strstart),t.strstart+=a,t.insert+=a>t.w_size-t.insert?t.w_size-t.insert:a),t.block_start=t.strstart),t.high_water<t.strstart&&(t.high_water=t.strstart),s?4:e!==Xo&&e!==Wn&&t.strm.avail_in===0&&t.strstart===t.block_start?2:(r=t.window_size-t.strstart,t.strm.avail_in>r&&t.block_start>=t.w_size&&(t.block_start-=t.w_size,t.strstart-=t.w_size,t.window.set(t.window.subarray(t.w_size,t.w_size+t.strstart),0),t.matches<2&&t.matches++,r+=t.w_size,t.insert>t.strstart&&(t.insert=t.strstart)),r>t.strm.avail_in&&(r=t.strm.avail_in),r&&(eS(t.strm,t.window,t.strstart,r),t.strstart+=r,t.insert+=r>t.w_size-t.insert?t.w_size-t.insert:r),t.high_water<t.strstart&&(t.high_water=t.strstart),r=t.bi_valid+42>>3,r=t.pending_buf_size-r>65535?65535:t.pending_buf_size-r,o=r>t.w_size?t.w_size:r,n=t.strstart-t.block_start,(n>=o||(n||e===Wn)&&e!==Xo&&t.strm.avail_in===0&&n<=r)&&(i=n>r?r:n,s=e===Wn&&t.strm.avail_in===0&&i===n?1:0,Zg(t,t.block_start,i,s),t.block_start+=i,En(t.strm)),s?3:1)},iS=(t,e)=>{let i,n;for(;;){if(t.lookahead<Mr){if(_c(t),t.lookahead<Mr&&e===Xo)return 1;if(t.lookahead===0)break}if(i=0,t.lookahead>=3&&(t.ins_h=Qo(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),i!==0&&t.strstart-i<=t.w_size-Mr&&(t.match_length=vP(t,i)),t.match_length>=3)if(n=zo(t,t.strstart-t.match_start,t.match_length-3),t.lookahead-=t.match_length,t.match_length<=t.max_lazy_match&&t.lookahead>=3){t.match_length--;do t.strstart++,t.ins_h=Qo(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart;while(--t.match_length!=0);t.strstart++}else t.strstart+=t.match_length,t.match_length=0,t.ins_h=t.window[t.strstart],t.ins_h=Qo(t,t.ins_h,t.window[t.strstart+1]);else n=zo(t,0,t.window[t.strstart]),t.lookahead--,t.strstart++;if(n&&(fn(t,!1),t.strm.avail_out===0))return 1}return t.insert=t.strstart<2?t.strstart:2,e===Wn?(fn(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(fn(t,!1),t.strm.avail_out===0)?1:2},mc=(t,e)=>{let i,n,r;for(;;){if(t.lookahead<Mr){if(_c(t),t.lookahead<Mr&&e===Xo)return 1;if(t.lookahead===0)break}if(i=0,t.lookahead>=3&&(t.ins_h=Qo(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart),t.prev_length=t.match_length,t.prev_match=t.match_start,t.match_length=2,i!==0&&t.prev_length<t.max_lazy_match&&t.strstart-i<=t.w_size-Mr&&(t.match_length=vP(t,i),t.match_length<=5&&(t.strategy===jq||t.match_length===3&&t.strstart-t.match_start>4096)&&(t.match_length=2)),t.prev_length>=3&&t.match_length<=t.prev_length){r=t.strstart+t.lookahead-3,n=zo(t,t.strstart-1-t.prev_match,t.prev_length-3),t.lookahead-=t.prev_length-1,t.prev_length-=2;do++t.strstart<=r&&(t.ins_h=Qo(t,t.ins_h,t.window[t.strstart+3-1]),i=t.prev[t.strstart&t.w_mask]=t.head[t.ins_h],t.head[t.ins_h]=t.strstart);while(--t.prev_length!=0);if(t.match_available=0,t.match_length=2,t.strstart++,n&&(fn(t,!1),t.strm.avail_out===0))return 1}else if(t.match_available){if(n=zo(t,0,t.window[t.strstart-1]),n&&fn(t,!1),t.strstart++,t.lookahead--,t.strm.avail_out===0)return 1}else t.match_available=1,t.strstart++,t.lookahead--}return t.match_available&&(n=zo(t,0,t.window[t.strstart-1]),t.match_available=0),t.insert=t.strstart<2?t.strstart:2,e===Wn?(fn(t,!0),t.strm.avail_out===0?3:4):t.sym_next&&(fn(t,!1),t.strm.avail_out===0)?1:2};function Ur(t,e,i,n,r){this.good_length=t,this.max_lazy=e,this.nice_length=i,this.max_chain=n,this.func=r}let Zd=[new Ur(0,0,0,0,yP),new Ur(4,4,8,4,iS),new Ur(4,5,16,8,iS),new Ur(4,6,32,32,iS),new Ur(4,4,16,16,mc),new Ur(8,16,32,32,mc),new Ur(8,16,128,128,mc),new Ur(8,32,128,256,mc),new Ur(32,128,258,1024,mc),new Ur(32,258,258,4096,mc)];function Qq(){this.strm=null,this.status=0,this.pending_buf=null,this.pending_buf_size=0,this.pending_out=0,this.pending=0,this.wrap=0,this.gzhead=null,this.gzindex=0,this.method=fp,this.last_flush=-1,this.w_size=0,this.w_bits=0,this.w_mask=0,this.window=null,this.window_size=0,this.prev=null,this.head=null,this.ins_h=0,this.hash_size=0,this.hash_bits=0,this.hash_mask=0,this.hash_shift=0,this.block_start=0,this.match_length=0,this.prev_match=0,this.match_available=0,this.strstart=0,this.match_start=0,this.lookahead=0,this.prev_length=0,this.max_chain_length=0,this.max_lazy_match=0,this.level=0,this.strategy=0,this.good_match=0,this.nice_match=0,this.dyn_ltree=new Uint16Array(2*zq),this.dyn_dtree=new Uint16Array(2*(2*qq+1)),this.bl_tree=new Uint16Array(2*(2*Yq+1)),Jo(this.dyn_ltree),Jo(this.dyn_dtree),Jo(this.bl_tree),this.l_desc=null,this.d_desc=null,this.bl_desc=null,this.bl_count=new Uint16Array(Xq+1),this.heap=new Uint16Array(2*tS+1),Jo(this.heap),this.heap_len=0,this.heap_max=0,this.depth=new Uint16Array(2*tS+1),Jo(this.depth),this.sym_buf=0,this.lit_bufsize=0,this.sym_next=0,this.sym_end=0,this.opt_len=0,this.static_len=0,this.matches=0,this.insert=0,this.bi_buf=0,this.bi_valid=0}let $d=t=>{if(!t)return 1;let e=t.state;return!e||e.strm!==t||e.status!==pc&&e.status!==57&&e.status!==69&&e.status!==73&&e.status!==91&&e.status!==103&&e.status!==xs&&e.status!==Jd?1:0},CP=t=>{if($d(t))return Vs(t,kr);t.total_in=t.total_out=0,t.data_type=Kq;let e=t.state;return e.pending=0,e.pending_out=0,e.wrap<0&&(e.wrap=-e.wrap),e.status=e.wrap===2?57:e.wrap?pc:xs,t.adler=e.wrap===2?0:1,e.last_flush=-2,kq(e),Oi},bP=t=>{let e=CP(t);return e===Oi&&(i=>{i.window_size=2*i.w_size,Jo(i.head),i.max_lazy_match=Zd[i.level].max_lazy,i.good_match=Zd[i.level].good_length,i.nice_match=Zd[i.level].nice_length,i.max_chain_length=Zd[i.level].max_chain,i.strstart=0,i.block_start=0,i.lookahead=0,i.insert=0,i.match_length=i.prev_length=2,i.match_available=0,i.ins_h=0})(t.state),e},IP=(t,e,i,n,r,o)=>{if(!t)return kr;let s=1;if(e===Bq&&(e=6),n<0?(s=0,n=-n):n>15&&(s=2,n-=16),r<1||r>9||i!==fp||n<8||n>15||e<0||e>9||o<0||o>Wq||n===8&&s!==1)return Vs(t,kr);n===8&&(n=9);let a=new Qq;return t.state=a,a.strm=t,a.status=pc,a.wrap=s,a.gzhead=null,a.w_bits=n,a.w_size=1<<a.w_bits,a.w_mask=a.w_size-1,a.hash_bits=r+7,a.hash_size=1<<a.hash_bits,a.hash_mask=a.hash_size-1,a.hash_shift=~~((a.hash_bits+3-1)/3),a.window=new Uint8Array(2*a.w_size),a.head=new Uint16Array(a.hash_size),a.prev=new Uint16Array(a.w_size),a.lit_bufsize=1<<r+6,a.pending_buf_size=4*a.lit_bufsize,a.pending_buf=new Uint8Array(a.pending_buf_size),a.sym_buf=a.lit_bufsize,a.sym_end=3*(a.lit_bufsize-1),a.level=e,a.strategy=o,a.method=i,bP(t)};var Zq=(t,e)=>{if($d(t)||e>SP||e<0)return t?Vs(t,kr):kr;let i=t.state;if(!t.output||t.avail_in!==0&&!t.input||i.status===Jd&&e!==Wn)return Vs(t,t.avail_out===0?$g:kr);let n=i.last_flush;if(i.last_flush=e,i.pending!==0){if(En(t),t.avail_out===0)return i.last_flush=-1,Oi}else if(t.avail_in===0&&RP(e)<=RP(n)&&e!==Wn)return Vs(t,$g);if(i.status===Jd&&t.avail_in!==0)return Vs(t,$g);if(i.status===pc&&i.wrap===0&&(i.status=xs),i.status===pc){let r=fp+(i.w_bits-8<<4)<<8,o=-1;if(o=i.strategy>=Ep||i.level<2?0:i.level<6?1:i.level===6?2:3,r|=o<<6,i.strstart!==0&&(r|=32),r+=31-r%31,Qd(i,r),i.strstart!==0&&(Qd(i,t.adler>>>16),Qd(i,65535&t.adler)),t.adler=1,i.status=xs,En(t),i.pending!==0)return i.last_flush=-1,Oi}if(i.status===57){if(t.adler=0,ve(i,31),ve(i,139),ve(i,8),i.gzhead)ve(i,(i.gzhead.text?1:0)+(i.gzhead.hcrc?2:0)+(i.gzhead.extra?4:0)+(i.gzhead.name?8:0)+(i.gzhead.comment?16:0)),ve(i,255&i.gzhead.time),ve(i,i.gzhead.time>>8&255),ve(i,i.gzhead.time>>16&255),ve(i,i.gzhead.time>>24&255),ve(i,i.level===9?2:i.strategy>=Ep||i.level<2?4:0),ve(i,255&i.gzhead.os),i.gzhead.extra&&i.gzhead.extra.length&&(ve(i,255&i.gzhead.extra.length),ve(i,i.gzhead.extra.length>>8&255)),i.gzhead.hcrc&&(t.adler=vi(t.adler,i.pending_buf,i.pending,0)),i.gzindex=0,i.status=69;else if(ve(i,0),ve(i,0),ve(i,0),ve(i,0),ve(i,0),ve(i,i.level===9?2:i.strategy>=Ep||i.level<2?4:0),ve(i,3),i.status=xs,En(t),i.pending!==0)return i.last_flush=-1,Oi}if(i.status===69){if(i.gzhead.extra){let r=i.pending,o=(65535&i.gzhead.extra.length)-i.gzindex;for(;i.pending+o>i.pending_buf_size;){let a=i.pending_buf_size-i.pending;if(i.pending_buf.set(i.gzhead.extra.subarray(i.gzindex,i.gzindex+a),i.pending),i.pending=i.pending_buf_size,i.gzhead.hcrc&&i.pending>r&&(t.adler=vi(t.adler,i.pending_buf,i.pending-r,r)),i.gzindex+=a,En(t),i.pending!==0)return i.last_flush=-1,Oi;r=0,o-=a}let s=new Uint8Array(i.gzhead.extra);i.pending_buf.set(s.subarray(i.gzindex,i.gzindex+o),i.pending),i.pending+=o,i.gzhead.hcrc&&i.pending>r&&(t.adler=vi(t.adler,i.pending_buf,i.pending-r,r)),i.gzindex=0}i.status=73}if(i.status===73){if(i.gzhead.name){let r,o=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>o&&(t.adler=vi(t.adler,i.pending_buf,i.pending-o,o)),En(t),i.pending!==0)return i.last_flush=-1,Oi;o=0}r=i.gzindex<i.gzhead.name.length?255&i.gzhead.name.charCodeAt(i.gzindex++):0,ve(i,r)}while(r!==0);i.gzhead.hcrc&&i.pending>o&&(t.adler=vi(t.adler,i.pending_buf,i.pending-o,o)),i.gzindex=0}i.status=91}if(i.status===91){if(i.gzhead.comment){let r,o=i.pending;do{if(i.pending===i.pending_buf_size){if(i.gzhead.hcrc&&i.pending>o&&(t.adler=vi(t.adler,i.pending_buf,i.pending-o,o)),En(t),i.pending!==0)return i.last_flush=-1,Oi;o=0}r=i.gzindex<i.gzhead.comment.length?255&i.gzhead.comment.charCodeAt(i.gzindex++):0,ve(i,r)}while(r!==0);i.gzhead.hcrc&&i.pending>o&&(t.adler=vi(t.adler,i.pending_buf,i.pending-o,o))}i.status=103}if(i.status===103){if(i.gzhead.hcrc){if(i.pending+2>i.pending_buf_size&&(En(t),i.pending!==0))return i.last_flush=-1,Oi;ve(i,255&t.adler),ve(i,t.adler>>8&255),t.adler=0}if(i.status=xs,En(t),i.pending!==0)return i.last_flush=-1,Oi}if(t.avail_in!==0||i.lookahead!==0||e!==Xo&&i.status!==Jd){let r=i.level===0?yP(i,e):i.strategy===Ep?((o,s)=>{let a;for(;;){if(o.lookahead===0&&(_c(o),o.lookahead===0)){if(s===Xo)return 1;break}if(o.match_length=0,a=zo(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++,a&&(fn(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===Wn?(fn(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(fn(o,!1),o.strm.avail_out===0)?1:2})(i,e):i.strategy===Gq?((o,s)=>{let a,c,d,l,u=o.window;for(;;){if(o.lookahead<=Us){if(_c(o),o.lookahead<=Us&&s===Xo)return 1;if(o.lookahead===0)break}if(o.match_length=0,o.lookahead>=3&&o.strstart>0&&(d=o.strstart-1,c=u[d],c===u[++d]&&c===u[++d]&&c===u[++d])){l=o.strstart+Us;do;while(c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&c===u[++d]&&d<l);o.match_length=Us-(l-d),o.match_length>o.lookahead&&(o.match_length=o.lookahead)}if(o.match_length>=3?(a=zo(o,1,o.match_length-3),o.lookahead-=o.match_length,o.strstart+=o.match_length,o.match_length=0):(a=zo(o,0,o.window[o.strstart]),o.lookahead--,o.strstart++),a&&(fn(o,!1),o.strm.avail_out===0))return 1}return o.insert=0,s===Wn?(fn(o,!0),o.strm.avail_out===0?3:4):o.sym_next&&(fn(o,!1),o.strm.avail_out===0)?1:2})(i,e):Zd[i.level].func(i,e);if(r!==3&&r!==4||(i.status=Jd),r===1||r===3)return t.avail_out===0&&(i.last_flush=-1),Oi;if(r===2&&(e===xq?Uq(i):e!==SP&&(Zg(i,0,0,!1),e===Vq&&(Jo(i.head),i.lookahead===0&&(i.strstart=0,i.block_start=0,i.insert=0))),En(t),t.avail_out===0))return i.last_flush=-1,Oi}return e!==Wn?Oi:i.wrap<=0?TP:(i.wrap===2?(ve(i,255&t.adler),ve(i,t.adler>>8&255),ve(i,t.adler>>16&255),ve(i,t.adler>>24&255),ve(i,255&t.total_in),ve(i,t.total_in>>8&255),ve(i,t.total_in>>16&255),ve(i,t.total_in>>24&255)):(Qd(i,t.adler>>>16),Qd(i,65535&t.adler)),En(t),i.wrap>0&&(i.wrap=-i.wrap),i.pending!==0?Oi:TP)},$q=(t,e)=>{let i=e.length;if($d(t))return kr;let n=t.state,r=n.wrap;if(r===2||r===1&&n.status!==pc||n.lookahead)return kr;if(r===1&&(t.adler=Xd(t.adler,e,i,0)),n.wrap=0,i>=n.w_size){r===0&&(Jo(n.head),n.strstart=0,n.block_start=0,n.insert=0);let c=new Uint8Array(n.w_size);c.set(e.subarray(i-n.w_size,i),0),e=c,i=n.w_size}let o=t.avail_in,s=t.next_in,a=t.input;for(t.avail_in=i,t.next_in=0,t.input=e,_c(n);n.lookahead>=3;){let c=n.strstart,d=n.lookahead-2;do n.ins_h=Qo(n,n.ins_h,n.window[c+3-1]),n.prev[c&n.w_mask]=n.head[n.ins_h],n.head[n.ins_h]=c,c++;while(--d);n.strstart=c,n.lookahead=2,_c(n)}return n.strstart+=n.lookahead,n.block_start=n.strstart,n.insert=n.lookahead,n.lookahead=0,n.match_length=n.prev_length=2,n.match_available=0,t.next_in=s,t.input=a,t.avail_in=o,n.wrap=r,Oi},tl={deflateInit:(t,e)=>IP(t,e,fp,15,8,Hq),deflateInit2:IP,deflateReset:bP,deflateResetKeep:CP,deflateSetHeader:(t,e)=>$d(t)||t.state.wrap!==2?kr:(t.state.gzhead=e,Oi),deflate:Zq,deflateEnd:t=>{if($d(t))return kr;let e=t.state.status;return t.state=null,e===xs?Vs(t,Fq):Oi},deflateSetDictionary:$q,deflateInfo:"pako deflate (from Nodeca project)"};let t8=(t,e)=>Object.prototype.hasOwnProperty.call(t,e);var gp={assign:function(t){let e=Array.prototype.slice.call(arguments,1);for(;e.length;){let i=e.shift();if(i){if(typeof i!="object")throw new TypeError(i+"must be non-object");for(let n in i)t8(i,n)&&(t[n]=i[n])}}return t},flattenChunks:t=>{let e=0;for(let n=0,r=t.length;n<r;n++)e+=t[n].length;let i=new Uint8Array(e);for(let n=0,r=0,o=t.length;n<o;n++){let s=t[n];i.set(s,r),r+=s.length}return i}};let AP=!0;try{String.fromCharCode.apply(null,new Uint8Array(1))}catch{AP=!1}let el=new Uint8Array(256);for(let t=0;t<256;t++)el[t]=t>=252?6:t>=248?5:t>=240?4:t>=224?3:t>=192?2:1;el[254]=el[254]=1;var il={string2buf:t=>{if(typeof TextEncoder=="function"&&TextEncoder.prototype.encode)return new TextEncoder().encode(t);let e,i,n,r,o,s=t.length,a=0;for(r=0;r<s;r++)i=t.charCodeAt(r),(64512&i)==55296&&r+1<s&&(n=t.charCodeAt(r+1),(64512&n)==56320&&(i=65536+(i-55296<<10)+(n-56320),r++)),a+=i<128?1:i<2048?2:i<65536?3:4;for(e=new Uint8Array(a),o=0,r=0;o<a;r++)i=t.charCodeAt(r),(64512&i)==55296&&r+1<s&&(n=t.charCodeAt(r+1),(64512&n)==56320&&(i=65536+(i-55296<<10)+(n-56320),r++)),i<128?e[o++]=i:i<2048?(e[o++]=192|i>>>6,e[o++]=128|63&i):i<65536?(e[o++]=224|i>>>12,e[o++]=128|i>>>6&63,e[o++]=128|63&i):(e[o++]=240|i>>>18,e[o++]=128|i>>>12&63,e[o++]=128|i>>>6&63,e[o++]=128|63&i);return e},buf2string:(t,e)=>{let i=e||t.length;if(typeof TextDecoder=="function"&&TextDecoder.prototype.decode)return new TextDecoder().decode(t.subarray(0,e));let n,r,o=new Array(2*i);for(r=0,n=0;n<i;){let s=t[n++];if(s<128){o[r++]=s;continue}let a=el[s];if(a>4)o[r++]=65533,n+=a-1;else{for(s&=a===2?31:a===3?15:7;a>1&&n<i;)s=s<<6|63&t[n++],a--;a>1?o[r++]=65533:s<65536?o[r++]=s:(s-=65536,o[r++]=55296|s>>10&1023,o[r++]=56320|1023&s)}}return((s,a)=>{if(a<65534&&s.subarray&&AP)return String.fromCharCode.apply(null,s.length===a?s:s.subarray(0,a));let c="";for(let d=0;d<a;d++)c+=String.fromCharCode(s[d]);return c})(o,r)},utf8border:(t,e)=>{(e=e||t.length)>t.length&&(e=t.length);let i=e-1;for(;i>=0&&(192&t[i])==128;)i--;return i<0||i===0?e:i+el[t[i]]>e?i:e}},wP=function(){this.input=null,this.next_in=0,this.avail_in=0,this.total_in=0,this.output=null,this.next_out=0,this.avail_out=0,this.total_out=0,this.msg="",this.state=null,this.data_type=2,this.adler=0};let OP=Object.prototype.toString,{Z_NO_FLUSH:e8,Z_SYNC_FLUSH:i8,Z_FULL_FLUSH:n8,Z_FINISH:r8,Z_OK:Sp,Z_STREAM_END:o8,Z_DEFAULT_COMPRESSION:s8,Z_DEFAULT_STRATEGY:a8,Z_DEFLATED:c8}=hc;function nl(t){this.options=gp.assign({level:s8,method:c8,chunkSize:16384,windowBits:15,memLevel:8,strategy:a8},t||{});let e=this.options;e.raw&&e.windowBits>0?e.windowBits=-e.windowBits:e.gzip&&e.windowBits>0&&e.windowBits<16&&(e.windowBits+=16),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new wP,this.strm.avail_out=0;let i=tl.deflateInit2(this.strm,e.level,e.method,e.windowBits,e.memLevel,e.strategy);if(i!==Sp)throw new Error(Ms[i]);if(e.header&&tl.deflateSetHeader(this.strm,e.header),e.dictionary){let n;if(n=typeof e.dictionary=="string"?il.string2buf(e.dictionary):OP.call(e.dictionary)==="[object ArrayBuffer]"?new Uint8Array(e.dictionary):e.dictionary,i=tl.deflateSetDictionary(this.strm,n),i!==Sp)throw new Error(Ms[i]);this._dict_set=!0}}function nS(t,e){let i=new nl(e);if(i.push(t,!0),i.err)throw i.msg||Ms[i.err];return i.result}nl.prototype.push=function(t,e){let i=this.strm,n=this.options.chunkSize,r,o;if(this.ended)return!1;for(o=e===~~e?e:e===!0?r8:e8,typeof t=="string"?i.input=il.string2buf(t):OP.call(t)==="[object ArrayBuffer]"?i.input=new Uint8Array(t):i.input=t,i.next_in=0,i.avail_in=i.input.length;;)if(i.avail_out===0&&(i.output=new Uint8Array(n),i.next_out=0,i.avail_out=n),(o===i8||o===n8)&&i.avail_out<=6)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else{if(r=tl.deflate(i,o),r===o8)return i.next_out>0&&this.onData(i.output.subarray(0,i.next_out)),r=tl.deflateEnd(this.strm),this.onEnd(r),this.ended=!0,r===Sp;if(i.avail_out!==0){if(o>0&&i.next_out>0)this.onData(i.output.subarray(0,i.next_out)),i.avail_out=0;else if(i.avail_in===0)break}else this.onData(i.output)}return!0},nl.prototype.onData=function(t){this.chunks.push(t)},nl.prototype.onEnd=function(t){t===Sp&&(this.result=gp.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var d8={Deflate:nl,deflate:nS,deflateRaw:function(t,e){return(e=e||{}).raw=!0,nS(t,e)},gzip:function(t,e){return(e=e||{}).gzip=!0,nS(t,e)},constants:hc};let Tp=16209;var l8=function(t,e){let i,n,r,o,s,a,c,d,l,u,h,p,g,E,f,R,y,N,k,L,P,V,B,Y,J=t.state;i=t.next_in,B=t.input,n=i+(t.avail_in-5),r=t.next_out,Y=t.output,o=r-(e-t.avail_out),s=r+(t.avail_out-257),a=J.dmax,c=J.wsize,d=J.whave,l=J.wnext,u=J.window,h=J.hold,p=J.bits,g=J.lencode,E=J.distcode,f=(1<<J.lenbits)-1,R=(1<<J.distbits)-1;t:do{p<15&&(h+=B[i++]<<p,p+=8,h+=B[i++]<<p,p+=8),y=g[h&f];e:for(;;){if(N=y>>>24,h>>>=N,p-=N,N=y>>>16&255,N===0)Y[r++]=65535&y;else{if(!(16&N)){if((64&N)==0){y=g[(65535&y)+(h&(1<<N)-1)];continue e}if(32&N){J.mode=16191;break t}t.msg="invalid literal/length code",J.mode=Tp;break t}k=65535&y,N&=15,N&&(p<N&&(h+=B[i++]<<p,p+=8),k+=h&(1<<N)-1,h>>>=N,p-=N),p<15&&(h+=B[i++]<<p,p+=8,h+=B[i++]<<p,p+=8),y=E[h&R];i:for(;;){if(N=y>>>24,h>>>=N,p-=N,N=y>>>16&255,!(16&N)){if((64&N)==0){y=E[(65535&y)+(h&(1<<N)-1)];continue i}t.msg="invalid distance code",J.mode=Tp;break t}if(L=65535&y,N&=15,p<N&&(h+=B[i++]<<p,p+=8,p<N&&(h+=B[i++]<<p,p+=8)),L+=h&(1<<N)-1,L>a){t.msg="invalid distance too far back",J.mode=Tp;break t}if(h>>>=N,p-=N,N=r-o,L>N){if(N=L-N,N>d&&J.sane){t.msg="invalid distance too far back",J.mode=Tp;break t}if(P=0,V=u,l===0){if(P+=c-N,N<k){k-=N;do Y[r++]=u[P++];while(--N);P=r-L,V=Y}}else if(l<N){if(P+=c+l-N,N-=l,N<k){k-=N;do Y[r++]=u[P++];while(--N);if(P=0,l<k){N=l,k-=N;do Y[r++]=u[P++];while(--N);P=r-L,V=Y}}}else if(P+=l-N,N<k){k-=N;do Y[r++]=u[P++];while(--N);P=r-L,V=Y}for(;k>2;)Y[r++]=V[P++],Y[r++]=V[P++],Y[r++]=V[P++],k-=3;k&&(Y[r++]=V[P++],k>1&&(Y[r++]=V[P++]))}else{P=r-L;do Y[r++]=Y[P++],Y[r++]=Y[P++],Y[r++]=Y[P++],k-=3;while(k>2);k&&(Y[r++]=Y[P++],k>1&&(Y[r++]=Y[P++]))}break}}break}}while(i<n&&r<s);k=p>>3,i-=k,p-=k<<3,h&=(1<<p)-1,t.next_in=i,t.next_out=r,t.avail_in=i<n?n-i+5:5-(i-n),t.avail_out=r<s?s-r+257:257-(r-s),J.hold=h,J.bits=p};let Rp=15,u8=new Uint16Array([3,4,5,6,7,8,9,10,11,13,15,17,19,23,27,31,35,43,51,59,67,83,99,115,131,163,195,227,258,0,0]),h8=new Uint8Array([16,16,16,16,16,16,16,16,17,17,17,17,18,18,18,18,19,19,19,19,20,20,20,20,21,21,21,21,16,72,78]),p8=new Uint16Array([1,2,3,4,5,7,9,13,17,25,33,49,65,97,129,193,257,385,513,769,1025,1537,2049,3073,4097,6145,8193,12289,16385,24577,0,0]),_8=new Uint8Array([16,16,16,16,17,17,18,18,19,19,20,20,21,21,22,22,23,23,24,24,25,25,26,26,27,27,28,28,29,29,64,64]);var rl=(t,e,i,n,r,o,s,a)=>{let c=a.bits,d,l,u,h,p,g,E=0,f=0,R=0,y=0,N=0,k=0,L=0,P=0,V=0,B=0,Y=null,J=new Uint16Array(16),yt=new Uint16Array(16),Rt,_t,ne,Qt=null;for(E=0;E<=Rp;E++)J[E]=0;for(f=0;f<n;f++)J[e[i+f]]++;for(N=c,y=Rp;y>=1&&J[y]===0;y--);if(N>y&&(N=y),y===0)return r[o++]=20971520,r[o++]=20971520,a.bits=1,0;for(R=1;R<y&&J[R]===0;R++);for(N<R&&(N=R),P=1,E=1;E<=Rp;E++)if(P<<=1,P-=J[E],P<0)return-1;if(P>0&&(t===0||y!==1))return-1;for(yt[1]=0,E=1;E<Rp;E++)yt[E+1]=yt[E]+J[E];for(f=0;f<n;f++)e[i+f]!==0&&(s[yt[e[i+f]]++]=f);if(t===0?(Y=Qt=s,g=20):t===1?(Y=u8,Qt=h8,g=257):(Y=p8,Qt=_8,g=0),B=0,f=0,E=R,p=o,k=N,L=0,u=-1,V=1<<N,h=V-1,t===1&&V>852||t===2&&V>592)return 1;for(;;){Rt=E-L,s[f]+1<g?(_t=0,ne=s[f]):s[f]>=g?(_t=Qt[s[f]-g],ne=Y[s[f]-g]):(_t=96,ne=0),d=1<<E-L,l=1<<k,R=l;do l-=d,r[p+(B>>L)+l]=Rt<<24|_t<<16|ne|0;while(l!==0);for(d=1<<E-1;B&d;)d>>=1;if(d!==0?(B&=d-1,B+=d):B=0,f++,--J[E]==0){if(E===y)break;E=e[i+s[f]]}if(E>N&&(B&h)!==u){for(L===0&&(L=N),p+=R,k=E-L,P=1<<k;k+L<y&&(P-=J[k+L],!(P<=0));)k++,P<<=1;if(V+=1<<k,t===1&&V>852||t===2&&V>592)return 1;u=B&h,r[u]=N<<24|k<<16|p-o|0}}return B!==0&&(r[p+B]=E-L<<24|64<<16|0),a.bits=N,0};let{Z_FINISH:NP,Z_BLOCK:m8,Z_TREES:vp,Z_OK:Fs,Z_STREAM_END:E8,Z_NEED_DICT:f8,Z_STREAM_ERROR:Hn,Z_DATA_ERROR:DP,Z_MEM_ERROR:PP,Z_BUF_ERROR:g8,Z_DEFLATED:LP}=hc,yp=16180,Cp=16190,so=16191,rS=16192,oS=16194,bp=16199,Ip=16200,sS=16206,We=16209,kP=t=>(t>>>24&255)+(t>>>8&65280)+((65280&t)<<8)+((255&t)<<24);function S8(){this.strm=null,this.mode=0,this.last=!1,this.wrap=0,this.havedict=!1,this.flags=0,this.dmax=0,this.check=0,this.total=0,this.head=null,this.wbits=0,this.wsize=0,this.whave=0,this.wnext=0,this.window=null,this.hold=0,this.bits=0,this.length=0,this.offset=0,this.extra=0,this.lencode=null,this.distcode=null,this.lenbits=0,this.distbits=0,this.ncode=0,this.nlen=0,this.ndist=0,this.have=0,this.next=null,this.lens=new Uint16Array(320),this.work=new Uint16Array(288),this.lendyn=null,this.distdyn=null,this.sane=0,this.back=0,this.was=0}let Bs=t=>{if(!t)return 1;let e=t.state;return!e||e.strm!==t||e.mode<yp||e.mode>16211?1:0},MP=t=>{if(Bs(t))return Hn;let e=t.state;return t.total_in=t.total_out=e.total=0,t.msg="",e.wrap&&(t.adler=1&e.wrap),e.mode=yp,e.last=0,e.havedict=0,e.flags=-1,e.dmax=32768,e.head=null,e.hold=0,e.bits=0,e.lencode=e.lendyn=new Int32Array(852),e.distcode=e.distdyn=new Int32Array(592),e.sane=1,e.back=-1,Fs},UP=t=>{if(Bs(t))return Hn;let e=t.state;return e.wsize=0,e.whave=0,e.wnext=0,MP(t)},xP=(t,e)=>{let i;if(Bs(t))return Hn;let n=t.state;return e<0?(i=0,e=-e):(i=5+(e>>4),e<48&&(e&=15)),e&&(e<8||e>15)?Hn:(n.window!==null&&n.wbits!==e&&(n.window=null),n.wrap=i,n.wbits=e,UP(t))},VP=(t,e)=>{if(!t)return Hn;let i=new S8;t.state=i,i.strm=t,i.window=null,i.mode=yp;let n=xP(t,e);return n!==Fs&&(t.state=null),n},aS,cS,FP=!0,T8=t=>{if(FP){aS=new Int32Array(512),cS=new Int32Array(32);let e=0;for(;e<144;)t.lens[e++]=8;for(;e<256;)t.lens[e++]=9;for(;e<280;)t.lens[e++]=7;for(;e<288;)t.lens[e++]=8;for(rl(1,t.lens,0,288,aS,0,t.work,{bits:9}),e=0;e<32;)t.lens[e++]=5;rl(2,t.lens,0,32,cS,0,t.work,{bits:5}),FP=!1}t.lencode=aS,t.lenbits=9,t.distcode=cS,t.distbits=5},BP=(t,e,i,n)=>{let r,o=t.state;return o.window===null&&(o.wsize=1<<o.wbits,o.wnext=0,o.whave=0,o.window=new Uint8Array(o.wsize)),n>=o.wsize?(o.window.set(e.subarray(i-o.wsize,i),0),o.wnext=0,o.whave=o.wsize):(r=o.wsize-o.wnext,r>n&&(r=n),o.window.set(e.subarray(i-n,i-n+r),o.wnext),(n-=r)?(o.window.set(e.subarray(i-n,i),0),o.wnext=n,o.whave=o.wsize):(o.wnext+=r,o.wnext===o.wsize&&(o.wnext=0),o.whave<o.wsize&&(o.whave+=r))),0};var R8=(t,e)=>{let i,n,r,o,s,a,c,d,l,u,h,p,g,E,f,R,y,N,k,L,P,V,B=0,Y=new Uint8Array(4),J,yt,Rt=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]);if(Bs(t)||!t.output||!t.input&&t.avail_in!==0)return Hn;i=t.state,i.mode===so&&(i.mode=rS),s=t.next_out,r=t.output,c=t.avail_out,o=t.next_in,n=t.input,a=t.avail_in,d=i.hold,l=i.bits,u=a,h=c,V=Fs;t:for(;;)switch(i.mode){case yp:if(i.wrap===0){i.mode=rS;break}for(;l<16;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}if(2&i.wrap&&d===35615){i.wbits===0&&(i.wbits=15),i.check=0,Y[0]=255&d,Y[1]=d>>>8&255,i.check=vi(i.check,Y,2,0),d=0,l=0,i.mode=16181;break}if(i.head&&(i.head.done=!1),!(1&i.wrap)||(((255&d)<<8)+(d>>8))%31){t.msg="incorrect header check",i.mode=We;break}if((15&d)!==LP){t.msg="unknown compression method",i.mode=We;break}if(d>>>=4,l-=4,P=8+(15&d),i.wbits===0&&(i.wbits=P),P>15||P>i.wbits){t.msg="invalid window size",i.mode=We;break}i.dmax=1<<i.wbits,i.flags=0,t.adler=i.check=1,i.mode=512&d?16189:so,d=0,l=0;break;case 16181:for(;l<16;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}if(i.flags=d,(255&_i(i))!==LP){t.msg="unknown compression method",i.mode=We;break}if(57344&_i(i)){t.msg="unknown header flags set",i.mode=We;break}i.head&&(i.head.text=d>>8&1),512&_i(i)&&4&i.wrap&&(Y[0]=255&d,Y[1]=d>>>8&255,i.check=vi(i.check,Y,2,0)),d=0,l=0,i.mode=16182;case 16182:for(;l<32;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}i.head&&(i.head.time=d),512&_i(i)&&4&i.wrap&&(Y[0]=255&d,Y[1]=d>>>8&255,Y[2]=d>>>16&255,Y[3]=d>>>24&255,i.check=vi(i.check,Y,4,0)),d=0,l=0,i.mode=16183;case 16183:for(;l<16;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}i.head&&(i.head.xflags=255&d,i.head.os=d>>8),512&_i(i)&&4&i.wrap&&(Y[0]=255&d,Y[1]=d>>>8&255,i.check=vi(i.check,Y,2,0)),d=0,l=0,i.mode=16184;case 16184:if(1024&_i(i)){for(;l<16;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}i.length=d,i.head&&(i.head.extra_len=d),512&_i(i)&&4&i.wrap&&(Y[0]=255&d,Y[1]=d>>>8&255,i.check=vi(i.check,Y,2,0)),d=0,l=0}else i.head&&(i.head.extra=null);i.mode=16185;case 16185:if(1024&_i(i)&&(p=i.length,p>a&&(p=a),p&&(i.head&&(P=i.head.extra_len-i.length,i.head.extra||(i.head.extra=new Uint8Array(i.head.extra_len)),i.head.extra.set(n.subarray(o,o+p),P)),512&_i(i)&&4&i.wrap&&(i.check=vi(i.check,n,p,o)),a-=p,o+=p,i.length-=p),i.length))break t;i.length=0,i.mode=16186;case 16186:if(2048&_i(i)){if(a===0)break t;p=0;do P=n[o+p++],i.head&&P&&i.length<65536&&(i.head.name+=String.fromCharCode(P));while(P&&p<a);if(512&_i(i)&&4&i.wrap&&(i.check=vi(i.check,n,p,o)),a-=p,o+=p,P)break t}else i.head&&(i.head.name=null);i.length=0,i.mode=16187;case 16187:if(4096&_i(i)){if(a===0)break t;p=0;do P=n[o+p++],i.head&&P&&i.length<65536&&(i.head.comment+=String.fromCharCode(P));while(P&&p<a);if(512&_i(i)&&4&i.wrap&&(i.check=vi(i.check,n,p,o)),a-=p,o+=p,P)break t}else i.head&&(i.head.comment=null);i.mode=16188;case 16188:if(512&_i(i)){for(;l<16;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}if(4&i.wrap&&d!==(65535&i.check)){t.msg="header crc mismatch",i.mode=We;break}d=0,l=0}i.head&&(i.head.hcrc=_i(i)>>9&1,i.head.done=!0),t.adler=i.check=0,i.mode=so;break;case 16189:for(;l<32;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}t.adler=i.check=kP(d),d=0,l=0,i.mode=Cp;case Cp:if(i.havedict===0)return t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,i.hold=d,i.bits=l,f8;t.adler=i.check=1,i.mode=so;case so:if(e===m8||e===vp)break t;case rS:if(i.last){d>>>=7&l,l-=7&l,i.mode=sS;break}for(;l<3;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}switch(i.last=1&d,d>>>=1,l-=1,3&d){case 0:i.mode=16193;break;case 1:if(T8(i),i.mode=bp,e===vp){d>>>=2,l-=2;break t}break;case 2:i.mode=16196;break;case 3:t.msg="invalid block type",i.mode=We}d>>>=2,l-=2;break;case 16193:for(d>>>=7&l,l-=7&l;l<32;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}if((65535&d)!=(d>>>16^65535)){t.msg="invalid stored block lengths",i.mode=We;break}if(i.length=65535&d,d=0,l=0,i.mode=oS,e===vp)break t;case oS:i.mode=16195;case 16195:if(p=i.length,p){if(p>a&&(p=a),p>c&&(p=c),p===0)break t;r.set(n.subarray(o,o+p),s),a-=p,o+=p,c-=p,s+=p,i.length-=p;break}i.mode=so;break;case 16196:for(;l<14;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}if(i.nlen=257+(31&d),d>>>=5,l-=5,i.ndist=1+(31&d),d>>>=5,l-=5,i.ncode=4+(15&d),d>>>=4,l-=4,i.nlen>286||i.ndist>30){t.msg="too many length or distance symbols",i.mode=We;break}i.have=0,i.mode=16197;case 16197:for(;i.have<i.ncode;){for(;l<3;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}i.lens[Rt[i.have++]]=7&d,d>>>=3,l-=3}for(;i.have<19;)i.lens[Rt[i.have++]]=0;if(i.lencode=i.lendyn,i.lenbits=7,J={bits:i.lenbits},V=rl(0,i.lens,0,19,i.lencode,0,i.work,J),i.lenbits=J.bits,V){t.msg="invalid code lengths set",i.mode=We;break}i.have=0,i.mode=16198;case 16198:for(;i.have<i.nlen+i.ndist;){for(;B=i.lencode[d&(1<<i.lenbits)-1],f=B>>>24,R=B>>>16&255,y=65535&B,!(f<=l);){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}if(y<16)d>>>=f,l-=f,i.lens[i.have++]=y;else{if(y===16){for(yt=f+2;l<yt;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}if(d>>>=f,l-=f,i.have===0){t.msg="invalid bit length repeat",i.mode=We;break}P=i.lens[i.have-1],p=3+(3&d),d>>>=2,l-=2}else if(y===17){for(yt=f+3;l<yt;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}d>>>=f,l-=f,P=0,p=3+(7&d),d>>>=3,l-=3}else{for(yt=f+7;l<yt;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}d>>>=f,l-=f,P=0,p=11+(127&d),d>>>=7,l-=7}if(i.have+p>i.nlen+i.ndist){t.msg="invalid bit length repeat",i.mode=We;break}for(;p--;)i.lens[i.have++]=P}}if(i.mode===We)break;if(i.lens[256]===0){t.msg="invalid code -- missing end-of-block",i.mode=We;break}if(i.lenbits=9,J={bits:i.lenbits},V=rl(1,i.lens,0,i.nlen,i.lencode,0,i.work,J),i.lenbits=J.bits,V){t.msg="invalid literal/lengths set",i.mode=We;break}if(i.distbits=6,i.distcode=i.distdyn,J={bits:i.distbits},V=rl(2,i.lens,i.nlen,i.ndist,i.distcode,0,i.work,J),i.distbits=J.bits,V){t.msg="invalid distances set",i.mode=We;break}if(i.mode=bp,e===vp)break t;case bp:i.mode=Ip;case Ip:if(a>=6&&c>=258){t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,i.hold=d,i.bits=l,l8(t,h),s=t.next_out,r=t.output,c=t.avail_out,o=t.next_in,n=t.input,a=t.avail_in,d=i.hold,l=i.bits,i.mode===so&&(i.back=-1);break}for(i.back=0;B=i.lencode[d&(1<<i.lenbits)-1],f=B>>>24,R=B>>>16&255,y=65535&B,!(f<=l);){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}if(R&&(240&R)==0){for(N=f,k=R,L=y;B=i.lencode[L+((d&(1<<N+k)-1)>>N)],f=B>>>24,R=B>>>16&255,y=65535&B,!(N+f<=l);){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}d>>>=N,l-=N,i.back+=N}if(d>>>=f,l-=f,i.back+=f,i.length=y,R===0){i.mode=16205;break}if(32&R){i.back=-1,i.mode=so;break}if(64&R){t.msg="invalid literal/length code",i.mode=We;break}i.extra=15&R,i.mode=16201;case 16201:if(i.extra){for(yt=i.extra;l<yt;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}i.length+=d&(1<<i.extra)-1,d>>>=i.extra,l-=i.extra,i.back+=i.extra}i.was=i.length,i.mode=16202;case 16202:for(;B=i.distcode[d&(1<<i.distbits)-1],f=B>>>24,R=B>>>16&255,y=65535&B,!(f<=l);){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}if((240&R)==0){for(N=f,k=R,L=y;B=i.distcode[L+((d&(1<<N+k)-1)>>N)],f=B>>>24,R=B>>>16&255,y=65535&B,!(N+f<=l);){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}d>>>=N,l-=N,i.back+=N}if(d>>>=f,l-=f,i.back+=f,64&R){t.msg="invalid distance code",i.mode=We;break}i.offset=y,i.extra=15&R,i.mode=16203;case 16203:if(i.extra){for(yt=i.extra;l<yt;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}i.offset+=d&(1<<i.extra)-1,d>>>=i.extra,l-=i.extra,i.back+=i.extra}if(i.offset>i.dmax){t.msg="invalid distance too far back",i.mode=We;break}i.mode=16204;case 16204:if(c===0)break t;if(p=h-c,i.offset>p){if(p=i.offset-p,p>i.whave&&i.sane){t.msg="invalid distance too far back",i.mode=We;break}p>i.wnext?(p-=i.wnext,g=i.wsize-p):g=i.wnext-p,p>i.length&&(p=i.length),E=i.window}else E=r,g=s-i.offset,p=i.length;p>c&&(p=c),c-=p,i.length-=p;do r[s++]=E[g++];while(--p);i.length===0&&(i.mode=Ip);break;case 16205:if(c===0)break t;r[s++]=i.length,c--,i.mode=Ip;break;case sS:if(i.wrap){for(;l<32;){if(a===0)break t;a--,d|=n[o++]<<l,l+=8}if(h-=c,t.total_out+=h,i.total+=h,4&i.wrap&&h&&(t.adler=i.check=_i(i)?vi(i.check,r,h,s-h):Xd(i.check,r,h,s-h)),h=c,4&i.wrap&&(_i(i)?d:kP(d))!==i.check){t.msg="incorrect data check",i.mode=We;break}d=0,l=0}i.mode=16207;case 16207:if(i.wrap&&_i(i)){for(;l<32;){if(a===0)break t;a--,d+=n[o++]<<l,l+=8}if(4&i.wrap&&d!==(4294967295&i.total)){t.msg="incorrect length check",i.mode=We;break}d=0,l=0}i.mode=16208;case 16208:V=E8;break t;case We:V=DP;break t;case 16210:return PP;default:return Hn}return t.next_out=s,t.avail_out=c,t.next_in=o,t.avail_in=a,i.hold=d,i.bits=l,(i.wsize||h!==t.avail_out&&i.mode<We&&(i.mode<sS||e!==NP))&&BP(t,t.output,t.next_out,h-t.avail_out),u-=t.avail_in,h-=t.avail_out,t.total_in+=u,t.total_out+=h,i.total+=h,4&i.wrap&&h&&(t.adler=i.check=_i(i)?vi(i.check,r,h,t.next_out-h):Xd(i.check,r,h,t.next_out-h)),t.data_type=i.bits+(i.last?64:0)+(i.mode===so?128:0)+(i.mode===bp||i.mode===oS?256:0),(u===0&&h===0||e===NP)&&V===Fs&&(V=g8),V},ao={inflateReset:UP,inflateReset2:xP,inflateResetKeep:MP,inflateInit:t=>VP(t,15),inflateInit2:VP,inflate:R8,inflateEnd:t=>{if(Bs(t))return Hn;let e=t.state;return e.window&&(e.window=null),t.state=null,Fs},inflateGetHeader:(t,e)=>{if(Bs(t))return Hn;let i=t.state;return(2&i.wrap)==0?Hn:(i.head=e,e.done=!1,Fs)},inflateSetDictionary:(t,e)=>{let i=e.length,n,r,o;return Bs(t)?Hn:(n=t.state,n.wrap!==0&&n.mode!==Cp?Hn:n.mode===Cp&&(r=1,r=Xd(r,e,i,0),r!==n.check)?DP:(o=BP(t,e,i,i),o?(n.mode=16210,PP):(n.havedict=1,Fs)))},inflateInfo:"pako inflate (from Nodeca project)"},v8=function(){this.text=0,this.time=0,this.xflags=0,this.os=0,this.extra=null,this.extra_len=0,this.name="",this.comment="",this.hcrc=0,this.done=!1};let jP=Object.prototype.toString,{Z_NO_FLUSH:y8,Z_FINISH:C8,Z_OK:ol,Z_STREAM_END:dS,Z_NEED_DICT:lS,Z_STREAM_ERROR:b8,Z_DATA_ERROR:GP,Z_MEM_ERROR:I8}=hc;function sl(t){this.options=gp.assign({chunkSize:65536,windowBits:15,to:""},t||{});let e=this.options;e.raw&&e.windowBits>=0&&e.windowBits<16&&(e.windowBits=-e.windowBits,e.windowBits===0&&(e.windowBits=-15)),!(e.windowBits>=0&&e.windowBits<16)||t&&t.windowBits||(e.windowBits+=32),e.windowBits>15&&e.windowBits<48&&(15&e.windowBits)==0&&(e.windowBits|=15),this.err=0,this.msg="",this.ended=!1,this.chunks=[],this.strm=new wP,this.strm.avail_out=0;let i=ao.inflateInit2(this.strm,e.windowBits);if(i!==ol)throw new Error(Ms[i]);if(this.header=new v8,ao.inflateGetHeader(this.strm,this.header),e.dictionary&&(typeof e.dictionary=="string"?e.dictionary=il.string2buf(e.dictionary):jP.call(e.dictionary)==="[object ArrayBuffer]"&&(e.dictionary=new Uint8Array(e.dictionary)),e.raw&&(i=ao.inflateSetDictionary(this.strm,e.dictionary),i!==ol)))throw new Error(Ms[i])}function uS(t,e){let i=new sl(e);if(i.push(t),i.err)throw i.msg||Ms[i.err];return i.result}sl.prototype.push=function(t,e){let i=this.strm,n=this.options.chunkSize,r=this.options.dictionary,o,s,a;if(this.ended)return!1;for(s=e===~~e?e:e===!0?C8:y8,jP.call(t)==="[object ArrayBuffer]"?i.input=new Uint8Array(t):i.input=t,i.next_in=0,i.avail_in=i.input.length;;){for(i.avail_out===0&&(i.output=new Uint8Array(n),i.next_out=0,i.avail_out=n),o=ao.inflate(i,s),o===lS&&r&&(o=ao.inflateSetDictionary(i,r),o===ol?o=ao.inflate(i,s):o===GP&&(o=lS));i.avail_in>0&&o===dS&&i.state.wrap>0&&t[i.next_in]!==0;)ao.inflateReset(i),o=ao.inflate(i,s);switch(o){case b8:case GP:case lS:case I8:return this.onEnd(o),this.ended=!0,!1}if(a=i.avail_out,i.next_out&&(i.avail_out===0||o===dS))if(this.options.to==="string"){let c=il.utf8border(i.output,i.next_out),d=i.next_out-c,l=il.buf2string(i.output,c);i.next_out=d,i.avail_out=n-d,d&&i.output.set(i.output.subarray(c,c+d),0),this.onData(l)}else this.onData(i.output.length===i.next_out?i.output:i.output.subarray(0,i.next_out));if(o!==ol||a!==0){if(o===dS)return o=ao.inflateEnd(this.strm),this.onEnd(o),this.ended=!0,!0;if(i.avail_in===0)break}}return!0},sl.prototype.onData=function(t){this.chunks.push(t)},sl.prototype.onEnd=function(t){t===ol&&(this.options.to==="string"?this.result=this.chunks.join(""):this.result=gp.flattenChunks(this.chunks)),this.chunks=[],this.err=t,this.msg=this.strm.msg};var A8={Inflate:sl,inflate:uS,inflateRaw:function(t,e){return(e=e||{}).raw=!0,uS(t,e)},ungzip:uS,constants:hc};let{Deflate:SX,deflate:w8,deflateRaw:TX,gzip:RX}=d8,{Inflate:vX,inflate:O8,inflateRaw:yX,ungzip:CX}=A8;var N8=w8,D8=O8,WP=function(t){return t[t.ONE_BYTE=0]="ONE_BYTE",t[t.TWO_BYTE=1]="TWO_BYTE",t}(WP||{});class P8{constructor(){T(this,"_sequence",0),T(this,"_startTime",Date.now()),T(this,"isUseOneByte",!0)}get startTime(){let e=Date.now()-this._startTime;return e<Math.pow(2,16)?e:(this._startTime+=Math.pow(2,16),this.startTime)}get sequence(){return this._sequence<Math.pow(2,32)?this._sequence++:(this._sequence-=Math.pow(2,32),this.sequence)}serialize(e){let i={commonPacketHeader:{length:0,reserved:0,extension:0,sequence:this.sequence},commonStreamHeader:this.startTime,extension:void 0,payload:e};if(e.byteLength>128){let a=new Uint8Array(4);a.set([1,0,0,0]);let c={id:0,length:4,data:a.buffer},d={profile:this.isUseOneByte?0:1,length:this.isUseOneByte?5:6,datas:[c]};i.commonPacketHeader.extension=1,i.extension=d,i.payload=this.compress(e),i.commonPacketHeader.length=8+(i.extension.length+2)+i.payload.byteLength}else i.commonPacketHeader.length=8+i.payload.byteLength;A("SHOW_DATASTREAM2_LOG")&&_.debug("send data header: ".concat(JSON.stringify(i.commonPacketHeader)));let n=new ArrayBuffer(i.commonPacketHeader.length),r=new Uint8Array(n),o=new DataView(n),s=0;if(o.setUint16(s,i.commonPacketHeader.extension<<15|i.commonPacketHeader.reserved<<14|i.commonPacketHeader.length,!0),s+=2,o.setUint32(s,i.commonPacketHeader.sequence,!0),s+=4,o.setUint16(s,i.commonStreamHeader,!0),s+=2,i.extension){let a=this.serializeExtension(i.extension);r.set(new Uint8Array(a),s),s+=a.byteLength}if(r.set(new Uint8Array(i.payload),s),s+=i.payload.byteLength,s!==i.commonPacketHeader.length)throw Error("serialize error!");return n}deserialize(e){if(e.byteLength<4)return new ArrayBuffer(0);let i=new DataView(e),n=0,r=i.getUint16(n,!0);n+=2;let o={length:16383&r,reserved:(16384&r)>>14,extension:(32768&r)>>15,sequence:i.getUint16(n+2,!0)<<16|i.getUint16(n,!0)},s,a;if(n+=4,A("SHOW_DATASTREAM2_LOG")&&_.debug("receive data header: ".concat(JSON.stringify(o))),i.getUint16(n,!0),n+=2,o.extension){a=this.deserializeExtension(e.slice(n)),n+=2+a.length,s=e.slice(n);let c=!1;if(a.datas.length>0){let d=a.datas.find(l=>l.id===0);d&&(c=(1&new DataView(d.data).getUint32(0,!0))==1)}s=c?this.decompress(s):s}else s=e.slice(8);return s}serializeExtension(e){let{profile:i,length:n,datas:r}=e,o=new ArrayBuffer(n+2),s=new Uint8Array(o),a=new DataView(o),c=0;if(a.setUint8(c++,i),a.setUint8(c++,n),r.forEach(d=>{i?(a.setUint8(c++,d.id),a.setUint8(c++,d.length),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength):(a.setUint8(c++,d.id|d.length<<4),s.set(new Uint8Array(d.data),c),c+=d.data.byteLength)}),c!==n+2)throw Error("serialize extension error, is ".concat(c,"!==").concat(n+2));return o}deserializeExtension(e){let i=new DataView(e),n=0,r=i.getUint8(n);n++;let o=i.getUint8(n);n++;let s=r===WP.TWO_BYTE,a=[],c=new DataView(e,2),d=0;for(;d<o;){let l=0,u=0,h=new ArrayBuffer(0);s?(l=c.getUint8(d),d++,u=c.getUint8(d),d++):(l=15&c.getUint8(d),u=c.getUint8(d)>>4,d++),u>0&&(h=c.buffer.slice(d+2,d+2+u),d+=h.byteLength),a.push({id:l,length:u,data:h})}if(d!==o)throw Error("parse error");return{profile:r,length:o,datas:a}}decompress(e){return D8(new Uint8Array(e))}compress(e){return N8(new Uint8Array(e))}}let L8={name:"DataStream",create:(t,e)=>{let i=e?new GK(t):new WK(t);return i.useDataStream(new P8),i}};class k8 extends ue{constructor(e,i,n){super(),T(this,"ws",void 0),T(this,"requestId",1),T(this,"heartBeatTimer",void 0),T(this,"joinInfo",void 0),T(this,"clientId",void 0),T(this,"onOpen",()=>{this.emit("open"),this.startHeartBeatCheck()}),T(this,"onClose",r=>{this.emit("close"),this.dispose()}),T(this,"onMessage",r=>{let o=JSON.parse(r.data);if(!o||o.command!=="serverResponse"||!o.requestId)return o&&o.command==="serverStatus"&&o.serverStatus&&o.serverStatus.command?(this.emit("status",o.serverStatus),void this.emit(o.serverStatus.command,o.serverStatus)):void 0;this.emit("req_".concat(o.requestId),o)}),this.joinInfo=e,this.clientId=i,this.ws=new Nd("cross-channel-".concat(this.clientId),n),this.ws.on(Tt.RECONNECTING,()=>{this.ws.reconnectMode="retry",this.emit("reconnecting")}),this.ws.on(Tt.CONNECTED,this.onOpen),this.ws.on(Tt.ON_MESSAGE,this.onMessage),this.ws.on(Tt.CLOSED,this.onClose)}isConnect(){return this.ws.state==="connected"}sendMessage(e){let i=this.requestId++;return e.requestId=i,e.seq=i,this.ws.sendMessage(e),i}waitStatus(e){return new Q((i,n)=>{let r=window.setTimeout(()=>{n(new x(C.TIMEOUT,"wait status timeout, status: ".concat(e)))},5e3);this.once(e,o=>{window.clearTimeout(r),o.state&&o.state!==0?n(new x(C.CROSS_CHANNEL_WAIT_STATUS_ERROR,"wait status error, status: ".concat(e))):i(void 0)}),this.once("dispose",()=>{window.clearTimeout(r),n(new x(C.WS_ABORT))})})}request(e){return I(this,null,function*(){if(this.ws.state==="closed")throw new x(C.WS_DISCONNECT);let i=()=>new Q((s,a)=>{this.ws.once(Tt.CLOSED,()=>a(new x(C.WS_ABORT))),this.ws.once(Tt.CONNECTED,s)});this.ws.state!=="connected"&&(yield i());let n=this.sendMessage(e),r=new Q((s,a)=>{let c=()=>{a(new x(C.WS_ABORT))};this.ws.once(Tt.RECONNECTING,c),this.ws.once(Tt.CLOSED,c),this.once("req_".concat(n),s),qe(3e3).then(()=>{this.removeAllListeners("req_".concat(n)),this.ws.off(Tt.RECONNECTING,c),this.ws.off(Tt.CLOSED,c),a(new x(C.TIMEOUT,"cross channel ws request timeout"))})}),o=yield r;if(!o||o.code!==200)throw new x(C.CROSS_CHANNEL_SERVER_ERROR_RESPONSE,"response: ".concat(JSON.stringify(o)));return o})}connect(e){return I(this,null,function*(){this.ws.removeAllListeners(Tt.REQUEST_NEW_URLS),this.ws.on(Tt.REQUEST_NEW_URLS,i=>{i(e)}),yield this.ws.init(e)})}dispose(){this.clearHeartBeatCheck(),this.emit("dispose"),this.removeAllListeners(),this.ws.close()}sendPing(e){let i=this.requestId++;return e.requestId=i,this.ws.sendMessage(e),i}startHeartBeatCheck(){this.heartBeatTimer&&window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=window.setInterval(()=>{this.sendPing({command:"ping",appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sid:this.joinInfo.sid,ts:+new Date,requestId:0})},3e3)}clearHeartBeatCheck(){window.clearInterval(this.heartBeatTimer),this.heartBeatTimer=void 0}}class M8 extends ue{set state(e){e!==this._state&&(e!==ki.RELAY_STATE_FAILURE&&(this.errorCode=Qa.RELAY_OK),this.emit("state",e,this.errorCode),this._state=e)}get state(){return this._state}constructor(e,i,n,r,o){super(),T(this,"joinInfo",void 0),T(this,"sid",void 0),T(this,"clientId",void 0),T(this,"cancelToken",bi.CancelToken.source()),T(this,"workerToken",void 0),T(this,"requestId",0),T(this,"signal",void 0),T(this,"prevChannelMediaConfig",void 0),T(this,"httpRetryConfig",void 0),T(this,"_resolution",void 0),T(this,"_state",ki.RELAY_STATE_IDLE),T(this,"errorCode",Qa.RELAY_OK),T(this,"onStatus",s=>{_.debug("[".concat(this.clientId,"] ChannelMediaStatus: ").concat(JSON.stringify(s))),s&&s.command&&(s.command==="onAudioPacketReceived"&&this.emit("event",eo.PACKET_RECEIVED_AUDIO_FROM_SRC),s.command==="onVideoPacketReceived"&&this.emit("event",eo.PACKET_RECEIVED_VIDEO_FROM_SRC),s.command==="onSrcTokenPrivilegeDidExpire"&&(this.errorCode=Qa.SRC_TOKEN_EXPIRED,this.state=ki.RELAY_STATE_FAILURE),s.command==="onDestTokenPrivilegeDidExpire"&&(this.errorCode=Qa.DEST_TOKEN_EXPIRED,this.state=ki.RELAY_STATE_FAILURE))}),T(this,"onReconnect",()=>I(this,null,function*(){_.debug("[".concat(this.clientId,"] ChannelMediaSocket disconnect, reconnecting")),this.emit("event",eo.NETWORK_DISCONNECTED),this.state=ki.RELAY_STATE_IDLE,this.prevChannelMediaConfig&&this.sendStartRelayMessage(this.prevChannelMediaConfig).catch(s=>{this.state!==ki.RELAY_STATE_IDLE&&(_.error("auto restart channel media relay failed",s.toString()),this.errorCode=Qa.SERVER_CONNECTION_LOST,this.state=ki.RELAY_STATE_FAILURE)})})),this.joinInfo=e,this.clientId=i,this.sid=Rs(),this.signal=new k8(this.joinInfo,this.clientId,n),this.httpRetryConfig=r,this._resolution=o}startChannelMediaRelay(e){return I(this,null,function*(){if(this.state!==ki.RELAY_STATE_IDLE)throw new x(C.INVALID_OPERATION);this.state=ki.RELAY_STATE_CONNECTING,yield this.connect(),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: connect success"));try{yield this.sendStartRelayMessage(e)}catch(i){throw i.data&&i.data.serverResponse&&i.data.serverResponse.command==="SetSourceChannel"?new x(C.CROSS_CHANNEL_FAILED_JOIN_SRC):i.data&&i.data.serverResponse&&i.serverResponse.command==="SetDestChannelStatus"?new x(C.CROSS_CHANNEL_FAILED_JOIN_DEST):i.data&&i.data.serverResponse&&i.serverResponse.command==="StartPacketTransfer"?new x(C.CROSS_CHANNEL_FAILED_PACKET_SENT_TO_DEST):i}this.prevChannelMediaConfig=e})}updateChannelMediaRelay(e){return I(this,null,function*(){if(this.state!==ki.RELAY_STATE_RUNNING)throw new x(C.INVALID_OPERATION);yield this.sendUpdateMessage(e),this.prevChannelMediaConfig=e})}setVideoProfile(e){return I(this,null,function*(){if(this._resolution=e,this.state!==ki.RELAY_STATE_RUNNING)throw new x(C.INVALID_OPERATION);let i=this.genMessage(Ri.SetVideoProfile);yield this.signal.request(i),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: setVideoProfile success"))})}stopChannelMediaRelay(){return I(this,null,function*(){yield this.sendStopRelayMessage(),_.debug("[".concat(this.clientId,"] stopChannelMediaRelay: send stop message success")),this.state=ki.RELAY_STATE_IDLE,this.dispose()})}dispose(){_.debug("[".concat(this.clientId,"] disposeChannelMediaRelay")),this.cancelToken.cancel(),this.cancelToken=bi.CancelToken.source(),this.state=ki.RELAY_STATE_IDLE,this.emit("dispose"),this.signal.dispose(),this.prevChannelMediaConfig=void 0}connect(){return I(this,null,function*(){let e=yield z6(this.joinInfo,this.cancelToken.token,this.httpRetryConfig);this.workerToken=e.workerToken,yield this.signal.connect(e.addressList),this.emit("event",eo.NETWORK_CONNECTED),this.signal.on("status",this.onStatus),this.signal.on("reconnecting",this.onReconnect)})}sendStartRelayMessage(e){return I(this,null,function*(){let i=this.genMessage(Ri.StopPacketTransfer);yield this.signal.request(i),yield this.signal.waitStatus("Normal Quit"),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: StopPacketTransfer success"));let n=this.genMessage(Ri.SetSdkProfile,e);yield this.signal.request(n),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSdkProfile success"));let r=this.genMessage(Ri.SetSourceChannel,e);yield this.signal.request(r),yield this.signal.waitStatus("SetSourceChannelStatus"),this.emit("event",eo.PACKET_JOINED_SRC_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceChannel success"));let o=this.genMessage(Ri.SetSourceUserId,e);yield this.signal.request(o),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetSourceUserId success"));let s=this.genMessage(Ri.SetDestChannel,e);yield this.signal.request(s),yield this.signal.waitStatus("SetDestChannelStatus"),this.emit("event",eo.PACKET_JOINED_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] startChannelMediaRelay: SetDestChannel success"));let a=this.genMessage(Ri.StartPacketTransfer,e);yield this.signal.request(a),this.emit("event",eo.PACKET_SENT_TO_DEST_CHANNEL),this.state=ki.RELAY_STATE_RUNNING,_.debug("[".concat(this.clientId,"] startChannelMediaRelay: StartPacketTransfer success")),this.setVideoProfile(this._resolution)})}sendUpdateMessage(e){return I(this,null,function*(){let i=this.genMessage(Ri.UpdateDestChannel,e);yield this.signal.request(i),this.emit("event",eo.PACKET_UPDATE_DEST_CHANNEL),_.debug("[".concat(this.clientId,"] sendUpdateMessage: UpdateDestChannel success"))})}sendStopRelayMessage(){return I(this,null,function*(){let e=this.genMessage(Ri.StopPacketTransfer);yield this.signal.request(e),_.debug("[".concat(this.clientId,"] sendStopRelayMessage: StopPacketTransfer success"))})}genMessage(e,i){let n=[],r=[],o=[];this.requestId+=1;let s={appId:this.joinInfo.appId,cname:this.joinInfo.cname,uid:this.joinInfo.uid.toString(),sdkVersion:hn,sid:this.sid,ts:Date.now(),requestId:this.requestId,seq:this.requestId,allocate:!0,clientRequest:{}};s.sdkVersion==="4.23.4"&&(s.sdkVersion="0.0.1");let a=null,c=null;switch(e){case Ri.SetSdkProfile:return s.clientRequest={command:"SetSdkProfile",type:"multi_channel"},s;case Ri.SetSourceChannel:if(c=i&&i.getSrcChannelMediaInfo(),!c)throw new x(C.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceChannel",uid:"0",channelName:c.channelName,token:c.token||this.joinInfo.appId},s;case Ri.SetSourceUserId:if(c=i&&i.getSrcChannelMediaInfo(),!c)throw new x(C.UNEXPECTED_ERROR,"can not find source config");return s.clientRequest={command:"SetSourceUserId",uid:c.uid+""},s;case Ri.SetDestChannel:if(a=i&&i.getDestChannelMediaInfo(),!a)throw new x(C.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{n.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"SetDestChannel",channelName:n,uid:r,token:o},s;case Ri.StartPacketTransfer:return s.clientRequest={command:"StartPacketTransfer"},s;case Ri.Reconnect:return s.clientRequest={command:"Reconnect"},s;case Ri.StopPacketTransfer:return s.clientRequest={command:"StopPacketTransfer"},s;case Ri.UpdateDestChannel:if(a=i&&i.getDestChannelMediaInfo(),!a)throw new x(C.UNEXPECTED_ERROR,"can not find dest config");return a.forEach(d=>{n.push(d.channelName),r.push(d.uid+""),o.push(d.token||this.joinInfo.appId)}),s.clientRequest={command:"UpdateDestChannel",channelName:n,uid:r,token:o},s;case Ri.SetVideoProfile:s.clientRequest={command:"SetVideoProfile",width:this._resolution.width,height:this._resolution.height}}return s}}let U8={name:"ChannelMediaRelay",create:function(t){return new M8(t.joinInfo,t.clientId,t.websocketRetryConfig||Oe,t.httpRetryConfig||Oe,t.resolution)}};function HP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function al(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?HP(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):HP(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class x8 extends ue{constructor(e,i,n,r){super(),T(this,"spec",void 0),T(this,"token",void 0),T(this,"websocket",void 0),T(this,"pingpongTimer",void 0),T(this,"reconnectMode","retry"),T(this,"serviceMode",void 0),T(this,"reqId",0),T(this,"commandReqId",0),T(this,"handleWebSocketOpen",()=>{this.reconnectMode="retry",this.startPingPong()}),T(this,"handleWebSocketMessage",o=>{if(!o.data)return;let s=JSON.parse(o.data);s.requestId?this.emit("@".concat(s.requestId,"-").concat(s.sid),s):(ot.workerEvent(this.spec.sid,{actionType:"status",serverCode:s.code,workerType:this.serviceMode===Ar.TRANSCODE?1:2}),this.emit(Vo.PUBLISH_STREAM_STATUS,s))}),this.spec=i,this.token=e,this.serviceMode=r,this.websocket=new Nd("live-streaming",n),this.websocket.on(Tt.CONNECTED,this.handleWebSocketOpen),this.websocket.on(Tt.ON_MESSAGE,this.handleWebSocketMessage),this.websocket.on(Tt.REQUEST_NEW_URLS,(o,s)=>{$e(this,Vo.REQUEST_NEW_ADDRESS).then(o).catch(s)}),this.websocket.on(Tt.RECONNECTING,()=>{this.websocket.reconnectMode=this.reconnectMode})}init(e){return this.websocket.init(e)}request(e,i,n,r){return I(this,null,function*(){this.reqId+=1,e==="request"&&(this.commandReqId+=1);let o=this.commandReqId,s=this.reqId;if(!s||!this.websocket)throw new x(C.UNEXPECTED_ERROR);let a=al({command:e,sdkVersion:hn==="4.23.4"?"0.0.1":hn,seq:s,requestId:s,allocate:n,cname:this.spec.cname,appId:this.spec.appId,sid:this.spec.sid,uid:this.spec.uid.toString(),ts:Math.floor(Date.now()/1e3)},i);if(this.websocket.state==="closed")throw new x(C.WS_DISCONNECT);let c=()=>new Q((h,p)=>{this.websocket.once(Tt.CLOSED,()=>p(new x(C.WS_ABORT))),this.websocket.once(Tt.CONNECTED,h)});this.websocket.state!=="connected"&&(yield c()),a.clientRequest&&(a.clientRequest.workerToken=this.token);let d=new Q((h,p)=>{let g=()=>{p(new x(C.WS_ABORT))};this.websocket.once(Tt.RECONNECTING,g),this.websocket.once(Tt.CLOSED,g),this.once("@".concat(s,"-").concat(this.spec.sid),E=>{h(E)})});r&&ot.workerEvent(this.spec.sid,al(al({},r),{},{requestId:o,actionType:"request",payload:JSON.stringify(i.clientRequest),serverCode:0,code:0}));let l=Date.now();this.websocket.sendMessage(a);let u=null;try{u=yield d}catch(h){if(this.websocket.state==="closed")throw h;return yield c(),yield this.request(e,i,n)}return r&&ot.workerEvent(this.spec.sid,al(al({},r),{},{requestId:o,actionType:"response",payload:JSON.stringify(u.serverResponse),serverCode:u.code,success:u.code===200,responseTime:Date.now()-l})),u.code!==200&&this.handleResponseError(u),u})}tryNextAddress(){this.reconnectMode="tryNext",this.websocket.reconnect("tryNext")}close(){let e=hn==="4.23.4"?"0.0.1":hn;this.reqId+=1,this.websocket.state==="connected"?(this.websocket.sendMessage({command:"request",appId:this.spec.appId,cname:this.spec.cname,uid:this.spec.uid.toString(),sdkVersion:e,sid:this.spec.sid,seq:this.reqId,ts:Math.floor(Date.now()/1e3),requestId:this.reqId,clientRequest:{command:"DestroyWorker"}}),this.websocket.close(!1,!0)):this.websocket.close(!1),this.pingpongTimer&&(window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0)}handleResponseError(e){switch(e.code){case ke.LIVE_STREAM_RESPONSE_ALREADY_EXISTS_STREAM:return void _.warning("live stream response already exists stream");case ke.LIVE_STREAM_RESPONSE_TRANSCODING_PARAMETER_ERROR:case ke.LIVE_STREAM_RESPONSE_BAD_STREAM:case ke.LIVE_STREAM_RESPONSE_WM_PARAMETER_ERROR:return new x(C.LIVE_STREAMING_INVALID_ARGUMENT,"",{code:e.code}).throw();case ke.LIVE_STREAM_RESPONSE_WM_WORKER_NOT_EXIST:if(e.serverResponse.command==="UnpublishStream")return;throw new x(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ke.LIVE_STREAM_RESPONSE_NOT_AUTHORIZED:return new x(C.LIVE_STREAMING_PUBLISH_STREAM_NOT_AUTHORIZED,"",{code:e.code}).throw();case ke.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let i=new x(C.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE);return this.emit(Vo.WARNING,i,e.serverResponse.url)}case ke.LIVE_STREAM_RESPONSE_REQUEST_TOO_OFTEN:{let i=new x(C.LIVE_STREAMING_WARN_FREQUENT_REQUEST);return this.emit(Vo.WARNING,i,e.serverResponse.url)}case ke.LIVE_STREAM_RESPONSE_NOT_FOUND_PUBLISH:throw new x(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream response wm worker not exist",{retry:!0});case ke.LIVE_STREAM_RESPONSE_NOT_SUPPORTED:return new x(C.LIVE_STREAMING_TRANSCODING_NOT_SUPPORTED,"",{code:e.code}).throw();case ke.LIVE_STREAM_RESPONSE_MAX_STREAM_NUM:{let i=new x(C.LIVE_STREAMING_WARN_STREAM_NUM_REACH_LIMIT);return this.emit(Vo.WARNING,i,e.serverResponse.url)}case ke.LIVE_STREAM_RESPONSE_INTERNAL_SERVER_ERROR:return new x(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code}).throw();case ke.LIVE_STREAM_RESPONSE_RESOURCE_LIMIT:throw new x(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"live stream resource limit",{retry:!0,changeAddress:!0});case ke.LIVE_STREAM_RESPONSE_WORKER_LOST:case ke.LIVE_STREAM_RESPONSE_WORKER_QUIT:if(e.serverResponse.command==="UnpublishStream")return;throw new x(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ke.ERROR_FAIL_SEND_MESSAGE:if(e.serverResponse.command==="UnpublishStream")return;if(e.serverResponse.command==="UpdateTranscoding"||e.serverResponse.command==="ControlStream")return new x(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{code:e.code}).throw();throw new x(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"error fail send message",{retry:!0,changeAddress:!0});case ke.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ke.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ke.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ke.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:return new x(C.LIVE_STREAMING_CDN_ERROR,"",{code:e.code}).throw()}}startPingPong(){this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(()=>{this.websocket.state==="connected"&&this.request("ping",{}).catch(fh)},6e3)}}function KP(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Mi(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?KP(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):KP(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class V8 extends ue{constructor(e){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:Oe,n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:Oe;super(),T(this,"onLiveStreamWarning",void 0),T(this,"onLiveStreamError",void 0),T(this,"spec",void 0),T(this,"retryTimeout",1e4),T(this,"connection",void 0),T(this,"httpRetryConfig",void 0),T(this,"wsRetryConfig",void 0),T(this,"streamingTasks",new Map),T(this,"isStartingStreamingTask",!1),T(this,"taskMutex",new ni("live-streaming")),T(this,"cancelToken",bi.CancelToken.source()),T(this,"transcodingConfig",void 0),T(this,"uapResponse",void 0),T(this,"lastTaskId",1),T(this,"statusError",new Map),this.spec=e,this.httpRetryConfig=n,this.wsRetryConfig=i}setTranscodingConfig(e){return I(this,null,function*(){let i=Mi(Mi({},A6),e);i.videoCodecProfile!==66&&i.videoCodecProfile!==77&&i.videoCodecProfile!==100&&(_.debug("[".concat(this.spec.clientId,"] set transcoding config, fix video codec profile: ").concat(i.videoCodecProfile," -> 100")),i.videoCodecProfile=100),i.transcodingUsers||(i.transcodingUsers=i.userConfigs),i.transcodingUsers&&(i.transcodingUsers=i.transcodingUsers.map(s=>Mi(Mi(Mi({},I6),s),{},{zOrder:s.zOrder?s.zOrder+1:1}))),function(s){me(s.width)||Xt(s.width,"config.width",0,1e4),me(s.height)||Xt(s.height,"config.height",0,1e4),me(s.videoBitrate)||Xt(s.videoBitrate,"config.videoBitrate",1,1e6),me(s.videoFrameRate)||Xt(s.videoFrameRate,"config.videoFrameRate"),me(s.lowLatency)||Zr(s.lowLatency,"config.lowLatency"),me(s.audioSampleRate)||xe(s.audioSampleRate,"config.audioSampleRate",[32e3,44100,48e3]),me(s.audioBitrate)||Xt(s.audioBitrate,"config.audioBitrate",1,128),me(s.audioChannels)||xe(s.audioChannels,"config.audioChannels",[1,2,3,4,5]),me(s.videoGop)||Xt(s.videoGop,"config.videoGop"),me(s.videoCodecProfile)||xe(s.videoCodecProfile,"config.videoCodecProfile",[66,77,100]),me(s.userCount)||Xt(s.userCount,"config.userCount",0,17),me(s.backgroundColor)||Xt(s.backgroundColor,"config.backgroundColor",0,16777215),me(s.userConfigExtraInfo)||Ke(s.userConfigExtraInfo,"config.userConfigExtraInfo",0,4096,!1),s.transcodingUsers&&!me(s.transcodingUsers)&&($r(s.transcodingUsers,"config.transcodingUsers"),s.transcodingUsers.forEach((a,c)=>{jh(a.uid),me(a.x)||Xt(a.x,"transcodingUser[".concat(c,"].x"),0,1e4),me(a.y)||Xt(a.y,"transcodingUser[".concat(c,"].y"),0,1e4),me(a.width)||Xt(a.width,"transcodingUser[".concat(c,"].width"),0,1e4),me(a.height)||Xt(a.height,"transcodingUser[".concat(c,"].height"),0,1e4),me(a.zOrder)||Xt(a.zOrder-1,"transcodingUser[".concat(c,"].zOrder"),0,100),me(a.alpha)||Xt(a.alpha,"transcodingUser[".concat(c,"].alpha"),0,1,!1)})),me(s.watermark)||dg(s.watermark,"watermark"),me(s.backgroundImage)||dg(s.backgroundImage,"backgroundImage"),s.images&&!me(s.images)&&($r(s.images,"config.images"),s.images.forEach((a,c)=>{dg(a,"images[".concat(c,"]"))}))}(i);let n=[];i.images&&n.push(...i.images.map(s=>Mi(Mi(Mi({},cg),s),{},{zOrder:255}))),i.backgroundImage&&(n.push(Mi(Mi(Mi({},cg),i.backgroundImage),{},{zOrder:0})),delete i.backgroundImage),i.watermark&&(n.push(Mi(Mi(Mi({},cg),i.watermark),{},{zOrder:255})),delete i.watermark),i.images=n,i.transcodingUsers&&(i.userConfigs=i.transcodingUsers.map(s=>Mi({},s)),i.userCount=i.transcodingUsers.length,delete i.transcodingUsers);let r=(i.userConfigs||[]).map(s=>typeof s.uid=="number"?Q.resolve(s.uid):pN(s.uid,this.spec,this.cancelToken.token,this.httpRetryConfig));if((yield Q.all(r)).forEach((s,a)=>{i.userConfigs&&i.userConfigs[a]&&(i.userConfigs[a].uid=s)}),this.transcodingConfig=i,this.connection)try{var o;let s=yield this.connection.request("request",{clientRequest:{command:"UpdateTranscoding",transcodingConfig:this.transcodingConfig}},!1,{command:"UpdateTranscoding",workerType:1,requestByUser:!0,tid:Array.from(Bi(o=this.streamingTasks).call(o)).map(a=>a.taskId).join("#")});_.debug("[".concat(this.spec.clientId,"] update live transcoding config success, code: ").concat(s.code,", config:"),JSON.stringify(this.transcodingConfig))}catch(s){if(!s.data||!s.data.retry)throw s;s.data.changeAddress&&this.connection.tryNextAddress(),this.streamingTasks.forEach(a=>{_.warning("[".concat(this.spec.clientId,"] live streaming receive error"),s.toString(),"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,s).then(()=>{_.debug("[".concat(this.spec.clientId,"] live streaming republish ").concat(a.url," success"))}).catch(c=>{_.error("[".concat(this.spec.clientId,"] live streaming republish failed"),a.url,c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)})})}})}startLiveStreamingTask(e,i,n){return I(this,null,function*(){if(!this.transcodingConfig&&i===Ar.TRANSCODE)throw new x(C.INVALID_OPERATION,"[LiveStreaming] no transcoding config found, can not start transcoding streaming task");let r={command:"PublishStream",ts:Date.now(),url:e,uid:this.spec.uid.toString(),autoDestroyTime:100,acceptImageTimeout:!0};_.debug("[".concat(this.spec.clientId,"] start live streaming ").concat(e,", mode: ").concat(i));let o=yield this.taskMutex.lock();if(!this.connection&&n)return void o();if(this.streamingTasks.get(e)&&!n)return o(),new x(C.LIVE_STREAMING_TASK_CONFLICT).throw();try{this.connection||(this.connection=yield this.connect(i))}catch(a){throw o(),a}switch(i){case Ar.TRANSCODE:r.transcodingConfig=Mi({},this.transcodingConfig);case Ar.RAW:}this.uapResponse&&this.uapResponse.vid&&(r.vid=this.uapResponse.vid),this.isStartingStreamingTask=!0;let s=this.lastTaskId++;try{let a=new Q((d,l)=>{qe(this.retryTimeout).then(()=>{if(n)return l(n);let u=this.statusError.get(e);return u?(this.statusError.delete(e),l(u)):void 0})}),c=yield Q.race([this.connection.request("request",{clientRequest:r},!0,{url:e,command:"PublishStream",workerType:i===Ar.TRANSCODE?1:2,requestByUser:!n,tid:s.toString()}),a]);this.isStartingStreamingTask=!1,_.debug("[".concat(this.spec.clientId,"] live streaming started, code: ").concat(c.code)),this.streamingTasks.set(e,{clientRequest:r,mode:i,url:e,taskId:s}),o()}catch(a){if(o(),this.isStartingStreamingTask=!1,!a.data||!a.data.retry||n)throw a;return a.data.changeAddress?(this.connection.tryNextAddress(),yield this.startLiveStreamingTask(e,i,a)):yield this.startLiveStreamingTask(e,i,a)}})}stopLiveStreamingTask(e){return new Q((i,n)=>{let r=this.streamingTasks.get(e);if(!r||!this.connection)return new x(C.UNEXPECTED_ERROR,"can not find streaming task to stop").throw();let o=r.mode;r.abortTask=()=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success(worker exception)")),this.streamingTasks.delete(e),i()},this.connection.request("request",{clientRequest:{command:"UnpublishStream",url:r.url}},!1,{url:e,command:"UnPublishStream",workerType:o===Ar.TRANSCODE?1:2,requestByUser:!0,tid:(this.lastTaskId++).toString()}).then(s=>{_.debug("[".concat(this.spec.clientId,"] stop live streaming success, code: ").concat(s.code)),this.streamingTasks.delete(e),this.streamingTasks.size===0&&(this.connection&&this.connection.close(),this.connection=void 0),i()}).catch(n)})}resetAllTask(){var e;let i=Array.from(Bi(e=this.streamingTasks).call(e));this.terminate();for(let n of i)this.startLiveStreamingTask(n.url,n.mode).catch(r=>{this.onLiveStreamError&&this.onLiveStreamError(n.url,r)})}terminate(){this.cancelToken&&this.cancelToken.cancel(),this.streamingTasks=new Map,this.isStartingStreamingTask=!1,this.statusError=new Map,this.cancelToken=bi.CancelToken.source(),this.uapResponse=void 0,this.connection&&this.connection.close(),this.connection=void 0}connect(e){return I(this,null,function*(){if(this.connection)throw new x(C.UNEXPECTED_ERROR,"live streaming connection has already connected");let i=yield $e(this,lg.REQUEST_WORKER_MANAGER_LIST,e);return this.uapResponse=i,this.connection=new x8(i.workerToken,this.spec,this.wsRetryConfig,e),this.connection.on(Vo.WARNING,(n,r)=>this.onLiveStreamWarning&&this.onLiveStreamWarning(r,n)),this.connection.on(Vo.PUBLISH_STREAM_STATUS,n=>this.handlePublishStreamServer(n)),this.connection.on(Vo.REQUEST_NEW_ADDRESS,(n,r)=>{if(!this.connection)return r(new x(C.UNEXPECTED_ERROR,"can not get new live streaming address list"));$e(this,lg.REQUEST_WORKER_MANAGER_LIST,e).then(o=>{this.uapResponse=o,n(o.addressList)}).catch(r)}),yield this.connection.init(i.addressList),this.connection})}handlePublishStreamServer(e){let i=e.serverStatus&&e.serverStatus.url||"empty_url",n=this.streamingTasks.get(i),r=e.reason;switch(e.code){case ke.PUBLISH_STREAM_STATUS_ERROR_PUBLISH_BROKEN:case ke.PUBLISH_STREAM_STATUS_ERROR_RTMP_CONNECT:case ke.PUBLISH_STREAM_STATUS_ERROR_RTMP_HANDSHAKE:case ke.PUBLISH_STREAM_STATUS_ERROR_RTMP_PUBLISH:{let s=new x(C.LIVE_STREAMING_CDN_ERROR,"",{code:e.code});if(n)return _.error(s.toString()),this.onLiveStreamError&&this.onLiveStreamError(i,s);if(!this.isStartingStreamingTask)return;this.statusError.set(i,s)}case ke.LIVE_STREAM_RESPONSE_FAILED_LOAD_IMAGE:{let s=new x(C.LIVE_STREAMING_WARN_FAILED_LOAD_IMAGE,r);return this.onLiveStreamWarning&&this.onLiveStreamWarning(i,s)}case ke.LIVE_STREAM_RESPONSE_WORKER_LOST:case ke.LIVE_STREAM_RESPONSE_WORKER_QUIT:{var o;if(!this.connection)return;this.connection.tryNextAddress();let s=Array.from(Bi(o=this.streamingTasks).call(o));for(let a of s)a.abortTask?a.abortTask():(_.warning("[".concat(this.spec.clientId,"] publish stream status code"),e.code,"try to republish",a.url),this.startLiveStreamingTask(a.url,a.mode,new x(C.LIVE_STREAMING_INTERNAL_SERVER_ERROR,"",{code:e.code})).then(()=>{_.debug("[".concat(this.spec.clientId,"] republish live stream success"),a.url)}).catch(c=>{_.error(c.toString()),this.onLiveStreamError&&this.onLiveStreamError(a.url,c)}));return}}}hasUrl(e){return this.streamingTasks.has(e)}}let F8={name:"LiveStreaming",create:function(t){return new V8(t.joinInfo,t.websocketRetryConfig||Oe,t.httpRetryConfig||Oe)}};function B8(t){let e=zP();return function(i,n){let r=i.appId;r!==void 0&&(Kt(n,10),xr(n,r));let o=i.cid;o!==void 0&&(Kt(n,16),Kt(n,o));let s=i.cname;s!==void 0&&(Kt(n,26),xr(n,s));let a=i.deviceId;a!==void 0&&(Kt(n,34),xr(n,a));let c=i.elapse;c!==void 0&&(Kt(n,40),Zo(n,c));let d=i.fileSize;d!==void 0&&(Kt(n,48),Zo(n,Ec(d)));let l=i.height;l!==void 0&&(Kt(n,56),Zo(n,Ec(l)));let u=i.jpg;u!==void 0&&(Kt(n,66),Kt(n,u.length),function(Ni,j){let K=fc(Ni,j.length);Ni.bytes.set(j,K)}(n,u));let h=i.networkType;h!==void 0&&(Kt(n,72),Zo(n,Ec(h)));let p=i.osType;p!==void 0&&(Kt(n,80),Zo(n,Ec(p)));let g=i.requestId;g!==void 0&&(Kt(n,90),xr(n,g));let E=i.sdkVersion;E!==void 0&&(Kt(n,98),xr(n,E));let f=i.sequence;f!==void 0&&(Kt(n,104),Zo(n,Ec(f)));let R=i.sid;R!==void 0&&(Kt(n,114),xr(n,R));let y=i.timestamp;y!==void 0&&(Kt(n,120),Zo(n,y));let N=i.uid;N!==void 0&&(Kt(n,128),Kt(n,N));let k=i.vid;k!==void 0&&(Kt(n,136),Kt(n,k));let L=i.width;L!==void 0&&(Kt(n,144),Zo(n,Ec(L)));let P=i.service;P!==void 0&&(Kt(n,152),Kt(n,P));let V=i.callbackData;V!==void 0&&(Kt(n,162),xr(n,V));let B=i.jpgEncryption;B!==void 0&&(Kt(n,168),Kt(n,B));let Y=i.requestType;Y!==void 0&&(Kt(n,176),Kt(n,Y));let J=i.scorePorn;J!==void 0&&(Kt(n,185),ES(n,J));let yt=i.scoreSexy;yt!==void 0&&(Kt(n,193),ES(n,yt));let Rt=i.scoreNeutral;Rt!==void 0&&(Kt(n,201),ES(n,Rt));let _t=i.scene;_t!==void 0&&(Kt(n,208),Kt(n,_t));let ne=i.ossFilePrefix;ne!==void 0&&(Kt(n,218),xr(n,ne));let Qt=i.serviceVendor;if(Qt!==void 0)for(let Ni of Qt){Kt(n,226);let j=zP();W8(Ni,j),Kt(n,j.limit),Y8(n,j),q8(j)}}(t,e),function(i){let n=i.bytes,r=i.limit;return n.length===r?n:n.subarray(0,r)}(e)}function j8(t){return function(i){let n={};t:for(;!XP(i);){let r=Vr(i);switch(r>>>3){case 0:break t;case 1:n.code=Vr(i);break;case 2:n.msg=JP(i,Vr(i));break;case 3:{let o=H8(i);n.data=G8(i),i.limit=o;break}default:qP(i,7&r)}}return n}({bytes:e=t,offset:0,limit:e.length});var e}function G8(t){let e={};t:for(;!XP(t);){let i=Vr(t);switch(i>>>3){case 0:break t;case 1:e.requestId=JP(t,Vr(t));break;case 2:e.requestType=Vr(t)>>>0;break;case 3:e.scorePorn=mS(t);break;case 4:e.scoreSexy=mS(t);break;case 5:e.scoreNeutral=mS(t);break;case 6:e.requestScene=Vr(t)>>>0;break;case 7:e.scene=Vr(t)>>>0;break;default:qP(t,7&i)}}return e}function W8(t,e){let i=t.service;i!==void 0&&(Kt(e,8),Kt(e,i));let n=t.vendor;n!==void 0&&(Kt(e,16),Kt(e,n));let r=t.token;r!==void 0&&(Kt(e,26),xr(e,r));let o=t.callbackUrl;o!==void 0&&(Kt(e,34),xr(e,o))}function H8(t){let e=Vr(t),i=t.limit;return t.limit=t.offset+e,i}function qP(t,e){switch(e){case 0:for(;128&QP(t););break;case 2:pS(t,Vr(t));break;case 5:pS(t,4);break;case 1:pS(t,8);break;default:throw new Error("Unimplemented type: "+e)}}let K8=new Float32Array(1);new Uint8Array(K8.buffer);let hS=new Float64Array(1),Ui=new Uint8Array(hS.buffer);function Ec(t){return{low:t|=0,high:t>>31,unsigned:t>=0}}let YP=[];function zP(){let t=YP.pop();return t?(t.offset=t.limit=0,t):{bytes:new Uint8Array(64),offset:0,limit:0}}function q8(t){YP.push(t)}function pS(t,e){if(t.offset+e>t.limit)throw new Error("Skip past limit");t.offset+=e}function XP(t){return t.offset>=t.limit}function fc(t,e){let i=t.bytes,n=t.offset,r=t.limit,o=n+e;if(o>i.length){let s=new Uint8Array(2*o);s.set(i),t.bytes=s}return t.offset=o,o>r&&(t.limit=o),n}function _S(t,e){let i=t.offset;if(i+e>t.limit)throw new Error("Read past limit");return t.offset+=e,i}function JP(t,e){let i=_S(t,e),n=String.fromCharCode,r=t.bytes,o="\uFFFD",s="";for(let a=0;a<e;a++){let c,d,l,u,h=r[a+i];(128&h)==0?s+=n(h):(224&h)==192?a+1>=e?s+=o:(c=r[a+i+1],(192&c)!=128?s+=o:(u=(31&h)<<6|63&c,u<128?s+=o:(s+=n(u),a++))):(240&h)==224?a+2>=e?s+=o:(c=r[a+i+1],d=r[a+i+2],(49344&(c|d<<8))!=32896?s+=o:(u=(15&h)<<12|(63&c)<<6|63&d,u<2048||u>=55296&&u<=57343?s+=o:(s+=n(u),a+=2))):(248&h)==240?a+3>=e?s+=o:(c=r[a+i+1],d=r[a+i+2],l=r[a+i+3],(12632256&(c|d<<8|l<<16))!=8421504?s+=o:(u=(7&h)<<18|(63&c)<<12|(63&d)<<6|63&l,u<65536||u>1114111?s+=o:(u-=65536,s+=n(55296+(u>>10),56320+(1023&u)),a+=3))):s+=o}return s}function xr(t,e){let i=e.length,n=0;for(let s=0;s<i;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<i&&(a=(a<<10)+e.charCodeAt(++s)-56613888),n+=a<128?1:a<2048?2:a<65536?3:4}Kt(t,n);let r=fc(t,n),o=t.bytes;for(let s=0;s<i;s++){let a=e.charCodeAt(s);a>=55296&&a<=56319&&s+1<i&&(a=(a<<10)+e.charCodeAt(++s)-56613888),a<128?o[r++]=a:(a<2048?o[r++]=a>>6&31|192:(a<65536?o[r++]=a>>12&15|224:(o[r++]=a>>18&7|240,o[r++]=a>>12&63|128),o[r++]=a>>6&63|128),o[r++]=63&a|128)}}function Y8(t,e){let i=fc(t,e.limit),n=t.bytes,r=e.bytes;for(let o=0,s=e.limit;o<s;o++)n[o+i]=r[o]}function QP(t){return t.bytes[_S(t,1)]}function ZP(t,e){let i=fc(t,1);t.bytes[i]=e}function mS(t){let e=_S(t,8),i=t.bytes;return Ui[0]=i[e++],Ui[1]=i[e++],Ui[2]=i[e++],Ui[3]=i[e++],Ui[4]=i[e++],Ui[5]=i[e++],Ui[6]=i[e++],Ui[7]=i[e++],hS[0]}function ES(t,e){let i=fc(t,8),n=t.bytes;hS[0]=e,n[i++]=Ui[0],n[i++]=Ui[1],n[i++]=Ui[2],n[i++]=Ui[3],n[i++]=Ui[4],n[i++]=Ui[5],n[i++]=Ui[6],n[i++]=Ui[7]}function Vr(t){let e,i=0,n=0;do e=QP(t),i<32&&(n|=(127&e)<<i),i+=7;while(128&e);return n}function Kt(t,e){for(e>>>=0;e>=128;)ZP(t,127&e|128),e>>>=7;ZP(t,e)}function Zo(t,e){let i=e.low>>>0,n=(e.low>>>28|e.high<<4)>>>0,r=e.high>>>24,o=r===0?n===0?i<16384?i<128?1:2:i<1<<21?3:4:n<16384?n<128?5:6:n<1<<21?7:8:r<128?9:10,s=fc(t,o),a=t.bytes;switch(o){case 10:a[s+9]=r>>>7&1;case 9:a[s+8]=o!==9?128|r:127&r;case 8:a[s+7]=o!==8?n>>>21|128:n>>>21&127;case 7:a[s+6]=o!==7?n>>>14|128:n>>>14&127;case 6:a[s+5]=o!==6?n>>>7|128:n>>>7&127;case 5:a[s+4]=o!==5?128|n:127&n;case 4:a[s+3]=o!==4?i>>>21|128:i>>>21&127;case 3:a[s+2]=o!==3?i>>>14|128:i>>>14&127;case 2:a[s+1]=o!==2?i>>>7|128:i>>>7&127;case 1:a[s]=o!==1?128|i:127&i}}function $P(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}let z8=new Map([["moderation",1],["supervise",2]]);class X8 extends ue{get connectionState(){return this._connectionState}set connectionState(e){if(this._connectionState===e)return;let i=this._connectionState;this._connectionState=e,this.emit(Ge.CONNECTION_STATE_CHANGE,i,e)}get inspectType(){return this._inspectType}set inspectType(e){var i;this._inspectMode=bn(i=e.map(n=>z8.get(n)||0)).call(i,(n,r)=>n+r),this._inspectType=e}get quality(){return this._quality}set quality(e){this._quality=e>1?1:e<.1?.1:e,this.qualityTimer&&(window.clearTimeout(this.qualityTimer),this.qualityTimer=null),this._quality>=1||(this.qualityTimer=window.setTimeout(()=>{this.quality=this._quality/this.qualityRatio},6e4))}constructor(e){super(),T(this,"name","AgoraRTCVideoContentInspect"),T(this,"_connectionState",xn.CONNECTING),T(this,"_innerConnectionState",void 0),T(this,"sequence",0),T(this,"inspectStartTime",void 0),T(this,"workerManagerConnection",void 0),T(this,"workerConnection",void 0),T(this,"workerMessageLengthLimit",void 0),T(this,"inspectIntervalMinimum",void 0),T(this,"qualityRatio",void 0),T(this,"_connectInfo",void 0),T(this,"_cancelTokenSource",bi.CancelToken.source()),T(this,"_retryConfig",void 0),T(this,"wmSequence",0),T(this,"inspectInterval",void 0),T(this,"inspectTimer",null),T(this,"ossFilePrefix",void 0),T(this,"extraInfo",void 0),T(this,"_inspectType",void 0),T(this,"_inspectMode",void 0),T(this,"_quality",1),T(this,"qualityTimer",null),T(this,"_inspectId",void 0),T(this,"_needWorkUrlOnly",!1),T(this,"inspectImage",()=>{if(this.connectionState!==xn.CONNECTED)throw new x(C.OPERATION_ABORTED,"content inspect service connection status is ".concat(this.connectionState));this.inspectTimer&&(window.clearInterval(this.inspectTimer),this.inspectTimer=null),this.inspectTimer=window.setInterval(()=>{this.connectionState===xn.CONNECTED?this.requestToInspectImage():_.debug("[".concat(this._inspectId,"] Inspect State is not connected , "),this.connectionState)},this.inspectInterval<this.inspectIntervalMinimum?this.inspectIntervalMinimum:this.inspectInterval),this.requestToInspectImage()}),this._inspectId=te(5,"inspect-"),this.workerMessageLengthLimit=A("VIDEO_INSPECT_WORKER_MESSAGE_LENGTH_LIMIT"),this.inspectIntervalMinimum=A("VIDEO_INSPECT_INTERVAL_MINIMUM"),this.qualityRatio=A("VIDEO_INSPECT_QUALITY_RATIO"),this.inspectInterval=e.interval,this.ossFilePrefix=e.ossFilePrefix,this.extraInfo=e.extraInfo,this.inspectType=e.inspectType,this.inspectStartTime=Number(Date.now()),this.workerManagerConnection=new Nd("worker-manager-"+this._inspectId,Oe),this.on(Ge.STATE_CHANGE,(i,n)=>{this._innerConnectionState=i,_.debug("[".concat(this._inspectId,"] Inspect operation :").concat(Vn[i]," ").concat(n||""))}),this.handleWorkerManagerEvents(),this.workerConnection=new Nd("worker-"+this._inspectId,Oe),this.handleWorkerEvents()}init(e,i){return I(this,null,function*(){this.emit(Ge.STATE_CHANGE,Vn.CONNECT_AP),this._connectInfo=e;let n=this._cancelTokenSource.token;return this._retryConfig=i,new Q((r,o)=>{this.on(Ge.CONNECTION_STATE_CHANGE,(s,a)=>{a===xn.CONNECTED&&r()}),this.requestAP(e,n,i).then(s=>{this.connectWorkerManager(s)}).catch(s=>{o(s)})})})}requestAP(e,i,n){return I(this,null,function*(){let r=A("WEBCS_DOMAIN").map(a=>"https://".concat(a,"/api/v1")),o=yield function(a,c,d,l){let{appId:u,areaCode:h,cname:p,sid:g,token:E,uid:f}=c;rc++;let R="image_moderation_api",y={service_name:R,json_body:JSON.stringify({appId:u,areaCode:h,cname:p,command:"allocateEdge",requestId:rc,seq:rc,sid:g,token:E,ts:Date.now(),uid:f+""})},N,k,L=a[0];return er(()=>I(null,null,function*(){N=Date.now();let P=yield sr(L,{data:y,cancelToken:d,headers:{"X-Packet-Service-Type":"0","X-Packet-URI":"61"},params:{action:"wrtc_gateway"}});if(k=Date.now()-N,P.code!==0){let J=new x(C.UNEXPECTED_RESPONSE,"image inspect ap error, code"+P.code,{retry:!0,responseTime:k});throw _.error(J.toString()),J}let V=JSON.parse(P.json_body);if(V.code!==200){let J=new x(C.UNEXPECTED_RESPONSE,"image inspect ap error, code: ".concat(V.code,", reason: ").concat(V.reason),{code:V.code,responseTime:k});throw _.error(J.toString()),J}if(!V.servers||!Array.isArray(V.servers)||V.servers.length===0){let J=new x(C.UNEXPECTED_RESPONSE,"image inspect ap empty server",{code:V.code,responseTime:k});throw _.error(J.toString()),J}let B=A("VIDEO_INSPECT_WORKER_MANAGER_HOST"),Y=A("VIDEO_INSPECT_WORKER_MANAGER_PORT");return{addressList:V.servers.map(J=>{let{address:yt,wss:Rt}=J;if(yt&&Rt)return"wss://".concat(yt.replace(/\./g,"-"),".").concat(B,":").concat(Y||Rt)}).filter(J=>!!J),workerToken:V.workerToken,vid:V.vid,responseTime:k}}),(P,V)=>(ot.apworkerEvent(g,{success:!0,sc:200,serviceName:R,responseDetail:JSON.stringify(P.addressList),firstSuccess:V===0,responseTime:k,serverIp:a[V%a.length]}),!1),(P,V)=>(ot.apworkerEvent(g,{success:!1,sc:P.data&&P.data.code||200,serviceName:R,responseTime:k,serverIp:a[V%a.length]}),!!(P.code!==C.OPERATION_ABORTED&&P.code!==C.UNEXPECTED_RESPONSE||P.data&&P.data.retry)&&(L=a[(V+1)%a.length],!0)),l)}(r,e,i,n);this.emit(Ge.STATE_CHANGE,Vn.AP_CONNECTED);let{addressList:s}=o;return this.wmSequence++,s})}connectWorkerManager(i){return I(this,arguments,function*(e){let n=arguments.length>1&&arguments[1]!==void 0&&arguments[1];this._needWorkUrlOnly=n,this.emit(Ge.STATE_CHANGE,Vn.CONNECT_WORKER_MANAGER),yield this.workerManagerConnection.init(e,1e4)})}connectWorker(e){return I(this,null,function*(){yield this.workerConnection.init([e])})}handleWorkerManagerEvents(){this.workerManagerConnection.on(Tt.CONNECTED,()=>I(this,null,function*(){this.emit(Ge.STATE_CHANGE,Vn.WORKER_MANAGER_CONNECTED,this.workerManagerConnection.url),this.workerManagerConnection.sendMessage({appId:this._connectInfo.appId,cname:this._connectInfo.cname,uid:this._connectInfo.uid+"",sdkVersion:"4.23.4",sid:this._connectInfo.sid,seq:this.wmSequence,ts:Number(Date.now()),requestId:Math.floor(1e12*Math.random()),allocate:!0,clientRequest:{command:"join"}},!0)})),this.workerManagerConnection.on(Tt.CLOSED,()=>{this._innerConnectionState<Vn.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is closed before connecting worker"))}),this.workerManagerConnection.on(Tt.FAILED,()=>{this._innerConnectionState<Vn.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Connecting inspect worker manager is failed before connecting worker"))}),this.workerManagerConnection.on(Tt.RECONNECTING,()=>{this._innerConnectionState<Vn.GET_WORKER_MANAGER_RESPONSE&&_.debug("[".concat(this._inspectId,"] Inspect worker manager is reconnecting before connecting worker"))}),this.workerManagerConnection.on(Tt.ON_MESSAGE,e=>I(this,null,function*(){this.emit(Ge.STATE_CHANGE,Vn.GET_WORKER_MANAGER_RESPONSE);let i=this.workerManagerConnection.url;this.workerManagerConnection.close();let n=JSON.parse(e.data);if(n.code!==200)throw _.error("[".concat(this._inspectId,"] Unexpected code ").concat(n.code," from worker manager")),new x(C.UNEXPECTED_RESPONSE,"response code of worker is unexpected",n);if(!(n.serverResponse&&n.serverResponse.portWss&&i))throw _.error("[".concat(this._inspectId,"] Unexpected content from worker manager : ").concat(JSON.stringify(n))),new x(C.UNEXPECTED_RESPONSE,"response content of worker is unexpected",n);{let r=A("VIDEO_INSPECT_WORKER_PORT")||n.serverResponse.portWss,o=i.replace(/:\d+\/?$/,":".concat(r));this.emit(Ge.STATE_CHANGE,Vn.CONNECT_WORKER,o),this._needWorkUrlOnly?this.emit(Ge.REQUEST_NEW_WORKER_URL,o):yield this.connectWorker(o)}})),this.workerManagerConnection.on(Tt.WILL_RECONNECT,(e,i,n)=>{n(e)}),this.workerManagerConnection.on(Tt.REQUEST_NEW_URLS,(e,i)=>{this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(e).catch(i)})}handleWorkerEvents(){this.workerConnection.on(Tt.CONNECTED,()=>I(this,null,function*(){this.emit(Ge.STATE_CHANGE,Vn.WORKER_CONNECTED,this.workerConnection.url),this.connectionState=xn.CONNECTED})),this.workerConnection.on(Tt.ON_MESSAGE,e=>I(this,null,function*(){if(e.data instanceof ArrayBuffer){let n=j8(new Uint8Array(e.data));if(A("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")&&_.debug("[".concat(this._inspectId,"] Response message for worker of inspect content "),JSON.stringify(n)),n.code===200){if(Array.isArray(this.inspectType)&&this.inspectType.length===1&&this.inspectType[0]==="supervise")return void this.emit(Ge.INSPECT_RESULT,void 0,void 0);if(n.data&&n.data.scorePorn&&n.data.scoreSexy&&n.data.scoreNeutral){var i;let r={porn:n.data.scorePorn,sexy:n.data.scoreSexy,neutral:n.data.scoreNeutral},o=bn(i=Object.keys(r)).call(i,(a,c)=>r[a]>r[c]?a:c,"porn"),s=Object.keys(r).find(a=>a===o);this.emit(Ge.INSPECT_RESULT,s)}else this.emit(Ge.INSPECT_RESULT,void 0,new x(C.UNEXPECTED_RESPONSE,n.code+"","There is an unexpected data on message"))}else this.emit(Ge.INSPECT_RESULT,void 0,new x(C.UNEXPECTED_RESPONSE,n.code+"",n.msg))}else _.error("[".concat(this._inspectId,"] Unexpected message type from worker")),this.emit(Ge.INSPECT_RESULT,void 0,new x(C.UNEXPECTED_RESPONSE,"invalid worker message type"))})),this.workerConnection.on(Tt.CLOSED,()=>{this.connectionState=xn.CLOSED}),this.workerConnection.on(Tt.FAILED,()=>{this.connectionState=xn.CLOSED}),this.workerConnection.on(Tt.RECONNECTING,()=>{this.connectionState=this.connectionState===xn.CONNECTED?xn.RECONNECTING:xn.CONNECTING}),this.workerConnection.on(Tt.WILL_RECONNECT,(e,i,n)=>{e==="recover"&&n(e),n("tryNext")}),this.workerConnection.on(Tt.REQUEST_NEW_URLS,(e,i)=>{this.workerManagerConnection.close(),this.once(Ge.REQUEST_NEW_WORKER_URL,n=>{e([n])}),this.requestAP(this._connectInfo,this._cancelTokenSource.token,this._retryConfig).then(n=>{this.connectWorkerManager(n,!0)}).catch(n=>{i(n)})})}requestToInspectImage(){return I(this,null,function*(){this.sequence++;let e=Ji(this,Ge.CLIENT_LOCAL_VIDEO_TRACK),i={appId:this._connectInfo.appId,cname:this._connectInfo.cname,cid:this._connectInfo.cid,sid:this._connectInfo.sid,uid:this._connectInfo.uid,vid:this._connectInfo.vid};if(e){if(!e.isPlaying)return void this.emit(Ge.INSPECT_RESULT,void 0,new x(C.INVALID_OPERATION,"Only the track being played can be inspected"));let n=yield this.generateRequestData(e,i);this.workerConnection.sendMessage(n,!0,!0)}else this.emit(Ge.INSPECT_RESULT,void 0,new x(C.INVALID_OPERATION,"Only the track being published can be inspected"))})}generateRequestData(e,i){return I(this,null,function*(){let{appId:n,cname:r,cid:o,vid:s,sid:a,uid:c}=i,d=Date.now(),l=yield e.getCurrentFrameImage("image/jpeg",this.quality),u=yield kw(l,n,r),h=this.sequence+"-"+o+"-"+c+"-"+d+"-"+te(12,""),p={appId:n,cid:o,cname:r,deviceId:"",elapse:(g=Number(d-this.inspectStartTime),{low:g|=0,high:g>>31,unsigned:g>=0}),fileSize:u.byteLength,jpgEncryption:2,height:l.height,width:l.width,jpg:u,networkType:6,osType:7,requestId:h,sdkVersion:"4.23.4",sequence:this.sequence,sid:a,timestamp:aD(d),uid:c,vid:s,service:this._inspectMode,callbackData:this.extraInfo,ossFilePrefix:this.ossFilePrefix};var g;this.extraInfo===void 0&&delete p.callbackData,this.ossFilePrefix===void 0&&delete p.ossFilePrefix;let E=B8(p);if(E.byteLength<this.workerMessageLengthLimit){if(A("SHOW_VIDEO_INSPECT_WORKER_MESSAGE")){let f=function(R){for(var y=1;y<arguments.length;y++){var N=arguments[y]!=null?arguments[y]:{};y%2?$P(Object(N),!0).forEach(function(k){T(R,k,N[k])}):Object.getOwnPropertyDescriptors?Object.defineProperties(R,Object.getOwnPropertyDescriptors(N)):$P(Object(N)).forEach(function(k){Object.defineProperty(R,k,Object.getOwnPropertyDescriptor(N,k))})}return R}({},p);delete f.jpg,_.debug("[".concat(this._inspectId,"] Request message for worker of inspect content "),JSON.stringify(f))}return E}{let f=this.quality*this.qualityRatio;return this.quality=f,yield this.generateRequestData(e,{appId:n,cname:r,cid:o,vid:s,sid:a,uid:c})}})}close(){this._cancelTokenSource.cancel(),this._cancelTokenSource=bi.CancelToken.source(),this.workerManagerConnection&&this.workerManagerConnection.close(),this.workerConnection&&this.workerConnection.close(),this.inspectTimer&&window.clearInterval(this.inspectTimer),this.inspectTimer=null,this.connectionState=xn.CLOSED,this.emit(Ge.STATE_CHANGE,Vn.CLOSED)}}let J8={name:"ContentInspect",create:function(t){let{config:e}=t;return function(i){if(!i)throw new x(C.INVALID_PARAMS,"inspectConfig is necessary.");if(!i.inspectType||!Array.isArray(i.inspectType))throw new x(C.INVALID_PARAMS,"inspectConfig.inspectType is necessary and is an instance of Array.");{let n=[...new Set(i.inspectType)];n.forEach(r=>{var o;if(!z(o=["supervise","moderation"]).call(o,r))throw new x(C.INVALID_PARAMS,"".concat(r," is not a valid inspect type."))}),i.inspectType=n}if(i&&i.extraInfo&&i.extraInfo.length>1024)throw new x(C.INVALID_PARAMS,"inspectConfig.extraInfo length cannot exceed 1024 bytes")}(e),new X8(e)}};var tL=b(dn.Object.getOwnPropertySymbols),Q8=Ht,Z8=I_.indexOf,$8=jl,fS=Lc([].indexOf),eL=!!fS&&1/fS([1],1,-0)<0;Q8({target:"Array",proto:!0,forced:eL||!$8("indexOf")},{indexOf:function(t){var e=arguments.length>1?arguments[1]:void 0;return eL?fS(this,t,e)||0:Z8(this,t,e)}});var tY=Cn("Array","indexOf"),eY=Wt,iY=tY,gS=Array.prototype,nY=function(t){var e=t.indexOf;return t===gS||eY(gS,t)&&e===gS.indexOf?iY:e},iL=b(nY);function rY(t,e){if(t==null)return{};var i,n,r=function(s,a){if(s==null)return{};var c={};for(var d in s)if({}.hasOwnProperty.call(s,d)){if(iL(a).call(a,d)!==-1)continue;c[d]=s[d]}return c}(t,e);if(tL){var o=tL(t);for(n=0;n<o.length;n++)i=o[n],iL(e).call(e,i)===-1&&{}.propertyIsEnumerable.call(t,i)&&(r[i]=t[i])}return r}let nL=class{get localCapabilities(){return he(this._localCapabilities)}get rtpCapabilities(){return he(this._rtpCapabilities)}get candidates(){return he(this._candidates)}get iceParameters(){return he(this._iceParameters)}get dtlsParameters(){return he(this._dtlsParameters)}constructor(t){T(this,"sessionDesc",void 0),T(this,"_localCapabilities",void 0),T(this,"_rtpCapabilities",void 0),T(this,"_candidates",void 0),T(this,"_iceParameters",void 0),T(this,"_dtlsParameters",void 0),T(this,"setup",void 0),T(this,"currentMidIndex",void 0),T(this,"cname","o/i14u9pJrxRKAsu"),T(this,"firefoxSsrcMidMap",new Map),t=he(t);let{remoteIceParameters:e,remoteDtlsParameters:i,candidates:n,remoteRTPCapabilities:r,localCapabilities:o,direction:s,setup:a,videoCodec:c,audioCodec:d}=t,l;this.setup=a,l=s===Ti.RECEIVE_ONLY?Li(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`):Li(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE 0 1
a=msid-semantic: WMS
a=extmap-allow-mixed
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:0
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=recvonly
a=rtcp-mux
a=rtcp-rsize
a=mid:1
`),this._rtpCapabilities=r,this._candidates=n,this._iceParameters=e,this._dtlsParameters=i,this._localCapabilities=o;let u=s===Ti.RECEIVE_ONLY?this.rtpCapabilities.send:this.rtpCapabilities.recv,h=s===Ti.RECEIVE_ONLY?this._localCapabilities.recv:this._localCapabilities.send,p=s===Ti.RECEIVE_ONLY?r.send.videoCodecs:Ld($.VIDEO,u,h,c),g=s===Ti.RECEIVE_ONLY?r.send.audioCodecs:Ld($.AUDIO,u,h,d);for(let E of l.mediaDescriptions)E.attributes.iceUfrag=e.iceUfrag,E.attributes.icePwd=e.icePwd,E.attributes.fingerprints=i.fingerprints,E.attributes.candidates=n,E.attributes.setup=this.setup,E.media.mediaType==="application"&&(E.attributes.sctpPort="5000"),E.media.mediaType==="video"&&(E.media.fmts=p.map(f=>f.payloadType.toString(10)),E.attributes.payloads=p,E.attributes.extmaps=u.videoExtensions),E.media.mediaType==="audio"&&(E.media.fmts=g.map(f=>f.payloadType.toString(10)),E.attributes.payloads=g,E.attributes.extmaps=u.audioExtensions,nc(E));this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return xo(this.sessionDesc)}hasMid(t){return Array.isArray(t)?t.every(e=>this.hasMid(e)):this.sessionDesc.mediaDescriptions.some(e=>e.attributes.mid===t)}send(t,e,i,n,r){i=i.replace(/ /g,"-");let{ssrcs:o,ssrcGroups:s}=Ns(e,this.cname,A("SYNC_GROUP")?i:void 0),a=this.findPreloadMediaDesc(o);if(a){if(_e()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,a.attributes.mid),r&&(r.twcc||r.remb)){let c=this.sessionDesc.mediaDescriptions.indexOf(a);return this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(a,r),{mid:a.attributes.mid,needExchangeSDP:!0}}return{mid:a.attributes.mid,needExchangeSDP:!1}}{let c=this.findAvailableMediaIndex(t,o,n),d;return c===-1?(d=this.createOrRecycleSendMedia(t,o,s,"sendonly",n,r),this.updateBundleMids()):(d=he(this.sessionDesc.mediaDescriptions[c]),d.attributes.direction="sendonly",d.attributes.ssrcs=o,d.attributes.ssrcGroups=s,this.sessionDesc.mediaDescriptions[c]=this.mungSendMediaDesc(d,r)),_e()&&this.firefoxSsrcMidMap.set(o[0].ssrcId,d.attributes.mid),{needExchangeSDP:!0,mid:d.attributes.mid}}}stopSending(t){let e=this.sessionDesc.mediaDescriptions.filter(i=>i.attributes.mid&&t.indexOf(i.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.stopSending.");e.forEach(i=>{i.attributes.ssrcs=[]}),this.updateBundleMids()}receive(t,e,i){let n=[];return t.forEach(r=>{let o=r._mediaStreamTrack.kind,s=this.findAvailableRecvMediaIndex(o),a,c=!1;s===-1?(c=!0,a=this.createOrRecycleRecvMedia(r,[],"recvonly",e,i),this.updateBundleMids()):(a=he(this.sessionDesc.mediaDescriptions[s]),a.attributes.direction="recvonly"),n.push({mid:a.attributes.mid,needCreateTransceiver:c})}),n}stopReceiving(t){let e=this.sessionDesc.mediaDescriptions.filter(i=>t.indexOf(i.attributes.mid)!==-1);if(e.length!==t.length)throw new Error("MediaDescriptions' length doesn't match mids's length when calling RemoteSDP.receive.");e.forEach(i=>{i.media.port="0",i.attributes.direction="inactive"}),this.updateBundleMids()}addRemoteCandidate(t){let{foundation:e,protocol:i,address:n,port:r,type:o,relatedAddress:s,relatedPort:a,priority:c}=new RTCIceCandidate(t),d={foundation:e??"",componentId:"1",transport:i??"",priority:c?c+"":"",connectionAddress:n??"",port:r?r+"":"",type:o?o+"":"",relAddr:s??"",relPort:a?a+"":"",extension:{}};this.candidates.some(l=>l.priority===d.priority&&l.connectionAddress===d.connectionAddress&&l.port===d.port)||(this._candidates.push(d),this.sessionDesc.mediaDescriptions.forEach(l=>{l.attributes.candidates=this.candidates}))}clearRemoteCandidate(){this._candidates=[],this.sessionDesc.mediaDescriptions[0].attributes.candidates=this._candidates}createOrRecycleRecvMedia(t,e,i,n,r){let o=t._mediaStreamTrack.kind,s=this.rtpCapabilities.recv,a=Ld(o,s,this.localCapabilities.send,o===$.AUDIO?r:n),c=o===$.VIDEO?s.videoExtensions:s.audioExtensions,d="".concat(++this.currentMidIndex),l={media:{mediaType:o,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(h=>h.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:[],rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:i,rtcpMux:!0,rtcpRsize:!0,mid:"".concat(d)}};l=this.mungRecvMediaDsec(l,t);let u=this.findFirstClosedMedia(o);if(u){let h=this.sessionDesc.mediaDescriptions.indexOf(u);this.sessionDesc.mediaDescriptions[h]=l}else this.sessionDesc.mediaDescriptions.push(l);return l}muteRemote(t){let e=this.sessionDesc.mediaDescriptions.filter(i=>z(t).call(t,i.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(i=>{i.attributes.direction="inactive"})}unmuteRemote(t){let e=this.sessionDesc.mediaDescriptions.filter(i=>z(t).call(t,i.attributes.mid||""));if(e.length!==t.length)throw new Error("mediaDescriptions' length doesn't match mids' length when calling RemoteSDP.muteRemote.");e.forEach(i=>{i.attributes.direction="recvonly"})}findAvailableMediaIndex(t,e,i){return this.sessionDesc.mediaDescriptions.findIndex(n=>{let r=n.media.mediaType===t&&n.media.port!=="0"&&(n.attributes.direction==="sendonly"||n.attributes.direction==="sendrecv")&&n.attributes.ssrcs.length===0;if(_e()){if(r){let o=this.firefoxSsrcMidMap.get(e[0].ssrcId);return!(o||n.attributes.mid!=="0"&&n.attributes.mid!=="1")||!(!o||o!==n.attributes.mid)}return!1}return r&&n.attributes.mid===i})}findAvailableRecvMediaIndex(t){return this.sessionDesc.mediaDescriptions.findIndex(e=>{let i=e.media.mediaType===t&&e.media.port!=="0"&&(e.attributes.direction==="recvonly"||e.attributes.direction==="sendrecv");return e.attributes.mid!=="0"&&e.attributes.mid!=="1"&&i})}predictReceivingMids(t){let e=[];for(let i=0;i<t;i++)e.push((this.currentMidIndex+i+1).toString(10));return e}restartICE(t){t=he(t),this._iceParameters=t,this.sessionDesc.mediaDescriptions.forEach(e=>{e.attributes.iceUfrag=t.iceUfrag,e.attributes.icePwd=t.icePwd})}createOrRecycleSendMedia(t,e,i,n,r,o){let s=this.rtpCapabilities.send,a=t===$.VIDEO?s.videoCodecs:s.audioCodecs,c=t===$.VIDEO?s.videoExtensions:s.audioExtensions;_e()&&(r="".concat(++this.currentMidIndex));let d={media:{mediaType:t,port:"9",protos:["UDP","TLS","RTP","SAVPF"],fmts:a.map(u=>u.payloadType.toString(10))},connections:[{nettype:"IN",addrtype:"IP4",address:"127.0.0.1"}],bandwidths:[],attributes:{iceUfrag:this.iceParameters.iceUfrag,icePwd:this.iceParameters.icePwd,unrecognized:[],candidates:[],extmaps:c,fingerprints:this.dtlsParameters.fingerprints,imageattr:[],msids:[],remoteCandidatesList:[],rids:[],ssrcs:e,ssrcGroups:i,rtcpFeedbackWildcards:[],payloads:a,rtcp:{port:"9",netType:"IN",addressType:"IP4",address:"0.0.0.0"},setup:this.setup,direction:n,rtcpMux:!0,rtcpRsize:!0,mid:r}};d=this.mungSendMediaDesc(d,o);let l=this.findFirstClosedMedia(t);if(l){let u=this.sessionDesc.mediaDescriptions.indexOf(l);this.sessionDesc.mediaDescriptions[u]=d}else this.sessionDesc.mediaDescriptions.push(d);return d}mungRecvMediaDsec(t,e,i){let n=he(t);return Eg(n),ic(n,e),fg(n,e),YO(n),zh(n,i,this.localCapabilities.send),n}mungSendMediaDesc(t,e){let i=he(t);return zh(i,e,this.localCapabilities.recv),nc(i),i}updateRecvMedia(t,e){let i=this.sessionDesc.mediaDescriptions.findIndex(n=>n.attributes.mid===t);if(i!==-1){let n=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[i],e);this.sessionDesc.mediaDescriptions[i]=n}}updateBundleMids(){this.sessionDesc.attributes.groups[0].identificationTag=this.sessionDesc.mediaDescriptions.filter(t=>t.media.port!=="0").map(t=>t.attributes.mid)}findPreloadMediaDesc(t){return this.sessionDesc.mediaDescriptions.find(e=>{var i;return((i=e.attributes)===null||i===void 0||(i=i.ssrcs[0])===null||i===void 0?void 0:i.ssrcId)===t[0].ssrcId})}findFirstClosedMedia(t){return this.sessionDesc.mediaDescriptions.find(e=>_e()?e.media.port==="0"&&e.media.mediaType===t:e.media.port==="0")}},oY=["sdp"];var oe;function rL(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function $o(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?rL(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):rL(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let oL=(oe=class Nc extends OO{get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get dtlsTransportState(){var e,i;return(e=(i=this.peerConnection.getReceivers()[0])===null||i===void 0||(i=i.transport)===null||i===void 0?void 0:i.state)!==null&&e!==void 0?e:null}get localCodecs(){return[]}set isInRestartIce(e){this._isInRestartIce=e}get isInRestartIce(){return this._isInRestartIce}constructor(e,i,n){super(e,i),T(this,"direction",void 0),T(this,"name",void 0),T(this,"store",void 0),T(this,"spec",void 0),T(this,"peerConnection",void 0),T(this,"initialOffer",void 0),T(this,"transport",void 0),T(this,"statsFilter",void 0),T(this,"localCandidateCount",0),T(this,"_isInRestartIce",!1),T(this,"mutex",void 0),T(this,"onLocalCandidate",void 0),T(this,"remoteSDP",void 0),T(this,"pendingCandidates",[]),T(this,"localCapabilities",void 0),T(this,"isReady",!1),T(this,"restartCnt",0),T(this,"curTurnServerIndex",0),this.store=i,this.spec=e,this.mutex=new ni("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection(Nc.resolvePCConfiguration(e,i.p2pTransport),{optional:[{googDscp:!0}]}),this.direction=n??Ti.SEND_ONLY,this.name=this.direction===Ti.SEND_ONLY?"sendP2PConnection":"recvP2PConnection",this.statsFilter=Of(this.peerConnection,A("STATS_UPDATE_INTERVAL"),void 0,_e()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1}establish(e){return I(this,null,function*(){try{let i=yield XO();if(this.localCapabilities=Xh(i),e){let{sdp:n}=e,r=rY(e,oY),o=function(){let l={audioCodecs:[],videoCodecs:[],audioExtensions:[],videoExtensions:[]},u=Pd(arguments.length>2?arguments[2]:void 0,arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},"sendonly"),h={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},p={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},g={audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]};if(Fn(u,l,"videoExtensions",h,p,g),Fn(u,l,"videoCodecs",h,p,g),Fn(u,l,"audioExtensions",h,p,g),Fn(u,l,"audioCodecs",h,p,g),A("RAISE_H264_BASELINE_PRIORITY")){let E=g.videoCodecs.findIndex(f=>f.rtpMap&&f.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&f.fmtp&&f.fmtp.parameters["profile-level-id"]==="42001f");if(E!==-1){let f=g.videoCodecs.findIndex(R=>R.rtpMap&&R.rtpMap.encodingName.toLocaleLowerCase()==="h264");if(f<E){_.debug("raising H264 baseline profile priority");let R=g.videoCodecs[E];g.videoCodecs.splice(E,1),g.videoCodecs.splice(f,0,R)}f!==-1&&A("FILTER_SEND_H264_BASELINE")&&(h.videoCodecs=h.videoCodecs.filter(R=>!(R.rtpMap&&R.rtpMap.encodingName.toLocaleLowerCase()==="h264"&&R.fmtp&&R.fmtp.parameters["profile-level-id"]!=="42001f")))}}return{send:h,recv:p,sendrecv:g}}({},{},n);this.remoteSDP=new nL({remoteIceParameters:r.iceParameters,remoteDtlsParameters:r.dtlsParameters,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"actpass",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),yield this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()}),this.isReady=!0;let s=yield this.peerConnection.createAnswer();if(!s.sdp)throw new Error("Cannot get answer sdp when trying to establish PeerConnection.");let a=Go(s.sdp);yield this.peerConnection.setLocalDescription(s);let c=yield JO({},{},s.sdp);this.localCapabilities=Xh(c);let d=this.peerConnection.getTransceivers()[0];return d!=null&&d.receiver&&d.receiver.transport&&this.tryBindTransportEvents(d.receiver.transport),$o($o({},a),{},{sdp:s.sdp})}{this.peerConnection.addTransceiver("video",{direction:"sendonly"}),this.peerConnection.addTransceiver("audio",{direction:"sendonly"});let n=yield this.peerConnection.createOffer();if(!n.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let r=Go(n.sdp);return this.initialOffer=n,$o($o({},r),{},{sdp:n.sdp})}}catch(i){throw new F(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,i.toString())}})}connect(e){return I(this,null,function*(){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");yield this.peerConnection.setLocalDescription(this.initialOffer);let{sdp:i,iceParameters:n,dtlsParameters:r}=e,o=yield JO({},{},i);this.remoteSDP=new nL({remoteIceParameters:n,remoteDtlsParameters:r,candidates:[],remoteRTPCapabilities:o,localCapabilities:this.localCapabilities,direction:this.direction,setup:"active",videoCodec:this.store.codec,audioCodec:this.store.audioCodec}),yield this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()});let s=this.peerConnection.getTransceivers()[0];s!=null&&s.sender&&s.sender.transport&&this.tryBindTransportEvents(s.sender.transport)}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}})}addRemoteCandidate(e){return I(this,null,function*(){try{e&&this.pendingCandidates.push(e),this.peerConnection.remoteDescription&&this.isReady&&(this.pendingCandidates.forEach(i=>{this.peerConnection.addIceCandidate(i)}),this.pendingCandidates=[])}catch(i){throw new F(C.ADD_CANDIDATE_FAILED,"P2PConnection.addRemoteCandidate failed; ".concat(i.toString()))}})}send(e,i,n){var r=this;return un(function*(){let o=yield Lt(r.mutex.lock("From P2PConnection.send"));try{if(!r.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let s=[],a=r.remoteSDP.receive(e,i,n);e.forEach((f,R)=>{if(a[R].needCreateTransceiver){let y=r.peerConnection.addTransceiver(f._mediaStreamTrack,{direction:"sendonly"});s.push(y),f._updateRtpTransceiver(y)}else{let y=r.peerConnection.getTransceivers().find(N=>N.mid===a[R].mid);if(!y)throw new Error("cannot find transceiver when sendPeerconnection send, mid is ".concat(a[R].mid));s.push(y),f._updateRtpTransceiver(y)}}),_e()&&A("SIMULCAST")===!0&&(yield Lt(r.applySimulcastForFirefox(s,e)));let c=a.map(f=>f.mid),d=yield Lt(r.peerConnection.createOffer()),l=r.mungSendOfferSDP(d.sdp,e,c),u=Li(l),h=c.map(f=>{let R=u.mediaDescriptions.find(y=>y.attributes.mid===f);if(!R)throw new Error("Cannot extract ssrc from mediaDescription.");return HO(R,A("USE_PUB_RTX"))}),p=s.map((f,R)=>{let y=c[R];return{localSSRC:h[R],id:y}});yield Lt(r.peerConnection.setLocalDescription({type:"offer",sdp:l}));try{yield p}catch(f){let R=r.remoteSDP.toString();throw yield Lt(r.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Lt(r.peerConnection.setRemoteDescription({type:"answer",sdp:R})),yield Lt(r.stopSending(c,!0)),f}yield Lt(r.applySimulcastEncodings(s,e)),yield Lt(r.applySendEncodings(s,e));let g=r.remoteSDP.toString(),E=r.logSDPExchange(l,"offer","local","send");return E?.(g),yield Lt(r.setRemoteDescription({type:"answer",sdp:g})),s.map((f,R)=>{let y=c[R];return{localSSRC:h[R],id:y}})}catch(s){throw s instanceof F?s:new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(s.toString()))}finally{o()}})()}stopSending(e,i){return I(this,null,function*(){let n=i?void 0:yield this.mutex.lock("From P2PConnection.stopSending");try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let r=this.peerConnection.getTransceivers().filter(c=>e.indexOf(c.mid)!==-1);if(r.length!==e.length)throw new Error("Transceivers' length (".concat(r.length,") doesn't match mids' length (").concat(e.length,") when trying to call P2PConnection.stopSending."));r.map(c=>{var d;c.direction="inactive",(d=c.stop)===null||d===void 0||d.call(c)});let o=yield this.peerConnection.createOffer(),s=this.logSDPExchange(o.sdp||"","offer","local","stopSending");yield this.peerConnection.setLocalDescription(o),this.remoteSDP.stopReceiving(e);let a=this.remoteSDP.toString();s?.(a),yield this.setRemoteDescription({type:"answer",sdp:a})}catch(r){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(r.toString()))}finally{n&&n()}})}receive(e,i,n,r){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,i,n,r);if(s){let c=this.remoteSDP.toString(),d=this.logSDPExchange(c,"offer","remote","receive");yield this.setRemoteDescription({type:"offer",sdp:c});let l=yield this.peerConnection.createAnswer(),u=this.mungReceiveAnswerSDP(l.sdp,o,e);d?.(u||""),yield this.peerConnection.setLocalDescription({type:"answer",sdp:u}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."));let a=this.peerConnection.getTransceivers().find(c=>c.mid===o);if(!a||a.mid===null)throw new Error("Cannot get transceiver after setLocalDescription.");return{track:a.receiver.track,mid:a.mid,transceiver:a}}catch(o){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}})}mockReceive(e,i,n,r){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{mid:o,needExchangeSDP:s}=this.remoteSDP.send(e,i,n,r);if(s){let a=this.remoteSDP.toString(),c=this.logSDPExchange(a,"offer","remote","receive");yield this.setRemoteDescription({type:"offer",sdp:a});let d=yield this.peerConnection.createAnswer(),l=this.mungReceiveAnswerSDP(d.sdp,o,e);c?.(l||""),yield this.peerConnection.setLocalDescription({type:"answer",sdp:l}),_.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," by exchanging SDP."))}else _.debug("[".concat(this.store.clientId,"] [P2PConnection] receive ").concat(e," no need to exchange SDP."))}catch(o){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}})}stopReceiving(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let i=this.remoteSDP.toString(),n=this.logSDPExchange(i,"offer","remote","stopReceiving");yield this.setRemoteDescription({type:"offer",sdp:i});let r=yield this.peerConnection.createAnswer();n?.(r.sdp||""),yield this.peerConnection.setLocalDescription(r)}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}})}restartICE(e){return I(this,null,function*(){try{if(this.store.p2pTransport===vs.Auto&&(this.store.p2pTransport=vs.SdRtn,Mt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Nc.resolvePCConfiguration(this.spec,this.store.p2pTransport))),this.restartCnt>3&&(this.restartCnt=0,Mt().supportPCSetConfiguration&&this.peerConnection.setConfiguration(Nc.resolvePCConfiguration(this.spec,this.store.p2pTransport,++this.curTurnServerIndex))),!e){this.restartCnt++,this.isReady=!1;let i=yield this.peerConnection.createOffer({iceRestart:!0});if(!i.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let{iceParameters:n}=Go(i.sdp);return this.store.descriptionStart(),this.direction===Ti.SEND_ONLY&&(yield this.peerConnection.setLocalDescription(i)),n}if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");if(this.remoteSDP.restartICE(e),this.store.descriptionStart(),this.direction===Ti.RECEIVE_ONLY){this.restartCnt++,yield this.setRemoteDescription({type:"offer",sdp:this.remoteSDP.toString()});let i=yield this.peerConnection.createAnswer();if(!i.sdp)throw new Error("Cannot get answer sdp when trying to iceRestart.");let{iceParameters:n}=Go(i.sdp);return yield this.peerConnection.setLocalDescription(i),n}yield this.setRemoteDescription({type:"answer",sdp:this.remoteSDP.toString()}),this.isReady=!0}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}})}close(){var e;this.peerConnection.close(),this.peerConnection.onicecandidate=null,(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.tryUnbindTransportEvents(),this.unbindPCEvents(),this.unbindStatsEvents(),this.transport=void 0,this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}updateEncoderConfig(e,i){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let n=yield this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[i],[e]);this.remoteSDP.updateRecvMedia(e,i);let o=this.remoteSDP.toString(),s=this.logSDPExchange(r,"offer","local","updateEncoderConfig");yield this.peerConnection.setLocalDescription({type:"offer",sdp:r}),s?.(o),yield this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new F(C.EXCHANGE_SDP_FAILED,n.toString())}})}updateSendParameters(e,i){return I(this,null,function*(){let n=this.peerConnection.getTransceivers().filter(r=>r.mid===e);n.length===1&&(this.isVP8Simulcast(i)?_e()||(yield this.applySimulcastEncodings(n,[i])):yield this.applySendEncodings(n,[i]))})}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}replaceTrack(e,i){return I(this,null,function*(){let n=this.peerConnection.getTransceivers().find(r=>r.mid===i);n&&(yield n.sender.replaceTrack(e._mediaStreamTrack))})}getSelectedCandidatePair(){return I(this,null,function*(){let e=this.peerConnection.getReceivers();if(e.length>0&&e[0].transport&&e[0].transport.iceTransport&&e[0].transport.iceTransport.getSelectedCandidatePair&&e[0].transport.iceTransport.getSelectedCandidatePair()){let i=e[0].transport.iceTransport,{local:n,remote:r}=i.getSelectedCandidatePair();return{local:$o($o({},yr),{},{candidateType:n.type,protocol:n.protocol,address:n.address,port:n.port}),remote:$o($o({},yr),{},{candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})}}return this.statsFilter.getSelectedCandidatePair()})}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e,i;z(e=["connected","completed"]).call(e,this.peerConnection.iceConnectionState)&&(this.isReady=!1),(i=this.onICEConnectionStateChange)===null||i===void 0||i.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;this.peerConnection.connectionState==="connected"&&(this.restartCnt=0),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.startICECandidate()}startICECandidate(){this.peerConnection.onicecandidate||(this.localCandidateCount=0,this.peerConnection.onicecandidate=e=>{if(e.candidate){var i;e.candidate.candidate&&((i=this.onLocalCandidate)===null||i===void 0||i.call(this,e.candidate.toJSON())),this.localCandidateCount+=1}else _.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount)})}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e,i){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,r={iceServers:[]};var o;return e.iceServers?r.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(gd(e.turnServer.servers)?r.iceServers=e.turnServer.servers:(r.iceServers&&r.iceServers.push(...Nc.turnServerConfigToIceServers(e.turnServer.servers,i,n)),A("USE_TURN_SERVER_OF_GATEWAY")&&r.iceServers&&e.turnServer.serversFromGateway&&r.iceServers.push(...Nc.turnServerConfigToIceServers(e.turnServer.serversFromGateway,i,n)),z(o=[vs.Relay,vs.SdRtn]).call(o,i)&&(r.iceTransportPolicy="relay"),A("FORCE_TURN_TCP")?r.iceTransportPolicy="relay":e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(s=>{s.forceturn&&(r.iceTransportPolicy="relay")}))),A("ENABLE_ENCODED_TRANSFORM")&&Mt().supportWebRTCEncodedTransform&&(r.encodedInsertableStreams=!0),_.debug("P2PConnection p2pTransport is ".concat(i)),r}static turnServerConfigToIceServers(e,i){let n=arguments.length>2&&arguments[2]!==void 0?arguments[2]:0,r=[],o=e.filter(a=>a.tcpport);_.debug("P2PConnection turnServers is ".concat(o,", current index is ").concat(n));let s=o.length>n?o[n]:o[0];switch(i){case vs.SdRtn:let a=e.filter(d=>{var l;return z(l=d.username).call(l,"glb:")&&d.turnServerURL==d.turnServerURL}),c=a.length>n?a[n]:a[0];c&&(r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turn:".concat(Bo(c.turnServerURL),":").concat(c.tcpport,"?transport=udp")}),r.push({username:c.username,credential:c.password,credentialType:"password",urls:"turns:".concat(Bo(c.turnServerURL),":").concat(c.tcpport,"?transport=tcp")}));break;case vs.Relay:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(Bo(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}));break;default:s&&(r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turn:".concat(s.turnServerURL,":").concat(s.tcpport,"?transport=udp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"turns:".concat(Bo(s.turnServerURL),":").concat(s.tcpport,"?transport=tcp")}),r.push({username:s.username,credential:s.password,credentialType:"password",urls:"stun:".concat(s.turnServerURL,":").concat(s.tcpport)}))}return r}tryBindTransportEvents(e){if(e){this.transport=e,e.onstatechange=()=>{var n;e!=null&&e.state&&((n=this.onDTLSTransportStateChange)===null||n===void 0||n.call(this,e.state))},e.onerror=n=>{var r;(r=this.onDTLSTransportError)===null||r===void 0||r.call(this,"error"in n?n.error:n)};let i=e.iceTransport;i&&(i.onstatechange=()=>{let n=e?.iceTransport.state;var r;n&&((r=this.onICETransportStateChange)===null||r===void 0||r.call(this,n))},i.getSelectedCandidatePair&&(i.onselectedcandidatepairchange=()=>{if(i.getSelectedCandidatePair()){let{local:n,remote:r}=i.getSelectedCandidatePair();_.info("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] selectedcandidatepairchange: local ").concat(JSON.stringify({candidateType:n.type,protocol:n.protocol}),", remote ").concat(JSON.stringify({candidateType:r.type,protocol:r.protocol,address:r.address,port:r.port})," )"))}}))}}tryUnbindTransportEvents(){this.transport&&(this.transport.onstatechange=null,this.transport.onerror=null,this.transport.iceTransport&&(this.transport.iceTransport.onstatechange=null))}updateRtpSenderEncodings(e,i){return I(this,null,function*(){var n;if(i||(i=this.peerConnection.getSenders().find(l=>l.track===e._mediaStreamTrack)),!i)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(this.isVP8Simulcast(e))return _.warn("[updateRtpSenderEncodings] Track is VP8 simulcast, please apply simulcast encodings");if(!Mt().supportSetRtpSenderParameters)return _.warn("[updateRtpSenderEncodings] Browser not support set rtp-sender parameters");let r={},o={};switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(e._encoderConfig){var s;let{bitrateMax:l,frameRate:u,scaleResolutionDownBy:h}=e._encoderConfig;l&&(o.maxBitrate=1e3*l),z(s=e._hints).call(s,Jt.LOW_STREAM)&&(u&&(o.maxFramerate=Hi(u)),h&&h>=1&&(o.scaleResolutionDownBy=h))}if(A("DSCP_TYPE")&&Qr()){var a;let l=A("DSCP_TYPE");z(a=["very-low","low","medium","high"]).call(a,l)&&(o.networkPriority=l)}let c=i.getParameters(),d=(n=c.encodings)===null||n===void 0?void 0:n[0];_e()&&!d&&(r.encodings=[o]),d&&Object.assign(d,o),Object.assign(c,r),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(c.encodings))),yield i.setParameters(c)})}applySendEncodings(e,i){return I(this,null,function*(){try{if(!Mt().supportSetRtpSenderParameters||e.length!==i.length)return;for(let n=0;n<e.length;n++){let r=e[n],o=i[n];o instanceof re&&!this.isVP8Simulcast(o)&&(yield this.updateRtpSenderEncodings(o,r.sender))}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}})}mungSendOfferSDP(e,i,n){let r=Li(e);return i.forEach((o,s)=>{let a=n[s],c=r.mediaDescriptions.find(d=>d.attributes.mid===a);c&&(ic(c,o),zO(c,o,this.store.codec))}),xo(r)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,i,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onFirstVideoDecodedTimeout=e=>{var i;(i=this.onFirstVideoDecodedTimeout)===null||i===void 0||i.call(this,e)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0,this.statsFilter.onFirstVideoDecodedTimeout=void 0}applySimulcastForFirefox(e,i){return I(this,null,function*(){if(e.length===i.length)for(let c=0;c<e.length;c++){var n,r,o,s,a;let d=e[c],l=i[c];if(l instanceof re&&!z(n=l._hints).call(n,Jt.LOW_STREAM)&&(r=l._encoderConfig)!==null&&r!==void 0&&r.bitrateMax&&((o=l._encoderConfig)===null||o===void 0?void 0:o.bitrateMax)>200&&(s=l._scalabilityMode)!==null&&s!==void 0&&s.numSpatialLayers&&((a=l._scalabilityMode)===null||a===void 0?void 0:a.numSpatialLayers)>1&&this.store.codec==="vp8"){let u={},h={high:1e3*(l._encoderConfig.bitrateMax-50),medium:5e4};u.encodings=[{rid:"m",active:!0,maxBitrate:h.medium,scaleResolutionDownBy:4},{rid:"h",active:!0,maxBitrate:h.high}];let p=d.sender.getParameters();yield d.sender.setParameters(Object.assign(p,u))}}})}applySimulcastEncodings(e,i){return I(this,null,function*(){if(!_e()&&e.length===i.length)for(let n=0;n<e.length;n++){let r=i[n];if(r instanceof re&&this.isVP8Simulcast(r)){let o=e[n],s={},a={high:1e3*(r._encoderConfig.bitrateMax-50),medium:5e4};s.encodings=[{active:!0,adaptivePtime:!1,networkPriority:"high",priority:"high",maxBitrate:a.high},{active:!0,adaptivePtime:!1,networkPriority:"low",priority:"low",maxBitrate:a.medium,scaleResolutionDownBy:4}];let c=o.sender.getParameters();yield o.sender.setParameters(Object.assign(c,s))}}})}isVP8Simulcast(e){var i,n,r,o,s;return!!(e instanceof re&&A("SIMULCAST")&&this.store.codec==="vp8"&&!z(i=e._hints).call(i,Jt.LOW_STREAM)&&(n=e._encoderConfig)!==null&&n!==void 0&&n.bitrateMax&&((r=e._encoderConfig)===null||r===void 0?void 0:r.bitrateMax)>200&&(o=e._scalabilityMode)!==null&&o!==void 0&&o.numSpatialLayers&&((s=e._scalabilityMode)===null||s===void 0?void 0:s.numSpatialLayers)>1)}logSDPExchange(e,i,n,r){if(A("SDP_LOGGING"))return _.upload("[".concat(this.store.clientId,"] exchanging ").concat(n," ").concat(i," SDP during P2PConnection.").concat(r,`
`),e),i==="offer"?o=>{this.logSDPExchange(o,"answer",n==="local"?"remote":"local",r)}:void 0}muteLocal(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(s=>{s.direction="inactive"});let n=yield this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","muteLocal");yield this.peerConnection.setLocalDescription(n),this.remoteSDP.muteRemote(e);let o=this.remoteSDP.toString();r?.(o),yield this.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}})}unmuteLocal(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getTransceivers().filter(s=>s.mid&&e.indexOf(s.mid)!==-1);if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length.");i.map(s=>I(this,null,function*(){s.direction="sendonly"}));let n=yield this.peerConnection.createOffer(),r=this.logSDPExchange(n.sdp||"","offer","local","unmuteLocal");yield this.peerConnection.setLocalDescription(n),this.remoteSDP.unmuteRemote(e);let o=this.remoteSDP.toString();r?.(o),yield this.setRemoteDescription({type:"answer",sdp:o})}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}})}getRemoteSSRC(e,i){return I(this,null,function*(){var n;if(i=i??((n=this.currentRemoteDescription)===null||n===void 0?void 0:n.sdp)){var r;let o=(r=Li(i).mediaDescriptions.find(s=>s.attributes.mid===e))===null||r===void 0?void 0:r.attributes.ssrcs;return o?.[0].ssrcId}})}setRemoteDescription(e){return I(this,null,function*(){var i;yield this.peerConnection.setRemoteDescription(e),z(i=["connected","completed"]).call(i,this.peerConnection.iceConnectionState)||(this.isReady=!0,this.addRemoteCandidate())})}mungReceiveAnswerSDP(e,i,n){let r=Li(e),o=r.mediaDescriptions.find(s=>s.attributes.mid===i);return o&&n===$.AUDIO&&o.media.mediaType==="audio"&&nc(o),xo(r)}},rt(oe.prototype,"establish",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"establish"),oe.prototype),rt(oe.prototype,"connect",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"connect"),oe.prototype),rt(oe.prototype,"receive",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"receive"),oe.prototype),rt(oe.prototype,"mockReceive",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"mockReceive"),oe.prototype),rt(oe.prototype,"stopReceiving",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"stopReceiving"),oe.prototype),rt(oe.prototype,"restartICE",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"restartICE"),oe.prototype),rt(oe.prototype,"close",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"close"),oe.prototype),rt(oe.prototype,"updateEncoderConfig",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"updateEncoderConfig"),oe.prototype),rt(oe.prototype,"updateSendParameters",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"updateSendParameters"),oe.prototype),rt(oe.prototype,"replaceTrack",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"replaceTrack"),oe.prototype),rt(oe.prototype,"muteLocal",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"muteLocal"),oe.prototype),rt(oe.prototype,"unmuteLocal",[Kn],Object.getOwnPropertyDescriptor(oe.prototype,"unmuteLocal"),oe.prototype),oe);function Kn(t,e,i){let n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=function(){return I(this,arguments,function*(){let r=this.mutex,o=yield r.lock("From P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return yield n.apply(this,a)}finally{o()}})},i}let cr=function(t){return t.SEND_ONLY="SEND_ONLY",t.RECEIVE_ONLY="RECEIVE_ONLY",t}({});var sL,aL,cL,dL,lL,uL,hL,pL,_L,mL,EL,le;function fL(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function Ap(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?fL(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):fL(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let sY=(sL=dr(cr.SEND_ONLY),aL=dr(cr.SEND_ONLY),cL=dr(),dL=dr(cr.RECEIVE_ONLY),lL=dr(cr.RECEIVE_ONLY),uL=dr(cr.RECEIVE_ONLY),hL=dr(cr.RECEIVE_ONLY),pL=dr(cr.RECEIVE_ONLY),_L=dr(cr.RECEIVE_ONLY),mL=dr(),EL=dr(cr.RECEIVE_ONLY),le=class extends ue{get state(){return this._state}set state(t){let e=this._state;this._state=t,this.emit(at.StateChange,e,this._state)}constructor(t,e){super(),T(this,"isPlanB",!1),T(this,"store",void 0),T(this,"statsUploader",void 0),T(this,"sendConnection",void 0),T(this,"recvConnection",void 0),T(this,"localTrackMap",new Map),T(this,"remoteUserMap",new Map),T(this,"localDataChannels",[]),T(this,"pendingLocalTracks",[]),T(this,"pendingRemoteTracks",[]),T(this,"statsCollector",void 0),T(this,"dtlsFailedCount",0),T(this,"sendMutex",void 0),T(this,"recvMutex",void 0),T(this,"_state",Bt.Disconnected),T(this,"_restartStates",["disconnected","failed"]),T(this,"reconnectInterval",void 0),T(this,"uploadUnplinkStarted",!1),T(this,"uploadDownlinkStarted",!1),T(this,"uplinkStateUploadInterval",void 0),T(this,"downlinkStatsUploadInterval",void 0),T(this,"handleMuteLocalTrack",(i,n,r)=>I(this,null,function*(){let o=yield this.sendMutex.lock("Locking from P2PChannel2.handleMuteLocalTrack");try{if(!this.sendConnection||this.state!==Bt.Connected)return void r(new F(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established."));let c=this.filterTobeMutedTracks(i);if(c.length===0)return void n();let d=c.find(p=>p[0]==="videoLowTrack");d&&d[1].track._originMediaStreamTrack.stop(),yield this.sendConnection.muteLocal(c.map(p=>{let[,{id:g}]=p;return g}));let l=!1;var s,a;i.trackMediaType==="video"?l=!((s=this.localTrackMap.get(W.LocalAudioTrack))===null||s===void 0||!s.track._muted):l=((a=this.localTrackMap.get(W.LocalVideoTrack))===null||a===void 0?void 0:a.id)===void 0;let u=this.createMuteMessage(c);yield Zt(this,at.RequestMuteLocal,u);let h=i.trackMediaType==="video"?Fo.MUTE_LOCAL_VIDEO:Fo.MUTE_LOCAL_AUDIO;yield Zt(this,at.RequestP2PMuteLocal,{action:h,message:u,isMuteAll:l}),n()}catch(c){r(c)}finally{o()}})),T(this,"handleUnmuteLocalTrack",(i,n,r)=>I(this,null,function*(){let o=yield this.sendMutex.lock("Locking from P2PChannel2.handleUnmuteLocalTrack");try{if(!this.sendConnection||this.state!==Bt.Connected)return void r(new F(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleUnmuteLocalTrack before sendConnection established."));let s=this.filterTobeUnmutedTracks(i);if(s.length===0)return void n();yield this.sendConnection.unmuteLocal(s.map(d=>{let[,{id:l}]=d;return l}));let a=this.createUnmuteMessage(s),c=i.trackMediaType==="video"?Fo.UNMUTE_LOCAL_VIDEO:Fo.UNMUTE_LOCAL_AUDIO;yield Zt(this,at.RequestP2PMuteLocal,{action:c,message:a}),n()}catch(s){r(s)}finally{o()}})),T(this,"handleUpdateVideoEncoder",(i,n,r,o)=>I(this,null,function*(){let s;typeof o=="boolean"&&o||(s=yield this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoEncoder"));try{let c=this.localTrackMap.get(W.LocalVideoTrack);if(!this.sendConnection||!c||c.track!==i||this.state!==Bt.Connected)return void n();let{id:d,track:l}=c;d&&(yield this.sendConnection.updateSendParameters(d,l),yield this.sendConnection.updateEncoderConfig(d,l),this.emit(at.UpdateVideoEncoder,l)),n()}catch(c){r(c)}finally{var a;(a=s)===null||a===void 0||a()}})),T(this,"handleUpdateVideoSendParameters",(i,n,r)=>I(this,null,function*(){let o=yield this.sendMutex.lock("Locking from P2PChannel2.handleUpdateVideoSendParameters");try{let s=this.localTrackMap.get(W.LocalVideoTrack);if(!this.sendConnection||!s||s.track!==i||this.state!==Bt.Connected)return void n();let{id:a,track:c}=s;a&&(yield this.sendConnection.updateSendParameters(a,c)),n()}catch(s){r(s)}finally{o()}})),T(this,"handleReplaceTrack",(i,n,r,o)=>I(this,null,function*(){let s;_.debug("[".concat(this.store.clientId,"] P2PChannel2 handleReplaceTrack for [track-id-").concat(i.getTrackId(),"]")),typeof o=="boolean"&&o||(s=yield this.sendMutex.lock("From P2PChannel2.handleReplaceTrack"));try{var a;let d=Array.from(this.localTrackMap.entries()).find(l=>{let[,{track:u}]=l;return i===u});if(!this.sendConnection||!d||d[1].id===void 0||this.state!==Bt.Connected)return void n();if(yield(a=this.sendConnection)===null||a===void 0?void 0:a.replaceTrack(i,d[1].id),d[0]===W.LocalVideoTrack&&Mt().supportDualStreamEncoding){let l=this.localTrackMap.get(W.LocalVideoLowTrack);if(l){let u=i._mediaStreamTrack.clone();l.track._originMediaStreamTrack.stop(),l.track._mediaStreamTrack=u,l.track._originMediaStreamTrack=u,yield new Q((h,p)=>{this.handleReplaceTrack(l.track,h,p,!0)})}}n()}catch(d){r(d)}finally{var c;(c=s)===null||c===void 0||c()}})),T(this,"handleGetLocalVideoStats",i=>{i(this.statsCollector.getLocalVideoTrackStats())}),T(this,"handleGetLocalAudioStats",i=>{i(this.statsCollector.getLocalAudioTrackStats())}),T(this,"handleGetRemoteVideoStats",i=>this.statsCollector.getRemoteVideoTrackStats(i.uid)[i.uid]),T(this,"handleGetRemoteAudioStats",i=>this.statsCollector.getRemoteAudioTrackStats(i.uid)[i.uid]),this.store=t,this.statsCollector=e,this.statsCollector.addP2PChannel(this),this.statsUploader=new LN(t),this.bindStatsUploaderEvents(),this.sendMutex=new ni("P2PChannel2-send-mutex",t.clientId),this.recvMutex=new ni("P2PChannel2-recv-mutex",t.clientId),this.reconnectInterval=window.setInterval(()=>{[this.sendConnection,this.recvConnection].forEach(i=>{i&&(i.iceConnectionState!=="disconnected"&&i.iceConnectionState!=="failed"||this.handleDisconnect(i.direction))})},A("ICE_RESTART_INTERVAL"))}startP2PConnection(t,e){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED,"p2p mode does not support startP2PConnection.")})}connect(t){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED,"p2p mode does not support connect.")})}startP2P(t,e){return I(this,null,function*(){let i;try{if(e){this.recvConnection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset recvConnection.")),this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection)),i=yield this.recvMutex.lock("From P2PChannel.startP2P"),this.recvConnection=new oL(t,this.store,Ti.RECEIVE_ONLY),this.bindConnectionEvents(this.recvConnection);let n=yield this.recvConnection.establish(e);return{iceParameters:n.iceParameters,dtlsParameters:n.dtlsParameters,sdp:n.sdp}}{this.state=Bt.New,this.sendConnection&&(_.warning("[".concat(this.store.clientId,"] P2PChannel.startP2P reset sendConnection.")),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection)),i=yield this.sendMutex.lock("From P2PChannel.startP2P"),this.sendConnection=new oL(t,this.store),this.store.peerConnectionStart(),this.bindConnectionEvents(this.sendConnection);let n=yield this.sendConnection.establish();return{iceParameters:n.iceParameters,dtlsParameters:n.dtlsParameters,sdp:n.sdp}}}finally{i&&i()}})}p2pConnect(t){return I(this,null,function*(){if(!this.sendConnection)throw new F(C.UNEXPECTED_ERROR,"Cannot P2PChannel2.p2pConnect before P2PChannel2.startP2PConnection .");this.store.peerConnectionStart(),yield this.sendConnection.connect(t),this.statsUploader.startUploadTransportStats(),this.statsUploader.startUploadExtensionUsageStats(),this.state=Bt.Connected})}addRemoteCandidate(t,e){return I(this,null,function*(){if(e===Ti.RECEIVE_ONLY){if(!this.sendConnection)throw new F(C.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");yield this.sendConnection.addRemoteCandidate(t)}else{if(!this.recvConnection)throw new F(C.UNEXPECTED_ERROR,"Cannot P2PChannel2.connect before P2PChannel2.addRemoteCandidate .");yield this.recvConnection.addRemoteCandidate(t)}})}publish(t,e,i){var n=this;return un(function*(){let r=yield Lt(n.sendMutex.lock("From P2PChannel.publish"));try{if(!n.sendConnection||n.state!==Bt.Connected){n.throwIfTrackTypeNotMatch(t);let d=t.filter(l=>n.pendingLocalTracks.indexOf(l)===-1);return void(n.pendingLocalTracks=n.pendingLocalTracks.concat(d))}n.store.pubId=n.store.pubId+1,si.markPublishStart(n.store.clientId,n.store.pubId);let o=n.filterTobePublishedTracks(t,e,i);if(o.length===0)return void(yield Lt(n.tryToUnmuteAudio(t)));o.forEach(d=>{let{track:l,type:u}=d,h=Date.now();n.store.publish(l.getTrackId(),u===W.LocalAudioTrack?"audio":"video",h)}),n.bindLocalTrackEvents(o);let s=yield Lt(n.sendConnection.send(o.map(d=>{let{track:l}=d;return l}),n.store.codec,n.store.audioCodec)),a=(yield Lt(s.next())).value,c=n.createGatewayPublishMessage(o,a);try{yield c}catch(d){throw s.throw(d),d?.code===C.WS_ABORT&&o.forEach(l=>{let{track:u}=l;n.pendingLocalTracks.indexOf(u)===-1&&n.pendingLocalTracks.push(u)}),n.unbindLocalTrackEvents(o),d}yield Lt(s.next()),o.forEach(d=>{let{type:l}=d;n.statsCollector.addLocalStats(l)}),n.statsUploader.startUploadOutboundStats(),n.assignLocalTracks(o,a),o.forEach(d=>{let{track:l,type:u}=d,h=Date.now();n.store.publish(l.getTrackId(),u===W.LocalAudioTrack?"audio":"video",void 0,h)}),n.startUploadUplinkState()}finally{r()}})()}unpublish(t){return I(this,null,function*(){if(!this.sendConnection||this.state!==Bt.Connected)return void(t.length===0?this.pendingLocalTracks.length=0:this.pendingLocalTracks=this.pendingLocalTracks.filter(r=>!z(t).call(t,r)));let e=this.filterTobeUnpublishedTracks(t);if(e.length===0)return;let i=e.find(r=>r[0]==="videoLowTrack");i&&i[1].track.close();let n=this.createGatewayUnpublishMessage(e);if(yield this.sendConnection.stopSending(e.map(r=>{let[,{id:o}]=r;return o})),this.withdrawLocalTracks(e),this.unbindLocalTrackEvents(e.map(r=>{let[o,{track:s}]=r;return{type:o,track:s}})),e.forEach(r=>{let[o]=r;this.statsCollector.removeLocalStats(o)}),this.localTrackMap.size===0&&(this.statsUploader.stopUploadOutboundStats(),this.stopUploadUplinkState()),this.sendConnection&&this.state===Bt.Connected)return i&&i[1].track.close(),n;t.forEach(r=>{let o=this.pendingLocalTracks.indexOf(r);o!==-1&&this.pendingLocalTracks.splice(o,1)})})}startUploadUplinkState(){if(this.uploadUnplinkStarted)return;this.uploadUnplinkStarted=!0,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval);let t=()=>{let e=[],i=[];Array.from(this.localTrackMap.entries()).forEach(n=>{let[r,{track:o,ssrcs:s}]=n,a={stream_type:tq(o,r),ssrcs:s};o._muted||!o._enabled?e.push(a):i.push(a)}),e.length>0&&e.forEach(n=>{Zt(this,at.RequestMuteLocal,[n])}),i.length>0&&i.forEach(n=>{Zt(this,at.RequestUnmuteLocal,[n])})};t(),this.uplinkStateUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadUplinkState(){this.uploadUnplinkStarted&&(this.uploadUnplinkStarted=!1,this.uplinkStateUploadInterval&&window.clearInterval(this.uplinkStateUploadInterval))}publishLowStream(t){return un(function*(){throw new F(C.NOT_SUPPORTED,"p2p mode does not support publishLowStream.")})()}republish(){return I(this,null,function*(){this.pendingLocalTracks.length>0&&(_.debug("[".concat(this.store.clientId,"] Emit P2PChannelEvents.RequestRePublish to republish tracks.")),yield $e(this,at.RequestRePublish,this.pendingLocalTracks),this.emit(at.MediaReconnectEnd,this.store.uid),this.pendingLocalTracks=[])})}unpublishLowStream(){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED,"p2p mode does not support unpublishLowStream.")})}subscribe(t,e,i,n){return I(this,null,function*(){var r;if(!this.recvConnection)throw new F(C.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");if((r=this.remoteUserMap.get(t))!==null&&r!==void 0&&r.has(e))return;let{track:o,mid:s,transceiver:a}=yield this.recvConnection.receive(e,[{ssrcId:i}],String(t.uid),n);e===$.AUDIO?(t._audioTrack?t._audioTrack._updateOriginMediaStreamTrack(o):(t._audioTrack=new za(o,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote audio track: ").concat(t._audioTrack.getTrackId()))),a&&t._audioTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._audioTrack)):(t._videoSSRC=i,t._videoTrack?t._videoTrack._updateOriginMediaStreamTrack(o):(t._videoTrack=new Ya(o,t.uid,t._uintid,this.store),_.info("[".concat(this.store.clientId,"] [").concat(this.store.p2pId,"] create remote video track: ").concat(t._videoTrack.getTrackId()))),a&&t._videoTrack._updateRtpTransceiver(a),this.bindRemoteTrackEvents(t,t._videoTrack));let c=this.remoteUserMap.get(t);c?c.set(e,s):this.remoteUserMap.set(t,new Map([[e,s]])),this.statsCollector.addRemoteStats(t.uid),this.statsUploader.startUploadInboundStats(),this.startUploadDownlinkState();let d=this.pendingRemoteTracks.findIndex(l=>{let{user:u,kind:h}=l;return u.uid===t.uid&&e===h});d!==-1&&(this.pendingRemoteTracks.splice(d,1),this.emit(at.MediaReconnectEnd,t.uid))})}mockSubscribe(t,e,i,n){return I(this,null,function*(){if(!this.recvConnection)throw new F(C.INVALID_OPERATION,"Cannot subscribe remote user when recvConnection disconnected.");yield this.recvConnection.mockReceive(e,[{ssrcId:i}],String(t.uid),n)})}unsubscribe(t,e,i){return I(this,null,function*(){let n=this.pendingRemoteTracks.filter(o=>{let{user:s,kind:a}=o;return e!==void 0?s.uid===t.uid&&e===a:s.uid===t.uid});if(n.forEach(o=>{let s=this.pendingRemoteTracks.indexOf(o);this.pendingRemoteTracks.splice(s,1)}),this.recvConnection||i||n.forEach(o=>{let{kind:s}=o;var a;if(s===$.AUDIO)(a=t._audioTrack)===null||a===void 0||a._destroy(),t._audioTrack=void 0;else if(s===$.VIDEO){var c;(c=t._videoTrack)===null||c===void 0||c._destroy(),t._videoTrack=void 0}}),!this.recvConnection)return;let r=this.filterTobeUnSubscribedTracks(t,e);r.length!==0&&(yield this.recvConnection.stopReceiving(r.map(o=>{let[,{id:s}]=o;return s})),this.withdrawRemoteTracks(r),this.remoteUserMap.size===0&&(this.statsUploader.stopUploadInboundStats(),this.stopUploadDownlinkState()),r.forEach(o=>{let[s,{kind:a}]=o;var c,d;if(a===$.VIDEO&&s._videoSSRC&&((c=this.recvConnection)===null||c===void 0||c.setStatsRemoteVideoIsReady(s._videoSSRC,!1)),a===$.VIDEO)this.unbindRemoteTrackEvents(s._videoTrack),i||((d=s._videoTrack)===null||d===void 0||d._destroy(),s._videoTrack=void 0);else if(a===$.AUDIO){var l;this.unbindRemoteTrackEvents(s._audioTrack),!i&&((l=s._audioTrack)===null||l===void 0||l._destroy(),s._audioTrack=void 0)}}),r.forEach(o=>{let[,{kind:s}]=o;Zt(this,at.RequestP2PMuteRemote,s)}))})}startUploadDownlinkState(){if(this.uploadDownlinkStarted)return;this.uploadDownlinkStarted=!0,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval);let t=()=>Array.from(this.remoteUserMap.entries()).forEach(e=>{let[,i]=e;[$.VIDEO,$.AUDIO].forEach(n=>{i.has(n)?Zt(this,at.RequestP2PUnmuteRemote,n):Zt(this,at.RequestP2PMuteRemote,n)})});t(),this.downlinkStatsUploadInterval=window.setInterval(()=>{t()},3e3)}stopUploadDownlinkState(){this.uploadDownlinkStarted&&(this.uploadDownlinkStarted=!1,this.downlinkStatsUploadInterval&&window.clearInterval(this.downlinkStatsUploadInterval))}getAllDataChannels(){return this.localDataChannels}massSubscribe(t){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED,"p2p mode does not support massSubscribe.")})}massSubscribeNoLock(t){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED,"p2p mode does not support massSubscribeNoLock.")})}massUnsubscribe(t){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED,"p2p mode does not support massUnsubscribe.")})}massUnsubscribeNoLock(t){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED,"p2p mode does not support massUnsubscribeNoLock.")})}muteRemote(t,e){return I(this,null,function*(){if(!this.recvConnection)return;let i=this.remoteUserMap.get(t);if(!i)return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid,"."));if(!i.get(e))return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.muteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."));let n=e===$.VIDEO?t._videoSSRC:t._audioSSRC;n!==void 0&&this.recvConnection.setStatsRemoteVideoIsReady(n,!1)})}unmuteRemote(t,e){return I(this,null,function*(){return this.unmuteRemoteNoLock(t,e)})}unmuteRemoteNoLock(t,e){return I(this,null,function*(){if(!this.recvConnection)return;let i=this.remoteUserMap.get(t);if(!i)return void _.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid,"."));i.get(e)||_.warning("[".concat(this.store.clientId,"] P2PChannel2.unmuteRemote has no remote user ").concat(t.uid," media type ").concat(e,"."))})}getAllTracks(t){let e=this.localTrackMap.get(W.LocalAudioTrack);if(e?.track instanceof Le){let i=e.track;return Array.from(this.localTrackMap.entries()).filter(n=>{let[r]=n;return r!==W.LocalAudioTrack}).filter(n=>{let[r]=n;return!(t&&r===W.LocalVideoLowTrack)}).map(n=>{let[,{track:r}]=n;return r}).concat(i.trackList)}return Array.from(this.localTrackMap.entries()).filter(i=>{let[n]=i;return!(t&&n===W.LocalVideoLowTrack)}).map(i=>{let[,{track:n}]=i;return n})}reportPublishEvent(t,e,i,n,r){if(t){let s=this.localTrackMap.get(W.LocalAudioTrack),a=n?this.localTrackMap.get(W.LocalVideoLowTrack):this.localTrackMap.get(W.LocalVideoTrack);ot.publish(this.store.sessionId,{eventElapse:si.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.track.getTrackLabel(),videoName:a?.track.getTrackLabel(),screenshare:a?.track._hints.indexOf(Jt.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}else{var o;i||(i=[]);let s=i.find(c=>c instanceof ge),a=n?(o=this.localTrackMap.get(W.LocalVideoTrack))===null||o===void 0?void 0:o.track:i.find(c=>c instanceof re);ot.publish(this.store.sessionId,{eventElapse:si.measureFromPublishStart(this.store.clientId,this.store.pubId),succ:t,ec:e,audioName:s?.getTrackLabel(),videoName:a?.getTrackLabel(),screenshare:a?._hints.indexOf(Jt.SCREEN_TRACK)!==-1,audio:!!s,video:!!a,p2pid:this.store.p2pId,publishRequestid:this.store.pubId,extend:r})}}reportSubscribeEvent(t,e,i,n){let r=n===$.VIDEO?i._videoSSRC:i._audioSSRC;r&&ot.subscribe(this.store.sessionId,{succ:t,ec:e,video:n===$.VIDEO,audio:n===$.AUDIO,peerid:i.uid,subscribeRequestid:n===$.VIDEO?i._videoSSRC:i._audioSSRC,p2pid:this.store.p2pId,eventElapse:si.measureFromSubscribeStart(this.store.clientId,r)})}reset(){_.debug("[".concat(this.store.clientId,"] P2PChannel2.reset")),this.sendMutex=new ni("P2PChannel2-send-mutex",this.store.clientId),this.sendMutex=new ni("P2PChannel2-recv-mutex",this.store.clientId),this.sendConnection&&(this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0),this.recvConnection&&(this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),this.statsUploader.stopUploadExtensionUsageStats(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.unbindLocalTrackEvents(),this.unbindAllRemoteTrackEvents(),this.unbindRtpTransceiver();let t=this.localTrackMap.get(W.LocalAudioTrack);if(t?.track instanceof Le){if(t.track.trackList.length>0){let e=t.track;t.track.trackList.forEach(i=>{e.removeAudioTrack(i)})}t.track.close()}this.localTrackMap.clear(),this.remoteUserMap.clear(),this.statsCollector.removeRemoteStats(),this.statsCollector.removeLocalStats(),this.dtlsFailedCount=0,this.pendingLocalTracks=[],this.pendingRemoteTracks=[],this.reconnectInterval&&(window.clearInterval(this.reconnectInterval),this.reconnectInterval=void 0),this.state=Bt.Disconnected}getStats(t){var e,i;return t?(i=this.recvConnection)===null||i===void 0?void 0:i.getStats():(e=this.sendConnection)===null||e===void 0?void 0:e.getStats()}getRemoteVideoIsReady(t){var e;return((e=this.recvConnection)===null||e===void 0?void 0:e.getRemoteVideoIsReady(t))||!1}getLocalAudioVolume(){let t=this.localTrackMap.get(W.LocalAudioTrack);if(t)return t.track.getVolumeLevel()}getLocalVideoSize(){let t=this.localTrackMap.get(W.LocalVideoTrack);if(t)return{width:t.track.videoWidth||0,height:t.track.videoHeight||0}}getEncoderConfig(t){let e=this.localTrackMap.get(t);return e&&e.track instanceof re||e&&e.track instanceof ge?e.track._encoderConfig:void 0}getLocalMedia(t){return this.localTrackMap.get(t)}hasLocalMedia(){return this.localTrackMap.size>0}hasRemoteMedia(t,e){if(!t)return this.remoteUserMap.size>0;let i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))}hasRemoteMediaWithLock(t,e){return I(this,null,function*(){if(!t)return this.remoteUserMap.size>0;let i=this.remoteUserMap.get(t);return!!i&&(!e||i.has(e))})}getRemoteMedia(t){var e;let i=Array.from(Zi(e=this.remoteUserMap).call(e)).find(n=>n.uid===t);return i?{audioTrack:i.audioTrack,audioSSRC:i._audioSSRC,videoTrack:i.videoTrack,videoSSRC:i._videoSSRC}:{}}getAudioLevels(){let t=Array.from(this.remoteUserMap.entries()).map(i=>{let[n]=i;return{uid:n.uid,level:n.audioTrack?100*n.audioTrack._source.getAccurateVolumeLevel():0}}),e=this.localTrackMap.get(W.LocalAudioTrack);return e&&t.push({level:100*e.track._source.getAccurateVolumeLevel(),uid:this.store.uid}),t=ls(t).call(t,(i,n)=>i.level-n.level),t}disconnectForReconnect(){return I(this,null,function*(){this.sendConnection&&this.recvConnection&&(_.debug("[".concat(this.store.clientId,"] P2PChannel2.disconnectForReconnect closing P2PConnection")),this.state=Bt.Reconnecting,A("KEEP_LAST_FRAME")&&this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e]=t;var i;e._videoTrack&&e._videoTrack._player&&((i=e._videoTrack._player.getVideoElement())===null||i===void 0||i.pause(),e._videoTrack._player.isKeepLastFrame=!0,e._videoTrack._originMediaStreamTrack.stop())}),this.sendConnection.close(),this.unbindConnectionEvents(this.sendConnection),this.sendConnection=void 0,this.recvConnection.close(),this.unbindConnectionEvents(this.recvConnection),this.recvConnection=void 0,this.localTrackMap.size!==0&&(Array.from(this.localTrackMap.entries()).forEach(t=>{var e;let[i,{track:n}]=t;switch(i){case W.LocalVideoTrack:z(e=n._hints).call(e,Jt.LOW_STREAM)?n.close():this.pendingLocalTracks.push(n);break;case W.LocalAudioTrack:n instanceof Le?this.pendingLocalTracks=this.pendingLocalTracks.concat(n.trackList):this.pendingLocalTracks.push(n);case W.LocalVideoLowTrack:}}),this.emit(at.MediaReconnectStart,this.store.uid)),this.unbindLocalTrackEvents(),this.localTrackMap.clear(),this.remoteUserMap.size!==0&&Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;Array.from(Zi(i).call(i)).forEach(n=>{this.setPendingRemoteMedia(e,n)}),this.emit(at.MediaReconnectStart,e.uid)}),this.unbindAllRemoteTrackEvents(),this.remoteUserMap.clear(),this.stopUploadUplinkState(),this.stopUploadDownlinkState(),this.statsUploader.stopUploadOutboundStats(),this.statsUploader.stopUploadInboundStats(),this.statsUploader.stopUploadTransportStats(),_.debug("[".concat(this.store.clientId,"] P2PChannel2 disconnected, waiting to reconnect.")))})}hasPendingRemoteMedia(t,e){for(let i of this.pendingRemoteTracks){let{user:n,kind:r}=i;if((t instanceof Ho?t.uid:t)===n.uid&&e===r)return!0}return!1}setPendingRemoteMedia(t,e){this.hasPendingRemoteMedia(t,e)||this.pendingRemoteTracks.push({user:t,kind:e})}restartICE(t,e){return I(this,null,function*(){let i,n;if(t===Ti.SEND_ONLY){if(!this.sendConnection)throw new F(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before sendConnection established.");i=yield this.sendMutex.lock("From P2PChannel.restartICE"),n=this.sendConnection}else{if(!this.recvConnection)throw new F(C.INVALID_OPERATION,"Cannot call P2PChannel2.handleMuteLocalTrack before recvConnection established.");i=yield this.recvMutex.lock("From P2PChannel.restartICE"),n=this.recvConnection}try{if(e){let r=yield n.restartICE(e);return n.isInRestartIce=!1,r}{let r=yield n.restartICE();if(r){let o=yield $e(this,at.RequestP2PRestartICE,{direction:Ti.RECEIVE_ONLY,iceParameter:r});yield n.restartICE(o),n.isInRestartIce=!1}}}finally{i()}})}getUplinkNetworkQuality(){if(!this.sendConnection)return 0;let t=this.sendConnection.getStats(),e=this.localTrackMap.get(W.LocalVideoTrack),i=this.localTrackMap.get(W.LocalAudioTrack),n=t.videoSend.find(p=>{var g;return p.ssrc===(e==null||(g=e.ssrcs)===null||g===void 0?void 0:g[0].ssrcId)}),r=t.audioSend.find(p=>{var g;return p.ssrc===(i==null||(g=i.ssrcs)===null||g===void 0?void 0:g[0].ssrcId)});if(!n||!r)return 1;let o=Ji(this,at.NeedSignalRTT),s=n?n.rttMs:void 0,a=r?r.rttMs:void 0,c=s&&a?(s+a)/2:s||a,d=(c&&o?(c+o)/2:c||o)||0,l=100*t.sendPacketLossRate*.7/50+.3*d/1500,u=l<.17?1:l<.36?2:l<.59?3:l<.1?4:5,h=e?.track;if(h&&h._encoderConfig&&h._hints.indexOf(Jt.SCREEN_TRACK)===-1){let p=h._encoderConfig.bitrateMax,g=t.bitrate.actualEncoded;if(p&&g){let E=(1e3*p-g)/(1e3*p);return RO[E<.15?0:E<.3?1:E<.45?2:E<.6?3:4][u]}}return u}getDownlinkNetworkQuality(){if(!this.recvConnection)return 0;let t=this.recvConnection.getStats(),e=0;return Array.from(this.remoteUserMap.entries()).forEach(i=>{let[n]=i,r=n._audioSSRC,o=n._videoSSRC,s=t.audioRecv.find(g=>g.ssrc===r),a=t.videoRecv.find(g=>g.ssrc===o);if(!s&&!a)return void(e+=1);let c=Ji(this,at.NeedSignalRTT),d=t.rtt,l=(d&&c?(d+c)/2:d||c)||0,u=s?s.jitterMs:void 0,h=t.recvPacketLossRate,p=.7*h*100/50+.3*l/1500;u&&(p=.6*h*100/50+.2*l/1500+.2*u/400),e+=p<.1?1:p<.17?2:p<.36?3:p<.59?4:5}),this.remoteUserMap.size>0?Math.round(e/this.remoteUserMap.size):e}muteLocalTrack(t){return I(this,null,function*(){return new Q((e,i)=>{this.handleMuteLocalTrack(t,e,i)})})}filterTobePublishedTracks(t,e,i){let n=[],r=Mt(),o=this.getAllTracks();t=ka(t=t.filter(c=>o.indexOf(c)===-1));let s=!1,a=!1;for(let c of t){if(c instanceof re&&(this.localTrackMap.has(W.LocalVideoTrack)||s?new F(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS).throw():(n.push({track:c,type:W.LocalVideoTrack}),s=!0),e)){let d=this.getLowVideoTrack(c,i);n.push({track:d,type:W.LocalVideoLowTrack})}if(c instanceof ge){let d=this.localTrackMap.get(W.LocalAudioTrack);if(d){if(!(d.track instanceof Le))throw new F(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new F(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");d.track.addAudioTrack(c),this.bindLocalAudioTrackEvents(c,!0)}else if(a){let l=n.find(u=>{let{type:h}=u;return h===W.LocalAudioTrack});if(!(l.track instanceof Le))throw new F(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser does not support audio mixing");if(c._bypassWebAudio)throw new F(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio");l.track.addAudioTrack(c)}else{if(!r.webAudioMediaStreamDest||c instanceof Le||c._bypassWebAudio)n.push({track:c,type:W.LocalAudioTrack});else{let l=new Le;l.addAudioTrack(c),n.push({track:l,type:W.LocalAudioTrack})}a=!0}}}return n}filterTobeUnpublishedTracks(t){let e=[],i=this.getAllTracks();t=ka(t=t.filter(n=>i.indexOf(n)!==-1));for(let n of t){if(n instanceof ge){let r=this.localTrackMap.get(W.LocalAudioTrack);if(!r)continue;r.track instanceof Le?(r.track.removeAudioTrack(n),this.unbindLocalAudioTrackEvents(n),r.track.trackList.length===0&&(e.push([W.LocalAudioTrack,r]),r.track.close())):e.push([W.LocalAudioTrack,r])}if(n instanceof re){let r=this.localTrackMap.get(W.LocalVideoTrack);if(!r)continue;e.push([W.LocalVideoTrack,r]);let o=this.localTrackMap.get(W.LocalVideoLowTrack);o&&e.push([W.LocalVideoLowTrack,o])}}return e}bindLocalTrackEvents(t){t.forEach(e=>{let{track:i,type:n}=e;switch(n){case W.LocalVideoTrack:i.addListener(nt.GET_STATS,this.handleGetLocalVideoStats),i.addListener(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(nt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.addListener(nt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.addListener(nt.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.addListener(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case W.LocalAudioTrack:this.bindLocalAudioTrackEvents(i);case W.LocalVideoLowTrack:}})}bindLocalAudioTrackEvents(t,e){t instanceof Le?t.trackList.forEach(i=>{i.addListener(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.addListener(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.addListener(nt.GET_STATS,this.handleGetLocalAudioStats),i.addListener(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.addListener(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.addListener(nt.GET_STATS,this.handleGetLocalAudioStats),t.addListener(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.addListener(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.addListener(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.addListener(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack),e||t.addListener(nt.NEED_REPLACE_TRACK,this.handleReplaceTrack))}unbindLocalTrackEvents(t){t||(t=Array.from(this.localTrackMap.entries()).map(e=>{let[i,{track:n}]=e;return{track:n,type:i}})),t.forEach(e=>{let{track:i,type:n}=e;switch(n){case W.LocalVideoTrack:i.off(nt.GET_STATS,this.handleGetLocalVideoStats),i.off(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),i.off(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),i.off(nt.NEED_UPDATE_VIDEO_ENCODER,this.handleUpdateVideoEncoder),i.off(nt.NEED_UPDATE_VIDEO_SEND_PARAMETERS,this.handleUpdateVideoSendParameters),i.off(nt.NEED_REPLACE_TRACK,this.handleReplaceTrack),i.off(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),i.off(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack);break;case W.LocalAudioTrack:this.unbindLocalAudioTrackEvents(i);case W.LocalVideoLowTrack:}})}unbindLocalAudioTrackEvents(t){t instanceof Le?t.trackList.forEach(e=>{e.off(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),e.off(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),e.off(nt.GET_STATS,this.handleGetLocalAudioStats),e.off(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),e.off(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack)}):(t.off(nt.GET_STATS,this.handleGetLocalAudioStats),t.off(nt.NEED_DISABLE_TRACK,this.handleMuteLocalTrack),t.off(nt.NEED_ENABLE_TRACK,this.handleUnmuteLocalTrack),t.off(nt.NEED_REPLACE_TRACK,this.handleReplaceTrack),t.off(nt.NEED_MUTE_TRACK,this.handleMuteLocalTrack),t.off(nt.NEED_UNMUTE_TRACK,this.handleUnmuteLocalTrack))}bindRemoteTrackEvents(t,e){e instanceof Ya&&e.addListener(nt.GET_STATS,i=>{i(this.handleGetRemoteVideoStats(t))}),e instanceof za&&e.addListener(nt.GET_STATS,i=>{i(this.handleGetRemoteAudioStats(t))})}unbindRemoteTrackEvents(t){t&&t.removeAllListeners(nt.GET_STATS)}unbindAllRemoteTrackEvents(){Array.from(this.remoteUserMap.entries()).forEach(t=>{let[e,i]=t;i.has($.AUDIO)&&this.unbindRemoteTrackEvents(e._audioTrack),i.has($.VIDEO)&&this.unbindRemoteTrackEvents(e._videoTrack)})}createGatewayPublishMessage(t,e){return t.map((i,n)=>{var r;let o,{track:s,type:a}=i;switch(a){case W.LocalAudioTrack:o=Gt.Audio;break;case W.LocalVideoTrack:o=z(r=s._hints).call(r,Jt.SCREEN_TRACK)?Gt.Screen:Gt.High;break;case W.LocalVideoLowTrack:o=Gt.Low}return{kind:a===W.LocalAudioTrack?$.AUDIO:$.VIDEO,stream_type:o,mid:e[n].id,ssrcs:e[n].localSSRC,isMuted:s.muted||!s.enabled}})}createGatewayUnpublishMessage(t){return t.map(e=>{var i;let n,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case W.LocalVideoTrack:n=z(i=o._hints).call(i,Jt.SCREEN_TRACK)?Gt.Screen:Gt.High;break;case W.LocalAudioTrack:n=Gt.Audio;break;case W.LocalVideoLowTrack:n=Gt.Low}return{stream_type:n,ssrcs:s,mid:a}})}assignLocalTracks(t,e){t.forEach((i,n)=>{let{track:r,type:o}=i;this.localTrackMap.set(o,{track:r,id:e[n].id,ssrcs:e[n].localSSRC})})}withdrawLocalTracks(t){t.forEach(e=>{let[i]=e;this.localTrackMap.delete(i)})}bindConnectionEvents(t){t.onConnectionStateChange=e=>I(this,null,function*(){var i;_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: ").concat(t.name,".onConnectionStateChange(").concat(e,")")),this.emit(at.PeerConnectionStateChange,e),e!=="connected"||this.store.keyMetrics.peerConnectionEnd||this.store.peerConnectionEnd(),e==="connected"&&(t.isInRestartIce=!1),z(i=this._restartStates).call(i,e)&&!t.isInRestartIce&&(e==="disconnected"&&(yield qe(800)),t.iceConnectionState!=="disconnected"&&t.iceConnectionState!=="failed"||this.handleDisconnect(t.direction))}),t.onICEConnectionStateChange=e=>{e!=="connected"||this.store.keyMetrics.iceConnectionEnd||this.store.iceConnectionEnd(),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICEConnectionStateChange(").concat(e,")")),ot.reportApiInvoke(this.store.sessionId,{name:"ICEConnectionStateChange",options:e,tag:Ee.TRACER}).onSuccess(),this.emit(at.IceConnectionStateChange,e)},t.onICETransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onICETransportStateChange(").concat(e,")"))},t.onDTLSTransportStateChange=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportStateChange(").concat(e,")"))},t.onDTLSTransportError=e=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.onDTLSTransportError(").concat(e,")"))},t.onFirstAudioDecoded=e=>{var i;let n=Array.from(Zi(i=this.remoteUserMap).call(i)).find(o=>o._audioSSRC===e);var r;n&&(this.store.subscribe(n.uid,"audio",void 0,void 0,void 0,Date.now()),(r=n.audioTrack)===null||r===void 0||r.emit(Ga.FIRST_FRAME_DECODED),ot.firstRemoteFrame(this.store.sessionId,Fe.FIRST_AUDIO_DECODE,ce.FIRST_AUDIO_DECODE,{peer:n._uintid,subscribeElapse:si.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId}))},t.onFirstAudioReceived=e=>{var i;let n=Array.from(Zi(i=this.remoteUserMap).call(i)).find(r=>r._audioSSRC===e);n&&ot.firstRemoteFrame(this.store.sessionId,Fe.FIRST_AUDIO_RECEIVED,ce.FIRST_AUDIO_RECEIVED,{peer:n._uintid,subscribeElapse:si.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onFirstVideoDecoded=(e,i,n)=>{this.reportVideoFirstFrameDecoded(e,i,n)},t.onFirstVideoReceived=e=>{var i;let n=Array.from(Zi(i=this.remoteUserMap).call(i)).find(r=>r._videoSSRC===e);n&&ot.firstRemoteFrame(this.store.sessionId,Fe.FIRST_VIDEO_RECEIVED,ce.FIRST_VIDEO_RECEIVED,{peer:n._uintid,subscribeElapse:si.measureFromSubscribeStart(this.store.clientId,e),subscribeRequestid:e,p2pid:this.store.p2pId})},t.onSelectedLocalCandidateChanged=(e,i)=>{let n=e.candidateType==="relay",r=i.candidateType==="relay";i.candidateType!=="unknown"&&n===r||this.emit(at.ConnectionTypeChange,n),_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedLocalCandidateChanged(").concat(JSON.stringify(jo(i))," -> ").concat(JSON.stringify(jo(e)),")"))},t.onSelectedRemoteCandidateChanged=(e,i)=>{_.info("[".concat(this.store.clientId,"] [p2pId: ").concat(this.store.p2pId,"]: P2PConnection.SelectedRemoteCandidateChanged(").concat(JSON.stringify(jo(i))," -> ").concat(JSON.stringify(jo(e)),")"))},t.onFirstVideoDecodedTimeout=e=>{this.reportVideoFirstFrameDecoded(e,void 0,void 0,!0)},t.onLocalCandidate=e=>{this.emit(at.LocalCandidate,{candidate:e,direction:t.direction})}}unbindConnectionEvents(t){t.onConnectionStateChange=void 0,t.onICEConnectionStateChange=void 0,t.onICETransportStateChange=void 0,t.onDTLSTransportStateChange=void 0,t.onDTLSTransportError=void 0,t.onFirstAudioDecoded=void 0,t.onFirstAudioReceived=void 0,t.onFirstVideoDecoded=void 0,t.onFirstVideoReceived=void 0,t.onSelectedLocalCandidateChanged=void 0,t.onSelectedRemoteCandidateChanged=void 0,t.onFirstVideoDecodedTimeout=void 0,t.onLocalCandidate=void 0}handleDisconnect(t){return I(this,null,function*(){let e=t===Ti.SEND_ONLY?this.sendConnection:this.recvConnection;e&&!e.isInRestartIce&&(e.isInRestartIce=!0,_.debug("[".concat(this.store.clientId,"] [P2PChannel-").concat(e.name,"] start use restartICE")),t===Ti.SEND_ONLY?this.restartICE(t):$e(this,at.RequestP2PRestartICE,{direction:Ti.SEND_ONLY}))})}filterTobeMutedTracks(t){let e=[];if(this.getAllTracks().indexOf(t)===-1)return e;let i=this.localTrackMap.get(W.LocalAudioTrack);if(t instanceof ge&&i?.track instanceof Le)return i.track.isActive||e.push([W.LocalAudioTrack,i]),e;let n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(n&&(e.push(n),n[0]===W.LocalVideoTrack)){let r=this.localTrackMap.get(W.LocalVideoLowTrack);r&&e.push([W.LocalVideoLowTrack,r])}return e}filterTobeUnmutedTracks(t){let e=[],i=this.localTrackMap.get(W.LocalAudioTrack);if(t instanceof ge&&i?.track instanceof Le)return i.track.isActive&&e.push([W.LocalAudioTrack,i]),e;let n=Array.from(this.localTrackMap.entries()).find(r=>{let[,{track:o}]=r;return t===o});if(n)if(n[0]===W.LocalVideoTrack){e.push(n);let r=this.localTrackMap.get(W.LocalVideoLowTrack);r&&e.push([W.LocalVideoLowTrack,r])}else e.push(n);return e}createMuteMessage(t){return t.map(e=>{var i;let n,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case W.LocalAudioTrack:n=Gt.Audio;break;case W.LocalVideoTrack:n=z(i=o._hints).call(i,Jt.SCREEN_TRACK)?Gt.Screen:Gt.High;break;case W.LocalVideoLowTrack:n=Gt.Low}return{stream_type:n,ssrcs:s,mid:a}})}createUnmuteMessage(t){return t.map(e=>{var i;let n,[r,{track:o,ssrcs:s,id:a}]=e;switch(r){case W.LocalAudioTrack:n=Gt.Audio;break;case W.LocalVideoTrack:n=z(i=o._hints).call(i,Jt.SCREEN_TRACK)?Gt.Screen:Gt.High;break;case W.LocalVideoLowTrack:n=Gt.Low}return{stream_type:n,ssrcs:s,mid:a}})}filterTobeUnSubscribedTracks(t,e){let i=[],n=this.remoteUserMap.get(t);if(!n)return i;if(e){let r=n.get(e);if(!r)return i;i.push([t,{kind:e,id:r}])}else Array.from(n.entries()).forEach(r=>{let[o,s]=r;i.push([t,{kind:o,id:s}])});return i}createUnsubscribeMessage(t){let e=[];return t.forEach(i=>{let[n,{kind:r,id:o}]=i;switch(r){case $.VIDEO:return void(n._videoSSRC&&e.push({stream_type:$.VIDEO,ssrcId:n._videoSSRC}));case $.AUDIO:return void(n._audioSSRC&&e.push({stream_type:$.AUDIO,ssrcId:n._audioSSRC}))}}),e}withdrawRemoteTracks(t){t.forEach(e=>{let[i,{kind:n}]=e,r=this.remoteUserMap.get(i);r&&(r.delete(n),Array.from(r.entries()).length===0&&this.remoteUserMap.delete(i))})}updateBitrateLimit(t){return I(this,null,function*(){let e=this.localTrackMap.get(W.LocalVideoTrack),i=this.localTrackMap.get(W.LocalVideoLowTrack);e&&(yield e.track.setBitrateLimit(t.uplink),yield new Q((n,r)=>{this.handleUpdateVideoEncoder(e.track,n,r,!0)})),i&&t.low_stream_uplink&&(yield i.track.setBitrateLimit({max_bitrate:t.low_stream_uplink.bitrate,min_bitrate:t.low_stream_uplink.bitrate||0}),yield new Q((n,r)=>{this.handleUpdateVideoEncoder(i.track,n,r,!0)}))})}isP2PDisconnected(){if(this.sendConnection&&this.recvConnection){let t=this.sendConnection.peerConnectionState,e=this.recvConnection.peerConnectionState;return t!=="connected"&&e!=="connected"}return!0}tryToUnmuteAudio(t){return I(this,null,function*(){for(let e=0;e<t.length;e++)if(t[e]instanceof ge){let i=this.filterTobeUnmutedTracks(t[e]);if(i.length===0)continue;let n=this.createUnmuteMessage(i);return void(yield Zt(this,at.RequestUnmuteLocal,n))}})}bindStatsUploaderEvents(){this.statsUploader.requestStats=t=>this.getStats(t),this.statsUploader.requestLocalMedia=()=>Array.from(this.localTrackMap.entries()).filter(t=>{let[,{ssrcs:e}]=t;return!!e}),this.statsUploader.requestRemoteMedia=()=>Array.from(this.remoteUserMap.entries()),this.statsUploader.requestVideoIsReady=t=>{var e;return!((e=this.recvConnection)===null||e===void 0||!e.getRemoteVideoIsReady(t))},this.statsUploader.requestUpload=(t,e)=>this.emit(at.RequestUpload,t,e),this.statsUploader.requestUploadStats=t=>this.emit(at.RequestUploadStats,t),this.statsUploader.requestAllTracks=()=>this.getAllTracks()}unbindStatsUploaderEvents(){this.statsUploader.requestStats=void 0,this.statsUploader.requestLocalMedia=void 0,this.statsUploader.requestRemoteMedia=void 0,this.statsUploader.requestVideoIsReady=void 0}requestReconnect(){return I(this,null,function*(){this.dtlsFailedCount+=1,yield qe(yf(this.dtlsFailedCount,Oe)),this.emit(at.RequestReconnect)})}reconnectP2P(){return I(this,null,function*(){})}canPublishLowStream(){return this.localTrackMap.has(W.LocalVideoTrack)||this.pendingLocalTracks.some(t=>t instanceof re)}throwIfTrackTypeNotMatch(t){if(t.filter(e=>e instanceof re).length>1)throw new F(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(t.filter(e=>e instanceof ge).length>1&&(t.some(e=>e instanceof ge&&e._bypassWebAudio)||!Mt().webAudioMediaStreamDest))throw new F(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode");for(let e of t){if(e instanceof re&&this.pendingLocalTracks.some(i=>i instanceof re))throw new F(C.CAN_NOT_PUBLISH_MULTIPLE_VIDEO_TRACKS);if(e instanceof ge&&this.pendingLocalTracks.some(i=>i instanceof ge)&&(!Mt().webAudioMediaStreamDest||e._bypassWebAudio||this.pendingLocalTracks.some(i=>i instanceof ge&&i._bypassWebAudio)))throw new F(C.NOT_SUPPORTED,"cannot publish multiple tracks which one of them configured with bypassWebAudio or your browser doesn't support MediaStreamDestNode")}}getLowVideoTrack(t,e){let i=!A("DISABLE_DUAL_STREAM_USE_ENCODING")&&Mt().supportDualStreamEncoding,n=Ap(Ap({},{width:160,height:120,framerate:15,bitrate:50}),e),r;r=i?t._mediaStreamTrack.clone():Lg(t,n);let o=te(8,"track-low-"),s=new re(r,Ap(Ap({},i&&{scaleResolutionDownBy:mg(n,t)}),{},{frameRate:n.framerate,bitrateMax:n.bitrate,bitrateMin:n.bitrate}),void 0,void 0,o);return s.on(ys.TRANSCEIVER_UPDATED,a=>{t._updateRtpTransceiver(a,Ba.LOW_STREAM)}),s._hints.push(Jt.LOW_STREAM),t.addListener(nt.NEED_CLOSE,()=>{s.close()}),s}globalLock(){return I(this,null,function*(){return this.recvMutex.lock("From P2PChannel2.globalLock")})}reportVideoFirstFrameDecoded(t,e,i,n){var r;let o=Array.from(Zi(r=this.remoteUserMap).call(r)).find(s=>s._videoSSRC===t);if(o){n||this.store.subscribe(o.uid,"video",void 0,void 0,void 0,void 0,Date.now());let s=this.store.keyMetrics,a=s.subscribe.find(c=>c.userId===o.uid&&c.type==="video");ot.firstRemoteVideoDecode(this.store.sessionId,Fe.FIRST_VIDEO_DECODE,ce.FIRST_VIDEO_DECODE,{peer:o._uintid,videowidth:e,videoheight:i,subscribeElapse:si.measureFromSubscribeStart(this.store.clientId,t),subscribeRequestid:t,p2pid:this.store.p2pId,apEnd:s.requestAPEnd||0,apStart:s.requestAPStart||0,joinGwEnd:s.joinGatewayEnd||0,joinGwStart:s.joinGatewayStart||0,pcEnd:s.peerConnectionEnd||0,pcStart:s.peerConnectionStart||0,subscriberEnd:a?.subscribeEnd||0,subscriberStart:a?.subscribeStart||0,videoAddNotify:a?.streamAdded||0,state:n?1:0})}}remoteMediaSsrcChanged(t,e,i){return I(this,null,function*(){if(!this.recvConnection)return!1;let n=this.remoteUserMap.get(t);if(!n)return!1;let r=n.get(e);if(!r)return!1;let o=yield this.recvConnection.getRemoteSSRC(r);return o!==void 0&&o!==i})}isPreSubScribe(t){return!1}publishDataChannel(t){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED)})}unpublishDataChannel(t){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED)})}subscribeDataChannel(t,e){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED)})}unsubscribeDataChannel(t,e){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED)})}hasPendingRemoteDataChannel(t,e){throw new F(C.NOT_SUPPORTED)}setPendingRemoteDataChannel(t,e){throw new F(C.NOT_SUPPORTED)}preConnect(t){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED)})}getEstablishParams(){throw new F(C.NOT_SUPPORTED)}reSubscribe(t){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED)})}updateVideoStreamParameter(t,e){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED)})}unbindRtpTransceiver(){this.localTrackMap.size!==0&&Array.from(this.localTrackMap.entries()).forEach(t=>{let[e,{track:i}]=t;e===W.LocalVideoLowTrack?i._updateRtpTransceiver(void 0,Ba.LOW_STREAM):i._updateRtpTransceiver(void 0)})}},rt(le.prototype,"p2pConnect",[sL],Object.getOwnPropertyDescriptor(le.prototype,"p2pConnect"),le.prototype),rt(le.prototype,"unpublish",[aL],Object.getOwnPropertyDescriptor(le.prototype,"unpublish"),le.prototype),rt(le.prototype,"unpublishLowStream",[cL],Object.getOwnPropertyDescriptor(le.prototype,"unpublishLowStream"),le.prototype),rt(le.prototype,"subscribe",[dL],Object.getOwnPropertyDescriptor(le.prototype,"subscribe"),le.prototype),rt(le.prototype,"mockSubscribe",[lL],Object.getOwnPropertyDescriptor(le.prototype,"mockSubscribe"),le.prototype),rt(le.prototype,"unsubscribe",[uL],Object.getOwnPropertyDescriptor(le.prototype,"unsubscribe"),le.prototype),rt(le.prototype,"muteRemote",[hL],Object.getOwnPropertyDescriptor(le.prototype,"muteRemote"),le.prototype),rt(le.prototype,"unmuteRemote",[pL],Object.getOwnPropertyDescriptor(le.prototype,"unmuteRemote"),le.prototype),rt(le.prototype,"hasRemoteMediaWithLock",[_L],Object.getOwnPropertyDescriptor(le.prototype,"hasRemoteMediaWithLock"),le.prototype),rt(le.prototype,"disconnectForReconnect",[mL],Object.getOwnPropertyDescriptor(le.prototype,"disconnectForReconnect"),le.prototype),rt(le.prototype,"remoteMediaSsrcChanged",[EL],Object.getOwnPropertyDescriptor(le.prototype,"remoteMediaSsrcChanged"),le.prototype),le);function dr(t){return function(e,i,n){let r=e[i];if(typeof r!="function")throw new Error("Cannot use mutex on object property.");return n.value=function(){return I(this,arguments,function*(){for(var o=arguments.length,s=new Array(o),a=0;a<o;a++)s[a]=arguments[a];switch(t){case cr.SEND_ONLY:{let c=yield this.sendMutex.lock("From P2PChannel2.".concat(i));try{return yield r.apply(this,s)}finally{c()}}case cr.RECEIVE_ONLY:{let c=yield this.recvMutex.lock("From P2PChannel2.".concat(i));try{return yield r.apply(this,s)}finally{c()}}default:{let c=yield this.sendMutex.lock("From P2PChannel2.".concat(i)),d=yield this.recvMutex.lock("From P2PChannel2.".concat(i));try{return yield r.apply(this,s)}finally{c(),d()}}}})},n}}class js extends ue{constructor(e,i){super(),T(this,"signal",void 0),T(this,"token",void 0),T(this,"tokenTimeout",void 0),T(this,"tokenInterval",void 0),T(this,"_sequence",0),T(this,"userMap",new Map),T(this,"encoder",new TextEncoder),this.signal=e,this.token=i;let n=()=>{this.signal.connectionState===ie.CONNECTED&&this.check(),this.userMap.size===0?this.tokenInterval=window.setTimeout(n,1e3):this.tokenInterval=window.setTimeout(n,3*A("P2P_TOKEN_INTERVAL"))};n()}send(e,i,n,r,o){return I(this,null,function*(){var s;if(this.userMap.size===0)return;let a=Array.from(Bi(s=this.userMap).call(s))[0].token;typeof i!="string"&&(i=JSON.stringify(i)),r=r??te(6,""),o=o??this._sequence++;let c={_id:r,_type:e,_seq:o,_message:i,token:"".concat(this.token,"_").concat(a)};A("SHOW_P2P_LOG")&&_.debug("send message",c,"noNeedResponse : ".concat(n)),this.splitMessage(JSON.stringify(c)).forEach(l=>{this.signal.request(pt.DATA_STREAM,{payload:Uo(this.encoder.encode(l))})});let d=new Q((l,u)=>{let h=window.setTimeout(()=>{this.off("res-@".concat(r,"_ack"),p),this.off("res-@".concat(r),E),this.off($a.ABORT,g),_.debug("[external-signal] request timeout, type: ".concat(e,", requestId: ").concat(r)),this.userMap.size===0?u(new F(C.INVALID_REMOTE_USER)):u(new F(C.TIMEOUT))},A("EXTERNAL_SIGNAL_REQUEST_TIMEOUT")),p=()=>{h&&window.clearTimeout(h),this.off($a.ABORT,g),n&&l()},g=()=>{h&&window.clearTimeout(h),this.off("res-@".concat(r,"_ack"),p),this.off("res-@".concat(r),E),u(new F(C.EXTERNAL_SIGNAL_ABORT,"type: ".concat(e,", requestId: ").concat(r)))};this.once($a.ABORT,g),this.once("res-@".concat(r,"_ack"),p);let E=(R,y)=>{f=!0,h&&window.clearTimeout(h),this.off("res-@".concat(r,"_ack"),p),this.off($a.ABORT,g),R==="success"?l(y):u(new F(C.P2P_MESSAGE_FAILED,"request ".concat(e," failed, requestId: ").concat(r)))},f=!1;n||(this.once("res-@".concat(r),E),qe(A("SIGNAL_REQUEST_TIMEOUT")).then(()=>{f||_.warning("external_signal request timeout, type: ".concat(e,", requestId: ").concat(r,", ").concat(c))}))});try{return yield d}catch(l){if(l.code===C.TIMEOUT)return yield this.send(e,i,n,r,o);throw l}})}onMessage(e){var i;let{_uid:n}=e,r,o=this.userMap.get(n);if(o)r=o.splitMessageMap;else{if(this.userMap.size>0||!("_type"in e)||e._type!==ye.CHECK)return;let{token:d}=e;r=new Map,o={uid:n,isStart:!0,token:d,splitMessageMap:r,nextExpectedSequenceNumber:0,receivedMessagesMap:new Map},this.userMap.set(n,o),this.signal.emit(wt.ON_USER_ONLINE,{uid:n}),this.handleUserOnline()}if("id"in e&&"total"in e){var s;let{id:d,total:l}=e,u=(s=r.get(d))!==null&&s!==void 0?s:[];if(u.push(e),r.has(d)||r.set(d,u),u.length!==l)return;{let h=ls(u).call(u,(p,g)=>p.index-g.index).map(p=>p.payload).join("");r.delete(d),(e=JSON.parse(h))._uid=n}}let{_type:a,token:c}=e;if(z(i=[ye.ACK,ye.CHECK]).call(i,a))return a===ye.CHECK&&this.handleCheckToken(o,c),void this.receiveMessage(e);c==="".concat(o.token,"_").concat(this.token)?this.handleReceivedMessage(e):_.debug('Receive unexpected message", '.concat(c,", cur_token: ").concat(o.token,"_").concat(this.token),e)}check(){let e={_id:te(6,""),token:this.token,_type:ye.CHECK};A("SHOW_P2P_LOG")&&_.debug("send message",e),this.signal.request(pt.DATA_STREAM,{payload:Uo(this.encoder.encode(JSON.stringify(e)))})}ack(e){let i={_id:e,_type:ye.ACK,token:this.token};A("SHOW_P2P_LOG")&&_.debug("send message",i),this.signal.request(pt.DATA_STREAM,{payload:Uo(this.encoder.encode(JSON.stringify(i)))})}response(e,i,n){this.send(ye.RESPONSE,JSON.stringify({success:!n,message:i}),!0,e)}handleReceivedMessage(e){let i=()=>{this.userMap.forEach(d=>{let{receivedMessagesMap:l,nextExpectedSequenceNumber:u}=d;for(;l.has(u);){let h=l.get(u);l.delete(u),this.receiveMessage(h),d.nextExpectedSequenceNumber++}})};if(!e)return void i();let{_uid:n,_seq:r}=e,o=this.userMap.get(n),{receivedMessagesMap:s,isStart:a,nextExpectedSequenceNumber:c}=o;if(r<c)return this.ack(e._id),void _.debug("[external-signal] receive old message, seq: ".concat(r,", ").concat(e._message));s.set(r,e),a&&r===c&&(this.receiveMessage(e),s.delete(c),o.nextExpectedSequenceNumber++,i())}receiveMessage(e){let{_id:i,_type:n,_message:r,_uid:o}=e;if(A("SHOW_P2P_LOG")&&_.debug("receive message",e),i){let s;switch(e._type!==ye.ACK&&(r&&(s=JSON.parse(r)),this.ack(e._id)),e._type){case ye.CANDIDATE:case ye.CONTROL:this.signal.emit(n,s,o);break;case ye.PUBLISH:case ye.UNPUBLISH:case ye.RESTART_ICE:case ye.CALL:s.uid=o,$e(this.signal,n,s).then(a=>{this.response(e._id,a)}).catch(()=>{this.response(e._id,void 0,!0)});break;case ye.ACK:this.getListeners("res-@".concat(i,"_ack")).length>0&&this.emit("res-@".concat(i,"_ack"));break;case ye.RESPONSE:{let{success:a,message:c}=s;this.emit("res-@".concat(i),a?"success":"failed",c);break}}}}splitMessage(e){if(e.length<js.MAX_MESSAGE_SIZE)return[e];let i=[],{remoteToken:n}=JSON.parse(e),r=te(6,""),o=0,s=800,a=Math.ceil(e.length/s);for(;e.length>0;){o++;let c={id:r,index:o,total:a,payload:e.slice(0,s),token:"".concat(this.token,"_").concat(n)};JSON.stringify(c).length>js.MAX_MESSAGE_SIZE?s-=50:(i.push(c),e=e.slice(s))}return i.map(c=>JSON.stringify(c))}handleCheckToken(e,i){return e.token!==i?(_.debug("token changed, from ".concat(e.token," to ").concat(i)),this.reset(e.uid,i),!1):(this.tokenTimeout&&(window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0),this.tokenTimeout=window.setTimeout(()=>{_.debug("token timeout, ".concat(i)),this.reset(e.uid)},A("MAX_P2P_TIMEOUT")),!0)}handleUserOnline(){return I(this,null,function*(){let e=yield $e(this.signal,ye.CALL,void 0),i=yield this.send(ye.CALL,e);this.signal.emit(Et.P2P_CONNECTION,i,!0)})}reset(e,i){return I(this,null,function*(){let n=this.userMap.get(e);n&&(this.emit($a.ABORT),this.signal.emit(wt.ON_USER_OFFLINE,{uid:n.uid,reason:w6.P2P_TOKEN_CHANGED}),this._sequence=0,this.userMap.clear(),i||(_.debug("change local token from ".concat(i," to ").concat(i)),this.token=te(6,"")))})}clear(){this._sequence=0,this.userMap.clear(),this.tokenInterval&&window.clearTimeout(this.tokenInterval),this.tokenInterval=void 0,this.tokenTimeout&&window.clearTimeout(this.tokenTimeout),this.tokenTimeout=void 0,this.emit($a.ABORT)}}T(js,"MAX_SIZE",1),T(js,"MAX_MESSAGE_SIZE",1024);class aY extends ue{get connectionState(){return this._connectionState}set connectionState(e){e!==this._connectionState&&(this._connectionState=e,e===ie.CONNECTED?this.emit(Et.WS_CONNECTED):e===ie.RECONNECTING?this.emit(Et.WS_RECONNECTING,this._websocketReconnectReason):e===ie.CLOSED&&this.emit(Et.WS_CLOSED,this._disconnectedReason))}get currentURLIndex(){return this.websocket.currentURLIndex}get url(){return this.websocket&&this.websocket.url||null}get rtt(){return this.rttRolling.mean()}constructor(e,i){super(),T(this,"_disconnectedReason",void 0),T(this,"_websocketReconnectReason",void 0),T(this,"_connectionState",ie.CLOSED),T(this,"reconnectToken",void 0),T(this,"p2pToken",void 0),T(this,"websocket",void 0),T(this,"openConnectionTime",void 0),T(this,"clientId",void 0),T(this,"lastMsgTime",Date.now()),T(this,"uploadCache",[]),T(this,"uploadCacheInterval",void 0),T(this,"rttRolling",new YA(5)),T(this,"pingpongTimer",void 0),T(this,"pingpongTimeoutCount",0),T(this,"joinResponse",void 0),T(this,"multiIpOption",void 0),T(this,"initError",void 0),T(this,"spec",void 0),T(this,"store",void 0),T(this,"_external_signal",void 0),T(this,"onWebsocketMessage",n=>{if(n.data instanceof ArrayBuffer)return void this.emit(Et.ON_BINARY_DATA,n.data);let r=JSON.parse(n.data);if(this.lastMsgTime=Date.now(),Object.prototype.hasOwnProperty.call(r,"_id")){let o="res-@".concat(r._id);this.emit(o,r._result,r._message)}else if(Object.prototype.hasOwnProperty.call(r,"_type")){switch(r._type){case wt.ON_DATA_STREAM:return void this.handleDataStream(r._message);case wt.MUTE_AUDIO:case wt.MUTE_VIDEO:case wt.ON_P2P_LOST:case wt.ON_USER_ONLINE:return;case wt.ON_USER_OFFLINE:let{uid:o}=r._message;return _.debug("[".concat(this.clientId,"] user-offline uid: ").concat(o)),void this._external_signal.reset(o)}if(this.emit(r._type,r._message),r._type===wt.ON_NOTIFICATION&&this.handleNotification(r._message),r._type===wt.ON_USER_BANNED)switch(r._message.error_code){case 14:this.close(Ft.UID_BANNED);break;case 15:this.close(Ft.IP_BANNED);break;case 16:this.close(Ft.CHANNEL_BANNED)}if(r._type===wt.ON_USER_LICENSE_BANNED)switch(r._message.error_code){case dt.ERR_LICENSE_MISSING:this.close(Ft.LICENSE_MISSING);break;case dt.ERR_LICENSE_EXPIRED:this.close(Ft.LICENSE_EXPIRED);break;case dt.ERR_LICENSE_MINUTES_EXCEEDED:this.close(Ft.LICENSE_MINUTES_EXCEEDED);break;case dt.ERR_LICENSE_PERIOD_INVALID:this.close(Ft.LICENSE_PERIOD_INVALID);break;case dt.ERR_LICENSE_MULTIPLE_SDK_SERVICE:this.close(Ft.LICENSE_MULTIPLE_SDK_SERVICE);break;case dt.ERR_LICENSE_ILLEGAL:this.close(Ft.LICENSE_ILLEGAL);break;default:this.close()}}}),this.clientId=e.clientId,this.spec=e,this.store=i,this.websocket=new pg("gateway-".concat(this.clientId),this.spec.retryConfig,!0,A("JOIN_GATEWAY_USE_DUAL_DOMAIN"),A("JOIN_GATEWAY_USE_443PORT_ONLY"),i),this.handleWebsocketEvents(),window.addEventListener("offline",()=>{this.connectionState===ie.CONNECTED&&this.reconnect("retry",Ze.OFFLINE)}),this.p2pToken=te(6,""),this._external_signal=new js(this,this.p2pToken)}request(e,i,n,r){return I(this,null,function*(){let o=te(6,""),s={_id:o,_type:e,_message:i},a=this.websocket.connectionID,c=()=>new Q((g,E)=>{if(this.connectionState===ie.CONNECTED)return g();let f=()=>{this.off(Et.WS_CLOSED,R),g()},R=()=>{this.off(Et.WS_CONNECTED,f),E(new F(C.WS_ABORT))};this.once(Et.WS_CONNECTED,f),this.once(Et.WS_CLOSED,R)});if(this.connectionState!==ie.CONNECTING&&this.connectionState!==ie.RECONNECTING||e===pt.JOIN||e===pt.REJOIN||(yield c()),this.websocket.sendMessage(s,!0),r)return;let d=new Q((g,E)=>{let f=!1,R=(N,k)=>{f=!0,g({isSuccess:N==="success",message:k||{}}),this.off(Et.WS_CLOSED,y),this.off(Et.WS_RECONNECTING,y),this.emit(Et.REQUEST_SUCCESS,e,i)};this.once("res-@".concat(o),R);let y=()=>{E(new F(C.WS_ABORT,"type: ".concat(e))),this.off(Et.WS_CLOSED,y),this.off(Et.WS_RECONNECTING,y),this.off("res-@".concat(o),R)};this.once(Et.WS_CLOSED,y),this.once(Et.WS_RECONNECTING,y),qe(A("SIGNAL_REQUEST_TIMEOUT")).then(()=>{this.websocket.connectionID!==a||f||(_.warning("[".concat(this.clientId,"] ws request timeout, type: ").concat(e)),this.emit(Et.REQUEST_TIMEOUT,e,i))})}),l=null;try{l=yield d}catch(g){if(this.connectionState===ie.CLOSED||e===pt.LEAVE)throw new F(C.WS_ABORT);return!this.spec.forceWaitGatewayResponse||n?g.throw():e===pt.JOIN||e===pt.REJOIN?null:(yield c(),yield this.request(e,i))}if(l.isSuccess)return l.message;let u=Number(l.message.error_code||l.message.code),h=Od(u),p=new F(C.UNEXPECTED_RESPONSE,"".concat(h.desc,": ").concat(l.message.error_str),{code:u,data:l.message,desc:h.desc});return h.action==="success"?l.message:(_.warning("[".concat(this.clientId,"] [").concat(this.websocket.connectionID,"] unexpected response from type ").concat(e,", error_code: ").concat(u,", message: ").concat(h.desc,", action: ").concat(h.action)),u===dt.ERR_TOO_MANY_BROADCASTERS?((e===pt.JOIN||e===pt.REJOIN)&&(this.initError=p,this.close()),p.throw()):h.action==="failed"?p.throw():h.action==="quit"?(this.initError=p,this.close(),p.throw()):(u===dt.ERR_JOIN_BY_MULTI_IP?(this.multiIpOption=l.message.option,_.warning("[".concat(this.clientId,"] detect multi ip, recover")),this.reconnect("recover",Ze.MULTI_IP)):this.reconnect(h.action,Ze.SERVER_ERROR),e===pt.JOIN||e===pt.REJOIN?null:yield this.request(e,i)))})}waitMessage(e,i){return new Q(n=>{let r=o=>{(!i||i(o))&&(this.off(e,r),n(o))};this.on(e,r)})}uploadWRTCStats(e){if(!this.store.sessionId)return void _.warn("[".concat(this.clientId,"] no session id when upload wrtc stats"));let i={lts:Date.now(),sid:this.store.sessionId,uid:this.store.intUid,stats:e};this.upload(Ad.WRTC_STATS,i)}upload(e,i){let n={_type:e,_message:i};try{this.websocket.sendMessage(n)}catch{let o=A("MAX_UPLOAD_CACHE")||50;this.uploadCache.push(n),this.uploadCache.length>o&&this.uploadCache.splice(0,1),this.uploadCache.length>0&&!this.uploadCacheInterval&&(this.uploadCacheInterval=window.setInterval(()=>{if(this.connectionState!==ie.CONNECTED)return;let s=this.uploadCache.splice(0,1)[0];this.uploadCache.length===0&&(window.clearInterval(this.uploadCacheInterval),this.uploadCacheInterval=void 0),this.upload(s._type,s._message)},A("UPLOAD_CACHE_INTERVAL")||2e3))}}send(e,i){let n={_type:e,_message:i};this.websocket.sendMessage(n)}sendExtensionMessage(e,i,n){return I(this,null,function*(){return yield this._external_signal.send(e,i,n)})}init(e){return this.initError=void 0,this.multiIpOption=void 0,this.joinResponse=void 0,this.reconnectToken=void 0,this.openConnectionTime=void 0,new Q((i,n)=>{this.once(Et.WS_CONNECTED,()=>i(this.joinResponse)),this.once(Et.WS_CLOSED,()=>n(this.initError||new F(C.WS_ABORT))),this.connectionState=ie.CONNECTING,this.websocket.init(e).catch(n)})}close(e){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.reconnectToken=void 0,this.joinResponse=void 0,this._external_signal.clear(),this._disconnectedReason=e||Ft.LEAVE,this.connectionState=ie.CLOSED,_.debug("[".concat(this.clientId,"] ")+"will close websocket in signal"),this.websocket.close(),this.p2pToken=te(6,""),this._external_signal.clear(),this._external_signal=new js(this,this.p2pToken)}join(){return I(this,null,function*(){if(!this.joinResponse){this.emit(Et.ABORT_P2P_EXECUTION);let e=yield $e(this,Et.REQUEST_JOIN_INFO),i=yield this.request(pt.JOIN,e);if(!i)return this.emit(Et.REPORT_JOIN_GATEWAY,C.TIMEOUT,this.url||""),!1;this.joinResponse=i,this.emit(Et.JOIN_RESPONSE,this.joinResponse),this.reconnectToken=this.joinResponse.rejoin_token}return this.connectionState=ie.CONNECTED,this.pingpongTimer&&window.clearInterval(this.pingpongTimer),this.pingpongTimer=window.setInterval(this.handlePingPong.bind(this),3e3),!0})}reconnect(e,i){this.pingpongTimer&&(this.pingpongTimeoutCount=0,window.clearInterval(this.pingpongTimer),this.pingpongTimer=void 0),this.websocket.reconnect(e,i)}handleDataStream(e){try{var i;let n=Ts(e.payload),r=new TextDecoder().decode(n),o=JSON.parse(r);"total"in o&&"id"in o||z(i=Object.values(ye)).call(i,o._type)?(o._uid=e.uid,this._external_signal.onMessage(o)):this.emit(wt.ON_DATA_STREAM,e)}catch{this.emit(wt.ON_DATA_STREAM,e)}}handleNotification(e){_.debug("[".concat(this.clientId,"] receive notification: "),e);let i=Od(e.code);if(i.action!=="success"){if(i.action!=="failed")return i.action==="quit"?(i.desc==="ERR_REPEAT_JOIN_CHANNEL"&&this.close(Ft.UID_BANNED),void this.close()):void this.reconnect(i.action,Ze.SERVER_ERROR);_.error("[".concat(this.clientId,"] ignore error: "),i.desc)}}handlePingPong(){if(!this.websocket||this.websocket.state!=="connected")return;this.pingpongTimeoutCount>0&&this.rttRolling.add(3e3),this.pingpongTimeoutCount+=1;let e=A("PING_PONG_TIME_OUT"),i=Date.now();this.pingpongTimeoutCount>=e&&(_.warning("[".concat(this.clientId,"] PINGPONG Timeout. Last Socket Message: ").concat(i-this.lastMsgTime,"ms")),i-this.lastMsgTime>A("WEBSOCKET_TIMEOUT_MIN"))?this.reconnect("retry",Ze.TIMEOUT):this.request(pt.PING,void 0,!0).then(()=>{this.pingpongTimeoutCount=0;let n=Date.now()-i;this.rttRolling.add(n),A("REPORT_STATS")&&this.send(pt.PING_BACK,{pingpongElapse:n})}).catch(n=>{})}handleWebsocketEvents(){this.websocket.on(Tt.RECONNECT_CREATE_CONNECTION,e=>{this.emit(Et.WS_RECONNECT_CREATE_CONNECTION,e)}),this.websocket.on(Tt.ON_MESSAGE,this.onWebsocketMessage),this.websocket.on(Tt.CLOSED,()=>{this.connectionState=ie.CLOSED}),this.websocket.on(Tt.FAILED,()=>{this._disconnectedReason=Ft.NETWORK_ERROR,this.connectionState=ie.CLOSED}),this.websocket.on(Tt.RECONNECTING,e=>{this._websocketReconnectReason=e,this.joinResponse=void 0,this.connectionState===ie.CONNECTED?this.connectionState=ie.RECONNECTING:this.connectionState=ie.CONNECTING}),this.websocket.on(Tt.WILL_RECONNECT,(e,i,n)=>{e!=="retry"?(_.debug("".concat(this.clientId," websocket will_connect event, renewSession reconnectMode is ").concat(e)),this.reconnectToken=void 0):_.debug("".concat(this.clientId," reconnect mode is retry, no need to renew session")),n(e)}),this.websocket.on(Tt.CONNECTED,()=>{this.openConnectionTime=Date.now(),this.join().catch(e=>{if(this.emit(Et.REPORT_JOIN_GATEWAY,e,this.url||""),e instanceof F&&e.code===C.UNEXPECTED_RESPONSE&&e.data.code===dt.ERR_NO_AUTHORIZED)return _.warning("[".concat(this.clientId,"] reconnect no authorized, recover")),void this.reconnect("recover",Ze.SERVER_ERROR);_.error("[".concat(this.clientId,"] join gateway request failed"),e.toString()),this.spec.forceWaitGatewayResponse?this.reconnect("tryNext",Ze.SERVER_ERROR):(this.initError=e,this.close())})}),this.websocket.on(Tt.REQUEST_NEW_URLS,(e,i)=>{$e(this,Et.REQUEST_RECOVER,this.multiIpOption).then(e).catch(i)}),this.websocket.on(Tt.ON_TOKEN_PRIVILEGE_DID_EXPIRE,()=>{this.emit(wt.ON_TOKEN_PRIVILEGE_DID_EXPIRE)})}}let cY={name:"P2PChannel",create:function(t){let{store:e,statsCollector:i}=t;return new sY(e,i)},createSubmodule:function(t){let{store:e,spec:i}=t;return new aY(i,e)}};function gL(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function SL(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?gL(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):gL(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}class dY{constructor(e){T(this,"sessionDesc",void 0),T(this,"localCapabilities",void 0),T(this,"rtpCapabilities",void 0),T(this,"candidates",void 0),T(this,"_originCandidates",void 0),T(this,"iceParameters",void 0),T(this,"dtlsParameters",void 0),T(this,"setup",void 0),T(this,"currentMidIndex",void 0),T(this,"cname",void 0),e=he(e);let{iceParameters:i,dtlsParameters:n,candidates:r,rtpCapabilities:o,setup:s,localCapabilities:a,sdkCodec:c,cname:d}=e,l=Li(`v=0
o=- 0 0 IN IP4 127.0.0.1
s=AgoraGateway
t=0 0
a=group:BUNDLE audio video
a=msid-semantic: WMS
a=ice-lite
m=audio 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:audio
m=video 9 UDP/TLS/RTP/SAVPF 0
c=IN IP4 127.0.0.1
a=rtcp:9 IN IP4 0.0.0.0
a=sendrecv
a=rtcp-mux
a=rtcp-rsize
a=mid:video
`);this.rtpCapabilities=o,this.candidates=r,this._originCandidates=he(r),this.iceParameters=i,this.dtlsParameters=n,this.setup=s,this.localCapabilities=a,this.cname=d;for(let u=0;u<l.mediaDescriptions.length;u++){let h=l.mediaDescriptions[u];if(h.attributes.iceUfrag=i.iceUfrag,h.attributes.icePwd=i.icePwd,h.attributes.fingerprints=n.fingerprints,h.attributes.candidates=r,h.attributes.setup=s,h.media.mediaType==="video"){h.media.fmts=o.videoCodecs.map(g=>g.payloadType.toString(10));let p=o.videoCodecs.filter(g=>{var E,f;return(E=g.rtpMap)===null||E===void 0?void 0:z(f=E.encodingName.toLowerCase()).call(f,c)});p.length===0&&(p=o.videoCodecs),h.attributes.payloads=p,h.attributes.extmaps=o.videoExtensions}h.media.mediaType==="audio"&&(h.media.fmts=o.audioCodecs.map(p=>p.payloadType.toString(10)),h.attributes.payloads=o.audioCodecs,h.attributes.extmaps=o.audioExtensions),l.mediaDescriptions[u]=this.mungMediaDesc(h)}this.sessionDesc=l,this.currentMidIndex=l.mediaDescriptions.length-1}toString(){return xo(this.sessionDesc)}send(e,i,n){let{ssrcs:r,ssrcGroups:o}=Ns(i,this.cname),s=this.sessionDesc.mediaDescriptions.find(d=>e===$.VIDEO?d.media.mediaType==="video":d.media.mediaType==="audio"),a=r[0].attributes.label,c=r[0].attributes.mslabel;return s.attributes.ssrcs=s.attributes.ssrcs.concat(r),s.attributes.ssrcGroups=s.attributes.ssrcGroups.concat(o),{id:a,mslabel:c}}batchSend(e){return e.map(i=>{let{kind:n,ssrcMsg:r}=i;return this.send(n,r,void 0)})}stopSending(e){this.sessionDesc.mediaDescriptions.forEach(i=>{let n=[],r=[],o=[];i.attributes.ssrcs.forEach(s=>{z(e).call(e,s.attributes.label||"")?o.push(s):n.push(s)}),i.attributes.ssrcGroups.forEach(s=>{var a;z(a=o.map(c=>c.ssrcId)).call(a,s.ssrcIds[0])||r.push(s)}),i.attributes.ssrcs=n,i.attributes.ssrcGroups=r})}mute(e){let i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.mute."));i.attributes.direction="inactive"}unmute(e){let i=this.sessionDesc.mediaDescriptions.find(n=>n.attributes.mid===e);if(!i)throw new Error("mediaDescription not found with ".concat(e," in remote SDP when calling RemoteSDP.unmute."));i.attributes.direction="sendonly"}receive(e,i,n){e.forEach((r,o)=>{let s=r._mediaStreamTrack,a=this.sessionDesc.mediaDescriptions.findIndex(d=>d.attributes.mid===s.kind),c=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[a],r);this.sessionDesc.mediaDescriptions[a]=c})}stopReceiving(e){}updateCandidates(e){let i=this._originCandidates.filter(r=>r.transport==="udp"),n=[];if(i.forEach(r=>{n.push(SL(SL({},r),{},{foundation:"tcpcandidate",priority:Number(r.priority)-1+"",transport:"tcp",port:Number(r.port)+90+""}))}),i.length!==0){switch(e){case oi.TCP_RELAY:this.candidates=n;break;case oi.UDP_TCP_RELAY:case oi.RELAY:this.candidates=[...i,...n];break;default:this.candidates=i}for(let r of this.sessionDesc.mediaDescriptions)r.attributes.candidates=this.candidates}}restartICE(e){e=he(e),this.iceParameters=e,this.sessionDesc.mediaDescriptions.forEach(i=>{i.attributes.iceUfrag=e.iceUfrag,i.attributes.icePwd=e.icePwd})}predictReceivingMids(e){let i=[];for(let n=0;n<e;n++)i.push((this.currentMidIndex+n+1).toString(10));return i}mungRecvMediaDsec(e,i){let n=he(e);return ic(n,i),fg(n,i),n}updateRecvMedia(e,i){let n=this.sessionDesc.mediaDescriptions.findIndex(r=>r.attributes.mid===e);if(n!==-1){let r=this.mungRecvMediaDsec(this.sessionDesc.mediaDescriptions[n],i);this.sessionDesc.mediaDescriptions[n]=r}}bumpMid(e){this.currentMidIndex+=e}updateTrackLabel(e,i,n){let r=this.sessionDesc.mediaDescriptions.find(s=>e===$.VIDEO?s.attributes.mid==="video":s.attributes.mid==="audio");if(r){let s=r.attributes.ssrcs.find(a=>a.attributes.label===i);var o;s&&(s.attributes.label=n,(o=s.attributes.msid)===null||o===void 0||o.replace(i,n))}}mungMediaDesc(e){let i=he(e);return Eg(i),function(n){let r=n.attributes.extmaps.find(o=>Yh(o.extensionName));r&&n.attributes.extmaps.splice(n.attributes.extmaps.indexOf(r),1),n.attributes.payloads.forEach(o=>{let s=o.rtcpFeedbacks.findIndex(a=>a.type==="transport-cc");s!==-1&&o.rtcpFeedbacks.splice(s,1)})}(i),i}getSSRC(e){for(let i of this.sessionDesc.mediaDescriptions)for(let n of i.attributes.ssrcs)if(n.attributes.label===e)return[n]}}var $t;function TL(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(r){return Object.getOwnPropertyDescriptor(t,r).enumerable})),i.push.apply(i,n)}return i}function wp(t){for(var e=1;e<arguments.length;e++){var i=arguments[e]!=null?arguments[e]:{};e%2?TL(Object(i),!0).forEach(function(n){T(t,n,i[n])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):TL(Object(i)).forEach(function(n){Object.defineProperty(t,n,Object.getOwnPropertyDescriptor(i,n))})}return t}let lY=($t=class Nl extends NO{get peerConnectionState(){return this.peerConnection.connectionState}get iceConnectionState(){return this.peerConnection.iceConnectionState}get currentLocalDescription(){return this.peerConnection.currentLocalDescription}get currentRemoteDescription(){return this.peerConnection.currentRemoteDescription}get localCodecs(){return[...new Set(this.localCapabilities&&this.localCapabilities.videoCodecs.map(e=>e.rtpMap&&e.rtpMap.encodingName.toLowerCase()||"").filter(e=>{var i;return z(i=Object.keys(vh)).call(i,e)}))]}constructor(e,i){super(e,i),T(this,"store",void 0),T(this,"peerConnection",void 0),T(this,"remoteSDP",void 0),T(this,"initialOffer",void 0),T(this,"statsFilter",void 0),T(this,"useRTX",!1),T(this,"localCapabilities",void 0),T(this,"localCandidateCount",0),T(this,"allCandidatesReceived",!1),T(this,"establishPromise",void 0),T(this,"mutex",void 0),this.store=i,this.mutex=new ni("P2PConnection-mutex",i.clientId),this.peerConnection=new RTCPeerConnection(Nl.resolvePCConfiguration(e),{optional:[{googDscp:!0}]}),this.statsFilter=Of(this.peerConnection,A("STATS_UPDATE_INTERVAL"),void 0,_e()?1200:void 0),this.bindPCEvents(),this.bindStatsEvents(),this.store.p2pId=this.store.p2pId+1,this.establishPromise=this.establish()}establish(){return I(this,null,function*(){try{let e=yield this.peerConnection.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0});if(!e.sdp)throw new Error("Cannot get initialOffer.sdp when trying to establish PeerConnection.");let i=Go(e.sdp),n=Pd(e.sdp,{filterRTX:!this.useRTX,filterVideoFec:A("FILTER_VIDEO_FEC"),filterAudioFec:A("FILTER_AUDIO_FEC"),filterAudioCodec:["opus"]});return this.localCapabilities=n,this.initialOffer=e,wp(wp({},i),{},{rtpCapabilities:{send:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},recv:{audioCodecs:[],audioExtensions:[],videoCodecs:[],videoExtensions:[]},sendrecv:n},offerSDP:e.sdp})}catch(e){throw new F(C.GET_LOCAL_CONNECTION_PARAMS_FAILED,e.toString())}})}updateRemoteConnect(){return I(this,null,function*(){})}connect(e){return I(this,null,function*(){try{if(!this.initialOffer)throw new Error("Cannot establish P2PConnection without initial offer.");this.remoteSDP=new dY(wp(wp({},e),{},{rtpCapabilities:e.rtpCapabilities.send,localCapabilities:this.localCapabilities,sdkCodec:this.store.codec}));let i=this.remoteSDP.toString();yield this.peerConnection.setLocalDescription(this.initialOffer),yield this.peerConnection.setRemoteDescription({type:"answer",sdp:i})}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.connect failed; ".concat(i.toString()))}})}updateRemoteRTPCapabilities(e,i){return I(this,null,function*(){throw new F(C.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")})}getPreMedia(e){}send(e,i){var n=this;return un(function*(){let r=yield Lt(n.mutex.lock());try{if(!n.remoteSDP)throw new Error("Cannot call P2PConnection.send before remote SDP created");let o=e.map(h=>n.peerConnection.addTrack(h._mediaStreamTrack)),s=yield Lt(n.peerConnection.createOffer()),a=Li(s.sdp),c=e.map(h=>{let p=h._mediaStreamTrack,g=a.mediaDescriptions.find(E=>E.attributes.mid===p.kind);if(!g)throw new Error("Cannot extract ssrc from mediaDescription.");return function(E,f,R){let y=E.attributes.ssrcs.filter(k=>k.attributes.label===f),N=E.attributes.ssrcGroups;if(y.length===0)throw new Error("Cannot extract ssrc from plan-b SDP.");if(N&&y.length>1){let k=N.find(L=>L.ssrcIds.indexOf(y[0].ssrcId)!==-1);return k?[{ssrcId:k.ssrcIds[0],rtx:R?k.ssrcIds[1]:void 0}]:[{ssrcId:y[0].ssrcId}]}return[{ssrcId:y[0].ssrcId}]}(g,p.id,n.useRTX)}),d;try{d=yield c}catch(h){throw o.forEach(p=>{Qe()&&p.replaceTrack(null),n.peerConnection.removeTrack(p)}),h}let l=n.mungSendOfferSDP(s.sdp,e);n.remoteSDP.receive(e,i,d);let u=n.remoteSDP.toString();return yield Lt(n.peerConnection.setLocalDescription({type:"offer",sdp:l})),yield Lt(n.applySendEncodings(o,e)),yield Lt(n.peerConnection.setRemoteDescription({type:"answer",sdp:u})),e.map((h,p)=>{let g=h._mediaStreamTrack.id;return{localSSRC:c[p],id:g}})}catch(o){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.send failed; ".concat(o.toString()))}finally{r()}})()}stopSending(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopSending before remote SDP created");let i=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(i.length!==e.length)throw new Error("Transceivers' length doesn't match mids' length when trying to call P2PConnection.stopSending.");i.map(o=>{Qe()&&o.replaceTrack(null),this.peerConnection.removeTrack(o)});let n=yield this.peerConnection.createOffer();yield this.peerConnection.setLocalDescription(n),this.remoteSDP.stopReceiving(e);let r=this.remoteSDP.toString();yield this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.stopSending failed; ".concat(i.toString()))}})}receive(e,i,n,r){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.receive ".concat(e," before remoteSDP created."));let{id:o,mslabel:s}=this.remoteSDP.send(e,i,r),a=new Q((l,u)=>{let h=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(o)))},1e4),p=g=>{let E=kt();if((E.name==="Safari"&&Number(E.version)===11||fi())&&g.track.id!==o&&g.streams[0].id===s){var f;let R=g.streams[0].getTracks()[0];return(f=this.remoteSDP)===null||f===void 0||f.updateTrackLabel(e,o,g.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(R)}if(g.track.id===o)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l(g.track)};this.peerConnection.addEventListener("track",p)}),c=this.remoteSDP.toString();yield this.peerConnection.setRemoteDescription({type:"offer",sdp:c});let d=yield this.peerConnection.createAnswer();return yield this.peerConnection.setLocalDescription(d),{track:yield a,id:o}}catch(o){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(o.toString()))}})}stopReceiving(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.stopReceiving before remote SDP created.");this.remoteSDP.stopSending(e);let i=this.remoteSDP.toString();yield this.peerConnection.setRemoteDescription({type:"offer",sdp:i});let n=yield this.peerConnection.createAnswer();yield this.peerConnection.setLocalDescription(n)}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection stopReceiving failed; ".concat(i.toString()))}})}muteRemote(e){return I(this,null,function*(){})}unmuteRemote(e){return I(this,null,function*(){})}muteLocal(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.muteLocal before remote SDP created.");let i=this.peerConnection.getSenders().filter(n=>{var r;return e.indexOf(((r=n.track)===null||r===void 0?void 0:r.id)||"")!==-1});if(i.length!==e.length)throw new Error("sender' length doesn't match mids' length.");i.map(n=>{if(Qe()&&n.track)n.track.enabled=!1;else{let r=n.getParameters();r.encodings.forEach(o=>o.active=!1),n.setParameters(r)}})}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.muteLocal failed; ".concat(i.toString()))}})}unmuteLocal(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.unmuteLocal before remote SDP created.");let i=this.peerConnection.getSenders().filter(o=>{var s;return e.indexOf(((s=o.track)===null||s===void 0?void 0:s.id)||"")!==-1});if(i.length!==e.length)throw new Error("Senders' length doesn't match mids' length.");i.map(o=>I(this,null,function*(){if(Qe()&&o.track)o.track.enabled=!0;else{let s=o.getParameters();s.encodings.forEach(a=>a.active=!0),yield o.setParameters(s)}}));let n=yield this.peerConnection.createOffer();yield this.peerConnection.setLocalDescription(n);let r=this.remoteSDP.toString();yield this.peerConnection.setRemoteDescription({type:"answer",sdp:r})}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.unmuteLocal failed; ".concat(i.toString()))}})}restartICE(e){var i=this;return un(function*(){let n=yield Lt(i.mutex.lock("From P2PConnection.restartICE"));try{if(!i.remoteSDP)throw new Error("Cannot restartICE before remoteSDP created.");let r=Mt().supportPCSetConfiguration;if(e===oi.RELAY&&!r)return;if(r){let d=i.peerConnection.getConfiguration(),l=e===oi.RELAY?"relay":"all";d.iceTransportPolicy!==l&&(_.debug("[".concat(i.store.clientId,"] restartICE change iceTransportPolicy from [").concat(d.iceTransportPolicy,"] to [").concat(l,"]")),d.iceTransportPolicy=l,i.peerConnection.setConfiguration(d))}e!==oi.RELAY&&i.remoteSDP.updateCandidates(e);let o=yield Lt(i.peerConnection.createOffer({iceRestart:!0}));if(!o.sdp)throw new Error("Cannot restartICE because restart offer SDP does not exist.");let s=Go(o.sdp),{remoteIceParameters:a}=yield s.iceParameters;i.remoteSDP.restartICE(a);let c=i.remoteSDP.toString();yield Lt(i.peerConnection.setLocalDescription(o)),yield Lt(i.peerConnection.setRemoteDescription({type:"answer",sdp:c}))}catch(r){_.warning("[".concat(i.store.clientId,"] restart ICE failed, abort operation"),r)}finally{n()}})()}close(){var e;this.peerConnection.close(),(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,"closed"),this.unbindPCEvents(),this.unbindStatsEvents(),this.removeAllListeners(),this.statsFilter.destroy()}getStats(){return this.statsFilter.getStats()}getRemoteVideoIsReady(e){return this.statsFilter.getVideoIsReady(e)}updateEncoderConfig(e,i){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.updateEncoderConfig before remote SDP created.");let n=yield this.peerConnection.createOffer(),r=this.mungSendOfferSDP(n.sdp,[i]);this.remoteSDP.updateRecvMedia(i._mediaStreamTrack.kind,i);let o=this.remoteSDP.toString();yield this.peerConnection.setLocalDescription({type:"offer",sdp:r}),yield this.peerConnection.setRemoteDescription({type:"answer",sdp:o})}catch(n){throw new F(C.EXCHANGE_SDP_FAILED,n.toString())}})}updateSendParameters(e,i){return I(this,null,function*(){let n=this.peerConnection.getSenders().filter(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===e});n.length===1&&(yield this.applySendEncodings(n,[i]))})}setStatsRemoteVideoIsReady(e,i){this.statsFilter.setVideoIsReady2(e,i)}replaceTrack(e,i){return I(this,null,function*(){let n=this.peerConnection.getSenders().find(r=>{var o;return((o=r.track)===null||o===void 0?void 0:o.id)===i});n&&(yield n.replaceTrack(e._mediaStreamTrack))})}createDataChannels(e,i){throw new F(C.NOT_SUPPORTED,"Planb mode does not support createDataChannels.")}stopDataChannels(e){throw new F(C.NOT_SUPPORTED,"Planb mode does not support stopDataChannels.")}bindPCEvents(){this.peerConnection.oniceconnectionstatechange=()=>{var e;(e=this.onICEConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.iceConnectionState)},this.peerConnection.onconnectionstatechange=()=>{var e;(e=this.onConnectionStateChange)===null||e===void 0||e.call(this,this.peerConnection.connectionState)},this.peerConnection.onicecandidate=e=>{e.candidate?this.localCandidateCount+=1:(this.peerConnection.onicecandidate=null,this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] local candidate count"),this.localCandidateCount))},setTimeout(()=>{this.allCandidatesReceived||(this.allCandidatesReceived=!0,_.debug("[".concat(this.store.clientId,"] [pc-").concat(this.store.p2pId,"] onicecandidate timeout, local candidate count"),this.localCandidateCount))},A("CANDIDATE_TIMEOUT"))}unbindPCEvents(){this.peerConnection.oniceconnectionstatechange=null,this.peerConnection.onconnectionstatechange=null,this.peerConnection.onsignalingstatechange=null,this.peerConnection.onicecandidateerror=null,this.peerConnection.onicecandidate=null,this.peerConnection.ontrack=null}static resolvePCConfiguration(e){let i={iceServers:[],sdpSemantics:"plan-b"};return e.iceServers?i.iceServers=e.iceServers:e.turnServer&&e.turnServer.mode!=="off"&&(gd(e.turnServer.servers)?i.iceServers=e.turnServer.servers:(i.iceServers&&i.iceServers.push(...Nl.turnServerConfigToIceServers(e.turnServer.servers)),A("USE_TURN_SERVER_OF_GATEWAY")&&i.iceServers&&e.turnServer.serversFromGateway&&i.iceServers.push(...Nl.turnServerConfigToIceServers(e.turnServer.serversFromGateway)),e.turnServer.servers.concat(e.turnServer.serversFromGateway||[]).forEach(n=>{n.forceturn&&(i.iceTransportPolicy="relay")}))),i}static turnServerConfigToIceServers(e){let i=[];return e.forEach(n=>{n.security?n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turns:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}):(n.udpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.udpport,"?transport=udp")}),n.tcpport&&i.push({username:n.username,credential:n.password,credentialType:"password",urls:"turn:".concat(n.turnServerURL,":").concat(n.tcpport,"?transport=tcp")}))}),i}updateRtpSenderEncodings(e,i){return I(this,null,function*(){var n;if(i||(i=this.peerConnection.getSenders().find(d=>{var l;return((l=d.track)===null||l===void 0?void 0:l.id)===e._mediaStreamTrack.id})),!i)return _.warn("[".concat(e.getTrackId(),"] no rtpSender found}"));if(!Mt().supportSetRtpSenderParameters)return _.warn("Browser not support set rtp-sender parameters");let r={},o={};if(e instanceof re)switch(e._optimizationMode){case"motion":r.degradationPreference="maintain-framerate";break;case"detail":r.degradationPreference="maintain-resolution";break;default:r.degradationPreference="balanced"}if(A("DSCP_TYPE")&&Qr()){var s;let d=A("DSCP_TYPE");z(s=["very-low","low","medium","high"]).call(s,d)&&(o.networkPriority=d)}let a=i.getParameters(),c=(n=a.encodings)===null||n===void 0?void 0:n[0];c&&Object.assign(c,o),Object.assign(a,r),_.debug("[".concat(e.getTrackId(),"] updateRtpSenderEncodings: ").concat(JSON.stringify(a.encodings))),yield i.setParameters(a)})}applySendEncodings(e,i){return I(this,null,function*(){try{if(!Mt().supportSetRtpSenderParameters||e.length!==i.length)return;for(let n=0;n<e.length;n++){let r=e[n],o=i[n];r&&o&&(yield this.updateRtpSenderEncodings(o,r))}}catch{_.debug("[".concat(this.store.clientId,"] Apply RTPSendEncodings failed."))}})}mungSendOfferSDP(e,i){let n=Li(e);return i.forEach((r,o)=>{let s=r._mediaStreamTrack,a=n.mediaDescriptions.find(c=>c.attributes.mid===s.kind);a&&ic(a,r)}),xo(n)}bindStatsEvents(){this.statsFilter.onFirstAudioReceived=e=>{var i;(i=this.onFirstAudioReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoReceived=e=>{var i;(i=this.onFirstVideoReceived)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstAudioDecoded=e=>{var i;(i=this.onFirstAudioDecoded)===null||i===void 0||i.call(this,e)},this.statsFilter.onFirstVideoDecoded=(e,i,n)=>{var r;(r=this.onFirstVideoDecoded)===null||r===void 0||r.call(this,e,i,n)},this.statsFilter.onSelectedLocalCandidateChanged=(e,i)=>{var n;(n=this.onSelectedLocalCandidateChanged)===null||n===void 0||n.call(this,e,i)},this.statsFilter.onSelectedRemoteCandidateChanged=(e,i)=>{var n;(n=this.onSelectedRemoteCandidateChanged)===null||n===void 0||n.call(this,e,i)}}unbindStatsEvents(){this.statsFilter.onFirstAudioReceived=void 0,this.statsFilter.onFirstVideoReceived=void 0,this.statsFilter.onFirstAudioDecoded=void 0,this.statsFilter.onFirstVideoDecoded=void 0,this.statsFilter.onSelectedLocalCandidateChanged=void 0,this.statsFilter.onSelectedRemoteCandidateChanged=void 0}batchReceive(e){return I(this,null,function*(){try{if(!this.remoteSDP)throw new Error("Cannot call P2PConnection.batchReceive before remoteSDP created.");let i=this.remoteSDP.batchSend(e).map((o,s)=>{let{id:a,mslabel:c}=o,{kind:d}=e[s];return new Q((l,u)=>{let h=setTimeout(()=>{u(new Error("Cannot receive track, id: ".concat(a)))},1e4),p=g=>{let E=kt();if(E.name==="Safari"&&Number(E.version)===11&&g.track.id!==a&&g.streams[0].id===c){var f;let R=g.streams[0].getTracks()[0];return(f=this.remoteSDP)===null||f===void 0||f.updateTrackLabel(d,a,g.track.id),this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:R,id:a})}if(g.track.id===a)return this.peerConnection.removeEventListener("track",p),clearTimeout(h),void l({track:g.track,id:a})};this.peerConnection.addEventListener("track",p)})}),n=this.remoteSDP.toString();yield this.peerConnection.setRemoteDescription({type:"offer",sdp:n});let r=yield this.peerConnection.createAnswer();return yield this.peerConnection.setLocalDescription(r),yield Q.all(i)}catch(i){throw new F(C.EXCHANGE_SDP_FAILED,"P2PConnection.receive failed; ".concat(i.toString()))}})}getRemoteSSRC(e){return I(this,null,function*(){if(!this.remoteSDP)return;let i=this.remoteSDP.getSSRC(e);return i?.[0].ssrcId})}setConfiguration(e){if(Mt().supportPCSetConfiguration){let i=Nl.resolvePCConfiguration(e);this.peerConnection.setConfiguration(i)}}},rt($t.prototype,"connect",[gn],Object.getOwnPropertyDescriptor($t.prototype,"connect"),$t.prototype),rt($t.prototype,"stopSending",[gn],Object.getOwnPropertyDescriptor($t.prototype,"stopSending"),$t.prototype),rt($t.prototype,"receive",[gn],Object.getOwnPropertyDescriptor($t.prototype,"receive"),$t.prototype),rt($t.prototype,"stopReceiving",[gn],Object.getOwnPropertyDescriptor($t.prototype,"stopReceiving"),$t.prototype),rt($t.prototype,"muteRemote",[gn],Object.getOwnPropertyDescriptor($t.prototype,"muteRemote"),$t.prototype),rt($t.prototype,"unmuteRemote",[gn],Object.getOwnPropertyDescriptor($t.prototype,"unmuteRemote"),$t.prototype),rt($t.prototype,"muteLocal",[gn],Object.getOwnPropertyDescriptor($t.prototype,"muteLocal"),$t.prototype),rt($t.prototype,"unmuteLocal",[gn],Object.getOwnPropertyDescriptor($t.prototype,"unmuteLocal"),$t.prototype),rt($t.prototype,"close",[gn],Object.getOwnPropertyDescriptor($t.prototype,"close"),$t.prototype),rt($t.prototype,"updateEncoderConfig",[gn],Object.getOwnPropertyDescriptor($t.prototype,"updateEncoderConfig"),$t.prototype),rt($t.prototype,"updateSendParameters",[gn],Object.getOwnPropertyDescriptor($t.prototype,"updateSendParameters"),$t.prototype),rt($t.prototype,"replaceTrack",[gn],Object.getOwnPropertyDescriptor($t.prototype,"replaceTrack"),$t.prototype),rt($t.prototype,"getRemoteSSRC",[gn],Object.getOwnPropertyDescriptor($t.prototype,"getRemoteSSRC"),$t.prototype),$t);function gn(t,e,i){let n=t[e];if(typeof n!="function")throw new Error("Cannot use mutex on object property.");return i.value=function(){return I(this,arguments,function*(){let r=this.mutex,o=yield r.lock("Locking from P2PConnection.".concat(e));try{for(var s=arguments.length,a=new Array(s),c=0;c<s;c++)a[c]=arguments[c];return yield n.apply(this,a)}finally{o()}})},i}let uY={name:"PlanBConnection",create:function(t){let{store:e,spec:i}=t;return new lY(i,e)}},hY={interceptLocalAudioFrame:function(e){return I(this,arguments,function*(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Mt().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(Dh.has(t)||!t.track)return;let n={track:t.track};if(Jr()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let o=null;try{o=t.createEncodedStreams()}catch(a){return void _.error("create audio-encoded-streams error",a&&a.message)}let s=new TransformStream({transform(a,c){n.controller||(n.controller=c),t.track&&t.track.id!==n.track.id&&(_.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r));let d=i.metadata&&i.metadata();d?function(l,u){let{chunk:h,controller:p}=u,g=A("ENABLE_AUDIO_PTS_METADATA")?to.AUDIO_64_BIT_PTS:to.METADATA;h.data=function(E,f,R){let y=R.byteLength,N=y+$f+mO,k=Qf+Zf+N,L=new ArrayBuffer(E.byteLength+k),P=new DataView(L);P.setUint8(0,_O),P.setUint16(1,N),P.setUint8(3,f),P.setUint16(4,y);for(let B=0;B<y;B++)P.setUint8(6+B,R[B]);let V=new Uint8Array(P.buffer);return V.set(new Uint8Array(E),k),V.buffer}(h.data,g,l),p.enqueue(h)}(d,{sender:t,chunk:a,controller:c}):c.enqueue(a)}});o.readable.pipeThrough(s).pipeTo(o.writable)}else if(Qe()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let o=Nh(),s=new MessageChannel;yield new Q(c=>o.onmessage=d=>{d.data==="registered"&&c(void 0)});let a=new RTCRtpScriptTransform(o,{name:"audio-metadata-tx",port:s.port2},[s.port2]);t.transform=a,yield new Q(c=>o.onmessage=d=>{d.data==="started"&&c(void 0)}),s.port1.onmessage=c=>{var d;if(c.data.transformed&&t.track&&((d=t.track)===null||d===void 0?void 0:d.id)!==n.track.id)_.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r);else if(c.data.getMetadata){let l=i.metadata&&i.metadata();l&&s.port1.postMessage({metadata:l})}},n.worker=o}function r(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",r)}let o=Dh.get(t);if(o){Dh.delete(t);try{var s,a;(s=o.controller)===null||s===void 0||s.terminate(),(a=o.worker)===null||a===void 0||a.terminate()}catch(c){_.warning(c&&c.message)}}}Dh.set(t,n),t.track.addEventListener("ended",r)})},interceptRemoteAudioFrame:function(e){return I(this,arguments,function*(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Mt().supportWebRTCEncodedTransform)return void _.warning("browser not support audio encoded transform");if(xh.has(t))return;let n={track:t.track,onMetadata:i.onMetadata};if(Jr()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");lf(xt.CHROME,87,116)||(i.enableTopn=!1);let o=null;try{o=t.createEncodedStreams()}catch(a){return void _.error("create audio-encoded-streams error",a&&a.message)}let s=new TransformStream({transform(a,c){n.controller||(n.controller=c),t.track&&t.track.id!==n.track.id&&(_.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r)),i.enableTopn?function(d,l,u){var h;let p=EO(new DataView(l.data));if(!p)return u.enqueue(l);let g=d.track.id;zK.set(g,d.track);let E=(h=p.tlv.find(L=>L.tag===to.AUDIO_LEVEL))===null||h===void 0?void 0:h.value,f=0;typeof E=="number"&&(f=127-E);let R=Math.round(Math.pow(10,f/60)-1),{selected:y,speaker:N}=function(L,P){let V=Xa.get(L);if(V||(V=function(B){let Y=new gO;return Xa.set(B,Y),nr||(nr=new qK(A("TOPN_SILENCE_THRESHOLD")||500),nr.on("ActiveSpeakerChanged",J=>{J!=null&&(kh=J)})),nr.addSpeakers([Y]),Y}(L)),Xa.size<=SO)return{selected:!0,speaker:V};if(!nr)throw new Error("no active speaker detector");return nr.levelChanged(V.id,P),As=nr.loudest.map(B=>B.id),kh&&!z(As).call(As,kh)&&As.length>=SO&&As.pop(),{selected:z(As).call(As,V.id)||V.id===kh,speaker:V}}(d,R),k=function(L,P,V){let B=rr.get(L)||new YK(L,P);return B.score=V,rr.set(L,B),function(Y){if(Mh.set(Y,!0),!Uh)return void(Uh=Date.now());let J=Date.now();J-Uh>1e3&&(Mh.get(Y)?Mh.set(Y,!1):(TO(Y),Mh.delete(Y)),Uh=J)}(L),B}(g,d.track,N.energyScore);k.addSample(y),k.active&&(l.data=p.frame.buffer,u.enqueue(l))}(t,a,c):i.enableMetadata?function(d,l,u){let h=EO(new DataView(d.data));if(!h)return l.enqueue(d);let p=h.tlv.find(g=>g.tag===to.METADATA||g.tag===to.AUDIO_64_BIT_PTS);p&&u&&p.value instanceof Uint8Array&&u(p.value),d.data=h.frame.buffer,l.enqueue(d)}(a,c,i.onMetadata):c.enqueue(a)}});o.readable.pipeThrough(s).pipeTo(o.writable)}else if(Qe()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let o=Nh(),s=new MessageChannel;yield new Q(c=>o.onmessage=d=>{d.data==="registered"&&c(void 0)});let a=new RTCRtpScriptTransform(o,{name:"audio-metadata-rx",port:s.port2},[s.port2]);t.transform=a,yield new Q(c=>o.onmessage=d=>{d.data==="started"&&c(void 0)}),s.port1.onmessage=c=>{var d;c.data.transformed&&t.track&&((d=t.track)===null||d===void 0?void 0:d.id)!==n.track.id?(_.debug("audio track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r)):c.data.metadata&&n.onMetadata&&n.onMetadata(c.data.metadata)},n.worker=o}function r(){t.track.removeEventListener("ended",r),function(o){let s=xh.get(o);if(s){(function(d){let l=Xa.get(d);l&&(Xa.delete(d),nr&&(nr.removeSpeakers([l]),Xa.size===0&&(nr.destroy(),nr=null)))})(o),TO(o.track.id),xh.delete(o);try{var a,c;(a=s.controller)===null||a===void 0||a.terminate(),(c=s.worker)===null||c===void 0||c.terminate()}catch(d){_.warning(d&&d.message)}}}(t)}xh.set(t,n),t.track.addEventListener("ended",r)})},interceptLocalVideoFrame:function(t,e){return I(this,null,function*(){if(!Mt().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(Vh.has(t)||!t.track)return;let i={track:t.track};if(Jr()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let r=null;try{r=t.createEncodedStreams()}catch(a){return void _.error("create video-encoded-streams error",a&&a.message)}let o=[];e.on("sei-to-send",a=>{o.push(a)});let s=new TransformStream({transform(a,c){i.controller||(i.controller=c),t.track&&t.track.id!==i.track.id&&(_.debug("video track changed: ".concat(i.track.id," => ").concat(t.track.id)),i.track.removeEventListener("ended",n),i.track=t.track,i.track.addEventListener("ended",n));let d=o.shift();d&&(a.data=function(l,u){let h=function(y){let N=y.length,k=[],L=0;for(;L<N;)L+2<N&&y[L]===0&&y[L+1]===0&&(y[L+2]===0||y[L+2]===1||y[L+2]===2||y[L+2]===3)?(k.push(y[L],y[L+1],3,y[L+2]),L+=3):(k.push(y[L]),L++);return new Uint8Array(k)}(u),p=h.length,g=Math.floor(p/255),E=p%255,f=new Uint8Array(6+g+1+p+l.byteLength);f[0]=0,f[1]=0,f[2]=0,f[3]=1,f[4]=6,f[5]=101;let R=0;for(;R<g;)f[6+R]=255,R++;return f[6+R]=E,R++,f.set(h,6+R),f.set(new Uint8Array(l),6+R+p),f.buffer}(a.data,d)),c.enqueue(a)}});r.readable.pipeThrough(s).pipeTo(r.writable)}else{if(!Qe())return;{if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let r=Nh(),o=new MessageChannel;yield new Q(a=>r.onmessage=c=>{c.data==="registered"&&a(void 0)});let s=new RTCRtpScriptTransform(r,{name:"sei-tx",port:o.port2},[o.port2]);t.transform=s,yield new Q(a=>r.onmessage=c=>{c.data==="started"&&a(void 0)}),e.on("sei-to-send",a=>{o.port1.postMessage({sei:a})}),o.port1.onmessage=a=>{var c;a.data.transformed&&t.track&&((c=t.track)===null||c===void 0?void 0:c.id)!==i.track.id&&(_.debug("video track changed: ".concat(i.track.id," => ").concat(t.track.id)),i.track.removeEventListener("ended",n),i.track=t.track,i.track.addEventListener("ended",n))},i.worker=r}}function n(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",n)}let r=Vh.get(t);if(r){Vh.delete(t);try{var o,s;(o=r.controller)===null||o===void 0||o.terminate(),(s=r.worker)===null||s===void 0||s.terminate()}catch(a){_.warning(a&&a.message)}}}Vh.set(t,i),t.track.addEventListener("ended",n)})},interceptRemoteVideoFrame:function(e){return I(this,arguments,function*(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{};if(!Mt().supportWebRTCEncodedTransform)return void _.warning("browser not support video encoded transform");if(!t.track)return;if(Id.has(t)){let o=Id.get(t);return void(o&&(o.onSei=i.onSei))}let n={track:t.track,onSei:i.onSei};if(Jr()){if(!t.createEncodedStreams)return void _.warning("browser not support createEncodedStreams() API");let o=null;try{o=t.createEncodedStreams()}catch(a){return void _.error("create video-encoded-streams error",a&&a.message)}let s=new TransformStream({transform(a,c){n.controller||(n.controller=c),t.track&&t.track.id!==n.track.id&&(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r));let d=function(l){let u=new DataView(l.data),h=0;for(;h+4<l.data.byteLength;){if(u.getUint8(h+0)===0&&u.getUint8(h+1)===0&&u.getUint8(h+2)===0&&u.getUint8(h+3)===1&&u.getUint8(h+4)===6){let p=h+6,g=0,E=0;for(;(E=u.getUint8(p++))===255;)g+=255;g+=E;let f=XK(l.data,p,g);return new Uint8Array(f)}h++}return null}(a);d&&n.onSei&&n.onSei(d),c.enqueue(a)}});o.readable.pipeThrough(s).pipeTo(o.writable)}else if(Qe()){if(typeof RTCRtpScriptTransform>"u")return void _.warning("browser not support RTCRtpScriptTransform");let o=Nh(),s=new MessageChannel;yield new Q(c=>o.onmessage=d=>{d.data==="registered"&&c(void 0)});let a=new RTCRtpScriptTransform(o,{name:"sei-rx",port:s.port2},[s.port2]);t.transform=a,yield new Q(c=>o.onmessage=d=>{d.data==="started"&&c(void 0)}),s.port1.onmessage=c=>{var d;c.data.transformed&&t.track&&((d=t.track)===null||d===void 0?void 0:d.id)!==n.track.id?(_.debug("video track changed: ".concat(n.track.id," => ").concat(t.track.id)),n.track.removeEventListener("ended",r),n.track=t.track,n.track.addEventListener("ended",r)):c.data.sei&&n.onSei&&n.onSei(c.data.sei)},n.worker=o}function r(){if(t.track){if(this.id!==t.track.id)return;t.track.removeEventListener("ended",r)}(function(o){let s=Id.get(o);if(s){Id.delete(o);try{var a,c;(a=s.controller)===null||a===void 0||a.terminate(),(c=s.worker)===null||c===void 0||c.terminate()}catch(d){_.warning(d&&d.message)}}})(t)}Id.set(t,n),t.track.addEventListener("ended",r)})}},pY={name:"InterceptFrame",create:()=>hY};Nf(),qt("PROCESS_ID","process-".concat(te(8,""),"-").concat(te(4,""),"-").concat(te(4,""),"-").concat(te(4,""),"-").concat(te(12,""))),function(){let t;try{t=window.localStorage.getItem("websdk_ng_global_parameter")}catch(e){return void _.error("Error loading sdk config",e.message)}if(t)try{let e=JSON.parse(window.atob(t)),i=Date.now();_.debug("Loading global parameters from cache",e),Object.keys(e).forEach(n=>{if(Object.prototype.hasOwnProperty.call(ae,n)){let{value:r,expires:o}=e[n];if(o&&o<=i)return;ir[n]=r,ae[n]=r}})}catch(e){_.error("Error loading mutableParamsCache: ".concat(t),e.message)}}(),Array.isArray(ir.AREAS)&&ir.AREAS.length>0&&vg(ir.AREAS,!0);let RL=(t,e,i)=>{_.debug("setParameter key:".concat(t,", value:").concat(JSON.stringify(e))),qt(t,e,i)};Wo(U8,!1),Wo(F8,!1),Wo(Tq,!1),Wo(J8,!1),Wo(L8,!1),Wo(cY,!1),Wo(uY,!1),Wo(pY,!1);let Ne=function(t){let e=new ue,i=t,n={getListeners:e.getListeners.bind(e),on:(r,o)=>(function(s,a){s===wr.SECURITY_POLICY_VIOLATION&&eP(a,!0)}(r,o),e.on.bind(e)(r,o)),addListener:e.addListener.bind(e),once:e.once.bind(e),off:e.off.bind(e),removeAllListeners:e.removeAllListeners.bind(e),emit:e.emit.bind(e),safeEmit:e.safeEmit.bind(e)};return tP(tP({},i),n)}({__TRACK_LIST__:Fa,VERSION:hn,BUILD:Lf,ESM_BUNDLER:!1,ESM:!1,UMD:!0,DEV:!1,setParameter:RL,getParameter:A,getSupportedCodec:function(){return I(this,null,function*(){let t={audio:[],video:[]};try{let e=new RTCPeerConnection,i=yield function(n){return I(this,null,function*(){let r;return Mt().supportUnifiedPlan?(n.addTransceiver("video",{direction:"recvonly"}),n.addTransceiver("audio",{direction:"recvonly"}),r=(yield n.createOffer()).sdp):r=(yield n.createOffer({offerToReceiveAudio:!0,offerToReceiveVideo:!0})).sdp,r})}(e);if(!i)return t;e.close(),e=null,t=function(n){let r={video:[],audio:[]};return n.match(/ VP8/i)&&r.video.push("VP8"),n.match(/ VP9/i)&&r.video.push("VP9"),n.match(/ AV1/i)&&r.video.push("AV1"),n.match(/ H264/i)&&r.video.push("H264"),n.match(/ H265/i)&&r.video.push("H265"),n.match(/ opus/i)&&r.audio.push("OPUS"),n.match(/ PCMU/i)&&r.audio.push("PCMU"),n.match(/ PCMA/i)&&r.audio.push("PCMA"),n.match(/ G722/i)&&r.audio.push("G722"),r}(i)}catch(e){throw new x(C.CREATE_OFFER_FAILED,e.toString&&e.toString()).print()}return t})},checkSystemRequirements:function(){let t=ot.reportApiInvoke(null,{name:be.CHECK_SYSTEM_REQUIREMENTS,options:[],tag:Ee.TRACER}),e=!1;try{let o=window.RTCPeerConnection,s=navigator.mediaDevices&&navigator.mediaDevices.getUserMedia,a=window.WebSocket;e=!!(o&&s&&a),e&&_f()&&vA(75)&&new o().close()}catch(o){return _.error("check system requirement failed: ",o),!1}let i=!1,n=kt();n.name===xt.CHROME&&Number(n.version)>=58&&(tr.engine.name!=="WebKit"||function(){let o=kt();if(ph()){if(o.os===Ve.MAC_OS)return!0;if(o.os===Ve.IOS){let s=tr.os.version&&tr.os.version.split(".");if(s&&Number(s[0])===14&&s[1]&&Number(s[1])>=3||s&&Number(s[0])>14)return!0}}return!1}())&&(i=!0),(n.name===xt.FIREFOX&&Number(n.version)>=56||n.name===xt.OPERA&&Number(n.version)>=45||n.name===xt.SAFARI&&Number(n.version)>=11||n.name==="WebKit"&&(fi()||Pn())&&n.osVersion&&Number(n.osVersion.split(".")[0])>=11||wA()||kt().name===xt.QQ)&&(i=!0),_.debug("checkSystemRequirements, api:",e,"browser",i);let r=e&&i;return t.onSuccess(r),r},getDevices:function(t){return rn.enumerateDevices(!0,!0,t)},getMicrophones:function(t){return rn.getRecordingDevices(t)},getCameras:function(t){return rn.getCamerasDevices(t)},getElectronScreenSources:vw,getPlaybackDevices:function(t){return rn.getSpeakers(t)},createClient:function(){var t;let e=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{codec:"vp8",audioCodec:"opus",mode:"rtc"},i=te(5,"client-"),n=ot.reportApiInvoke(null,{id:i,name:be.CREATE_CLIENT,options:[e],tag:Ee.TRACER});try{(function(r){xe(r.codec,"config.codec",["vp8","vp9","av1","h264","h265"]),xe(r.mode,"config.mode",["rtc","live","p2p"]),r.audioCodec!==void 0&&xe(r.audioCodec,"config.audioCodec",["opus","pcmu","pcma","g722"]),r.proxyServer!==void 0&&Ke(r.proxyServer,"config.proxyServer",1,1e4),r.turnServer!==void 0&&UA(r.turnServer),r.httpRetryConfig!==void 0&&MA(r.httpRetryConfig),r.websocketRetryConfig!==void 0&&MA(r.websocketRetryConfig)})(e)}catch(r){throw n.onError(r),r}return(CA(16,0,!0)||bA(16,0,!0))&&(e.codec==="vp9"&&(e.codec="vp8",_.debug("browser not support vp9, force use vp8")),qt("UNSUPPORTED_VIDEO_CODEC",["vp9"])),e.audioCodec===void 0&&(e.audioCodec="opus"),n.onSuccess(),new Rq(Gn(Gn({forceWaitGatewayResponse:!0},e),{},{role:z(t=["rtc","p2p"]).call(t,e.mode)?"host":e.role||"audience"}),i)},createCameraVideoTrack:function(){return I(this,arguments,function*(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=A("CAMERA_CAPTURE_CONFIG"),i=te(8,"track-cam-"),n=ot.reportApiInvoke(null,{id:i,tag:Ee.TRACER,name:be.CREATE_CAM_VIDEO_TRACK,options:[de({},t),e]});e&&(t.encoderConfig=e);let r=wh(t),o=null;_.info("start create camera video track with config",JSON.stringify(t),"trackId",i);try{o=(yield nn({video:r},i)).getVideoTracks()[0]||null}catch(a){throw n.onError(a),a}if(!o){let a=new F(C.UNEXPECTED_ERROR,"can not find track in media stream");return n.onError(a),a.throw(_)}if(t.optimizationMode&&Jf(i,o,t,Mn(t.encoderConfig)),A("USE_STANDARD_BITRATE_DEFAULT")){let a=Mn(t.encoderConfig);t.encoderConfig=a,delete a.bitrateMax,delete a.bitrateMin}let s=new Xf(o,t,r,t.scalabiltyMode?Ch(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,i);return n.onSuccess(s.getTrackId()),_.info("create camera video success, trackId:",i),s})},createCustomVideoTrack:function(t){let e=te(8,"track-cus-"),i=ot.reportApiInvoke(null,{id:e,tag:Ee.TRACER,name:be.CREATE_CUSTOM_VIDEO_TRACK,options:[t]});A("USE_STANDARD_BITRATE_DEFAULT")&&(delete t.bitrateMax,delete t.bitrateMin);let n=new re(t.mediaStreamTrack,{width:t.width,height:t.height,frameRate:t.frameRate,bitrateMax:t.bitrateMax,bitrateMin:t.bitrateMin},t.scalabiltyMode?Ch(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,e,[Jt.CUSTOM_TRACK]);return i.onSuccess(n.getTrackId()),_.info("create custom video track success with config",t,"trackId",n.getTrackId()),n},createScreenVideoTrack:function(){return I(this,arguments,function*(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:"disable",i=typeof e=="object"?function(h){return Pw(h)}(e):void 0;i&&(e="auto");let n=te(8,"track-scr-v-"),r=ot.reportApiInvoke(null,{id:n,tag:Ee.TRACER,name:be.CREATE_SCREEN_VIDEO_TRACK,options:[de({},t),e]});t.encoderConfig?typeof t.encoderConfig=="string"||t.encoderConfig.width&&t.encoderConfig.height||(t.encoderConfig.width={max:1920},t.encoderConfig.height={max:1080}):t.encoderConfig="1080p_2";let o=function(h){let p={};h.screenSourceType&&(p.mediaSource=h.screenSourceType),h.extensionId&&Jr()&&(p.extensionId=h.extensionId);let{displaySurface:g,selfBrowserSurface:E,surfaceSwitching:f,systemAudio:R,preferCurrentTab:y}=h;(_d(107)||uf(107)||hf(93))&&(g&&(xe(g,"displaySurface",["browser","window","monitor"]),p.displaySurface=g),E?(xe(E,"selfBrowserSurface",["exclude","include"]),p.selfBrowserSurface=E):p.selfBrowserSurface="include",f&&(xe(f,"surfaceSwitching",["exclude","include"]),p.surfaceSwitching=f)),(_d(105)||uf(105)||hf(91))&&R&&(xe(R,"systemAudio",["exclude","include"]),p.systemAudio=R),(_d(94)||uf(94)||hf(80))&&y&&(p.preferCurrentTab=!0),h.electronScreenSourceId&&(p.sourceId=h.electronScreenSourceId);let N=h.encoderConfig?Vf(h.encoderConfig):null;return p.mandatory={chromeMediaSource:"desktop",maxWidth:N?N.width:void 0,maxHeight:N?N.height:void 0},N&&(N.frameRate&&(typeof N.frameRate=="number"?(p.mandatory.maxFrameRate=N.frameRate,p.mandatory.minFrameRate=N.frameRate):(p.mandatory.maxFrameRate=N.frameRate.max||N.frameRate.ideal||N.frameRate.exact||void 0,p.mandatory.minFrameRate=N.frameRate.min||N.frameRate.ideal||N.frameRate.exact||void 0),p.frameRate=N.frameRate),N.width&&(p.width=N.width),N.height&&(p.height=N.height)),p}(t),s=null,a=null,c=Mt();if(!c.supportShareAudio&&e==="enable"){let h=new F(C.NOT_SUPPORTED,"your browser or platform is not support share-screen with audio");return r.onError(h),h.throw(_)}_.info("start create screen video track with config",t,"withAudio",e,"trackId",n);let d=c.supportShareAudio&&e!=="disable";try{let h=yield nn({screen:o,screenAudio:d?i||!0:void 0},n);s=h.getVideoTracks()[0]||null,a=h.getAudioTracks()[0]||null}catch(h){throw r.onError(h),h}if(!s){let h=new F(C.UNEXPECTED_ERROR,"can not find track in media stream");return r.onError(h),h.throw(_)}if(!a&&e==="enable"){s&&s.stop();let h=new F(C.SHARE_AUDIO_NOT_ALLOWED);return r.onError(h),h.throw(_)}t.optimizationMode||(t.optimizationMode="detail"),t.optimizationMode&&(Jf(n,s,t,t.encoderConfig&&Vf(t.encoderConfig)||void 0),t.encoderConfig&&typeof t.encoderConfig!="string"&&(t.encoderConfig.bitrateMin=t.encoderConfig.bitrateMax));let l=new re(s,t.encoderConfig?Vf(t.encoderConfig):{},t.scalabiltyMode?Ch(t.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},t.optimizationMode,n,[Jt.SCREEN_TRACK]);if(!a)return r.onSuccess(l.getTrackId()),_.info("create screen video track success","video:",l.getTrackId()),l;let u=new ge(a,void 0,te(8,"track-scr-a-"),!1);return r.onSuccess([l.getTrackId(),u.getTrackId()]),_.info("create screen video track success","video:",l.getTrackId(),"audio:",u.getTrackId()),[l,u]})},createMicrophoneAndCameraTracks:function(){return I(this,arguments,function*(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},i=A("CAMERA_CAPTURE_CONFIG"),n=te(8,"track-mic-"),r=te(8,"track-cam-"),o=ot.reportApiInvoke(null,{id:"".concat(n,"-").concat(r),tag:Ee.TRACER,name:be.CREATE_MIC_AND_CAM_TRACKS,options:[t,e,i]});i&&(e.encoderConfig=i);let s=wh(e),a=Lw(t),c=null,d=null;_.info("start create camera video track(".concat(r,") and microphone audio track(").concat(n,") with config, audio: ").concat(JSON.stringify(t),", video: ").concat(JSON.stringify(e)));try{let h=yield nn({audio:a,video:s},"".concat(n,"-").concat(r));c=h.getAudioTracks()[0],d=h.getVideoTracks()[0]}catch(h){throw o.onError(h),h}if(!c||!d){let h=new F(C.UNEXPECTED_ERROR,"can not find tracks in media stream");return o.onError(h),h.throw(_)}if(e.optimizationMode&&Jf(r,d,e,Mn(e.encoderConfig)),A("USE_STANDARD_BITRATE_DEFAULT")){let h=Mn(e.encoderConfig);e.encoderConfig=h,delete h.bitrateMax,delete h.bitrateMin}let l=new bd(c,t,a,n),u=new Xf(d,e,s,e.scalabiltyMode?Ch(e.scalabiltyMode):{numSpatialLayers:1,numTemporalLayers:1},e.optimizationMode,r);return o.onSuccess([l.getTrackId(),u.getTrackId()]),_.info("create camera video track(".concat(r,") and microphone audio track(").concat(n,") success")),[l,u]})},createMicrophoneAudioTrack:function(){return I(this,arguments,function*(){let t=arguments.length>0&&arguments[0]!==void 0?arguments[0]:{},e=te(8,"track-mic-"),i=ot.reportApiInvoke(null,{id:e,tag:Ee.TRACER,name:be.CREATE_MIC_AUDIO_TRACK,options:[t]}),n=Lw(t),r=null;_.info("start create microphone audio track with config",JSON.stringify(t),"trackId",e);try{r=(yield nn({audio:n},e)).getAudioTracks()[0]||null}catch(s){throw i.onError(s),s}if(!r){let s=new F(C.UNEXPECTED_ERROR,"can not find track in media stream");return i.onError(s),s.throw(_)}let o=new bd(r,t,n,e);return i.onSuccess(o.getTrackId()),_.info("create microphone audio track success, trackId:",e),o})},createCustomAudioTrack:function(t){let e=te(8,"track-cus-"),i=ot.reportApiInvoke(null,{id:e,tag:Ee.TRACER,name:be.CREATE_CUSTOM_AUDIO_TRACK,options:[t]}),n=new ge(t.mediaStreamTrack,t.encoderConfig?bh(t.encoderConfig):{},e,!1);return _.info("create custom audio track success with config",t,"trackId",n.getTrackId()),i.onSuccess(n.getTrackId()),n},createBufferSourceAudioTrack:function(t){return I(this,null,function*(){var e;let{cacheOnlineFile:i,encoderConfig:n}=t,{source:r}=t,o={source:r instanceof AudioBuffer?"AudioBuffer":r instanceof File?(e=File.name)!==null&&e!==void 0?e:"File":r,cacheOnlineFile:i,encoderConfig:n},s=te(8,"track-buf-"),a=ot.reportApiInvoke(null,{id:s,tag:Ee.TRACER,name:be.CREATE_BUFFER_AUDIO_TRACK,options:[o]});if(A("DISABLE_WEBAUDIO"))throw new F(C.NOT_SUPPORTED,"can not create BufferSourceAudioTrack when WebAudio disabled");_.info("start create buffer source audio track with config",JSON.stringify(o),"trackId",s);let c=r;if(!(r instanceof AudioBuffer))try{r=yield function(u,h){return I(this,null,function*(){let p=null;if(typeof u=="string"){let E=S0.get(u);if(E)return _.debug("use cached audio resource: ",u),E;try{p=(yield er(()=>bi.get(u,{responseType:"arraybuffer"}),void 0,void 0,{maxRetryCount:3})).data}catch(f){throw new F(C.FETCH_AUDIO_FILE_FAILED,f.toString())}}else p=yield new Q((f,R)=>{let y=new FileReader;y.onload=N=>{N.target?f(N.target.result):R(new F(C.READ_LOCAL_AUDIO_FILE_ERROR))},y.onerror=()=>{R(new F(C.READ_LOCAL_AUDIO_FILE_ERROR))},y.readAsArrayBuffer(u)});let g=yield function(E){let f=Ka();return new Q((R,y)=>{f.decodeAudioData(E,N=>{R(N)},N=>{y(new F(C.DECODE_AUDIO_FILE_FAILED,N.toString()))})})}(p);return typeof u=="string"&&h&&S0.set(u,g),g})}(r,i)}catch(u){return a.onError(u),u.throw(_)}let d=new jK(r),l=new BK(c,d,n?bh(n):{},s);return _.info("create buffer source audio track success, trackId:",s),a.onSuccess(l.getTrackId()),l})},setAppType:function(t){if(_.debug("setAppType: ".concat(t)),!(Number.isInteger(t)&&t>=0))throw _.debug("Invalid appType"),new x(C.INVALID_PARAMS,"invalid app type",t);qt("APP_TYPE",Math.floor(t))},setLogLevel:function(t){_.setLogLevel(t)},enableLogUpload:function(){A("USE_NEW_LOG")?qt("UPLOAD_LOG",!0):_.enableLogUpload()},disableLogUpload:function(){A("USE_NEW_LOG")?qt("UPLOAD_LOG",!1):_.disableLogUpload()},createChannelMediaRelayConfiguration:function(){return new SN},checkAudioTrackIsActive:function(e){return I(this,arguments,function*(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,n=ot.reportApiInvoke(null,{tag:Ee.TRACER,name:be.CHECK_AUDIO_TRACK_IS_ACTIVE,options:[i]});if(!(t instanceof ge||t instanceof za)){let d=new x(C.INVALID_TRACK,"the parameter is not a audio track");return n.onError(d),d.throw()}i&&i<1e3&&(i=1e3);let r=t instanceof ge?t.getTrackLabel():"remote_track",o=t.getVolumeLevel(),s=o,a=o,c=Date.now();return new Q(d=>{let l=setInterval(()=>{let u=t.getVolumeLevel();s=u>s?u:s,a=u<a?u:a;let h=s-a>1e-4,p=Date.now()-c;if(h||p>i){clearInterval(l);let g=h,E={duration:p,deviceLabel:r,maxVolumeLevel:s,result:g};_.info("[track-".concat(t.getTrackId(),"] check audio track active completed. ").concat(JSON.stringify(E))),n.onSuccess(E),d(g)}},200)})})},checkVideoTrackIsActive:function(e){return I(this,arguments,function*(t){let i=arguments.length>1&&arguments[1]!==void 0?arguments[1]:5e3,n=ot.reportApiInvoke(null,{tag:Ee.TRACER,name:be.CHECK_VIDEO_TRACK_IS_ACTIVE,options:[i]});if(!(t instanceof re||t instanceof Ya)){let h=new x(C.INVALID_TRACK,"the parameter is not a video track");return n.onError(h),h.throw()}i&&i<1e3&&(i=1e3);let r=t instanceof re?t.getTrackLabel():"remote_track",o=t.getMediaStreamTrack(!0),s=document.createElement("video");s.style.width="1px",s.style.height="1px",s.setAttribute("muted",""),s.muted=!0,s.setAttribute("playsinline",""),s.controls=!1,(Qe()||ph())&&(s.style.opacity="0.01",s.style.position="fixed",s.style.left="0",s.style.top="0",document.body.appendChild(s)),s.srcObject=new MediaStream([o]),s.play();let a=document.createElement("canvas");a.width=160,a.height=120;let c=0,d=0;try{let h=Date.now();c=yield function(p,g,E,f){let R,y=0,N=null;return new Q((k,L)=>{function P(){y>f&&R&&(R(),k(y));let V=E.getContext("2d");if(!V){let J=new x(C.UNEXPECTED_ERROR,"can not get canvas 2d context.");return _.error(J.toString()),void L(J)}V.drawImage(p,0,0,160,120);let B=V.getImageData(0,0,E.width,E.height),Y=Math.floor(B.data.length/3);if(N){for(let J=0;J<Y;J+=3)if(B.data[J]!==N[J])return y+=1,void(N=B.data);N=B.data}else N=B.data}setTimeout(()=>{R&&(R(),k(y))},g),R=Wf(()=>{P()},30)})}(s,i,a,4),d=Date.now()-h}catch(h){throw n.onError(h),h}aq===xt.SAFARI&&(s.pause(),s.remove()),s.srcObject=null;let l=c>4,u={duration:d,changedPicNum:c,deviceLabel:r,result:l};return _.info("[track-".concat(t.getTrackId(),"] check video track active completed. ").concat(JSON.stringify(u))),n.onSuccess(u),l})},setArea:vg,audioElementPlayCenter:Ii,resumeAudioContext:function(){Ii.autoResumeAfterInterruption(!0)},processExternalMediaAEC:function(t){yq.processExternalMediaAEC(t)},registerExtensions:function(t){let e=A("PLUGIN_INFO")||[];t.forEach(i=>{"name"in i&&!z(e).call(e,i.name)&&e.push(i.name);let n=i;n.__registered__=!0,n.logger.hookLog=_.extLog,n.reporter.hookApiInvoke=ot.extApiInvoke,n.parameters&&Object.keys(n.parameters).forEach(r=>{n.parameters[r]=A(r)})}),RL("PLUGIN_INFO",e)},ChannelMediaRelayError:Qa,ChannelMediaRelayEvent:eo,ChannelMediaRelayState:ki,RemoteStreamFallbackType:LK,RemoteStreamType:PK,ConnectionDisconnectedReason:Ft,AudienceLatencyLevelType:dK,AREAS:Vt,preload:function(t,e,i,n){return I(this,null,function*(){return HN(t,e,i,n)})}});return Object.defineProperties(Ne,{onAudioAutoplayFailed:{get:()=>on.onAudioAutoplayFailed,set:t=>{on.onAudioAutoplayFailed=t}},onAutoplayFailed:{get:()=>on.onAutoplayFailed,set:t=>{on.onAutoplayFailed=t}},_onSecurityPolicyViolation:{value:void 0,writable:!0},_cspEventHandlerPointer:{value:void 0,writable:!0},onSecurityPolicyViolation:{get:()=>Ne._onSecurityPolicyViolation,set(t){Ne._onSecurityPolicyViolation=t,eP(t)}},__CLIENT_LIST__:{get:()=>A("SHOW_GLOBAL_CLIENT_LIST")?ws:[]}}),rn.on(Cs.CAMERA_DEVICE_CHANGED,t=>{_.info("camera device changed",JSON.stringify(t)),Ne.onCameraChanged&&Ne.onCameraChanged(t),Ne.safeEmit(wr.CAMERA_CHANGED,t)}),rn.on(Cs.RECORDING_DEVICE_CHANGED,t=>{_.info("microphone device changed",JSON.stringify(t)),Ne.onMicrophoneChanged&&Ne.onMicrophoneChanged(t),Ne.safeEmit(wr.MICROPHONE_CHANGED,t)}),rn.on(Cs.PLAYOUT_DEVICE_CHANGED,t=>{_.debug("playout device changed",JSON.stringify(t)),Ne.onPlaybackDeviceChanged&&Ne.onPlaybackDeviceChanged(t),Ne.safeEmit(wr.PLAYBACK_DEVICE_CHANGED,t)}),Ii.onAutoplayFailed=()=>{_.info("detect audio element autoplay failed"),on.onAudioAutoplayFailed&&on.onAudioAutoplayFailed()},Yt.on("autoplay-failed",()=>{_.info("detect webaudio autoplay failed"),on.onAudioAutoplayFailed&&on.onAudioAutoplayFailed(),Ne.safeEmit(wr.AUTOPLAY_FAILED)}),Yt.on(ze.STATE_CHANGE,(t,e)=>{_.info("audio context state changed: ".concat(e," => ").concat(t)),Ne.onAudioContextStateChanged&&Ne.onAudioContextStateChanged(t,e),Ne.safeEmit(wr.AUDIO_CONTEXT_STATE_CHANGED,t,e)}),Ie.on(La.NETWORK_STATE_CHANGE,(t,e)=>{_.info("[network-indicator] network state changed, ".concat(e," => ").concat(t))}),window&&(window.__ARTC__=Ne),Ne})});var OL={production:!1,apiUrl:"http://localhost:8888/.netlify/functions",backendUrl:"http://localhost:8080",agoraAppId:"a7cc419ef65d49e0b456180f70a2668e"};function NL(v,S){v.terminate=function(){let b=()=>{};this.onerror=b,this.onmessage=b,this.onopen=b;let O=new Date,M=Math.random().toString().substring(2,8),q=this.onclose;this.onclose=et=>{let st=new Date().getTime()-O.getTime();S(`Discarded socket (#${M})  closed after ${st}ms, with code/reason: ${et.code}/${et.reason}`)},this.close(),q?.call(v,{code:4001,reason:`Quick discarding socket (#${M}) without waiting for the shutdown sequence.`,wasClean:!1})}}var Hs={LF:`
`,NULL:"\0"};var ul=class v{get body(){return!this._body&&this.isBinaryBody&&(this._body=new TextDecoder().decode(this._binaryBody)),this._body||""}get binaryBody(){return!this._binaryBody&&!this.isBinaryBody&&(this._binaryBody=new TextEncoder().encode(this._body)),this._binaryBody}constructor(S){let{command:b,headers:O,body:M,binaryBody:q,escapeHeaderValues:et,skipContentLengthHeader:st}=S;this.command=b,this.headers=Object.assign({},O||{}),q?(this._binaryBody=q,this.isBinaryBody=!0):(this._body=M||"",this.isBinaryBody=!1),this.escapeHeaderValues=et||!1,this.skipContentLengthHeader=st||!1}static fromRawFrame(S,b){let O={},M=q=>q.replace(/^\s+|\s+$/g,"");for(let q of S.headers.reverse()){let et=q.indexOf(":"),st=M(q[0]),ct=M(q[1]);b&&S.command!=="CONNECT"&&S.command!=="CONNECTED"&&(ct=v.hdrValueUnEscape(ct)),O[st]=ct}return new v({command:S.command,headers:O,binaryBody:S.binaryBody,escapeHeaderValues:b})}toString(){return this.serializeCmdAndHeaders()}serialize(){let S=this.serializeCmdAndHeaders();return this.isBinaryBody?v.toUnit8Array(S,this._binaryBody).buffer:S+this._body+Hs.NULL}serializeCmdAndHeaders(){let S=[this.command];this.skipContentLengthHeader&&delete this.headers["content-length"];for(let b of Object.keys(this.headers||{})){let O=this.headers[b];this.escapeHeaderValues&&this.command!=="CONNECT"&&this.command!=="CONNECTED"?S.push(`${b}:${v.hdrValueEscape(`${O}`)}`):S.push(`${b}:${O}`)}return(this.isBinaryBody||!this.isBodyEmpty()&&!this.skipContentLengthHeader)&&S.push(`content-length:${this.bodyLength()}`),S.join(Hs.LF)+Hs.LF+Hs.LF}isBodyEmpty(){return this.bodyLength()===0}bodyLength(){let S=this.binaryBody;return S?S.length:0}static sizeOfUTF8(S){return S?new TextEncoder().encode(S).length:0}static toUnit8Array(S,b){let O=new TextEncoder().encode(S),M=new Uint8Array([0]),q=new Uint8Array(O.length+b.length+M.length);return q.set(O),q.set(b,O.length),q.set(M,O.length+b.length),q}static marshall(S){return new v(S).serialize()}static hdrValueEscape(S){return S.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/:/g,"\\c")}static hdrValueUnEscape(S){return S.replace(/\\r/g,"\r").replace(/\\n/g,`
`).replace(/\\c/g,":").replace(/\\\\/g,"\\")}};var Lp=class{constructor(S,b){this.onFrame=S,this.onIncomingPing=b,this._encoder=new TextEncoder,this._decoder=new TextDecoder,this._token=[],this._initState()}parseChunk(S,b=!1){let O;if(typeof S=="string"?O=this._encoder.encode(S):O=new Uint8Array(S),b&&O[O.length-1]!==0){let M=new Uint8Array(O.length+1);M.set(O,0),M[O.length]=0,O=M}for(let M=0;M<O.length;M++){let q=O[M];this._onByte(q)}}_collectFrame(S){if(S!==0&&S!==13){if(S===10){this.onIncomingPing();return}this._onByte=this._collectCommand,this._reinjectByte(S)}}_collectCommand(S){if(S!==13){if(S===10){this._results.command=this._consumeTokenAsUTF8(),this._onByte=this._collectHeaders;return}this._consumeByte(S)}}_collectHeaders(S){if(S!==13){if(S===10){this._setupCollectBody();return}this._onByte=this._collectHeaderKey,this._reinjectByte(S)}}_reinjectByte(S){this._onByte(S)}_collectHeaderKey(S){if(S===58){this._headerKey=this._consumeTokenAsUTF8(),this._onByte=this._collectHeaderValue;return}this._consumeByte(S)}_collectHeaderValue(S){if(S!==13){if(S===10){this._results.headers.push([this._headerKey,this._consumeTokenAsUTF8()]),this._headerKey=void 0,this._onByte=this._collectHeaders;return}this._consumeByte(S)}}_setupCollectBody(){let S=this._results.headers.filter(b=>b[0]==="content-length")[0];S?(this._bodyBytesRemaining=parseInt(S[1],10),this._onByte=this._collectBodyFixedSize):this._onByte=this._collectBodyNullTerminated}_collectBodyNullTerminated(S){if(S===0){this._retrievedBody();return}this._consumeByte(S)}_collectBodyFixedSize(S){if(this._bodyBytesRemaining--===0){this._retrievedBody();return}this._consumeByte(S)}_retrievedBody(){this._results.binaryBody=this._consumeTokenAsRaw();try{this.onFrame(this._results)}catch(S){console.log("Ignoring an exception thrown by a frame handler. Original exception: ",S)}this._initState()}_consumeByte(S){this._token.push(S)}_consumeTokenAsUTF8(){return this._decoder.decode(this._consumeTokenAsRaw())}_consumeTokenAsRaw(){let S=new Uint8Array(this._token);return this._token=[],S}_initState(){this._results={command:void 0,headers:[],binaryBody:void 0},this._token=[],this._headerKey=void 0,this._onByte=this._collectFrame}};var uo=function(v){return v[v.CONNECTING=0]="CONNECTING",v[v.OPEN=1]="OPEN",v[v.CLOSING=2]="CLOSING",v[v.CLOSED=3]="CLOSED",v}(uo||{}),hr=function(v){return v[v.ACTIVE=0]="ACTIVE",v[v.DEACTIVATING=1]="DEACTIVATING",v[v.INACTIVE=2]="INACTIVE",v}(hr||{}),kp=function(v){return v[v.LINEAR=0]="LINEAR",v[v.EXPONENTIAL=1]="EXPONENTIAL",v}(kp||{}),Rc=function(v){return v.Interval="interval",v.Worker="worker",v}(Rc||{});var Mp=class{constructor(S,b=Rc.Interval,O){this._interval=S,this._strategy=b,this._debug=O,this._workerScript=`
    var startTime = Date.now();
    setInterval(function() {
        self.postMessage(Date.now() - startTime);
    }, ${this._interval});
  `}start(S){this.stop(),this.shouldUseWorker()?this.runWorker(S):this.runInterval(S)}stop(){this.disposeWorker(),this.disposeInterval()}shouldUseWorker(){return typeof Worker<"u"&&this._strategy===Rc.Worker}runWorker(S){this._debug("Using runWorker for outgoing pings"),this._worker||(this._worker=new Worker(URL.createObjectURL(new Blob([this._workerScript],{type:"text/javascript"}))),this._worker.onmessage=b=>S(b.data))}runInterval(S){if(this._debug("Using runInterval for outgoing pings"),!this._timer){let b=Date.now();this._timer=setInterval(()=>{S(Date.now()-b)},this._interval)}}disposeWorker(){this._worker&&(this._worker.terminate(),delete this._worker,this._debug("Outgoing ping disposeWorker"))}disposeInterval(){this._timer&&(clearInterval(this._timer),delete this._timer,this._debug("Outgoing ping disposeInterval"))}};var mi=class{constructor(S){this.versions=S}supportedVersions(){return this.versions.join(",")}protocolVersions(){return this.versions.map(S=>`v${S.replace(".","")}.stomp`)}};mi.V1_0="1.0";mi.V1_1="1.1";mi.V1_2="1.2";mi.default=new mi([mi.V1_2,mi.V1_1,mi.V1_0]);var Up=class{get connectedVersion(){return this._connectedVersion}get connected(){return this._connected}constructor(S,b,O){this._client=S,this._webSocket=b,this._connected=!1,this._serverFrameHandlers={CONNECTED:M=>{this.debug(`connected to server ${M.headers.server}`),this._connected=!0,this._connectedVersion=M.headers.version,this._connectedVersion===mi.V1_2&&(this._escapeHeaderValues=!0),this._setupHeartbeat(M.headers),this.onConnect(M)},MESSAGE:M=>{let q=M.headers.subscription,et=this._subscriptions[q]||this.onUnhandledMessage,st=M,ct=this,mt=this._connectedVersion===mi.V1_2?st.headers.ack:st.headers["message-id"];st.ack=(Wt={})=>ct.ack(mt,q,Wt),st.nack=(Wt={})=>ct.nack(mt,q,Wt),et(st)},RECEIPT:M=>{let q=this._receiptWatchers[M.headers["receipt-id"]];q?(q(M),delete this._receiptWatchers[M.headers["receipt-id"]]):this.onUnhandledReceipt(M)},ERROR:M=>{this.onStompError(M)}},this._counter=0,this._subscriptions={},this._receiptWatchers={},this._partialData="",this._escapeHeaderValues=!1,this._lastServerActivityTS=Date.now(),this.debug=O.debug,this.stompVersions=O.stompVersions,this.connectHeaders=O.connectHeaders,this.disconnectHeaders=O.disconnectHeaders,this.heartbeatIncoming=O.heartbeatIncoming,this.heartbeatOutgoing=O.heartbeatOutgoing,this.splitLargeFrames=O.splitLargeFrames,this.maxWebSocketChunkSize=O.maxWebSocketChunkSize,this.forceBinaryWSFrames=O.forceBinaryWSFrames,this.logRawCommunication=O.logRawCommunication,this.appendMissingNULLonIncoming=O.appendMissingNULLonIncoming,this.discardWebsocketOnCommFailure=O.discardWebsocketOnCommFailure,this.onConnect=O.onConnect,this.onDisconnect=O.onDisconnect,this.onStompError=O.onStompError,this.onWebSocketClose=O.onWebSocketClose,this.onWebSocketError=O.onWebSocketError,this.onUnhandledMessage=O.onUnhandledMessage,this.onUnhandledReceipt=O.onUnhandledReceipt,this.onUnhandledFrame=O.onUnhandledFrame}start(){let S=new Lp(b=>{let O=ul.fromRawFrame(b,this._escapeHeaderValues);this.logRawCommunication||this.debug(`<<< ${O}`),(this._serverFrameHandlers[O.command]||this.onUnhandledFrame)(O)},()=>{this.debug("<<< PONG")});this._webSocket.onmessage=b=>{if(this.debug("Received data"),this._lastServerActivityTS=Date.now(),this.logRawCommunication){let O=b.data instanceof ArrayBuffer?new TextDecoder().decode(b.data):b.data;this.debug(`<<< ${O}`)}S.parseChunk(b.data,this.appendMissingNULLonIncoming)},this._webSocket.onclose=b=>{this.debug(`Connection closed to ${this._webSocket.url}`),this._cleanUp(),this.onWebSocketClose(b)},this._webSocket.onerror=b=>{this.onWebSocketError(b)},this._webSocket.onopen=()=>{let b=Object.assign({},this.connectHeaders);this.debug("Web Socket Opened..."),b["accept-version"]=this.stompVersions.supportedVersions(),b["heart-beat"]=[this.heartbeatOutgoing,this.heartbeatIncoming].join(","),this._transmit({command:"CONNECT",headers:b})}}_setupHeartbeat(S){if(S.version!==mi.V1_1&&S.version!==mi.V1_2||!S["heart-beat"])return;let[b,O]=S["heart-beat"].split(",").map(M=>parseInt(M,10));if(this.heartbeatOutgoing!==0&&O!==0){let M=Math.max(this.heartbeatOutgoing,O);this.debug(`send PING every ${M}ms`),this._pinger=new Mp(M,this._client.heartbeatStrategy,this.debug),this._pinger.start(()=>{this._webSocket.readyState===uo.OPEN&&(this._webSocket.send(Hs.LF),this.debug(">>> PING"))})}if(this.heartbeatIncoming!==0&&b!==0){let M=Math.max(this.heartbeatIncoming,b);this.debug(`check PONG every ${M}ms`),this._ponger=setInterval(()=>{let q=Date.now()-this._lastServerActivityTS;q>M*2&&(this.debug(`did not receive server activity for the last ${q}ms`),this._closeOrDiscardWebsocket())},M)}}_closeOrDiscardWebsocket(){this.discardWebsocketOnCommFailure?(this.debug("Discarding websocket, the underlying socket may linger for a while"),this.discardWebsocket()):(this.debug("Issuing close on the websocket"),this._closeWebsocket())}forceDisconnect(){this._webSocket&&(this._webSocket.readyState===uo.CONNECTING||this._webSocket.readyState===uo.OPEN)&&this._closeOrDiscardWebsocket()}_closeWebsocket(){this._webSocket.onmessage=()=>{},this._webSocket.close()}discardWebsocket(){typeof this._webSocket.terminate!="function"&&NL(this._webSocket,S=>this.debug(S)),this._webSocket.terminate()}_transmit(S){let{command:b,headers:O,body:M,binaryBody:q,skipContentLengthHeader:et}=S,st=new ul({command:b,headers:O,body:M,binaryBody:q,escapeHeaderValues:this._escapeHeaderValues,skipContentLengthHeader:et}),ct=st.serialize();if(this.logRawCommunication?this.debug(`>>> ${ct}`):this.debug(`>>> ${st}`),this.forceBinaryWSFrames&&typeof ct=="string"&&(ct=new TextEncoder().encode(ct)),typeof ct!="string"||!this.splitLargeFrames)this._webSocket.send(ct);else{let mt=ct;for(;mt.length>0;){let Wt=mt.substring(0,this.maxWebSocketChunkSize);mt=mt.substring(this.maxWebSocketChunkSize),this._webSocket.send(Wt),this.debug(`chunk sent = ${Wt.length}, remaining = ${mt.length}`)}}}dispose(){if(this.connected)try{let S=Object.assign({},this.disconnectHeaders);S.receipt||(S.receipt=`close-${this._counter++}`),this.watchForReceipt(S.receipt,b=>{this._closeWebsocket(),this._cleanUp(),this.onDisconnect(b)}),this._transmit({command:"DISCONNECT",headers:S})}catch(S){this.debug(`Ignoring error during disconnect ${S}`)}else(this._webSocket.readyState===uo.CONNECTING||this._webSocket.readyState===uo.OPEN)&&this._closeWebsocket()}_cleanUp(){this._connected=!1,this._pinger&&(this._pinger.stop(),this._pinger=void 0),this._ponger&&(clearInterval(this._ponger),this._ponger=void 0)}publish(S){let{destination:b,headers:O,body:M,binaryBody:q,skipContentLengthHeader:et}=S,st=Object.assign({destination:b},O);this._transmit({command:"SEND",headers:st,body:M,binaryBody:q,skipContentLengthHeader:et})}watchForReceipt(S,b){this._receiptWatchers[S]=b}subscribe(S,b,O={}){O=Object.assign({},O),O.id||(O.id=`sub-${this._counter++}`),O.destination=S,this._subscriptions[O.id]=b,this._transmit({command:"SUBSCRIBE",headers:O});let M=this;return{id:O.id,unsubscribe(q){return M.unsubscribe(O.id,q)}}}unsubscribe(S,b={}){b=Object.assign({},b),delete this._subscriptions[S],b.id=S,this._transmit({command:"UNSUBSCRIBE",headers:b})}begin(S){let b=S||`tx-${this._counter++}`;this._transmit({command:"BEGIN",headers:{transaction:b}});let O=this;return{id:b,commit(){O.commit(b)},abort(){O.abort(b)}}}commit(S){this._transmit({command:"COMMIT",headers:{transaction:S}})}abort(S){this._transmit({command:"ABORT",headers:{transaction:S}})}ack(S,b,O={}){O=Object.assign({},O),this._connectedVersion===mi.V1_2?O.id=S:O["message-id"]=S,O.subscription=b,this._transmit({command:"ACK",headers:O})}nack(S,b,O={}){return O=Object.assign({},O),this._connectedVersion===mi.V1_2?O.id=S:O["message-id"]=S,O.subscription=b,this._transmit({command:"NACK",headers:O})}};var xp=class{get webSocket(){return this._stompHandler?._webSocket}get disconnectHeaders(){return this._disconnectHeaders}set disconnectHeaders(S){this._disconnectHeaders=S,this._stompHandler&&(this._stompHandler.disconnectHeaders=this._disconnectHeaders)}get connected(){return!!this._stompHandler&&this._stompHandler.connected}get connectedVersion(){return this._stompHandler?this._stompHandler.connectedVersion:void 0}get active(){return this.state===hr.ACTIVE}_changeState(S){this.state=S,this.onChangeState(S)}constructor(S={}){this.stompVersions=mi.default,this.connectionTimeout=0,this.reconnectDelay=5e3,this._nextReconnectDelay=0,this.maxReconnectDelay=15*60*1e3,this.reconnectTimeMode=kp.LINEAR,this.heartbeatIncoming=1e4,this.heartbeatOutgoing=1e4,this.heartbeatStrategy=Rc.Interval,this.splitLargeFrames=!1,this.maxWebSocketChunkSize=8*1024,this.forceBinaryWSFrames=!1,this.appendMissingNULLonIncoming=!1,this.discardWebsocketOnCommFailure=!1,this.state=hr.INACTIVE;let b=()=>{};this.debug=b,this.beforeConnect=b,this.onConnect=b,this.onDisconnect=b,this.onUnhandledMessage=b,this.onUnhandledReceipt=b,this.onUnhandledFrame=b,this.onStompError=b,this.onWebSocketClose=b,this.onWebSocketError=b,this.logRawCommunication=!1,this.onChangeState=b,this.connectHeaders={},this._disconnectHeaders={},this.configure(S)}configure(S){Object.assign(this,S),this.maxReconnectDelay>0&&this.maxReconnectDelay<this.reconnectDelay&&(this.debug(`Warning: maxReconnectDelay (${this.maxReconnectDelay}ms) is less than reconnectDelay (${this.reconnectDelay}ms). Using reconnectDelay as the maxReconnectDelay delay.`),this.maxReconnectDelay=this.reconnectDelay)}activate(){let S=()=>{if(this.active){this.debug("Already ACTIVE, ignoring request to activate");return}this._changeState(hr.ACTIVE),this._nextReconnectDelay=this.reconnectDelay,this._connect()};this.state===hr.DEACTIVATING?(this.debug("Waiting for deactivation to finish before activating"),this.deactivate().then(()=>{S()})):S()}_connect(){return I(this,null,function*(){if(yield this.beforeConnect(this),this._stompHandler){this.debug("There is already a stompHandler, skipping the call to connect");return}if(!this.active){this.debug("Client has been marked inactive, will not attempt to connect");return}this.connectionTimeout>0&&(this._connectionWatcher&&clearTimeout(this._connectionWatcher),this._connectionWatcher=setTimeout(()=>{this.connected||(this.debug(`Connection not established in ${this.connectionTimeout}ms, closing socket`),this.forceDisconnect())},this.connectionTimeout)),this.debug("Opening Web Socket...");let S=this._createWebSocket();this._stompHandler=new Up(this,S,{debug:this.debug,stompVersions:this.stompVersions,connectHeaders:this.connectHeaders,disconnectHeaders:this._disconnectHeaders,heartbeatIncoming:this.heartbeatIncoming,heartbeatOutgoing:this.heartbeatOutgoing,heartbeatStrategy:this.heartbeatStrategy,splitLargeFrames:this.splitLargeFrames,maxWebSocketChunkSize:this.maxWebSocketChunkSize,forceBinaryWSFrames:this.forceBinaryWSFrames,logRawCommunication:this.logRawCommunication,appendMissingNULLonIncoming:this.appendMissingNULLonIncoming,discardWebsocketOnCommFailure:this.discardWebsocketOnCommFailure,onConnect:b=>{if(this._connectionWatcher&&(clearTimeout(this._connectionWatcher),this._connectionWatcher=void 0),!this.active){this.debug("STOMP got connected while deactivate was issued, will disconnect now"),this._disposeStompHandler();return}this.onConnect(b)},onDisconnect:b=>{this.onDisconnect(b)},onStompError:b=>{this.onStompError(b)},onWebSocketClose:b=>{this._stompHandler=void 0,this.state===hr.DEACTIVATING&&this._changeState(hr.INACTIVE),this.onWebSocketClose(b),this.active&&this._schedule_reconnect()},onWebSocketError:b=>{this.onWebSocketError(b)},onUnhandledMessage:b=>{this.onUnhandledMessage(b)},onUnhandledReceipt:b=>{this.onUnhandledReceipt(b)},onUnhandledFrame:b=>{this.onUnhandledFrame(b)}}),this._stompHandler.start()})}_createWebSocket(){let S;if(this.webSocketFactory)S=this.webSocketFactory();else if(this.brokerURL)S=new WebSocket(this.brokerURL,this.stompVersions.protocolVersions());else throw new Error("Either brokerURL or webSocketFactory must be provided");return S.binaryType="arraybuffer",S}_schedule_reconnect(){this._nextReconnectDelay>0&&(this.debug(`STOMP: scheduling reconnection in ${this._nextReconnectDelay}ms`),this._reconnector=setTimeout(()=>{this.reconnectTimeMode===kp.EXPONENTIAL&&(this._nextReconnectDelay=this._nextReconnectDelay*2,this.maxReconnectDelay!==0&&(this._nextReconnectDelay=Math.min(this._nextReconnectDelay,this.maxReconnectDelay))),this._connect()},this._nextReconnectDelay))}deactivate(){return I(this,arguments,function*(S={}){let b=S.force||!1,O=this.active,M;if(this.state===hr.INACTIVE)return this.debug("Already INACTIVE, nothing more to do"),Promise.resolve();if(this._changeState(hr.DEACTIVATING),this._nextReconnectDelay=0,this._reconnector&&(clearTimeout(this._reconnector),this._reconnector=void 0),this._stompHandler&&this.webSocket.readyState!==uo.CLOSED){let q=this._stompHandler.onWebSocketClose;M=new Promise((et,st)=>{this._stompHandler.onWebSocketClose=ct=>{q(ct),et()}})}else return this._changeState(hr.INACTIVE),Promise.resolve();return b?this._stompHandler?.discardWebsocket():O&&this._disposeStompHandler(),M})}forceDisconnect(){this._stompHandler&&this._stompHandler.forceDisconnect()}_disposeStompHandler(){this._stompHandler&&this._stompHandler.dispose()}publish(S){this._checkConnection(),this._stompHandler.publish(S)}_checkConnection(){if(!this.connected)throw new TypeError("There is no underlying STOMP connection")}watchForReceipt(S,b){this._checkConnection(),this._stompHandler.watchForReceipt(S,b)}subscribe(S,b,O={}){return this._checkConnection(),this._stompHandler.subscribe(S,b,O)}unsubscribe(S,b={}){this._checkConnection(),this._stompHandler.unsubscribe(S,b)}begin(S){return this._checkConnection(),this._stompHandler.begin(S)}commit(S){this._checkConnection(),this._stompHandler.commit(S)}abort(S){this._checkConnection(),this._stompHandler.abort(S)}ack(S,b,O={}){this._checkConnection(),this._stompHandler.ack(S,b,O)}nack(S,b,O={}){this._checkConnection(),this._stompHandler.nack(S,b,O)}};var fM=vL(EM());var r_=class v{client;messageSubject=new yL;isConnected=!1;constructor(){this.client=new xp({webSocketFactory:()=>new fM.default("http://localhost:8080/ws"),reconnectDelay:5e3,debug:S=>console.log("[STOMP]",S)})}connect(S){if(this.isConnected){console.log("\u26A0\uFE0F Already connected. Skipping...");return}this.client.onConnect=()=>{this.isConnected=!0,console.log("\u2705 STOMP connected!");let b=`/topic/room/${S}`;this.client.subscribe(b,O=>{O.body&&(console.log(`\u{1F4E9} Received from room ${S}:`,O.body),this.messageSubject.next(JSON.parse(O.body)))})},this.client.onStompError=b=>{console.error("\u274C STOMP error:",b)},this.client.activate()}sendMessage(S){this.client.connected?this.client.publish({destination:"/app/chat.sendMessage",body:JSON.stringify(S)}):console.warn("\u26A0\uFE0F Not connected to STOMP.")}addUser(S){this.client.connected?this.client.publish({destination:"/app/chat.addUser",body:JSON.stringify(S)}):console.warn("\u26A0\uFE0F Not connected to STOMP.")}getMessages(){return this.messageSubject.asObservable()}sendJoinMessage(S,b){if(!this.client.connected){console.warn("\u26A0\uFE0F Not connected to STOMP.");return}let O={type:"JOIN",sender:S,roomId:b,content:""};this.client.publish({destination:"/app/chat.addUser",body:JSON.stringify(O)})}static \u0275fac=function(b){return new(b||v)};static \u0275prov=CL({token:v,factory:v.\u0275fac,providedIn:"root"})};var Dl=vL(TM());var RM=class v{http=Pp(AL);route=Pp(wL);socketService=Pp(r_);roomId;usersInCall=[];client;localTracks={videoTrack:null,audioTrack:null};screenTrack=null;isCameraOn=!0;isMicOn=!0;isSharingScreen=!1;ngAfterViewInit(){return I(this,null,function*(){if(console.log("\u{1F4F9} [VideoCall] roomId =",this.roomId),typeof window>"u")return;let S=this.roomId??"default-room",b=S,O=OL.agoraAppId,M=Math.floor(Math.random()*1e5);if(this.client=Dl.default.createClient({mode:"rtc",codec:"vp8"}),!(yield this.http.get(`http://localhost:8080/api/agora/token?channelName=${b}&uid=${M}`,{responseType:"text"}).toPromise()))return;yield this.client.join(O,b,null,M);let et="User "+M;this.socketService.connect(S),setTimeout(()=>{this.socketService.sendJoinMessage(et,S)},1e3),this.client.on("user-published",(ct,mt)=>I(this,null,function*(){if(yield this.client.subscribe(ct,mt),mt==="video"){let Wt=document.getElementById("remote-container"),ht=document.createElement("div");ht.id=`remote-${ct.uid}`,ht.style.width="320px",ht.style.height="240px",ht.style.border="1px solid gray",ht.style.marginBottom="8px",Wt?.appendChild(ht),ct.videoTrack?.play(ht)}mt==="audio"&&ct.audioTrack?.play()})),this.client.on("user-unpublished",(ct,mt)=>{if(mt==="video"){let Wt=document.getElementById(`remote-${ct.uid}`);Wt&&Wt.remove()}mt==="audio"&&ct.audioTrack?.stop()}),this.localTracks.videoTrack=yield Dl.default.createCameraVideoTrack(),this.localTracks.audioTrack=yield Dl.default.createMicrophoneAudioTrack(),yield this.client.publish([this.localTracks.videoTrack,this.localTracks.audioTrack]);let st=document.querySelector("video");st&&this.localTracks.videoTrack.play(st),this.attachToggleButtons()})}attachToggleButtons(){let S=document.getElementById("toggle-camera"),b=document.getElementById("toggle-mic"),O=document.getElementById("share-screen");S?.addEventListener("click",()=>{this.localTracks.videoTrack&&(this.localTracks.videoTrack.setEnabled(!this.isCameraOn),this.isCameraOn=!this.isCameraOn)}),b?.addEventListener("click",()=>{this.localTracks.audioTrack&&(this.localTracks.audioTrack.setEnabled(!this.isMicOn),this.isMicOn=!this.isMicOn)}),O?.addEventListener("click",()=>I(this,null,function*(){yield this.toggleScreenShare()}))}toggleScreenShare(){return I(this,null,function*(){if(this.isSharingScreen)this.screenTrack&&(yield this.client.unpublish(this.screenTrack),this.screenTrack.stop(),this.screenTrack.close(),this.screenTrack=null),this.localTracks.videoTrack&&(yield this.client.publish(this.localTracks.videoTrack),this.localTracks.videoTrack.play("localVideo")),this.isSharingScreen=!1;else try{let S=yield Dl.default.createScreenVideoTrack({encoderConfig:"1080p_1"});this.screenTrack=S,this.localTracks.videoTrack&&(yield this.client.unpublish(this.localTracks.videoTrack),this.localTracks.videoTrack.stop()),yield this.client.publish(this.screenTrack),this.screenTrack.play("local-player"),this.isSharingScreen=!0}catch(S){console.error("L\u1ED7i share screen:",S)}})}static \u0275fac=function(b){return new(b||v)};static \u0275cmp=bL({type:v,selectors:[["app-video-call"]],inputs:{roomId:"roomId"},decls:13,vars:0,consts:[[1,"p-4","bg-gray-100","rounded-xl","shadow-md","flex","flex-col","h-full"],[1,"text-2xl","font-bold","mb-4","text-gray-700","flex","items-center","gap-2"],[1,"flex","justify-center","mb-4"],["id","local-player","autoplay","","playsinline","","muted","",1,"rounded-xl","shadow-lg","border","border-gray-300","w-80","h-60","md:w-96","md:h-72"],["id","remote-container",1,"flex","flex-wrap","gap-4","justify-center","mb-4"],[1,"flex","justify-center","gap-4","mt-auto"],["id","toggle-camera",1,"bg-blue-500","text-white","px-4","py-2","rounded-lg","hover:bg-blue-600","transition-colors"],["id","toggle-mic",1,"bg-green-500","text-white","px-4","py-2","rounded-lg","hover:bg-green-600","transition-colors"],["id","share-screen",1,"bg-purple-500","text-white","px-4","py-2","rounded-lg","hover:bg-purple-600","transition-colors"]],template:function(b,O){b&1&&(Sc(0,"div",0)(1,"h2",1),ll(2,"\u{1F4F9} Video Call"),Tc(),Sc(3,"div",2),TS(4,"video",3),Tc(),TS(5,"div",4),Sc(6,"div",5)(7,"button",6),ll(8," \u{1F3A5} Toggle Camera "),Tc(),Sc(9,"button",7),ll(10," \u{1F3A4} Toggle Mic "),Tc(),Sc(11,"button",8),ll(12," \u{1F5A5}\uFE0F Share Screen "),Tc()()())},dependencies:[IL],encapsulation:2})};export{r_ as a,RM as b};
